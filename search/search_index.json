{"config":{"lang":["en"],"separator":"[\\s\\u200b\\u3000\\-\u3001\u3002\uff0c\uff0e\uff1f\uff01\uff1b]+","pipeline":["stemmer"]},"docs":[{"location":"index.html","title":"hxp \u7684\u6587\u6863\u5e93","text":"<p>\u6b64\u7f51\u7ad9\u4e3a \u80e1\u559c\u5e73 \u4e2a\u4eba\u6587\u6863\u5e93\u3002\u5305\u542b\u65e5\u5e38 Linux\u3001\u5b58\u50a8\u3001\u5bb9\u5668\u7b49\u6240\u6709\u6280\u672f\u7814\u53d1\u7684\u7b14\u8bb0\u3002</p>"},{"location":"index.html#1","title":"1. \u4e2a\u4eba\u7b80\u4ecb","text":"<p>\u80e1\u559c\u5e73\uff0cLinux \u72c2\u70ed\u7231\u597d\u8005\uff0c\u4ece 14 \u5c81\u65e5\u5e38\u4f7f\u7528 Linux \uff0c\u5927\u5b66\u4e09\u5e74\u7ea7\u83b7\u5f97 RedHat Linux \u6700\u9ad8\u7ea7\u8ba4\u8bc1 RHCA \uff0c2 \u5e74 Arch Linux \u30011 \u5e74 Gentoo \u4f7f\u7528\u7ecf\u9a8c\uff0c\u5177\u6709\u4e30\u5bcc\u7684 Linux \u65e5\u5e38\u548c\u4f01\u4e1a\u4f7f\u7528\u7ecf\u9a8c\uff0c\u80fd\u901a\u8fc7\u81ea\u5df1\u6298\u817e\u89e3\u51b3\u975e\u5e38\u591a\u7684\u95ee\u9898\u3002</p> <p>\u8d1f\u8d23\u67d0\u56fd\u6709\u5927\u578b\u94f6\u884c Ansible \u53ca AWX \u7684\u642d\u5efa\u548c\u81ea\u52a8\u5316\u95ee\u9898\u3001\u51e0\u4e4e\u6240\u6709\u548c Linux \u6cbe\u8fb9\u7684\u4e8b\u60c5\uff0cGPFS\u3001Oracle\u3001Redis\u3001MySQL-cmha \u7b49\u81ea\u52a8\u5b89\u88c5\u811a\u672c\u3001 Linux \u6545\u969c\u548c\u6027\u80fd\u95ee\u9898\u5206\u6790\u3002</p>"},{"location":"index.html#2","title":"2. \u4e2a\u4eba\u5de5\u4f5c\u7ecf\u5386","text":""},{"location":"index.html#21-linux","title":"2.1 \u534e\u4e2d\u79d1\u6280\u5927\u5b66 Linux \u793e\u56e2\u521b\u59cb\u4eba","text":"<ul> <li>\u521b\u5efa\u534e\u4e2d\u79d1\u6280\u5927\u5b66 Linux \u793e\u56e2\uff0c\u8d1f\u8d23\u793e\u56e2 Gentoo Linux \u670d\u52a1\u5668\u5efa\u8bbe\u3002</li> </ul> <ul> <li>\u548c\u6821\u8d85\u7b97\u4e2d\u5fc3\u4e3e\u529e\u8bb2\u5ea7 https://imo.hust.edu.cn/info/1353/4670.htm</li> </ul>"},{"location":"index.html#22-ansible-awx","title":"2.2 \u67d0\u5927\u578b\u56fd\u6709\u94f6\u884c Ansible \u5821\u5792\u673a\u548c AWX \u5efa\u8bbe","text":"<ul> <li>\u72ec\u81ea\u5b8c\u6210\u5728\u94f6\u6cb3\u9e92\u9e9f V10 \u4fe1\u521b\u7cfb\u7edf\u4e0a\uff0c\u642d\u5efa 4 \u4e2a\u4e0d\u540c\u7f51\u7edc\u533a\u57df\u7684 Kubernetes \u96c6\u7fa4\uff0c\u5e76\u5c06\u5176\u4f5c\u4e3a AWX \u7684\u5bb9\u5668\u7ec4\u3002\u5c06\u5f00\u6e90 AWX-23.9 \u4f7f\u7528 awx-operator \u90e8\u7f72\u5e76\u81ea\u5efa Keycloak \u5355\u70b9\u767b\u9646\u7cfb\u7edf\u3001\u4f7f\u7528 SAML \u5bf9\u63a5\u3002</li> </ul> <ul> <li>\u5b8c\u6210 Ansible \u5821\u5792\u673a\u7684\u5bb9\u5668\u5316\u6539\u9020\uff0c\u89e3\u51b3\u4e0d\u540c\u4eba\u7528\u76f8\u540c\u8d26\u53f7\u4e0a\u5821\u5792\u673a\u65f6\uff0c\u6bcf\u4e2a\u767b\u5f55\u4e4b\u95f4\u76f8\u4e92\u9694\u79bb\u4e14\u6709 root \u6743\u9650\u3001\u7070\u5ea6\u53d1\u5e03\u7b49\u529f\u80fd\u3002</li> </ul> <ul> <li>\u8d1f\u8d23\u65e5\u5e38\u4e2d\u95f4\u4ef6\u5b89\u88c5\u3001\u751f\u4ea7\u53d8\u66f4\u7684 Ansible \u811a\u672c\u7ef4\u62a4\u3002</li> </ul> <ul> <li>\u8d1f\u8d23\u57fa\u4e8e Python \u7684 Ansible \u6a21\u5757\u7f16\u5199\u3002</li> </ul>"},{"location":"index.html#3","title":"3. \u4e2a\u4eba\u6240\u83b7\u5f97\u7684\u4e13\u4e1a\u8ba4\u8bc1","text":""},{"location":"index.html#31-redhat-rhca","title":"3.1 RedHat \u8ba4\u8bc1\u67b6\u6784\u5e08\uff08RHCA\uff09","text":""},{"location":"index.html#32-kubernetes-cka","title":"3.2 Kubernetes CKA \u8ba4\u8bc1","text":""},{"location":"index.html#33-redhat-ceph","title":"3.3 RedHat \u8ba4\u8bc1 Ceph \u5b58\u50a8\u7ba1\u7406\u5458","text":""},{"location":"index.html#34-redhat","title":"3.4 RedHat \u8ba4\u8bc1\u7cfb\u7edf\u7ba1\u7406\u5458","text":""},{"location":"index.html#35-redhat-openstack","title":"3.5 RedHat \u8ba4\u8bc1 OpenStack \u7cfb\u7edf\u7ba1\u7406\u5458","text":""},{"location":"index.html#36-redhat-openshift","title":"3.6 RedHat \u8ba4\u8bc1 OpenShift \u7ba1\u7406\u4e13\u5bb6","text":""},{"location":"index.html#37-redhat","title":"3.7 RedHat \u8ba4\u8bc1\u5de5\u7a0b\u5e08","text":""},{"location":"index.html#38-redhat","title":"3.8 RedHat \u8ba4\u8bc1\u9ad8\u53ef\u7528\u96c6\u7fa4\u4e13\u5bb6","text":""},{"location":"index.html#39-redhat-linux","title":"3.9 RedHat \u8ba4\u8bc1 Linux \u6027\u80fd\u8c03\u4f18\u4e13\u5bb6","text":""},{"location":"tags.html","title":"\u6587\u6863\u5206\u7c7b","text":"<p>\u4ee5\u4e0b\u4e3a\u6240\u6709\u6587\u6863\u7684\u8fc7\u6ee4\u6807\u7b7e:</p>"},{"location":"tags.html#tag:awx","title":"AWX","text":"<ul> <li>            AWX-23.9\u4f7f\u7528SAML\u5bf9\u63a5Keycloak-24\u8ba4\u8bc1          </li> <li>            AWX\u548cstolon\u9ad8\u53ef\u7528\u8c03\u4f18          </li> <li>            AWX\u589e\u52a0\u5e76\u4f7f\u7528token          </li> <li>            AWX\u8bbe\u7f6eSAML\u8ba4\u8bc1\u7528\u6237\u4e3a\u7ba1\u7406\u5458          </li> <li>            \u5728k3s\u4e0a\u642d\u5efaawx\u6d4b\u8bd5\u73af\u5883          </li> <li>            \u5b89\u88c5AWX-23.7          </li> </ul>"},{"location":"tags.html#tag:ax9000","title":"AX9000","text":"<ul> <li>            \u5c0f\u7c73AX9000\u5237\u673a          </li> <li>            \u5c0f\u7c73AX9000\u52a0\u5165160MHz\u652f\u6301          </li> <li>            \u5c0f\u7c73AX9000\u89e3\u9501SSH          </li> </ul>"},{"location":"tags.html#tag:cifs","title":"CIFS","text":"<ul> <li>            Linux\u6302\u8f7dCIFS          </li> </ul>"},{"location":"tags.html#tag:ceph","title":"Ceph","text":"<ul> <li>            \u5bf9\u63a5CephFS\u5b58\u50a8          </li> <li>            \u94f6\u6cb3\u9e92\u9e9fV10\u5b89\u88c5Ceph          </li> </ul>"},{"location":"tags.html#tag:ddns","title":"DDNS","text":"<ul> <li>            OpenWrt DDNS\u5f00\u673a\u542f\u52a8\u5931\u8d25\u95ee\u9898          </li> <li>            OpenWrt\u4fee\u6539\u9ed8\u8ba4Shell\u4e3abash\u5e76\u5f00\u542f\u5386\u53f2\u547d\u4ee4\u65f6\u95f4\u6233          </li> </ul>"},{"location":"tags.html#tag:docker","title":"Docker","text":"<ul> <li>            Dockerfile\u4e2d\u4e0d\u4fdd\u7559\u7f16\u8bd1\u7f13\u5b58          </li> <li>            \u4f7f\u7528docker-compose\u642d\u5efakeycloak\u5f00\u53d1\u73af\u5883          </li> <li>            \u7f16\u8bd1OnlyOffice\u4ee5\u89e3\u966420\u8fde\u63a5\u6570\u9650\u5236          </li> </ul>"},{"location":"tags.html#tag:f4610u","title":"F4610U","text":"<ul> <li>            \u5317\u4eac\u8054\u901a\u4e2d\u5174F4610U\u5149\u732b\u5f00\u8d85\u7ba1\u754c\u9762          </li> </ul>"},{"location":"tags.html#tag:geeker-admin","title":"Geeker-Admin","text":"<ul> <li>            Geeker-Admin\u63a5\u5165Keycloak\u8ba4\u8bc1          </li> </ul>"},{"location":"tags.html#tag:gentoo","title":"Gentoo","text":"<ul> <li>            Gentoo\u542f\u52a8\u65f6\u6302\u8f7dcifs\u5931\u8d25\u89e3\u51b3\u65b9\u6cd5          </li> <li>            Hyper-V\u73af\u5883\u4e0bsddm\u65e0\u6cd5\u542f\u52a8\u56fe\u5f62\u754c\u9762\u95ee\u9898\u89e3\u51b3          </li> <li>            emerge\u88c5\u5305ninja\u62a5\u9519\u201cmanifest 'build.ninja' still dirty after 100 tries\u201d\u89e3\u51b3\u65b9\u6cd5          </li> <li>            \u5728Hyper-V\u73af\u5883\u5b89\u88c5Gentoo          </li> <li>            \u5728QEMU\u73af\u5883\u5b89\u88c5Gentoo          </li> <li>            \u5b89\u88c5xfce\u540efcitx\u53f3\u4e0a\u89d2\u663e\u793a\u4f46\u65e0\u6cd5\u9009\u62e9\u8f93\u5165\u6cd5\u95ee\u9898\u89e3\u51b3          </li> </ul>"},{"location":"tags.html#tag:git","title":"Git","text":"<ul> <li>            Git\u4e2d\u6587\u4e71\u7801\u95ee\u9898\u89e3\u51b3          </li> <li>            Git\u914d\u7f6e\u8bb0\u4f4f\u5bc6\u7801          </li> <li>            \u4f7f\u7528nginx\u5feb\u901f\u642d\u5efa\u53ea\u8bfbGit\u4ed3\u5e93          </li> <li>            \u6700\u7b80Git\u670d\u52a1\u5668\u642d\u5efa.md          </li> </ul>"},{"location":"tags.html#tag:github","title":"GitHub","text":"<ul> <li>            GitHub\u9ed8\u8ba4\u5934\u50cf\u83b7\u53d6          </li> </ul>"},{"location":"tags.html#tag:gitlab","title":"GitLab","text":"<ul> <li>            GitLab\u7b2c\u4e8c\u90ae\u7bb1\u4fee\u6539\u4e3a\u5df2\u8ba4\u8bc1          </li> </ul>"},{"location":"tags.html#tag:hyper-v","title":"Hyper-V","text":"<ul> <li>            Hyper-V\u4fee\u6539\u8c03\u5ea6\u5668          </li> <li>            Hyper-V\u591a\u7f51\u5361\u7ed1\u5b9a          </li> <li>            Hyper-V\u73af\u5883\u4e0bsddm\u65e0\u6cd5\u542f\u52a8\u56fe\u5f62\u754c\u9762\u95ee\u9898\u89e3\u51b3          </li> <li>            Ubuntu\u5b89\u88c5Hyper-V\u5de5\u5177          </li> </ul>"},{"location":"tags.html#tag:java","title":"Java","text":"<ul> <li>            SpringBoot 2.5.1 \u5bf9\u63a5Keycloak\u8ba4\u8bc1          </li> <li>            \u4f7f\u7528OnlyOffice\u5b98\u65b9Spring\u793a\u4f8b\u9047\u5230\u7684\u5751          </li> </ul>"},{"location":"tags.html#tag:k3s","title":"K3S","text":"<ul> <li>            \u5728k3s\u4e0a\u642d\u5efaawx\u6d4b\u8bd5\u73af\u5883          </li> </ul>"},{"location":"tags.html#tag:kvm","title":"KVM","text":"<ul> <li>            virt-manager\u521b\u5efa\u865a\u62df\u673a\u62a5\u9519\u201cDid not find any UEFI binary path for arch 'aarch64'\u201d\u95ee\u9898          </li> </ul>"},{"location":"tags.html#tag:keycloak","title":"Keycloak","text":"<ul> <li>            AWX-23.9\u4f7f\u7528SAML\u5bf9\u63a5Keycloak-24\u8ba4\u8bc1          </li> <li>            Geeker-Admin\u63a5\u5165Keycloak\u8ba4\u8bc1          </li> <li>            SpringBoot 2.5.1 \u5bf9\u63a5Keycloak\u8ba4\u8bc1          </li> <li>            k3s\u642d\u5efa\u5355\u70b9Keycloak          </li> <li>            k8s\u96c6\u7fa4Keycloak\u90e8\u7f72\u53ca\u8d1f\u8f7d\u914d\u7f6e          </li> <li>            mkdocs\u5728k8s\u4e0a\u7684\u90e8\u7f72          </li> <li>            \u4f7f\u7528docker-compose\u642d\u5efakeycloak\u5f00\u53d1\u73af\u5883          </li> <li>            \u4f7f\u7528openresty\u5bb9\u5668\u4e3ak8s\u7684\u670d\u52a1\u63d0\u4f9bKeycloak\u8ba4\u8bc1\u670d\u52a1          </li> <li>            \u601d\u6e90\u7b14\u8bb0k8s\u90e8\u7f72          </li> </ul>"},{"location":"tags.html#tag:kubernetes","title":"Kubernetes","text":"<ul> <li>            AWX\u548cstolon\u9ad8\u53ef\u7528\u8c03\u4f18          </li> <li>            k3s\u642d\u5efa\u5355\u70b9Keycloak          </li> <li>            k8s\u96c6\u7fa4Keycloak\u90e8\u7f72\u53ca\u8d1f\u8f7d\u914d\u7f6e          </li> <li>            local-path-provisioner\u5b89\u88c5          </li> <li>            mkdocs\u5728k8s\u4e0a\u7684\u90e8\u7f72          </li> <li>            \u4f7f\u7528openresty\u5bb9\u5668\u4e3ak8s\u7684\u670d\u52a1\u63d0\u4f9bKeycloak\u8ba4\u8bc1\u670d\u52a1          </li> <li>            \u4f7f\u7528stolon\u5b89\u88c5\u9ad8\u53ef\u7528PostgreSQL          </li> <li>            \u5728k3s\u4e0a\u642d\u5efaawx\u6d4b\u8bd5\u73af\u5883          </li> <li>            \u5b89\u88c5AWX-23.7          </li> <li>            \u5b89\u88c5helm\u5305\u7ba1\u7406\u5668          </li> <li>            \u5b89\u88c5metrics-server          </li> <li>            \u5b89\u88c5traefik ingress controller          </li> <li>            \u5bf9\u63a5CephFS\u5b58\u50a8          </li> <li>            \u601d\u6e90\u7b14\u8bb0k8s\u90e8\u7f72          </li> <li>            \u6269\u5bb9master\u8282\u70b9          </li> <li>            \u7981\u7528\u5bb9\u5668\u955c\u50cf\u5783\u573e\u56de\u6536\u5e76\u914d\u7f6e\u78c1\u76d8\u76f8\u5173\u5bb9\u5668\u6f02\u79fb\u7b56\u7565          </li> <li>            \u914d\u7f6e\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u51ed\u8bc1          </li> <li>            \u94f6\u6cb3\u9e92\u9e9fV10\u5b89\u88c5Kubernetes          </li> </ul>"},{"location":"tags.html#tag:linux","title":"Linux","text":"<ul> <li>            Gentoo\u542f\u52a8\u65f6\u6302\u8f7dcifs\u5931\u8d25\u89e3\u51b3\u65b9\u6cd5          </li> <li>            Hyper-V\u73af\u5883\u4e0bsddm\u65e0\u6cd5\u542f\u52a8\u56fe\u5f62\u754c\u9762\u95ee\u9898\u89e3\u51b3          </li> <li>            Linux LVM\u8e22PV          </li> <li>            Linux \u5f00\u542f OTP \u4e8c\u6b21\u8ba4\u8bc1          </li> <li>            Linux\u4e0b\u8f7dyum\u6e90          </li> <li>            Linux\u6302\u8f7dCIFS          </li> <li>            Linux\u914d\u7f6eudev\u89c4\u5219\u5ffd\u7565\u78c1\u76d8          </li> <li>            Ubuntu\u5b89\u88c5Hyper-V\u5de5\u5177          </li> <li>            emerge\u88c5\u5305ninja\u62a5\u9519\u201cmanifest 'build.ninja' still dirty after 100 tries\u201d\u89e3\u51b3\u65b9\u6cd5          </li> <li>            \u4f7f\u7528tlog\u5bf9\u767b\u5f55\u5230Linux\u4e0a\u7684\u7528\u6237\u8fdb\u884c\u5f55\u5c4f          </li> <li>            \u5728Hyper-V\u73af\u5883\u5b89\u88c5Gentoo          </li> <li>            \u5728QEMU\u73af\u5883\u5b89\u88c5Gentoo          </li> <li>            \u5b89\u88c5xfce\u540efcitx\u53f3\u4e0a\u89d2\u663e\u793a\u4f46\u65e0\u6cd5\u9009\u62e9\u8f93\u5165\u6cd5\u95ee\u9898\u89e3\u51b3          </li> <li>            \u66d9\u5149\u670d\u52a1\u5668\u88c5\u673a\u65e0RAID\u5361\u9a71\u52a8\u5bfc\u81f4\u4e0d\u80fd\u8bc6\u522b\u786c\u76d8\u95ee\u9898\u5206\u6790\u4e0e\u89e3\u51b3\u65b9\u6848          </li> <li>            \u8054\u60f3\u7269\u7406\u673aPXE\u88c5\u673a\u62a5\u9519\u201c\u6839\u5206\u533a\u627e\u4e0d\u5230\u201d\u539f\u56e0\u53ca\u89e3\u51b3\u65b9\u6cd5          </li> <li>            \u8bb0\u67d0\u6b21\u67d0\u5b89\u5168\u5382\u5546\u5e94\u7528\u8fd0\u884c\u4e00\u6bb5\u65f6\u95f4\u540eLinux\u51fa\u73b0ping\u5ef6\u8fdf\u9ad8\u95ee\u9898\u7684\u89e3\u51b3\u601d\u8def          </li> <li>            \u8bb0\u67d0\u6b21\u8bef\u64cd\u4f5cyum update\u540ejboss\u5e94\u7528\u65e0\u6cd5\u542f\u52a8\u53ca\u91cd\u542f\u65e0\u6cd5\u8bc6\u522bvg\u95ee\u9898          </li> <li>            \u9e92\u9e9fV10SP4\u589e\u52a0VSCode\u652f\u6301          </li> </ul>"},{"location":"tags.html#tag:maven","title":"Maven","text":"<ul> <li>            \u4f7f\u7528OnlyOffice\u5b98\u65b9Spring\u793a\u4f8b\u9047\u5230\u7684\u5751          </li> </ul>"},{"location":"tags.html#tag:nexus","title":"Nexus","text":"<ul> <li>            \u914d\u7f6e\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u51ed\u8bc1          </li> </ul>"},{"location":"tags.html#tag:nginx","title":"Nginx","text":"<ul> <li>            \u4f7f\u7528nginx\u5feb\u901f\u642d\u5efa\u53ea\u8bfbGit\u4ed3\u5e93          </li> </ul>"},{"location":"tags.html#tag:otp","title":"OTP","text":"<ul> <li>            Linux \u5f00\u542f OTP \u4e8c\u6b21\u8ba4\u8bc1          </li> </ul>"},{"location":"tags.html#tag:onlyoffice","title":"OnlyOffice","text":"<ul> <li>            \u4f7f\u7528OnlyOffice\u5b98\u65b9Spring\u793a\u4f8b\u9047\u5230\u7684\u5751          </li> <li>            \u7f16\u8bd1OnlyOffice\u4ee5\u89e3\u966420\u8fde\u63a5\u6570\u9650\u5236          </li> </ul>"},{"location":"tags.html#tag:openvpn","title":"OpenVPN","text":"<ul> <li>            OpenWrt\u5b89\u88c5OpenVPN          </li> </ul>"},{"location":"tags.html#tag:openwrt","title":"OpenWrt","text":"<ul> <li>            OpenWrt DDNS\u5f00\u673a\u542f\u52a8\u5931\u8d25\u95ee\u9898          </li> <li>            OpenWrt\u4fee\u6539\u9ed8\u8ba4Shell\u4e3abash\u5e76\u5f00\u542f\u5386\u53f2\u547d\u4ee4\u65f6\u95f4\u6233          </li> <li>            OpenWrt\u5b89\u88c5OpenVPN          </li> <li>            OpenWrt\u5b89\u88c5WireGuard          </li> <li>            \u5c0f\u7c73AX9000\u5237\u673a          </li> <li>            \u5c0f\u7c73AX9000\u52a0\u5165160MHz\u652f\u6301          </li> <li>            \u5c0f\u7c73AX9000\u89e3\u9501SSH          </li> </ul>"},{"location":"tags.html#tag:podman","title":"Podman","text":"<ul> <li>            \u57fa\u4e8eeBPF\u7684\u5bb9\u5668\u5ba1\u8ba1\u6280\u672f\u7684\u5b9e\u73b0          </li> </ul>"},{"location":"tags.html#tag:postgresql","title":"PostgreSQL","text":"<ul> <li>            AWX\u548cstolon\u9ad8\u53ef\u7528\u8c03\u4f18          </li> <li>            \u4f7f\u7528stolon\u5b89\u88c5\u9ad8\u53ef\u7528PostgreSQL          </li> </ul>"},{"location":"tags.html#tag:python","title":"Python","text":"<ul> <li>            Python\u5347\u7ea7\u6240\u6709\u4f9d\u8d56          </li> <li>            Python\u9650\u5236\u5185\u5b58\u548cCPU\u4f7f\u7528          </li> <li>            \u57fa\u4e8ePython\u7684\u6a21\u5757\u5316\u76d1\u63a7\u5de5\u5177\u7684\u5f00\u53d1          </li> <li>            \u6784\u5efa\u89e3\u538b\u5373\u7528\u7684Python3          </li> </ul>"},{"location":"tags.html#tag:qemu","title":"QEMU","text":"<ul> <li>            virt-manager\u521b\u5efa\u865a\u62df\u673a\u62a5\u9519\u201cDid not find any UEFI binary path for arch 'aarch64'\u201d\u95ee\u9898          </li> </ul>"},{"location":"tags.html#tag:rhel6","title":"RHEL6","text":"<ul> <li>            \u8bb0\u67d0\u6b21\u8bef\u64cd\u4f5cyum update\u540ejboss\u5e94\u7528\u65e0\u6cd5\u542f\u52a8\u53ca\u91cd\u542f\u65e0\u6cd5\u8bc6\u522bvg\u95ee\u9898          </li> </ul>"},{"location":"tags.html#tag:shell","title":"Shell","text":"<ul> <li>            Shell\u8bbe\u7f6e\u53d8\u91cf\u672a\u8d4b\u503c\u6216\u9047\u5230\u9519\u8bef\u7acb\u523b\u9000\u51fa          </li> </ul>"},{"location":"tags.html#tag:spring-security","title":"Spring Security","text":"<ul> <li>            SpringBoot 2.5.1 \u5bf9\u63a5Keycloak\u8ba4\u8bc1          </li> </ul>"},{"location":"tags.html#tag:springboot","title":"SpringBoot","text":"<ul> <li>            SpringBoot 2.5.1 \u5bf9\u63a5Keycloak\u8ba4\u8bc1          </li> <li>            \u4f7f\u7528OnlyOffice\u5b98\u65b9Spring\u793a\u4f8b\u9047\u5230\u7684\u5751          </li> </ul>"},{"location":"tags.html#tag:tftp","title":"TFTP","text":"<ul> <li>            TrueNAS iSCSI \u5b89\u88c5 Windows Server 2025          </li> </ul>"},{"location":"tags.html#tag:tetragon","title":"Tetragon","text":"<ul> <li>            \u57fa\u4e8eeBPF\u7684\u5bb9\u5668\u5ba1\u8ba1\u6280\u672f\u7684\u5b9e\u73b0          </li> </ul>"},{"location":"tags.html#tag:truenas","title":"TrueNAS","text":"<ul> <li>            TrueNAS iSCSI \u5b89\u88c5 Windows Server 2025          </li> <li>            TrueNAS\u5220\u9664\u6240\u6709\u7a7a\u5feb\u7167          </li> </ul>"},{"location":"tags.html#tag:typescript","title":"TypeScript","text":"<ul> <li>            Geeker-Admin\u63a5\u5165Keycloak\u8ba4\u8bc1          </li> </ul>"},{"location":"tags.html#tag:ubuntu","title":"Ubuntu","text":"<ul> <li>            Ubuntu\u5b89\u88c5Hyper-V\u5de5\u5177          </li> </ul>"},{"location":"tags.html#tag:vscode","title":"VSCode","text":"<ul> <li>            \u9e92\u9e9fV10SP4\u589e\u52a0VSCode\u652f\u6301          </li> </ul>"},{"location":"tags.html#tag:vue3","title":"Vue3","text":"<ul> <li>            Geeker-Admin\u63a5\u5165Keycloak\u8ba4\u8bc1          </li> </ul>"},{"location":"tags.html#tag:windows","title":"Windows","text":"<ul> <li>            TrueNAS iSCSI \u5b89\u88c5 Windows Server 2025          </li> </ul>"},{"location":"tags.html#tag:wireguard","title":"WireGuard","text":"<ul> <li>            OpenWrt\u5b89\u88c5WireGuard          </li> </ul>"},{"location":"tags.html#tag:zfs","title":"ZFS","text":"<ul> <li>            TrueNAS\u5220\u9664\u6240\u6709\u7a7a\u5feb\u7167          </li> </ul>"},{"location":"tags.html#tag:ebpf","title":"eBPF","text":"<ul> <li>            \u57fa\u4e8eeBPF\u7684\u5bb9\u5668\u5ba1\u8ba1\u6280\u672f\u7684\u5b9e\u73b0          </li> </ul>"},{"location":"tags.html#tag:fcitx","title":"fcitx","text":"<ul> <li>            \u5b89\u88c5xfce\u540efcitx\u53f3\u4e0a\u89d2\u663e\u793a\u4f46\u65e0\u6cd5\u9009\u62e9\u8f93\u5165\u6cd5\u95ee\u9898\u89e3\u51b3          </li> </ul>"},{"location":"tags.html#tag:google-authenticator","title":"google-authenticator","text":"<ul> <li>            Linux \u5f00\u542f OTP \u4e8c\u6b21\u8ba4\u8bc1          </li> </ul>"},{"location":"tags.html#tag:helm","title":"helm","text":"<ul> <li>            \u5b89\u88c5helm\u5305\u7ba1\u7406\u5668          </li> </ul>"},{"location":"tags.html#tag:iscsi","title":"iSCSI","text":"<ul> <li>            TrueNAS iSCSI \u5b89\u88c5 Windows Server 2025          </li> </ul>"},{"location":"tags.html#tag:iptables","title":"iptables","text":"<ul> <li>            \u8bb0\u67d0\u6b21\u67d0\u5b89\u5168\u5382\u5546\u5e94\u7528\u8fd0\u884c\u4e00\u6bb5\u65f6\u95f4\u540eLinux\u51fa\u73b0ping\u5ef6\u8fdf\u9ad8\u95ee\u9898\u7684\u89e3\u51b3\u601d\u8def          </li> </ul>"},{"location":"tags.html#tag:k3s","title":"k3s","text":"<ul> <li>            k3s\u5220\u9664namespace\u5361\u6b7b\u5728Terminating\u89e3\u51b3\u65b9\u6cd5          </li> </ul>"},{"location":"tags.html#tag:local-path-provisioner","title":"local-path-provisioner","text":"<ul> <li>            local-path-provisioner\u5b89\u88c5          </li> </ul>"},{"location":"tags.html#tag:metrics-server","title":"metrics-server","text":"<ul> <li>            \u5b89\u88c5metrics-server          </li> </ul>"},{"location":"tags.html#tag:mkdocs","title":"mkdocs","text":"<ul> <li>            mkdocs\u5728k8s\u4e0a\u7684\u90e8\u7f72          </li> </ul>"},{"location":"tags.html#tag:openresty","title":"openresty","text":"<ul> <li>            \u4f7f\u7528openresty\u5bb9\u5668\u4e3ak8s\u7684\u670d\u52a1\u63d0\u4f9bKeycloak\u8ba4\u8bc1\u670d\u52a1          </li> </ul>"},{"location":"tags.html#tag:sddm","title":"sddm","text":"<ul> <li>            Hyper-V\u73af\u5883\u4e0bsddm\u65e0\u6cd5\u542f\u52a8\u56fe\u5f62\u754c\u9762\u95ee\u9898\u89e3\u51b3          </li> </ul>"},{"location":"tags.html#tag:tlog","title":"tlog","text":"<ul> <li>            \u4f7f\u7528tlog\u5bf9\u767b\u5f55\u5230Linux\u4e0a\u7684\u7528\u6237\u8fdb\u884c\u5f55\u5c4f          </li> </ul>"},{"location":"tags.html#tag:traefik","title":"traefik","text":"<ul> <li>            \u5b89\u88c5traefik ingress controller          </li> </ul>"},{"location":"tags.html#tag:udev","title":"udev","text":"<ul> <li>            Linux\u914d\u7f6eudev\u89c4\u5219\u5ffd\u7565\u78c1\u76d8          </li> </ul>"},{"location":"tags.html#tag:xfce","title":"xfce","text":"<ul> <li>            Hyper-V\u73af\u5883\u4e0bsddm\u65e0\u6cd5\u542f\u52a8\u56fe\u5f62\u754c\u9762\u95ee\u9898\u89e3\u51b3          </li> <li>            \u5b89\u88c5xfce\u540efcitx\u53f3\u4e0a\u89d2\u663e\u793a\u4f46\u65e0\u6cd5\u9009\u62e9\u8f93\u5165\u6cd5\u95ee\u9898\u89e3\u51b3          </li> </ul>"},{"location":"tags.html#tag:\u4e2d\u6807\u9e92\u9e9fv7","title":"\u4e2d\u6807\u9e92\u9e9fV7","text":"<ul> <li>            \u66d9\u5149\u670d\u52a1\u5668\u88c5\u673a\u65e0RAID\u5361\u9a71\u52a8\u5bfc\u81f4\u4e0d\u80fd\u8bc6\u522b\u786c\u76d8\u95ee\u9898\u5206\u6790\u4e0e\u89e3\u51b3\u65b9\u6848          </li> <li>            \u8054\u60f3\u7269\u7406\u673aPXE\u88c5\u673a\u62a5\u9519\u201c\u6839\u5206\u533a\u627e\u4e0d\u5230\u201d\u539f\u56e0\u53ca\u89e3\u51b3\u65b9\u6cd5          </li> </ul>"},{"location":"tags.html#tag:\u5149\u732b\u7834\u89e3","title":"\u5149\u732b\u7834\u89e3","text":"<ul> <li>            \u5317\u4eac\u8054\u901a\u4e2d\u5174F4610U\u5149\u732b\u5f00\u8d85\u7ba1\u754c\u9762          </li> </ul>"},{"location":"tags.html#tag:\u5bbd\u5e26","title":"\u5bbd\u5e26","text":"<ul> <li>            \u5317\u4eac\u8054\u901a\u4e2d\u5174F4610U\u5149\u732b\u5f00\u8d85\u7ba1\u754c\u9762          </li> </ul>"},{"location":"tags.html#tag:\u601d\u6e90\u7b14\u8bb0","title":"\u601d\u6e90\u7b14\u8bb0","text":"<ul> <li>            \u601d\u6e90\u7b14\u8bb0k8s\u90e8\u7f72          </li> </ul>"},{"location":"tags.html#tag:\u94f6\u6cb3\u9e92\u9e9fv10","title":"\u94f6\u6cb3\u9e92\u9e9fV10","text":"<ul> <li>            virt-manager\u521b\u5efa\u865a\u62df\u673a\u62a5\u9519\u201cDid not find any UEFI binary path for arch 'aarch64'\u201d\u95ee\u9898          </li> <li>            \u8bb0\u67d0\u6b21\u67d0\u5b89\u5168\u5382\u5546\u5e94\u7528\u8fd0\u884c\u4e00\u6bb5\u65f6\u95f4\u540eLinux\u51fa\u73b0ping\u5ef6\u8fdf\u9ad8\u95ee\u9898\u7684\u89e3\u51b3\u601d\u8def          </li> <li>            \u94f6\u6cb3\u9e92\u9e9fV10\u5b89\u88c5Ceph          </li> <li>            \u94f6\u6cb3\u9e92\u9e9fV10\u5b89\u88c5Kubernetes          </li> <li>            \u9e92\u9e9fV10SP4\u589e\u52a0VSCode\u652f\u6301          </li> </ul>"},{"location":"%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/Vue3/Geeker-Admin%E6%8E%A5%E5%85%A5Keycloak%E8%AE%A4%E8%AF%81.html","title":"Geeker-Admin \u63a5\u5165 Keycloak \u8ba4\u8bc1","text":"","tags":["Geeker-Admin","Vue3","Keycloak","TypeScript"]},{"location":"%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/Vue3/Geeker-Admin%E6%8E%A5%E5%85%A5Keycloak%E8%AE%A4%E8%AF%81.html#1","title":"1. \u524d\u7f6e\u6761\u4ef6","text":"<ol> <li>Keycloak \u670d\u52a1\u5668\u8fd0\u884c\u5728 http://localhost:8080/ \u3002</li> <li>Keycloak \u670d\u52a1\u5668\u521b\u5efa Realm\uff0c\u540d\u79f0\u4e3a test \uff0c\u5e76\u5728\u5176\u4e2d\u521b\u5efa Client ID \u4e3a test-client \u3001 Client type \u4e3a OpenID Connect \u3001 Client authentication \u5173\u95ed\u3001 Valid redirect URIs \u548c Web origins \u5747\u4e3a * \u7684 Client \u3002</li> </ol>","tags":["Geeker-Admin","Vue3","Keycloak","TypeScript"]},{"location":"%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/Vue3/Geeker-Admin%E6%8E%A5%E5%85%A5Keycloak%E8%AE%A4%E8%AF%81.html#2-keycloak","title":"2. \u5b89\u88c5 Keycloak \u5bf9\u63a5\u5668","text":"<pre><code>npm i --save keycloak-js@24.0\n</code></pre>","tags":["Geeker-Admin","Vue3","Keycloak","TypeScript"]},{"location":"%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/Vue3/Geeker-Admin%E6%8E%A5%E5%85%A5Keycloak%E8%AE%A4%E8%AF%81.html#3","title":"3. \u52a0\u5165\u73af\u5883\u53d8\u91cf","text":"<p>\u5728 <code>.env.development</code> \u52a0\u5165\uff1a</p> <pre><code># keycloak options\nVITE_APP_KEYCLOAK_OPTIONS_URL = 'http://localhost:8080/'\nVITE_APP_KEYCLOAK_OPTIONS_REALM = 'test'\nVITE_APP_KEYCLOAK_OPTIONS_CLIENTID = 'test-client'\nVITE_APP_KEYCLOAK_OPTIONS_ONLOAD = 'login-required'\n</code></pre>","tags":["Geeker-Admin","Vue3","Keycloak","TypeScript"]},{"location":"%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/Vue3/Geeker-Admin%E6%8E%A5%E5%85%A5Keycloak%E8%AE%A4%E8%AF%81.html#4-maints-keycloak","title":"4. \u5728 main.ts \u4e2d\u52a0\u5165 keycloak \u8ba4\u8bc1","text":"<p>\u5728 <code>src/main.ts</code> \u4e2d\u52a0\u5165\u4ee5\u4e0b\u4ee3\u7801\uff0c\u5f15\u5165 Keycloak\uff1a</p> <pre><code>// \u5f15\u5165Keycloak\n// \u53c2\u8003\uff1ahttps://github.com/achernetsov/vue-keycloak-template\nimport Keycloak, {\n  type KeycloakConfig,\n  type KeycloakInitOptions,\n} from \"keycloak-js\";\nimport { useKeycloakStore } from \"@/store/modules/keycloakStore\";\n</code></pre> <p>\u4e3a Keycloak \u52a0\u5165 store\uff0c\u521b\u5efa\u6587\u4ef6 <code>src/stores/modules/keycloakStore.ts</code> \uff1a</p> <pre><code>import { ref } from \"vue\";\nimport { defineStore } from \"pinia\";\nimport type Keycloak from \"keycloak-js\";\n\n// https://pinia.vuejs.org/getting-started.html\nexport const useKeycloakStore = defineStore(\"keycloakStore\", () =&gt; {\n  const keycloak = ref(null as Keycloak | null);\n  return { keycloak };\n});\n</code></pre> <p>\u5728 <code>main.ts</code> \u4e2d\u52a0\u5165 Keycloak \u5c06\u4ee5\u4e0b\u4ee3\u7801\uff1a</p> <pre><code>app\n  .use(ElementPlus)\n  .use(directives)\n  .use(router)\n  .use(I18n)\n  .use(pinia)\n  .mount(\"#app\");\n</code></pre> <p>\u66ff\u6362\u4e3a\uff1a</p> <pre><code>app.use(ElementPlus).use(directives).use(router).use(I18n).use(pinia);\n\nlet keycloakConfig: KeycloakConfig = {\n  url: import.meta.env.VITE_APP_KEYCLOAK_OPTIONS_URL,\n  realm: import.meta.env.VITE_APP_KEYCLOAK_OPTIONS_REALM,\n  clientId: import.meta.env.VITE_APP_KEYCLOAK_OPTIONS_CLIENTID,\n};\nlet keycloak = new Keycloak(keycloakConfig);\nconst keycloakStore = useKeycloakStore();\nkeycloakStore.keycloak = keycloak;\nlet initOptions: KeycloakInitOptions = {\n  onLoad: \"login-required\",\n  enableLogging: true,\n  responseMode: \"query\", // \u53c2\u8003\uff1ahttps://github.com/keycloak/keycloak/issues/14742\n};\nkeycloak.init(initOptions).then((auth) =&gt; {\n  if (!auth) {\n    console.warn(\"Authentication failed\");\n  } else {\n    console.log(\"Authenticated\");\n    keycloak.loadUserInfo().then(() =&gt; {\n      app.mount(\"#app\");\n    });\n  }\n  //Token Refresh\n  setInterval(() =&gt; {\n    keycloak\n      .updateToken(70)\n      .then((refreshed) =&gt; {\n        if (refreshed) {\n          console.log(\"Token refreshed\");\n        } else {\n          console.warn(\"Token not refreshed\");\n        }\n      })\n      .catch(() =&gt; {\n        console.error(\"Failed to refresh token\");\n      });\n  }, 6000);\n});\n</code></pre>","tags":["Geeker-Admin","Vue3","Keycloak","TypeScript"]},{"location":"%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/Ceph/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Ceph.html","title":"\u94f6\u6cb3\u9e92\u9e9f V10 \u5b89\u88c5 Ceph","text":"","tags":["Ceph","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/Ceph/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Ceph.html#1","title":"1. \u7cfb\u7edf\u67b6\u6784","text":"<p>\u672c\u6b21\u5b89\u88c5\u7684 Ceph \u4ec5\u6709 3 \u4e2a\u8282\u70b9\uff0c\u5404\u4e2a\u8282\u70b9\u914d\u7f6e\u548c\u7528\u9014\u5982\u4e0b\uff1a</p> \u8282\u70b9\u540d\u79f0 IP \u5730\u5740 \u670d\u52a1\u5668\u89d2\u8272 \u914d\u7f6e\u8981\u6c42 ceph01 192.168.100.14 Ceph \u8282\u70b9 4C8G ceph02 192.168.100.15 Ceph \u8282\u70b9 4C8G ceph03 192.168.100.16 Ceph \u8282\u70b9 4C8G <p>\u5176\u4e2d\uff0c\u6240\u6709\u7684\u8282\u70b9\u90fd\u9700\u8981\u914d\u7f6e NTP \u65f6\u949f\u540c\u6b65\u670d\u52a1\u5668\uff0c\u4e14\u6240\u6709\u8282\u70b9\u90fd\u9700\u8981\u6709\u9ed8\u8ba4\u7f51\u5173\u3002\u540c\u65f6\uff0c\u9700\u8981\u4f7f\u7528 Ansible \u5bf9\u8fd9 3 \u4e2a\u8282\u70b9\u8fdb\u884c\u6279\u91cf\u914d\u7f6e\u3002</p>","tags":["Ceph","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/Ceph/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Ceph.html#2","title":"2. \u51c6\u5907\u5de5\u4f5c","text":"","tags":["Ceph","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/Ceph/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Ceph.html#21","title":"2.1 \u5b89\u88c5\u524d\u7cfb\u7edf\u53c2\u6570","text":"<p>\u6240\u6709\u8282\u70b9\u5747\u9700\u8981\u7981\u7528 swap \u3001\u5173\u95ed firewalld \u9632\u706b\u5899\u4e0e SELinux \uff1a</p> <pre><code># Disable swap\nsed -i '/^.*[[:space:]]*swap[[:space:]]*swap[[:space:]]*.*$/d' /etc/fstab\n# Disable firewalld\nsystemctl disable firewalld.service\n# Disable SELinux\nsed -i 's/^SELINUX=.*$/SELINUX=disabled/g' /etc/selinux/config\n# Reboot to apply changes\nreboot\n</code></pre>","tags":["Ceph","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/Ceph/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Ceph.html#22-ansible","title":"2.2 Ansible \u4e3b\u673a\u6e05\u5355\u914d\u7f6e","text":"<p>\u672c\u6587\u4f7f\u7528 Ansible \u6765\u5bf9\u8282\u70b9\u8fdb\u884c\u6279\u91cf\u64cd\u4f5c\uff0cAnsible \u4e3b\u673a\u6e05\u5355\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>[ceph]\n192.168.100.14\n192.168.100.15\n192.168.100.16\n</code></pre>","tags":["Ceph","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/Ceph/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Ceph.html#23","title":"2.3 \u4ecb\u8d28\u4e0b\u8f7d","text":"<p>\u5982\u679c\u9700\u8981\u79bb\u7ebf\u5b89\u88c5\uff0c\u9700\u8981\u989d\u5916\u51c6\u5907\u4e00\u53f0\u53ef\u4ee5\u901a\u5916\u7f51\u7684\u673a\u5668\u6765\u4e0b\u8f7d\u4ecb\u8d28\uff0c\u6b64\u673a\u5668\u4e5f\u9700\u8981\u7981\u7528 swap \u3001\u5173\u95ed firewalld \u9632\u706b\u5899\u4e0e SELinux \uff0c\u4e14\u81f3\u5c11\u9700\u8981\u5b89\u88c5 docker \u3002\u5176\u4e2d\u9700\u8981\u4e0b\u8f7d\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u53ca\u914d\u7f6e\u6587\u4ef6\u5982\u4e0b\uff1a</p> \u4ecb\u8d28\u540d\u79f0 \u4e0b\u8f7d\u5730\u5740 containerd-1.7.11-linux-amd64.tar.gz https://github.com/containerd/containerd/releases containerd.service https://raw.githubusercontent.com/containerd/containerd/main/containerd.service docker-24.0.7.tgz https://download.docker.com/linux/static/stable/x86_64/ docker.service https://github.com/moby/moby/blob/master/contrib/init/systemd/docker.service docker.socket https://github.com/moby/moby/blob/master/contrib/init/systemd/docker.socket <p>\u9700\u8981\u4e0b\u8f7d\u7684\u5bb9\u5668\u955c\u50cf\u5982\u4e0b\uff1a</p> \u955c\u50cf\u540d\u79f0 \u4e0b\u8f7d\u65b9\u5f0f quay.io/ceph/ceph:v18 \u4f7f\u7528 docker \u547d\u4ee4\u4e0b\u8f7d quay.io/ceph/ceph-grafana:9.4.7 \u4f7f\u7528 docker \u547d\u4ee4\u4e0b\u8f7d quay.io/prometheus/prometheus:v2.43.0 \u4f7f\u7528 docker \u547d\u4ee4\u4e0b\u8f7d quay.io/prometheus/alertmanager:v0.25.0 \u4f7f\u7528 docker \u547d\u4ee4\u4e0b\u8f7d quay.io/prometheus/node-exporter:v1.5.0 \u4f7f\u7528 docker \u547d\u4ee4\u4e0b\u8f7d registry:2 \u4f7f\u7528 docker \u547d\u4ee4\u4e0b\u8f7d <p>\u4f7f\u7528 docker \u4e0b\u8f7d\u5bb9\u5668\u955c\u50cf\u7684\u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code>docker pull [\u955c\u50cf\u540d\u79f0]\ndocker image save -i [\u955c\u50cf\u540d\u79f0].tar\n</code></pre> <p>\u5bfc\u5165 docker \u5bb9\u5668\u955c\u50cf\u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code>docker image load -i [\u955c\u50cf\u540d\u79f0].tar\n</code></pre>","tags":["Ceph","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/Ceph/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Ceph.html#3-containerd","title":"3. \u5b89\u88c5 containerd \u5bb9\u5668\u8fd0\u884c\u73af\u5883","text":"<p>\u6240\u6709\u7684 ceph \u8282\u70b9\u90fd\u9700\u8981\u5b89\u88c5 containerd \uff0c\u4f7f\u7528\u6b64 Ansible Playbook \u8fdb\u884c\u6279\u91cf\u5b89\u88c5\uff1a</p> containerd-install.yaml<pre><code>---\n- name: install containerd\n  hosts: all\n  tasks:\n    - name: extract containerd-1.7.11-linux-amd64.tar.gz\n      unarchive:\n        src: containerd-1.7.11-linux-amd64.tar.gz\n        dest: /usr/local/\n    - name: install containerd.service\n      copy:\n        src: containerd.service\n        dest: /usr/lib/systemd/system/containerd.service\n    - name: generate default containerd config\n      shell:\n        cmd: |\n          mkdir -p /etc/containerd/\n          containerd config default &gt; /etc/containerd/config.toml\n    - name: configure containerd to use systemd cgroup\n      replace:\n        path: /etc/containerd/config.toml\n        regexp: \"SystemdCgroup = false\"\n        replace: \"SystemdCgroup = true\"\n    - name: configure containerd to use pause:3.9\n      replace:\n        path: /etc/containerd/config.toml\n        regexp: \"registry.k8s.io/pause:3.8\"\n        replace: \"registry.k8s.io/pause:3.9\"\n    - name: enable and restart containerd service\n      systemd:\n        name: containerd\n        daemon_reload: yes\n        state: restarted\n        enabled: yes\n</code></pre>","tags":["Ceph","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/Ceph/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Ceph.html#4-docker","title":"4. \u5b89\u88c5 docker","text":"<p>\u6240\u6709\u7684 ceph \u8282\u70b9\u90fd\u9700\u8981\u5b89\u88c5 docker \uff0c\u4f7f\u7528\u6b64 Ansible Playbook \u8fdb\u884c\u6279\u91cf\u5b89\u88c5\uff1a</p> docker-install.yaml<pre><code>---\n- name: install docker\n  hosts: ceph\n  tasks:\n    - name: copy files to remote /tmp\n      copy:\n        src: \"{{ item }}\"\n        dest: /tmp/\n      with_items:\n        - docker-24.0.7.tgz\n        - docker.service\n        - docker.socket\n    - name: install docker\n      shell: |\n        cd /tmp\n        tar zxvf docker-24.0.7.tgz\n        cp docker/* /usr/bin/\n        cp docker.service docker.socket /usr/lib/systemd/system/\n        groupadd --system docker --gid 357\n    - name: enable and restart docker service\n      systemd:\n        name: docker\n        daemon_reload: yes\n        state: restarted\n        enabled: yes\n</code></pre>","tags":["Ceph","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/Ceph/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Ceph.html#5-cephadm-ceph","title":"5. \u5b89\u88c5 cephadm \u548c ceph","text":"<p>\u4f7f\u7528\u4ee5\u4e0b playbook \u5b89\u88c5 ceph \u548c cephadm\uff1a</p> <pre><code>---\n- name: install ceph\n  hosts: ceph\n  tasks:\n    - name: tag images\n      shell: |\n        docker image tag quay.io/prometheus/alertmanager:v0.25.0 localhost:5000/prometheus/alertmanager:v0.25.0\n        docker image tag quay.io/ceph/ceph-grafana:9.4.7 localhost:5000/ceph/ceph-grafana:9.4.7\n        docker image tag quay.io/ceph/ceph:v18 localhost:5000/ceph/ceph:v18\n        docker image tag quay.io/prometheus/node-exporter:v1.5.0 localhost:5000/prometheus/node-exporter:v1.5.0\n        docker image tag quay.io/prometheus/prometheus:v2.43.0 localhost:5000/prometheus/prometheus:v2.43.0\n    - name: run docker local registry\n      shell: |\n        docker run -d --restart=unless-stopped --name registry \\\n          -e \"REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY=/var/lib/registry\" \\\n          -e \"REGISTRY_STORAGE_CACHE_BLOBDESCRIPTOR=inmemory\" \\\n          -e \"REGISTRY_STORAGE_DELETE_ENABLED=true\" \\\n          -e \"REGISTRY_VALIDATION_DISABLED=true\" \\\n          -v \"registry-data:/var/lib/registry\" \\\n          -p \"127.0.0.1:5000:5000\" \\\n          registry:2\n        true\n    - name: push images to local repository\n      shell: |\n        docker push localhost:5000/prometheus/alertmanager:v0.25.0\n        docker push localhost:5000/ceph/ceph-grafana:9.4.7\n        docker push localhost:5000/ceph/ceph:v18\n        docker push localhost:5000/prometheus/node-exporter:v1.5.0\n        docker push localhost:5000/prometheus/prometheus:v2.43.0\n    - name: install cephadm\n      copy:\n        src: cephadm\n        dest: /usr/local/bin/\n        mode: 0755\n    - name: add ceph group\n      group:\n        name: ceph\n        gid: 167\n    - name: add ceph user\n      user:\n        name: ceph\n        uid: 167\n        shell: /sbin/nologin\n        expires: -1\n    - name: add /root/.bashrc environment variable\n      lineinfile:\n        path: /root/.bashrc\n        line: \"export CEPHADM_IMAGE=localhost:5000/ceph/ceph:v18\"\n</code></pre>","tags":["Ceph","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/Ceph/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Ceph.html#6-ceph01","title":"6. \u914d\u7f6e ceph01 \u8282\u70b9","text":"<p>\u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u5728 ceph01 \u8282\u70b9\uff0c\u521b\u5efa ceph \u96c6\u7fa4\uff1a</p> <pre><code>source ~/.bashrc\ncephadm bootstrap --mon-ip 192.168.100.14\n</code></pre> <p>\u4e4b\u540e\u4f7f\u7528<code>cephadm shell</code>\u547d\u4ee4\u8fdb\u5165 ceph \u547d\u4ee4\u884c\uff08\u6240\u6709 ceph \u547d\u4ee4\u5747\u9700\u8981\u5728 ceph \u547d\u4ee4\u884c\u6267\u884c\uff09\uff0c\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u4fee\u6539 ceph \u76f8\u5173\u5bb9\u5668\u4f7f\u7528\u672c\u5730\u955c\u50cf\u4ed3\u5e93\uff1a</p> <pre><code>ceph config set mgr mgr/cephadm/container_image_prometheus localhost:5000/prometheus/prometheus:v2.43.0\nceph config set mgr mgr/cephadm/container_image_node_exporter localhost:5000/prometheus/node-exporter:v1.5.0\nceph config set mgr mgr/cephadm/container_image_grafana localhost:5000/ceph/ceph-grafana:9.4.7\nceph config set mgr mgr/cephadm/container_image_alertmanager localhost:5000/prometheus/alertmanager:v0.25.0\n</code></pre> <p>\u91cd\u65b0\u90e8\u7f72 ceph \u5bb9\u5668\uff1a</p> <pre><code>ceph orch redeploy prometheus\nceph orch redeploy node-exporter\nceph orch redeploy grafana\nceph orch redeploy alertmanager\n</code></pre> <p>\u9a8c\u8bc1\uff1a</p> <pre><code>ceph orch ls\n</code></pre> <pre><code>NAME           PORTS        RUNNING  REFRESHED  AGE  PLACEMENT\nalertmanager   ?:9093,9094      1/1  7s ago     3m   count:1\nceph-exporter                   1/1  7s ago     3m   *\ncrash                           1/1  7s ago     3m   *\ngrafana        ?:3000           1/1  7s ago     3m   count:1\nmgr                             1/2  7s ago     3m   count:2\nmon                             1/5  7s ago     3m   count:5\nnode-exporter  ?:9100           1/1  7s ago     3m   *\nprometheus     ?:9095           1/1  7s ago     3m   count:1\n</code></pre> <p>\u5c06\u8282\u70b9 ceph01 \u8bbe\u7f6e\u6210\u7ba1\u7406\u8282\u70b9\uff1a</p> <pre><code>ceph orch host label add ceph01 _admin\n</code></pre> <p>\u68c0\u67e5 ceph \u6240\u6709\u8282\u70b9\uff1a</p> <pre><code>ceph orch host ls\n</code></pre> <pre><code>HOST    ADDR            LABELS  STATUS\nceph01  192.168.100.14  _admin\n</code></pre>","tags":["Ceph","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/Ceph/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Ceph.html#7-ceph","title":"7. \u5c06\u5176\u5b83\u8282\u70b9\u52a0\u5165 ceph \u96c6\u7fa4\u4f5c\u4e3a\u7ba1\u7406\u8282\u70b9","text":"<p>\u5728\u7b2c\u4e00\u4e2a\u8282\u70b9\u4e0a\uff0c\u5c06\u5269\u4e0b\u4e24\u4e2a\u8282\u70b9\u52a0\u5165 ceph \u96c6\u7fa4\uff08\u4ee5\u4e0b\u547d\u4ee4\u4e0d\u8981\u5728 ceph \u547d\u4ee4\u884c\u6267\u884c\uff09\uff1a</p> <pre><code>ssh-copy-id -f -i /etc/ceph/ceph.pub root@192.168.100.15\nssh-copy-id -f -i /etc/ceph/ceph.pub root@192.168.100.16\ncephadm shell -- ceph orch host add ceph02 192.168.100.15\ncephadm shell -- ceph orch host label add ceph02 _admin\ncephadm shell -- ceph orch host add ceph03 192.168.100.16\ncephadm shell -- ceph orch host label add ceph03 _admin\n</code></pre> <p>\u5c06 monitor \u90e8\u7f72\u5728\u4e09\u4e2a\u8282\u70b9\uff1a</p> <pre><code>ceph orch apply mon --placement=\"ceph01,ceph02,ceph03\"\n</code></pre> <p>\u5982\u679c\u4e09\u4e2a\u8282\u70b9\u5728\u4e00\u4e2a B \u6bb5\uff0c\u4f46\u662f\u4e0d\u5728\u4e00\u4e2a C \u6bb5\uff0c\u8fd8\u9700\u8981\u989d\u5916\u8fd0\u884c\u8fd9\u4e2a\u547d\u4ee4\u4fee\u6539 public_network \u5b50\u7f51\uff1a</p> <pre><code>ceph config set mon public_network 192.168.0.0/16\n</code></pre> <p>\u5b8c\u6210\u4ee5\u540e\uff0c\u68c0\u67e5 ceph \u4e3b\u673a\u5217\u8868\uff1a</p> <pre><code>ceph orch host ls\n</code></pre> <pre><code>HOST    ADDR            LABELS  STATUS\nceph01  192.168.100.14  _admin\nceph02  192.168.100.15  _admin\nceph03  192.168.100.16  _admin\n3 hosts in cluster\n</code></pre>","tags":["Ceph","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/Ceph/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Ceph.html#8-ceph","title":"8. \u5c06\u78c1\u76d8\u52a0\u5165 ceph","text":"<p>\u5c06\u4e09\u4e2a\u673a\u5668\u7684/dev/sdb \u52a0\u5165 ceph \u96c6\u7fa4\uff1a</p> <pre><code>ceph orch daemon add osd ceph01:/dev/sdb\nceph orch daemon add osd ceph02:/dev/sdb\nceph orch daemon add osd ceph03:/dev/sdb\n</code></pre>","tags":["Ceph","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/Ceph/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Ceph.html#9-ceph","title":"9. \u68c0\u67e5 ceph \u96c6\u7fa4\u72b6\u6001","text":"<pre><code>ceph status\n</code></pre> <pre><code>  cluster:\n    id:     2708c980-bdb5-11ee-9d2f-000c29838e6e\n    health: HEALTH_OK\n\n  services:\n    mon: 3 daemons, quorum ceph01,ceph02,ceph03 (age 3m)\n    mgr: ceph02.rlxrnd(active, since 3m), standbys: ceph01.ftqqta\n    osd: 3 osds: 3 up (since 22s), 3 in (since 38s)\n\n  data:\n    pools:   1 pools, 1 pgs\n    objects: 2 objects, 449 KiB\n    usage:   80 MiB used, 96 GiB / 96 GiB avail\n    pgs:     1 active+clean\n</code></pre>","tags":["Ceph","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/TrueNAS/TrueNAS%20iSCSI%20%E5%AE%89%E8%A3%85%20Windows%20Server%202025.html","title":"TrueNAS iSCSI \u5b89\u88c5 Windows Server 2025","text":"","tags":["TrueNAS","Windows","iSCSI","TFTP"]},{"location":"%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/TrueNAS/TrueNAS%20iSCSI%20%E5%AE%89%E8%A3%85%20Windows%20Server%202025.html#1","title":"1. \u51c6\u5907\u5de5\u4f5c","text":"<p>\u8981\u60f3\u5728 Windows Server \u5b89\u88c5\u5230 TrueNAS \u7684 iSCSI \u670d\u52a1\u5668\u4e0a\uff0c\u9700\u8981\u5148\u5177\u5907\u4ee5\u4e0b\uff1a</p> <ul> <li>HTTP \u670d\u52a1\u5668\uff1a\u7531 TrueNAS \u4e0a\u865a\u62df\u673a\u63d0\u4f9b</li> <li>TFTP \u670d\u52a1\u5668\uff1a\u7531 TrueNAS \u7684\u5bb9\u5668\u63d0\u4f9b</li> <li>iSCSI \u670d\u52a1\u5668\uff1a\u7531 TrueNAS \u63d0\u4f9b</li> <li>DNS \u548c DHCP \u670d\u52a1\u5668\uff1a\u7531 OpenWrt \u4e0a dnsmasq \u63d0\u4f9b</li> <li>SMB \u670d\u52a1\u5668\uff1a\u7531 TrueNAS \u63d0\u4f9b</li> </ul> <p>\u540c\u65f6\u9700\u8981\u5177\u5907\u4e00\u53f0\u5df2\u7ecf\u88c5\u597d Windows \u7684\u673a\u5668\u7528\u4e8e\u5236\u4f5c WinPE \u955c\u50cf\uff0c\u4e00\u53f0 Linux \u7684\u673a\u5668\u7528\u4e8e\u7f16\u8bd1 iPXE \u548c\u4e0a\u4f20 iPXE \u955c\u50cf\u5230 TFTP \u670d\u52a1\u5668</p>","tags":["TrueNAS","Windows","iSCSI","TFTP"]},{"location":"%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/TrueNAS/TrueNAS%20iSCSI%20%E5%AE%89%E8%A3%85%20Windows%20Server%202025.html#2-iscsi-lun","title":"2. \u5728 iSCSI \u4e0a\u5212\u5206\u4e00\u4e2a LUN","text":"<p>\u9996\u5148\u8fdb\u5165 Datasets \uff0c\u65b0\u5efa\u4e00\u4e2a Zvol \uff0c\u540d\u79f0\u4e3a <code>windows-server-2025</code> \uff0c\u5927\u5c0f\u4e3a 64 GB \uff1a  \u4e4b\u540e\u4e0d\u8981\u5fd8\u8bb0\u5bf9\u6b64 Zvol \u8bbe\u7f6e\u5b9a\u65f6\u5feb\u7167\uff0c\u4ee5\u9632 Windows \u66f4\u65b0\u65e0\u6cd5\u56de\u9000\uff1a  \u8fdb\u5165 Shares -&gt; iSCSI \uff0c\u70b9\u51fb Wizard \u5feb\u901f\u521b\u5efa\u4e00\u4e2a LUN \uff1a   \u521b\u5efa\u5b8c\u6210\u540e\u53ef\u6302\u8f7d\u6b64 LUN \u6765\u9a8c\u8bc1\u3002</p>","tags":["TrueNAS","Windows","iSCSI","TFTP"]},{"location":"%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/TrueNAS/TrueNAS%20iSCSI%20%E5%AE%89%E8%A3%85%20Windows%20Server%202025.html#3-tftp","title":"3. \u642d\u5efa TFTP \u670d\u52a1","text":"<p>\u76f4\u63a5\u4f7f\u7528 TrueNAS Scale \u7684\u5bb9\u5668\u529f\u80fd\u642d\u5efa TFTP \u670d\u52a1\uff0c\u5728 Apps \u91cc\u5b89\u88c5 <code>tftpd-hpa</code> \u5e94\u7528\u5373\u53ef\uff0c\u76f8\u5173\u914d\u7f6e\u9ed8\u8ba4\u5373\u53ef\u3002\u642d\u5efa\u5b8c\u6210\u540e\u4f7f\u7528 TFTP \u547d\u4ee4\u9a8c\u8bc1\uff0c\u6ce8\u610f TFTP \u547d\u4ee4\u662f\u6ca1\u6709 ls \u7684\u3002</p>","tags":["TrueNAS","Windows","iSCSI","TFTP"]},{"location":"%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/TrueNAS/TrueNAS%20iSCSI%20%E5%AE%89%E8%A3%85%20Windows%20Server%202025.html#4-dns-dhcp","title":"4. \u914d\u7f6e DNS \u548c DHCP \u670d\u52a1","text":"<p>DNS \u548c DHCP \u670d\u52a1\u7531 OpenWrt \u7684 dnsmasq \u63d0\u4f9b\uff0c\u9996\u5148\u914d\u7f6e\u57df\u540d <code>pxe.hxp.lan</code> \u89e3\u6790\u5230 HTTP \u670d\u52a1\u5668\uff0c\u5728 <code>Network -&gt; DHCP and DNS -&gt; Hostnames</code> \u91cc\uff0c\u6dfb\u52a0\u57df\u540d\u89e3\u6790\u3002\u4e4b\u540e\u5728 <code>Network -&gt; DHCP and DNS -&gt; PXE/TFTP</code> \u91cc\uff0c\u627e\u5230 <code>Special PXE boot options for Dnsmasq</code> \u6dfb\u52a0\u5982\u4e0b\u914d\u7f6e\uff1a  \u6ce8\u610f\u8fd9\u91cc <code>DHCP Options</code> \u4e3a\u9ed8\u8ba4\u503c\u3002\u4e0a\u7ea7\u754c\u9762\u91cc\uff0c\u4e0d\u52fe\u9009 <code>Enable TFTP server</code> \uff1a  \u914d\u7f6e\u5b8c\u6210\u5982\u56fe\u6240\u793a\u3002</p>","tags":["TrueNAS","Windows","iSCSI","TFTP"]},{"location":"%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/TrueNAS/TrueNAS%20iSCSI%20%E5%AE%89%E8%A3%85%20Windows%20Server%202025.html#5-ipxe-tftp","title":"5. \u7f16\u8bd1 iPXE \u955c\u50cf\u5e76\u4e0a\u4f20\u81f3 TFTP","text":"<p>\u8fd9\u91cc\u4f7f\u7528 RHEL 9 \u8fdb\u884c\u7f16\u8bd1\uff0c\u9996\u5148\u9700\u8981\u5b89\u88c5\u5982\u4e0b\u4f9d\u8d56\uff1a</p> <pre><code>sudo yum install git gcc binutils make perl xz-devel mtools\n</code></pre> <p>\u4e0b\u8f7d iPXE \u6e90\u7801\u5e76\u8fdb\u5165\u6e90\u7801\u76ee\u5f55\uff1a</p> <pre><code>git clone https://github.com/ipxe/ipxe.git\ncd src\n</code></pre> <p>\u65b0\u5efa <code>boot.ipxe</code> \u6587\u4ef6\uff0c\u6839\u636e\u5e8f\u5217\u53f7\u542f\u52a8\uff1a</p> <pre><code>#!ipxe\necho Configure dhcp ....\ndhcp\nchain --replace http://pxe.hxp.lan/http-boot.ipxe\nshell\n</code></pre> <p>\u6839\u636eMAC\u5730\u5740\u542f\u52a8\uff1a</p> <pre><code>#!ipxe\necho Serial number: ${serial}\necho Configure dhcp ....\ndhcp\nchain --replace http://pxe.hxp.lan:31485/ipxe/${netX/mac}.ipxe\n</code></pre> <p>\u8fd9\u4e2a iPXE \u4ec5\u8d1f\u8d23\u5c06\u7f51\u5361 DHCP \u83b7\u53d6\u5230 IP \u5730\u5740\uff0c\u5e76\u52a0\u8f7d <code>http://pxe.hxp.lan/http-boot.ipxe</code> \uff0c\u5982\u679c\u540e\u7eed\u9700\u8981\u4fee\u6539 iPXE \u5219\u4fee\u6539 HTTP \u670d\u52a1\u5668\u4e0a <code>http-boot.ipxe</code> \u800c\u4e0d\u662f\u91cd\u65b0\u7f16\u8bd1\u8fd9\u4e2a iPXE \u955c\u50cf\u3002\u7f16\u8bd1 iPXE \u955c\u50cf\uff1a</p> <pre><code>make bin-x86_64-efi/ipxe.efi EMBED=boot.ipxe\n</code></pre> <p>\u4e0a\u4f20\u7f16\u8bd1\u597d\u7684 ipxe.efi \u5230 TFTP \u670d\u52a1\u5668\uff08\u5982\u679c TFTP \u547d\u4ee4\u5361\u6b7b\uff0c\u9700\u8981\u4e34\u65f6\u7981\u7528\u9632\u706b\u5899\uff09\uff1a</p> <pre><code>cd bin-x86_64-efi\ntftp 172.21.0.2 -m binary -c put ipxe.efi\ntouch autoexec.ipxe\ntftp 172.21.0.2 -m binary -c put autoexec.ipxe\ncd ..\n</code></pre> <p>\u540c\u65f6\uff0c\u5728 HTTP \u670d\u52a1\u5668\u7684\u6839\u76ee\u5f55\u521b\u5efa <code>http-boot.ipxe</code> \u5982\u4e0b\uff1a</p> <pre><code>#!ipxe\necho Serial number: ${serial}\nchain --replace http://pxe.hxp.lan/boot-${serial}.ipxe\n</code></pre> <p>\u8fd9\u4e2a iPXE \u4f1a\u8f93\u51fa\u81ea\u5df1\u7684\u5e8f\u5217\u53f7\uff0c\u5e76\u52a0\u8f7d HTTP \u670d\u52a1\u5668\u6839\u76ee\u5f55\u4e0b <code>boot-[\u5e8f\u5217\u53f7].ipxe</code> \u811a\u672c\uff0c\u5b9e\u73b0\u4e0d\u540c\u673a\u5668 PXE \u542f\u52a8\u65f6\u6839\u636e\u5e8f\u5217\u53f7\u62c9\u53d6\u4e0d\u540c\u7684\u811a\u672c\u3002</p>","tags":["TrueNAS","Windows","iSCSI","TFTP"]},{"location":"%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/TrueNAS/TrueNAS%20iSCSI%20%E5%AE%89%E8%A3%85%20Windows%20Server%202025.html#6-winpe-http","title":"6. \u5236\u4f5c WinPE \u955c\u50cf\u5e76\u4e0a\u4f20\u81f3 HTTP \u670d\u52a1\u5668","text":"<p>\u9700\u8981 1 \u53f0 Windows \u7535\u8111\uff0c\u5148\u6309\u7167\u5fae\u8f6f\u5b98\u65b9\u6559\u7a0b\u5b89\u88c5 <code>Windows ADK</code> \u548c <code>Windows PE add-on for the Windows ADK</code> \uff1a  \u4e4b\u540e\u627e\u5230\u5f00\u59cb\u83dc\u5355\u91cc\u7684 <code>\u90e8\u7f72\u548c\u6620\u50cf\u5de5\u5177\u73af\u5883</code> \uff0c\u4f7f\u7528\u7ba1\u7406\u5458\u6743\u9650\u8fd0\u884c\uff0c\u4f1a\u5f97\u5230\u4e00\u4e2a CMD \u7a97\u53e3\uff0c\u8f93\u5165\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>cd \"..\\Windows Preinstallation Environment\\amd64\"\nmd C:\\WinPE_amd64\\mount\nDism /Mount-Image /ImageFile:\"en-us\\winpe.wim\" /index:1 /MountDir:\"C:\\WinPE_amd64\\mount\"\ncopype amd64 C:\\temp\\winpe\\amd64\nDism /Unmount-Image /MountDir:\"C:\\WinPE_amd64\\mount\" /Commit\nrd C:\\WinPE_amd64\\mount\nrd C:\\WinPE_amd64\n</code></pre> <p>\u4e4b\u540e\u5c06 <code>C:\\temp\\winpe\\amd64</code> \u590d\u5236\u5230 HTTP \u670d\u52a1\u5668\u7684\u6839\u76ee\u5f55\u4e0b\u3002</p>","tags":["TrueNAS","Windows","iSCSI","TFTP"]},{"location":"%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/TrueNAS/TrueNAS%20iSCSI%20%E5%AE%89%E8%A3%85%20Windows%20Server%202025.html#7-windows","title":"7. \u4fee\u6539 Windows \u5b89\u88c5\u955c\u50cf\u589e\u52a0\u9a71\u52a8","text":"<p>\u5bf9 Windows \u5b89\u88c5\u955c\u50cf sources \u76ee\u5f55\u4e0b boot.wim \u548c install.wim \u505a\u5982\u4e0b\u64cd\u4f5c\uff08\u9a71\u52a8\u53ef\u5728 <code>C:\\Windows\\System32\\DriverStore\\FileRepository</code> \u76ee\u5f55\u67e5\u627e\uff09\uff1a</p> <pre><code>md C:\\WinPE_amd64\\mount\nDism /Mount-Image /ImageFile:\"C:\\temp\\boot.wim\" /Index:1 /MountDir:\"C:\\WinPE_amd64\\mount\"\nDism /Image:\"C:\\WinPE_amd64\\mount\" /Add-Driver /Driver:\"C:\\Windows\\System32\\DriverStore\\FileRepository\" /ForceUnsigned /Recurse\nDism /Unmount-Image /MountDir:\"C:\\WinPE_amd64\\mount\" /Commit\nDism /Mount-Image /ImageFile:\"C:\\temp\\install.wim\" /Index:4 /MountDir:\"C:\\WinPE_amd64\\mount\"\nDism /Image:\"C:\\WinPE_amd64\\mount\" /Add-Driver /Driver:\"C:\\Windows\\System32\\DriverStore\\FileRepository\" /ForceUnsigned /Recurse\nDism /Unmount-Image /MountDir:\"C:\\WinPE_amd64\\mount\" /Commit\nrd C:\\WinPE_amd64\\mount\nrd C:\\WinPE_amd64\n</code></pre> <p>\u5176\u4e2d install.wim \u547d\u4ee4\u5e94\u5f53\u586b\u5165\u7684\u5e8f\u53f7\u5728\u8fd9\u91cc\u67e5\u770b\uff1a</p> <pre><code>Dism /Get-ImageInfo /ImageFile:\"C:\\temp\\install.wim\"\n</code></pre>","tags":["TrueNAS","Windows","iSCSI","TFTP"]},{"location":"%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/TrueNAS/TrueNAS%20iSCSI%20%E5%AE%89%E8%A3%85%20Windows%20Server%202025.html#8-windows-server","title":"8. \u5b89\u88c5 Windows Server","text":"<p>\u5728 HTTP \u670d\u52a1\u5668\u4e0a\uff0c\u6839\u76ee\u5f55\u5b58\u653e\u6587\u4ef6 <code>boot-[\u5e8f\u5217\u53f7].ipxe</code> \u4e3a\u5982\u4e0b\uff1a</p> <pre><code>#!ipxe\n\n# Attach SAN storage\necho attaching SAN storage\nset keep-san 1\nsanhook iscsi:172.21.0.2::::iqn.2005-10.org.freenas.ctl:windows-server-2025\n\n# Set webroot\nset webroot http://pxe.hxp.lan\necho Webroot is ${webroot}\n\n#Set architecture\ncpuid --ext 29 &amp;&amp; set arch amd64 || set arch x86\necho ARCH is ${arch}\n\n#Load wimboot\necho Loading Wimboot ...\nkernel ${webroot}/wimboot\ninitrd ${webroot}/${arch}/media/Boot/BCD BCD\ninitrd ${webroot}/${arch}/media/Boot/boot.sdi boot.sdi\ninitrd ${webroot}/${arch}/media/sources/boot.wim boot.wim\n\n#boot winpe\necho booting winpe\nboot\n</code></pre> <p>\u8ba9\u5f85\u88c5\u673a\u670d\u52a1\u5668\u4ece PXE \u542f\u52a8\uff1a </p> <p>\u63d0\u524d\u51c6\u5907 SMB \u670d\u52a1\u5668\u5e76\u5c06 Windows \u5b89\u88c5 ISO \u89e3\u538b\u81f3 winsrv2025 \u76ee\u5f55\uff0c\u542f\u52a8\u8fdb\u5165 WinPE \u540e\uff0c\u8fdb\u5165 CMD \u547d\u4ee4\u884c\uff0c\u6309\u4e0b Ctrl-C \uff0c\u7136\u540e\u6302\u8f7d SMB \u76ee\u5f55\u5230 <code>Z:</code> \u5e76\u8fd0\u884c <code>setup.exe</code> \uff1a</p> <pre><code>net use Z: \\\\172.21.0.2\\downloads\\others\\winsrv2025\nZ:\nsetup.exe\n</code></pre> <p></p> <p>\u5982\u679c\u5b89\u88c5\u5931\u8d25\u53ef\u80fd\u9700\u8981\u70b9\u51fb <code>use previous version of windows setup</code> \uff0c\u5b89\u88c5\u7cfb\u7edf\u5b8c\u6210\u540e\uff0c\u4fee\u6539 <code>boot-[\u5e8f\u5217\u53f7].ipxe</code> \u4e3a\u5982\u4e0b\uff1a</p> <pre><code>echo booting from SAN storage\nset keep-san 1\nsanboot iscsi:172.21.0.2::::iqn.2005-10.org.freenas.ctl:windows-server-2025\n</code></pre> <p>\u4e4b\u540e\u8fdb\u5165 PXE \u5219\u4f1a\u4ece iSCSI \u542f\u52a8\u3002</p>","tags":["TrueNAS","Windows","iSCSI","TFTP"]},{"location":"%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/TrueNAS/TrueNAS%20iSCSI%20%E5%AE%89%E8%A3%85%20Windows%20Server%202025.html#9-windows-server","title":"9. \u6fc0\u6d3b Windows Server","text":"<p>\u6fc0\u6d3b\u4e4b\u524d\uff0c\u5148\u67e5\u770b\u5f53\u524d Windows \u90fd\u6709\u54ea\u4e9b\u7248\u672c\uff0c\u5e76\u5c06\u5176\u8f6c\u6362\u4e3a\u975e\u8bd5\u7528\u7248\u672c\uff1a</p> <pre><code>DISM.exe /Online /Get-TargetEditions\n</code></pre> <p>\u8f6c\u6362\u4e3a\u975e\u8bd5\u7528\u7684 Datacenter \u7248\u672c\uff1a</p> <pre><code>DISM.exe /online /Set-Edition:ServerDatacenter /ProductKey:D764K-2NDRG-47T6Q-P8T8W-YP6DF /AcceptEula\n</code></pre> <p>\u91cd\u542f\u540e\uff0c\u4f7f\u7528\u5b98\u65b9 KMS \u5bc6\u94a5\u6fc0\u6d3b\uff1a</p> <pre><code>slmgr /ipk D764K-2NDRG-47T6Q-P8T8W-YP6DF\nslmgr /skms openwrt.hxp.lan\nslmgr /ato\nslmgr /dlv\n</code></pre> <p>\u8fd9\u91cc\u4f7f\u7528\u4e86 OpenWrt \u4f5c\u4e3a KMS \u670d\u52a1\u5668\u3002</p>","tags":["TrueNAS","Windows","iSCSI","TFTP"]},{"location":"%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/ZFS/TrueNAS%E5%88%A0%E9%99%A4%E6%89%80%E6%9C%89%E7%A9%BA%E5%BF%AB%E7%85%A7.html","title":"TrueNAS \u5220\u9664\u6240\u6709\u7a7a\u5feb\u7167","text":"","tags":["ZFS","TrueNAS"]},{"location":"%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/ZFS/TrueNAS%E5%88%A0%E9%99%A4%E6%89%80%E6%9C%89%E7%A9%BA%E5%BF%AB%E7%85%A7.html#1-zfs","title":"1. ZFS \u5217\u51fa\u6240\u6709\u5feb\u7167","text":"<p>\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5217\u51fa\u6240\u6709\u5feb\u7167:</p> <pre><code>zfs list -t snap\n</code></pre> <p>\u8be5\u547d\u4ee4\u8f93\u51fa\u5927\u81f4\u5982\u4e0b:</p> <pre><code>NAME                                   USED  AVAIL  REFER  MOUNTPOINT\nboot-pool/ROOT/24.04.0@pristine          8K      -   164M  -\nboot-pool/ROOT/24.04.0/conf@pristine     0B      -   140K  -\nboot-pool/ROOT/24.04.0/etc@pristine   1.06M      -  5.54M  -\nboot-pool/ROOT/24.04.0/opt@pristine      0B      -  74.1M  -\nboot-pool/ROOT/24.04.0/usr@pristine      0B      -  2.12G  -\nboot-pool/ROOT/24.04.0/var@pristine    716K      -  30.8M  -\nnas@auto-2023-10-28_20-00               80K      -   120K  -\nnas@auto-2023-10-28_21-00                0B      -   112K  -\nnas@auto-2023-10-28_22-00                0B      -   112K  -\nnas@auto-2023-10-28_23-00                0B      -   112K  -\nnas@auto-2023-10-29_00-00                0B      -   112K  -\nnas@auto-2023-10-29_01-00                0B      -   112K  -\nnas@auto-2023-10-29_02-00                0B      -   112K  -\nnas@auto-2023-10-29_03-00                0B      -   112K  -\nnas@auto-2023-10-29_04-00                0B      -   112K  -\nnas@auto-2023-10-29_05-00                0B      -   112K  -\nnas@auto-2023-10-29_06-00                0B      -   112K  -\nnas@auto-2023-10-29_07-00                0B      -   112K  -\nnas@auto-2023-10-29_08-00                0B      -   112K  -\n</code></pre>","tags":["ZFS","TrueNAS"]},{"location":"%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/ZFS/TrueNAS%E5%88%A0%E9%99%A4%E6%89%80%E6%9C%89%E7%A9%BA%E5%BF%AB%E7%85%A7.html#2-0b","title":"2. \u627e\u51fa\u6240\u6709\u5927\u5c0f\u4e3a 0B \u7684\u5feb\u7167\u5e76\u5220\u9664","text":"<p>\u4f7f\u7528\u4ee5\u4e0b\u811a\u672c,\u7528 awk \u63d0\u53d6\u51fa\u5927\u5c0f\u4e3a 0B \u7684\u5feb\u7167,\u5e76\u8f93\u51fa zfs \u5220\u9664\u5feb\u7167\u7684\u547d\u4ee4:</p> <p>remove_empty_snapshots.sh</p> <pre><code>#!/bin/bash\nsnapshots=$(zfs list -t snap | awk '$2==\"0B\"{print $1}')\nwhile read -r line;do\n    echo zfs destroy $line\ndone &lt;&lt;&lt; \"$snapshots\"\n</code></pre> <p>\u5c06\u6b64\u811a\u672c\u8f93\u51fa\u91cd\u5b9a\u5411\u5230\u6587\u4ef6 <code>remove.sh</code> :</p> <pre><code>/bin/bash remove_empty_snapshots.sh &gt; remove.sh\n</code></pre> <p>\u5728\u6838\u5bf9 <code>remove.sh</code> \u5185\u5bb9\u540e,\u8fd0\u884c <code>remove.sh</code> :</p> <pre><code>/bin/bash remove.sh\n</code></pre>","tags":["ZFS","TrueNAS"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Docker%26Podman/Dockerfile%E4%B8%AD%E4%B8%8D%E4%BF%9D%E7%95%99%E7%BC%96%E8%AF%91%E7%BC%93%E5%AD%98.html","title":"Dockerfile \u4e2d\u4e0d\u4fdd\u7559\u7f16\u8bd1\u7f13\u5b58","text":"<p>\u5728\u6784\u5efa OnlyOffice \u7684 Docker \u955c\u50cf\u65f6\uff0c\u9700\u8981\u5728 Dockerfile \u91cc\u4e0b\u8f7d\u6e90\u4ee3\u7801\u5e76\u7f16\u8bd1\uff0c\u4f46\u662f\u6e90\u4ee3\u7801\u7f16\u8bd1\u540e\uff0c\u7f16\u8bd1\u7684\u7f13\u5b58\u7531 40GB\uff0c\u5bfc\u81f4\u955c\u50cf\u6700\u7ec8\u7531 44GB\uff0c\u4f46\u662f\u5b9e\u9645\u6709\u7528\u7684\u53ea\u662f\u7f16\u8bd1\u540e\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u3002\u539f\u5148\u7684 Dockerfile \u5982\u4e0b\uff1a</p> <pre><code>FROM ubuntu:20.04\n\nENV TZ=Etc/UTC\nRUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; echo $TZ &gt; /etc/timezone\n\nRUN apt-get -y update &amp;&amp; \\\n    apt-get -y install python2 \\\n                       python3 \\\n                       sudo \\\n                       git \\\n                       postgresql \\\n                       rabbitmq-server \\\n                       nginx\nRUN ln -s /usr/bin/python2 /usr/bin/python\nWORKDIR /build\n\nRUN git clone https://github.com/ONLYOFFICE/build_tools.git\nRUN cd /build/build_tools/tools/linux &amp;&amp; ./automate.py server\nRUN sed -i 's/exports.LICENSE_CONNECTIONS = 20;/exports.LICENSE_CONNECTIONS = 99999;/' /build/server/Common/sources/constants.js\nRUN sed -i 's/\"--update\", \"1\"/\"--update\", \"0\"/' /build/build_tools/tools/linux/automate.py\nRUN cd /build/build_tools/tools/linux &amp;&amp; ./automate.py server\n</code></pre> <p>\u8fd9\u4e2a Dockerfile \u6784\u5efa\u51fa\u7684\u955c\u50cf\u4e2d\uff0c\u53ea\u6709 <code>/build/build_tools/out/linux_64/onlyoffice/documentserver</code> \u4e2d\u7684\u6587\u4ef6\u6709\u7528\uff0c\u5176\u5b83\u6587\u4ef6\u6ca1\u6709\u7528\u3002\u5982\u679c\u5c1d\u8bd5\u5728 Dockerfile \u4e2d\u5c06\u5176 <code>rm -rf</code> \u6389\uff0c\u4f1a\u4e0d\u8d77\u4f5c\u7528\u3002\u56e0\u4e3a\u5199\u5165 image layer \u7684\u4e1c\u897f\u662f\u5220\u4e0d\u6389\u7684\u3002\u8fd9\u65f6\u5019\u5c31\u9700\u8981\u4f7f\u7528 Dockerfile \u7684\u591a\u9636\u6bb5\u6784\u5efa\uff1a</p> <pre><code>FROM ubuntu:20.04\n\nENV TZ=Etc/UTC\nRUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; echo $TZ &gt; /etc/timezone\n\nRUN apt-get -y update &amp;&amp; \\\n    apt-get -y install python2 \\\n                       python3 \\\n                       sudo \\\n                       git \\\n                       postgresql \\\n                       rabbitmq-server \\\n                       nginx\nRUN ln -s /usr/bin/python2 /usr/bin/python\nWORKDIR /build\n\nRUN git clone https://github.com/ONLYOFFICE/build_tools.git\nRUN cd /build/build_tools/tools/linux &amp;&amp; ./automate.py server\nRUN sed -i 's/exports.LICENSE_CONNECTIONS = 20;/exports.LICENSE_CONNECTIONS = 99999;/' /build/server/Common/sources/constants.js\nRUN sed -i 's/\"--update\", \"1\"/\"--update\", \"0\"/' /build/build_tools/tools/linux/automate.py\nRUN cd /build/build_tools/tools/linux &amp;&amp; ./automate.py server\n\nFROM ubuntu:20.04\nCOPY --from=0 /build/build_tools/out/linux_64/onlyoffice/documentserver /var/www/html/\nRUN apt-get -y update &amp;&amp; apt-get -y install nginx\n\nCMD /bin/bash -c 'while true;do sleep 3600;done'\n</code></pre> <p>\u5373\u5148\u6784\u5efa\u4e00\u4e2a\u7f16\u8bd1\u955c\u50cf\uff0c\u7136\u540e\u628a\u7f16\u8bd1\u955c\u50cf\u91cc\u751f\u6210\u7684\u6709\u7528\u7684\u4e1c\u897f\u590d\u5236\u5230\u7b2c\u4e8c\u4e2a\u955c\u50cf\uff0c\u518d\u6784\u5efa\u7b2c\u4e8c\u4e2a\u955c\u50cf\u3002</p> <p>\u540c\u65f6\uff0c\u7f16\u8bd1\u5b8c\u6210\u4ee5\u540e\uff0c\u8fd8\u9700\u8981\u6e05\u7406 docker \u7684 overlay2 \u91cc\u7684\u7f13\u5b58\u7b49\u5176\u5b83\u7f13\u5b58\uff1a</p> <pre><code>docker system prune -a\n</code></pre>","tags":["Docker"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Docker%26Podman/Dockerfile%E4%B8%AD%E4%B8%8D%E4%BF%9D%E7%95%99%E7%BC%96%E8%AF%91%E7%BC%93%E5%AD%98.html#1","title":"1. \u53c2\u8003\u94fe\u63a5","text":"<p>https://docs.docker.com/build/building/multi-stage/</p>","tags":["Docker"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Docker%26Podman/%E5%9F%BA%E4%BA%8EeBPF%E7%9A%84%E5%AE%B9%E5%99%A8%E5%AE%A1%E8%AE%A1%E6%8A%80%E6%9C%AF%E7%9A%84%E5%AE%9E%E7%8E%B0.html","title":"\u57fa\u4e8e eBPF \u7684\u5bb9\u5668\u5ba1\u8ba1\u6280\u672f\u7684\u5b9e\u73b0","text":"","tags":["Podman","Tetragon","eBPF"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Docker%26Podman/%E5%9F%BA%E4%BA%8EeBPF%E7%9A%84%E5%AE%B9%E5%99%A8%E5%AE%A1%E8%AE%A1%E6%8A%80%E6%9C%AF%E7%9A%84%E5%AE%9E%E7%8E%B0.html#1","title":"1. \u9879\u76ee\u9700\u6c42","text":"<p>\u67d0\u9879\u76ee\u9700\u8981\u76d1\u89c6\u8fd0\u884c\u5728 podman \u5bbf\u4e3b\u673a\u5185\u5bb9\u5668\u4e2d\u6240\u6709\u6587\u4ef6\u7684\u4fee\u6539\u548c\u7cfb\u7edf\u8c03\u7528\uff0c\u4f5c\u4e3a\u5ba1\u8ba1\u65e5\u5fd7\u3002\u65e5\u5fd7\u4e2d\u81f3\u5c11\u9700\u8981\u5305\u542b\u6267\u884c\u547d\u4ee4\u7684\u5bb9\u5668\u3001\u547d\u4ee4\u5185\u5bb9\u6216\u4fee\u6539\u7684\u6587\u4ef6\u3002</p> <p>\u4f7f\u7528 auditd \u65e0\u6cd5\u5b9e\u73b0\u6b64\u9700\u6c42\uff0c\u56e0\u4e3a\u5bb9\u5668\u5185 auditd \u65e0\u6cd5\u542f\u52a8\uff0caudit \u4f9d\u8d56\u4e8e\u5185\u6838 kaudit \u8fdb\u7a0b\uff0c\u5176\u5de5\u4f5c\u65b9\u5f0f\u4e3a\u5185\u6838\u6001 kauditd \u5728\u7cfb\u7edf\u8c03\u7528\u5c42\u8bb0\u5f55\u65e5\u5fd7\uff0c\u628a\u65e5\u5fd7\u653e\u5165\u4e00\u4e2a netlink \u5957\u63a5\u5b57\u4e2d\uff0c\u7528\u6237\u6001 auditd \u8fdb\u7a0b\u76d1\u542c\u8fd9\u4e2a\u5957\u63a5\u5b57\uff0c\u5c06\u65e5\u5fd7\u8f6c\u50a8\u5230\u7cfb\u7edf\u65e5\u5fd7\u6216\u65e5\u5fd7\u6587\u4ef6\u4e2d\u3002\u4e14\u4e00\u4e2a\u673a\u5668\u4e0a\u53ea\u8981\u6709\u4e00\u4e2a\u5bb9\u5668\u6216\u8005\u5bbf\u4e3b\u673a\u5f00\u542f auditd \uff0c\u5176\u5b83\u5bb9\u5668\u6216\u5bbf\u4e3b\u673a\u90fd\u65e0\u6cd5\u518d\u6b21\u542f\u52a8 auditd \u3002</p> <p>\u800c\u4e14\uff0c auditd \u4e0d\u652f\u6301 namespace \uff0c\u4e0d\u53ef\u80fd\u77e5\u9053\u662f\u90a3\u4e2a\u5bb9\u5668\u91cc\u6267\u884c\u4e86\u4ec0\u4e48\u547d\u4ee4\u3002\u56e0\u6b64\u89e3\u51b3\u8fd9\u4e2a\u65b9\u6cd5\u9700\u8981\u4f7f\u7528 eBPF \u5185\u6838\u63a2\u9488\u3002</p> <p>\u6b64\u65b9\u6848\u5728 RHEL8 \u5185\u6838\u7248\u672c <code>4.18.0-553.el8_10</code> \uff0c podman \u7248\u672c <code>4.9.4-rhel</code> \u4e0a\u6d4b\u8bd5\u901a\u8fc7\u3002</p>","tags":["Podman","Tetragon","eBPF"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Docker%26Podman/%E5%9F%BA%E4%BA%8EeBPF%E7%9A%84%E5%AE%B9%E5%99%A8%E5%AE%A1%E8%AE%A1%E6%8A%80%E6%9C%AF%E7%9A%84%E5%AE%9E%E7%8E%B0.html#2-tetragon","title":"2. \u4e91\u539f\u751f\u65b9\u6848\u4e0b\u7684\u5bb9\u5668\u5ba1\u8ba1\u5de5\u5177 Tetragon","text":"<p>Tetragon \u662f\u4e00\u4e2a\u5e94\u7528\u4e8e k8s \u3001 docker \u7b49\u5bb9\u5668\u73af\u5883\u4e0b\u7684\u5ba1\u8ba1\u5de5\u5177\uff0c\u5b83\u4f9d\u8d56\u4e8e eBPF \u6280\u672f\uff0c\u4ee5\u5bb9\u5668\u7684\u65b9\u5f0f\u8fd0\u884c\uff0c\u901a\u8fc7 eBPF \u7684 kprobe \u8bbe\u7acb hook \u7684\u65b9\u5f0f\u5b8c\u6210\u5bf9\u4e00\u4e2a\u5bb9\u5668\u5bbf\u4e3b\u673a\u4e0a\u6240\u6709\u5bb9\u5668\u7684\u547d\u4ee4\u6267\u884c\u4e0e\u6587\u4ef6\u4fee\u6539\u3001\u751a\u81f3\u7f51\u7edc\u8fde\u63a5\u7684\u5ba1\u8ba1\u3002\u672c\u6b21\u65b9\u6848\u5728 podman \u5bb9\u5668\u5bbf\u4e3b\u673a\u4e0a\u4f7f\u7528\u6b64\u65b9\u6848\u5b9e\u73b0\u3002</p>","tags":["Podman","Tetragon","eBPF"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Docker%26Podman/%E5%9F%BA%E4%BA%8EeBPF%E7%9A%84%E5%AE%B9%E5%99%A8%E5%AE%A1%E8%AE%A1%E6%8A%80%E6%9C%AF%E7%9A%84%E5%AE%9E%E7%8E%B0.html#3-tetragon","title":"3. \u8fd0\u884c Tetragon \u5bb9\u5668","text":"<p>\u9996\u5148\u65b0\u5efa\u6587\u4ef6\u5ba1\u8ba1\u914d\u7f6e\u6587\u4ef6 <code>file_monitoring.yaml</code> \uff1a</p> <pre><code>apiVersion: cilium.io/v1alpha1\nkind: TracingPolicy\nmetadata:\n  name: \"file-monitoring-filtered\"\nspec:\n  kprobes:\n    - call: \"security_file_permission\"\n      syscall: false\n      return: true\n      args:\n        - index: 0\n          type: \"file\" # (struct file *) used for getting the path\n        - index: 1\n          type: \"int\" # 0x04 is MAY_READ, 0x02 is MAY_WRITE\n      returnArg:\n        index: 0\n        type: \"int\"\n      returnArgAction: \"Post\"\n      selectors:\n        - matchArgs:\n            - index: 0\n              operator: \"NotPrefix\"\n              values:\n                - \"/dev/\" # Reads to sensitive directories\n                - \"/proc/\" # Reads to sensitive directories\n                - \"/var/log/tetragon/tetragon.log\"\n            - index: 1\n              operator: \"Equal\"\n              values:\n                - \"4\" # MAY_READ\n        - matchArgs:\n            - index: 0\n              operator: \"NotPrefix\"\n              values:\n                - \"/dev\" # Writes to sensitive directories\n                - \"/proc/\" # Reads to sensitive directories\n                - \"/var/log/tetragon/tetragon.log\"\n            - index: 1\n              operator: \"Equal\"\n              values:\n                - \"2\" # MAY_WRITE\n    - call: \"security_mmap_file\"\n      syscall: false\n      return: true\n      args:\n        - index: 0\n          type: \"file\" # (struct file *) used for getting the path\n        - index: 1\n          type: \"uint32\" # the prot flags PROT_READ(0x01), PROT_WRITE(0x02), PROT_EXEC(0x04)\n        - index: 2\n          type: \"uint32\" # the mmap flags (i.e. MAP_SHARED, ...)\n      returnArg:\n        index: 0\n        type: \"int\"\n      returnArgAction: \"Post\"\n      selectors:\n        - matchArgs:\n            - index: 0\n              operator: \"Prefix\"\n              values:\n                - \"/\" # Reads to sensitive directories\n            - index: 1\n              operator: \"Equal\"\n              values:\n                - \"1\" # MAY_READ\n            - index: 2\n              operator: \"Mask\"\n              values:\n                - \"1\" # MAP_SHARED\n        - matchArgs:\n            - index: 0\n              operator: \"Prefix\"\n              values:\n                - \"/\" # Writes to sensitive directories\n            - index: 1\n              operator: \"Mask\"\n              values:\n                - \"2\" # PROT_WRITE\n            - index: 2\n              operator: \"Mask\"\n              values:\n                - \"1\" # MAP_SHARED\n    - call: \"security_path_truncate\"\n      syscall: false\n      return: true\n      args:\n        - index: 0\n          type: \"path\" # (struct path *) used for getting the path\n      returnArg:\n        index: 0\n        type: \"int\"\n      returnArgAction: \"Post\"\n      selectors:\n        - matchArgs:\n            - index: 0\n              operator: \"Prefix\"\n              values:\n                - \"/\" # Truncate to sensitive directories\n</code></pre> <p>\u6ce8\u610f\uff0c\u5b9e\u9645\u4f7f\u7528\u4e2d\uff0c\u9700\u8981\u5bf9\u6b64\u914d\u7f6e\u6587\u4ef6\u8fdb\u884c\u8c03\u6574\u3002\u6b64\u914d\u7f6e\u6587\u4ef6\u5ba1\u8ba1\u6240\u6709\u6587\u4ef6\uff0c\u65e5\u5fd7\u91cf\u6781\u5927\u3002\u65b0\u5efa\u65e5\u5fd7\u5b58\u50a8\u8def\u5f84\u914d\u7f6e <code>export-filename</code> :</p> <pre><code>/var/log/tetragon/tetragon.log\n</code></pre> <p>\u4e4b\u540e\u542f\u52a8 Tetragon \u5bb9\u5668\uff1a</p> <pre><code>podman run -d --rm --name tetragon-container --rm \\\n  --pid=host --cgroupns=host --privileged \\\n  -v /sys/kernel/btf/vmlinux:/var/lib/tetragon/btf \\\n  -v ${PWD}/file_monitoring.yaml:/etc/tetragon/tetragon.tp.d/file_monitoring.yaml \\\n  -v ${PWD}/export-filename:/etc/tetragon/tetragon.conf.d/export-filename \\\n  quay.io/cilium/tetragon-ci:latest\n</code></pre> <p>\u5982\u679c\u60f3\u67e5\u770b\u5b9e\u65f6\u5ba1\u8ba1\u65e5\u5fd7\uff1a</p> <pre><code>podman exec tetragon-container tetra getevents -o json\n</code></pre>","tags":["Podman","Tetragon","eBPF"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Docker%26Podman/%E5%9F%BA%E4%BA%8EeBPF%E7%9A%84%E5%AE%B9%E5%99%A8%E5%AE%A1%E8%AE%A1%E6%8A%80%E6%9C%AF%E7%9A%84%E5%AE%9E%E7%8E%B0.html#4","title":"4. \u6d4b\u8bd5\u5ba1\u8ba1\u7ed3\u679c","text":"<p>\u8fd0\u884c\u4e00\u4e2a\u4e34\u65f6\u7684 ubuntu \u5bb9\u5668\uff1a</p> <pre><code>podman run -it --rm ubuntu /bin/bash\n</code></pre> <p>\u4e4b\u540e\u5728\u5bb9\u5668\u5185\u90e8\uff0c\u8fd0\u884c\u547d\u4ee4\uff1a</p> <pre><code>useradd testuser\ncat /etc/shadow\necho \"Hello, world!\" &gt; /tmp/passwd\nexit\n</code></pre> <p>\u4e4b\u540e\u8fdb\u5165 Tetragon \u5bb9\u5668\uff1a</p> <pre><code>podman exec -it tetragon-container /bin/bash\n</code></pre> <p>\u67e5\u770b\u5ba1\u8ba1\u65e5\u5fd7\uff1a</p> <pre><code>grep /tmp/passwd -rni /var/log/tetragon\n</code></pre> <p>\u627e\u5230\u5ba1\u8ba1\u65e5\u5fd7\u5982\u4e0b\uff1a</p> <pre><code>{\n  \"process_exit\": {\n    \"process\": {\n      \"exec_id\": \"OGJiZjEyNWNmNGI3OjI3NzM2NDExODc3ODU0Njg6NTc2NjY0\",\n      \"pid\": 576664,\n      \"uid\": 0,\n      \"cwd\": \"/\",\n      \"binary\": \"/usr/sbin/useradd\",\n      \"arguments\": \"testuser\",\n      \"flags\": \"execve rootcwd clone\",\n      \"start_time\": \"2024-06-27T06:06:07.223409055Z\",\n      \"auid\": 0,\n      \"docker\": \"89052e071b4ae7de344adf937794275\",\n      \"parent_exec_id\": \"OGJiZjEyNWNmNGI3OjI3NzM2MzU4NzIxMjg2MTI6NTc2NjUy\",\n      \"tid\": 576664\n    },\n    \"parent\": {\n      \"exec_id\": \"OGJiZjEyNWNmNGI3OjI3NzM2MzU4NzIxMjg2MTI6NTc2NjUy\",\n      \"pid\": 576652,\n      \"uid\": 0,\n      \"cwd\": \"/\",\n      \"binary\": \"/bin/bash\",\n      \"flags\": \"execve rootcwd clone\",\n      \"start_time\": \"2024-06-27T06:06:01.907752059Z\",\n      \"auid\": 0,\n      \"docker\": \"89052e071b4ae7de344adf937794275\",\n      \"parent_exec_id\": \"OGJiZjEyNWNmNGI3OjI3NzM2MzU3NTQxODkyNTg6NTc2NjQy\",\n      \"tid\": 576652\n    },\n    \"time\": \"2024-06-27T06:06:07.248861466Z\"\n  },\n  \"node_name\": \"8bbf125cf4b7\",\n  \"time\": \"2024-06-27T06:06:07.248861562Z\"\n}\n</code></pre> <pre><code>{\n  \"process_kprobe\": {\n    \"process\": {\n      \"exec_id\": \"OGJiZjEyNWNmNGI3OjI3NzM2NDEyMTM3ODA4ODc6NTc2Njcx\",\n      \"pid\": 576671,\n      \"uid\": 0,\n      \"cwd\": \"/\",\n      \"binary\": \"/usr/bin/cat\",\n      \"arguments\": \"/etc/shadow\",\n      \"flags\": \"execve rootcwd clone\",\n      \"start_time\": \"2024-06-27T06:06:07.249404483Z\",\n      \"auid\": 0,\n      \"docker\": \"89052e071b4ae7de344adf937794275\",\n      \"parent_exec_id\": \"OGJiZjEyNWNmNGI3OjI3NzM2MzU4NzIxMjg2MTI6NTc2NjUy\",\n      \"refcnt\": 1,\n      \"tid\": 576671\n    },\n    \"parent\": {\n      \"exec_id\": \"OGJiZjEyNWNmNGI3OjI3NzM2MzU4NzIxMjg2MTI6NTc2NjUy\",\n      \"pid\": 576652,\n      \"uid\": 0,\n      \"cwd\": \"/\",\n      \"binary\": \"/bin/bash\",\n      \"flags\": \"execve rootcwd clone\",\n      \"start_time\": \"2024-06-27T06:06:01.907752059Z\",\n      \"auid\": 0,\n      \"docker\": \"89052e071b4ae7de344adf937794275\",\n      \"parent_exec_id\": \"OGJiZjEyNWNmNGI3OjI3NzM2MzU3NTQxODkyNTg6NTc2NjQy\",\n      \"tid\": 576652\n    },\n    \"function_name\": \"security_file_permission\",\n    \"args\": [\n      { \"file_arg\": { \"path\": \"/etc/shadow\", \"permission\": \"-rw-r-----\" } },\n      { \"int_arg\": 4 }\n    ],\n    \"return\": { \"int_arg\": 0 },\n    \"action\": \"KPROBE_ACTION_POST\",\n    \"policy_name\": \"file-monitoring-filtered\",\n    \"return_action\": \"KPROBE_ACTION_POST\"\n  },\n  \"node_name\": \"8bbf125cf4b7\",\n  \"time\": \"2024-06-27T06:06:07.249857560Z\"\n}\n</code></pre> <pre><code>{\n  \"process_kprobe\": {\n    \"process\": {\n      \"exec_id\": \"OGJiZjEyNWNmNGI3OjI3NzM2MzU4NzIxMjg2MTI6NTc2NjUy\",\n      \"pid\": 576652,\n      \"uid\": 0,\n      \"cwd\": \"/\",\n      \"binary\": \"/bin/bash\",\n      \"flags\": \"execve rootcwd clone\",\n      \"start_time\": \"2024-06-27T06:06:01.907752059Z\",\n      \"auid\": 0,\n      \"docker\": \"89052e071b4ae7de344adf937794275\",\n      \"parent_exec_id\": \"OGJiZjEyNWNmNGI3OjI3NzM2MzU3NTQxODkyNTg6NTc2NjQy\",\n      \"refcnt\": 1,\n      \"tid\": 576652\n    },\n    \"parent\": {\n      \"exec_id\": \"OGJiZjEyNWNmNGI3OjI3NzM2MzU3NTQxODkyNTg6NTc2NjQy\",\n      \"pid\": 576642,\n      \"uid\": 0,\n      \"cwd\": \"/tmp\",\n      \"binary\": \"/usr/bin/conmon\",\n      \"arguments\": \"--api-version 1 -c 89052e071b4ae7de344adf937794275ccdb977e9d4aa1d68a9fdb5cc63959048 -u 89052e071b4ae7de344adf937794275ccdb977e9d4aa1d68a9fdb5cc63959048 -r /usr/bin/runc -b /var/lib/containers/storage/overlay-containers/89052e071b4ae7de344adf937794275ccdb977e9d4aa1d68a9fdb5cc63959048/userdata -p /run/containers/storage/overlay-containers/89052e071b4ae7de344adf937794275ccdb977e9d4aa1d68a9fdb5cc63959048/userdata/pidfile -n angry_wozniak --exit-dir /run/libpod/exits --full-attach -s -l k8s-file:/var/lib/containers/storage/overlay-containers/89052e071b4ae7de344adf937794275ccdb977e9d4aa1d68a9fdb5cc63959048/userdata/ctr.log --log-level warning --syslog --runtime-arg --log-format=json --runtime-arg --log --runtime-arg=/run/containers/storage/overlay-containers/89052e071b4ae7de344adf937794275ccdb977e9d4aa1d68a9fdb5cc63959048/userdata/oci-log -t --conmon-pidfile /run/containers/storage/overlay-containers/89052e071b4ae7de344adf937794275ccdb977e9d4aa1d68a9fdb5cc63959048/userdata/conmon.pid --exit-command /usr/bin/podman --exit-command-arg --root --exit-command-arg /var/lib/containers/storage --exit-command-arg --runroot --exit-command-arg /run/containers/storage --exit-command-arg --log-level --exit-command-arg warning --exit-command-arg --cgroup-manager --exit-command-arg systemd --exit-command-arg --tmpdir --exit-command-arg /run/libpod --exit-command-arg --network-config-dir --exit-command-arg  --exit-command-arg --network-backend --exit-command-arg cni --exit-command-arg --volumepath --exit-command-arg /var/lib/containers/storage/volumes --exit-command-arg --db-backend --exit-command-arg sqlite --exit-command-arg --transient-store=false --exit-command-arg --runtime --exit-command-arg runc --exit-command-arg --storage-driver --exit-command-arg overlay --exit-command-arg --storage-opt --exit-command-arg overlay.mountopt=nodev,metacopy=on --exit-command-arg --events-backend --exit-command-arg file --exit-command-arg container --exit-command-arg cleanup --exit-command-arg --rm --exit-command-arg 89052e071b4ae7de344adf937794275ccdb977e9d4aa1d68a9fdb5cc63959048\",\n      \"flags\": \"execve\",\n      \"start_time\": \"2024-06-27T06:06:01.789813045Z\",\n      \"auid\": 0,\n      \"parent_exec_id\": \"OGJiZjEyNWNmNGI3OjI3NzM2MzU3NDM1NTE5NDM6NTc2NjQx\",\n      \"refcnt\": 1,\n      \"tid\": 576642\n    },\n    \"function_name\": \"security_file_permission\",\n    \"args\": [\n      { \"file_arg\": { \"path\": \"/tmp/passwd\", \"permission\": \"-rw-r--r--\" } },\n      { \"int_arg\": 2 }\n    ],\n    \"return\": { \"int_arg\": 0 },\n    \"action\": \"KPROBE_ACTION_POST\",\n    \"policy_name\": \"file-monitoring-filtered\",\n    \"return_action\": \"KPROBE_ACTION_POST\"\n  },\n  \"node_name\": \"8bbf125cf4b7\",\n  \"time\": \"2024-06-27T06:06:07.250057584Z\"\n}\n</code></pre>","tags":["Podman","Tetragon","eBPF"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Docker%26Podman/%E5%9F%BA%E4%BA%8EeBPF%E7%9A%84%E5%AE%B9%E5%99%A8%E5%AE%A1%E8%AE%A1%E6%8A%80%E6%9C%AF%E7%9A%84%E5%AE%9E%E7%8E%B0.html#5","title":"5. \u53c2\u8003\u8d44\u6599","text":"<p>https://tetragon.io/docs/getting-started/file-events/</p> <p>https://tetragon.io/docs/concepts/tracing-policy/options/</p> <p>https://github.com/cilium/tetragon/blob/main/examples/quickstart/file_monitoring.yaml</p> <p>https://medium.com/@boutnaru/the-linux-process-journey-kauditd-25718f6c502d</p> <p>https://medium.com/@rhonnava/audit-logging-with-container-id-tagging-65e92c570f12</p> <p>https://access.redhat.com/articles/4494341</p>","tags":["Podman","Tetragon","eBPF"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/k3s%E5%88%A0%E9%99%A4namespace%E5%8D%A1%E6%AD%BB%E5%9C%A8Terminating%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95.html","title":"k3s \u5220\u9664 namespace \u5361\u6b7b\u5728 Terminating \u89e3\u51b3\u65b9\u6cd5","text":"","tags":["k3s"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/k3s%E5%88%A0%E9%99%A4namespace%E5%8D%A1%E6%AD%BB%E5%9C%A8Terminating%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95.html#1","title":"1. \u95ee\u9898\u73b0\u8c61","text":"<p>k3s \u5728\u5220\u9664 namespace \u65f6\uff0c\u5361\u6b7b\uff0c\u6309 Ctrl-C \u540e\u53d1\u73b0 namespace \u4e00\u76f4\u5904\u4e8e Terminating \u72b6\u6001\uff1a</p> <pre><code>$ kubectl get ns\nNAME              STATUS        AGE\nkube-system       Active        33d\ndefault           Active        33d\nkube-public       Active        33d\nkube-node-lease   Active        33d\nawx               Terminating   5d18h\n</code></pre>","tags":["k3s"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/k3s%E5%88%A0%E9%99%A4namespace%E5%8D%A1%E6%AD%BB%E5%9C%A8Terminating%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95.html#2","title":"2. \u89e3\u51b3\u65b9\u6cd5","text":"<p>\u7528\u4ee5\u4e0b\u547d\u4ee4\u6e05\u7406\uff1a</p> <pre><code>NS=`kubectl get ns |grep Terminating | awk 'NR==1 {print $1}'` &amp;&amp; kubectl get namespace \"$NS\" -o json   | tr -d \"\\n\" | sed \"s/\\\"finalizers\\\": \\[[^]]\\+\\]/\\\"finalizers\\\": []/\"   | kubectl replace --raw /api/v1/namespaces/$NS/finalize -f -\n</code></pre>","tags":["k3s"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/k3s%E5%88%A0%E9%99%A4namespace%E5%8D%A1%E6%AD%BB%E5%9C%A8Terminating%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95.html#3","title":"3. \u53c2\u8003\u6587\u732e","text":"<p>https://stackoverflow.com/questions/52369247/namespace-stucked-as-terminating-how-i-removed-it</p>","tags":["k3s"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/k8s%E5%BC%80%E5%90%AFswap%E6%94%AF%E6%8C%81.html","title":"k8s \u5f00\u542f swap \u652f\u6301","text":""},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/k8s%E5%BC%80%E5%90%AFswap%E6%94%AF%E6%8C%81.html#1","title":"1. \u9694\u79bb\u5e76\u9a71\u9010\u6240\u6709\u5bb9\u5668","text":"<pre><code>kubectl cordon awx-k8s-01\nkubectl drain awx-k8s-01 --ignore-daemonsets --delete-emptydir-data\n</code></pre>"},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/k8s%E5%BC%80%E5%90%AFswap%E6%94%AF%E6%8C%81.html#2-kubelet","title":"2. \u4fee\u6539 kubelet \u914d\u7f6e","text":"<p>\u4fee\u6539 <code>/var/lib/kubelet/config.yaml</code> \uff1a</p> <pre><code>memorySwap: {}\n</code></pre> <p>\u4fee\u6539\u4e3a\uff1a</p> <pre><code>failSwapOn: false\nfeatureGates:\n  NodeSwap: true\nmemorySwap:\n  swapBehavior: UnlimitedSwap\n</code></pre>"},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/k8s%E5%BC%80%E5%90%AFswap%E6%94%AF%E6%8C%81.html#3-kubelet","title":"3. \u91cd\u542f kubelet","text":"<pre><code>systemctl restart kubelet\nsystemctl status kubelet\n</code></pre>"},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/local-path-provisioner%E5%AE%89%E8%A3%85.html","title":"local-path-provisioner \u5b89\u88c5","text":"","tags":["Kubernetes","local-path-provisioner"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/local-path-provisioner%E5%AE%89%E8%A3%85.html#1-kubernetes","title":"1. \u521b\u5efa kubernetes \u76f8\u5173\u8d44\u6e90","text":"<p>\u4e0b\u8f7d yaml \u6587\u4ef6\u5e76\u5e94\u7528\uff1a</p> <pre><code>wget https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.26/deploy/local-path-storage.yaml\nkubectl apply -f local-path-storage.yaml\n</code></pre>","tags":["Kubernetes","local-path-provisioner"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/local-path-provisioner%E5%AE%89%E8%A3%85.html#2-local-path-provisioner","title":"2. \u521b\u5efa local-path-provisioner \u76ee\u5f55","text":"<p>\u5728\u6240\u6709\u8282\u70b9\uff0c\u521b\u5efa<code>/opt/local-path-provisioner</code>\u76ee\u5f55\uff08\u5efa\u8bae\u5bf9\u6b64\u76ee\u5f55\u5355\u72ec\u5efa\u7acb\u903b\u8f91\u5377</p>","tags":["Kubernetes","local-path-provisioner"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/local-path-provisioner%E5%AE%89%E8%A3%85.html#3-local-path-provisioner-storageclass","title":"3. \u5c06 local-path-provisioner \u8bbe\u7f6e\u4e3a\u9ed8\u8ba4 StorageClass","text":"<pre><code>kubectl patch storageclass local-path -p '{\"metadata\": {\"annotations\":{\"storageclass.kubernetes.io/is-default-class\":\"true\"}}}'\n</code></pre>","tags":["Kubernetes","local-path-provisioner"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/local-path-provisioner%E5%AE%89%E8%A3%85.html#4","title":"4. \u6d4b\u8bd5\u5e76\u9a8c\u8bc1","text":"<p>\u521b\u5efa pvc \u5e76\u6d4b\u8bd5\uff0c\u65b0\u5efa\u6587\u4ef6<code>test-pvc.yaml</code>\uff1a</p> <pre><code>---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: test-pvc\nspec:\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 1Gi\n  storageClassName: local-path\n</code></pre> <p>\u521b\u5efa pvc\uff1a</p> <pre><code>kubectl apply -f test-pvc.yaml\n</code></pre> <p>\u7531\u4e8e VolumeBindingMode \u8bbe\u7f6e\u6210\u4e86 WaitForFirstConsumer\uff0c\u9700\u8981\u542f\u52a8\u4e00\u4e2a pod \u6765\u4f7f\u7528 pvc\uff0cpv \u624d\u4f1a\u88ab\u521b\u5efa\uff1a</p> <pre><code>kubectl run -i --rm --tty busybox --overrides='\n{\n    \"apiVersion\": \"v1\",\n    \"spec\": {\n        \"containers\": [\n            {\n                \"name\": \"busybox\",\n                \"image\": \"docker.io/rancher/busybox:1.31.1\",\n                \"args\": [\n                    \"sh\"\n                ],\n                \"stdin\": true,\n                \"stdinOnce\": true,\n                \"tty\": true,\n                \"volumeMounts\": [\n                    {\n                        \"mountPath\": \"/home/store\",\n                        \"name\": \"store\"\n                    }\n                ]\n            }\n        ],\n        \"volumes\": [\n            {\n                \"name\": \"store\",\n                \"persistentVolumeClaim\": {\n                    \"claimName\": \"test-pvc\"\n                }\n            }\n        ]\n    }\n}\n'  --image=busybox --restart=Never -- /bin/sh\n</code></pre> <p>\u68c0\u67e5 pvc \u4e3a Bound \u72b6\u6001\uff1a</p> <pre><code>kubectl get pvc\n</code></pre> <pre><code>NAME       STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS    VOLUMEATTRIBUTESCLASS   AGE\ntest-pvc   Bound    pvc-9c92208e-cd5a-436a-a785-74b6dc00ae31   1Gi        RWX            csi-cephfs-sc   &lt;unset&gt;                 9m15s\n</code></pre>","tags":["Kubernetes","local-path-provisioner"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AE%89%E8%A3%85helm%E5%8C%85%E7%AE%A1%E7%90%86%E5%99%A8.html","title":"\u5b89\u88c5 helm \u5305\u7ba1\u7406\u5668","text":"","tags":["Kubernetes","helm"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AE%89%E8%A3%85helm%E5%8C%85%E7%AE%A1%E7%90%86%E5%99%A8.html#1","title":"1. \u51c6\u5907\u5de5\u4f5c","text":"","tags":["Kubernetes","helm"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AE%89%E8%A3%85helm%E5%8C%85%E7%AE%A1%E7%90%86%E5%99%A8.html#11","title":"1.1 \u4ecb\u8d28\u4e0b\u8f7d","text":"\u4ecb\u8d28\u540d\u79f0 \u4e0b\u8f7d\u5730\u5740 helm-v3.14.0-linux-amd64.tar.gz https://github.com/helm/helm/releases","tags":["Kubernetes","helm"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AE%89%E8%A3%85helm%E5%8C%85%E7%AE%A1%E7%90%86%E5%99%A8.html#2-ansible-playbook-k8s-helm","title":"2. \u4f7f\u7528 Ansible Playbook \u4e3a\u6240\u6709 k8s \u8282\u70b9\u6279\u91cf\u5b89\u88c5 helm","text":"<p>\u5c06 helm \u4e8c\u8fdb\u5236\u7a0b\u5e8f\u653e\u5230<code>/usr/local/bin/</code>\u5373\u53ef\u5b8c\u6210\u5b89\u88c5\uff0cplaybook \u5982\u4e0b\uff1a</p> helm-install.yaml<pre><code>---\n- name: install helm\n  hosts: k8s\n  tasks:\n  - name: unarchive files to remote /tmp\n    unarchive:\n      src: helm-v3.14.0-linux-amd64.tar.gz\n      dest: /tmp/\n  - name: install helm\n    copy:\n      src: /tmp/linux-amd64/helm\n      dest: /usr/local/bin/helm\n      mode: 0755\n      remote_src: yes\n</code></pre>","tags":["Kubernetes","helm"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AE%89%E8%A3%85helm%E5%8C%85%E7%AE%A1%E7%90%86%E5%99%A8.html#3","title":"3. \u53c2\u8003\u94fe\u63a5","text":"<p>https://helm.sh/docs/intro/install/</p> <p>https://stackoverflow.com/questions/50343089/how-to-use-helm-charts-without-internet-access</p> <p>https://stackoverflow.com/questions/60892265/extract-docker-images-from-helm-chart</p>","tags":["Kubernetes","helm"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AE%89%E8%A3%85metrics-server.html","title":"\u5b89\u88c5 metrics-server","text":"","tags":["Kubernetes","metrics-server"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AE%89%E8%A3%85metrics-server.html#1","title":"1. \u51c6\u5907\u5de5\u4f5c","text":"","tags":["Kubernetes","metrics-server"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AE%89%E8%A3%85metrics-server.html#11","title":"1.1 \u4ecb\u8d28\u4e0b\u8f7d","text":"<p>\u9700\u8981\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u4e0b\u8f7d metrics-server \u7684 helm chart\uff1a</p> <pre><code>helm repo add metrics-server https://kubernetes-sigs.github.io/metrics-server/\nhelm pull metrics-server/metrics-server\n</code></pre> <p>\u540c\u65f6\u9700\u8981\u4e0b\u8f7d\u6b64 helm chart \u6240\u9700\u7684\u5bb9\u5668\u955c\u50cf\uff0c\u955c\u50cf\u540d\u79f0\u7528\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\uff1a</p> <pre><code>helm install --dry-run metrics-server metrics-server-3.12.0.tgz | grep image:\n</code></pre>","tags":["Kubernetes","metrics-server"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AE%89%E8%A3%85metrics-server.html#2-helm-metrics-server","title":"2. \u4f7f\u7528 helm \u5b89\u88c5 metrics-server","text":"<p>\u5728\u5176\u4e2d\u4e00\u4e2a\u8282\u70b9\u521b\u5efa metrics-server \u7684 namespace \u5e76\u5b89\u88c5\uff1a</p> <pre><code>kubectl create ns metrics-server\nhelm install --namespace metrics-server metrics-server metrics-server-3.11.0.tgz\n</code></pre> <p>\u521b\u5efa\u4e4b\u540e\uff0c\u4fee\u6539 deployments \u914d\u7f6e\uff1a</p> <pre><code>kubectl -n metrics-server edit deployments.apps metrics-server\n</code></pre> <p>\u65b0\u589e<code>- --kubelet-insecure-tls</code>\u914d\u7f6e\uff0c\u4fee\u6539\u4e4b\u540e\u5982\u4e0b\uff1a</p> <pre><code>    spec:\n      containers:\n      - args:\n        - --secure-port=10250\n        - --cert-dir=/tmp\n        - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname\n        - --kubelet-use-node-status-port\n        - --metric-resolution=15s\n        - --kubelet-insecure-tls\n        image: registry.k8s.io/metrics-server/metrics-server:v0.6.4\n</code></pre> <p>\u4fee\u6539\u4e4b\u540e\u8f6e\u8be2\u91cd\u542f\u5bb9\u5668\uff0c\u5e76\u5c06\u5bb9\u5668\u4fee\u6539\u4e3a\u90e8\u7f72 3 \u4e2a\uff1a</p> <pre><code>kubectl -n metrics-server rollout restart deployment metrics-server\nkubectl -n metrics-server scale --replicas 3 deployment metrics-server\n</code></pre> <p>\u90e8\u7f72\u5b8c\u6210\u540e\u68c0\u67e5\u8d44\u6e90\u72b6\u6001\uff1a</p> <pre><code>kubectl get all -n metrics-server\n</code></pre> <pre><code>NAME                                  READY   STATUS    RESTARTS   AGE\npod/metrics-server-55f78d9d6f-4r98q   1/1     Running   0          32s\npod/metrics-server-55f78d9d6f-68t2q   1/1     Running   0          32s\npod/metrics-server-55f78d9d6f-cktdd   1/1     Running   0          102s\n\nNAME                     TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE\nservice/metrics-server   ClusterIP   10.108.4.192   &lt;none&gt;        443/TCP   8m2s\n\nNAME                             READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/metrics-server   3/3     3            3           8m2s\n\nNAME                                        DESIRED   CURRENT   READY   AGE\nreplicaset.apps/metrics-server-55f78d9d6f   3         3         3       102s\nreplicaset.apps/metrics-server-596d577f98   0         0         0       2m24s\nreplicaset.apps/metrics-server-5b76987ff    0         0         0       8m2s\n</code></pre> <p>\u4e4b\u540e\u6267\u884c<code>kubectl top pods -A</code>\u548c<code>kubectl top nodes</code>\uff0c\u89c2\u5bdf\u6709\u65e0\u62a5\u9519\u3002</p>","tags":["Kubernetes","metrics-server"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AE%89%E8%A3%85traefik%20ingress%20controller.html","title":"\u5b89\u88c5 traefik ingress controller","text":"","tags":["Kubernetes","traefik"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AE%89%E8%A3%85traefik%20ingress%20controller.html#1","title":"1. \u51c6\u5907\u5de5\u4f5c","text":"","tags":["Kubernetes","traefik"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AE%89%E8%A3%85traefik%20ingress%20controller.html#11","title":"1.1 \u4ecb\u8d28\u4e0b\u8f7d","text":"<p>\u9700\u8981\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u4e0b\u8f7d traefik \u7684 helm chart\uff1a</p> <pre><code>helm repo add traefik https://traefik.github.io/charts\nhelm pull traefik/traefik\n</code></pre> <p>\u540c\u65f6\u9700\u8981\u4e0b\u8f7d\u6b64 helm chart \u6240\u9700\u7684\u5bb9\u5668\u955c\u50cf\uff0c\u955c\u50cf\u540d\u79f0\u7528\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\uff1a</p> <pre><code>helm install --dry-run traefik traefik-27.0.2.tgz | grep image:\n</code></pre> <p>\u5982\u679c\u9700\u8981\u6d4b\u8bd5 traefik \u90e8\u7f72\uff0c\u8fd8\u9700\u8981\u4e0b\u8f7d\u5bb9\u5668\u955c\u50cf<code>docker.io/traefik/whoami:v1.10</code>\uff0c\u5e76\u4ece traefik \u5b98\u7f51\u7684 QuickStart \u7ae0\u8282\u4e0b\u8f7d yaml \u6587\u4ef6<code>03-whoami.yml</code>\u3001<code>03-whoami-services.yml</code>\u548c<code>04-whoami-ingress.yml</code>\u3002</p>","tags":["Kubernetes","traefik"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AE%89%E8%A3%85traefik%20ingress%20controller.html#2-values","title":"2. \u521b\u5efa\u5e76\u4fee\u6539 values","text":"<p>\u521b\u5efa<code>values.yaml</code>\uff1a</p> <pre><code>helm show values traefik-27.0.2.tgz &gt; values.yaml\n</code></pre> <p>\u5982\u679c\u4f7f\u7528\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\uff0c\u9700\u8981\u4fee\u6539<code>image</code>\u548c<code>imagePullSecrets</code>\u3002</p>","tags":["Kubernetes","traefik"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AE%89%E8%A3%85traefik%20ingress%20controller.html#3-helm-chart","title":"3. \u90e8\u7f72 helm chart","text":"<p>\u521b\u5efa namespace \u5e76\u90e8\u7f72\uff1a</p> <pre><code>kubectl create ns traefik\nhelm install --namespace traefik traefik traefik-27.0.2.tgz --values values.yaml\n</code></pre> <p>\u5c06\u5bb9\u5668\u90e8\u7f72\u4fee\u6539\u4e3a 3 \u4e2a\uff1a</p> <pre><code>kubectl -n traefik scale deployment traefik --replicas 3\n</code></pre>","tags":["Kubernetes","traefik"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AE%89%E8%A3%85traefik%20ingress%20controller.html#4","title":"4. \u914d\u7f6e\u8d1f\u8f7d\u5747\u8861\u5668","text":"<p>\u9996\u9009\u67e5\u8be2 traefik \u7684 NodePort \u7aef\u53e3\uff1a</p> <pre><code>kubectl get svc -n traefik\n</code></pre> <pre><code>NAME      TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE\ntraefik   LoadBalancer   10.96.103.221   &lt;pending&gt;     80:30795/TCP,443:32752/TCP   5d1h\n</code></pre> <p>\u8fd9\u91cc http \u7aef\u53e3 30795\uff0chttps \u7aef\u53e3 32752\uff0c\u914d\u7f6e\u8d1f\u8f7d\u5747\u8861\u5668\u7684 80 \u7aef\u53e3\u8f6c\u53d1\u5230\u6240\u6709 k8s \u8282\u70b9 30795 \u7aef\u53e3\uff0c443 \u7aef\u53e3\u8f6c\u53d1\u5230\u6240\u6709 k8s \u8282\u70b9 32752 \u7aef\u53e3\uff0c\u8d1f\u8f7d\u6a21\u5f0f\u4e3a TCP \u8f6e\u8be2\u3002\u5982\u679c\u4f7f\u7528\u7684\u662f\u5728 k8s master \u8282\u70b9\u4f7f\u7528 static pod \u65b9\u5f0f\u5b89\u88c5 HAProxy \u548c Keepalived \u7684\u65b9\u5f0f\uff0c\u5219\u9700\u8981\u4fee\u6539 HAProxy \u914d\u7f6e\uff1a</p> <pre><code>frontend web\n    bind *:80\n    mode tcp\n    option tcplog\n    default_backend webbackend\n\nbackend webbackend\n    mode tcp\n    balance     roundrobin\n        server k8s01 192.168.100.11:30795 check\n        server k8s02 192.168.100.12:30795 check\n        server k8s03 192.168.100.13:30795 check\n\nfrontend websecure\n    bind *:443\n    mode tcp\n    option tcplog\n    default_backend websecurebackend\n\nbackend websecurebackend\n    mode tcp\n    balance     roundrobin\n        server k8s01 192.168.100.11:32752 check\n        server k8s02 192.168.100.12:32752 check\n        server k8s03 192.168.100.13:32752 check\n</code></pre> <p>static pod \u91cd\u542f\u5fc5\u987b\u4f7f\u7528 crictl \u547d\u4ee4\uff0c\u9996\u5148\u627e\u5230 static pod \u7684\u5bb9\u5668 ID\uff1a</p> <pre><code>crictl ps | grep haproxy\n</code></pre> <pre><code>a0b4e29a3ba18 6600fae04efde 3 minutes ago Running haproxy 2 5e3faac3ce66d haproxy-k8s01\n</code></pre> <p>\u7136\u540e\u505c\u6b62\u5bb9\u5668\uff1a</p> <pre><code>crictl stop a0b4e29a3ba18\n</code></pre> <p>\u5728\u505c\u6b62\u5bb9\u5668\u540e kubelet \u4f1a\u81ea\u52a8\u5c06\u5176\u91cd\u65b0\u62c9\u8d77\u3002</p>","tags":["Kubernetes","traefik"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AE%89%E8%A3%85traefik%20ingress%20controller.html#5-whoami","title":"5. \u521b\u5efa whoami \u5bb9\u5668\u8fdb\u884c\u9a8c\u8bc1","text":"<p>\u5728 default \u547d\u540d\u7a7a\u95f4\uff0c\u521b\u5efa whoami \u5bb9\u5668\u3001service \u548c ingress\uff1a</p> <pre><code>kubectl apply -f 03-whoami.yml -f 03-whoami-services.yml -f 04-whoami-ingress.yml\n</code></pre> <p>\u4f7f\u7528 curl \u547d\u4ee4\u68c0\u67e5\uff1a</p> <pre><code>curl http://[\u8d1f\u8f7d\u5747\u8861\u5668VIP]/whoami/\n</code></pre> <pre><code>Hostname: whoami-78994d7bf9-x7lzr\nIP: 127.0.0.1\nIP: ::1\nIP: 172.18.209.24\nIP: fe80::209c:b5ff:fefa:ca79\nRemoteAddr: 172.18.209.20:41776\nGET /whoami/ HTTP/1.1\nHost: 192.168.100.10\nUser-Agent: curl/7.71.1\nAccept: */*\nAccept-Encoding: gzip\nX-Forwarded-For: 192.168.100.11\nX-Forwarded-Host: 192.168.100.10\nX-Forwarded-Port: 80\nX-Forwarded-Proto: http\nX-Forwarded-Server: traefik-deployment-65547f8865-27d6x\nX-Real-Ip: 192.168.100.11\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 whoami \u5bb9\u5668\u6536\u5230\u7684\u8bf7\u6c42\u91cc\u5e26\u7740\u6587\u6839 whoami\uff0c\u4e4b\u540e\u6d4b\u8bd5 middleware \u53bb\u9664\u6587\u6839\u529f\u80fd\uff0c\u4fee\u6539<code>04-whoami-ingress.yml</code>\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: whoami-ingress\n  annotations:\n    ingress.kubernetes.io/ssl-redirect: \"false\"\n    traefik.ingress.kubernetes.io/router.middlewares: default-strip-prefix@kubernetescrd\nspec:\n  rules:\n    - http:\n        paths:\n          - path: /\n            pathType: Prefix\n            backend:\n              service:\n                name: whoami\n                port:\n                  name: web\n---\napiVersion: traefik.containo.us/v1alpha1\nkind: Middleware\nmetadata:\n  name: strip-prefix\n  # No namespace defined\nspec:\n  stripPrefixRegex:\n    regex:\n      - ^/[^/]+\n</code></pre> <p>\u4fee\u6539\u5b8c\u6210\u540e\u5e94\u7528 yaml \u914d\u7f6e\uff1a</p> <pre><code>kubectl apply -f 04-whoami-ingress.yml\n</code></pre> <p>\u7528 curl \u547d\u4ee4\u6d4b\u8bd5\uff1a</p> <pre><code>curl http://[\u8d1f\u8f7d\u5747\u8861\u5668VIP]/whoami/\n</code></pre> <pre><code>Hostname: whoami-8c9864b56-dms8j\nIP: 127.0.0.1\nIP: ::1\nIP: 172.18.122.2\nIP: fe80::e840:22ff:fe60:51e7\nRemoteAddr: 172.18.209.2:41866\nGET / HTTP/1.1\nHost: 192.168.100.10\nUser-Agent: curl/7.61.1\nAccept: */*\nAccept-Encoding: gzip\nX-Forwarded-For: 172.18.122.0\nX-Forwarded-Host: 192.168.100.10\nX-Forwarded-Port: 80\nX-Forwarded-Prefix: /whoami\nX-Forwarded-Proto: http\nX-Forwarded-Server: traefik-858b7cfbcd-t4ltm\nX-Real-Ip: 172.18.122.0\n</code></pre> <p>\u6ce8\u610f\u8fd9\u91cc\u7684<code>GET /whoami/ HTTP/1.1</code>\u53d8\u6210\u4e86<code>GET / HTTP/1.1</code>\uff0c\u8bf4\u660e middleware \u751f\u6548\u3002\u6700\u540e\u6e05\u7406\u6d4b\u8bd5\u4f7f\u7528\u7684\u8d44\u6e90\uff1a</p> <pre><code>kubectl delete -f 03-whoami.yml -f 03-whoami-services.yml -f 04-whoami-ingress.yml\n</code></pre>","tags":["Kubernetes","traefik"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AE%89%E8%A3%85traefik%20ingress%20controller.html#6","title":"6. \u53c2\u8003\u94fe\u63a5","text":"<p>https://doc.traefik.io/traefik/getting-started/install-traefik/#use-the-helm-chart</p> <p>https://github.com/traefik/traefik-helm-chart/blob/master/EXAMPLES.md</p>","tags":["Kubernetes","traefik"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AF%B9%E6%8E%A5CephFS%E5%AD%98%E5%82%A8.html","title":"\u5bf9\u63a5 CephFS \u5b58\u50a8","text":"","tags":["Kubernetes","Ceph"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AF%B9%E6%8E%A5CephFS%E5%AD%98%E5%82%A8.html#1","title":"1. \u51c6\u5907\u5de5\u4f5c","text":"","tags":["Kubernetes","Ceph"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AF%B9%E6%8E%A5CephFS%E5%AD%98%E5%82%A8.html#11","title":"1.1 \u4ecb\u8d28\u4e0b\u8f7d","text":"<p>\u9700\u8981\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u4e0b\u8f7d ceph-csi-cephfs \u7684 helm chart\uff1a</p> <pre><code>helm repo add ceph-csi https://ceph.github.io/csi-charts\nhelm pull ceph-csi/ceph-csi-cephfs\n</code></pre> <p>\u540c\u65f6\u9700\u8981\u4e0b\u8f7d\u6b64 helm chart \u6240\u9700\u7684\u5bb9\u5668\u955c\u50cf\uff0c\u955c\u50cf\u540d\u79f0\u7528\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\uff1a</p> <pre><code>helm template ceph-csi-cephfs-3.10.1.tgz | grep 'image:'\n</code></pre>","tags":["Kubernetes","Ceph"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AF%B9%E6%8E%A5CephFS%E5%AD%98%E5%82%A8.html#2-cephfs-volume","title":"2. \u65b0\u5efa cephfs \u548c volume","text":"<p>\u5728 ceph \u670d\u52a1\u5668\u4e0a\uff0c\u4f7f\u7528<code>cephadm shell</code>\u8fdb\u5165 ceph \u547d\u4ee4\u884c\uff0c\u5e76\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>ceph fs volume create cephfs\nceph fs subvolumegroup create cephfs csi\n</code></pre> <p>\u6267\u884c\u4ee5\u540e\u68c0\u67e5\uff1a</p> <pre><code>ceph fs volume ls\n</code></pre> <pre><code>[\n    {\n        \"name\": \"cephfs\"\n    }\n]\n</code></pre> <pre><code>ceph fs subvolumegroup ls cephfs\n</code></pre> <pre><code>[\n    {\n        \"name\": \"csi\"\n    }\n]\n</code></pre>","tags":["Kubernetes","Ceph"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AF%B9%E6%8E%A5CephFS%E5%AD%98%E5%82%A8.html#3-ceph-admin-keyring","title":"3. ceph \u96c6\u7fa4\u914d\u7f6e\u548c admin keyring \u6536\u96c6","text":"<p>\u5728 ceph \u8282\u70b9\u4e0a\uff0c\u6536\u96c6 ceph \u914d\u7f6e\u548c admin \u7684 keyring\uff1a</p> <pre><code>ceph config generate-minimal-conf\n</code></pre> <pre><code># minimal ceph.conf for 77488730-b4d9-11ee-bec7-fa163e3bb924\n[global]\n    fsid = 77488730-b4d9-11ee-bec7-fa163e3bb924\n    mon_host = [v2:192.168.100.14:3300/0,v1:192.168.100.14:6789/0] [v2:192.168.100.15:3300/0,v1:192.168.100.15:6789/0] [v2:192.168.100.16:3300/0,v1:192.168.100.16:6789/0]\n</code></pre> <pre><code>ceph auth get client.admin\n</code></pre> <pre><code>[client.admin]\n    key = ********\n    caps mds = \"allow *\"\n    caps mgr = \"allow *\"\n    caps mon = \"allow *\"\n    caps osd = \"allow *\"\n</code></pre>","tags":["Kubernetes","Ceph"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AF%B9%E6%8E%A5CephFS%E5%AD%98%E5%82%A8.html#4-valuesyaml","title":"4. \u521b\u5efa values.yaml","text":"<p>\u9996\u5148\u751f\u6210 values.yaml\uff1a</p> <pre><code>helm show values ceph-csi-cephfs-3.10.1.tgz &gt; values.yaml\n</code></pre> <p>\u4fee\u6539\u4ee5\u4e0b\u7684\u90e8\u5206\uff1a</p> <pre><code>csiConfig:\n  - clusterID: \"77488730-b4d9-11ee-bec7-fa163e3bb924\"\n    monitors:\n      - \"192.168.100.14\"\n      - \"192.168.100.15\"\n      - \"192.168.100.16\"\n    cephFS:\n      subvolumeGroup: \"csi\"\n      # netNamespaceFilePath: \"{{ .kubeletDir }}/plugins/{{ .driverName }}/net\"\n# csiConfig: []\n</code></pre> <pre><code>secret:\n  # Specifies whether the secret should be created\n  create: true\n  name: csi-cephfs-secret\n  adminID: admin\n  adminKey: ********\n</code></pre> <pre><code>storageClass:\n  create: true\n  name: csi-cephfs-sc\n  clusterID: 77488730-b4d9-11ee-bec7-fa163e3bb924\n  fsName: cephfs\n</code></pre>","tags":["Kubernetes","Ceph"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AF%B9%E6%8E%A5CephFS%E5%AD%98%E5%82%A8.html#5-helm-chart-ceph-csi-cephfs","title":"5. \u4f7f\u7528 helm chart \u5b89\u88c5 ceph-csi-cephfs","text":"<pre><code>kubectl create namespace ceph-csi-cephfs\nhelm install --namespace \"ceph-csi-cephfs\" \"ceph-csi-cephfs\" ceph-csi-cephfs-3.10.1.tgz --values ./values.yaml\n</code></pre>","tags":["Kubernetes","Ceph"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AF%B9%E6%8E%A5CephFS%E5%AD%98%E5%82%A8.html#6-ceph-csi-sc-storage-class","title":"6. \u5c06 ceph-csi-sc \u8bbe\u7f6e\u4e3a\u9ed8\u8ba4 storage class","text":"<pre><code>kubectl patch storageclass ceph-csi-sc -p '{\"metadata\": {\"annotations\":{\"storageclass.kubernetes.io/is-default-class\":\"true\"}}}'\n</code></pre>","tags":["Kubernetes","Ceph"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AF%B9%E6%8E%A5CephFS%E5%AD%98%E5%82%A8.html#7-pvc","title":"7. \u521b\u5efa pvc \u5e76\u6d4b\u8bd5","text":"<p>\u65b0\u5efa\u6587\u4ef6<code>test-pvc.yaml</code>\uff1a</p> test-pvc.yaml<pre><code>---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: test-pvc\nspec:\n  accessModes:\n    - ReadWriteMany\n  resources:\n    requests:\n      storage: 1Gi\n  storageClassName: csi-cephfs-sc\n</code></pre> <p>\u521b\u5efa pvc\uff1a</p> <pre><code>kubectl apply -f test-pvc.yaml\n</code></pre> <p>\u68c0\u67e5 pvc \u72b6\u6001\u4e3a Bound \u5219\u4e3a\u5b89\u88c5\u6210\u529f\uff1a</p> <pre><code>kubectl get pvc\n</code></pre> <pre><code>NAME       STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS    VOLUMEATTRIBUTESCLASS   AGE\ntest-pvc   Bound    pvc-9c92208e-cd5a-436a-a785-74b6dc00ae31   1Gi        RWX            csi-cephfs-sc   &lt;unset&gt;                 9m15s\n</code></pre> <p>\u5982\u679c\u8981\u67e5\u8be2\u8fd9\u4e2a pvc \u5bf9\u5e94\u7684 pv \u5bf9\u5e94\u7684 cephfs \u5b58\u50a8\u4f4d\u7f6e\uff0c\u53ef\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>kubectl get pv $(kubectl get pvc test-pvc -o jsonpath=\"{.spec.volumeName}\") -o jsonpath='{.spec.csi.volumeAttributes.subvolumePath}';echo\n</code></pre> <p>\u6e05\u7406\uff1a</p> <pre><code>kubectl delete -f testpvc.yaml\n</code></pre>","tags":["Kubernetes","Ceph"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AF%B9%E6%8E%A5CephFS%E5%AD%98%E5%82%A8.html#8-k8s-cephfs","title":"8. \u5728\u975e k8s \u8282\u70b9\u6302\u8f7d cephfs \u7684\u65b9\u6cd5","text":"","tags":["Kubernetes","Ceph"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AF%B9%E6%8E%A5CephFS%E5%AD%98%E5%82%A8.html#81-ceph-fuse","title":"8.1 \u5b89\u88c5\u5e76\u914d\u7f6e ceph-fuse","text":"<p>\u5728 ceph \u5ba2\u6237\u7aef\u4e0a\u5b89\u88c5 ceph-fuse\uff1a</p> <pre><code>yum install ceph-fuse\n</code></pre> <p>\u914d\u7f6e<code>/etc/ceph/ceph.conf</code>\uff1a</p> <pre><code>mkdir -p -m 755 /etc/ceph\ncat &gt; /etc/ceph/ceph.conf &lt;&lt;-'EOF'\n[global]\n    fsid = 77488730-b4d9-11ee-bec7-fa163e3bb924\n    mon_host = 192.168.100.14:6789,192.168.100.15:6789,192.168.100.16:6789\nEOF\nchmod 644 /etc/ceph/ceph.conf\n</code></pre> <p>\u914d\u7f6e keyring\uff1a</p> <pre><code>cat &gt; /etc/ceph/ceph.client.admin.keyring &lt;&lt;-'EOF'\n[client.admin]\n    key = **********\nEOF\nchmod 600 /etc/ceph/ceph.client.admin.keyring\n</code></pre>","tags":["Kubernetes","Ceph"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AF%B9%E6%8E%A5CephFS%E5%AD%98%E5%82%A8.html#82-cephfs","title":"8.2 \u4e34\u65f6\u6302\u5728 cephfs","text":"<p>\u5982\u679c\u8981\u4e34\u65f6\u6302\u8f7d\uff0c\u4f7f\u7528\u547d\u4ee4\uff1a</p> <pre><code>ceph-fuse -n client.admin /mnt/cephfs\n</code></pre>","tags":["Kubernetes","Ceph"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AF%B9%E6%8E%A5CephFS%E5%AD%98%E5%82%A8.html#83-cephfs","title":"8.3 \u6c38\u4e45\u6302\u8f7d cephfs","text":"<p>\u5982\u679c\u8981\u6c38\u4e45\u6302\u8f7d\uff0c\u5219\u914d\u7f6e<code>/etc/fstab</code>\uff0c\u52a0\u5165\u4ee5\u4e0b\u884c\uff1a</p> <pre><code>none    /mnt/cephfs fuse.ceph   ceph.id=admin,_netdev   0   0\n</code></pre> <p>\u518d\u6302\u8f7d cephfs\uff1a</p> <pre><code>mkdir -p /mnt/cephfs\nmount /mnt/cephfs\n</code></pre>","tags":["Kubernetes","Ceph"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E5%AF%B9%E6%8E%A5CephFS%E5%AD%98%E5%82%A8.html#9","title":"9. \u53c2\u8003\u94fe\u63a5","text":"<p>https://www.pivert.org/ceph-csi-on-kubernetes-1-24/</p>","tags":["Kubernetes","Ceph"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E6%89%A9%E5%AE%B9master%E8%8A%82%E7%82%B9.html","title":"\u6269\u5bb9 master \u8282\u70b9","text":"","tags":["Kubernetes"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E6%89%A9%E5%AE%B9master%E8%8A%82%E7%82%B9.html#1","title":"1. \u5728\u5df2\u6709\u7684\u8282\u70b9\u4e0a\u751f\u6210\u52a0\u5165\u8282\u70b9\u7684\u547d\u4ee4","text":"<p>\u5728\u5df2\u6709\u7684 master \u8282\u70b9\u751f\u6210\u8bc1\u4e66\u548c\u52a0\u5165\u96c6\u7fa4\u547d\u4ee4\uff1a</p> <pre><code>kubeadm token create --print-join-command\n</code></pre> <pre><code>kubeadm join cluster-endpoint:8443 --token 9igvk8.ptcn52v5d7g261ff --discovery-token-ca-cert-hash sha256:b25ba14968a69b71974b51ee5996d61c3ae1940afcea673500b3d5468d41a1ee\n</code></pre> <pre><code>kubeadm init phase upload-certs --upload-certs\n</code></pre> <pre><code>W0417 16:23:10.938672 3195210 version.go:104] could not fetch a Kubernetes version from the internet: unable to get URL \"https://dl.k8s.io/release/stable-1.txt\": Get \"https://dl.k8s.io/release/stable-1.txt\": dial tcp: lookup dl.k8s.io on 21.126.129.88:53: no such host\nW0417 16:23:10.938728 3195210 version.go:105] falling back to the local client version: v1.29.2\n[upload-certs] Storing the certificates in Secret \"kubeadm-certs\" in the \"kube-system\" Namespace\n[upload-certs] Using certificate key:\n6147e16f74b590e74b53dd24e4e928dfeaf934c66229adb4036f6cbac792392a\n</code></pre>","tags":["Kubernetes"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E6%89%A9%E5%AE%B9master%E8%8A%82%E7%82%B9.html#2-k8s","title":"2. \u5728\u65b0\u8282\u70b9\u52a0\u5165 K8S \u96c6\u7fa4","text":"<p>\u5728\u65b0\u8282\u70b9\u4e0a\u4f7f\u7528 kubeadm \u547d\u4ee4\u52a0\u5165\u96c6\u7fa4\uff0c\u5e76\u4f5c\u4e3a master \u8282\u70b9\uff1a</p> <pre><code>kubeadm join cluster-endpoint:8443 --token 9igvk8.ptcn52v5d7g261ff --discovery-token-ca-cert-hash sha256:b25ba14968a69b71974b51ee5996d61c3ae1940afcea673500b3d5468d41a1ee --control-plane --certificate-key 6147e16f74b590e74b53dd24e4e928dfeaf934c66229adb4036f6cbac792392a\n</code></pre>","tags":["Kubernetes"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E6%89%A9%E5%AE%B9master%E8%8A%82%E7%82%B9.html#3-networkmanager-calico","title":"3. \u914d\u7f6e NetworkManager \u5ffd\u7565 calico \u7f51\u5361","text":"<p>\u5982\u679c k8s \u96c6\u7fa4\u4f7f\u7528 calico \u4f5c\u4e3a\u7f51\u7edc\u63d2\u4ef6\uff0c\u8fd8\u9700\u8981\u914d\u7f6e NetworkManager \u5ffd\u7565 calico \u7f51\u5361\uff0c\u53ef\u4f7f\u7528\u4ee5\u4e0b playbook \u6279\u91cf\u914d\u7f6e\uff1a</p> <pre><code>---\n- name: configure networkmanager for calico\n  hosts: k8s\n  tasks:\n    - name: create /etc/NetworkManager/conf.d/calico.conf\n      copy:\n        content: |\n          [keyfile]\n          unmanaged-devices=interface-name:cali*;interface-name:tunl*;interface-name:vxlan.calico;interface-name:vxlan-v6.calico;interface-name:wireguard.cali;interface-name:wg-v6.cali\n        dest: /etc/NetworkManager/conf.d/calico.conf\n    - name: restart networkmanager\n      systemd:\n        name: NetworkManager\n        state: restarted\n</code></pre>","tags":["Kubernetes"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E6%89%A9%E5%AE%B9master%E8%8A%82%E7%82%B9.html#4-bashrc","title":"4. \u4fee\u6539 bashrc","text":"<p>\u4fee\u6539 bashrc \u4f7f\u5f97\u9ed8\u8ba4 kubectl \u547d\u4ee4\u8fde\u63a5\u6b64 k8s \u96c6\u7fa4\uff1a</p> <pre><code>echo 'export KUBECONFIG=/etc/kubernetes/admin.conf' &gt;&gt; /root/.bashrc\nsource /root/.bashrc\n</code></pre>","tags":["Kubernetes"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E7%A6%81%E7%94%A8%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%B9%B6%E9%85%8D%E7%BD%AE%E7%A3%81%E7%9B%98%E7%9B%B8%E5%85%B3%E5%AE%B9%E5%99%A8%E6%BC%82%E7%A7%BB%E7%AD%96%E7%95%A5.html","title":"\u7981\u7528\u5bb9\u5668\u955c\u50cf\u5783\u573e\u56de\u6536\u5e76\u914d\u7f6e\u78c1\u76d8\u76f8\u5173\u5bb9\u5668\u6f02\u79fb\u7b56\u7565","text":"","tags":["Kubernetes"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E7%A6%81%E7%94%A8%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%B9%B6%E9%85%8D%E7%BD%AE%E7%A3%81%E7%9B%98%E7%9B%B8%E5%85%B3%E5%AE%B9%E5%99%A8%E6%BC%82%E7%A7%BB%E7%AD%96%E7%95%A5.html#1-k8s","title":"1. \u5728\u65e0\u955c\u50cf\u4ed3\u5e93\u7684\u60c5\u51b5\u4e0b\u4f7f\u7528 k8s \u7684\u95ee\u9898","text":"<p>k8s \u9ed8\u8ba4\u6709\u4e00\u4e2a\u5783\u573e\u56de\u6536\u673a\u5236\uff0c\u800c\u4e14\u5bb9\u5668\u7684\u4e34\u65f6\u5b58\u50a8\u548c\u5bb9\u5668\u7684\u955c\u50cf\u5b58\u50a8\u90fd\u5728/var \u76ee\u5f55\u4e0b\uff0c\u56e0\u6b64\u53ea\u8981\u6709/var \u76ee\u5f55\u5927\u4e8e 85%\u7684\u60c5\u51b5\uff08\u65e0\u8bba\u662f\u5bb9\u5668\u5199\u4e34\u65f6\u6587\u4ef6\u8fd8\u662f/var \u76ee\u5f55\u4e0b\u751f\u6210\u4e86\u5176\u5b83\u7279\u522b\u5927\u7684\u4e1c\u897f\uff0c\u8fd8\u662f\u5bfc\u5165\u5bb9\u5668\u955c\u50cf\uff09\uff0ck8s \u5c31\u4f1a\u628a\u6240\u6709\u7684\u5bb9\u5668\u8d76\u8d70\uff0c\u540c\u65f6\u4f1a\u5bf9\u5bb9\u5668\u955c\u50cf\u5783\u573e\u56de\u6536\u3002\u4f46\u662f\uff0c\u7531\u4e8e\u5bb9\u5668\u5df2\u7ecf\u90fd\u88ab\u8d76\u8d70\u4e86\uff0c\u5783\u573e\u56de\u6536\u4f1a\u628a\u8fd9\u4e9b\u5bb9\u5668\u955c\u50cf\u5220\u6389\uff0c\u4e4b\u540e\u5982\u679c\u5bb9\u5668\u955c\u50cf\u662f\u5728\u8282\u70b9\u624b\u52a8\u5bfc\u5165\u800c\u975e\u4ece\u955c\u50cf\u4ed3\u5e93\u62c9\u53d6\uff0c\u5219\u4f1a\u5bfc\u81f4\u5bb9\u5668\u955c\u50cf\u6c38\u8fdc\u4e22\u5931\uff0c\u8282\u70b9/var \u76ee\u5f55\u6e05\u7406\u6216\u6269\u5bb9\u540e\uff0c\u4ecd\u65e7\u65e0\u6cd5\u542f\u52a8\u5bb9\u5668\u3002\u56e0\u6b64\u9700\u8981\u628a\u5bb9\u5668\u7684\u5b58\u50a8\u4f4d\u7f6e\u5355\u72ec\u6302\u76d8\uff0c\u5e76\u4e14\u7981\u7528\u5bb9\u5668\u955c\u50cf\u7684\u5783\u573e\u56de\u6536\u3002</p> <p>\u8fd8\u662f\u4e0d\u63a8\u8350\u4e0d\u642d\u5efa\u4e00\u4e2a\u955c\u50cf\u4ed3\u5e93\uff0c\u56e0\u4e3a\u8fd9\u79cd\u65b9\u6cd5\u4e00\u65e6\u5bb9\u5668\u7684\u76ee\u5f55\u771f\u7684\u6ee1\u4e86\uff0c\u5fc5\u987b\u4eba\u5de5\u4e0a\u53bb ctr \u547d\u4ee4\u5220\u9664\u5bb9\u5668</p>","tags":["Kubernetes"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E7%A6%81%E7%94%A8%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%B9%B6%E9%85%8D%E7%BD%AE%E7%A3%81%E7%9B%98%E7%9B%B8%E5%85%B3%E5%AE%B9%E5%99%A8%E6%BC%82%E7%A7%BB%E7%AD%96%E7%95%A5.html#2-kubelet","title":"2. \u4fee\u6539 kubelet \u914d\u7f6e","text":"<p>\u5728<code>/var/lib/kubelet/config.yaml</code>\u4e2d\uff0c\u914d\u7f6e k8s \u8282\u70b9\u5728\u5bb9\u5668\u4e34\u65f6\u6587\u4ef6\u5b58\u50a8\u4f4e\u4e8e 10% \u65f6\uff0c\u8d76\u8d70\u6240\u6709\u5bb9\u5668\u5230\u5176\u5b83\u8282\u70b9\uff0c\u4e14\u5bb9\u5668\u955c\u50cf\u4e0d\u4f7f\u7528 100 \u5e74\u540e\u624d\u6e05\u7406\uff1a</p> <pre><code>evictionHard:\n  imagefs.available: \"10%\"\n  nodefs.available: \"5%\"\nimageGCHighThresholdPercent: 100\nimageGCLowThresholdPercent: 99\nimageMinimumGCAge: 876000h\n</code></pre> <p>\u91cd\u542f kublet\uff1a</p> <pre><code>systemctl restart kubelet.service\n</code></pre>","tags":["Kubernetes"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E7%A6%81%E7%94%A8%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%B9%B6%E9%85%8D%E7%BD%AE%E7%A3%81%E7%9B%98%E7%9B%B8%E5%85%B3%E5%AE%B9%E5%99%A8%E6%BC%82%E7%A7%BB%E7%AD%96%E7%95%A5.html#3-varlibcontainerd-lv","title":"3. \u5c06 /var/lib/containerd \u5355\u72ec\u6302\u8f7d lv\uff0c\u9632\u6b62\u7cfb\u7edf\u65e5\u5fd7\u6324\u5360\u5bb9\u5668\u7a7a\u95f4","text":"","tags":["Kubernetes"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E7%A6%81%E7%94%A8%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%B9%B6%E9%85%8D%E7%BD%AE%E7%A3%81%E7%9B%98%E7%9B%B8%E5%85%B3%E5%AE%B9%E5%99%A8%E6%BC%82%E7%A7%BB%E7%AD%96%E7%95%A5.html#31-k8s","title":"3.1 \u817e\u7a7a\u4e00\u4e2a k8s \u8282\u70b9","text":"<pre><code>kubectl cordon z10bansk8scp02\nkubectl drain z10bansk8scp02 --ignore-daemonsets --delete-emptydir-data\n</code></pre>","tags":["Kubernetes"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E7%A6%81%E7%94%A8%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%B9%B6%E9%85%8D%E7%BD%AE%E7%A3%81%E7%9B%98%E7%9B%B8%E5%85%B3%E5%AE%B9%E5%99%A8%E6%BC%82%E7%A7%BB%E7%AD%96%E7%95%A5.html#32","title":"3.2 \u6e05\u7406\u6570\u636e","text":"<p>\u505c\u6b62 kubelet\uff1a</p> <pre><code>systemctl stop kubelet.service\n</code></pre> <p>\u5220\u9664\u6240\u6709\u5bb9\u5668\uff1a</p> <pre><code>for i in $(ctr -n k8s.io task ls | awk '{print $1}');do ctr -n k8s.io task kill $i;done\nfor i in $(ctr -n k8s.io container ls | awk '{print $1}');do ctr -n k8s.io container delete $i;done\n</code></pre> <p>\u5220\u9664\u5bb9\u5668\u955c\u50cf\uff1a</p> <pre><code>ctr -n k8s.io image prune --all\n</code></pre> <p>\u505c\u6b62 containerd \u5e76\u6e05\u7406 containerd \u76ee\u5f55\uff1a</p> <pre><code>systemctl stop containerd\nrm -rf /var/lib/containerd/*\n</code></pre> <p>\u5c06 containerd \u955c\u50cf\u76ee\u5f55\u5355\u72ec\u6302\u8f7d lv\uff1a</p> <pre><code>lvcreate -n lv_containerd -L 30G rootvg\nmkfs.xfs /dev/rootvg/lv_containerd\necho \"/dev/rootvg/lv_containerd /var/lib/containerd xfs defaults 0 0\" &gt;&gt; /etc/fstab\nmount -a\n</code></pre> <p>\u542f\u52a8 containerd \u548c kubelet\uff0c\u5e76\u89e3\u9664\u9694\u79bb\u72b6\u6001\uff1a</p> <pre><code>systemctl restart containerd\nsystemctl restart kubelet.service\nkubectl uncordon z10bansk8scp02\n</code></pre>","tags":["Kubernetes"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E7%A6%81%E7%94%A8%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%B9%B6%E9%85%8D%E7%BD%AE%E7%A3%81%E7%9B%98%E7%9B%B8%E5%85%B3%E5%AE%B9%E5%99%A8%E6%BC%82%E7%A7%BB%E7%AD%96%E7%95%A5.html#33","title":"3.3 \u91cd\u65b0\u5bfc\u5165\u5bb9\u5668\u955c\u50cf\u5e76\u68c0\u67e5\uff1a","text":"<pre><code>for i in *;do ctr -n k8s.io image import $i --platform linux/amd64;done\nctr -n k8s.io images list | grep -v ^sha256 | awk '{print $1}' | nl\n</code></pre>","tags":["Kubernetes"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E7%A6%81%E7%94%A8%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%B9%B6%E9%85%8D%E7%BD%AE%E7%A3%81%E7%9B%98%E7%9B%B8%E5%85%B3%E5%AE%B9%E5%99%A8%E6%BC%82%E7%A7%BB%E7%AD%96%E7%95%A5.html#4","title":"4. \u53c2\u8003\u94fe\u63a5","text":"<p>https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/</p> <p>https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/</p> <p>https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/</p>","tags":["Kubernetes"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%85%8D%E7%BD%AE%E7%A7%81%E6%9C%89%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%E5%87%AD%E8%AF%81.html","title":"\u914d\u7f6e\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u51ed\u8bc1","text":"","tags":["Kubernetes","Nexus"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%85%8D%E7%BD%AE%E7%A7%81%E6%9C%89%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%E5%87%AD%E8%AF%81.html#1-docker","title":"1. docker \u914d\u7f6e\u6dfb\u52a0","text":"<p>\u5728 Nexus \u865a\u62df\u673a<code>192.168.100.12</code>\u4e0a\uff0c\u83b7\u53d6 docker \u914d\u7f6e<code>~/.docker/config.json</code>\u5982\u4e0b\uff1a</p> <pre><code>{\n  \"auths\": {\n    \"192.168.100.12:8082\": {\n      \"auth\": \"**********\"\n    },\n    \"192.168.100.12:8083\": {\n      \"auth\": \"**********\"\n    }\n  }\n}\n</code></pre> <p>\u5c06\u6b64\u914d\u7f6e\u590d\u5236\u5230 kubernetes \u7684 master \u8282\u70b9\u7684<code>/tmp/config.json</code>\uff0c\u5e76\u52a0\u5165\u51ed\u8bc1\u5230 <code>keycloak</code> \u547d\u540d\u7a7a\u95f4\uff1a</p> <pre><code>kubectl -n keycloak create secret generic nexus-regcred --from-file=.dockerconfigjson=/tmp/config.json --type=kubernetes.io/dockerconfigjson\n</code></pre>","tags":["Kubernetes","Nexus"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%85%8D%E7%BD%AE%E7%A7%81%E6%9C%89%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%E5%87%AD%E8%AF%81.html#2-ca","title":"2. CA \u8bc1\u4e66\u6dfb\u52a0","text":"<p>\u5728 Nexus \u865a\u62df\u673a<code>192.168.100.12</code>\u4e0a\uff0c\u83b7\u53d6 CA \u8bc1\u4e66<code>/etc/docker/certs.d/192.168.100.12:8082/ca.crt</code>\uff0c\u5c06\u5176\u590d\u5236\u5230\u6240\u6709 k8s \u8282\u70b9\u7684<code>/etc/pki/ca-trust/source/anchors/nexus.crt</code>\uff0c\u5e76\u5728\u6240\u6709\u8282\u70b9\u66f4\u65b0\u8bc1\u4e66\uff1a</p> <pre><code>update-ca-trust\n</code></pre> <p>\u4e4b\u540e\u8fd8\u9700\u8981\u91cd\u542f containerd\uff1a</p> <pre><code>systemctl restart containerd.service\n</code></pre>","tags":["Kubernetes","Nexus"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%85%8D%E7%BD%AE%E7%A7%81%E6%9C%89%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%E5%87%AD%E8%AF%81.html#3","title":"3. \u4f7f\u7528\u51ed\u8bc1\u62c9\u53d6\u955c\u50cf","text":"<p>\u5728\u547d\u540d\u7a7a\u95f4 <code>keycloak</code> \u521b\u5efa\u4e00\u4e2a pod\uff0c\u4f7f\u7528\u51ed\u8bc1 <code>nexus-regcred</code> \u62c9\u53d6\u955c\u50cf\uff0c\u65b0\u5efa\u6587\u4ef6<code>test-pod.yaml</code>\uff1a</p> test-pod.yaml<pre><code>---\napiVersion: v1\nkind: Pod\nmetadata:\n  name: test-pod\n  namespace: keycloak\nspec:\n  containers:\n    - name: keycloak\n      image: 192.168.100.12:8082/keycloak/keycloak:24.0\n  imagePullSecrets:\n    - name: nexus-regcred\n</code></pre> <p>\u521b\u5efa pod\uff1a</p> <pre><code>kubectl create -f test-pod.yaml\n</code></pre>","tags":["Kubernetes","Nexus"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Kubernetes.html","title":"\u94f6\u6cb3\u9e92\u9e9f V10 \u5b89\u88c5 Kubernetes","text":"","tags":["Kubernetes","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Kubernetes.html#1","title":"1. \u7cfb\u7edf\u67b6\u6784","text":"<p>\u672c\u6b21\u5b89\u88c5\u7684 K8S \u4ec5\u6709 3 \u4e2a master \u8282\u70b9\uff0c\u5176\u4e2d 1 \u8282\u70b9\u548c 3 \u8282\u70b9\u989d\u5916 HAProxy \u548c Keepalived \u505a apiserver \u9ad8\u53ef\u7528\uff0c\u5404\u4e2a\u8282\u70b9\u914d\u7f6e\u548c\u7528\u9014\u5982\u4e0b\uff1a</p> \u8282\u70b9\u540d\u79f0 IP \u5730\u5740 \u670d\u52a1\u5668\u89d2\u8272 \u914d\u7f6e\u8981\u6c42 k8s01 192.168.100.11 K8S master \u8282\u70b9 2C4G\uff0c\u516c\u7f51\u7f51\u5361\u540d\u79f0 ens33 k8s02 192.168.100.12 K8S master \u8282\u70b9 2C4G\uff0c\u516c\u7f51\u7f51\u5361\u540d\u79f0 ens33 k8s03 192.168.100.13 K8S master \u8282\u70b9 2C4G\uff0c\u516c\u7f51\u7f51\u5361\u540d\u79f0 ens33 <p>\u5176\u4e2d\uff0c\u6240\u6709\u7684\u8282\u70b9\u90fd\u9700\u8981\u914d\u7f6e NTP \u65f6\u949f\u540c\u6b65\u670d\u52a1\u5668\uff0c\u4e14\u6240\u6709\u8282\u70b9\u90fd\u9700\u8981\u6709\u9ed8\u8ba4\u7f51\u5173\u3002\u8282\u70b9 k8s01 \u548c k8s03 \u56e0\u6709\u5b89\u88c5 KeepAlived \u7684\u9700\u6c42\uff0c\u9700\u8981\u989d\u5916\u914d\u7f6e\u4e00\u4e2a VIP\uff1a192.168.100.10\uff0c\u540c\u65f6\uff0c\u9700\u8981\u4f7f\u7528 Ansible \u5bf9\u8fd9 3 \u4e2a\u8282\u70b9\u8fdb\u884c\u6279\u91cf\u914d\u7f6e\u3002</p> <p>\u6b64\u6b21\u5b89\u88c5\u4e3a\u6700\u5c0f\u5316\u5b89\u88c5\uff0c\u5b89\u88c5\u7f51\u7edc\u63d2\u4ef6 calico\uff0cingress\u3001helm\u3001ceph-csi \u3001metrics-server \u7b49\u975e\u5fc5\u8981\u529f\u80fd\u4e0d\u5b89\u88c5\u3002\u540c\u65f6\uff0c\u63a8\u8350\u63d0\u524d\u521b\u5efa <code>/var/lib/containerd</code> \u76ee\u5f55\u5e76\u7ed9\u5176\u5355\u72ec\u6302\u5728\u903b\u8f91\u5377\u3002</p>","tags":["Kubernetes","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Kubernetes.html#2","title":"2. \u51c6\u5907\u5de5\u4f5c","text":"","tags":["Kubernetes","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Kubernetes.html#21","title":"2.1 \u5b89\u88c5\u524d\u7cfb\u7edf\u53c2\u6570","text":"<p>\u6240\u6709\u8282\u70b9\u5747\u9700\u8981\u7981\u7528 swap\u3001\u5173\u95ed firewalld \u9632\u706b\u5899\u4e0e SELinux\uff1a</p> <pre><code># Disable swap\nsed -i '/^.*[[:space:]]*swap[[:space:]]*swap[[:space:]]*.*$/d' /etc/fstab\n# Disable firewalld\nsystemctl disable firewalld.service\n# Disable SELinux\nsed -i 's/^SELINUX=.*$/SELINUX=disabled/g' /etc/selinux/config\n# Reboot to apply changes\nreboot\n</code></pre> <p>\u5bf9\u4e8e 1C2G \u7684\u4f4e\u914d\u7f6e\u673a\u5668\uff0c\u5982\u679c\u53d1\u73b0\u5185\u5b58\u4e0d\u8db3\uff0c\u9700\u8981\u4fee\u6539 kdump \u7684\u9ed8\u8ba4 1024M \u5185\u5b58\u4e3a\u66f4\u5c0f\u7684\u6570\u503c\uff1a</p> <pre><code>sed -i 's/crashkernel=1024M,high/crashkernel=128M,high/' /etc/default/grub\ngrub2-mkconfig -o /boot/grub2/grub.cfg\nreboot\n</code></pre>","tags":["Kubernetes","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Kubernetes.html#22","title":"2.2 \u5b89\u88c5\u4f9d\u8d56\u7684\u8f6f\u4ef6","text":"<p>\u6240\u6709 k8s \u8282\u70b9\u90fd\u9700\u8981\u4f7f\u7528 yum \u547d\u4ee4\u5b89\u88c5\u4ee5\u4e0b\u4f9d\u8d56\uff1a</p> <pre><code>yum install conntrack-tools libnetfilter_cthelper ibnetfilter_cttimeout libnetfilter_queue socat\n</code></pre>","tags":["Kubernetes","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Kubernetes.html#23-ansible","title":"2.3 Ansible \u4e3b\u673a\u6e05\u5355\u914d\u7f6e","text":"<p>\u672c\u6587\u4f7f\u7528 Ansible \u6765\u5bf9\u8282\u70b9\u8fdb\u884c\u6279\u91cf\u64cd\u4f5c\uff0cAnsible \u4e3b\u673a\u6e05\u5355\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>[k8s]\n192.168.100.11\n192.168.100.12\n192.168.100.13\n\n[keepalived]\n192.168.100.11 keepalived_status=MASTER\n192.168.100.13 keepalived_status=BACKUP\n\n[keepalived:vars]\nkeepalived_nic=ens33\nkeepalived_pass=unIhenGAcvAEH\nkeepalived_router_id=101\n\n[all:vars]\nkeepalived_vip=192.168.100.10\n</code></pre>","tags":["Kubernetes","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Kubernetes.html#24","title":"2.4 \u4ecb\u8d28\u4e0b\u8f7d","text":"<p>\u5982\u679c\u9700\u8981\u79bb\u7ebf\u5b89\u88c5\uff0c\u9700\u8981\u989d\u5916\u51c6\u5907\u4e00\u53f0\u53ef\u4ee5\u901a\u5916\u7f51\u7684\u673a\u5668\u6765\u4e0b\u8f7d\u4ecb\u8d28\uff0c\u6b64\u673a\u5668\u4e5f\u9700\u8981\u7981\u7528 swap\u3001\u5173\u95ed firewalld \u9632\u706b\u5899\u4e0e SELinux\uff0c\u4e14\u81f3\u5c11\u9700\u8981\u5b89\u88c5 docker\u3001containerd \u4e0e helm\u3002\u5176\u4e2d\u9700\u8981\u4e0b\u8f7d\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u53ca\u914d\u7f6e\u6587\u4ef6\u5982\u4e0b\uff1a</p> \u4ecb\u8d28\u540d\u79f0 \u4e0b\u8f7d\u5730\u5740 containerd-1.7.11-linux-amd64.tar.gz https://github.com/containerd/containerd/releases containerd.service https://raw.githubusercontent.com/containerd/containerd/main/containerd.service runc.amd64 https://github.com/opencontainers/runc/releases cni-plugins-linux-amd64-v1.4.0.tgz https://github.com/containernetworking/plugins/releases crictl-v1.28.0-linux-amd64.tar.gz https://github.com/kubernetes-sigs/cri-tools/releases kubelet https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#k8s-install-2 kubeadm https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#k8s-install-2 kubectl https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#k8s-install-2 10-kubeadm.conf https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#k8s-install-2 tigera-operator.yaml https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart custom-resources.yaml https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart <p>\u9700\u8981\u4e0b\u8f7d\u7684\u5bb9\u5668\u955c\u50cf\u5982\u4e0b\uff1a</p> \u955c\u50cf\u540d\u79f0 \u4e0b\u8f7d\u65b9\u5f0f registry.k8s.io/kube-apiserver:v1.29.0 \u4f7f\u7528 ctr \u6216\u8005 docker \u547d\u4ee4\u4e0b\u8f7d registry.k8s.io/kube-controller-manager:v1.29.0 \u4f7f\u7528 ctr \u6216\u8005 docker \u547d\u4ee4\u4e0b\u8f7d registry.k8s.io/kube-scheduler:v1.29.0 \u4f7f\u7528 ctr \u6216\u8005 docker \u547d\u4ee4\u4e0b\u8f7d registry.k8s.io/kube-proxy:v1.29.0 \u4f7f\u7528 ctr \u6216\u8005 docker \u547d\u4ee4\u4e0b\u8f7d registry.k8s.io/coredns/coredns:v1.11.1 \u4f7f\u7528 ctr \u6216\u8005 docker \u547d\u4ee4\u4e0b\u8f7d registry.k8s.io/pause:3.9 \u4f7f\u7528 ctr \u6216\u8005 docker \u547d\u4ee4\u4e0b\u8f7d registry.k8s.io/etcd:3.5.10-0 \u4f7f\u7528 ctr \u6216\u8005 docker \u547d\u4ee4\u4e0b\u8f7d docker.io/library/haproxy:2.1.4 \u4f7f\u7528 ctr \u6216\u8005 docker \u547d\u4ee4\u4e0b\u8f7d docker.io/osixia/keepalived:2.0.17 \u4f7f\u7528 ctr \u6216\u8005 docker \u547d\u4ee4\u4e0b\u8f7d docker.io/calico/apiserver:v3.27.0 \u4f7f\u7528 ctr \u6216\u8005 docker \u547d\u4ee4\u4e0b\u8f7d docker.io/calico/cni:v3.27.0 \u4f7f\u7528 ctr \u6216\u8005 docker \u547d\u4ee4\u4e0b\u8f7d docker.io/calico/csi:v3.27.0 \u4f7f\u7528 ctr \u6216\u8005 docker \u547d\u4ee4\u4e0b\u8f7d docker.io/calico/kube-controllers:v3.27.0 \u4f7f\u7528 ctr \u6216\u8005 docker \u547d\u4ee4\u4e0b\u8f7d docker.io/calico/node-driver-registrar:v3.27.0 \u4f7f\u7528 ctr \u6216\u8005 docker \u547d\u4ee4\u4e0b\u8f7d docker.io/calico/node:v3.27.0 \u4f7f\u7528 ctr \u6216\u8005 docker \u547d\u4ee4\u4e0b\u8f7d docker.io/calico/pod2daemon-flexvol:v3.27.0 \u4f7f\u7528 ctr \u6216\u8005 docker \u547d\u4ee4\u4e0b\u8f7d quay.io/tigera/operator:v1.32.3 \u4f7f\u7528 ctr \u6216\u8005 docker \u547d\u4ee4\u4e0b\u8f7d docker.io/calico/typha:v3.27.0 \u4f7f\u7528 ctr \u6216\u8005 docker \u547d\u4ee4\u4e0b\u8f7d <p>\u5bb9\u5668\u955c\u50cf\u4f7f\u7528 ctr \u6216\u8005 docker \u547d\u4ee4\u4e0b\u8f7d\uff0cctr \u7684\u4e0b\u8f7d\u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code>ctr -n k8s.io image pull [\u955c\u50cf\u540d\u79f0] --platform linux/amd64\nctr -n k8s.io image export [\u955c\u50cf\u540d\u79f0].tar [\u955c\u50cf\u540d\u79f0] --platform linux/amd64\n</code></pre> <p>docker \u4e0b\u8f7d\u7684\u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code>docker pull [\u955c\u50cf\u540d\u79f0]\ndocker image save -i [\u955c\u50cf\u540d\u79f0].tar\n</code></pre> <p>\u5bfc\u5165\u5bb9\u5668\u955c\u50cf\uff0c\u9700\u8981\u5728 k8s \u8282\u70b9\u7528 ctr \u547d\u4ee4\u5bfc\u5165\uff0c\u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code>ctr -n k8s.io image import [\u955c\u50cf\u540d\u79f0].tar --platform linux/amd64\n</code></pre>","tags":["Kubernetes","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Kubernetes.html#3-containerd","title":"3. \u5b89\u88c5 containerd \u5bb9\u5668\u8fd0\u884c\u73af\u5883","text":"<p>\u6240\u6709\u7684 k8s \u8282\u70b9\u90fd\u9700\u8981\u5b89\u88c5 containerd\uff0c\u4f7f\u7528\u6b64 Ansible Playbook \u8fdb\u884c\u6279\u91cf\u5b89\u88c5\uff1a</p> containerd-install.yaml<pre><code>---\n- name: install containerd\n  hosts: all\n  tasks:\n    - name: extract containerd-1.7.11-linux-amd64.tar.gz\n      unarchive:\n        src: containerd-1.7.11-linux-amd64.tar.gz\n        dest: /usr/local/\n    - name: install containerd.service\n      copy:\n        src: containerd.service\n        dest: /usr/lib/systemd/system/containerd.service\n    - name: generate default containerd config\n      shell:\n        cmd: |\n          mkdir -p /etc/containerd/\n          containerd config default &gt; /etc/containerd/config.toml\n    - name: configure containerd to use systemd cgroup\n      replace:\n        path: /etc/containerd/config.toml\n        regexp: \"SystemdCgroup = false\"\n        replace: \"SystemdCgroup = true\"\n    - name: configure containerd to use pause:3.9\n      replace:\n        path: /etc/containerd/config.toml\n        regexp: \"registry.k8s.io/pause:3.8\"\n        replace: \"registry.k8s.io/pause:3.9\"\n    - name: enable and restart containerd service\n      systemd:\n        name: containerd\n        daemon_reload: yes\n        state: restarted\n        enabled: yes\n</code></pre>","tags":["Kubernetes","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Kubernetes.html#4-kubernetes","title":"4. \u5b89\u88c5 Kubernetes","text":"","tags":["Kubernetes","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Kubernetes.html#41-k8s","title":"4.1 \u914d\u7f6e\u5185\u6838\u53c2\u6570\u5e76\u5b89\u88c5 k8s \u4e8c\u8fdb\u5236\u6587\u4ef6","text":"<p>\u4f7f\u7528\u4ee5\u4e0b playbook \u914d\u7f6e\u5185\u6838\u53c2\u6570\u3001\u5b89\u88c5\u4e8c\u8fdb\u5236\u6587\u4ef6\u5e76\u5bfc\u5165\u5bb9\u5668\u955c\u50cf\uff1a</p> k8s-install.yaml<pre><code>---\n- name: install kubernetes\n  hosts: k8s\n  tasks:\n    - name: edit /etc/modules-load.d/k8s.conf\n      copy:\n        content: |\n          overlay\n          br_netfilter\n        dest: /etc/modules-load.d/k8s.conf\n      register: k8s_mod\n    - name: edit /etc/sysctl.d/k8s.conf\n      copy:\n        content: |\n          net.bridge.bridge-nf-call-iptables  = 1\n          net.bridge.bridge-nf-call-ip6tables = 1\n          net.ipv4.ip_forward                 = 1\n        dest: /etc/sysctl.d/k8s.conf\n      register: k8s_sysctl\n    - name: edit /etc/sysctl.conf\n      copy:\n        content: \"\"\n        dest: /etc/sysctl.conf\n      register: sysctl\n    - name: reboot\n      reboot:\n        reboot_timeout: 600\n      when: k8s_mod.changed == true or k8s_sysctl.changed == true or sysctl.changed == true\n    - name: install runc\n      copy:\n        src: runc.amd64\n        dest: /usr/local/sbin/runc\n        mode: 0755\n    - name: create directory /opt/cni/bin\n      file:\n        path: /opt/cni/bin\n        state: directory\n    - name: install cni-plugins\n      unarchive:\n        src: cni-plugins-linux-amd64-v1.4.0.tgz\n        dest: /opt/cni/bin\n    - name: install crictl\n      unarchive:\n        src: crictl-v1.28.0-linux-amd64.tar.gz\n        dest: /usr/local/bin\n    - name: install kubelet, kubeadm and kubectl\n      copy:\n        src: \"{{ item }}\"\n        dest: /usr/local/bin/\n        mode: 0755\n      with_items:\n        - kubeadm\n        - kubelet\n        - kubectl\n    - name: set up bash-completion\n      lineinfile:\n        line: \"source &lt;(kubectl completion bash)\"\n        path: /root/.bashrc\n    - name: install kubelet service\n      copy:\n        src: kubelet.service\n        dest: /etc/systemd/system/kubelet.service\n    - name: create directory /etc/systemd/system/kubelet.service.d\n      file:\n        path: /etc/systemd/system/kubelet.service.d\n        state: directory\n    - name: install 10-kubeadm.conf\n      copy:\n        src: 10-kubeadm.conf\n        dest: /etc/systemd/system/kubelet.service.d/10-kubeadm.conf\n    - name: enable and restart kubelet service\n      systemd:\n        name: kubelet\n        daemon_reload: yes\n        state: restarted\n        enabled: yes\n</code></pre>","tags":["Kubernetes","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Kubernetes.html#42-etchosts","title":"4.2 \u914d\u7f6e\u6240\u6709\u8282\u70b9/etc/hosts","text":"","tags":["Kubernetes","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Kubernetes.html#421-jinja2","title":"4.2.1 \u521b\u5efa jinja2 \u6a21\u677f\u6587\u4ef6","text":"<p>\u521b\u5efa\u4e00\u4e2a jinja2 \u6a21\u677f\u6587\u4ef6\u7528\u4e8e\u914d\u7f6e hosts\uff0c\u5c06\u5176\u653e\u5728 templates \u76ee\u5f55\u4e0b\uff1a</p> hosts.j2<pre><code>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1         localhost localhost.localdomain localhost6 localhost6.localdomain6\n\n{{ keepalived_vip }} cluster-endpoint\n{% for host in groups['k8s'] %}\n{{ host }} {{ hostvars[host].ansible_nodename }}\n{% endfor %}\n</code></pre>","tags":["Kubernetes","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Kubernetes.html#422-ansible-playbook-etchosts","title":"4.2.2 \u4f7f\u7528 Ansible Playbook \u914d\u7f6e/etc/hosts","text":"<p>\u4f7f\u7528\u4ee5\u4e0b Ansible Playbook \u6279\u91cf\u914d\u7f6e/etc/hosts\uff1a</p> <pre><code>---\n- name: config /etc/hosts for all hosts\n  hosts: all\n  tasks:\n    - name: create /etc/hosts\n      template:\n        src: templates/hosts.j2\n        dest: /etc/hosts\n</code></pre>","tags":["Kubernetes","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Kubernetes.html#43-static-pod-keepalived-haproxy","title":"4.3 \u4f7f\u7528 static pod \u65b9\u5f0f\u5b89\u88c5 Keepalived \u548c HAProxy","text":"<p>Warning</p> <p>\u5728\u751f\u4ea7\u73af\u5883\uff0c\u5982\u679c\u8d1f\u8f7d\u5747\u8861\u5668\u53ef\u7528\uff0c\u63a8\u8350\u4f7f\u7528\u8d1f\u8f7d\u5747\u8861\u5668\u6765\u5b9e\u73b0 apiserver \u9ad8\u53ef\u7528\u3002\u5982\u679c\u6ca1\u6709\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u63a8\u8350\u5355\u72ec\u53d1\u653e 2 \u53f0\u865a\u62df\u673a\u505a HAProxy \u548c Keepalived \u8fdb\u884c\u8f6f\u8d1f\u8f7d\u9ad8\u53ef\u7528\u3002\u5982\u679c\u5b9e\u5728\u65e0\u6cd5\u6ee1\u8db3\u6761\u4ef6\uff0c\u5728 2 \u4e2a k8s \u8282\u70b9\u4ee5 static pod \u65b9\u5f0f\u5b89\u88c5 HAProxy \u548c Keepalived\u3002</p>","tags":["Kubernetes","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Kubernetes.html#431-jinja2","title":"4.3.1 \u521b\u5efa jinja2 \u6a21\u677f\u6587\u4ef6","text":"<p>\u4e00\u5171\u9700\u8981\u521b\u5efa 4 \u4e2a jinja2 \u6a21\u677f\u6587\u4ef6\uff0c\u5c06\u5176\u653e\u5728 templates \u76ee\u5f55\u4e0b\uff1a</p> check_apiserver.sh.j2<pre><code>#!/bin/sh\n\nerrorExit() {\n    echo \"*** $*\" 1&gt;&amp;2\n    exit 1\n}\n\ncurl --silent --max-time 2 --insecure https://localhost:8443/ -o /dev/null || errorExit \"Error GET https://localhost:8443/\"\nif ip addr | grep -q {{ keepalived_vip }}; then\n    curl --silent --max-time 2 --insecure https://{{ keepalived_vip }}:8443/ -o /dev/null || errorExit \"Error GET https://{{ keepalived_vip }}:8443/\"\nfi\n</code></pre> haproxy.cfg.j2<pre><code># /etc/haproxy/haproxy.cfg\n#---------------------------------------------------------------------\n# Global settings\n#---------------------------------------------------------------------\nglobal\n    log /dev/log local0\n    log /dev/log local1 notice\n    daemon\n\n#---------------------------------------------------------------------\n# common defaults that all the 'listen' and 'backend' sections will\n# use if not designated in their block\n#---------------------------------------------------------------------\ndefaults\n    mode                    http\n    log                     global\n    option                  httplog\n    option                  dontlognull\n    option http-server-close\n    option forwardfor       except 127.0.0.0/8\n    option                  redispatch\n    retries                 1\n    timeout http-request    10s\n    timeout queue           20s\n    timeout connect         5s\n    timeout client          20s\n    timeout server          20s\n    timeout http-keep-alive 10s\n    timeout check           10s\n\n#---------------------------------------------------------------------\n# apiserver frontend which proxys to the control plane nodes\n#---------------------------------------------------------------------\nfrontend apiserver\n    bind *:8443\n    mode tcp\n    option tcplog\n    default_backend apiserverbackend\n\n#---------------------------------------------------------------------\n# round robin balancing for apiserver\n#---------------------------------------------------------------------\nbackend apiserverbackend\n    option httpchk GET /healthz\n    http-check expect status 200\n    mode tcp\n    option ssl-hello-chk\n    balance     roundrobin\n    {% for host in groups['k8s'] %}\n        server {{ hostvars[host].ansible_nodename }} {{ host }}:6443 check\n    {% endfor %}\n</code></pre> haproxy.yaml.j2<pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: haproxy\n  namespace: kube-system\nspec:\n  containers:\n  - image: docker.io/library/haproxy:2.1.4\n    name: haproxy\n    livenessProbe:\n      failureThreshold: 8\n      httpGet:\n        host: localhost\n        path: /healthz\n        port: 8443\n        scheme: HTTPS\n    volumeMounts:\n    - mountPath: /usr/local/etc/haproxy/haproxy.cfg\n      name: haproxyconf\n      readOnly: true\n  hostNetwork: true\n  volumes:\n  - hostPath:\n      path: /etc/haproxy/haproxy.cfg\n      type: FileOrCreate\n    name: haproxyconf\nstatus: {}\n</code></pre> keepalived.conf.j2<pre><code>! /etc/keepalived/keepalived.conf\n! Configuration File for keepalived\nglobal_defs {\n    router_id LVS_DEVEL\n}\nvrrp_script check_apiserver {\n  script \"/etc/keepalived/check_apiserver.sh\"\n  interval 3\n  weight -2\n  fall 10\n  rise 2\n}\n\nvrrp_instance VI_1 {\n    state {{ keepalived_status }}\n    interface {{ keepalived_nic }}\n    virtual_router_id {{ keepalived_router_id }}\n    priority 50\n    authentication {\n        auth_type PASS\n        auth_pass {{ keepalived_pass }}\n    }\n    virtual_ipaddress {\n        {{ keepalived_vip }}\n    }\n    track_script {\n        check_apiserver\n    }\n}\n</code></pre> keepalived.yaml.j2<pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  creationTimestamp: null\n  name: keepalived\n  namespace: kube-system\nspec:\n  containers:\n  - image: docker.io/osixia/keepalived:2.0.17\n    name: keepalived\n    resources: {}\n    securityContext:\n      capabilities:\n        add:\n        - NET_ADMIN\n        - NET_BROADCAST\n        - NET_RAW\n    volumeMounts:\n    - mountPath: /usr/local/etc/keepalived/keepalived.conf\n      name: config\n    - mountPath: /etc/keepalived/check_apiserver.sh\n      name: check\n  hostNetwork: true\n  volumes:\n  - hostPath:\n      path: /etc/keepalived/keepalived.conf\n    name: config\n  - hostPath:\n      path: /etc/keepalived/check_apiserver.sh\n    name: check\nstatus: {}\n</code></pre>","tags":["Kubernetes","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Kubernetes.html#432-ansible-playbook-haproxy-keepalived-static-pod","title":"4.3.2 \u4f7f\u7528 Ansible Playbook \u5b89\u88c5 HAProxy \u548c Keepalived \u7684 static pod","text":"<p>\u4f7f\u7528\u4ee5\u4e0b Playbook \u5b89\u88c5 HAProxy \u548c Keepalived \u7684 static pod\uff1a</p> k8s-install-haproxy-keepalived.yaml<pre><code>---\n- name: install keepalived and haproxy as static pod\n  hosts: all\n  tasks:\n    - name: create directory /etc/haproxy, /etc/keepalived and /etc/kubernetes/manifests\n      file:\n        path: \"{{ item }}\"\n        state: directory\n        recurse: yes\n      with_items:\n        - /etc/haproxy\n        - /etc/keepalived\n        - /etc/kubernetes/manifests\n      when: \"'keepalived' in group_names\"\n    - name: create /etc/haproxy/haproxy.cfg\n      template:\n        src: templates/haproxy.cfg.j2\n        dest: /etc/haproxy/haproxy.cfg\n      when: \"'keepalived' in group_names\"\n    - name: create /etc/keepalived/check_apiserver.sh\n      template:\n        src: templates/check_apiserver.sh.j2\n        dest: /etc/keepalived/check_apiserver.sh\n      when: \"'keepalived' in group_names\"\n    - name: create /etc/keepalived/keepalived.conf\n      template:\n        src: templates/keepalived.conf.j2\n        dest: /etc/keepalived/keepalived.conf\n      when: \"'keepalived' in group_names\"\n    - name: create /etc/kubernetes/manifests/haproxy.yaml\n      template:\n        src: templates/haproxy.yaml.j2\n        dest: /etc/kubernetes/manifests/haproxy.yaml\n      when: \"'keepalived' in group_names\"\n    - name: create /etc/kubernetes/manifests/keepalived.yaml\n      template:\n        src: templates/keepalived.yaml.j2\n        dest: /etc/kubernetes/manifests/keepalived.yaml\n      when: \"'keepalived' in group_names\"\n</code></pre>","tags":["Kubernetes","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Kubernetes.html#44-kubeadm-kubernetes","title":"4.4 \u4f7f\u7528 kubeadm \u521b\u5efa Kubernetes \u96c6\u7fa4","text":"<p>\u5728 k8s01 \u8282\u70b9\u521b\u5efa\u96c6\u7fa4\uff1a</p> <pre><code>kubeadm init --control-plane-endpoint cluster-endpoint:8443 --pod-network-cidr=172.18.0.0/16 --upload-certs\n</code></pre> <p>\u521b\u5efa\u6210\u529f\u540e\u4f1a\u6709\u4ee5\u4e0b\u63d0\u793a\uff1a</p> <pre><code>You can now join any number of the control-plane node running the following command on each as root:\n\n  kubeadm join cluster-endpoint:8443 --token dqgsa7.3g5uhcbbtbgogrfm \\\n    --discovery-token-ca-cert-hash sha256:7b66a8861d2c2986f1d5caf043b8e5358477b52d4760055dda2781ddad44cc92 \\\n    --control-plane --certificate-key 526b695cca88e6c8bbb1e19f805f46f080087bcb748a5547009d99c6ac1e4d27\n</code></pre> <p>\u5728 k8s02 \u548c k8s03 \u6267\u884c\uff1a</p> <pre><code>kubeadm join cluster-endpoint:8443 --token dqgsa7.3g5uhcbbtbgogrfm \\\n    --discovery-token-ca-cert-hash sha256:7b66a8861d2c2986f1d5caf043b8e5358477b52d4760055dda2781ddad44cc92 \\\n    --control-plane --certificate-key 526b695cca88e6c8bbb1e19f805f46f080087bcb748a5547009d99c6ac1e4d27\n</code></pre> <p>\u5c06\u4e24\u4e2a\u8282\u70b9\u52a0\u5165\u96c6\u7fa4\uff0c\u4e4b\u540e\u6240\u6709 k8s \u8282\u70b9\u90fd\u4fee\u6539 bashrc\uff1a</p> <pre><code>echo 'export KUBECONFIG=/etc/kubernetes/admin.conf' &gt;&gt; /root/.bashrc\nsource /root/.bashrc\n</code></pre> <p>\u68c0\u67e5\u96c6\u7fa4\u72b6\u6001\uff1a</p> <pre><code># kubectl get nodes\nNAME    STATUS     ROLES           AGE     VERSION\nk8s01   NotReady   control-plane   4m32s   v1.29.0\nk8s02   NotReady   control-plane   2m6s    v1.29.0\nk8s03   NotReady   control-plane   110s    v1.29.0\n</code></pre> <p>\u6b64\u65f6 NotReady \u662f\u56e0\u4e3a\u6ca1\u6709\u5b89\u88c5 calico\uff0c\u4e3a\u6b63\u5e38\u73b0\u8c61\u3002</p>","tags":["Kubernetes","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Kubernetes.html#45-master","title":"4.5 \u8bbe\u7f6e\u5141\u8bb8 master \u8282\u70b9\u8c03\u5ea6\u5bb9\u5668","text":"<p>\u96c6\u7fa4\u521b\u5efa\u4ee5\u540e\uff0c\u56e0\u4e3a\u6211\u4eec\u53ea\u6709 master \u8282\u70b9\uff0c\u9700\u8981\u5141\u8bb8\u5bb9\u5668\u5728 master \u8282\u70b9\u8c03\u5ea6\uff1a</p> <pre><code>kubectl taint nodes --all node-role.kubernetes.io/control-plane-\n</code></pre>","tags":["Kubernetes","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Kubernetes.html#5-calico","title":"5. \u5b89\u88c5 Calico \u7f51\u7edc\u63d2\u4ef6","text":"","tags":["Kubernetes","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Kubernetes.html#51-networkmanager","title":"5.1 \u914d\u7f6e NetworkManager","text":"<p>\u6240\u6709\u8282\u70b9\u90fd\u9700\u8981\u914d\u7f6e NetworkManager \u5ffd\u7565 calico \u7f51\u5361\uff0c\u53ef\u4f7f\u7528\u4ee5\u4e0b playbook \u6279\u91cf\u914d\u7f6e\uff1a</p> calico-configure-nm.yaml<pre><code>---\n- name: configure networkmanager for calico\n  hosts: k8s\n  tasks:\n    - name: create /etc/NetworkManager/conf.d/calico.conf\n      copy:\n        content: |\n          [keyfile]\n          unmanaged-devices=interface-name:cali*;interface-name:tunl*;interface-name:vxlan.calico;interface-name:vxlan-v6.calico;interface-name:wireguard.cali;interface-name:wg-v6.cali\n        dest: /etc/NetworkManager/conf.d/calico.conf\n    - name: restart networkmanager\n      systemd:\n        name: NetworkManager\n        state: restarted\n</code></pre>","tags":["Kubernetes","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Kubernetes.html#52-tigera-operator-calico","title":"5.2 \u521b\u5efa tigera-operator \u5e76\u5b89\u88c5 calico","text":"<p>\u521b\u5efa <code>custom-resources.yaml</code>\uff1a</p> custom-resources.yaml<pre><code># This section includes base Calico installation configuration.\n# For more information, see: https://docs.tigera.io/calico/latest/reference/installation/api#operator.tigera.io/v1.Installation\napiVersion: operator.tigera.io/v1\nkind: Installation\nmetadata:\n  name: default\nspec:\n  # Configures Calico networking.\n  calicoNetwork:\n    # Note: The ipPools section cannot be modified post-install.\n    ipPools:\n      - blockSize: 24\n        cidr: 172.18.0.0/16\n        encapsulation: VXLAN\n        natOutgoing: Enabled\n        nodeSelector: all()\n---\n# This section configures the Calico API server.\n# For more information, see: https://docs.tigera.io/calico/latest/reference/installation/api#operator.tigera.io/v1.APIServer\n#apiVersion: operator.tigera.io/v1\n#kind: APIServer\n#metadata:\n#  name: default\n#spec: {}\n</code></pre> <p>\u5728\u4efb\u610f\u4e00\u4e2a k8s \u8282\u70b9\u4e0a\u8fd0\u884c\uff1a</p> <pre><code>kubectl create -f tigera-operator.yaml\nkubectl create -f custom-resources.yaml\n</code></pre> <p>\u68c0\u67e5 pod \u72b6\u6001\uff1a</p> <pre><code># kubectl -n tigera-operator get pods\nNAME                               READY   STATUS    RESTARTS      AGE\ntigera-operator-55585899bf-6mwrh   1/1     Running   2 (50s ago)   11m\n# kubectl -n calico-system get pods\nNAME                           READY   STATUS    RESTARTS       AGE\ncalico-typha-f8fd87f9d-8sb7w   1/1     Running   1 (2m8s ago)   10m\ncalico-typha-f8fd87f9d-thkt6   1/1     Running   1 (92s ago)    10m\n</code></pre> <p>\u5728\u5b8c\u5168\u5c31\u7eea\u4ee5\u540e\uff0c\u5728 k8s \u4e0a\u67e5\u770b\u8def\u7531\u8868\uff0c\u53ef\u4ee5\u770b\u5230 calico \u4e3a\u6bcf\u4e2a k8s \u8282\u70b9\u90fd\u5206\u914d\u4e86\u4e00\u4e2a\u7f51\u6bb5\uff0c\u7f51\u6bb5\u5199\u5165\u4e86\u8def\u7531\u8868\uff1a</p> <pre><code># ip route\ndefault via 192.168.100.1 dev ens33 proto static metric 100\n172.18.97.0/24 via 172.18.97.0 dev vxlan.calico onlink\n172.18.122.0/24 via 172.18.122.0 dev vxlan.calico onlink\nblackhole 172.18.209.0/24 proto 80\n172.18.209.7 dev cali7ba71aa9a5b scope link\n172.18.209.8 dev cali4f83fc794cd scope link\n192.168.100.0/24 dev ens33 proto kernel scope link src 192.168.100.11 metric 100\n</code></pre> <p>\u5b8c\u5168\u5c31\u7eea\u4ee5\u540e\uff0c\u68c0\u67e5\u4e24\u4e2a coredns \u662f\u4e0d\u662f\u624e\u5806\u90e8\u7f72\u5728\u4e00\u4e2a\u8282\u70b9\u4e0a\uff1a</p> <pre><code># kubectl -n kube-system get pods -o wide | grep coredns\nkube-system        coredns-76f75df574-4nskd            1/1     Running   1 (4m17s ago)   47m     172.18.97.7      k8s03    &lt;none&gt;           &lt;none&gt;\nkube-system        coredns-76f75df574-t9stk            1/1     Running   1 (4m17s ago)   47m     172.18.97.6      k8s03    &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u5982\u679c\u6709\u8fd9\u79cd\u60c5\u51b5\uff0c\u9700\u8981\u8f6e\u8be2\u91cd\u542f coredns \u6765\u4f7f\u5f97 coredns \u4e0d\u624e\u5806\u5728\u4e00\u4e2a\u8282\u70b9\uff1a</p> <pre><code>kubectl -n kube-system rollout restart deployment coredns\n</code></pre>","tags":["Kubernetes","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Kubernetes.html#6","title":"6. \u53c2\u8003\u94fe\u63a5","text":"<p>https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/</p> <p>https://kubernetes.io/docs/setup/production-environment/container-runtimes/</p> <p>https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/</p> <p>https://github.com/kubernetes/kubeadm/blob/main/docs/ha-considerations.md#options-for-software-load-balancing</p> <p>https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart</p> <p>https://www.pivert.org/ceph-csi-on-kubernetes-1-24/</p>","tags":["Kubernetes","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/Gentoo%E5%90%AF%E5%8A%A8%E6%97%B6%E6%8C%82%E8%BD%BDcifs%E5%A4%B1%E8%B4%A5%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95.html","title":"Gentoo \u542f\u52a8\u65f6\u6302\u8f7d cifs \u5931\u8d25\u89e3\u51b3\u65b9\u6cd5","text":"","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/Gentoo%E5%90%AF%E5%8A%A8%E6%97%B6%E6%8C%82%E8%BD%BDcifs%E5%A4%B1%E8%B4%A5%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95.html#1","title":"1. \u95ee\u9898\u63cf\u8ff0","text":"<p>\u4eca\u65e5\u89c2\u5bdf\u5230 Gentoo \u91cd\u542f\u540e cifs \u6302\u8f7d\u9879\u4e22\u5931\uff0c\u5176\u4e2d <code>/etc/fstab</code> \u662f\u8fd9\u6837\u5199\u7684\uff1a</p> <pre><code>//192.168.11.254/downloads/others /mnt/winshare cifs credentials=/etc/cifs-credentials,uid=3000,gid=3000,_netdev 0 0\n</code></pre> <p>\u542f\u52a8\u62a5\u9519\u91cc <code>dmesg</code> \u5927\u81f4\u4e3a\u7f51\u7edc\u4e0d\u53ef\u8fbe\u7c7b\u578b\u7684\u62a5\u9519\u3002</p>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/Gentoo%E5%90%AF%E5%8A%A8%E6%97%B6%E6%8C%82%E8%BD%BDcifs%E5%A4%B1%E8%B4%A5%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95.html#2","title":"2. \u6392\u67e5\u65b9\u5411","text":"","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/Gentoo%E5%90%AF%E5%8A%A8%E6%97%B6%E6%8C%82%E8%BD%BDcifs%E5%A4%B1%E8%B4%A5%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95.html#21","title":"2.1 \u68c0\u67e5\u7f51\u5361\u540d\u5b57\u662f\u5426\u5339\u914d","text":"<ul> <li>\u68c0\u67e5 <code>/etc/init.d/net.*</code> \u7f51\u5361\u914d\u7f6e\u6587\u4ef6\u7684\u7f51\u5361\u540d\u79f0\u662f\u5426\u662f\u5f53\u524d\u7f51\u5361\u540d\u79f0\u3002</li> <li>\u68c0\u67e5 <code>/etc/conf.d/net</code> \u4e2d\u914d\u7f6e\u7684\u7f51\u5361\u540d\u79f0\u3002</li> </ul>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/Gentoo%E5%90%AF%E5%8A%A8%E6%97%B6%E6%8C%82%E8%BD%BDcifs%E5%A4%B1%E8%B4%A5%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95.html#22-dhcpcd","title":"2.2 \u68c0\u67e5 dhcpcd \u548c\u7f51\u5361\u670d\u52a1\u542f\u52a8\u72b6\u6001","text":"<p>\u5728\u670d\u52a1 <code>net.eth0</code> \u5f00\u542f\u7684\u60c5\u51b5\u4e0b\uff0c\u670d\u52a1 <code>dhcpcd</code> \u5e94\u8be5\u4e0d\u8bbe\u7f6e\u5f00\u673a\u542f\u52a8\uff0c\u800c\u7531 <code>net.eth0</code> \u62c9\u8d77\u3002</p>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/Gentoo%E5%90%AF%E5%8A%A8%E6%97%B6%E6%8C%82%E8%BD%BDcifs%E5%A4%B1%E8%B4%A5%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95.html#23","title":"2.3 \u914d\u7f6e\u6302\u8f7d\u524d\u7f51\u7edc\u4f9d\u8d56","text":"<p>\u914d\u7f6e\u6587\u4ef6 <code>/etc/conf.d/netmount</code> \uff1a</p> <pre><code>rc_need=\"net.eth0\"\nrc_need=\"dhcpcd\"\n</code></pre> <p>\u914d\u7f6e\u6587\u4ef6 <code>/etc/conf.d/net-online</code> \uff1a</p> <pre><code>interfaces=\"eth0\"\ninclude_ping_test=yes\nping_test_host=192.168.11.1\ntimeout=120\n</code></pre> <p>\u540c\u65f6\u5c06\u8fd9\u4e24\u4e2a\u670d\u52a1\u5f00\u673a\u81ea\u542f\u52a8\u3002</p>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/Hyper-V%E7%8E%AF%E5%A2%83%E4%B8%8Bsddm%E6%97%A0%E6%B3%95%E5%90%AF%E5%8A%A8%E5%9B%BE%E5%BD%A2%E7%95%8C%E9%9D%A2%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3.html","title":"Hyper-V \u73af\u5883\u4e0b sddm \u65e0\u6cd5\u542f\u52a8\u56fe\u5f62\u754c\u9762\u95ee\u9898\u89e3\u51b3","text":"","tags":["Gentoo","Linux","xfce","sddm","Hyper-V"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/Hyper-V%E7%8E%AF%E5%A2%83%E4%B8%8Bsddm%E6%97%A0%E6%B3%95%E5%90%AF%E5%8A%A8%E5%9B%BE%E5%BD%A2%E7%95%8C%E9%9D%A2%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3.html#1","title":"1. \u95ee\u9898\u63cf\u8ff0","text":"<p>\u5728 Hyper-V \u73af\u5883\u4e0b\uff0c\u5b89\u88c5 KDE \u540e\uff0csddm \u65e0\u6cd5\u542f\u52a8\u56fe\u5f62\u754c\u9762\uff0c\u5373\u4ee5\u4e0b\u547d\u4ee4\u65e0\u6548\uff1a</p> <pre><code>rc-service display-manager start\n</code></pre> <p>\u5176\u4e2d <code>/etc/conf.d/display-manager</code> \u4e2d\u6b63\u786e\u914d\u7f6e\u4e86 <code>DISPLAYMANAGER=\"sddm\"</code> \uff0c\u4e14\u4f7f\u7528\u914d\u7f6e <code>~/.xinitrc</code> \u540e\u7528 <code>startx</code> \u547d\u4ee4\u542f\u52a8 KDE \uff0c\u6216\u8005\u4f7f\u7528 VNC \u90fd\u6b63\u5e38\u3002</p>","tags":["Gentoo","Linux","xfce","sddm","Hyper-V"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/Hyper-V%E7%8E%AF%E5%A2%83%E4%B8%8Bsddm%E6%97%A0%E6%B3%95%E5%90%AF%E5%8A%A8%E5%9B%BE%E5%BD%A2%E7%95%8C%E9%9D%A2%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3.html#2","title":"2. \u6392\u67e5\u8fc7\u7a0b","text":"<p>\u5c06\u865a\u62df\u673a\u8fc1\u79fb\u5230 VMware \uff0c\u4e00\u5207\u6b63\u5e38\u3002\u8bf4\u660e sddm \u5b89\u88c5\u548c\u914d\u7f6e\u6ca1\u6709\u95ee\u9898\u3002 VMware \u548c Hyper-V \u7684\u533a\u522b\u4e3a VMware \u865a\u62df\u673a\u91cc <code>lspci</code> \u6709\u8f93\u51fa\uff0c Hyper-V \u865a\u62df\u673a\u91cc\u6ca1\u6709\uff0c\u56e0\u4e3a Hyper-V \u8d70\u7684\u662f VMBus \u800c\u4e0d\u662f PCI-E \u3002</p> <p>\u540c\u65f6\uff0c\u5728 Hyper-V \u91cc\u542f\u52a8 manjaro \u5b89\u88c5\u955c\u50cf\uff0c\u56fe\u5f62\u754c\u9762\u53ef\u4ee5\u542f\u52a8\u3002\u56e0\u6b64\u4e0d\u662f Hyper-V \u865a\u62df\u673a\u914d\u7f6e\u95ee\u9898\u3002\u4e8e\u662f\u5f00\u59cb\u6392\u67e5\u5185\u6838\u6a21\u5757\u95ee\u9898\uff0c\u5728 manjaro \u4e0a <code>lsmod | grep hyper</code> \u548c gentoo \u8fdb\u884c\u5bf9\u6bd4\uff0c\u6700\u7ec8\u5c06 gentoo \u5185\u6838\u91cd\u65b0\u7f16\u8bd1\uff1a</p> <pre><code>genkernel all --install --bootloader=grub2 --hyperv --mountboot --menuconfig\n</code></pre> <p>\u5176\u4e2d menuconfig \u91cc\uff0c\u7981\u7528\u8fd9\u91cc\u7684 <code>hyperv_fb</code> \uff1a</p> <pre><code>hyperv_fb\n\u2502 Symbol: FB_HYPERV [=m] \u2502\n\u2502 Type : tristate \u2502\n\u2502 Defined at drivers/video/fbdev/Kconfig:1781 \u2502\n\u2502 Prompt: Microsoft Hyper-V Synthetic Video support \u2502\n\u2502 Depends on: HAS_IOMEM [=y] &amp;&amp; FB [=y] &amp;&amp; HYPERV [=m] \u2502\n\u2502 Location: \u2502\n\u2502 -&gt; Device Drivers \u2502\n\u2502 -&gt; Graphics support \u2502\n\u2502 -&gt; Frame buffer Devices \u2502\n\u2502 (2) -&gt; Microsoft Hyper-V Synthetic Video support (FB_HYPERV [=m])\n</code></pre> <p>\u5f00\u542f\u8fd9\u91cc\u7684 <code>hyperv_drm</code> \uff1a</p> <pre><code>hyperv_drm\n\u2502 Symbol: DRM_HYPERV [=n] \u2502\n\u2502 Type : tristate \u2502\n\u2502 Defined at drivers/gpu/drm/Kconfig:390 \u2502\n\u2502 Prompt: DRM Support for Hyper-V synthetic video device \u2502\n\u2502 Depends on: HAS_IOMEM [=y] &amp;&amp; DRM [=m] &amp;&amp; PCI [=y] &amp;&amp; MMU [=y] &amp;&amp; HYPERV [=m] \u2502\n\u2502 Location: \u2502\n\u2502 -&gt; Device Drivers \u2502\n\u2502 -&gt; Graphics support \u2502\n\u2502 (1) -&gt; DRM Support for Hyper-V synthetic video device (DRM_HYPERV [=n]) \u2502\n\u2502 Selects: DRM_KMS_HELPER [=m] &amp;&amp; DRM_GEM_SHMEM_HELPER [=m]\n</code></pre> <p>\u95ee\u9898\u6ca1\u6709\u5f97\u5230\u89e3\u51b3\u3002\u540e\u6765\u5f97\u77e5\u8fd9\u4e2a\u662f sddm \u5df2\u77e5\u95ee\u9898\uff0c\u66f4\u6362 DM \u4e3a lightdm \u540e\uff0c\u4fee\u6539 lightdm \u914d\u7f6e\u6587\u4ef6 <code>/etc/lightdm/lightdm.conf</code> \u7684\u8fd9\u4e00\u884c\uff1a</p> <pre><code>[LightDM]\nlogind-check-graphical=false\n</code></pre> <p>\u540c\u65f6\uff0c\u9700\u8981\u79fb\u9664\u6587\u4ef6 <code>/usr/share/xsessions/Xsession.desktop</code> \u6765\u9632\u6b62\u53f3\u4e0a\u89d2\u663e\u793a\u4e0d\u80fd\u7528\u7684 Xsession \u8fd9\u4e2a DE \uff0c\u4fee\u6539 <code>/etc/conf.d/display-manager</code> \u91cc <code>DISPLAYMANAGER=\"lightdm\"</code> \uff0c\u4e4b\u540e\u95ee\u9898\u5f97\u5230\u89e3\u51b3\u3002</p>","tags":["Gentoo","Linux","xfce","sddm","Hyper-V"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/emerge%E8%A3%85%E5%8C%85ninja%E6%8A%A5%E9%94%99%E2%80%9Cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%E2%80%9D%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95.html","title":"emerge \u88c5\u5305 ninja \u62a5\u9519\u201cmanifest 'build.ninja' still dirty after 100 tries\u201d\u89e3\u51b3\u65b9\u6cd5","text":"<p>\u5728\u65b0\u7cfb\u7edf\u4fee\u6539\u7f16\u8bd1 flag \u540e\uff0c\u91cd\u65b0\u7f16\u8bd1\u7cfb\u7edf\u91cc\u6240\u6709\u5305\u65f6\uff0c\u8fd0\u884c\u4e86\u5982\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>emerge -Deuav world\n</code></pre> <p>\u62a5\u9519\u5982\u4e0b\uff1a</p> <pre><code>* Messages for package net-libs/nghttp2-1.61.0:\n\n * ERROR: net-libs/nghttp2-1.61.0::gentoo failed (compile phase):\n *   ninja -v -j16 -l16 failed\n *\n * Call stack:\n *     ebuild.sh, line  136:  Called src_compile\n *   environment, line 2565:  Called cmake-multilib_src_compile\n *   environment, line  776:  Called multilib-minimal_src_compile\n *   environment, line 1904:  Called multilib_foreach_abi 'multilib-minimal_abi_src_compile'\n *   environment, line 2171:  Called multibuild_foreach_variant '_multilib_multibuild_wrapper' 'multilib-minimal_abi_src_compile'\n *   environment, line 1864:  Called _multibuild_run '_multilib_multibuild_wrapper' 'multilib-minimal_abi_src_compile'\n *   environment, line 1862:  Called _multilib_multibuild_wrapper 'multilib-minimal_abi_src_compile'\n *   environment, line  531:  Called multilib-minimal_abi_src_compile\n *   environment, line 1898:  Called multilib_src_compile\n *   environment, line 2391:  Called cmake_src_compile\n *   environment, line  894:  Called cmake_build\n *   environment, line  861:  Called eninja\n *   environment, line 1332:  Called die\n * The specific snippet of code:\n *       \"$@\" || die -n \"${*} failed\"\n *\n * If you need support, post the output of `emerge --info '=net-libs/nghttp2-1.61.0::gentoo'`,\n * the complete build log and the output of `emerge -pqv '=net-libs/nghttp2-1.61.0::gentoo'`.\n * The complete build log is located at '/var/tmp/portage/net-libs/nghttp2-1.61.0/temp/build.log'.\n * The ebuild environment file is located at '/var/tmp/portage/net-libs/nghttp2-1.61.0/temp/environment'.\n * Working directory: '/var/tmp/portage/net-libs/nghttp2-1.61.0/work/nghttp2-1.61.0_build-abi_x86_64.amd64'\n * S: '/var/tmp/portage/net-libs/nghttp2-1.61.0/work/nghttp2-1.61.0'\n</code></pre> <p>\u5176\u4e2d\u65e5\u5fd7\u6587\u4ef6 <code>/var/tmp/portage/net-libs/nghttp2-1.61.0/temp/build.log</code> \u62a5\u9519\u5982\u4e0b\uff1a</p> <pre><code>ninja: error: manifest 'build.ninja' still dirty after 100 tries, perhaps system time is not set\n * ERROR: net-libs/nghttp2-1.61.0::gentoo failed (compile phase):\n *   ninja -v -j16 -l16 failed\n *\n * Call stack:\n *     ebuild.sh, line  136:  Called src_compile\n *   environment, line 2565:  Called cmake-multilib_src_compile\n *   environment, line  776:  Called multilib-minimal_src_compile\n *   environment, line 1904:  Called multilib_foreach_abi 'multilib-minimal_abi_src_compile'\n *   environment, line 2171:  Called multibuild_foreach_variant '_multilib_multibuild_wrapper' 'multilib-minimal_abi_src_compile'\n *   environment, line 1864:  Called _multibuild_run '_multilib_multibuild_wrapper' 'multilib-minimal_abi_src_compile'\n *   environment, line 1862:  Called _multilib_multibuild_wrapper 'multilib-minimal_abi_src_compile'\n *   environment, line  531:  Called multilib-minimal_abi_src_compile\n *   environment, line 1898:  Called multilib_src_compile\n *   environment, line 2391:  Called cmake_src_compile\n *   environment, line  894:  Called cmake_build\n *   environment, line  861:  Called eninja\n *   environment, line 1332:  Called die\n * The specific snippet of code:\n *       \"$@\" || die -n \"${*} failed\"\n *\n * If you need support, post the output of `emerge --info '=net-libs/nghttp2-1.61.0::gentoo'`,\n * the complete build log and the output of `emerge -pqv '=net-libs/nghttp2-1.61.0::gentoo'`.\n * The complete build log is located at '/var/tmp/portage/net-libs/nghttp2-1.61.0/temp/build.log'.\n * The ebuild environment file is located at '/var/tmp/portage/net-libs/nghttp2-1.61.0/temp/environment'.\n * Working directory: '/var/tmp/portage/net-libs/nghttp2-1.61.0/work/nghttp2-1.61.0_build-abi_x86_64.amd64'\n * S: '/var/tmp/portage/net-libs/nghttp2-1.61.0/work/nghttp2-1.61.0'\n</code></pre> <p>\u62a5\u9519\u7684\u539f\u56e0\u662f\u7cfb\u7edf\u521a\u88c5\u597d\u8fdb\u884c\u4e86\u65f6\u95f4\u540c\u6b65\uff0c ninja \u7f16\u8bd1\u53d1\u73b0\u6709\u4e00\u4e9b\u6587\u4ef6\u662f\u5728\u672a\u6765\u521b\u5efa\u7684\u3002\u89e3\u51b3\u65b9\u6cd5\u4e3a\u627e\u5230\u6240\u6709\u5728\u672a\u6765\u521b\u5efa\u7684\u6587\u4ef6\uff0c\u5e76\u5c06\u5176\u65f6\u95f4\u6233\u4fee\u6539\u4e3a\u73b0\u5728\uff1a</p> <pre><code>touch currtime\nfind / -cnewer currtime -exec touch {} \\;\nrm currtime\n</code></pre> <p>\u6700\u540e\u5355\u72ec\u91cd\u65b0\u7f16\u8bd1\u8fd9\u4e00\u4e2a\u5305\uff1a</p> <pre><code>emerge -av =net-libs/nghttp2-1.61.0\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/emerge%E8%A3%85%E5%8C%85ninja%E6%8A%A5%E9%94%99%E2%80%9Cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%E2%80%9D%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95.html#1","title":"1. \u53c2\u8003\u8d44\u6599","text":"<p>https://forums.gentoo.org/viewtopic-p-8768044.html?sid=ed3fa313c3404a3db1ef5260515270ef</p>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html","title":"\u5728 Hyper-V \u73af\u5883\u5b89\u88c5 Gentoo","text":"<p>Note</p> <p>\u672c\u6b21 Gentoo \u5b89\u88c5\u5c06\u4f1a\u5b89\u88c5\u5728 UEFI \u6a21\u5f0f\u542f\u52a8\u7684 Hyper-V \u865a\u62df\u673a\u4e0a\uff0c\u5176\u4e2d init \u65b9\u5f0f\u9009\u62e9\u4f20\u7edf\u7684 openrc \u800c\u975e systemd \u3002</p>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#1","title":"1. \u51c6\u5907\u5de5\u4f5c","text":"","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#11","title":"1.1 \u4e0b\u8f7d\u5b89\u88c5\u4ecb\u8d28","text":"<p>\u53bb Gentoo \u4e0b\u8f7d\u5b98\u7f51 \uff0c\u4e0b\u8f7d Boot Media \u548c Stage Archive\uff1a</p> <p></p>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#12","title":"1.2 \u53d1\u653e\u865a\u62df\u673a","text":"<p>\u53d1\u653e\u6ee1\u8db3\u5982\u4e0b\u8981\u6c42\u7684\u865a\u62df\u673a\uff1a</p> <ul> <li>\u865a\u62df\u673a\u4ee3\u6570\uff1a\u7b2c 2 \u4ee3 \uff08UEFI \u542f\u52a8\uff09</li> <li>\u78c1\u76d8\u5927\u5c0f\uff1a64GB</li> <li>CD-ROM\uff1a\u521a\u521a\u4e0b\u8f7d\u7684 Boot Media ISO \u6587\u4ef6</li> <li>Secure Boot\uff1a\u5173\u95ed</li> </ul> <p>\u53d1\u653e\u5b8c\u6210\u540e\uff0c\u4ece CD-ROM \u542f\u52a8\u5e76\u5f15\u5bfc\u8fdb\u5165\u7cfb\u7edf\u3002</p>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#13-ssh","title":"1.3 \u8fde\u63a5\u7f51\u7edc\u5e76\u542f\u52a8 SSH \u670d\u52a1","text":"<p>\u4f7f\u7528\u9759\u6001 IP \u5730\u5740\u7684\u65b9\u5f0f\u914d\u7f6e\u7f51\u7edc\uff0c\u4f7f\u7528 <code>ip a</code> \u547d\u4ee4\u67e5\u8be2\u5230\u5f53\u524d\u73af\u5883\u7f51\u5361\u540d\u79f0\u4e3a <code>eth0</code> \uff0c\u4e4b\u540e\u4f7f\u7528\u547d\u4ee4 <code>net-setup eth0</code> \u547d\u4ee4\u914d\u7f6e\u7f51\u7edc\uff0c\u4e00\u8def\u56de\u8f66\u5373\u4f7f\u7528 DHCP \u6a21\u5f0f\u3002\u4e4b\u540e\u4f7f\u7528 <code>ifconfig</code> \u547d\u4ee4\u67e5\u770b DHCP \u83b7\u5f97\u7684 IP \u5730\u5740\u3002</p> <p>\u4e4b\u540e\u4f7f\u7528 <code>passwd</code> \u547d\u4ee4\u8bbe\u7f6e\u4e34\u65f6 root \u5bc6\u7801\uff0c\u4f7f\u7528 <code>rc-service sshd start</code> \u547d\u4ee4\u542f\u52a8 SSH \u670d\u52a1\uff0c\u540e\u7eed\u901a\u8fc7 SSH \u8fdc\u7a0b\u8fde\u63a5\u6765\u7ee7\u7eed\u5b89\u88c5\u3002</p>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#2","title":"2. \u78c1\u76d8\u5206\u533a\u683c\u5f0f\u5316","text":"<p>\u4f7f\u7528 <code>fdisk</code> \u5bf9\u786c\u76d8\u8fdb\u884c\u5206\u533a\uff0c\u5206\u533a\u8868\u683c\u5f0f\u4e3a GPT \uff0c\u6b64\u6b21\u4f7f\u7528\u7684\u5206\u533a\u8868\u5982\u4e0b\uff1a</p> \u5206\u533a\u540d\u79f0 \u5206\u533a\u5927\u5c0f \u6587\u4ef6\u7cfb\u7edf \u6302\u8f7d\u70b9 /dev/sda1 1G ext4 /boot /dev/sda2 256M vfat /boot/efi /dev/sda3 \u78c1\u76d8\u5269\u4f59\u6240\u6709\u7a7a\u95f4 ext4 / <p>\u683c\u5f0f\u5316\u78c1\u76d8\u5206\u533a\uff1a</p> <pre><code>mkfs.ext4 /dev/sda1\nmkfs.vfat /dev/sda2\nmkfs.ext4 /dev/sda3\n</code></pre> <p>\u6302\u8f7d\u6587\u4ef6\u7cfb\u7edf\uff1a</p> <pre><code>mkdir --parents /mnt/gentoo\nmount /dev/sda3 /mnt/gentoo\nmkdir --parents /mnt/gentoo/boot\nmount /dev/sda1 /mnt/gentoo/boot\nmkdir --parents /mnt/gentoo/boot/efi\nmount /dev/sda2 /mnt/gentoo/boot/efi\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#3-stage","title":"3. \u89e3\u538b stage \u6587\u4ef6","text":"<p>\u5148\u5c06 stage \u6587\u4ef6\u653e\u5728\u5bb6\u76ee\u5f55\u4e0b\uff0c\u7136\u540e\u89e3\u538b\uff1a</p> <pre><code>cd /mnt/gentoo/\ntar xpvf ~/stage3-*.tar.xz --xattrs-include='*.*' --numeric-owner\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#4","title":"4. \u540c\u6b65\u65f6\u95f4","text":"<p>\u6700\u597d\u5728\u5b89\u88c5\u524d\u7528 <code>chronyd</code> \u547d\u4ee4\u540c\u6b65\u4e0b\u65f6\u95f4\uff0c\u907f\u514d\u65e5\u540e\u4e0b\u8f7d\u4e1c\u897f\u62a5\u9519\uff1a</p> <pre><code>chronyd -q\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#5","title":"5. \u9ed8\u8ba4\u914d\u7f6e\u4fee\u6539","text":"<p>\u4fee\u6539 <code>/mnt/gentoo/etc/portage/make.conf</code> \u4e2d\u4ee5\u4e0b\u4e00\u884c\uff1a</p> <pre><code>COMMON_FLAGS=\"-march=native -O2 -pipe\"\n</code></pre> <p>\u4fee\u6539\u4e4b\u540e\u7f16\u8bd1\u5b89\u88c5\u6240\u6709\u8f6f\u4ef6\u4f1a\u6839\u636e\u673a\u5668\u81ea\u5df1\u7684\u6307\u4ee4\u96c6\u7f16\u8bd1\u3002</p>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#6-base-system","title":"6. \u5b89\u88c5 base system","text":"","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#61-dns","title":"6.1 \u590d\u5236 DNS \u670d\u52a1\u5668\u4fe1\u606f\u5230\u65b0\u7cfb\u7edf","text":"<pre><code>cp --dereference /etc/resolv.conf /mnt/gentoo/etc/\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#62","title":"6.2 \u6302\u8f7d\u6587\u4ef6\u7cfb\u7edf","text":"<pre><code>mount --types proc /proc /mnt/gentoo/proc\nmount --rbind /sys /mnt/gentoo/sys\nmount --make-rslave /mnt/gentoo/sys\nmount --rbind /dev /mnt/gentoo/dev\nmount --make-rslave /mnt/gentoo/dev\nmount --bind /run /mnt/gentoo/run\nmount --make-slave /mnt/gentoo/run\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#63-chroot","title":"6.3 chroot \u8fdb\u5165\u65b0\u7cfb\u7edf","text":"<p>\u6302\u8f7d\u6587\u4ef6\u7cfb\u7edf\u540e\uff0c chroot \u8fdb\u5165\u65b0\u7cfb\u7edf\uff1a</p> <pre><code>chroot /mnt/gentoo /bin/bash\n</code></pre> <p>chroot \u4e4b\u540e\u9700\u8981 source \u4e0b profile\uff1a</p> <pre><code>source /etc/profile\nexport PS1=\"(chroot) ${PS1}\"\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#64-portage","title":"6.4 \u914d\u7f6e portage","text":"<p>\u521b\u5efa\u914d\u7f6e\u6587\u4ef6\uff1a</p> <pre><code>mkdir --parents /etc/portage/repos.conf\ncp /usr/share/portage/config/repos.conf /etc/portage/repos.conf/gentoo.conf\n</code></pre> <p>\u4e3a\u4e86\u52a0\u5feb\u4e0b\u8f7d\u901f\u5ea6\uff0c\u9700\u8981\u914d\u7f6e\u955c\u50cf\uff0c\u4fee\u6539 <code>/etc/portage/repos.conf/gentoo.conf</code> \uff1a</p> <pre><code>sync-uri = rsync://mirrors.tuna.tsinghua.edu.cn/gentoo-portage\n</code></pre> <p>\u5728 <code>/etc/portage/make.conf</code> \u4e2d\u52a0\u5165\uff1a</p> <pre><code>GENTOO_MIRRORS=\"https://mirrors.tuna.tsinghua.edu.cn/gentoo\"\n</code></pre> <p>\u66f4\u65b0\u4ed3\u5e93\uff1a</p> <pre><code>emerge-webrsync\nemerge --sync\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#65","title":"6.5 \u66f4\u65b0\u6240\u6709\u8f6f\u4ef6\u5305","text":"<pre><code>emerge --ask --verbose --update --deep --newuse @world\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#7","title":"7. \u672c\u5730\u5316\u914d\u7f6e","text":"","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#71","title":"7.1 \u8bbe\u7f6e\u65f6\u533a","text":"<pre><code>echo \"Asia/Shanghai\" &gt; /etc/timezone\nemerge --config sys-libs/timezone-data\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#72-locale","title":"7.2 \u8bbe\u7f6e locale","text":"<p>\u5728 <code>/etc/locale.gen</code> \u4e2d\u5bf9\u9700\u8981\u7684 locale \u53d6\u6d88\u6ce8\u91ca\uff0c\u7136\u540e\u91cd\u65b0\u751f\u6210 locale \uff1a</p> <pre><code>locale-gen\n</code></pre> <p>\u8bbe\u7f6e\u9ed8\u8ba4 locale \uff1a</p> <pre><code>eselect locale list\n</code></pre> <pre><code>Available targets for the LANG variable:\n  [1]   C\n  [2]   C.utf8\n  [3]   POSIX\n  [4]   en_US.utf8\n  [5]   C.UTF8 *\n  [ ]   (free form)\n</code></pre> <pre><code>eselect locale set 4\n</code></pre> <pre><code>Setting LANG to en_US.utf8 ...\nRun \". /etc/profile\" to update the variable in your shell.\n</code></pre> <p>\u91cd\u65b0\u52a0\u8f7d profile \uff1a</p> <pre><code>env-update &amp;&amp; source /etc/profile &amp;&amp; export PS1=\"(chroot) ${PS1}\"\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#8","title":"8. \u7f16\u8bd1\u5e76\u5b89\u88c5\u5185\u6838","text":"","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#81","title":"8.1 \u4e0b\u8f7d\u5185\u6838\u6e90\u7801","text":"<pre><code>emerge --ask sys-kernel/installkernel sys-kernel/gentoo-sources\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#82","title":"8.2 \u9009\u62e9\u5185\u6838\u6e90\u7801","text":"<pre><code>eselect kernel list\n</code></pre> <pre><code>Available kernel symlink targets:\n  [1]   linux-6.6.21-gentoo\n</code></pre> <pre><code>eselect kernel set 1\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#83-genkernel","title":"8.3 \u5b89\u88c5 genkernel","text":"<pre><code>mkdir -p /etc/portage/package.license\necho 'sys-kernel/linux-firmware @BINARY-REDISTRIBUTABLE' &gt; /etc/portage/package.license/linux-firmware\nemerge --ask sys-kernel/genkernel\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#84","title":"8.4 \u7f16\u8bd1\u5185\u6838","text":"<p>\u7528 genkernel \u751f\u6210\u5e76\u81ea\u52a8\u5b89\u88c5\u5185\u6838\uff1a</p> <pre><code>genkernel --mountboot --install all --hyperv\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#9","title":"9. \u5b89\u88c5\u540e\u914d\u7f6e","text":"","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#91-fstab","title":"9.1 \u914d\u7f6e fstab","text":"<p>\u7f16\u8f91 <code>/etc/fstab</code>\uff1a</p> <pre><code>/dev/sda1 /boot ext4 defaults  0 2\n/dev/sda2 /boot/efi vfat defaults 0 0\n/dev/vda3 / ext4 defaults  0 0\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#92","title":"9.2 \u914d\u7f6e\u4e3b\u673a\u540d","text":"<pre><code>echo gentoo &gt; /etc/hostname\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#93","title":"9.3 \u5b89\u88c5\u5fc5\u8981\u7684\u8f6f\u4ef6","text":"<p>\u5b89\u88c5 dhcpcd \u6765\u4e3a DHCP \u63d0\u4f9b\u652f\u6301:</p> <pre><code>emerge --ask net-misc/dhcpcd\nrc-update add dhcpcd default\nrc-service dhcpcd start\n</code></pre> <p>\u5b89\u88c5 netifrc \u6765\u7ba1\u7406\u7f51\u7edc\uff1a</p> <pre><code>emerge --ask --noreplace net-misc/netifrc\n</code></pre> <p>\u5b89\u88c5 system logger \u3001 chrony \u7b49\u57fa\u7840\u8f6f\u4ef6\uff1a</p> <pre><code>emerge --ask app-admin/sysklogd sys-process/cronie sys-apps/mlocate net-misc/chrony app-shells/bash-completion sys-fs/xfsprogs sys-block/io-scheduler-udev-rules\nrc-update add sysklogd default\nrc-update add chronyd default\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#94-bootloader","title":"9.4 \u5b89\u88c5 bootloader","text":"<p>\u5b89\u88c5 grub \u8f6f\u4ef6\u5305\uff1a</p> <pre><code>echo 'GRUB_PLATFORMS=\"efi-64\"' &gt;&gt; /etc/portage/make.conf\nemerge --ask --verbose sys-boot/grub\n</code></pre> <p>\u5b89\u88c5 grub \u5230\u786c\u76d8\u5934\uff1a</p> <pre><code>grub-install --efi-directory=/boot/efi\n</code></pre> <p>\u751f\u6210 grub \u542f\u52a8\u9879\u914d\u7f6e\uff1a</p> <pre><code>grub-mkconfig -o /boot/grub/grub.cfg\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#95-root","title":"9.5 \u8bbe\u7f6e root \u5bc6\u7801","text":"<p>\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u4e0d\u8981\u5fd8\u8bb0\u7528 <code>passwd</code> \u547d\u4ee4\u8bbe\u7f6e\u5bc6\u7801\u3002</p>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#96","title":"9.6 \u914d\u7f6e\u7f51\u7edc","text":"<p>\u4f7f\u7528 DHCP \u7684\u65b9\u5f0f\u914d\u7f6e\u7f51\u7edc\uff0c\u5728 <code>/etc/conf.d/net</code> \u4e2d\u589e\u52a0\u7f51\u5361\u914d\u7f6e\uff1a</p> <pre><code>config_eth0=\"dhcp\"\n</code></pre> <p>\u914d\u7f6e\u5f00\u673a\u542f\u52a8\uff08\u5982\u679c\u662f\u9759\u6001\u5730\u5740\uff0c\u9700\u8981\u7981\u7528 dhcpcd \u9632\u6b62\u5176\u81ea\u52a8\u83b7\u53d6 169.254 \u7f51\u5173\uff09\uff1a</p> <pre><code>cd /etc/init.d\nln -s net.lo net.eth0\nrc-update add net.eth0 default\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#97-ssh","title":"9.7 \u914d\u7f6e SSH \u5f00\u673a\u542f\u52a8","text":"<pre><code>rc-update add sshd default\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#98-ssh-root","title":"9.8 \u914d\u7f6e SSH \u5141\u8bb8 root \u4f7f\u7528\u5bc6\u7801\u767b\u5f55","text":"<p>\u4fee\u6539 <code>/etc/ssh/sshd_config</code> \uff1a</p> <pre><code>PermitRootLogin yes\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#10","title":"10. \u5b89\u88c5\u5b8c\u6210\u5e76\u91cd\u542f","text":"<p>\u9000\u51fa chroot \u73af\u5883\uff1a</p> <pre><code>exit\n</code></pre> <p>\u5378\u8f7d\u6587\u4ef6\u7cfb\u7edf\u5e76\u91cd\u542f\uff1a</p> <pre><code>umount -l /mnt/gentoo/dev{/shm,/pts,}\numount -R /mnt/gentoo\nreboot\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8Hyper-V%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#11_1","title":"11. \u53c2\u8003\u6587\u732e","text":"<p>https://wiki.gentoo.org/wiki/Handbook:AMD64</p> <p>https://wiki.gentoo.org/wiki/QEMU/Linux_guest#Kernel</p> <p>https://wiki.gentoo.org/wiki/Kernel/Configuration</p>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html","title":"\u5728 QEMU \u73af\u5883\u5b89\u88c5 Gentoo","text":"<p>Note</p> <p>\u672c\u6b21 Gentoo \u5b89\u88c5\u5c06\u4f1a\u5b89\u88c5\u5728 BIOS \u6a21\u5f0f\u542f\u52a8\u7684 QEMU \u865a\u62df\u673a\u4e0a\uff0c\u5176\u4e2d init \u65b9\u5f0f\u9009\u62e9\u4f20\u7edf\u7684 openrc \u800c\u975e systemd \u3002</p>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#1","title":"1. \u51c6\u5907\u5de5\u4f5c","text":"","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#11","title":"1.1 \u4e0b\u8f7d\u5b89\u88c5\u4ecb\u8d28","text":"<p>\u53bb Gentoo \u4e0b\u8f7d\u5b98\u7f51 \uff0c\u4e0b\u8f7d Boot Media \u548c Stage Archive\uff1a</p> <p></p>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#12","title":"1.2 \u53d1\u653e\u865a\u62df\u673a","text":"<p>\u53d1\u653e\u6ee1\u8db3\u5982\u4e0b\u8981\u6c42\u7684\u865a\u62df\u673a\uff1a</p> <ul> <li>\u542f\u52a8\u65b9\u5f0f\uff1aBIOS</li> <li>\u78c1\u76d8\u5927\u5c0f\uff1a64GB</li> <li>CD-ROM\uff1a\u521a\u521a\u4e0b\u8f7d\u7684 Boot Media ISO \u6587\u4ef6</li> <li>Secure Boot\uff1a\u5173\u95ed</li> <li>QEMU Guest Agent\uff1a\u5f00\u542f</li> </ul> <p>\u53d1\u653e\u5b8c\u6210\u540e\uff0c\u4ece CD-ROM \u542f\u52a8\u5e76\u5f15\u5bfc\u8fdb\u5165\u7cfb\u7edf\u3002</p>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#13-ssh","title":"1.3 \u8fde\u63a5\u7f51\u7edc\u5e76\u542f\u52a8 SSH \u670d\u52a1","text":"<p>\u4f7f\u7528\u9759\u6001 IP \u5730\u5740\u7684\u65b9\u5f0f\u914d\u7f6e\u7f51\u7edc\uff0c\u4f7f\u7528 <code>ip a</code> \u547d\u4ee4\u67e5\u8be2\u5230\u5f53\u524d\u73af\u5883\u7f51\u5361\u540d\u79f0\u4e3a <code>enp0s18</code> \uff0c\u4e4b\u540e\u4f7f\u7528\u547d\u4ee4 <code>net-setup enp0s18</code> \u547d\u4ee4\u914d\u7f6e\u7f51\u7edc\uff0c\u672c\u6b21 IP \u5730\u5740\u6682\u65f6\u914d\u7f6e\u4e3a <code>192.168.100.200</code> \uff08\u8ddf\u7740 TUI \u754c\u9762\u6307\u5f15\u4e00\u6b65\u6b65\u914d\u7f6e\u5373\u53ef\uff09\u3002</p> <p>Tip</p> <p>\u5982\u679c\u914d\u7f6e\u5b8c\u6210\u540e\u7f51\u7edc\u4e0d\u901a\uff0c\u9700\u8981\u7528 <code>ip r</code> \u547d\u4ee4\u68c0\u67e5\u8def\u7531\u8868\u662f\u5426\u6b63\u786e\uff0c\u5982\u679c\u4e0d\u6b63\u786e\u9700\u8981\u6dfb\u52a0\u5982\u4e0b\u8def\u7531\uff1a <pre><code>ip route add 192.168.100.0/24 dev enp0s18\nip route add default via 192.168.100.1\n</code></pre> \u7528\u4ee5\u4e0b\u547d\u4ee4\u91cd\u542f\u7f51\u5361\uff1a <pre><code>ifconfig enp0s18 down\nifconfig enp0s18 up\n</code></pre></p> <p>\u4e4b\u540e\u4f7f\u7528 <code>passwd</code> \u547d\u4ee4\u8bbe\u7f6e\u4e34\u65f6 root \u5bc6\u7801\uff0c\u4f7f\u7528 <code>rc-service sshd start</code> \u547d\u4ee4\u542f\u52a8 SSH \u670d\u52a1\uff0c\u540e\u7eed\u901a\u8fc7 SSH \u8fdc\u7a0b\u8fde\u63a5\u6765\u7ee7\u7eed\u5b89\u88c5\u3002</p>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#2","title":"2. \u78c1\u76d8\u5206\u533a\u683c\u5f0f\u5316","text":"<p>\u53c2\u8003 \u5b98\u65b9\u624b\u518c \u7684 \"Partitioning the disk with MBR for BIOS / legacy boot\" \u8fdb\u884c\u5206\u533a\uff08\u4e0d\u521b\u5efa swap \u5206\u533a\uff09\uff1a</p> <pre><code>livecd ~ # fdisk /dev/vda\n\nWelcome to fdisk (util-linux 2.39.3).\nChanges will remain in memory only, until you decide to write them.\nBe careful before using the write command.\n\nDevice does not contain a recognized partition table.\nCreated a new DOS (MBR) disklabel with disk identifier 0x043cf7fb.\n\nCommand (m for help): o\nCreated a new DOS (MBR) disklabel with disk identifier 0x76a86e99.\n\nCommand (m for help): n\nPartition type\n   p   primary (0 primary, 0 extended, 4 free)\n   e   extended (container for logical partitions)\nSelect (default p): p\nPartition number (1-4, default 1):\nFirst sector (2048-134217727, default 2048):\nLast sector, +/-sectors or +/-size{K,M,G,T,P} (2048-134217727, default 134217727): +1G\n\nCreated a new partition 1 of type 'Linux' and of size 1 GiB.\n\nCommand (m for help): a\nSelected partition 1\nThe bootable flag on partition 1 is enabled now.\n\nCommand (m for help): n\nPartition type\n   p   primary (1 primary, 0 extended, 3 free)\n   e   extended (container for logical partitions)\nSelect (default p):\n\nUsing default response p.\nPartition number (2-4, default 2):\nFirst sector (2099200-134217727, default 2099200):\nLast sector, +/-sectors or +/-size{K,M,G,T,P} (2099200-134217727, default 134217727):\n\nCreated a new partition 2 of type 'Linux' and of size 63 GiB.\n\nCommand (m for help): p\nDisk /dev/vda: 64 GiB, 68719476736 bytes, 134217728 sectors\nUnits: sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisklabel type: dos\nDisk identifier: 0x76a86e99\n\nDevice     Boot   Start       End   Sectors Size Id Type\n/dev/vda1  *       2048   2099199   2097152   1G 83 Linux\n/dev/vda2       2099200 134217727 132118528  63G 83 Linux\n\nCommand (m for help): w\nThe partition table has been altered.\nCalling ioctl() to re-read partition table.\nSyncing disks.\n</code></pre> <p>\u683c\u5f0f\u5316\u5e76\u6302\u8f7d\u6587\u4ef6\u7cfb\u7edf\uff1a</p> <pre><code>mkfs.xfs /dev/vda1\nmkfs.xfs /dev/vda2\nmkdir --parents /mnt/gentoo\nmount /dev/vda2 /mnt/gentoo\nmkdir --parents /mnt/gentoo/boot\nmount /dev/vda1 /mnt/gentoo/boot\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#3-stage","title":"3. \u89e3\u538b stage \u6587\u4ef6","text":"<p>\u5148\u5c06 stage \u6587\u4ef6\u653e\u5728\u5bb6\u76ee\u5f55\u4e0b\uff0c\u7136\u540e\u89e3\u538b\uff1a</p> <pre><code>cd /mnt/gentoo/\ntar xpvf ~/stage3-*.tar.xz --xattrs-include='*.*' --numeric-owner\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#4","title":"4. \u540c\u6b65\u65f6\u95f4","text":"<p>\u6700\u597d\u5728\u5b89\u88c5\u524d\u7528 <code>chronyd</code> \u547d\u4ee4\u540c\u6b65\u4e0b\u65f6\u95f4\uff0c\u907f\u514d\u65e5\u540e\u4e0b\u8f7d\u4e1c\u897f\u62a5\u9519\uff1a</p> <pre><code>chronyd -q\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#5","title":"5. \u9ed8\u8ba4\u914d\u7f6e\u4fee\u6539","text":"<p>\u4fee\u6539 <code>/mnt/gentoo/etc/portage/make.conf</code> \u4e2d\u4ee5\u4e0b\u4e00\u884c\uff1a</p> <pre><code>COMMON_FLAGS=\"-march=native -O2 -pipe\"\n</code></pre> <p>\u4fee\u6539\u4e4b\u540e\u7f16\u8bd1\u5b89\u88c5\u6240\u6709\u8f6f\u4ef6\u4f1a\u6839\u636e\u673a\u5668\u81ea\u5df1\u7684\u6307\u4ee4\u96c6\u7f16\u8bd1\u3002</p>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#6-base-system","title":"6. \u5b89\u88c5 base system","text":"","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#61-dns","title":"6.1 \u590d\u5236 DNS \u670d\u52a1\u5668\u4fe1\u606f\u5230\u65b0\u7cfb\u7edf","text":"<pre><code>cp --dereference /etc/resolv.conf /mnt/gentoo/etc/\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#62","title":"6.2 \u6302\u8f7d\u6587\u4ef6\u7cfb\u7edf","text":"<pre><code>mount --types proc /proc /mnt/gentoo/proc\nmount --rbind /sys /mnt/gentoo/sys\nmount --make-rslave /mnt/gentoo/sys\nmount --rbind /dev /mnt/gentoo/dev\nmount --make-rslave /mnt/gentoo/dev\nmount --bind /run /mnt/gentoo/run\nmount --make-slave /mnt/gentoo/run\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#63-chroot","title":"6.3 chroot \u8fdb\u5165\u65b0\u7cfb\u7edf","text":"<p>\u6302\u8f7d\u6587\u4ef6\u7cfb\u7edf\u540e\uff0c chroot \u8fdb\u5165\u65b0\u7cfb\u7edf\uff1a</p> <pre><code>chroot /mnt/gentoo /bin/bash\n</code></pre> <p>chroot \u4e4b\u540e\u9700\u8981 source \u4e0b profile\uff1a</p> <pre><code>source /etc/profile\nexport PS1=\"(chroot) ${PS1}\"\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#64-portage","title":"6.4 \u914d\u7f6e portage","text":"<p>\u521b\u5efa\u914d\u7f6e\u6587\u4ef6\uff1a</p> <pre><code>mkdir --parents /etc/portage/repos.conf\ncp /usr/share/portage/config/repos.conf /etc/portage/repos.conf/gentoo.conf\n</code></pre> <p>\u4e3a\u4e86\u52a0\u5feb\u4e0b\u8f7d\u901f\u5ea6\uff0c\u9700\u8981\u914d\u7f6e\u955c\u50cf\uff0c\u4fee\u6539 <code>/etc/portage/repos.conf/gentoo.conf</code> \uff1a</p> <pre><code>sync-uri = rsync://mirrors.tuna.tsinghua.edu.cn/gentoo-portage\n</code></pre> <p>\u5728 <code>/etc/portage/make.conf</code> \u4e2d\u52a0\u5165\uff1a</p> <pre><code>GENTOO_MIRRORS=\"https://mirrors.tuna.tsinghua.edu.cn/gentoo\"\n</code></pre> <p>\u66f4\u65b0\u4ed3\u5e93\uff1a</p> <pre><code>emerge-webrsync\nemerge --sync\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#65","title":"6.5 \u66f4\u65b0\u6240\u6709\u8f6f\u4ef6\u5305","text":"<pre><code>emerge --ask --verbose --update --deep --newuse @world\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#7","title":"7. \u672c\u5730\u5316\u914d\u7f6e","text":"","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#71","title":"7.1 \u8bbe\u7f6e\u65f6\u533a","text":"<pre><code>echo \"Asia/Shanghai\" &gt; /etc/timezone\nemerge --config sys-libs/timezone-data\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#72-locale","title":"7.2 \u8bbe\u7f6e locale","text":"<p>\u5728 <code>/etc/locale.gen</code> \u4e2d\u5bf9\u9700\u8981\u7684 locale \u53d6\u6d88\u6ce8\u91ca\uff0c\u7136\u540e\u91cd\u65b0\u751f\u6210 locale \uff1a</p> <pre><code>locale-gen\n</code></pre> <p>\u8bbe\u7f6e\u9ed8\u8ba4 locale \uff1a</p> <pre><code>eselect locale list\n</code></pre> <pre><code>Available targets for the LANG variable:\n  [1]   C\n  [2]   C.utf8\n  [3]   POSIX\n  [4]   en_US.utf8\n  [5]   C.UTF8 *\n  [ ]   (free form)\n</code></pre> <pre><code>eselect locale set 4\n</code></pre> <pre><code>Setting LANG to en_US.utf8 ...\nRun \". /etc/profile\" to update the variable in your shell.\n</code></pre> <p>\u91cd\u65b0\u52a0\u8f7d profile \uff1a</p> <pre><code>env-update &amp;&amp; source /etc/profile &amp;&amp; export PS1=\"(chroot) ${PS1}\"\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#8","title":"8. \u7f16\u8bd1\u5e76\u5b89\u88c5\u5185\u6838","text":"","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#81","title":"8.1 \u4e0b\u8f7d\u5185\u6838\u6e90\u7801","text":"<pre><code>emerge --ask sys-kernel/installkernel sys-kernel/gentoo-sources\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#82","title":"8.2 \u9009\u62e9\u5185\u6838\u6e90\u7801","text":"<pre><code>eselect kernel list\n</code></pre> <pre><code>Available kernel symlink targets:\n  [1]   linux-6.6.21-gentoo\n</code></pre> <pre><code>eselect kernel set 1\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#83-genkernel","title":"8.3 \u5b89\u88c5 genkernel","text":"<pre><code>mkdir -p /etc/portage/package.license\necho 'sys-kernel/linux-firmware @BINARY-REDISTRIBUTABLE' &gt; /etc/portage/package.license/linux-firmware\nemerge --ask sys-kernel/genkernel\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#84","title":"8.4 \u7f16\u8bd1\u5185\u6838","text":"<p>\u7528 genkernel \u751f\u6210\u5e76\u81ea\u52a8\u5b89\u88c5\u5185\u6838\uff1a</p> <pre><code>genkernel --mountboot --install all --menuconfig\n</code></pre> <p>\u6ce8\u610f\uff0c\u5728\u5f39\u51fa\u7684\u754c\u9762\u4e2d\uff0c\u9700\u8981\u989d\u5916\u914d\u7f6e\u8fd9\u51e0\u9879\u6765\u5c06\u76f8\u5173\u9a71\u52a8\u7f16\u8bd1\u8fdb\u5185\u6838\uff1a</p> <pre><code>Processor type and features  ---&gt;\n    [*] Linux guest support ---&gt;\n        [*] Enable Paravirtualization code\n        [*] KVM Guest support (including kvmclock)\nDevice Drivers  ---&gt;\n    [*] Virtio drivers  ---&gt;\n        &lt;*&gt; PCI driver for virtio devices\n    [*] Block devices  ---&gt;\n        &lt;*&gt; Virtio block driver\n    SCSI device support  ---&gt;\n        [*] SCSI low-level drivers  ---&gt;\n            [*] virtio-scsi support\n    [*] Network device support  ---&gt;\n        [*] Network core driver support\n            &lt;*&gt; Virtio network driver\n    Graphics support  ---&gt;\n        &lt;*&gt; Direct Rendering Manager (XFree86 4.1.0 and higher DRI support)  ---&gt;\n        &lt;*&gt; Virtio GPU driver\n    Character devices ---&gt;\n       &lt;*&gt; Hardware Random Number Generator Core support ---&gt;\n           &lt;*&gt; VirtIO Random Number Generator support\n       &lt;*&gt; Virtio console\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#85-qemu","title":"8.5 \u5b89\u88c5 QEMU \u865a\u62df\u673a\u76f8\u5173\u8f6f\u4ef6","text":"<pre><code>emerge --ask sys-power/acpid app-emulation/qemu-guest-agent\nrc-update add acpid default\nrc-update add qemu-guest-agent default\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#9","title":"9. \u5b89\u88c5\u540e\u914d\u7f6e","text":"","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#91-fstab","title":"9.1 \u914d\u7f6e fstab","text":"<p>\u7f16\u8f91 <code>/etc/fstab</code>\uff1a</p> <pre><code>/dev/vda1 /boot xfs defaults  0 2\n/dev/vda2 / xfs defaults  0 0\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#92","title":"9.2 \u914d\u7f6e\u4e3b\u673a\u540d","text":"<pre><code>echo gentoo &gt; /etc/hostname\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#93","title":"9.3 \u5b89\u88c5\u5fc5\u8981\u7684\u8f6f\u4ef6","text":"<p>\u5b89\u88c5 dhcpcd \u6765\u4e3a DHCP \u63d0\u4f9b\u652f\u6301:</p> <pre><code>emerge --ask net-misc/dhcpcd\nrc-update add dhcpcd default\nrc-service dhcpcd start\n</code></pre> <p>\u5b89\u88c5 netifrc \u6765\u7ba1\u7406\u7f51\u7edc\uff1a</p> <pre><code>emerge --ask --noreplace net-misc/netifrc\n</code></pre> <p>\u5b89\u88c5 system logger \u3001 chrony \u7b49\u57fa\u7840\u8f6f\u4ef6\uff1a</p> <pre><code>emerge --ask app-admin/sysklogd sys-process/cronie sys-apps/mlocate net-misc/chrony app-shells/bash-completion sys-fs/xfsprogs sys-block/io-scheduler-udev-rules\nrc-update add sysklogd default\nrc-update add chronyd default\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#94-bootloader","title":"9.4 \u5b89\u88c5 bootloader","text":"<p>\u5b89\u88c5 grub \u8f6f\u4ef6\u5305\uff1a</p> <pre><code>echo 'GRUB_PLATFORMS=\"pc\"' &gt;&gt; /etc/portage/make.conf\nemerge --ask --verbose sys-boot/grub\n</code></pre> <p>\u914d\u7f6e grub \uff0c\u4fee\u6539 <code>/etc/default/grub</code> \uff1a</p> <pre><code>GRUB_CMDLINE_LINUX=\"console=tty0 console=ttyS0\"\nGRUB_TERMINAL=console\n</code></pre> <p>\u914d\u7f6e <code>/etc/inittab</code> \uff1a</p> <pre><code># SERIAL CONSOLES\ns0:12345:respawn:/sbin/agetty -L 115200 ttyS0 vt100\n</code></pre> <p>\u5b89\u88c5 grub \u5230\u786c\u76d8\u5934\uff1a</p> <pre><code>grub-install /dev/vda\n</code></pre> <p>\u751f\u6210 grub \u542f\u52a8\u9879\u914d\u7f6e\uff1a</p> <pre><code>grub-mkconfig -o /boot/grub/grub.cfg\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#95-root","title":"9.5 \u8bbe\u7f6e root \u5bc6\u7801","text":"<p>\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u4e0d\u8981\u5fd8\u8bb0\u7528 <code>passwd</code> \u547d\u4ee4\u8bbe\u7f6e\u5bc6\u7801\u3002</p>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#96","title":"9.6 \u914d\u7f6e\u7f51\u7edc","text":"<p>Note</p> <p>\u90e8\u5206\u5b89\u88c5\u573a\u666f\u4e0b\u7f51\u5361 <code>enp0s18</code> \u5728\u8fdb\u5165\u65b0\u7cfb\u7edf\u540e\u4f1a\u53d8\u6210 <code>ens18</code> \uff0c\u9700\u8981\u8fdb\u884c\u76f8\u5e94\u8c03\u6574\u3002</p> <p>\u4f7f\u7528\u9759\u6001\u5730\u5740\u7684\u65b9\u5f0f\u914d\u7f6e\u7f51\u7edc\uff0c\u5728 <code>/etc/conf.d/net</code> \u4e2d\u589e\u52a0\u7f51\u5361\u914d\u7f6e\uff1a</p> <pre><code>config_enp0s18=\"192.168.100.5 netmask 255.255.255.0 brd 192.168.100.255\"\nroutes_enp0s18=\"default via 192.168.100.1\"\n</code></pre> <p>\u914d\u7f6e\u5f00\u673a\u542f\u52a8\uff08\u5982\u679c\u662f\u9759\u6001\u5730\u5740\uff0c\u9700\u8981\u7981\u7528 dhcpcd \u9632\u6b62\u5176\u81ea\u52a8\u83b7\u53d6 169.254 \u7f51\u5173\uff09\uff1a</p> <pre><code>cd /etc/init.d\nln -s net.lo net.enp0s18\nrc-update del dhcpcd\nrc-update add net.enp0s18 default\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#97-ssh","title":"9.7 \u914d\u7f6e SSH \u5f00\u673a\u542f\u52a8","text":"<pre><code>rc-update add sshd default\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#10","title":"10. \u5b89\u88c5\u5b8c\u6210\u5e76\u91cd\u542f","text":"<pre><code>exit\numount -l /mnt/gentoo/dev{/shm,/pts,}\numount -R /mnt/gentoo\nreboot\n</code></pre>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%9C%A8QEMU%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85Gentoo.html#11_1","title":"11. \u53c2\u8003\u6587\u732e","text":"<p>https://wiki.gentoo.org/wiki/Handbook:AMD64</p> <p>https://wiki.gentoo.org/wiki/QEMU/Linux_guest#Kernel</p> <p>https://wiki.gentoo.org/wiki/Kernel/Configuration</p>","tags":["Gentoo","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%AE%89%E8%A3%85xfce%E5%90%8Efcitx%E5%8F%B3%E4%B8%8A%E8%A7%92%E6%98%BE%E7%A4%BA%E4%BD%86%E6%97%A0%E6%B3%95%E9%80%89%E6%8B%A9%E8%BE%93%E5%85%A5%E6%B3%95%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3.html","title":"\u5b89\u88c5 xfce \u540e fcitx \u53f3\u4e0a\u89d2\u663e\u793a\u4f46\u65e0\u6cd5\u9009\u62e9\u8f93\u5165\u6cd5\u95ee\u9898\u89e3\u51b3","text":"","tags":["Gentoo","Linux","xfce","fcitx"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%AE%89%E8%A3%85xfce%E5%90%8Efcitx%E5%8F%B3%E4%B8%8A%E8%A7%92%E6%98%BE%E7%A4%BA%E4%BD%86%E6%97%A0%E6%B3%95%E9%80%89%E6%8B%A9%E8%BE%93%E5%85%A5%E6%B3%95%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3.html#1","title":"1. \u95ee\u9898\u63cf\u8ff0","text":"<p>\u5728\u5b89\u88c5 xfce \u540e\uff0c\u5b89\u88c5 fcitx-rime \uff0c\u4e4b\u540e\u53d1\u73b0\u8f93\u5165\u6cd5\u7684\u952e\u76d8\u56fe\u6807\u5728\u53f3\u4e0a\u89d2\u80fd\u663e\u793a\uff0c\u4f46\u662f\u53f3\u952e\u65e0\u6cd5\u9009\u62e9\u8f93\u5165\u6cd5\u3002\u5df2\u7ecf\u5c1d\u8bd5\u8fc7\u7684\u65b9\u6cd5\u4e3a\uff1a</p> <ul> <li>\u5c06\u90a3\u4e09\u4e2a\u73af\u5883\u53d8\u91cf\u540c\u65f6\u914d\u7f6e\u4e8e <code>~/.xprofile</code> \u3001 <code>~/.xinitrc</code> \u548c <code>/etc/profile.d/fcitx.sh</code> \uff0c\u91cd\u542f\uff0c\u95ee\u9898\u4f9d\u65e7\u5b58\u5728\u3002</li> <li>\u4f7f\u7528 <code>fcitx-diagnose</code> \u8bca\u65ad\uff0c\u53d1\u73b0\u65e0\u5f02\u5e38\u3002</li> <li>\u5c1d\u8bd5\u4f7f\u7528 vnc \u8fde\u63a5\uff0c\u95ee\u9898\u4f9d\u65e7\u5b58\u5728\u3002</li> </ul>","tags":["Gentoo","Linux","xfce","fcitx"]},{"location":"%E6%8A%98%E8%85%BELinux/Gentoo/%E5%AE%89%E8%A3%85xfce%E5%90%8Efcitx%E5%8F%B3%E4%B8%8A%E8%A7%92%E6%98%BE%E7%A4%BA%E4%BD%86%E6%97%A0%E6%B3%95%E9%80%89%E6%8B%A9%E8%BE%93%E5%85%A5%E6%B3%95%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3.html#2","title":"2. \u89e3\u51b3\u65b9\u6cd5","text":"<p>\u5b89\u88c5 ibus \u8f93\u5165\u6cd5\u540e\uff0c\u95ee\u9898\u81ea\u52a8\u89e3\u51b3\uff0c\u6211\u4e5f\u4e0d\u77e5\u9053\u4e3a\u4ec0\u4e48\uff1a</p> <pre><code>emerge --ask app-i18n/ibus ibus-libpinyin\n</code></pre> <p>\u8868\u73b0\u4e3a\u5b89\u88c5 ibus \u540e\uff0c\u6211\u5c06\u4e09\u4e2a\u73af\u5883\u53d8\u91cf\u6e05\u9664\uff1a</p> <pre><code>export GTK_IM_MODULE=fcitx\nexport QT_IM_MODULE=fcitx\nexport XMODIFIERS=@im=fcitx\n</code></pre> <p>\u7136\u540e\u6539\u6210\u4e86 ibus \u7684\uff1a</p> <pre><code>GTK_IM_MODULE=ibus\nQT_IM_MODULE=ibus\nXMODIFIERS=@im=ibus\n</code></pre> <p>\u4e4b\u540e\u6ca1\u6709\u5378\u8f7d fcitx \uff0c\u91cd\u542f\u540e\u53d1\u73b0 xfce \u53f3\u4e0a\u89d2\u952e\u76d8\u56fe\u6807\u53d8\u6210\u52a0\u7c97\u7684\u56fe\u6807\uff0c fcitx \u83ab\u540d\u5176\u5999\u5730\u597d\u4e86\u3002\u5220\u9664 ibus \u73af\u5883\u53d8\u91cf\uff0c\u4e0d\u6dfb\u52a0 fcitx \u73af\u5883\u53d8\u91cf\uff0c\u91cd\u542f\uff0c\u4f9d\u65e7\u662f\u597d\u7684\u3002</p>","tags":["Gentoo","Linux","xfce","fcitx"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/OpenWrt%20DDNS%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8%E5%A4%B1%E8%B4%A5%E9%97%AE%E9%A2%98.html","title":"OpenWrt DDNS \u5f00\u673a\u542f\u52a8\u5931\u8d25\u95ee\u9898","text":"","tags":["OpenWrt","DDNS"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/OpenWrt%20DDNS%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8%E5%A4%B1%E8%B4%A5%E9%97%AE%E9%A2%98.html#1","title":"1. \u95ee\u9898\u63cf\u8ff0","text":"<p>OpenWrt \u5728\u5b89\u88c5 <code>luci-app-ddns</code> \u548c <code>ddns-scripts-dnspod</code> \u540e\uff0c\u6bcf\u6b21\u5f00\u673a\u540e\u5747\u4e0d\u80fd\u6b63\u5e38\u542f\u52a8\u3002\u5728 <code>System -&gt; Startup -&gt; Initscripts</code> \u91cc\u663e\u793a <code>ddns</code> \u662f <code>Enabled</code> \u72b6\u6001\uff0c\u4e14\u70b9\u51fb <code>Restart</code> \u80fd\u6b63\u5e38\u542f\u52a8\u3002</p>","tags":["OpenWrt","DDNS"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/OpenWrt%20DDNS%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8%E5%A4%B1%E8%B4%A5%E9%97%AE%E9%A2%98.html#2","title":"2. \u89e3\u51b3\u65b9\u6cd5","text":"<p>\u5df2\u77e5 bug \uff0c\u53ef\u4ee5\u6dfb\u52a0\u989d\u5916\u542f\u52a8\u811a\u672c\u89e3\u51b3\uff0c\u5728 <code>System -&gt; Startup -&gt; Local Startup</code> \u6dfb\u52a0\uff1a</p> <pre><code>/bin/sleep 30 &amp;&amp; /sbin/service ddns restart &amp;\n</code></pre> <p>\u6dfb\u52a0\u540e\u5982\u56fe\uff1a</p> <p></p>","tags":["OpenWrt","DDNS"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/OpenWrt%20DDNS%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8%E5%A4%B1%E8%B4%A5%E9%97%AE%E9%A2%98.html#3","title":"3. \u53c2\u8003\u8d44\u6599","text":"<p>https://forum.openwrt.org/t/ddns-do-not-start-when-reboot/98374/17</p> <p>https://forum.openwrt.org/t/ddns-do-not-start-when-reboot/98374/2</p> <p>https://forum.openwrt.org/t/ddns-do-not-start-when-reboot/98374/2</p> <p>https://forum.openwrt.org/t/ddns-auto-start-not-working/30866</p>","tags":["OpenWrt","DDNS"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/OpenWrt%E4%BF%AE%E6%94%B9%E9%BB%98%E8%AE%A4Shell%E4%B8%BAbash%E5%B9%B6%E5%BC%80%E5%90%AF%E5%8E%86%E5%8F%B2%E5%91%BD%E4%BB%A4%E6%97%B6%E9%97%B4%E6%88%B3.html","title":"OpenWrt \u4fee\u6539\u9ed8\u8ba4 Shell \u4e3a bash \u5e76\u5f00\u542f\u5386\u53f2\u547d\u4ee4\u65f6\u95f4\u6233","text":"","tags":["OpenWrt","DDNS"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/OpenWrt%E4%BF%AE%E6%94%B9%E9%BB%98%E8%AE%A4Shell%E4%B8%BAbash%E5%B9%B6%E5%BC%80%E5%90%AF%E5%8E%86%E5%8F%B2%E5%91%BD%E4%BB%A4%E6%97%B6%E9%97%B4%E6%88%B3.html#1-bash","title":"1. \u5b89\u88c5\u5e76\u914d\u7f6e bash","text":"<p>\u5b89\u88c5 bash</p> <pre><code>opkg update &amp;&amp; opkg install bash\n</code></pre> <p>\u68c0\u67e5 <code>/etc/shells</code> \u4e2d\u6709 <code>/bin/bash</code> \u540e\uff0c\u4fee\u6539 root \u7528\u6237\u7684 shell \u89e3\u91ca\u5668\uff0c\u7f16\u8f91 <code>/etc/passwd</code> \u6587\u4ef6\uff0c\u4fee\u6539\u7b2c\u4e00\u884c\uff08\u7b2c\u4e00\u884c\u5c31\u662f root \u7528\u6237\uff09\u4e2d\u7684 <code>/bin/ash</code> \uff0c\u6539\u6210 <code>/bin/bash</code> \uff0c\u91cd\u542f\u8def\u7531\u5668\u3002</p>","tags":["OpenWrt","DDNS"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/OpenWrt%E4%BF%AE%E6%94%B9%E9%BB%98%E8%AE%A4Shell%E4%B8%BAbash%E5%B9%B6%E5%BC%80%E5%90%AF%E5%8E%86%E5%8F%B2%E5%91%BD%E4%BB%A4%E6%97%B6%E9%97%B4%E6%88%B3.html#2","title":"2. \u914d\u7f6e\u547d\u4ee4\u65f6\u95f4\u6233\u8bb0\u5f55","text":"<p>\u65b0\u5efa\u914d\u7f6e <code>/etc/profile.d/history.sh</code> \uff1a</p> <pre><code>export PROMPT_COMMAND='history -a'\nexport HISTTIMEFORMAT=\"[ %F %T ] ($USER) || \"\nexport HISTFILESIZE=100000\nexport HISTSIZE=100000\n</code></pre>","tags":["OpenWrt","DDNS"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/OpenWrt%E4%BF%AE%E6%94%B9%E9%BB%98%E8%AE%A4Shell%E4%B8%BAbash%E5%B9%B6%E5%BC%80%E5%90%AF%E5%8E%86%E5%8F%B2%E5%91%BD%E4%BB%A4%E6%97%B6%E9%97%B4%E6%88%B3.html#3","title":"3. \u53c2\u8003\u8d44\u6599","text":"<p>https://hellodk.cn/post/472</p>","tags":["OpenWrt","DDNS"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/OpenWrt%E5%AE%89%E8%A3%85OpenVPN.html","title":"OpenWrt \u5b89\u88c5 OpenVPN","text":"","tags":["OpenWrt","OpenVPN"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/OpenWrt%E5%AE%89%E8%A3%85OpenVPN.html#1","title":"1. \u524d\u8a00","text":"<p>\u5c3d\u7ba1 OpenVPN \u8fd9\u79cd\u5f02\u5730\u7ec4\u7f51\u65b9\u5f0f\u6709\u4e9b\u8bb8\u8fdc\u53e4\uff0c\u4f46\u662f\u8fd8\u662f\u6709\u4f7f\u7528 OpenVPN \u7684\u5fc5\u8981\uff0c\u8b6c\u5982\u8bf4\u5b83\u652f\u6301 TCP \u534f\u8bae\u3002\u56e0\u6b64\u672c\u6587\u4f1a\u5efa\u7acb\u4e00\u4e2a OpenVPN \u670d\u52a1\u5668\uff0c\u524d\u7f6e\u6761\u4ef6\u5982\u4e0b\uff1a</p> <ul> <li>OpenWrt \u6709\u516c\u7f51 IPv6 \uff0c\u4e14\u9ad8\u4f4d TCP \u7aef\u53e3\u53ef\u7a33\u5b9a\u8fde\u63a5\u3002</li> <li>\u79c1\u7f51\u7f51\u6bb5 10.8.1.0/24 \u6ca1\u6709\u88ab\u4f7f\u7528\uff0c\u5c06\u4f1a\u88ab\u4f5c\u4e3a OpenVPN \u79c1\u7f51\u7f51\u6bb5\u3002</li> </ul>","tags":["OpenWrt","OpenVPN"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/OpenWrt%E5%AE%89%E8%A3%85OpenVPN.html#2","title":"2. \u5b89\u88c5\u8f6f\u4ef6\u5305","text":"<p>\u4f7f\u7528 opkg \u5b89\u88c5\u8f6f\u4ef6\uff1a</p> <pre><code># Install packages\nopkg update\nopkg install openvpn-openssl openvpn-easy-rsa\n</code></pre>","tags":["OpenWrt","OpenVPN"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/OpenWrt%E5%AE%89%E8%A3%85OpenVPN.html#3","title":"3. \u8bbe\u7f6e\u73af\u5883\u53d8\u91cf","text":"<p>\u4ee5\u4e0b\u4e3a\u5b89\u88c5\u9700\u8981\u7684\u73af\u5883\u53d8\u91cf\uff1a</p> <pre><code># Configuration parameters\nVPN_DIR=\"/etc/openvpn\"\nVPN_PKI=\"/etc/easy-rsa/pki\"\nVPN_PORT=\"11940\"\nVPN_PROTO=\"tcp6\"\nVPN_POOL=\"10.8.1.0 255.255.255.0\"\nVPN_DNS=\"${VPN_POOL%.* *}.1\"\nVPN_DN=\"$(uci -q get dhcp.@dnsmasq[0].domain)\"\n\n# Fetch server address\nNET_FQDN=\"$(uci -q get ddns.@service[0].lookup_host)\"\n. /lib/functions/network.sh\nnetwork_flush_cache\nnetwork_find_wan NET_IF\nnetwork_get_ipaddr NET_ADDR \"${NET_IF}\"\nif [ -n \"${NET_FQDN}\" ];then\n  VPN_SERV=\"${NET_FQDN}\"\nelse\n  VPN_SERV=\"${NET_ADDR}\"\nfi\n</code></pre> <p>\u5982\u679c\u4e2d\u9014\u9000\u51fa\uff0c\u9700\u8981\u91cd\u65b0\u8bbe\u7f6e\u3002</p>","tags":["OpenWrt","OpenVPN"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/OpenWrt%E5%AE%89%E8%A3%85OpenVPN.html#4-easyrsa","title":"4. \u4f7f\u7528 EasyRSA \u751f\u6210\u5bc6\u94a5","text":"<p>\u4e00\u952e\u4e0b\u8f7d\u5e76\u751f\u6210\u5bc6\u94a5\uff1a</p> <pre><code>cd ~\n# Work around EasyRSA issues\nwget -U \"\" -O /tmp/easyrsa.tar.gz https://github.com/OpenVPN/easy-rsa/releases/download/v3.2.0/EasyRSA-3.2.0.tgz\ntar -z -x -f /tmp/easyrsa.tar.gz\n\n# Configuration parameters\ncat &lt;&lt; EOF &gt; /etc/profile.d/easy-rsa.sh\nexport EASYRSA_PKI=\"${VPN_PKI}\"\nexport EASYRSA_TEMP_DIR=\"/tmp\"\nexport EASYRSA_CERT_EXPIRE=\"3650\"\nexport EASYRSA_BATCH=\"1\"\nalias easyrsa=\"/root/EasyRSA-3.2.0/easyrsa\"\nEOF\n. /etc/profile.d/easy-rsa.sh\n\n# Remove and re-initialize PKI directory\neasyrsa init-pki\n\n# Generate DH parameters\neasyrsa gen-dh\n\n# Create a new CA\neasyrsa build-ca nopass\n\n# Generate server keys and certificate\neasyrsa build-server-full server nopass\nopenvpn --genkey tls-crypt-v2-server ${EASYRSA_PKI}/private/server.pem\n\n# Generate client keys and certificate\neasyrsa build-client-full client nopass\nopenvpn --tls-crypt-v2 ${EASYRSA_PKI}/private/server.pem \\\n--genkey tls-crypt-v2-client ${EASYRSA_PKI}/private/client.pem\n</code></pre>","tags":["OpenWrt","OpenVPN"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/OpenWrt%E5%AE%89%E8%A3%85OpenVPN.html#5-openvpn","title":"5. \u751f\u6210 OpenVPN \u914d\u7f6e\u5e76\u542f\u52a8\u670d\u52a1","text":"<p>\u751f\u6210\u5ba2\u6237\u7aef\u4e0e\u670d\u52a1\u5668\u914d\u7f6e\u6587\u4ef6\uff1a</p> <pre><code># Configure VPN service and generate client profiles\numask go=\nVPN_DH=\"$(cat ${VPN_PKI}/dh.pem)\"\nVPN_CA=\"$(openssl x509 -in ${VPN_PKI}/ca.crt)\"\nls ${VPN_PKI}/issued \\\n| sed -e \"s/\\.\\w*$//\" \\\n| while read -r VPN_ID\ndo\nVPN_TC=\"$(cat ${VPN_PKI}/private/${VPN_ID}.pem)\"\nVPN_KEY=\"$(cat ${VPN_PKI}/private/${VPN_ID}.key)\"\nVPN_CERT=\"$(openssl x509 -in ${VPN_PKI}/issued/${VPN_ID}.crt)\"\nVPN_EKU=\"$(echo \"${VPN_CERT}\" | openssl x509 -noout -purpose)\"\ncase ${VPN_EKU} in\n(*\"SSL server : Yes\"*)\nVPN_CONF=\"${VPN_DIR}/${VPN_ID}.conf\"\ncat &lt;&lt; EOF &gt; ${VPN_CONF} ;;\nuser nobody\ngroup nogroup\ndev tun\nport ${VPN_PORT}\nproto ${VPN_PROTO}\nserver ${VPN_POOL}\ntopology subnet\nclient-to-client\nkeepalive 10 60\npersist-tun\npersist-key\npush \"dhcp-option DNS ${VPN_DNS}\"\npush \"dhcp-option DOMAIN ${VPN_DN}\"\npush \"redirect-gateway def1\"\npush \"persist-tun\"\npush \"persist-key\"\n&lt;dh&gt;\n${VPN_DH}\n&lt;/dh&gt;\nEOF\n(*\"SSL client : Yes\"*)\nVPN_CONF=\"${VPN_DIR}/${VPN_ID}.ovpn\"\ncat &lt;&lt; EOF &gt; ${VPN_CONF} ;;\nuser nobody\ngroup nogroup\ndev tun\nnobind\nclient\nremote ${VPN_SERV} ${VPN_PORT} ${VPN_PROTO}\nauth-nocache\ncomp-lzo yes\nallow-compression yes\nremote-cert-tls server\nEOF\nesac\ncat &lt;&lt; EOF &gt;&gt; ${VPN_CONF}\n&lt;tls-crypt-v2&gt;\n${VPN_TC}\n&lt;/tls-crypt-v2&gt;\n&lt;key&gt;\n${VPN_KEY}\n&lt;/key&gt;\n&lt;cert&gt;\n${VPN_CERT}\n&lt;/cert&gt;\n&lt;ca&gt;\n${VPN_CA}\n&lt;/ca&gt;\nEOF\ndone\nservice openvpn restart\nls ${VPN_DIR}/*.ovpn\n</code></pre> <p>\u751f\u6210\u7684\u5ba2\u6237\u7aef\u914d\u7f6e\u5728 <code>/etc/openvpn/client.ovpn</code> \uff0c\u670d\u52a1\u5668\u914d\u7f6e\u5728 <code>/etc/openvpn/server.conf</code></p>","tags":["OpenWrt","OpenVPN"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/OpenWrt%E5%AE%89%E8%A3%85OpenVPN.html#6","title":"6. \u914d\u7f6e\u9632\u706b\u5899","text":"<p>\u5728 <code>Network -&gt; Firewall -&gt; Traffic Rules</code> \u914d\u7f6e\u9632\u706b\u5899\uff0c\u653e\u884c OpenVPN \u7aef\u53e3\uff1a</p> <p></p> <p>\u5728 <code>Network -&gt; Interfaces</code> \u4e2d\u6dfb\u52a0 <code>tun0</code> \u7f51\u7edc\u63a5\u53e3\uff1a</p> <p></p> <p>\u5c06\u8be5\u7f51\u7edc\u63a5\u53e3\u653e\u5165 <code>vpn</code> \u9632\u706b\u5899\u533a\u57df\uff1a</p> <p></p> <p>\u540c\u65f6\uff0c\u5728 <code>Network -&gt; Firewall -&gt; Zones</code> \u4e2d\uff0c\u8bbe\u7f6e <code>vpn</code> \u533a\u57df\u5bf9\u6240\u6709\u533a\u57df\u53ef\u8f6c\u53d1\uff0c\u5f00\u542f <code>Masquerading</code> \uff0cInput \u3001 Output \u3001 Forward \u5168\u90e8 Accept \uff1a</p> <p></p> <p>\u81f3\u6b64\u4e00\u4e2a\u6700\u57fa\u672c\u7684 OpenVPN \u914d\u7f6e\u5b8c\u6210\u3002</p>","tags":["OpenWrt","OpenVPN"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/OpenWrt%E5%AE%89%E8%A3%85OpenVPN.html#7-luci-app-openvpn","title":"7. luci-app-openvpn \u7684\u914d\u7f6e","text":"<p>\u5982\u679c\u8981\u4f7f\u7528\u56fe\u5f62\u5316\u7ba1\u7406 OpenVPN \uff0c\u9996\u5148\u9700\u8981\u5b89\u88c5 luci-app-openvpn \uff0c\u4e4b\u540e\u6839\u636e <code>/etc/openvpn/server.conf</code> \u8fdb\u884c\u914d\u7f6e\u6587\u4ef6\u8fc1\u79fb\u3002\u9996\u5148\u5148\u5728 <code>/etc/openvpn/server.conf</code> \u4e2d\u63d0\u53d6\u8bc1\u4e66\uff0c\u5e76\u5b58\u653e\u5230\u76f8\u5e94\u4f4d\u7f6e\uff1a</p> <code>server.conf</code> \u4e2d\u8bc1\u4e66 \u5b58\u653e\u5730\u70b9 ca /etc/openvpn/pki/ca.crt dh /etc/openvpn/pki/dh.pem cert /etc/openvpn/pki/server.crt key /etc/openvpn/pki/server.key tls-crypt-v2 /etc/openvpn/pki/server.pem <p>\u4e4b\u540e\u5c06 <code>/etc/openvpn/server.conf</code> \u91cd\u547d\u540d\u4e3a <code>server.conf.bak</code> \uff0c\u5f00\u59cb\u5728 <code>VPN -&gt; OpenVPN</code> \u754c\u9762\u70b9\u51fb <code>Edit</code> \u5bf9\u9ed8\u8ba4\u7684 <code>myvpn</code> \u8fdb\u884c\u914d\u7f6e\uff1a</p> <p></p> <p>\u5b9e\u6d4b\u6700\u7ec8\u7684\u914d\u7f6e\u5982\u4e0b\uff1a</p> <p></p> <p></p> <p></p> <p></p> <p></p>","tags":["OpenWrt","OpenVPN"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/OpenWrt%E5%AE%89%E8%A3%85OpenVPN.html#8","title":"8. \u53c2\u8003\u8d44\u6599","text":"<p>https://openwrt.org/docs/guide-user/services/vpn/openvpn/server</p>","tags":["OpenWrt","OpenVPN"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/OpenWrt%E5%AE%89%E8%A3%85WireGuard.html","title":"OpenWrt \u5b89\u88c5 WireGuard","text":"","tags":["OpenWrt","WireGuard"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/OpenWrt%E5%AE%89%E8%A3%85WireGuard.html#1","title":"1. \u524d\u8a00","text":"<p>\u5f53\u51fa\u95e8\u5728\u5916\u9700\u8981\u8bbf\u95ee\u5bb6\u91cc\u7684\u670d\u52a1\u65f6\uff0c\u603b\u662f\u9700\u8981\u4e00\u79cd\u5f02\u5730\u7ec4\u7f51\u65b9\u6848\u3002\u73b0\u884c\u7684\u5f02\u5730\u7ec4\u7f51\u65b9\u6848\u5927\u81f4\u6709 ZeroTier \u3001 OpenVPN \u548c WireGuard \u4e09\u79cd\uff0c\u5176\u4e2d\u5404\u6709\u4f18\u52a3\u3002 OpenVPN \u7684\u4f18\u52bf\u662f\u4f7f\u7528 TCP \u8fde\u63a5\uff0c\u4e0d\u5bb9\u6613\u50cf\u5269\u4e0b\u4e24\u79cd\u65b9\u6848\u4f3c\u7684\u6709 UDP \u8fde\u63a5\u4e0d\u7a33\u5b9a\u7684\u60c5\u51b5\uff0c\u7f3a\u70b9\u662f\u901f\u5ea6\u6162\u3002\u800c WireGuard \u6b63\u597d\u548c OpenVPN \u76f8\u53cd\uff0c\u901f\u5ea6\u6700\u5feb\uff0c\u4f46\u53ea\u80fd\u4f7f\u7528 UDP \u76f4\u8fde\u3002 ZeroTier \u4ecb\u4e8e\u4e24\u79cd\u4e4b\u95f4\uff08\u5b83\u5728\u8fde\u63a5\u975e\u5e38\u4e0d\u7a33\u5b9a\u65f6\u4f1a\u4f7f\u7528 TCP \u5e76\u8d70\u4e2d\u8f6c\u670d\u52a1\u5668\uff09\u3002</p> <p>\u56e0\u6b64\u672c\u6587\u5728 OpenWrt \u4e0a\u642d\u5efa\u4e00\u4e2a WireGuard \u670d\u52a1\u5668\uff0c\u5176\u4e2d\u9700\u8981\u51c6\u5907\u7684\u6761\u4ef6\u5982\u4e0b\uff1a</p> <ul> <li>OpenWrt \u7cfb\u7edf\u5df2\u5b89\u88c5\u3002</li> <li>\u6709\u516c\u7f51 IPv6 \u3002</li> <li>\u516c\u7f51 IPv6 \u9ad8\u4f4d UDP \u7aef\u53e3\u53ef\u4ee5\u7a33\u5b9a\u8fde\u63a5\u3002</li> <li>\u79c1\u7f51\u7f51\u6bb5 10.8.0.0/24 \u6ca1\u6709\u88ab\u4f7f\u7528\uff0c\u5c06\u4f1a\u88ab\u4f5c\u4e3a WireGuard \u79c1\u7f51\u7f51\u6bb5\u3002</li> </ul>","tags":["OpenWrt","WireGuard"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/OpenWrt%E5%AE%89%E8%A3%85WireGuard.html#2","title":"2. \u5b89\u88c5\u5fc5\u8981\u7684\u8f6f\u4ef6\u5305","text":"<p>\u5b89\u88c5\u4ee5\u4e0b\u8f6f\u4ef6\uff1a</p> <ul> <li>wireguard-tools</li> <li>luci-app-wireguard</li> <li>luci-proto-wireguard</li> <li>qrencode</li> </ul> <p>\u53ef\u4ee5\u53bb <code>System -&gt; Software</code> \u754c\u9762\u5b89\u88c5\uff0c\u6216\u8005\u4f7f\u7528\u547d\u4ee4\u884c\u5b89\u88c5\u3002\u5b89\u88c5\u4ee5\u540e\u8bb0\u5f97\u91cd\u542f\u3002</p>","tags":["OpenWrt","WireGuard"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/OpenWrt%E5%AE%89%E8%A3%85WireGuard.html#3-wireguard","title":"3. \u914d\u7f6e WireGuard \u7f51\u5361","text":"<p>\u5728 <code>Network -&gt; Interfaces</code> \u754c\u9762\uff0c\u70b9\u51fb <code>Add new Interface</code> \uff0c\u6dfb\u52a0\u7c7b\u578b\u4e3a WireGuard \u7684\u7f51\u5361\uff1a</p> <p></p> <p>\u9700\u8981\u70b9\u51fb <code>Generate new key pair</code> \u751f\u6210\u5bc6\u94a5\uff0c\u5176\u4e2d <code>IP Address</code> \u91cc\u5e94\u8be5\u586b\u5199 OpenWrt \u51c6\u5907\u4f7f\u7528\u7684\u79c1\u7f51 IP \u5730\u5740\uff0810.8.0.1/32\uff09\uff0c\u4ee5\u53ca\u6574\u4e2a WireGuard \u7f51\u7edc\u7684\u5730\u5740\uff0810.8.0.0/24\uff09\uff1a</p> <p></p> <p>\u5728 <code>Firewall Settings</code> \u91cc\uff0c\u65b0\u5efa\u9632\u706b\u5899\u533a\u57df <code>vpn</code> \u5e76\u5c06\u5176\u52a0\u5165\u8be5\u533a\u57df\uff1a</p> <p></p> <p>\u5728 <code>Peers</code> \u91cc\uff0c\u8bbe\u7f6e\u9700\u8981\u8fde\u63a5\u5230\u6b64 WireGuard \u670d\u52a1\u5668\u7684\u5ba2\u6237\u7aef\uff0c\u70b9\u51fb <code>Add peer</code> \u6dfb\u52a0\u5ba2\u6237\u7aef\uff1a</p> <p></p> <p>\u540c\u6837\u9700\u8981\u70b9\u51fb <code>Generate new key pair</code> \u548c <code>Generate preshared key</code> \u6765\u751f\u6210 2 \u4e2a\u5bc6\u94a5\uff0c\u52fe\u9009 <code>Route Allowed IPs</code> \u5e76\u5728 <code>Allowed IPs</code> \u4e2d\u586b\u5165\u5ba2\u6237\u7aef\u5728 WireGuard \u79c1\u7f51\u7684 IP \u5730\u5740\uff0810.8.0.2/32\uff09\uff0c <code>Persistens Keep Alive</code> \u586b\u5199\u5efa\u8bae\u503c <code>25</code> \uff0c\u4e4b\u540e\u70b9\u51fb <code>Generate configuration</code> \u83b7\u53d6\u5ba2\u6237\u7aef\u8fde\u63a5\u914d\u7f6e\uff1a</p> <p></p> <p>\u4e4b\u540e\u4fdd\u5b58\u6240\u6709\u8bbe\u7f6e\uff0c\u5e76\u91cd\u542f WireGuard \u7f51\u5361\uff08\u6bcf\u6b21\u4fee\u6539\u540e\u90fd\u9700\u8981\u91cd\u542f\u7f51\u5361\u751f\u6548\uff09\u3002</p>","tags":["OpenWrt","WireGuard"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/OpenWrt%E5%AE%89%E8%A3%85WireGuard.html#4-wireguard","title":"4. \u67e5\u770b WireGuard \u914d\u7f6e","text":"<p>\u5728 <code>Status -&gt; WireGuard</code> \u4e2d\u53ef\u4ee5\u67e5\u770b WireGuard \u6240\u6709\u5ba2\u6237\u7aef\u7684\u4fe1\u606f\uff1a</p> <p></p>","tags":["OpenWrt","WireGuard"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/OpenWrt%E5%AE%89%E8%A3%85WireGuard.html#5","title":"5. \u914d\u7f6e\u9632\u706b\u5899","text":"<p>\u5728 <code>Network -&gt; Firewall -&gt; Traffic Rules</code> \u4e2d\uff0c\u6dfb\u52a0\u9632\u706b\u5899\u89c4\u5219\uff0c\u653e\u884c WireGuard \u7684\u7aef\u53e3\uff1a</p> <p></p> <p>\u540c\u65f6\uff0c\u5728 <code>Network -&gt; Firewall -&gt; Zones</code> \u4e2d\uff0c\u8bbe\u7f6e <code>vpn</code> \u533a\u57df\u5bf9\u6240\u6709\u533a\u57df\u53ef\u8f6c\u53d1\uff0c\u5f00\u542f <code>Masquerading</code> \uff0cInput \u3001 Output \u3001 Forward \u5168\u90e8 Accept \uff1a</p> <p></p>","tags":["OpenWrt","WireGuard"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/OpenWrt%E5%AE%89%E8%A3%85WireGuard.html#6","title":"6. \u4f7f\u7528\u5ba2\u6237\u7aef\u6d4b\u8bd5","text":"<p>\u79fb\u52a8\u7aef\u4f7f\u7528\u4e8c\u7ef4\u7801\uff0c\u684c\u9762\u7aef\u76f4\u63a5\u590d\u5236\u914d\u7f6e\u6587\u4ef6\u5bfc\u5165\uff0c\u8fdb\u884c\u6d4b\u8bd5\u3002</p>","tags":["OpenWrt","WireGuard"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/OpenWrt%E5%AE%89%E8%A3%85WireGuard.html#7","title":"7. \u53c2\u8003\u8d44\u6599","text":"<p>https://upsangel.com/security/vpn/%E4%B8%80%E9%8D%B5%E9%80%A3%E5%9B%9E%E5%AE%B6%E9%87%8C%E5%85%A7%E7%B6%B2%EF%BC%9Aopenwrt%E4%B8%8A%E9%83%A8%E7%BD%B2wireguard-vpn%E6%9C%8D%E5%8B%99%E5%99%A8%E7%9A%84%E4%B8%89%E5%80%8B%E8%A6%81%E9%BB%9E/</p> <p>https://whatgui.github.io/2020/02/08/%E3%80%8C%E6%8D%AF%E9%A5%AC%E8%AE%B0%E5%BD%95%E3%80%8D%E5%9C%A8OpenWrt%E4%B8%8A%E9%85%8D%E7%BD%AE%E4%B8%80%E4%B8%8Bwireguard%E6%9C%8D%E5%8A%A1%E7%AB%AF/</p>","tags":["OpenWrt","WireGuard"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/%E5%8C%97%E4%BA%AC%E8%81%94%E9%80%9A%E4%B8%AD%E5%85%B4F4610U%E5%85%89%E7%8C%AB%E5%BC%80%E8%B6%85%E7%AE%A1%E7%95%8C%E9%9D%A2.html","title":"\u5317\u4eac\u8054\u901a\u4e2d\u5174 F4610U \u5149\u732b\u5f00\u8d85\u7ba1\u754c\u9762","text":"","tags":["F4610U","\u5149\u732b\u7834\u89e3","\u5bbd\u5e26"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/%E5%8C%97%E4%BA%AC%E8%81%94%E9%80%9A%E4%B8%AD%E5%85%B4F4610U%E5%85%89%E7%8C%AB%E5%BC%80%E8%B6%85%E7%AE%A1%E7%95%8C%E9%9D%A2.html#1","title":"1. \u964d\u7ea7\u56fa\u4ef6","text":"<p>\u4ece\u6069\u5c71\u8bba\u575b\u5317\u4eac\u8054\u901a\u5149\u732b\u56fa\u4ef6\u4e2d\u5174 4610U_V1.2.0P1N20/N16 \u56fa\u4ef6\u5347\u964d\u7ea7\u53ca\u53c2\u6570\u4fee\u6539\u6559\u7a0b\u4e0b\u8f7d\u56fa\u4ef6\uff0c\u4f7f\u7528\u666e\u901a\u8d26\u53f7\u548c\u5bc6\u7801\u767b\u5f55 http://192.168.1.1 \uff0c\u518d\u6d4f\u89c8\u5668\u590d\u5236\u7c98\u8d34\u8fd9\u4e2a\u5730\u5740\uff1a</p> <pre><code>http://192.168.1.1/getpage.gch?pid=1001&amp;hidden=upgrade\n</code></pre> <p>\u8fdb\u5165 <code>\u8bbe\u5907\u7ba1\u7406</code>-&gt;<code>\u8bbe\u5907\u7ba1\u7406</code>-&gt;<code>\u7248\u672c\u5347\u7ea7</code>\u3002</p> <p>\u5148\u4e0a\u4f20 <code>F4610U_V1.2.0P1N20_upgrade.bin</code> \u6587\u4ef6\u8fdb\u884c\u5347\u7ea7\uff0c\u5347\u7ea7\u540e\u5149\u732b\u4f1a\u91cd\u542f\uff0c\u7b49\u5f85\u5149\u732b\u91cd\u542f\u5b8c\u6bd5\uff0c\u518d\u4e0a\u4f20 <code>F4610U_V1.2.0P1N16_upgrade.bin</code> \u6587\u4ef6\u8fdb\u884c\u964d\u7ea7\u3002\u964d\u7ea7\u5b8c\u6210\u540e\uff0c\u8fdb\u5165 <code>\u72b6\u6001</code> -&gt; <code>\u8bbe\u5907\u4fe1\u606f</code> \uff0c\u68c0\u67e5 <code>\u8f6f\u4ef6\u7248\u672c\u53f7</code> \u4e3a <code>V1.2.0P1T1</code> \u5219\u964d\u7ea7\u6210\u529f\u3002</p>","tags":["F4610U","\u5149\u732b\u7834\u89e3","\u5bbd\u5e26"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/%E5%8C%97%E4%BA%AC%E8%81%94%E9%80%9A%E4%B8%AD%E5%85%B4F4610U%E5%85%89%E7%8C%AB%E5%BC%80%E8%B6%85%E7%AE%A1%E7%95%8C%E9%9D%A2.html#2-telnet","title":"2. \u5f00\u542f telnet","text":"<p>\u5f00\u542f Telnet \u524d\uff0c\u9700\u8981\u5148\u62d4\u6389\u5149\u732b\u7684\u5149\u7ea4\uff0c\u4e4b\u540e\u7528\u7259\u7b7e\u6345 Reset \u6309\u94ae\uff0c\u4e4b\u540e\u4f7f\u7528 zte_modem_tools \u5f00\u6e90\u9879\u76ee\uff1a</p> <pre><code>python .\\zte_factroymode.py telnet\n</code></pre> <p>\u5982\u679c\u62a5\u9519\u53ef\u91cd\u8bd5\uff0c\u91cd\u8bd5\u5931\u8d25\u53ef\u5c1d\u8bd5\u518d\u6b21\u62d4\u6389\u5149\u7ea4\u7528\u7259\u7b7e\u6345 Reset \u6309\u94ae\uff0c\u6210\u529f\u5b9e\u4f8b\u8f93\u51fa\u5982\u4e0b\uff1a</p> <pre><code>PS C:\\Users\\hxp\\Downloads\\zte_modem_tools-main&gt; python .\\zte_factroymode.py telnet\ntrying  user:\"factorymode\" pass:\"nE%jA@5b\"\nreset facTelnetSteps:\nreset OK!\n\nfacStep 1:\nOK!\n\nfacStep 2:\nOK!\n\nfacStep 3:\nOK!\n\nfacStep 4:\nOK!\n\nb'FactoryMode.gch\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\xd6`\\xd0[1F\\xb9\\x87\\x8f\\xb5p/P\\xd0\\xab\\x17'\nfacStep 5:\nOK!\n\nb'FactoryModeAuth.gch?user=H5nb40xW&amp;pass=T******3\\x00'\ndone\n</code></pre> <p>\u8fd9\u4e00\u6b65\u4f1a\u751f\u6210\u968f\u673a\u7528\u6237\u540d\u548c\u5bc6\u7801\uff08\u6b64\u7528\u6237\u540d\u4e3a <code>H5nb40xW</code> \u5bc6\u7801\u4e3a <code>T******3</code>\uff09\uff0c\u7528 Telnet \u8fdb\u884c\u8fde\u63a5\uff1a</p> <pre><code>F4610U\n\nLogin: H5nb40xW\nPassword:\n\nBusyBox v1.17.2 (2022-10-20 22:55:06 CST) built-in shell (ash)\nEnter 'help' for a list of built-in commands.\n\n/ #\n</code></pre> <p>\u5982\u679c\u9700\u8981\u5f00\u6c38\u4e45 telnet\uff08\u5bc6\u7801 Zte521\uff09\uff0c\u8fd0\u884c\uff1a</p> <pre><code>sendcmd 1 DB p TelnetCfg\nsendcmd 1 DB set TelnetCfg 0 Lan_Enable 1\nsendcmd 1 DB set TelnetCfg 0 TS_UName root\nsendcmd 1 DB set TelnetCfg 0 TSLan_UName root\nsendcmd 1 DB set TelnetCfg 0 TS_UPwd Zte521\nsendcmd 1 DB set TelnetCfg 0 TSLan_UPwd Zte521\nsendcmd 1 DB set TelnetCfg 0 Max_Con_Num 99\nsendcmd 1 DB set TelnetCfg 0 ExitTime 999999\nsendcmd 1 DB set TelnetCfg 0 InitSecLvl 3\nsendcmd 1 DB set TelnetCfg 0 CloseServerTime 9999999\nsendcmd 1 DB set TelnetCfg 0 Lan_EnableAfterOlt 1\nsendcmd 1 DB save\nkillall telnetd\n</code></pre>","tags":["F4610U","\u5149\u732b\u7834\u89e3","\u5bbd\u5e26"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/%E5%8C%97%E4%BA%AC%E8%81%94%E9%80%9A%E4%B8%AD%E5%85%B4F4610U%E5%85%89%E7%8C%AB%E5%BC%80%E8%B6%85%E7%AE%A1%E7%95%8C%E9%9D%A2.html#3","title":"3. \u4fee\u6539\u533a\u57df","text":"<p>\u5148\u67e5\u770b\u533a\u57df\u4ee3\u7801\uff1a</p> <pre><code>cat /etc/init.d/regioncode\n</code></pre> <p>\u8bbe\u5b9a\u533a\u57df\u4e3a\u6cb3\u5317\u7701\uff1a</p> <pre><code>upgradetest sdefconf 322\n</code></pre> <p>\u6210\u529f\u540e\u5149\u732b\u8f93\u51fa success \u5e76\u81ea\u52a8\u91cd\u542f\uff1a</p> <pre><code>&lt;a00002a025&gt;11930:43:45 [U_upgradetest][Crit] [upgrade_test.c(126)main] LOG_SEC: Upgradetest sdefconf!\n&lt;a00002a025&gt;11930:43:45 [U_upgradetest][Crit] [pon_upgrade_cma(480)CmDelCfgFile] LOG_SEC: Delete cfg file!\nsuccess!\n</code></pre>","tags":["F4610U","\u5149\u732b\u7834\u89e3","\u5bbd\u5e26"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/%E5%8C%97%E4%BA%AC%E8%81%94%E9%80%9A%E4%B8%AD%E5%85%B4F4610U%E5%85%89%E7%8C%AB%E5%BC%80%E8%B6%85%E7%AE%A1%E7%95%8C%E9%9D%A2.html#4","title":"4. \u4f7f\u7528\u8d85\u7ea7\u7ba1\u7406\u5458\u767b\u5f55","text":"<p>\u7b49\u5149\u732b\u91cd\u542f\u540e\uff0c\u8bbf\u95ee http://192.168.1.1/cu.html \uff0c\u4f7f\u7528 <code>cuadmin</code> \u8d26\u53f7\u767b\u5f55\u8d85\u7ea7\u7ba1\u7406\u5458\u3002</p>","tags":["F4610U","\u5149\u732b\u7834\u89e3","\u5bbd\u5e26"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/%E5%8C%97%E4%BA%AC%E8%81%94%E9%80%9A%E4%B8%AD%E5%85%B4F4610U%E5%85%89%E7%8C%AB%E5%BC%80%E8%B6%85%E7%AE%A1%E7%95%8C%E9%9D%A2.html#5","title":"5. \u4fee\u6539\u4e3a\u6865\u63a5\u6a21\u5f0f","text":"<p>\u767b\u5f55\u8d85\u7ea7\u7ba1\u7406\u5458\u754c\u9762\u540e\uff0c\u8fdb\u5165 <code>\u57fa\u672c\u914d\u7f6e</code> -&gt; <code>WAN\u8fde\u63a5</code> \uff0c\u4f7f\u7528\u5982\u4e0b\u914d\u7f6e\u65b0\u5efa\u7f51\u7edc\u8fde\u63a5\uff1a</p> <ul> <li>\u8fde\u63a5\u540d\u79f0\uff1a\u65b0\u5efa WAN \u8fde\u63a5</li> <li>\u8fde\u63a5\u6a21\u5f0f\uff1a\u6865\u63a5</li> <li>VLAN \u6a21\u5f0f\uff1a\u6539\u5199(tag)</li> <li>VLAN ID\uff1a3961</li> <li>802.1p\uff1a0</li> <li>\u4f7f\u80fd DSCP\uff1a\u5426</li> <li>DHCP \u670d\u52a1\u4f7f\u80fd\uff1a\u5426</li> </ul> <p>\u4e4b\u540e\u901a\u8fc7 OpenWrt \u4f7f\u7528\u5bbd\u5e26\u8d26\u53f7\u5bc6\u7801\u62e8\u53f7\u3002</p>","tags":["F4610U","\u5149\u732b\u7834\u89e3","\u5bbd\u5e26"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/%E5%8C%97%E4%BA%AC%E8%81%94%E9%80%9A%E4%B8%AD%E5%85%B4F4610U%E5%85%89%E7%8C%AB%E5%BC%80%E8%B6%85%E7%AE%A1%E7%95%8C%E9%9D%A2.html#6","title":"6. \u53c2\u8003\u8d44\u6599","text":"<p>https://www.bilibili.com/video/BV1W94y1t7cW/?vd_source=d266dd531d25724f221c1d5d3c3d2438</p> <p>https://www.right.com.cn/forum/thread-8389711-1-1.html</p> <p>https://www.right.com.cn/forum/thread-8389176-1-1.html</p> <p>https://www.right.com.cn/forum/thread-8361606-1-1.html</p>","tags":["F4610U","\u5149\u732b\u7834\u89e3","\u5bbd\u5e26"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/%E5%B0%8F%E7%B1%B3AX9000%E5%88%B7%E6%9C%BA.html","title":"\u5c0f\u7c73 AX9000 \u5237\u673a","text":"","tags":["OpenWrt","AX9000"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/%E5%B0%8F%E7%B1%B3AX9000%E5%88%B7%E6%9C%BA.html#1-rootfs","title":"1. \u786e\u4fdd\u5c0f\u7c73\u56fa\u4ef6\u5728\u5206\u533a rootfs \u91cc","text":"<p>SSH \u767b\u5f55\u5c0f\u7c73\u8def\u7531\u5668\uff0c\u8bbe\u7f6e env \u4fdd\u8bc1\u5c0f\u7c73\u56fa\u4ef6\u5728\u5206\u533a rootfs \u91cc\uff0c\u4e3a\u4e0b\u4e00\u90e8\u628a qsdk \u5237\u5230 rootfs_1 \u505a\u51c6\u5907\uff1a</p> <pre><code>nvram set flag_last_success=0\nnvram set flag_boot_rootfs=0\nnvram set flag_try_sys1_failed=0\nnvram set flag_try_sys2_failed=0\nnvram commit\n</code></pre> <p>\u91cd\u542f\u8def\u7531\u5668\uff1a</p> <pre><code>reboot\n</code></pre>","tags":["OpenWrt","AX9000"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/%E5%B0%8F%E7%B1%B3AX9000%E5%88%B7%E6%9C%BA.html#2","title":"2. \u5237\u5199\u56fa\u4ef6","text":"<p>\u5237\u673a\u56fa\u4ef6\u4e3akiddin9 \u56fa\u4ef6\uff0c scp \u628a\u56fa\u4ef6 kwrt-09.29.2024-ipq807x-generic-xiaomi_ax9000-squashfs-factory.ubi \u4f20\u5230\u8def\u7531\u5668 tmp \u76ee\u5f55\uff0cssh \u547d\u4ee4\u6253\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>. /lib/upgrade/platform.sh\nswitch_layout linux\nubiformat /dev/mtd22 -y -f /tmp/kwrt-09.29.2024-ipq807x-generic-xiaomi_ax9000-squashfs-factory.ubi\nnvram set flag_last_success=1\nnvram set flag_boot_rootfs=1\nnvram commit\n</code></pre> <p>\u91cd\u542f\u8def\u7531\u5668\uff1a</p> <pre><code>reboot\n</code></pre>","tags":["OpenWrt","AX9000"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/%E5%B0%8F%E7%B1%B3AX9000%E5%88%B7%E6%9C%BA.html#3","title":"3. \u53c2\u8003\u8d44\u6599","text":"<p>https://www.right.com.cn/forum/thread-5657691-1-1.html</p> <p>https://www.right.com.cn/forum/thread-4875974-1-1.html</p> <p>https://www.right.com.cn/forum/thread-8234200-1-1.html</p> <p>https://mudew.com/2022/11/23/%E5%B0%8F%E7%B1%B3AX9000%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/</p>","tags":["OpenWrt","AX9000"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/%E5%B0%8F%E7%B1%B3AX9000%E5%8A%A0%E5%85%A5160MHz%E6%94%AF%E6%8C%81.html","title":"\u5c0f\u7c73 AX9000 \u52a0\u5165 160MHz \u652f\u6301","text":"<p>\u5907\u4efd\u51c6\u5907\u66ff\u6362\u7684\u9a71\u52a8</p> <pre><code>cd /lib/firmware/ath11k/QCN9074/hw1.0 &amp;&amp; mv ./board-2.bin ./board-2.bin.bak\n</code></pre> <p>\u5c06 generic-ax9000.tar.gz \u62f7\u8d1d\u5230 root \u6839\u76ee\u5f55</p> <pre><code>mv generic-ax9000.tar.gz /\n</code></pre> <p>\u8fdb\u5165\u6839\u76ee\u5f55\u6267\u884c\u89e3\u538b\u547d\u4ee4</p> <pre><code>cd / &amp;&amp; tar -xzvf generic-ax9000.tar.gz\n</code></pre> <p>\u91cd\u542f\u8def\u7531\u5668\uff0c\u8bbe\u7f6e 160MHZ WIFI \u4fe1\u9053\uff0c36,40,44,48,52,56,60 \u5176\u4e2d\u9009\u4e00\u4e2a</p>","tags":["OpenWrt","AX9000"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/%E5%B0%8F%E7%B1%B3AX9000%E5%8A%A0%E5%85%A5160MHz%E6%94%AF%E6%8C%81.html#1","title":"1. \u53c2\u8003\u8d44\u6599","text":"<p>https://github.com/robimarko/openwrt/issues/84</p> <p>https://forum.openwrt.org/t/openwrt-support-for-xiaomi-ax9000/98908/976</p> <p>https://openwrt.org/toh/xiaomi/ax9000#potential_issueslimitations</p> <p>https://www.right.com.cn/forum/thread-8354210-1-1.html</p> <p>https://www.right.com.cn/forum/thread-8342494-1-1.html</p>","tags":["OpenWrt","AX9000"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/%E5%B0%8F%E7%B1%B3AX9000%E8%A7%A3%E9%94%81SSH.html","title":"\u5c0f\u7c73 AX9000 \u89e3\u9501 SSH","text":"","tags":["OpenWrt","AX9000"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/%E5%B0%8F%E7%B1%B3AX9000%E8%A7%A3%E9%94%81SSH.html#1","title":"1. \u5237\u5165\u5c0f\u7c73\u5f00\u53d1\u7248\u56fa\u4ef6","text":"<p>\u4e0b\u8f7d\u5c0f\u7c73\u8def\u7531\u5668\u4fee\u590d\u5de5\u5177\u548c\u5c0f\u7c73\u8def\u7531\u5668\u5f00\u53d1\u7248\u56fa\u4ef6 1.0.140\uff0c\u8fdb\u884c\u5237\u673a\u3002\u4e0b\u8f7d\u5730\u5740\u4e5f\u53ef\u5728\u5c0f\u7c73\u8def\u7531\u5668\u5b98\u7f51\u4e0b\u8f7d\u3002</p>","tags":["OpenWrt","AX9000"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/%E5%B0%8F%E7%B1%B3AX9000%E8%A7%A3%E9%94%81SSH.html#2-docker","title":"2. \u5b89\u88c5 docker","text":"<p>\u51c6\u5907\u4e00\u4e2a\u683c\u5f0f\u5316\u6210 ext4 \u683c\u5f0f\u4e14\u5927\u4e8e 64GB \u7684 U \u76d8\uff0c\u63d2\u5165 AX9000\uff0c\u767b\u5f55\u5c0f\u7c73\u8def\u7531\u5668\u540e\u53f0\u5b89\u88c5 docker \u540e\u5b89\u88c5\u7ba1\u7406\u63d2\u4ef6\u3002</p>","tags":["OpenWrt","AX9000"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/%E5%B0%8F%E7%B1%B3AX9000%E8%A7%A3%E9%94%81SSH.html#3-busybox","title":"3. \u542f\u52a8 busybox \u5bb9\u5668","text":"<p>\u4f7f\u7528\u5b89\u88c5\u597d\u7684 docker \u542f\u52a8 busybox \u5bb9\u5668\uff1a</p> <ul> <li>Image: docker.io/busybox</li> <li>Console: Interactive &amp; TTY</li> <li>Advanced container settings:<ul> <li>Volumes:<ul> <li>container: /mnt, Bind</li> <li>host: /, Writable</li> </ul> </li> </ul> </li> </ul> <p>\u4e4b\u540e\u8fd4\u56de\u5bb9\u5668\u5217\u8868\uff0c\u70b9\u51fb busybox \u5bb9\u5668\u540e\u56de\u5f62\u9488\u56fe\u6807\uff0c\u8fdb\u5165\u5bb9\u5668\u3002</p>","tags":["OpenWrt","AX9000"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/%E5%B0%8F%E7%B1%B3AX9000%E8%A7%A3%E9%94%81SSH.html#4-chroot-ax9000-ssh","title":"4. chroot \u5230 AX9000 \u5e76\u83b7\u53d6 SSH","text":"<p>\u5728\u5bb9\u5668\u5185\u6267\u884c\uff1a</p> <pre><code>chroot /mnt\nvi /etc/init.d/dropbear\n</code></pre> <p>\u7f16\u8f91 <code>/etc/init.d/dropbear</code> \u6ce8\u91ca\u4ee5\u4e0b\u51e0\u884c\uff1a</p> <pre><code>start_service()\n{\n        # \u7a33\u5b9a\u7248\u4e0d\u80fd\u6253\u5f00ssh\u670d\u52a1\n        #flg_ssh=`nvram get ssh_en`\n        #channel=`/sbin/uci get /usr/share/xiaoqiang/xiaoqiang_version.version.CHANNEL`\n        #if [ \"$flg_ssh\" != \"1\" -o \"$channel\" = \"release\" ]; then\n        #       return 0\n        #fi\n\n        [ -s /etc/dropbear/dropbear_rsa_host_key ] || keygen\n\n        . /lib/functions.sh\n        . /lib/functions/network.sh\n\n        config_load \"${NAME}\"\n        config_foreach dropbear_instance dropbear\n}\n</code></pre> <p>\u542f\u52a8 SSH \u670d\u52a1\uff1a</p> <pre><code>/etc/init.d/dropbear start\n</code></pre> <p>\u4fee\u6539 root \u5bc6\u7801\uff1a</p> <pre><code>passwd root\n</code></pre>","tags":["OpenWrt","AX9000"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/%E5%B0%8F%E7%B1%B3AX9000%E8%A7%A3%E9%94%81SSH.html#5-ssh","title":"5. \u56fa\u5316 SSH","text":"<p>\u5982\u679c\u60f3\u8ba9\u5347\u7ea7\u540e\u4f9d\u65e7\u4fdd\u7559 SSH \u6743\u9650\uff0c\u9700\u8981\u56fa\u5316\uff0c\u56fa\u5316\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2a\u5de5\u5177\u5373\u53ef\uff1ahttps://github.com/paldier/ax3600_tool</p> <p>\u6ce8\u610f AX9000 \u7684 bdata \u5206\u533a\u662f mtd18</p> <pre><code>root@XiaoQiang:~# cat /proc/mtd\ndev: size erasesize name\nmtd0: 00100000 00020000 \"0:SBL1\"\nmtd1: 00100000 00020000 \"0:MIBIB\"\nmtd2: 00080000 00020000 \"0:BOOTCONFIG\"\nmtd3: 00080000 00020000 \"0:BOOTCONFIG1\"\nmtd4: 00300000 00020000 \"0:QSEE\"\nmtd5: 00300000 00020000 \"0:QSEE_1\"\nmtd6: 00080000 00020000 \"0:DEVCFG\"\nmtd7: 00080000 00020000 \"0:DEVCFG_1\"\nmtd8: 00080000 00020000 \"0:APDP\"\nmtd9: 00080000 00020000 \"0:APDP_1\"\nmtd10: 00080000 00020000 \"0:RPM\"\nmtd11: 00080000 00020000 \"0:RPM_1\"\nmtd12: 00080000 00020000 \"0:CDT\"\nmtd13: 00080000 00020000 \"0:CDT_1\"\nmtd14: 00080000 00020000 \"0:APPSBLENV\"\nmtd15: 00100000 00020000 \"0:APPSBL_1\"\nmtd16: 00100000 00020000 \"0:APPSBL\"\nmtd17: 00080000 00020000 \"0:ART\"\nmtd18: 00080000 00020000 \"bdata\"\nmtd19: 00080000 00020000 \"crash\"\nmtd20: 00080000 00020000 \"crash_syslog\"\nmtd21: 03800000 00020000 \"rootfs\"\nmtd22: 03800000 00020000 \"rootfs_1\"\nmtd23: 00100000 00020000 \"cfg_bak\"\nmtd24: 03d80000 00020000 \"overlay\"\nmtd25: 04000000 00020000 \"mifw_bak\"\nmtd26: 005ef000 0001f000 \"kernel\"\nmtd27: 02283000 0001f000 \"ubi_rootfs\"\nmtd28: 0087a000 0001f000 \"rootfs_data\"\nmtd29: 03013000 0001f000 \"data\"\n</code></pre> <p>\u6240\u4ee5\u5907\u4efd\u547d\u4ee4\u662f\uff1a</p> <pre><code>nanddump -f /tmp/bdata_mtd18.img /dev/mtd18\n</code></pre>","tags":["OpenWrt","AX9000"]},{"location":"%E6%8A%98%E8%85%BELinux/OpenWrt/%E5%B0%8F%E7%B1%B3AX9000%E8%A7%A3%E9%94%81SSH.html#6","title":"6. \u53c2\u8003\u8d44\u6599","text":"<p>https://blog.nanpuyue.com/2022/056.html</p>","tags":["OpenWrt","AX9000"]},{"location":"%E6%8A%98%E8%85%BELinux/RHEL6/%E8%AE%B0%E6%9F%90%E6%AC%A1%E8%AF%AF%E6%93%8D%E4%BD%9Cyum%20update%E5%90%8Ejboss%E5%BA%94%E7%94%A8%E6%97%A0%E6%B3%95%E5%90%AF%E5%8A%A8%E5%8F%8A%E9%87%8D%E5%90%AF%E6%97%A0%E6%B3%95%E8%AF%86%E5%88%ABvg%E9%97%AE%E9%A2%98.html","title":"\u8bb0\u67d0\u6b21\u8bef\u64cd\u4f5c yum update \u540e jboss \u5e94\u7528\u65e0\u6cd5\u542f\u52a8\u53ca\u91cd\u542f\u65e0\u6cd5\u8bc6\u522b vg \u95ee\u9898","text":"","tags":["RHEL6","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/RHEL6/%E8%AE%B0%E6%9F%90%E6%AC%A1%E8%AF%AF%E6%93%8D%E4%BD%9Cyum%20update%E5%90%8Ejboss%E5%BA%94%E7%94%A8%E6%97%A0%E6%B3%95%E5%90%AF%E5%8A%A8%E5%8F%8A%E9%87%8D%E5%90%AF%E6%97%A0%E6%B3%95%E8%AF%86%E5%88%ABvg%E9%97%AE%E9%A2%98.html#1","title":"1. \u95ee\u9898\u63cf\u8ff0","text":"<p>\u5728\u4e00\u6b21\u5f00\u542f kdump \u7684\u64cd\u4f5c\u4e2d\uff0c\u56e0\u4e3a\u8bef\u64cd\u4f5c\u5bfc\u81f4\u6267\u884c\u4e86 <code>yum update -y</code> \uff0c\u5373\u4f7f\u5728\u4e2d\u9014\u88ab\u53d1\u73b0\u540e\u6309 Ctrl-C \u9000\u51fa\uff0c\u4f46\u662f\u8fd8\u662f\u6709\u90e8\u5206\u8f6f\u4ef6\u5305\u88ab\u5347\u7ea7\u3002\u8bef\u64cd\u4f5c\u5f53\u65f6\uff0c\u5185\u6838\u548c java \u7b49\u7ec4\u4ef6\u88ab\u5347\u7ea7\uff0c\u4e14\u5f53\u665a\u8fdb\u884c\u4e86\u4fee\u6539 grub \u7684\u64cd\u4f5c\u4f7f\u5f97\u91cd\u542f\u540e\u4f9d\u65e7\u8fdb\u5165\u65e7\u5185\u6838\u3002</p> <p>\u4f46\u662f\u540e\u7eed\u53d1\u73b0 jboss \u5728\u91cd\u542f\u540e\uff0cjboss \u80fd\u542f\u52a8\u4f46\u662f jboss \u7684\u5e94\u7528\u65e0\u6cd5\u542f\u52a8\uff0c\u62a5\u9519\u4e3a\u56fd\u5bc6\u8bc1\u4e66\u65e0\u6cd5\u52a0\u8f7d\u3002\u4e14\u5728\u91cd\u542f\u540e\u62a5\u9519\u627e\u4e0d\u5230\u903b\u8f91\u5377\u3002</p>","tags":["RHEL6","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/RHEL6/%E8%AE%B0%E6%9F%90%E6%AC%A1%E8%AF%AF%E6%93%8D%E4%BD%9Cyum%20update%E5%90%8Ejboss%E5%BA%94%E7%94%A8%E6%97%A0%E6%B3%95%E5%90%AF%E5%8A%A8%E5%8F%8A%E9%87%8D%E5%90%AF%E6%97%A0%E6%B3%95%E8%AF%86%E5%88%ABvg%E9%97%AE%E9%A2%98.html#2","title":"2. \u95ee\u9898\u89e3\u51b3\u8fc7\u7a0b","text":"","tags":["RHEL6","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/RHEL6/%E8%AE%B0%E6%9F%90%E6%AC%A1%E8%AF%AF%E6%93%8D%E4%BD%9Cyum%20update%E5%90%8Ejboss%E5%BA%94%E7%94%A8%E6%97%A0%E6%B3%95%E5%90%AF%E5%8A%A8%E5%8F%8A%E9%87%8D%E5%90%AF%E6%97%A0%E6%B3%95%E8%AF%86%E5%88%ABvg%E9%97%AE%E9%A2%98.html#21-jboss","title":"2.1 jboss \u5e94\u7528\u65e0\u6cd5\u542f\u52a8","text":"<p>\u7ecf\u8fc7\u548c\u6b63\u5e38\u8282\u70b9\u7684\u5bf9\u6bd4\uff0cjboss \u65e0\u6cd5\u542f\u52a8\u53ef\u80fd\u662f\u7531\u4e8e java \u88ab\u5347\u7ea7\u5bfc\u81f4\uff0c\u8fdb\u884c\u4e86 java \u7684\u964d\u7ea7\uff08\u964d\u7ea7\u9700\u8981\u5c06\u7cfb\u7edf\u7684 YUM \u6e90\u4fee\u6539\u5230 RHEL6.4 \u7684 YUM \u6e90\uff09\uff1a</p> <pre><code>yum install java-1.7.0-openjdk-1.7.0.9-2.3.4.1.el6_3\nyum reinstall java-1.7.0-openjdk-1.7.0.9-2.3.4.1.el6_3\n</code></pre> <p>\u7ecf\u8fc7 java \u7684\u964d\u7ea7\u540e\uff0cjboss \u5e94\u7528\u65e0\u6cd5\u542f\u52a8\u95ee\u9898\u88ab\u89e3\u51b3\u3002</p>","tags":["RHEL6","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/RHEL6/%E8%AE%B0%E6%9F%90%E6%AC%A1%E8%AF%AF%E6%93%8D%E4%BD%9Cyum%20update%E5%90%8Ejboss%E5%BA%94%E7%94%A8%E6%97%A0%E6%B3%95%E5%90%AF%E5%8A%A8%E5%8F%8A%E9%87%8D%E5%90%AF%E6%97%A0%E6%B3%95%E8%AF%86%E5%88%ABvg%E9%97%AE%E9%A2%98.html#22-var-tmp","title":"2.2 \u7cfb\u7edf\u91cd\u542f\u540e\u62a5\u9519 /var \u76ee\u5f55\u548c /tmp \u76ee\u5f55\u7591\u4f3c\u635f\u574f","text":"<p>\u540e\u7eed\u53c8\u53d1\u73b0\u5728\u91cd\u542f\u540e\uff0c\u7531\u4e8e RHEL6 \u7684 /etc/fstab \u9ed8\u8ba4\u914d\u7f6e\u542f\u52a8\u65f6 fsck \uff0cfsck \u62a5\u9519 /var \u548c /tmp \u635f\u574f\u3002\u5728\u7cfb\u7edf\u8fdb\u5165 enmergency shell \u540e\uff0c\u8f93\u5165 root \u5bc6\u7801\uff0c\u9996\u5148\u5c1d\u8bd5\u4f7f\u7528 <code>lvm lvs</code> \u547d\u4ee4\u68c0\u67e5\u903b\u8f91\u5377\u662f\u5426\u8fd8\u5728\uff0c\u53d1\u73b0\u62a5\u9519\uff1a</p> <pre><code>File-based locking initialisation failed\n</code></pre> <p>\u67e5\u8be2\u6587\u6863\u5f97\u77e5\uff0c\u6b64\u62a5\u9519\u662f\u7531\u4e8e <code>/var/lock/lvm</code> \u76ee\u5f55\u65e0\u6cd5\u5199\u5165\u5bfc\u81f4\u3002\u6839\u672c\u539f\u56e0\u4e3a\u5728 emergency shell \u4e2d\uff0c\u6839\u76ee\u5f55\u662f\u4ee5\u53ea\u8bfb\u7684\u65b9\u5f0f\u6302\u8f7d\u7684\uff0c\u9700\u8981\u91cd\u65b0\u6302\u8f7d\u4e3a\u8bfb\u5199\uff1a</p> <pre><code>mount -o remount,rw /\n</code></pre> <p>\u4e4b\u540e\u53d1\u73b0 <code>lvs</code> \u547d\u4ee4\u6b63\u5e38\uff0c\u4f46\u662f\u6240\u6709\u903b\u8f91\u5377\u90fd\u6ca1\u6709 activate \uff0c\u4e14\u8fd0\u884c\u6b64\u547d\u4ee4\u53ef\u4ee5 activate \u6240\u6709\u903b\u8f91\u5377\uff1a</p> <pre><code>vgchange -ay rootvg\n</code></pre> <p>\u4e4b\u540e\u6392\u67e5\u6587\u4ef6\u7cfb\u7edf\u635f\u574f\u95ee\u9898\uff0c\u5c1d\u8bd5\u4f7f\u7528 <code>e2fsck</code> \u547d\u4ee4\u4fee\u590d\u6587\u4ef6\u7cfb\u7edf\uff1a</p> <pre><code>e2fsck /dev/rootvg/lv_var\ne2fsck /dev/rootvg/lv_tmp\n</code></pre> <p>\u4f46\u662f\u53d1\u73b0\u6587\u4ef6\u7cfb\u7edf\u6ca1\u6709\u635f\u574f\u3002\u91cd\u542f\u4ee5\u540e\uff0c\u6545\u969c\u6ca1\u6709\u6062\u590d\uff0c\u4f9d\u65e7\u662f\u627e\u4e0d\u5230\u9664\u4e86\u6839\u76ee\u5f55\u548c swap \u4ee5\u5916\u6240\u6709\u903b\u8f91\u5377\u3002\u7ecf\u8fc7\u4ed4\u7ec6\u5206\u6790\u7cfb\u7edf\u542f\u52a8\u65f6\u6302\u8f7d\u903b\u8f91\u5377\u7684\u539f\u7406\u4e3a\u6267\u884c <code>/etc/rc.sysinit</code> \u811a\u672c\u4e2d\u6709\u4e00\u53e5 vgchange \u547d\u4ee4\u6fc0\u6d3b\u903b\u8f91\u5377\u3002\u731c\u6d4b\u662f\u6b64\u547d\u4ee4\u6ca1\u6709\u6b63\u786e\u6267\u884c\u5bfc\u81f4\uff0c\u56e0\u4e3a\u8fdb\u5165 emergency shell \u7684\u73b0\u8c61\u5c31\u662f vg \u6ca1\u6709\u6fc0\u6d3b\uff0c\u4e14\u6839\u76ee\u5f55\u548c swap \u88ab\u6fc0\u6d3b\u3002\u4ed4\u7ec6\u548c\u6b63\u5e38\u7684\u673a\u5668\u8fdb\u884c\u5bf9\u6bd4\uff0c\u5f97\u51fa\u89e3\u51b3\u65b9\u6848\u5982\u4e0b\uff1a</p> <p>\u4fee\u6539 <code>/etc/rc.sysinit</code> \uff0c\u5c06\uff1a</p> <pre><code>action $\"Setting up Logical Volume Management:\" /sbin/lvm vgchange -a ay --sysinit --ignoreskippedcluster\n</code></pre> <p>\u4fee\u6539\u4e3a\uff1a</p> <pre><code>action $\"Setting up Logical Volume Management:\" /sbin/lvm vgchange -a ay --sysinit\n</code></pre> <p>\u95ee\u9898\u7684\u6839\u672c\u539f\u56e0\uff0c\u731c\u6d4b\u4e3a <code>yum update -y</code> \u5347\u7ea7\u4e86 <code>/etc/rc.sysinit</code> \u4f46\u662f\u6ca1\u6709\u5347\u7ea7 lvm \uff0c\u6216\u8005\u5347\u7ea7 lvm \u7684\u8fc7\u7a0b\u4e2d\u88ab\u7ec8\u6b62\uff0c\u5bfc\u81f4 <code>/etc/rc.sysinit</code> \u88ab\u66f4\u65b0\u52a0\u5165\u4e86 <code>--ignoreskippedcluster</code> \u53c2\u6570\uff0c\u4f46\u662f vgchange \u547d\u4ee4\u548c lvm \u6ca1\u6709\u88ab\u66f4\u65b0\u3002\u5b9e\u9645\u5728\u673a\u5668\u4e0a\u5b9e\u884c <code>/sbin/lvm vgchange -a ay --sysinit --ignoreskippedcluster</code> \u62a5\u9519\u4fe1\u606f\u4e3a\u201c\u53c2\u6570 --ignoreskippedcluster \u672a\u77e5\u201d\u4e5f\u5370\u8bc1\u4e86\u8fd9\u4e00\u70b9\u3002</p>","tags":["RHEL6","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/RHEL6/%E8%AE%B0%E6%9F%90%E6%AC%A1%E8%AF%AF%E6%93%8D%E4%BD%9Cyum%20update%E5%90%8Ejboss%E5%BA%94%E7%94%A8%E6%97%A0%E6%B3%95%E5%90%AF%E5%8A%A8%E5%8F%8A%E9%87%8D%E5%90%AF%E6%97%A0%E6%B3%95%E8%AF%86%E5%88%ABvg%E9%97%AE%E9%A2%98.html#3","title":"3. \u53c2\u8003\u6587\u732e","text":"<p>https://access.redhat.com/solutions/47028</p> <p>https://access.redhat.com/solutions/22545</p>","tags":["RHEL6","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/Ubuntu/Ubuntu%E5%AE%89%E8%A3%85Hyper-V%E5%B7%A5%E5%85%B7.html","title":"Ubuntu \u5b89\u88c5 Hyper-V \u5de5\u5177","text":"<p>\u5728 Hyper-V \u4e0a\u9ed8\u8ba4\u5b89\u88c5\u597d\u7684 Ubuntu Server \u540e\uff0c\u5982\u679c\u865a\u62df\u673a\u4f7f\u7528\u7684 IP \u5730\u5740\u4e0d\u662f Hyper-V \u5206\u914d\uff0c\u8fd9\u91cc\u4e0d\u663e\u793a\uff1a</p> <p></p> <p>\u89e3\u51b3\u65b9\u6cd5\uff1a</p> <pre><code>sudo apt-get install \"linux-cloud-tools-$(uname -r)\"\n</code></pre> <p>\u8fd9\u6837\u5c31\u80fd\u5b89\u88c5 Hyper-V \u7684\u76f8\u5173\u670d\u52a1\uff08\u9700\u91cd\u542f\u751f\u6548\uff09\u3002</p>","tags":["Ubuntu","Linux","Hyper-V"]},{"location":"%E6%8A%98%E8%85%BELinux/%E4%B8%AD%E6%A0%87%E9%BA%92%E9%BA%9FV7/%E6%9B%99%E5%85%89%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%A3%85%E6%9C%BA%E6%97%A0RAID%E5%8D%A1%E9%A9%B1%E5%8A%A8%E5%AF%BC%E8%87%B4%E4%B8%8D%E8%83%BD%E8%AF%86%E5%88%AB%E7%A1%AC%E7%9B%98%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html","title":"\u66d9\u5149\u670d\u52a1\u5668\u88c5\u673a\u65e0 RAID \u5361\u9a71\u52a8\u5bfc\u81f4\u4e0d\u80fd\u8bc6\u522b\u786c\u76d8\u95ee\u9898\u5206\u6790\u4e0e\u89e3\u51b3\u65b9\u6848","text":"","tags":["\u4e2d\u6807\u9e92\u9e9fV7","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/%E4%B8%AD%E6%A0%87%E9%BA%92%E9%BA%9FV7/%E6%9B%99%E5%85%89%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%A3%85%E6%9C%BA%E6%97%A0RAID%E5%8D%A1%E9%A9%B1%E5%8A%A8%E5%AF%BC%E8%87%B4%E4%B8%8D%E8%83%BD%E8%AF%86%E5%88%AB%E7%A1%AC%E7%9B%98%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#1","title":"1. \u95ee\u9898\u7684\u521d\u6b65\u5b9a\u4f4d","text":"<p>2022 \u5e74\u66d9\u5149\u670d\u52a1\u5668\u88c5\u673a\u65f6\u627e\u4e0d\u5230\u786c\u76d8\uff0c\u4f46\u662f\u8001\u7684\u66d9\u5149\u670d\u52a1\u5668\u53ef\u4ee5\u627e\u5230\u786c\u76d8\uff0c\u4e4b\u524d\u7684\u89e3\u51b3\u65b9\u6cd5\u662f\u6302\u8f7d\u4e00\u4e2a DUD\uff08Driver Update Disk\uff09\u5149\u76d8\u7684 ISO \u955c\u50cf\uff0cDUD \u76d8\u91cc\u6709 RAID \u5361\u9a71\u52a8\uff08rpm \u5305\u5f62\u5f0f\u7684\u9a71\u52a8\uff09\uff0c\u5b89\u88c5\u65f6\u68c0\u6d4b\u5230 DUD \u76d8\u73b0\u573a\u5b89\u88c5\u9a71\u52a8\uff0c\u5e76\u5728\u88c5\u65b0\u7cfb\u7edf\u65f6\u4e5f\u5b89\u88c5 DUD \u76d8\u5185\u7684\u9a71\u52a8\u3002</p> <p>\u8fd9\u662f\u547d\u4ee4 modinfo megaraid_sas \u5728\u88c5\u673a\u4e0d\u6302 DUD \u955c\u50cf\u65f6\u7684\u8f93\u51fa\uff0c\u53ef\u4ee5\u770b\u51fa magaraid_sas \u9a71\u52a8\u7684\u7248\u672c\u6bd4\u8f83\u4f4e\uff0c\u9a71\u52a8\u5382\u5546\u4e3a Avago\uff1a</p> <p></p> <p>\u8fd9\u4e2a\u662f\u88c5\u597d\u7684\u670d\u52a1\u5668\u7684 megaraid_sas \u9a71\u52a8\u7684\u4fe1\u606f\uff0c\u9a71\u52a8\u7248\u672c\u9ad8\uff0c\u800c\u4e14\u5382\u5546\u4e3a Boardcom\uff08Avago \u6536\u8d2d Boardcom \u540e\u6539\u4e86\u516c\u53f8\u7684\u540d\u5b57\u4e3a Boardcom\uff0c\u56e0\u6b64 Boradcom \u548c Avago \u662f\u4e00\u4e2a\u516c\u53f8\uff09\uff1a</p> <p></p> <p>\u56e0\u6b64\uff0c\u65b0\u7248\u66d9\u5149\u670d\u52a1\u5668\u627e\u4e0d\u5230\u9a71\u52a8\u7684\u539f\u56e0\u4e3a\uff1a\u65b0\u7248\u66d9\u5149\u670d\u52a1\u5668\u5347\u7ea7\u4e86 RAID \u5361\u5230\u65b0\u7684\u7248\u672c\uff0c\u4f46\u662f\u9e92\u9e9f 7.6 \u7684\u5b89\u88c5\u955c\u50cf\u91cc\u7684\u9a71\u52a8\u662f\u8001\u7248\u672c\u9a71\u52a8\u3002\u89e3\u51b3\u65b9\u6848\u662f\u5347\u7ea7\u5b89\u88c5\u955c\u50cf\u91cc\u7684 megaraid_sas \u9a71\u52a8\u7a0b\u5e8f\u3002</p> <p>\u540c\u65f6\uff0c\u89c2\u5bdf\u6ca1\u6709\u6302\u8f7d DUD \u76d8\u65f6\uff0c\u5b89\u88c5\u5149\u76d8\u91cc\u7684 Linux \u53ef\u4ee5\u6b63\u5e38\u542f\u52a8\uff0c\u53ef\u4ee5\u52a0\u8f7d\u5185\u6838\u548c initramfs \uff0cinitramfs \u53ef\u4ee5\u6302\u8f7d squashfs\uff0c\u4ece\u800c\u628a\u955c\u50cf\u5185\u7684\u64cd\u4f5c\u7cfb\u7edf\u542f\u52a8\u8d77\u6765\u3002\u4f46\u662f\u955c\u50cf\u5185\u64cd\u4f5c\u7cfb\u7edf\u542f\u52a8\u5b8c\u6210\u540e\uff0cmegaraid_sas \u9a71\u52a8\u7a0b\u5e8f\u7248\u672c\u4f4e\uff0c\u65e0\u6cd5\u9a71\u52a8\u9ad8\u7248\u672c\u7684 RAID \u5361\u3002\u56e0\u6b64\u9700\u8981\u5347\u7ea7\u7684\u662f squashfs \u5185\u7684 RAID \u5361\u9a71\u52a8\u3002</p>","tags":["\u4e2d\u6807\u9e92\u9e9fV7","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/%E4%B8%AD%E6%A0%87%E9%BA%92%E9%BA%9FV7/%E6%9B%99%E5%85%89%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%A3%85%E6%9C%BA%E6%97%A0RAID%E5%8D%A1%E9%A9%B1%E5%8A%A8%E5%AF%BC%E8%87%B4%E4%B8%8D%E8%83%BD%E8%AF%86%E5%88%AB%E7%A1%AC%E7%9B%98%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#2-squashfs","title":"2. \u4fee\u6539\u88c5\u673a\u955c\u50cf\u4e2d squashfs \u5e76\u52a0\u5165\u65b0\u7248\u9a71\u52a8","text":"<p>Info</p> <p>\u4ee5\u4e0b\u8fc7\u7a0b\u9700\u8981\u7528 root \u7528\u6237\u64cd\u4f5c</p> <p>squashfs \u4f4d\u4e8e\u5b89\u88c5\u5149\u76d8\u7684 LiveOS \u76ee\u5f55\u4e0b\uff0c\u5148\u628a\u5b83\u79fb\u52a8\u51fa\u6765\uff1a</p> <pre><code>mkdir /root/squashfs-edit\nmv LiveOS/squashfs.img /root/squashfs-edit/\ncd /root/squashfs-edit/\n</code></pre> <p>\u89e3\u538b squashfs\uff1a</p> <pre><code>unsquashfs squashfs.img\n</code></pre> <pre><code>Parallel unsquashfs: Using 8 processors\n1 inodes (16384 blocks) to write\n\n[============================================================-] 16384/16384 100%\n\ncreated 1 files\ncreated 2 directories\ncreated 0 symlinks\ncreated 0 devices\ncreated 0 fifos\n</code></pre> <p>\u89e3\u538b\u5b8c\u6210\u540e\u7684\u76ee\u5f55\u7ed3\u6784\u4e3a\uff1a</p> <pre><code>tree .\n</code></pre> <pre><code>.\n\u251c\u2500\u2500 squashfs.img\n\u2514\u2500\u2500 squashfs-root\n    \u2514\u2500\u2500 LiveOS\n        \u2514\u2500\u2500 rootfs.img\n\n2 directories, 2 files\n</code></pre> <p>\u53d1\u73b0 rootfs.img \u662f\u4e00\u4e2a ext4 \u6587\u4ef6\u7cfb\u7edf\uff1a</p> <pre><code>file squashfs-root/LiveOS/rootfs.img\n</code></pre> <pre><code>squashfs-root/LiveOS/rootfs.img: Linux rev 1.0 ext4 filesystem data, UUID=921b7a3a-746d-405e-af58-cb96cb700222, volume name \"Anaconda\" (extents) (64bit) (huge files)\n</code></pre> <p>\u5c06\u8fd9\u4e2a rootfs.img \u4e0a\u4f20\u5230\u5b89\u88c5\u4e86\u6d77\u5149\u7248\u672c\u7684\u9e92\u9e9f 7.6 \u7cfb\u7edf\u7684\u673a\u5668\u4e0a\uff08\u53ef\u4ee5\u662f\u529e\u516c\u7535\u8111\u5f00\u7684 KVM \u865a\u62df\u673a\uff09\uff0c\u5e76\u6302\u8f7d\uff1a</p> <pre><code>mkdir /root/rootfs\nmount rootfs.img /root/rootfs/\nls /root/rootfs/\n</code></pre> <pre><code>total 27K\nlrwxrwxrwx.  1 root root    7 Oct 13  2019 bin -&gt; usr/bin\ndr-xr-xr-x.  2 root root 1.0K Oct 13  2019 boot\ndrwxr-xr-x   2 root root 1.0K Oct 13  2019 dev\ndrwxr-xr-x. 92 root root 5.0K Oct 13  2019 etc\nlrwxrwxrwx.  1 root root   12 Oct 13  2019 firmware -&gt; lib/firmware\nlrwxrwxrwx.  1 root root    7 Oct 13  2019 lib -&gt; usr/lib\nlrwxrwxrwx.  1 root root    9 Oct 13  2019 lib64 -&gt; usr/lib64\ndrwx------.  2 root root  12K Oct 13  2019 lost+found\ndrwxr-xr-x.  2 root root 1.0K Oct 13  2019 mnt\nlrwxrwxrwx.  1 root root   11 Oct 13  2019 modules -&gt; lib/modules\ndr-xr-xr-x   2 root root 1.0K Apr 11  2018 proc\ndr-xr-x---.  2 root root 1.0K Oct 13  2019 root\ndrwxr-xr-x. 16 root root 1.0K Oct 13  2019 run\nlrwxrwxrwx.  1 root root    8 Oct 13  2019 sbin -&gt; usr/sbin\ndr-xr-xr-x   2 root root 1.0K Apr 11  2018 sys\ndrwxrwxrwt.  7 root root 1.0K Oct 13  2019 tmp\ndrwxr-xr-x. 10 root root 1.0K Oct 13  2019 usr\ndrwxr-xr-x. 10 root root 1.0K Oct 13  2019 var\n</code></pre> <p>\u4e4b\u540e\u7528\u65b0\u7248 megaraid_sas \u9a71\u52a8\u66ff\u6362\u6389\u8001\u7248\u672c\u9a71\u52a8\uff08\u5982\u679c\u9a71\u52a8\u662f ko \u7ed3\u5c3e\u7684\uff0c\u7528 xz \u547d\u4ee4\u538b\u7f29\u4e0b\uff09\uff1a</p> <pre><code>xz megaraid_sas.ko\ncp megaraid_sas.ko.xz /root/rootfs/usr/lib/modules/3.10.0-957.el7.hg.3.x86_64/kernel/drivers/scsi/megaraid/megaraid_sas.ko.xz\n</code></pre> <p>\u66ff\u6362\u5b8c\u6210\u540e\uff0cchroot \u8fdb\u53bb:</p> <pre><code>chroot /root/rootfs\n</code></pre> <p>\u8fd0\u884c depmod \u6765\u91cd\u5efa\u5185\u6838\u6a21\u5757\u7684\u4f9d\u8d56\u5173\u7cfb\uff1a</p> <pre><code>depmod -v\n</code></pre> <p>\u65b0\u5efa\u914d\u7f6e\u6587\u4ef6 <code>/etc/modules-load.d/megaraid_sas.conf</code> ,\u4f7f\u5f97\u5f00\u673a\u52a0\u8f7d megaraid_sas \u9a71\u52a8:</p> <pre><code>echo megaraid_sas &gt; /etc/modules-load.d/megaraid_sas.conf\n</code></pre> <p>\u5b8c\u6210\u4fee\u6539\u540e\u9000\u51fa chroot ,\u5378\u8f7d rootfs\uff1a</p> <pre><code>exit\numount /root/rootfs\n</code></pre> <p>\u628a rootfs.img \u66ff\u6362\u4e3a\u65b0\u7684 rootfs.img \u540e\uff0c\u7528\u4ee5\u4e0b\u547d\u4ee4\u91cd\u65b0\u5c01\u88c5 squashfs\uff1a</p> <pre><code>mksquashfs squashfs-root/ squashfs.img.new -noappend -always-use-fragments\n</code></pre> <pre><code>Parallel mksquashfs: Using 8 processors\nCreating 4.0 filesystem on squashfs.img.new, block size 131072.\n[============================================================|] 16384/16384 100%\n\nExportable Squashfs 4.0 filesystem, gzip compressed, data block size 131072\n    compressed data, compressed metadata, compressed fragments, compressed xattrs\n    duplicates are removed\nFilesystem size 521989.16 Kbytes (509.76 Mbytes)\n    24.89% of uncompressed filesystem size (2097216.30 Kbytes)\nInode table size 30526 bytes (29.81 Kbytes)\n    46.50% of uncompressed inode table size (65650 bytes)\nDirectory table size 48 bytes (0.05 Kbytes)\n    82.76% of uncompressed directory table size (58 bytes)\nNumber of duplicate files found 0\nNumber of inodes 3\nNumber of files 1\nNumber of fragments 0\nNumber of symbolic links  0\nNumber of device nodes 0\nNumber of fifo nodes 0\nNumber of socket nodes 0\nNumber of directories 2\nNumber of ids (unique uids + gids) 1\nNumber of uids 1\n    root (0)\nNumber of gids 1\n    root (0)\n</code></pre> <p>\u7528\u65b0\u751f\u6210\u7684 squashfs.img.new \u66ff\u6362\u6389\u8001\u7684 squashfs\uff0c\u7136\u540e\u91cd\u65b0\u5236\u4f5c\u6210\u88c5\u673a\u955c\u50cf\u5373\u53ef\u3002\u540c\u65f6\uff0c\u4e3a\u4e86\u786e\u4fdd\u9a71\u52a8\u7a0b\u5e8f\u80fd\u88ab\u52a0\u8f7d\uff0c\u53ef\u4ee5\u5728 kickstart \u6587\u4ef6\u4e2d\uff0c\u5206\u76d8\u4e4b\u524d\uff0c\u63d2\u5165\uff1a</p> <pre><code># Load Boardcom RAID card driver\n%pre\nset -x\nmodprobe megaraid_sas\nsleep 10\n%end\n</code></pre> <p>\u6765\u5f3a\u5236\u52a0\u8f7d megaraid_sas \u9a71\u52a8\u3002\u4e5f\u9700\u8981\u5728 kickstart \u4e2d\u8bbe\u7f6e\u673a\u5668\u88c5\u5b8c\u7cfb\u7edf\u540e\uff0c\u989d\u5916\u5b89\u88c5 megaraid_sas \u9a71\u52a8\u5230\u65b0\u7cfb\u7edf\uff0c\u628a DUD \u5149\u76d8\u653e\u5230 extend/megaraid9560_v7.iso\uff0c\u7136\u540e\u5728%post --nochroot \u4e2d\u52a0\u5165\uff1a</p> <pre><code># Copy Boardcom RAID driver installation disk\necho \"Copying megaraid9560_v7.iso to /root ...\"\ncurl --connect-timeout 5 -o /mnt/sysimage/root/megaraid9560_v7.iso http://osinstall.pxe/kylin/v7-hygon/os/x86_64/extend/megaraid9560_v7.iso\ncp /run/install/repo/extend/megaraid9560_v7.iso /mnt/sysimage/root/\n</code></pre> <p>\u8fd8\u9700\u8981\u5728\u88c5\u673a\u540e\u8fd0\u884c\u811a\u672c %post \u4e2d\u52a0\u5165\uff1a</p> <pre><code>echo \"Installing Boardcom RAID card driver ...\"\nmount /root/megaraid9560_v7.iso /mnt\ncd /mnt/rpms/x86_64 &amp;&amp; rpm -ivh kmod-megaraid_sas-07.720.04.00-1.x86_64.rpm\n</code></pre> <p>\u6765\u786e\u4fdd\u88c5\u673a\u540e kickstart \u4f1a\u5b89\u88c5\u65b0\u7248\u672c\u9a71\u52a8\u5230\u88c5\u597d\u540e\u7684\u7cfb\u7edf\u3002</p>","tags":["\u4e2d\u6807\u9e92\u9e9fV7","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/%E4%B8%AD%E6%A0%87%E9%BA%92%E9%BA%9FV7/%E8%81%94%E6%83%B3%E7%89%A9%E7%90%86%E6%9C%BAPXE%E8%A3%85%E6%9C%BA%E6%8A%A5%E9%94%99%E2%80%9C%E6%A0%B9%E5%88%86%E5%8C%BA%E6%89%BE%E4%B8%8D%E5%88%B0%E2%80%9D%E5%8E%9F%E5%9B%A0%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95.html","title":"\u8054\u60f3\u7269\u7406\u673a PXE \u88c5\u673a\u62a5\u9519\u201c\u6839\u5206\u533a\u627e\u4e0d\u5230\u201d\u539f\u56e0\u53ca\u89e3\u51b3\u65b9\u6cd5","text":"","tags":["\u4e2d\u6807\u9e92\u9e9fV7","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/%E4%B8%AD%E6%A0%87%E9%BA%92%E9%BA%9FV7/%E8%81%94%E6%83%B3%E7%89%A9%E7%90%86%E6%9C%BAPXE%E8%A3%85%E6%9C%BA%E6%8A%A5%E9%94%99%E2%80%9C%E6%A0%B9%E5%88%86%E5%8C%BA%E6%89%BE%E4%B8%8D%E5%88%B0%E2%80%9D%E5%8E%9F%E5%9B%A0%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95.html#1-pxe","title":"1. PXE \u88c5\u673a\u542f\u52a8\u8fc7\u7a0b","text":"<p>\u5b9e\u9645\u89c2\u5bdf\u5230\u7684\u8054\u60f3\u670d\u52a1\u5668\u88c5\u673a\u542f\u52a8\u8fc7\u7a0b\u5927\u81f4\u5982\u4e0b\uff1a</p> <ol> <li>\u52a0\u8f7d\u4f4d\u4e8e \u00a0http://osinstall/kylin/v7-hygon/os/x86_64/images/pxeboot/vmlinuz \u7684\u5185\u6838\u548c\u4f4d\u4e8e http://osinstall/kylin/v7-hygon/os/x86_64/images/pxeboot/initrd.img\u00a0 \u7684 initramfs</li> <li>initramfs \u52a0\u8f7d\u5b8c\u6bd5\u540e\uff0c\u52a0\u8f7d \u00a0http://osinstall.pxe/kylin/v7-hygon/os/x86_64/LiveOS/squashfs.img\u00a0\uff0c\u5e76\u5c06\u5176\u6302\u8f7d\uff0c\u4e4b\u540e chroot \u8fdb squashfs \u8fdb\u884c\u540e\u7eed\u5b89\u88c5</li> </ol> <p>\u88c5\u673a\u5931\u8d25\u62a5\u9519 /dev/root \u627e\u4e0d\u5230\uff0c\u662f\u5361\u5728\u6302\u8f7d squashfs.img \u8fd9\u4e00\u6b65\uff1a</p> <p></p> <p>\u7528 ip a \u547d\u4ee4\u68c0\u67e5\u53d1\u73b0\u6ca1\u6709\u7f51\u5361\uff1a</p> <p></p> <p>\u7ecf\u8fc7\u68c0\u67e5\uff0c\u88c5\u673a\u5931\u8d25\u7684\u673a\u5668\u7f51\u5361\u4e3a\u7f51\u8baf RP2000\uff0c\u9a71\u52a8\u7684\u5185\u6838\u6a21\u5757\u5e94\u8be5\u662f txgbe \uff1a</p> <p></p> <p>\u88c5\u673a\u6210\u529f\u7684\u673a\u5668\u7f51\u5361\u82f1\u7279\u5c14 X710\uff0c\u82f1\u7279\u5c14\u7f51\u5361\u517c\u5bb9\u6027\u597d\uff0cinitramfs \u6709\u9a71\u52a8\uff1a</p> <p></p> <p>\u627e\u4e0d\u5230 /dev/root \u7684\u539f\u56e0\u4e3a initramfs \u65e0 txgbe \u7f51\u5361\u9a71\u52a8\uff0c\u5bfc\u81f4\u65e0\u6cd5\u8fde\u63a5\u7f51\u7edc\u83b7\u53d6 squashfs.img \uff0c\u6700\u7ec8\u5bfc\u81f4 squashfs.img \u65e0\u6cd5\u6302\u8f7d\uff0c\u5b89\u88c5\u955c\u50cf\u65e0\u6cd5\u7ee7\u7eed\u542f\u52a8\u3002</p>","tags":["\u4e2d\u6807\u9e92\u9e9fV7","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/%E4%B8%AD%E6%A0%87%E9%BA%92%E9%BA%9FV7/%E8%81%94%E6%83%B3%E7%89%A9%E7%90%86%E6%9C%BAPXE%E8%A3%85%E6%9C%BA%E6%8A%A5%E9%94%99%E2%80%9C%E6%A0%B9%E5%88%86%E5%8C%BA%E6%89%BE%E4%B8%8D%E5%88%B0%E2%80%9D%E5%8E%9F%E5%9B%A0%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95.html#2","title":"2. \u89e3\u51b3\u65b9\u6cd5","text":"<p>Info</p> <p>\u4ee5\u4e0b\u8fc7\u7a0b\u9700\u8981\u7528 root \u7528\u6237\u64cd\u4f5c</p> <p>\u8054\u60f3\u670d\u52a1\u5668 PXE \u88c5\u673a\u5931\u8d25\u62a5\u9519/dev/root \u627e\u4e0d\u5230\uff0c\u539f\u56e0\u4e3a initrd.img \u65e0\u6cd5\u4e0b\u8f7d squashfs.img\uff0c\u4ece\u800c\u65e0\u6cd5\u6302\u8f7d squashfs\uff0c\u7ecf\u68c0\u67e5\u53d1\u73b0 initrd.img \u91cc\u6ca1\u6709\u7f51\u8baf\u7f51\u5361\u9a71\u52a8\uff0c\u89e3\u51b3\u65b9\u6cd5\u662f\u5728 initramfs \u91cc\u52a0\u5165\u7f51\u8baf\u7f51\u5361\u9a71\u52a8\u3002\u9996\u5148\u5c06\u88c5\u673a\u955c\u50cf\u7684 images/pxeboot/initrd.img \u590d\u5236\u5230\u4e00\u53f0\u5df2\u7ecf\u88c5\u597d\u6d77\u5149\u7248\u672c\u9e92\u9e9f 7.6 \u7684\u673a\u5668\u4e0a\uff08\u53ef\u4ee5\u662f\u6ca1\u6709\u7f51\u8baf\u7f51\u5361\u7684\u865a\u62df\u673a\uff09\uff0c\u5e76\u89e3\u538b initrd.img\uff1a</p> <pre><code>mkdir /root/initramfs-hygon\ncd /root/initramfs-hygon\nxz -d -c -k /tmp/initrd.img | cpio -i\n</code></pre> <p>\u4e4b\u540e\u628a\u9a71\u52a8\u7a0b\u5e8f txgbe.ko \u4f7f\u7528 xz \u538b\u7f29\uff0c\u5e76\u590d\u5236\u5230\u76f8\u5e94\u76ee\u5f55\uff1a</p> <pre><code>cd usr/lib/modules/3.10.0-957.el7.hg.3.x86_64/kernel/drivers/net/ethernet/\nmkdir txgbe\ncd txgbe/\nmv /tmp/txgbe.ko.xz .\n</code></pre> <p>\u7136\u540e\u9700\u8981 chroot \u8fdb\u53bb\u8fdb\u884c depmod\uff1a</p> <pre><code>chroot /root/initramfs-hygon/\ndepmod -v | grep txgbe\n</code></pre> <pre><code>/lib/modules/3.10.0-957.el7.hg.3.x86_64/kernel/drivers/net/ethernet/txgbe/txgbe.ko.xz needs \"ptp_clock_index\": /lib/modules/3.10.0-957.el7.hg.3.x86_64/kernel/drivers/ptp/ptp.ko.xz\n</code></pre> <p>\u9000\u51fa chroot \uff1a</p> <pre><code>exit\n</code></pre> <p>\u4e4b\u540e\u91cd\u65b0\u5c01\u88c5 initrd.img\uff1a</p> <pre><code>cd /root/initramfs-hygon/\nfind . | cpio -H newc -o | xz --check=crc32 --x86 --lzma2 &gt; /root/initrd-230322.img\n</code></pre> <p>\u9a8c\u8bc1\uff1a</p> <pre><code>lsinitramfs initrd-230322.img | grep txgbe\n</code></pre> <pre><code>usr/lib/modules/3.10.0-957.el7.hg.3.x86_64/kernel/drivers/net/ethernet/txgbe\nusr/lib/modules/3.10.0-957.el7.hg.3.x86_64/kernel/drivers/net/ethernet/txgbe/txgbe.ko.xz\n</code></pre> <p>\u6700\u540e\u628a initrd.img \u66ff\u6362\uff0c\u91cd\u65b0\u5c01\u88c5 ISO \u955c\u50cf\u3002</p>","tags":["\u4e2d\u6807\u9e92\u9e9fV7","Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%80%9A%E7%94%A8Linux/Kickstart%20%E8%BD%AFraid%E5%AE%89%E8%A3%85.html","title":"Kickstart \u8f6f RAID \u5b89\u88c5","text":"<p>\u4f7f\u7528\u4ee5\u4e0b <code>kickstart</code> \u5206\u533a\u914d\u7f6e\u5b89\u88c5 \u8f6f RAID 1 \u5230\u6700\u5c0f\u7684\u4e24\u5757\u786c\u76d8\u7684\u5206\u76d8\u811a\u672c\u5982\u4e0b\uff1a</p> <pre><code># Partition disks\n%pre --interpreter=/bin/bash\nset -x\n# Get the sizes of all /dev/sd[a-z] devices in bytes and sort them by size\ndevices=$(lsblk -dbn -o NAME,SIZE | grep '^sd[a-z]' | sort -k2 -n)\n# Extract the two smallest devices\nsmallest_devices=$(echo \"$devices\" | head -n 2)\n# Assign the smallest devices to variables\nsmallest_1=$(echo \"$smallest_devices\" | sed -n '1p' | awk '{print $1}')\nsmallest_2=$(echo \"$smallest_devices\" | sed -n '2p' | awk '{print $1}')\n# Print the results\necho \"The two block devices with the smallest size are:\"\necho \"/dev/$smallest_1\"\necho \"/dev/$smallest_2\"\n# \u88c5\u8f6fRAID\u5230\u6700\u5c0f\u76842\u5757\u76d8\u4e0a\ncat &gt;/tmp/part-include &lt;&lt;-EOF\n    zerombr\n    ignoredisk --only-use=$smallest_1,$smallest_2\n    clearpart --all --initlabel --drives=$smallest_1,$smallest_2\n    part raid.1583 --fstype=\"mdmember\" --ondisk=$smallest_1 --size=2050\n    part raid.1590 --fstype=\"mdmember\" --ondisk=$smallest_2 --size=2050\n    part raid.1254 --fstype=\"mdmember\" --ondisk=$smallest_1 --size=2050\n    part raid.1261 --fstype=\"mdmember\" --ondisk=$smallest_2 --size=2050\n    part raid.2055 --fstype=\"mdmember\" --ondisk=$smallest_1 --size=1 --grow\n    part raid.2048 --fstype=\"mdmember\" --ondisk=$smallest_2 --size=1 --grow\n    raid /boot/efi --device=boot_efi --fstype=\"efi\" --level=RAID1 --fsoptions=\"umask=0077,shortname=winnt\" raid.1583 raid.1590\n    raid /boot --device=boot --fstype=\"xfs\" --level=RAID1 raid.1254 raid.1261\n    raid pv.789 --device=pv00 --fstype=\"lvmpv\" --level=RAID1 raid.2055 raid.2048\n    volgroup rootvg --pesize=4096 pv.789\n    logvol swap --fstype=\"swap\" --size=32768 --name=lv_swap --vgname=rootvg\n    logvol /home --fstype=\"xfs\" --size=20480 --name=lv_home --vgname=rootvg\n    logvol /tmp --fstype=\"xfs\" --size=51200 --name=lv_tmp --vgname=rootvg\n    logvol /var --fstype=\"xfs\" --size=51200 --name=lv_var --vgname=rootvg\n    logvol / --fstype=\"xfs\" --size=51200 --name=lv_root --vgname=rootvg\nEOF\n%end\n%include /tmp/part-include\n</code></pre> <p>\u5c01\u88c5 ISO \u955c\u50cf\u53ef\u53c2\u8003\u4ee5\u4e0b\u4ee3\u7801\uff1a</p> <pre><code>case \"${os_type}\" in\n*_ARM)\n    sudo genisoimage -V \"$label\" -o \"${BASEDIR}/${DISTDIR}/${os_type}.${DATE}.iso\" \\\n        -J -rational-rock -joliet-long -cache-inodes -graft-points \\\n        -untranslated-filenames -translation-table -m repoview \\\n        -efi-boot-part -efi-boot-image -e images/efiboot.img -no-emul-boot \\\n        .\n    ;;\n*_X86)\n    sudo genisoimage -V \"$label\" -o \"${BASEDIR}/${DISTDIR}/${os_type}.${DATE}.iso\" \\\n        -J -rational-rock -joliet-long -cache-inodes -graft-points \\\n        -untranslated-filenames -translation-table -m repoview \\\n        -eltorito-boot isolinux/isolinux.bin -eltorito-catalog isolinux/boot.cat -boot-load-size 4 -boot-info-table -no-emul-boot \\\n        -eltorito-alt-boot -eltorito-boot images/efiboot.img -no-emul-boot \\\n        .\n    ;;\nesac\n</code></pre>"},{"location":"%E6%8A%98%E8%85%BELinux/%E9%80%9A%E7%94%A8Linux/Linux%20LVM%E8%B8%A2PV.html","title":"Linux LVM \u8e22 PV","text":"<p>lv_ubuntu \u7531 <code>/dev/sdb</code> \u548c <code>/dev/sda3</code> \u4e24\u4e2a pv \u7ec4\u6210\uff0c\u5176\u4e2d\u90e8\u5206\u6570\u636e\u5199\u5728\u4e86 <code>/dev/sdb</code> \uff0c\u5982\u679c\u60f3\u628a <code>/dev/sdb</code> \u8e22\u76d8\uff0c\u9700\u8981\u5148\u8fdb\u884c\u5982\u4e0b\u64cd\u4f5c\uff1a</p> <pre><code>pvmove /dev/sdb /dev/sda3\n</code></pre> <p>\u5c06 <code>/dev/sdb</code> \u8fd9\u4e2a PV \u91cc\u7684 PE \u8fc1\u79fb\u5230 <code>/dev/sda3</code> \u4e0a\uff0c\u4e4b\u540e\u8e22\u76d8\uff1a</p> <pre><code>vgreduce ubuntu-vg /dev/sdb\n</code></pre>","tags":["Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%80%9A%E7%94%A8Linux/Linux%20%E5%BC%80%E5%90%AF%20OTP%20%E4%BA%8C%E6%AC%A1%E8%AE%A4%E8%AF%81.html","title":"Linux \u5f00\u542f OTP \u8ba4\u8bc1","text":"","tags":["Linux","OTP","google-authenticator"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%80%9A%E7%94%A8Linux/Linux%20%E5%BC%80%E5%90%AF%20OTP%20%E4%BA%8C%E6%AC%A1%E8%AE%A4%E8%AF%81.html#1-google-authenticator","title":"1. \u5b89\u88c5 google-authenticator","text":"<p>CentOS \u8fd0\u884c\uff1a</p> <pre><code>sudo yum install epel-release\nsudo dnf install google-authenticator qrencode qrencode-libs\n</code></pre>","tags":["Linux","OTP","google-authenticator"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%80%9A%E7%94%A8Linux/Linux%20%E5%BC%80%E5%90%AF%20OTP%20%E4%BA%8C%E6%AC%A1%E8%AE%A4%E8%AF%81.html#2","title":"2. \u914d\u7f6e\u4ee4\u724c","text":"<p>\u76f4\u63a5\u4f7f\u7528 google-authenticator \u914d\u7f6e\uff08\u6b64\u5904\u914d\u7f6e\u7684\u662f\u5f53\u524d\u7528\u6237\u4ee4\u724c\uff09\uff1a</p> <pre><code>google-authenticator\n</code></pre>","tags":["Linux","OTP","google-authenticator"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%80%9A%E7%94%A8Linux/Linux%20%E5%BC%80%E5%90%AF%20OTP%20%E4%BA%8C%E6%AC%A1%E8%AE%A4%E8%AF%81.html#3-pam","title":"3. \u914d\u7f6e PAM","text":"<p>\u7f16\u8f91 <code>/etc/pam.d/sshd</code> \uff1a</p> <pre><code>auth required pam_google_authenticator.so\n</code></pre>","tags":["Linux","OTP","google-authenticator"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%80%9A%E7%94%A8Linux/Linux%20%E5%BC%80%E5%90%AF%20OTP%20%E4%BA%8C%E6%AC%A1%E8%AE%A4%E8%AF%81.html#4-sshd","title":"4. \u914d\u7f6e sshd \u4f7f\u7528\u4e8c\u6b21\u9a8c\u8bc1","text":"<p>\u4fee\u6539 <code>/etc/ssh/sshd_config</code> \u914d\u7f6e\uff0c\u52a0\u5165\uff1a</p> <pre><code>AuthenticationMethods publickey,keyboard-interactive\n</code></pre> <p>\u627e\u5230 <code>/etc/ssh/sshd_config.d/50-redhat.conf</code> \u5e76\u6ce8\u91ca\u4ee5\u4e0b\u884c\uff1a</p> <pre><code>ChallengeResponseAuthentication no\n</code></pre> <p>\u68c0\u67e5\u914d\u7f6e\u65e0\u8bef\u540e\u91cd\u542f sshd \u670d\u52a1\uff1a</p> <pre><code>sudo sshd -t &amp;&amp; sudo systemctl restart sshd\n</code></pre> <p>\u6b64\u65f6 SSH \u767b\u5f55\u4f1a\u53d8\u6210\u9700\u8981\u516c\u94a5\u3001\u5bc6\u7801\u548c\u4e8c\u6b21\u8ba4\u8bc1\u7801\uff0c\u5982\u679c\u8981\u6c42\u53ea\u8981\u516c\u94a5\u548c\u4e8c\u6b21\u8ba4\u8bc1\u7801\uff0c\u627e\u5230 <code>/etc/pam.d/sshd</code> \u5e76\u6ce8\u91ca\uff1a</p> <pre><code>auth       substack     password-auth\n</code></pre>","tags":["Linux","OTP","google-authenticator"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%80%9A%E7%94%A8Linux/Linux%E4%B8%8B%E8%BD%BDyum%E6%BA%90.html","title":"Linux \u4e0b\u8f7d yum \u6e90","text":"","tags":["Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%80%9A%E7%94%A8Linux/Linux%E4%B8%8B%E8%BD%BDyum%E6%BA%90.html#1-reposync","title":"1. \u4f7f\u7528 reposync \u4e0b\u8f7d","text":"<p>\u5148\u521b\u5efa yum \u6e90\u914d\u7f6e\u6587\u4ef6\uff1a</p> <pre><code>cat &gt; kylin10-x86.repo &lt;&lt;-'EOF'\n###Kylin Linux Advanced Server 10 - os repo###\n\n[ks10-adv-os]\nname = Kylin Linux Advanced Server 10 - Os\nbaseurl = http://update.cs2c.com.cn:8080/NS/V10/V10SP1.1/os/adv/lic/base/$basearch/\ngpgcheck = 0\nenabled = 1\n\n[ks10-adv-updates]\nname = Kylin Linux Advanced Server 10 - Updates\nbaseurl = http://update.cs2c.com.cn:8080/NS/V10/V10SP1.1/os/adv/lic/updates/$basearch/\ngpgcheck = 0\nenabled = 1\n\n[ks10-adv-addons]\nname = Kylin Linux Advanced Server 10 - Addons\nbaseurl = http://update.cs2c.com.cn:8080/NS/V10/V10SP1.1/os/adv/lic/addons/$basearch/\ngpgcheck = 0\nenabled = 0\nEOF\n</code></pre> <p>\u4e0b\u8f7d\u5230 <code>/mnt/kylin10-x86</code> \uff1a</p> <pre><code>dnf reposync -c kylin10-x86.repo -p /mnt/kylin10-x86 --repo ks10-adv-os,ks10-adv-updates --arch=x86_64,noarch\n</code></pre> <p>\u5728\u4e0b x86 \u7684 yum \u6e90\u65f6\u63a8\u8350\u52a0 <code>--arch=x86_64,noarch</code> \u9632\u6b62\u4e0b\u8f7d\u5230 32 \u4f4d\u7684\u5305\uff0c\u5982\u679c\u662f arm \u5219\u9700\u8981\u52a0 <code>--arch=aarch64,noarch</code> \u3002</p>","tags":["Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%80%9A%E7%94%A8Linux/Linux%E4%B8%8B%E8%BD%BDyum%E6%BA%90.html#2-wget","title":"2. \u4f7f\u7528 wget \u4e0b\u8f7d","text":"<p>\u4e5f\u53ef\u4ee5\u4f7f\u7528 wget \u9012\u5f52\u4e0b\u8f7d\u4e00\u4e2a YUM \u6e90\uff1a</p> <pre><code>wget -np -P . -r -R \"index.html*\" --cut-dirs=6 https://update.cs2c.com.cn/NS/V10/V10SP1.1/os/adv/lic/updates/\n</code></pre> <p>\u5176\u4e2d<code>--cut-dirs</code>\u9700\u8981\u6839\u636e\u5b9e\u9645\u7684\u8fdc\u7a0b\u76ee\u5f55\u5c42\u6570\u8fdb\u884c\u8c03\u6574\uff0c\u4e0b\u8f7d\u5b8c\u6210\u540e\u9700\u8981\u68c0\u67e5 wget \u6709\u65e0\u62a5\u9519\u3002</p>","tags":["Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%80%9A%E7%94%A8Linux/Linux%E4%B8%8B%E8%BD%BDyum%E6%BA%90.html#3","title":"3. \u53c2\u8003\u94fe\u63a5","text":"<p>https://rakeshjain-devops.medium.com/download-files-and-directories-from-web-using-curl-and-wget-9217bc2e34c9</p>","tags":["Linux"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%80%9A%E7%94%A8Linux/Linux%E5%B0%86%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E7%A3%81%E7%9B%98%E5%88%86%E5%8C%BA%E6%89%A9%E5%AE%B9%E5%88%B0%E6%9C%80%E5%A4%A7.html","title":"Linux \u5c06\u6700\u540e\u4e00\u4e2a\u78c1\u76d8\u5206\u533a\u6269\u5bb9\u5230\u6700\u5927","text":"<p>\u5728\u6269\u5bb9 Linux \u7684\u7cfb\u7edf\u76d8\u540e\uff0c <code>/dev/sda</code> \u540e\u90e8\u6709\u5927\u91cf\u7a7a\u95f2\u7a7a\u95f4\u6ca1\u6709\u4f7f\u7528\uff0c\u9700\u8981\u5c06\u5176\u7eb3\u5165\u6700\u540e\u4e00\u4e2a\u78c1\u76d8\u5206\u533a\u4e2d\u3002</p>"},{"location":"%E6%8A%98%E8%85%BELinux/%E9%80%9A%E7%94%A8Linux/Linux%E5%B0%86%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E7%A3%81%E7%9B%98%E5%88%86%E5%8C%BA%E6%89%A9%E5%AE%B9%E5%88%B0%E6%9C%80%E5%A4%A7.html#1","title":"1. \u68c0\u67e5\u8def\u7531\u8868","text":"<pre><code>parted -s -a opt /dev/sda \"print free\"\n</code></pre> <pre><code>Warning: Not all of the space available to /dev/sda appears to be used, you can fix the GPT to use all of the space (an extra 201326592 blocks) or continue with the current setting?\nModel: Msft Virtual Disk (scsi)\nDisk /dev/sda: 137GB\nSector size (logical/physical): 512B/4096B\nPartition Table: gpt\nDisk Flags:\n\nNumber  Start   End     Size    File system  Name  Flags\n        17.4kB  1049kB  1031kB  Free Space\n 1      1049kB  1128MB  1127MB  fat32              boot, esp\n 2      1128MB  3276MB  2147MB  ext4\n 3      3276MB  34.4GB  31.1GB\n        34.4GB  137GB   103GB   Free Space\n</code></pre>"},{"location":"%E6%8A%98%E8%85%BELinux/%E9%80%9A%E7%94%A8Linux/Linux%E5%B0%86%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E7%A3%81%E7%9B%98%E5%88%86%E5%8C%BA%E6%89%A9%E5%AE%B9%E5%88%B0%E6%9C%80%E5%A4%A7.html#2-3","title":"2. \u6269\u5bb9\u7b2c 3 \u4e2a\u5206\u533a\u5230\u78c1\u76d8\u672b\u5c3e","text":"<pre><code>root@ubuntu:~# growpart /dev/sda 3\n</code></pre> <pre><code>CHANGED: partition=3 start=6397952 old: size=60708864 end=67106815 new: size=262037471 end=268435422\n</code></pre>"},{"location":"%E6%8A%98%E8%85%BELinux/%E9%80%9A%E7%94%A8Linux/Linux%E6%8C%82%E8%BD%BDCIFS.html","title":"Linux \u6302\u8f7d CIFS","text":"<p>\u9996\u5148\u5b89\u88c5 cifs-utils\uff0c\u7136\u540e\u7f16\u8f91\u6587\u4ef6<code>/etc/cifs-credentials</code>\uff1a</p> <pre><code>username=[username]\npassword=[password]\n</code></pre> <p>\u4fee\u6539\u6587\u4ef6\u6743\u9650\uff1a</p> <pre><code>chmod 600 /etc/cifs-credentials\nchown root:root /etc/cifs-credentials\n</code></pre> <p>\u5728/etc/fstab \u8ffd\u52a0\u6302\u8f7d\u9879\uff1a</p> <pre><code>//[IP_address]/[share_name] /mnt/winshare cifs credentials=/etc/cifs-credentials,uid=1000,gid=1000,_netdev 0 0\n</code></pre> <p>\u6302\u8f7d\uff1a</p> <pre><code>mkdir -p /mnt/winshare\nsystemctl daemon-reload\nmount -a\n</code></pre>","tags":["Linux","CIFS"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%80%9A%E7%94%A8Linux/Linux%E9%85%8D%E7%BD%AEudev%E8%A7%84%E5%88%99%E5%BF%BD%E7%95%A5%E7%A3%81%E7%9B%98.html","title":"Linux \u914d\u7f6e udev \u89c4\u5219\u5ffd\u7565\u78c1\u76d8","text":"","tags":["Linux","udev"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%80%9A%E7%94%A8Linux/Linux%E9%85%8D%E7%BD%AEudev%E8%A7%84%E5%88%99%E5%BF%BD%E7%95%A5%E7%A3%81%E7%9B%98.html#1-udev","title":"1. \u914d\u7f6e udev \u89c4\u5219\u5ffd\u7565\u78c1\u76d8","text":"<p>\u5728\u5b89\u88c5 Proxmox VE \u5e76\u4f7f\u7528 Clover \u8fdb\u884c\u5f15\u5bfc\u540e\uff0c\u6211\u4e0d\u60f3\u5728 PVE \u91cc\u770b\u5230\u5f15\u5bfc\u7528\u7684 U \u76d8/dev/sdd\uff0c\u9700\u8981\u914d\u7f6e udev rule \u6765\u5ffd\u7565\u5f15\u5bfc U \u76d8\u3002\u9996\u5148\u6293\u53d6 udev \u7279\u5f81\uff1a</p> <pre><code>udevadm info -a -n /dev/sdd\n</code></pre> <p>\u91cd\u70b9\u5173\u6ce8 model \u6216\u8005 vendor\uff1a</p> <pre><code>ATTRS{model}==\"CHIPFANCIER     \"\nATTRS{vendor}==\"32G SLC \"\n</code></pre> <p>\u7136\u540e\u65b0\u5efa\u6587\u4ef6 <code>/etc/udev/rules.d/99-hide-usb.rules</code> \u5982\u4e0b\uff1a</p> <pre><code>KERNEL==\"sd?\", ATTRS{model}==\"CHIPFANCIER     \", ATTRS{vendor}==\"32G SLC \", ENV{UDISKS_IGNORE}=\"1\", RUN+=\"/bin/sh -c '/usr/bin/echo deleted device %k &gt;&gt; /tmp/udev.log &amp;&amp; echo 1 &gt; /sys/block/%k/device/delete'\"\n</code></pre> <p>\u4f7f\u5176\u751f\u6548\uff1a</p> <pre><code>udevadm control --reload &amp;&amp; udevadm trigger\n</code></pre> <p>\u8fd9\u4e2a udev rule \u539f\u7406\u662f\u6709\u8fd9\u4e2a\u76d8\u5c31\u5220\u9664\u8fd9\u4e2a\u76d8\u3002</p>","tags":["Linux","udev"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%80%9A%E7%94%A8Linux/Linux%E9%85%8D%E7%BD%AEudev%E8%A7%84%E5%88%99%E5%BF%BD%E7%95%A5%E7%A3%81%E7%9B%98.html#2","title":"2. \u53c2\u8003\u94fe\u63a5","text":"<p>https://www.baeldung.com/linux/shell-run-script-usb-plugged</p> <p>https://askubuntu.com/questions/352836/how-can-i-tell-linux-kernel-to-completely-ignore-a-disk-as-if-it-was-not-even-co</p> <p>https://unix.stackexchange.com/questions/25552/making-udev-ignore-certain-devices-during-boot</p>","tags":["Linux","udev"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%80%9A%E7%94%A8Linux/%E4%BD%BF%E7%94%A8tlog%E5%AF%B9%E7%99%BB%E5%BD%95%E5%88%B0Linux%E4%B8%8A%E7%9A%84%E7%94%A8%E6%88%B7%E8%BF%9B%E8%A1%8C%E5%BD%95%E5%B1%8F.html","title":"\u4f7f\u7528 tlog \u5bf9\u767b\u5f55\u5230 Linux \u4e0a\u7684\u7528\u6237\u8fdb\u884c\u5f55\u5c4f","text":"","tags":["Linux","tlog"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%80%9A%E7%94%A8Linux/%E4%BD%BF%E7%94%A8tlog%E5%AF%B9%E7%99%BB%E5%BD%95%E5%88%B0Linux%E4%B8%8A%E7%9A%84%E7%94%A8%E6%88%B7%E8%BF%9B%E8%A1%8C%E5%BD%95%E5%B1%8F.html#1","title":"1. \u9879\u76ee\u80cc\u666f","text":"<p>\u9700\u8981\u5bf9 SSH \u767b\u5f55\u5230 Linux \u670d\u52a1\u5668\u4e0a\u7684\u7528\u6237\u8fdb\u884c\u5f55\u5c4f\uff0c\u4e3b\u8981\u6709\u4e24\u79cd\u9700\u6c42\uff1a</p> <ol> <li>\u8bb0\u5f55\u81ea\u5df1\u5728 Linux \u4e0a\u7684\u64cd\u4f5c\u3002</li> <li>\u5982\u679c\u522b\u4eba\u505a\u4e86\u4ec0\u4e48\u8822\u4e8b\uff0c\u628a\u4ed6\u63ea\u51fa\u6765\u3002</li> </ol>","tags":["Linux","tlog"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%80%9A%E7%94%A8Linux/%E4%BD%BF%E7%94%A8tlog%E5%AF%B9%E7%99%BB%E5%BD%95%E5%88%B0Linux%E4%B8%8A%E7%9A%84%E7%94%A8%E6%88%B7%E8%BF%9B%E8%A1%8C%E5%BD%95%E5%B1%8F.html#2-tlog","title":"2. \u5b89\u88c5 tlog","text":"<p>\u4ece GitHub \u4ed3\u5e93 \u7684 Releases \u9875\u9762\u4e0b\u8f7d tlog \u6e90\u7801\uff0c\u4e4b\u540e\u5b89\u88c5\u4f9d\u8d56 \uff08\u4ee5 RHEL 8 \u4e3a\u4f8b\uff09\uff1a</p> <pre><code>yum install gcc make m4 json-c-devel systemd-devel libcurl-devel\n</code></pre> <p>\u4e4b\u540e\u5bf9\u6e90\u7801\u8fdb\u884c\u7f16\u8bd1\u5b89\u88c5\uff1a</p> <pre><code>./configure --prefix=/opt/tlog --sysconfdir=/etc --localstatedir=/var &amp;&amp; make\nmake install\n</code></pre>","tags":["Linux","tlog"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%80%9A%E7%94%A8Linux/%E4%BD%BF%E7%94%A8tlog%E5%AF%B9%E7%99%BB%E5%BD%95%E5%88%B0Linux%E4%B8%8A%E7%9A%84%E7%94%A8%E6%88%B7%E8%BF%9B%E8%A1%8C%E5%BD%95%E5%B1%8F.html#3-tlog","title":"3. \u4e3a\u7528\u6237\u542f\u7528 tlog","text":"<p>\u542f\u7528 tlog \u9700\u8981\u4fee\u6539\u7528\u6237\u767b\u5f55 shell \uff1a</p> <pre><code>usermod -s /opt/tlog/bin/tlog-rec-session hxp\n</code></pre> <p>\u4fee\u6539 pam \u914d\u7f6e <code>/etc/pam.d/sshd</code> \u548c <code>/etc/pam.d/system-auth</code> \uff0c\u52a0\u5165\uff1a</p> <pre><code>session     required      pam_env.so readenv=1 envfile=/etc/locale.conf\n</code></pre> <p>\u4fee\u6539\u7cfb\u7edf\u4e34\u65f6\u6587\u4ef6\u76ee\u5f55\u914d\u7f6e <code>/usr/lib/tmpfiles.d/tlog.conf</code> \uff0c\u52a0\u5165\uff1a</p> <pre><code>d /var/run/tlog 1777 root root 10d\n</code></pre> <p>\u521b\u5efa <code>/var/run/tlog/</code> \u76ee\u5f55\uff1a</p> <pre><code>mkdir -p /var/run/tlog/\nchmod 1777 /var/run/tlog/\n</code></pre>","tags":["Linux","tlog"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%80%9A%E7%94%A8Linux/%E4%BD%BF%E7%94%A8tlog%E5%AF%B9%E7%99%BB%E5%BD%95%E5%88%B0Linux%E4%B8%8A%E7%9A%84%E7%94%A8%E6%88%B7%E8%BF%9B%E8%A1%8C%E5%BD%95%E5%B1%8F.html#4","title":"4. \u67e5\u770b\u5f55\u5c4f","text":"<p>\u5f55\u5c4f\u4f1a\u5f55\u5165\u5230 journal \uff0c\u67e5\u770b journal \u4e2d\u7528\u6237\u767b\u5f55\u8bb0\u5f55\u83b7\u53d6 ID \u540e\uff1a</p> <pre><code>tlog-play -r journal -M TLOG_REC=12ca5b356065453fb50adfe57007658a-306a-26f2910 -s 5\n</code></pre>","tags":["Linux","tlog"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10/%E8%AE%B0%E6%9F%90%E6%AC%A1%E6%9F%90%E5%AE%89%E5%85%A8%E5%8E%82%E5%95%86%E5%BA%94%E7%94%A8%E8%BF%90%E8%A1%8C%E4%B8%80%E6%AE%B5%E6%97%B6%E9%97%B4%E5%90%8E%EF%BC%8CLinux%E5%87%BA%E7%8E%B0ping%E5%BB%B6%E8%BF%9F%E9%AB%98%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF.html","title":"\u8bb0\u67d0\u6b21\u67d0\u5b89\u5168\u5382\u5546\u5e94\u7528\u8fd0\u884c\u4e00\u6bb5\u65f6\u95f4\u540e\uff0cLinux \u51fa\u73b0 ping \u5ef6\u8fdf\u9ad8\u95ee\u9898\u7684\u89e3\u51b3\u601d\u8def","text":"","tags":["Linux","\u94f6\u6cb3\u9e92\u9e9fV10","iptables"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10/%E8%AE%B0%E6%9F%90%E6%AC%A1%E6%9F%90%E5%AE%89%E5%85%A8%E5%8E%82%E5%95%86%E5%BA%94%E7%94%A8%E8%BF%90%E8%A1%8C%E4%B8%80%E6%AE%B5%E6%97%B6%E9%97%B4%E5%90%8E%EF%BC%8CLinux%E5%87%BA%E7%8E%B0ping%E5%BB%B6%E8%BF%9F%E9%AB%98%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF.html#1","title":"1. \u95ee\u9898\u63cf\u8ff0","text":"<p>\u5728\u67d0\u53f0\u8054\u60f3\u4fe1\u521b\u670d\u52a1\u5668\uff08\u6d77\u5149 CPU \u7248\u672c\uff09\u4e0a\u5b89\u88c5\u94f6\u6cb3\u9e92\u9e9f V10SP1 \u540e\uff0c\u5b89\u88c5\u4e86\u67d0\u4e2a\u5b89\u5168\u5382\u5546\u7684\u8f6f\u4ef6\u3002\u8be5\u5b89\u5168\u5382\u5546\u8f6f\u4ef6\u9700\u8981\u90e8\u5206 root \u7684\u6743\u9650\u8fd0\u884c\uff0c\u89c2\u5bdf\u5230\u7684\u73b0\u8c61\u4e3a\uff1a\u8f6f\u4ef6\u8fd0\u884c\u4e00\u6bb5\u65f6\u95f4\u540e\uff0c\u8fd9\u4e2a\u8282\u70b9\u5230\u522b\u7684\u8282\u70b9 ping \u5ef6\u8fdf\u53d8\u5f97\u7279\u522b\u9ad8\u800c\u4e14\u4e0d\u7a33\u5b9a\uff08\u540c\u4e00\u4e2a\u4ea4\u6362\u673a\u4e0b\u7684\u4e24\u53f0\u673a\u5668\u4e4b\u95f4\u4e92\u76f8 ping\uff0c\u6709 100ms \u5ef6\u8fdf\uff09\u3002\u4e14\u89c2\u5bdf\u5230 CPU \u8f6f\u4e2d\u65ad\u975e\u5e38\u9ad8\u4e14\u5206\u5e03\u4e0d\u5747\u5300\u3002</p>","tags":["Linux","\u94f6\u6cb3\u9e92\u9e9fV10","iptables"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10/%E8%AE%B0%E6%9F%90%E6%AC%A1%E6%9F%90%E5%AE%89%E5%85%A8%E5%8E%82%E5%95%86%E5%BA%94%E7%94%A8%E8%BF%90%E8%A1%8C%E4%B8%80%E6%AE%B5%E6%97%B6%E9%97%B4%E5%90%8E%EF%BC%8CLinux%E5%87%BA%E7%8E%B0ping%E5%BB%B6%E8%BF%9F%E9%AB%98%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF.html#2","title":"2. \u89e3\u51b3\u601d\u8def\u53ca\u6700\u7ec8\u7ed3\u8bba","text":"<p>\u8be5\u95ee\u9898\u7684\u6392\u67e5\u601d\u8def\u5982\u4e0b\uff1a</p> <ul> <li>\u5728\u786e\u8ba4\u4e86\u65e0\u5e94\u7528\u548c\u4e1a\u52a1\u5f71\u54cd\u3001\u5c06\u5e94\u7528\u670d\u52a1\u5668\u9694\u79bb\u540e\uff0c\u505c\u6b62\u5e94\u7528\uff0c\u7ee7\u7eed\u6d4b\u8bd5\uff0c\u53d1\u73b0 ping \u5ef6\u8fdf\u4f9d\u65e7\u9ad8\uff0c\u81f3\u6b64\u6392\u9664\u4e0d\u662f\u5e94\u7528\u8fd0\u884c\u5bfc\u81f4\u7684\u95ee\u9898\u3002</li> <li>\u5173\u95ed\u8fd9\u53f0\u7269\u7406\u673a\u4e0a\u5b89\u88c5\u7684\u5b89\u5168\u9632\u62a4\u8f6f\u4ef6 G01\uff0c\u5e76\u5378\u8f7d G01 \u8f6f\u4ef6\u7684\u5185\u6838\u6a21\u5757\uff0c\u95ee\u9898\u4f9d\u65e7\u5b58\u5728\uff0c\u8bf4\u660e\u4e0d\u662f G01 \u5bfc\u81f4\u7684\u95ee\u9898\u3002</li> <li>\u91cd\u542f <code>dbus</code> \u670d\u52a1\u548c <code>systemd</code> \u670d\u52a1\uff1a</li> </ul> <pre><code>systemctl restart dbus.service\nsystemctl systemctl daemon-reexec\n</code></pre> <p>\u95ee\u9898\u4f9d\u65e7\u5b58\u5728\uff0c\u6392\u9664 <code>dbus</code>\u548c `systemd \u7684\u95ee\u9898\u3002</p> <ul> <li>\u8be5\u7269\u7406\u673a\u4f7f\u7528\u53cc\u7f51\u5361\u7ed1\u5b9a\uff0c\u4f9d\u6b21\u91cd\u542f\u4e24\u4e2a\u7f51\u5361\u53ca\u5176 bond\uff0c\u91cd\u542f <code>NetworkManager</code> \uff0c\u95ee\u9898\u6ca1\u6709\u89e3\u51b3\u3002\u4e14\u5c1d\u8bd5 ping 127.0.0.1 \uff0c\u53d1\u73b0 127.0.0.1 \u7684\u5ef6\u8fdf\u4e5f\u6709 10ms \u4e14\u4e0d\u7a33\u5b9a\uff0c\u6392\u9664\u662f\u7f51\u7edc\u95ee\u9898\u5bfc\u81f4\u3002</li> </ul> <ul> <li>\u6700\u7ec8\u53d1\u73b0\u662f <code>iptables</code> \u91cc\u6709 9 \u4e07\u884c\u91cd\u590d\u9879\u5bfc\u81f4\uff1a</li> </ul> <pre><code># iptables -n -L -v | wc -l\n91257\n</code></pre> <p>\u76f4\u63a5\u95ee\u9898\u662f\u56e0\u4e3a\u6bcf\u6b21\u5305\u8fdb\u5165\u5230\u670d\u52a1\u5668\uff0c\u90fd\u8981\u5339\u914d\u8fd9 9 \u4e07\u884c iptables \u89c4\u5219\uff0c\u7136\u540e\u624d\u4f1a\u628a\u5305\u653e\u8fdb\u6765\u3002</p>","tags":["Linux","\u94f6\u6cb3\u9e92\u9e9fV10","iptables"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10/%E8%AE%B0%E6%9F%90%E6%AC%A1%E6%9F%90%E5%AE%89%E5%85%A8%E5%8E%82%E5%95%86%E5%BA%94%E7%94%A8%E8%BF%90%E8%A1%8C%E4%B8%80%E6%AE%B5%E6%97%B6%E9%97%B4%E5%90%8E%EF%BC%8CLinux%E5%87%BA%E7%8E%B0ping%E5%BB%B6%E8%BF%9F%E9%AB%98%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF.html#3","title":"3. \u89e3\u51b3\u65b9\u6cd5","text":"<p>\u4e34\u65f6\u7684\u89e3\u51b3\u65b9\u6cd5\u4e3a\u6e05\u7a7a iptables \uff1a</p> <pre><code>iptables -F\n</code></pre> <p>\u6e05\u7a7a\u540e\uff0c ping 127.0.0.1 \u9a8c\u8bc1\u95ee\u9898\u5df2\u89e3\u51b3\u3002</p> <p>\u6839\u672c\u7684\u89e3\u51b3\u65b9\u6cd5\u9700\u8981\u5b89\u5168\u8f6f\u4ef6\u5382\u5546\u5206\u6790\u4e3a\u4ec0\u4e48\u8f6f\u4ef6\u4f1a\u5f80 iptables \u91cc\u6dfb\u52a0 9 \u4e07\u884c\u91cd\u590d\u7684 iptables \u89c4\u5219\u3002</p>","tags":["Linux","\u94f6\u6cb3\u9e92\u9e9fV10","iptables"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10/%E9%BA%92%E9%BA%9FV10SP4%E5%A2%9E%E5%8A%A0VSCode%E6%94%AF%E6%8C%81.html","title":"\u9e92\u9e9f V10SP4 \u589e\u52a0 VSCode \u652f\u6301","text":"<p>VSCode \u81ea 1.99 \u7248\u672c\u5f00\u59cb\u629b\u5f03\u4e86\u5bf9\u65e7\u7248\u672c Linux \u7684\u652f\u6301\uff0c\u5bf9\u4e8e\u65e7\u7248\u672c\u9700\u8981\u989d\u5916\u8fdb\u884c\u4e00\u4e9b\u914d\u7f6e\u624d\u80fd\u4f7f\u7528\u3002</p>","tags":["Linux","\u94f6\u6cb3\u9e92\u9e9fV10","VSCode"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10/%E9%BA%92%E9%BA%9FV10SP4%E5%A2%9E%E5%8A%A0VSCode%E6%94%AF%E6%8C%81.html#1","title":"1. \u5b89\u88c5\u7f16\u8bd1\u4f9d\u8d56","text":"<pre><code>yum group install -y 'Development Tools'\nyum install -y texinfo help2man ncurses-libs ncurses-devel libstdc++-static\n</code></pre>","tags":["Linux","\u94f6\u6cb3\u9e92\u9e9fV10","VSCode"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10/%E9%BA%92%E9%BA%9FV10SP4%E5%A2%9E%E5%8A%A0VSCode%E6%94%AF%E6%8C%81.html#2-crosstool-ng","title":"2. \u5b89\u88c5 crosstool-ng","text":"<pre><code>wget http://crosstool-ng.org/download/crosstool-ng/crosstool-ng-1.26.0.tar.bz2\ntar -xjf crosstool-ng-1.26.0.tar.bz2\ncd crosstool-ng-1.26.0\n./configure --prefix=/opt/crosstool-ng-1.26.0\nmake\nmake install\n</code></pre>","tags":["Linux","\u94f6\u6cb3\u9e92\u9e9fV10","VSCode"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10/%E9%BA%92%E9%BA%9FV10SP4%E5%A2%9E%E5%8A%A0VSCode%E6%94%AF%E6%8C%81.html#3-sysroot","title":"3. \u7f16\u8bd1\u65b0 sysroot","text":"<p>\u65b0\u5efa <code>.config</code> \u6587\u4ef6\uff1a</p> <pre><code>mkdir /opt/crosstool-ng-1.26.0/toolchain\ncd /opt/crosstool-ng-1.26.0/toolchain\nwget -O .config 'https://raw.githubusercontent.com/microsoft/vscode-linux-build-agent/refs/heads/main/x86_64-gcc-8.5.0-glibc-2.28.config'\n</code></pre> <p>\u7f16\u8f91 <code>.config</code> \u6587\u4ef6\uff0c\u5c06\u4ee5\u4e0b\u884c\u63d2\u5165\u5230\u6700\u5f00\u59cb\u4f4d\u7f6e\u4ee5\u5141\u8bb8\u4f7f\u7528 root \u6784\u5efa\uff1a</p> <pre><code>CT_EXPERIMENTAL=y\nCT_ALLOW_BUILD_AS_ROOT=y\nCT_ALLOW_BUILD_AS_ROOT_SURE=y\n</code></pre> <p>\u7528 <code>make menuconfig</code> \u4fee\u6539 gcc \u7248\u672c\uff1a</p> <pre><code>/opt/crosstool-ng-1.26.0/bin/ct-ng menuconfig\n</code></pre> <p>\u8fdb\u5165 <code>C compiler</code> -&gt; <code>Version of gcc</code> \uff0c\u5c06\u5176\u4fee\u6539\u4e3a <code>6.5.0</code> \uff0c\u8fdb\u5165 <code>Operating System</code> -&gt; <code>Version of linux</code> \uff0c\u5c06\u5176\u4fee\u6539\u4e3a <code>4.18.20</code> \uff0c\u4fdd\u5b58\u9000\u51fa\u540e\u5f00\u59cb\u7f16\u8bd1\uff1a</p> <pre><code>/opt/crosstool-ng-1.26.0/bin/ct-ng build\n</code></pre>","tags":["Linux","\u94f6\u6cb3\u9e92\u9e9fV10","VSCode"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10/%E9%BA%92%E9%BA%9FV10SP4%E5%A2%9E%E5%8A%A0VSCode%E6%94%AF%E6%8C%81.html#4-patchelf","title":"4. \u5b89\u88c5 patchelf","text":"<pre><code>cd /tmp\nwget https://github.com/NixOS/patchelf/releases/download/0.18.0/patchelf-0.18.0-x86_64.tar.gz\nmkdir /opt/patchelf-0.18.0\ntar -zxvf patchelf-0.18.0-x86_64.tar.gz -C /opt/patchelf-0.18.0\n</code></pre>","tags":["Linux","\u94f6\u6cb3\u9e92\u9e9fV10","VSCode"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10/%E9%BA%92%E9%BA%9FV10SP4%E5%A2%9E%E5%8A%A0VSCode%E6%94%AF%E6%8C%81.html#5","title":"5. \u8bbe\u7f6e\u73af\u5883\u53d8\u91cf","text":"<p>\u65b0\u5efa\u6587\u4ef6 <code>/etc/profile.d/vscode.sh</code> \uff1a</p> <pre><code>#!/bin/bash\nexport VSCODE_SERVER_CUSTOM_GLIBC_LINKER=/opt/crosstool-ng-1.26.0/toolchain/x86_64-linux-gnu/x86_64-linux-gnu/sysroot/lib/ld-2.28.so\nexport VSCODE_SERVER_CUSTOM_GLIBC_PATH=/opt/crosstool-ng-1.26.0/toolchain/x86_64-linux-gnu/x86_64-linux-gnu/sysroot/lib64\nexport VSCODE_SERVER_PATCHELF_PATH=/opt/patchelf-0.18.0/bin/patchelf\n</code></pre>","tags":["Linux","\u94f6\u6cb3\u9e92\u9e9fV10","VSCode"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10/%E9%BA%92%E9%BA%9FV10SP4%E5%A2%9E%E5%8A%A0VSCode%E6%94%AF%E6%8C%81.html#6-sshd-allowtcpforwarding","title":"6. \u542f\u7528 sshd \u7684 AllowTcpForwarding","text":"<p>\u7f16\u8f91 <code>/etc/ssh/sshd_config</code>\uff0c\u5c06 <code>AllowTcpForwarding</code> \u8bbe\u7f6e\u4e3a <code>yes</code>\u540e\uff0c\u91cd\u542f sshd \u670d\u52a1\uff1a</p> <pre><code>sshd -t &amp;&amp; systemctl restart sshd\n</code></pre>","tags":["Linux","\u94f6\u6cb3\u9e92\u9e9fV10","VSCode"]},{"location":"%E6%8A%98%E8%85%BELinux/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10/%E9%BA%92%E9%BA%9FV10SP4%E5%A2%9E%E5%8A%A0VSCode%E6%94%AF%E6%8C%81.html#7","title":"7. \u53c2\u8003\u94fe\u63a5","text":"<ul> <li>https://code.visualstudio.com/docs/remote/faq#_can-i-run-vs-code-server-on-older-linux-distributions</li> </ul>","tags":["Linux","\u94f6\u6cb3\u9e92\u9e9fV10","VSCode"]},{"location":"%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/Hyper-V/Hyper-V%E4%BF%AE%E6%94%B9%E8%B0%83%E5%BA%A6%E5%99%A8.html","title":"Hyper-V \u4fee\u6539\u8c03\u5ea6\u5668","text":"<p>\u5728\u5c1d\u8bd5\u7ed9 Hyper-V \u865a\u62df\u673a\u8bbe\u7f6e CPU \u4f7f\u7528\u9650\u5236\u65f6\uff0c\u53d1\u73b0\u8fd9\u6837\u7684\u544a\u8b66\uff1a</p> <p></p> <p>\u9700\u8981\u4fee\u6539\u8c03\u5ea6\u5668\u3002\u67e5\u770b\u5f53\u524d\u8c03\u5ea6\u5668\u7684 PowerShell \u547d\u4ee4\u4e3a\uff1a</p> <pre><code>Get-WinEvent -FilterHashTable @{ProviderName=\"Microsoft-Windows-Hyper-V-Hypervisor\"; ID=2} -MaxEvents 1\n</code></pre> <p>\u547d\u4ee4\u8fd4\u56de\u5982\u4e0b\uff1a</p> <pre><code>   ProviderName: Microsoft-Windows-Hyper-V-Hypervisor\n\n\nTimeCreated                      Id LevelDisplayName Message\n-----------                      -- ---------------- -------\n6/1/2024 9:31:43 PM               2 Information      Hypervisor scheduler type is 0x4.\n</code></pre> <p>\u5176\u4e2d <code>0x4</code> \u8868\u793a\u8c03\u5ea6\u5668\u4e3a <code>Root scheduler</code> \uff0c\u5176\u5b83\u6570\u5b57\u542b\u4e49\u5982\u4e0b\uff1a</p> <ul> <li>1 = Classic scheduler, SMT disabled</li> <li>2 = Classic scheduler</li> <li>3 = Core scheduler</li> <li>4 = Root scheduler</li> </ul> <p>\u8c03\u5ea6\u5668\u5177\u4f53\u533a\u522b\u53ef\u53c2\u8003 Manage Hyper-V hypervisor scheduler types \uff0c</p> <p>\u4fee\u6539\u8c03\u5ea6\u5668\u65b9\u6cd5\u4e3a Core scheduler \u7684\u65b9\u6cd5\u4e3a\uff1a</p> <pre><code>bcdedit /set hypervisorschedulertype core\n</code></pre> <p>\u4fee\u6539\u4ee5\u540e\u9700\u8981\u91cd\u542f\u3002</p>","tags":["Hyper-V"]},{"location":"%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/Hyper-V/Hyper-V%E5%A4%9A%E7%BD%91%E5%8D%A1%E7%BB%91%E5%AE%9A.html","title":"Hyper-V \u591a\u7f51\u5361\u7ed1\u5b9a","text":"<p>\u81ea Windows Server 2022 \u542f\uff0cLBFO \uff08\u5373\u64cd\u4f5c\u7cfb\u7edf\u91cc\u5185\u7f6e\u7684 NIC Teaming\uff09\u4e0d\u518d\u88ab\u652f\u6301\u6dfb\u52a0\u5230 Hyper-V \u7684\u865a\u62df\u4ea4\u6362\u673a\u5185\uff0c\u9700\u8981\u4f7f\u7528 Switch Embedded Teaming (SET) \uff0c\u6dfb\u52a0\u65b9\u6cd5\u5982\u4e0b\uff1a</p> <p>\u83b7\u53d6\u7f51\u5361\u540d\uff1a</p> <pre><code>Get-NetAdapter\n</code></pre> <p>\u521b\u5efa\u865a\u62df\u4ea4\u6362\u673a\uff1a</p> <pre><code>New-VMSwitch -Name \"External\" -NetAdapterName \"\u4ee5\u592a\u7f51 2\", \"\u4ee5\u592a\u7f51 3\" -AllowManagementOS $false\n</code></pre> <p>\u67e5\u770b\u865a\u62df\u4ea4\u6362\u673a\u53c2\u6570\uff1a</p> <pre><code>Get-VMSwitchTeam -Name External | Format-List\n</code></pre> <p>\u4fee\u6539\u865a\u62df\u4ea4\u6362\u673a\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u4e3a\u52a8\u6001\uff1a</p> <pre><code>Set-VMSwitchTeam -Name \"External\" -LoadBalancingAlgorithm Dynamic\n</code></pre> <p>\u6ce8\u610f\uff1aSET \u662f\u4e0d\u652f\u6301 LACP \u7684\uff0c\u53ea\u652f\u6301\u548c\u4ea4\u6362\u673a\u65e0\u5173\u7684\u7ed1\u5b9a\u6a21\u5f0f\uff0c\u9700\u8981\u628a\u5bf9\u7aef\u7ed1\u5b9a\u6a21\u5f0f\u4fee\u6539\u4e3a\u8f6e\u8be2\u3002</p>","tags":["Hyper-V"]},{"location":"%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/Hyper-V/Hyper-V%E7%BD%91%E5%8D%A1%E7%9B%B4%E9%80%9A.html","title":"Hyper-V \u7f51\u5361\u76f4\u901a","text":""},{"location":"%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/Hyper-V/Hyper-V%E7%BD%91%E5%8D%A1%E7%9B%B4%E9%80%9A.html#_1","title":"\u5bbf\u4e3b\u673a\u7981\u7528\u7f51\u5361","text":"<p>\u8fdb\u5165\u8bbe\u5907\u7ba1\u7406\u5668\uff0c\u5148\u627e\u5230\u7f51\u5361\u7684 LocationPath \uff1a</p> <p></p> <p>\u5c06\u5176\u8bb0\u5f55\u4e0b\u6765\u540e\uff0c\u8bbe\u5907\u7ba1\u7406\u5668\u4e2d\u7981\u7528\u8bbe\u5907\uff1a</p> <p></p> <p>\u4e4b\u540e\u5c06\u8bbe\u5907\u4ece\u5bbf\u4e3b\u673a\u4e0a\u89e3\u9664\u6302\u8f7d\uff1a</p> <pre><code>Dismount-VMHostAssignableDevice -LocationPath \"PCIROOT(0)#PCI(0100)#PCI(0000)#PCI(0600)#PCI(0001)\" -Force\n</code></pre> <p>\u5982\u679c\u9700\u8981\u5c06\u7f51\u5361\u52a0\u56de\u5bbf\u4e3b\u673a\uff1a</p> <pre><code>Mount-VMHostAssignableDevice -LocationPath \"PCIROOT(0)#PCI(0100)#PCI(0000)#PCI(0600)#PCI(0001)\"\n</code></pre> <p>\u5982\u679c\u67e5\u770b\u5df2\u7ecf\u89e3\u9664\u6302\u8f7d\u4f46\u672a\u5206\u914d\u7ed9\u865a\u62df\u673a\u7684\u8bbe\u5907\uff1a</p> <pre><code>Get-VMHostAssignableDevice\n</code></pre>"},{"location":"%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/Hyper-V/Hyper-V%E7%BD%91%E5%8D%A1%E7%9B%B4%E9%80%9A.html#_2","title":"\u5c06\u8bbe\u5907\u6302\u8f7d\u5230\u865a\u62df\u673a","text":"<p>\u5c06\u4e0a\u8ff0\u8bbe\u5907\u52a0\u5165\u5230\u865a\u62df\u673a <code>speedtest</code> \u7684\u547d\u4ee4\u4e3a\uff1a</p> <pre><code>Add-VMAssignableDevice -VMName speedtest -LocationPath \"PCIROOT(0)#PCI(0100)#PCI(0000)#PCI(0600)#PCI(0001)\"\n</code></pre> <p>\u5982\u679c\u9700\u8981\u79fb\u9664\u6b64\u8bbe\u5907\uff1a</p> <pre><code>Remove-VMAssignableDevice -VMName speedtest -LocationPath \"PCIROOT(0)#PCI(0100)#PCI(0000)#PCI(0600)#PCI(0001)\"\n</code></pre> <p>\u67e5\u770b\u6240\u6709\u5df2\u8fde\u63a5\u8bbe\u5907\uff1a</p> <pre><code>Get-VMAssignableDevice -VMName speedtest\n</code></pre>"},{"location":"%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/Hyper-V/Hyper-V%E7%BD%91%E5%8D%A1%E7%9B%B4%E9%80%9A.html#_3","title":"\u53c2\u8003\u8d44\u6599","text":"<p>https://www.nakivo.com/blog/hyper-v-gpu-passthrough/</p>"},{"location":"%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/QEMU/PVE%E5%8F%91%E6%94%BEARM%E8%99%9A%E6%8B%9F%E6%9C%BA.html","title":"PVE\u53d1\u653eARM\u865a\u62df\u673a","text":""},{"location":"%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/QEMU/PVE%E5%8F%91%E6%94%BEARM%E8%99%9A%E6%8B%9F%E6%9C%BA.html#pve","title":"PVE \u5bbf\u4e3b\u673a\u5b89\u88c5\u4f9d\u8d56","text":"<p>PVE\u5bbf\u4e3b\u673a\u9700\u8981\u5b89\u88c5ARM\u7ed3\u6784\u7684firmware\uff1a</p> <pre><code>apt install pve-edk2-firmware-aarch64\n</code></pre>"},{"location":"%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/QEMU/PVE%E5%8F%91%E6%94%BEARM%E8%99%9A%E6%8B%9F%E6%9C%BA.html#_1","title":"\u65b0\u5efa\u865a\u62df\u673a","text":"<p>\u65b0\u5efa\u865a\u62df\u673a\uff0c\u5e76\u505a\u5982\u4e0b\u914d\u7f6e\uff1a</p> <ul> <li>\u4e0d\u9009\u62e9 CDROM</li> <li>Machine \u9009\u62e9 i440fx</li> <li>BIOS \u9009\u62e9 UEFI \uff0c\u4e0d\u6dfb\u52a0 EFI \u78c1\u76d8</li> <li>SCSI \u63a7\u5236\u5668\u9009\u62e9 VirtIO SCSI \uff0c\u78c1\u76d8\u9009 VirtIO Block \u7c7b\u578b</li> </ul>"},{"location":"%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/QEMU/PVE%E5%8F%91%E6%94%BEARM%E8%99%9A%E6%8B%9F%E6%9C%BA.html#_2","title":"\u4fee\u6539\u865a\u62df\u673a\u914d\u7f6e","text":"<p>\u521b\u5efa\u51fa\u7684\u865a\u62df\u673aID\u4e3a108\uff0c\u8fdb\u5165 <code>/etc/pve/qemu-server/108.conf</code> \uff0c\u4fee\u6539\u8fd9\u4e2a\u6587\u4ef6\uff0c\u6dfb\u52a0\u5982\u4e0b\u914d\u7f6e\uff1a</p> <pre><code>arch: aarch64\n</code></pre> <p>\u5220\u9664\u5982\u4e0b\u914d\u7f6e\uff1a</p> <pre><code>cpu: x86-64-v2-AES\nvmgenid: 8e8ffebe-a35d-4882-9039-a8f1d66b6b8d\n</code></pre> <p>\u4e4b\u540e\u518d\u9875\u9762\u4e0a\u5220\u9664 CD \u9a71\u52a8\u5668\uff0c\u518d\u65b0\u5efa\u4e3a SCSI \u7684 CD \u9a71\u52a8\u5668\u3002\u4fee\u6539\u5b8c\u6210\u6b64\u914d\u7f6e\u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>arch: aarch64\nbios: ovmf\nboot: order=net0;scsi0\ncores: 8\nmemory: 16384\nmeta: creation-qemu=9.0.2,ctime=1740024564\nname: centos-9-arm-1\nnet0: virtio=BC:24:11:E4:64:02,bridge=vmbr0,firewall=1\nnuma: 0\nostype: l26\nscsi0: local:iso/CentOS-Stream-9-latest-aarch64-dvd1.iso,media=cdrom,size=10398208K\nscsihw: virtio-scsi-pci\nsmbios1: uuid=3b8d0e01-c5e7-49d3-9f3e-d0fb02e0e048\nsockets: 1\ntemplate: 1\nvirtio0: local-zfs:base-106-disk-0,iothread=1,size=32G\n</code></pre> <p>\u6302\u8f7d\u64cd\u4f5c\u7cfb\u7edf ISO \u5b89\u88c5\u955c\u50cf\uff0c\u5728 Options \u91cc\u4fee\u6539 CD \u4e3a\u7b2c\u4e00\u542f\u52a8\u9879\uff0c\u5b89\u88c5\u64cd\u4f5c\u7cfb\u7edf\u3002</p>"},{"location":"%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/QEMU/virt-manager%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%8A%A5%E9%94%99%E2%80%9CDid%20not%20find%20any%20UEFI%20binary%20path%20for%20arch%20%27aarch64%27%E2%80%9D%E9%97%AE%E9%A2%98.html","title":"virt-manager \u521b\u5efa\u865a\u62df\u673a\u62a5\u9519 \u201cDid not find any UEFI binary path for arch 'aarch64'\u201d \u95ee\u9898","text":"","tags":["QEMU","KVM","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/QEMU/virt-manager%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%8A%A5%E9%94%99%E2%80%9CDid%20not%20find%20any%20UEFI%20binary%20path%20for%20arch%20%27aarch64%27%E2%80%9D%E9%97%AE%E9%A2%98.html#_1","title":"\u95ee\u9898\u63cf\u8ff0","text":"<p>\u5728 ARM64 \u67b6\u6784\u7684\u534e\u4e3a\u9cb2\u9e4f\u67b6\u6784\u7269\u7406\u673a\u4e0a\uff0c\u5b89\u88c5 virt-manager \u540e\uff0c\u65e0\u6cd5\u521b\u5efa KVM \u865a\u62df\u673a\uff0c\u62a5\u9519 \u201cDid not find any UEFI binary path for arch 'aarch64'\u201d \uff1a</p> <p></p> <p>\u64cd\u4f5c\u7cfb\u7edf\u4e3a\u94f6\u6cb3\u9e92\u9e9f V10\uff0c\u7ecf\u8fc7\u68c0\u67e5\uff0c <code>edk2-ovmf-201908-9.ky10.noarch.rpm</code> \u8f6f\u4ef6\u5305\u5df2\u5b89\u88c5\u3002</p>","tags":["QEMU","KVM","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/QEMU/virt-manager%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%8A%A5%E9%94%99%E2%80%9CDid%20not%20find%20any%20UEFI%20binary%20path%20for%20arch%20%27aarch64%27%E2%80%9D%E9%97%AE%E9%A2%98.html#_2","title":"\u89e3\u51b3\u65b9\u6cd5","text":"<p>\u9700\u8981\u5b89\u88c5 <code>edk2-aarch64</code> \u5e76\u91cd\u542f libvirtd \uff1a</p> <pre><code>yum install edk2-aarch64\nsystemctl restart libvirtd\n</code></pre>","tags":["QEMU","KVM","\u94f6\u6cb3\u9e92\u9e9fV10"]},{"location":"%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/%E5%8D%8E%E4%B8%BA%E4%BA%91/%E5%8D%8E%E4%B8%BAHCS%208%E4%B8%8E%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10SP4%20cloud-init%E9%80%82%E9%85%8D%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3.html","title":"\u534e\u4e3a HCS 8 \u4e0e\u94f6\u6cb3\u9e92\u9e9f V10SP4 cloud-init \u9002\u914d\u95ee\u9898\u89e3\u51b3","text":""},{"location":"%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/%E5%8D%8E%E4%B8%BA%E4%BA%91/%E5%8D%8E%E4%B8%BAHCS%208%E4%B8%8E%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10SP4%20cloud-init%E9%80%82%E9%85%8D%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3.html#1","title":"1. \u95ee\u9898\u73b0\u8c61","text":"<p>\u5728\u5236\u4f5c\u94f6\u6cb3\u9e92\u9e9f V10SP4 \u865a\u62df\u673a\u955c\u50cf\u65f6\uff0c\u5b89\u88c5\u540e\u68c0\u67e5\u53d1\u73b0\u6ca1\u6709\u5b89\u88c5 cloud-init \uff0c\u8fdb\u4e00\u6b65\u8c03\u67e5 packer \u65e5\u5fd7\u5982\u4e0b\uff1a</p> <pre><code>qemu: install-cloud-init.sh executing ......\nqemu: /usr/bin/python3\nqemu: python version check success\nqemu: /usr/bin/systemctl\nqemu: setuptools install failed, try to install setuptools through specified directory\nqemu: uninstall old setuptools, try to install setuptools again\n</code></pre> <p>\u65e5\u5fd7\u6307\u5411\u4e3a setuptools \u5b89\u88c5\u5931\u8d25\u3002\u5c1d\u8bd5\u6302\u8f7d image-tools \u7684 ISO \u8fdb\u884c\u624b\u52a8\u5b89\u88c5\uff1a</p> <pre><code>mount /dev/sr0 /mnt\nmkdir /opt/image-tools\ncp -r /mnt/linux/ /opt/image-tools/\numount /mnt\ncd /tmp\ntar zxvf /root/install/drivers/cloud-init-depends.tar.gz\nfind /tmp/cloud-init-depends -type f -exec cp {} /opt/image-tools/linux/cloud-init/cloudinit_depend/ \\;\ncd /opt/image-tools/linux\nchmod +x *.sh\n./install-cloud-init.sh\n</code></pre> <p>\u53ef\u4ee5\u590d\u73b0\u76f8\u540c\u7684\u62a5\u9519\u3002</p>"},{"location":"%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/%E5%8D%8E%E4%B8%BA%E4%BA%91/%E5%8D%8E%E4%B8%BAHCS%208%E4%B8%8E%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10SP4%20cloud-init%E9%80%82%E9%85%8D%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3.html#2","title":"2. \u6392\u67e5\u8fc7\u7a0b","text":"<p>\u5b89\u88c5 setuptools \u7684 Shell \u4ee3\u7801\u4f4d\u4e8e <code>/opt/image-tools/linux/cloud-init/install_script/utils/common_func.sh</code> \uff1a</p> <pre><code># install python setuptools\nfnSetuptoolsInstall()\n{\n    setuptools_name=${setuptools_pkg}\n    cd \"${PKG_PATH}\" || exit\n    tar -xzvf ${setuptools_name}.tar.gz &gt;&gt; \"$LOG_FILE\" 2&gt;&amp;1\n    cd \"${PKG_PATH}\"/${setuptools_name} || exit\n    ${PYTHON_EXEC} bootstrap.py &gt;&gt; \"$LOG_FILE\" 2&gt;&amp;1\n    ${PYTHON_EXEC} setup.py install &gt;&gt; \"$LOG_FILE\" 2&gt;&amp;1\n\n    if [ $? -ne 0 ]; then\n        echo \"setuptools install failed, try to install setuptools through specified directory\"\n        ${PYTHON_EXEC} setup.py install --prefix=/ &gt;&gt; \"$LOG_FILE\" 2&gt;&amp;1\n    fi\n    if [ $? -ne 0 -a -n \"$(${PYTHON_EXEC} -m pydoc setuptools | grep VERSION)\" ]; then\n        echo \"uninstall old setuptools, try to install setuptools again\"\n        fnSetuptoolsUnInstall\n        ${PYTHON_EXEC} setup.py install &gt;&gt; \"$LOG_FILE\" 2&gt;&amp;1\n    fi\n    fnResultCheck ${setuptools_name} $?\n}\n</code></pre> <p>\u8fdb\u4e00\u6b65\u4f7f\u7528 <code>bash -xv install-cloud-init.sh</code> \u6253\u5370 Shell \u811a\u672c\u8be6\u7ec6\u8c03\u8bd5\u4fe1\u606f\u5982\u4e0b\uff1a</p> <pre><code>++ fnSetuptoolsInstall\n++ '[' -e /etc/.productinfo ']'\n+++ grep -c Kylin /etc/.productinfo\n++ '[' 1 -ne 0 ']'\n+++ grep -c 'V10 (SP3)' /etc/.productinfo\n++ '[' 0 -ne 0 ']'\n++ setuptools_name=setuptools-65.6.3\n++ cd /opt/image-tools/linux/cloud-init/cloudinit_depend\n++ tar -xzvf setuptools-65.6.3.tar.gz\n++ cd /opt/image-tools/linux/cloud-init/cloudinit_depend/setuptools-65.6.3\n++ python3 bootstrap.py\n++ python3 setup.py install\n++ '[' 1 -ne 0 ']'\n++ echo 'setuptools install failed, try to install setuptools through specified directory'\nsetuptools install failed, try to install setuptools through specified directory\n++ python3 setup.py install --prefix=/\n+++ grep VERSION\n+++ python3 -m pydoc setuptools\n++ '[' 1 -ne 0 -a -n VERSION ']'\n++ echo 'uninstall old setuptools, try to install setuptools again'\nuninstall old setuptools, try to install setuptools again\n</code></pre> <p>\u8be5\u811a\u672c\u5b9e\u9645\u8fd0\u884c\u7684\u5b89\u88c5\u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code>python3 setup.py install --prefix=/\n</code></pre> <p>\u624b\u52a8\u6267\u884c\uff0c\u53d1\u73b0\u5f00\u6e90\u7248\u672c setuptools \u4e0d\u80fd\u5b89\u88c5\uff1a</p> <pre><code>[root@localhost setuptools-65.6.3]# python3 setup.py install\nTraceback (most recent call last):\n  File \"setup.py\", line 87, in &lt;module&gt;\n    dist = setuptools.setup(**setup_params)\n  File \"/opt/image-tools/linux/cloud-init/cloudinit_depend/setuptools-65.6.3/setuptools/__init__.py\", line 87, in setup\n    return distutils.core.setup(**attrs)\n  File \"/opt/image-tools/linux/cloud-init/cloudinit_depend/setuptools-65.6.3/setuptools/_distutils/core.py\", line 147, in setup\n    _setup_distribution = dist = klass(attrs)\n  File \"/opt/image-tools/linux/cloud-init/cloudinit_depend/setuptools-65.6.3/setuptools/dist.py\", line 479, in __init__\n    for k, v in attrs.items()\n  File \"/opt/image-tools/linux/cloud-init/cloudinit_depend/setuptools-65.6.3/setuptools/_distutils/dist.py\", line 283, in __init__\n    self.finalize_options()\n  File \"/opt/image-tools/linux/cloud-init/cloudinit_depend/setuptools-65.6.3/setuptools/dist.py\", line 898, in finalize_options\n    for ep in sorted(loaded, key=by_order):\n  File \"/opt/image-tools/linux/cloud-init/cloudinit_depend/setuptools-65.6.3/setuptools/dist.py\", line 897, in &lt;lambda&gt;\n    loaded = map(lambda e: e.load(), filtered)\n  File \"/opt/image-tools/linux/cloud-init/cloudinit_depend/setuptools-65.6.3/setuptools/_vendor/importlib_metadata/__init__.py\", line 196, in load\n    return functools.reduce(getattr, attrs, module)\nAttributeError: type object 'Distribution' has no attribute '_finalize_feature_opts'\n</code></pre> <p>\u5176\u4e2d\u62a5\u9519\u7684 python \u4ee3\u7801\u4f4d\u4e8e <code>/opt/image-tools/linux/cloud-init/cloudinit_depend/setuptools-65.6.3/setuptools/__init__.py</code> \uff1a</p> <pre><code>from setuptools.dist import Distribution\n</code></pre> <p>\u770b\u8d77\u6765\u50cf\u662f python \u5728\u5b89\u88c5\u65f6\u68c0\u67e5 Linux \u53d1\u884c\u7248\u7248\u672c\uff0c\u4e0d\u8bc6\u522b\u94f6\u6cb3\u9e92\u9e9f\u7cfb\u5217\u64cd\u4f5c\u7cfb\u7edf\u3002\u56e0\u6b64\u65ad\u5b9a\u9700\u8981\u5b89\u88c5\u9e92\u9e9f\u4fee\u6539\u540e\u7684 setuptools \u800c\u975e\u5f00\u6e90\u7248\u672c\u3002\u8fd9\u4e00\u70b9\u534e\u4e3a\u4e91\u5de5\u7a0b\u5e08\u5df2\u7ecf\u8003\u8651\u5230\u4e86\uff0c\u4ee3\u7801 <code>/opt/image-tools/linux/cloud-init/cloudinit_scripts/offdeploy-cloud-init.sh</code> \u91cc\u6709\u5bf9\u9e92\u9e9f\u64cd\u4f5c\u7cfb\u7edf\u7684\u5224\u65ad\uff1a</p> <pre><code># install python setuptools\nfnSetuptoolsInstall()\n{\n    # \u5f53\u524d\u4ec5\u9488\u5bf9Kylin V10 SP3\u8fdb\u884c\u7279\u6b8a\u5904\u7406\uff0c\u4f7f\u7528\u7cfb\u7edf\u81ea\u5e26\u7684setuptools\uff0c\u5176\u4ed6\u64cd\u4f5c\u7cfb\u7edf\u4ecd\u6cbf\u7528\u8001\u7684\u903b\u8f91\n    if [ -e /etc/.productinfo ] &amp;&amp; [ `grep -c \"Kylin\" /etc/.productinfo` -ne '0' ] &amp;&amp; [ `grep -c \"V10 (SP3)\" /etc/.productinfo` -ne '0' ]; then\n        hasInstallSetuptools=$(python -m pydoc setuptools | grep __version__)\n        if [ -n \"$hasInstallSetuptools\" ]; then\n                echo \"setuptools has already installed on this machine, skip install setuptools\"\n                return\n        fi\n    fi\n    setuptools_name=${setuptools_pkg}\n    cd \"${PKG_PATH}\" || exit\n    tar -xzvf ${setuptools_name}.tar.gz &gt;&gt; \"$LOG_FILE\" 2&gt;&amp;1\n    cd \"${PKG_PATH}\"/${setuptools_name} || exit\n    ${PYTHON_EXEC} bootstrap.py &gt;&gt; \"$LOG_FILE\" 2&gt;&amp;1\n    ${PYTHON_EXEC} setup.py install &gt;&gt; \"$LOG_FILE\" 2&gt;&amp;1\n\n    if [ $? -ne 0 ]; then\n        echo \"setuptools install failed, try to install setuptools through specified directory\"\n        ${PYTHON_EXEC} setup.py install --prefix=/ &gt;&gt; \"$LOG_FILE\" 2&gt;&amp;1\n    fi\n    if [ $? -ne 0 -a -n \"$(${PYTHON_EXEC} -m pydoc setuptools | grep VERSION)\" ]; then\n        echo \"uninstall old setuptools, try to install setuptools again\"\n        fnSetuptoolsUnInstall\n        ${PYTHON_EXEC} setup.py install &gt;&gt; \"$LOG_FILE\" 2&gt;&amp;1\n    fi\n    if [ $? -ne 0 ]; then\n        echo \"setuptools install failed, try to install setuptools 41.1.0\"\n        setuptools_pkg=\"setuptools-41.1.0\"\n        setuptools_name=${setuptools_pkg}\n        cd \"${PKG_PATH}\" || exit\n        tar -xzvf ${setuptools_name}.tar.gz &gt;&gt; \"$LOG_FILE\" 2&gt;&amp;1\n        cd \"${PKG_PATH}\"/${setuptools_name} || exit\n        ${PYTHON_EXEC} bootstrap.py &gt;&gt; \"$LOG_FILE\" 2&gt;&amp;1\n        ${PYTHON_EXEC} setup.py install &gt;&gt; \"$LOG_FILE\" 2&gt;&amp;1\n    fi\n    fnResultCheck ${setuptools_name} $?\n}\n</code></pre> <p>\u4f46\u662f\u6b64\u4ee3\u7801\u4ec5\u80fd\u5224\u65ad\u94f6\u6cb3\u9e92\u9e9f V10 SP3 \uff0c\u5b9e\u6d4b\u5224\u65ad\u547d\u4ee4\u5728 \u94f6\u6cb3\u9e92\u9e9f V10 SP4 \u4e0a\u8f93\u51fa\u5982\u4e0b\uff1a</p> <pre><code>[root@localhost linux]# grep -c \"V10 (SP3)\" /etc/.productinfo\n0\n[root@localhost linux]# cat /etc/.productinfo\nKylin Linux Advanced Server\nrelease V10 SP3 2403/(Halberd)-aarch64-Build20/20240426\n[root@localhost linux]# python -m pydoc setuptools | grep __version__\n-bash: python: command not found\n[root@localhost linux]# python3 -m pydoc setuptools | grep __version__\n[root@localhost linux]# python2 -m pydoc setuptools | grep __version__\n-bash: python2: command not found\n[root@localhost linux]# ls -lh /usr/bin/python\nls: cannot access '/usr/bin/python': No such file or directory\n[root@localhost linux]# ls -lh /usr/bin/python3\nlrwxrwxrwx 1 root root 9 Mar 18  2024 /usr/bin/python3 -&gt; python3.7\n</code></pre>"},{"location":"%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/%E5%8D%8E%E4%B8%BA%E4%BA%91/%E5%8D%8E%E4%B8%BAHCS%208%E4%B8%8E%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10SP4%20cloud-init%E9%80%82%E9%85%8D%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3.html#3","title":"3. \u89e3\u51b3\u65b9\u6cd5","text":"<p>\u4fee\u6539\u4e0a\u8ff0\u4ee3\u7801\uff0c\u52a0\u5165 SP4 \u7248\u672c\u5224\u65ad\u903b\u8f91\uff0c\u5c06\u4ee5\u4e0b\u4ee3\u7801\uff1a</p> <pre><code>    # \u5f53\u524d\u4ec5\u9488\u5bf9Kylin V10 SP3\u8fdb\u884c\u7279\u6b8a\u5904\u7406\uff0c\u4f7f\u7528\u7cfb\u7edf\u81ea\u5e26\u7684setuptools\uff0c\u5176\u4ed6\u64cd\u4f5c\u7cfb\u7edf\u4ecd\u6cbf\u7528\u8001\u7684\u903b\u8f91\n    if [ -e /etc/.productinfo ] &amp;&amp; [ `grep -c \"Kylin\" /etc/.productinfo` -ne '0' ] &amp;&amp; [ `grep -c \"V10 (SP3)\" /etc/.productinfo` -ne '0' ]; then\n        hasInstallSetuptools=$(python -m pydoc setuptools | grep __version__)\n        if [ -n \"$hasInstallSetuptools\" ]; then\n                echo \"setuptools has already installed on this machine, skip install setuptools\"\n                return\n        fi\n    fi\n</code></pre> <p>\u4fee\u6539\u4e3a\uff1a</p> <pre><code>    if [ -e /etc/.productinfo ] &amp;&amp; [ `grep -c \"Kylin\" /etc/.productinfo` -ne '0' ] &amp;&amp; [ `grep -cE \"V10 (SP3)|V10 SP3 2403\" /etc/.productinfo` -ne '0' ]; then\n        hasInstallSetuptools=$(${PYTHON_EXEC} -m pydoc setuptools | grep version)\n        if [ -n \"$hasInstallSetuptools\" ]; then\n                echo \"setuptools has already installed on this machine, skip install setuptools\"\n                return\n        fi\n    fi\n</code></pre> <p>\u5982\u679c\u9700\u8981\u4f7f\u7528 Shell \u811a\u672c\u81ea\u52a8\u5316\u4fee\u6539\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a</p> <pre><code>if [ -e /etc/.productinfo ] &amp;&amp; [ `grep -c \"Kylin\" /etc/.productinfo` -ne '0' ] &amp;&amp; [ `grep -cE \"V10 (SP3)|V10 SP3 2403\" /etc/.productinfo` -ne '0' ]; then\n    cp -f /opt/image-tools/linux/cloud-init/cloudinit_scripts/offdeploy-cloud-init.sh /opt/image-tools/linux/cloud-init/cloudinit_scripts/offdeploy-cloud-init.sh.bak\n    chmod +w /opt/image-tools/linux/cloud-init/cloudinit_scripts/offdeploy-cloud-init.sh\n    sed -i 's/grep -c \"V10 (SP3)\" \\/etc\\/.productinfo/grep -cE \"V10 (SP3)|V10 SP3 2403\" \\/etc\\/.productinfo/' /opt/image-tools/linux/cloud-init/cloudinit_scripts/offdeploy-cloud-init.sh\n    sed -i 's/python -m pydoc setuptools | grep __version__/${PYTHON_EXEC} -m pydoc setuptools | grep version/' /opt/image-tools/linux/cloud-init/cloudinit_scripts/offdeploy-cloud-init.sh\n    diff /opt/image-tools/linux/cloud-init/cloudinit_scripts/offdeploy-cloud-init.sh /opt/image-tools/linux/cloud-init/cloudinit_scripts/offdeploy-cloud-init.sh.bak\nfi\n</code></pre> <p>\u4e4b\u540e\u91cd\u65b0\u5b89\u88c5 cloud-init \u3002</p>"},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX-23.9%E4%BD%BF%E7%94%A8SAML%E5%AF%B9%E6%8E%A5Keycloak-24%E8%AE%A4%E8%AF%81.html","title":"AWX-23.9 \u4f7f\u7528 SAML \u5bf9\u63a5 Keycloak-24 \u8ba4\u8bc1","text":"","tags":["Keycloak","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX-23.9%E4%BD%BF%E7%94%A8SAML%E5%AF%B9%E6%8E%A5Keycloak-24%E8%AE%A4%E8%AF%81.html#1-ssl","title":"1. \u751f\u6210 SSL \u8bc1\u4e66","text":"<p>\u5728\u4efb\u610f Linux \u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u751f\u6210 SSL \u8bc1\u4e66\uff1a</p> <pre><code>openssl req -subj \"/C=CN/ST=Beijing/L=Haidian/O=awx.hxp.lan/CN=awx.hxp.lan\" -sha256 -newkey rsa:2048 -nodes -keyout key.pem -x509 -days 3650 -out certificate.pem\n</code></pre> <p>\u6b64 SSL \u8bc1\u4e66\u76f4\u63a5\u7533\u8bf7\u4e86 10 \u5e74\u6709\u6548\u671f\u3002\u8bb0\u5f97\u5728 10 \u5e74\u540e\u66f4\u65b0\u3002</p>","tags":["Keycloak","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX-23.9%E4%BD%BF%E7%94%A8SAML%E5%AF%B9%E6%8E%A5Keycloak-24%E8%AE%A4%E8%AF%81.html#2-awx","title":"2. \u4fee\u6539 AWX \u914d\u7f6e","text":"<p>\u70b9\u51fb <code>\u8bbe\u7f6e</code> -&gt; <code>\u6742\u9879\u7cfb\u7edf</code> \uff0c\u4fee\u6539 <code>\u670d\u52a1\u7684\u57fa\u672c URL</code> \u4e3a AWX \u7684\u516c\u7f51 URL\uff1a</p> <p></p>","tags":["Keycloak","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX-23.9%E4%BD%BF%E7%94%A8SAML%E5%AF%B9%E6%8E%A5Keycloak-24%E8%AE%A4%E8%AF%81.html#3-awx-saml","title":"3. \u5728 AWX \u4e0a\u914d\u7f6e SAML \u8ba4\u8bc1","text":"<p>\u70b9\u51fb <code>\u8bbe\u7f6e</code> -&gt; <code>SAML</code> \uff0c\u586b\u5199 Keycloak SAML \u670d\u52a1\u5668\u914d\u7f6e\uff1a</p>","tags":["Keycloak","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX-23.9%E4%BD%BF%E7%94%A8SAML%E5%AF%B9%E6%8E%A5Keycloak-24%E8%AE%A4%E8%AF%81.html#31-saml-id","title":"3.1 SAML \u670d\u52a1\u63d0\u4f9b\u5546\u5b9e\u4f53 ID","text":"<p>\u586b\u5199 <code>awx-saml</code></p>","tags":["Keycloak","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX-23.9%E4%BD%BF%E7%94%A8SAML%E5%AF%B9%E6%8E%A5Keycloak-24%E8%AE%A4%E8%AF%81.html#32-saml","title":"3.2 SAML \u670d\u52a1\u63d0\u4f9b\u5546\u516c\u5171\u8bc1\u4e66","text":"<p>\u4e0a\u4f20\u751f\u6210\u7684\u8bc1\u4e66 <code>certificate.pem</code></p>","tags":["Keycloak","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX-23.9%E4%BD%BF%E7%94%A8SAML%E5%AF%B9%E6%8E%A5Keycloak-24%E8%AE%A4%E8%AF%81.html#33-saml","title":"3.3 SAML \u670d\u52a1\u63d0\u4f9b\u5546\u79c1\u94a5","text":"<p>\u4e0a\u4f20\u751f\u6210\u7684\u5bc6\u94a5 <code>key.pem</code></p>","tags":["Keycloak","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX-23.9%E4%BD%BF%E7%94%A8SAML%E5%AF%B9%E6%8E%A5Keycloak-24%E8%AE%A4%E8%AF%81.html#34-saml","title":"3.4 SAML \u670d\u52a1\u63d0\u4f9b\u5546\u673a\u6784\u4fe1\u606f","text":"<p>\u586b\u5199\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>{\n  \"en-US\": {\n    \"displayname\": \"Keycloak\",\n    \"name\": \"Keycloak\",\n    \"url\": \"http://keycloak.hxp.lan:30081/\"\n  }\n}\n</code></pre>","tags":["Keycloak","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX-23.9%E4%BD%BF%E7%94%A8SAML%E5%AF%B9%E6%8E%A5Keycloak-24%E8%AE%A4%E8%AF%81.html#35-saml","title":"3.5 SAML \u670d\u52a1\u63d0\u4f9b\u5546\u6280\u672f\u8054\u7cfb\u4eba","text":"<p>\u586b\u5199\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>{\n  \"emailAddress\": \"awx@example.com\",\n  \"givenName\": \"awx\"\n}\n</code></pre>","tags":["Keycloak","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX-23.9%E4%BD%BF%E7%94%A8SAML%E5%AF%B9%E6%8E%A5Keycloak-24%E8%AE%A4%E8%AF%81.html#36-saml","title":"3.6 SAML \u670d\u52a1\u63d0\u4f9b\u5546\u652f\u6301\u8054\u7cfb\u4eba","text":"<p>\u586b\u5199\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>{\n  \"emailAddress\": \"awx@example.com\",\n  \"givenName\": \"awx\"\n}\n</code></pre>","tags":["Keycloak","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX-23.9%E4%BD%BF%E7%94%A8SAML%E5%AF%B9%E6%8E%A5Keycloak-24%E8%AE%A4%E8%AF%81.html#37-saml","title":"3.7 SAML \u542f\u7528\u7684\u8eab\u4efd\u63d0\u4f9b\u5546","text":"<p>\u586b\u5199\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>{\n  \"Keycloak\": {\n    \"attr_email\": \"email\",\n    \"attr_first_name\": \"first_name\",\n    \"attr_last_name\": \"last_name\",\n    \"attr_user_permanent_id\": \"name_id\",\n    \"attr_username\": \"username\",\n    \"entity_id\": \"http://keycloak.hxp.lan:30081/realms/awx\",\n    \"url\": \"http://keycloak.hxp.lan:30081/realms/awx/protocol/saml\",\n    \"x509cert\": \"-----BEGIN CERTIFICATE-----MIIDaz*****X7Z-----END CERTIFICATE-----\"\n  }\n}\n</code></pre> <p>x509cert \u5185\u5bb9\u8fd9\u6837\u751f\u6210\uff1a</p> <pre><code>sed ':a;N;$!ba;s/\\n//g' certificate.pem | sed 's/^-----BEGIN CERTIFICATE-----//;s/-----END CERTIFICATE-----$//'\n</code></pre>","tags":["Keycloak","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX-23.9%E4%BD%BF%E7%94%A8SAML%E5%AF%B9%E6%8E%A5Keycloak-24%E8%AE%A4%E8%AF%81.html#38-saml","title":"3.8 SAML \u673a\u6784\u6620\u5c04","text":"<pre><code>{\n  \"Default\": {\n    \"users\": true\n  },\n  \"Keycloak\": {\n    \"admins\": [],\n    \"remove_admins\": false,\n    \"remove_users\": false,\n    \"users\": true\n  }\n}\n</code></pre>","tags":["Keycloak","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX-23.9%E4%BD%BF%E7%94%A8SAML%E5%AF%B9%E6%8E%A5Keycloak-24%E8%AE%A4%E8%AF%81.html#39-saml","title":"3.9 SAML \u673a\u6784\u5c5e\u6027\u6620\u5c04","text":"<p>\u9ed8\u8ba4\u503c</p>","tags":["Keycloak","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX-23.9%E4%BD%BF%E7%94%A8SAML%E5%AF%B9%E6%8E%A5Keycloak-24%E8%AE%A4%E8%AF%81.html#310-saml","title":"3.10 SAML \u56e2\u961f\u6620\u5c04","text":"<p>\u9ed8\u8ba4\u503c</p>","tags":["Keycloak","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX-23.9%E4%BD%BF%E7%94%A8SAML%E5%AF%B9%E6%8E%A5Keycloak-24%E8%AE%A4%E8%AF%81.html#311-saml","title":"3.11 SAML \u56e2\u961f\u5c5e\u6027\u6620\u5c04","text":"<p>\u9ed8\u8ba4\u503c</p>","tags":["Keycloak","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX-23.9%E4%BD%BF%E7%94%A8SAML%E5%AF%B9%E6%8E%A5Keycloak-24%E8%AE%A4%E8%AF%81.html#312-saml-user-flags-attribute-mapping","title":"3.12 SAML User Flags Attribute Mapping","text":"<p>\u9ed8\u8ba4\u503c</p>","tags":["Keycloak","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX-23.9%E4%BD%BF%E7%94%A8SAML%E5%AF%B9%E6%8E%A5Keycloak-24%E8%AE%A4%E8%AF%81.html#313-saml","title":"3.13 SAML \u5b89\u5168\u914d\u7f6e","text":"<p>\u9ed8\u8ba4\u503c</p>","tags":["Keycloak","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX-23.9%E4%BD%BF%E7%94%A8SAML%E5%AF%B9%E6%8E%A5Keycloak-24%E8%AE%A4%E8%AF%81.html#314-saml","title":"3.14 SAML \u670d\u52a1\u63d0\u4f9b\u5546\u989d\u5916\u914d\u7f6e\u6570\u636e","text":"<p>\u9ed8\u8ba4\u503c</p>","tags":["Keycloak","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX-23.9%E4%BD%BF%E7%94%A8SAML%E5%AF%B9%E6%8E%A5Keycloak-24%E8%AE%A4%E8%AF%81.html#315-saml-idp-extra_data","title":"3.15 SAML IDP \u5230 extra_data \u5c5e\u6027\u6620\u5c04","text":"<p>\u9ed8\u8ba4\u503c</p>","tags":["Keycloak","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX-23.9%E4%BD%BF%E7%94%A8SAML%E5%AF%B9%E6%8E%A5Keycloak-24%E8%AE%A4%E8%AF%81.html#4-saml-keycloak","title":"4. \u83b7\u53d6 SAML \u914d\u7f6e\u5e76\u5bfc\u5165 Keycloak","text":"<p>\u5728 AWX \u4e0a\u5b8c\u6210 SAML \u914d\u7f6e\u540e\uff0c\u914d\u7f6e\u9875\u9762\u4e0a <code>SAML \u670d\u52a1\u63d0\u4f9b\u5546\u5143\u6570\u636e URL</code> \u53ef\u4e0b\u8f7d SAML \u914d\u7f6e\uff0c\u4e0b\u8f7d\u6b64\u914d\u7f6e\u540e\uff0c\u5728 Keycloak \u4e0a\u65b0\u5efa Realm \u540d\u79f0 awx \uff0c\u70b9\u51fb <code>Clients</code> -&gt; <code>Import client</code> \u5c06\u6b64\u914d\u7f6e\u5bfc\u5165\uff1a</p> <p></p> <p>\u5bfc\u5165\u914d\u7f6e\u65f6\u9700\u8981\u5c06 <code>Client signature required</code> \u5173\u95ed\u3002</p>","tags":["Keycloak","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX-23.9%E4%BD%BF%E7%94%A8SAML%E5%AF%B9%E6%8E%A5Keycloak-24%E8%AE%A4%E8%AF%81.html#5-keycloak","title":"5. Keycloak \u5bfc\u5165\u8bc1\u4e66","text":"<p>\u81ea\u7b7e\u7684 SSL \u8bc1\u4e66\u9700\u8981\u5bfc\u5165\u5230 Keycloak \uff0c\u70b9\u51fb <code>Realm Settings</code> -&gt; <code>Keys</code> -&gt; <code>Add provider</code> \u6dfb\u52a0\u7c7b\u578b\u4e3a <code>rsa</code> \u7684\u5bc6\u94a5\uff1a</p> <p></p> <p>\u9009\u62e9\u8bc1\u4e66\u548c\u5bc6\u94a5\u5e76\u4fdd\u5b58\uff1a</p> <p></p> <p>\u6ce8\u610f\u8fd9\u91cc\u7684\u4f18\u5148\u7ea7\u5fc5\u987b\u8db3\u591f\u5927\u3002</p>","tags":["Keycloak","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX-23.9%E4%BD%BF%E7%94%A8SAML%E5%AF%B9%E6%8E%A5Keycloak-24%E8%AE%A4%E8%AF%81.html#6-keycloak","title":"6. Keycloak \u914d\u7f6e\u7528\u6237\u4fe1\u606f\u6620\u5c04","text":"<p>\u8fdb\u5165 <code>Client scopes</code> -&gt; <code>role_list</code> -&gt; <code>Mappers</code> -&gt; <code>Add mapper</code> -&gt; <code>By configuration</code> \uff0c\u521b\u5efa\u5982\u4e0b <code>User Attribute</code> \u6620\u5c04\uff1a</p> <p></p> <p>\u521b\u5efa\u5982\u4e0b <code>User Property</code> \u6620\u5c04\uff1a</p> <p></p> <p></p> <p></p> <p></p> <p>\u8fdb\u5165 <code>Client scopes</code> -&gt; <code>role_list</code> -&gt; <code>Mappers</code> -&gt; <code>role list</code> \uff0c\u5f00\u542f <code>Single Role Attribute</code> \u9009\u9879\uff1a</p> <p></p>","tags":["Keycloak","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX-23.9%E4%BD%BF%E7%94%A8SAML%E5%AF%B9%E6%8E%A5Keycloak-24%E8%AE%A4%E8%AF%81.html#7","title":"7. \u767b\u5f55\u9a8c\u8bc1","text":"<p>\u5b8c\u6210\u4ee5\u540e\uff0c\u53bb AWX \u70b9\u51fb\u8fd9\u91cc\u767b\u5f55\uff1a</p> <p></p> <p>\u6d4b\u8bd5\u7528\u6237\u540d\u3001\u7535\u5b50\u90ae\u7bb1\u3001\u59d3\u540d\u80fd\u5426\u6b63\u5e38\u83b7\u53d6\uff1a</p> <p></p>","tags":["Keycloak","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX-23.9%E4%BD%BF%E7%94%A8SAML%E5%AF%B9%E6%8E%A5Keycloak-24%E8%AE%A4%E8%AF%81.html#8","title":"8. \u5176\u5b83\u8bbe\u7f6e","text":"<p>\u53ef\u4ee5\u5728 <code>\u8bbe\u7f6e</code> -&gt; <code>\u5176\u5b83\u8eab\u4efd\u9a8c\u8bc1</code> \u91cc\u8bbe\u7f6e <code>\u767b\u5f55\u91cd\u5b9a\u5411\u8986\u5199 URL</code> \u4e3a <code>/sso/login/saml/?idp=Keycloak</code> \u6765\u8ba9 Keycloak SAML \u4e3a\u9ed8\u8ba4\u767b\u9646\u9009\u9879\u3002</p>","tags":["Keycloak","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX-23.9%E4%BD%BF%E7%94%A8SAML%E5%AF%B9%E6%8E%A5Keycloak-24%E8%AE%A4%E8%AF%81.html#9","title":"9. \u53c2\u8003\u6587\u732e","text":"<p>https://dev.to/rpelisse/automate-your-sso-with-ansible-and-keycloak-o1k</p> <p>https://docs.ansible.com/ansible-tower/latest/html/administration/ent_auth.html#saml-authentication-settings</p> <p>https://github.com/ansible/awx/issues/5570</p> <p>https://github.com/ansible/awx/issues/1016</p> <p>https://github.com/ansible/awx/issues/4814</p> <p>https://github.com/ansible/awx/issues/13226</p> <p>https://www.ansible.com/blog/red-hat-single-sign-on-integration-with-ansible-tower</p> <p>https://dev.to/iderr/connect-your-awxansible-tower-with-keycloak-using-oidc--4ekb</p> <p>https://josh-tracy.github.io/Ansible_Tower_RedHatSSO/</p> <p>https://github.com/getsentry/self-hosted/issues/1571</p> <p>https://rdeplatform.netlify.app/docs/single%20sign-on%20with%20keycloak/ integration%20with%20awx/</p> <p>https://number1.co.za/using-keycloak-as-the-identity-provider-for-awx/</p> <p>https://docs.ansible.com/ansible-tower/latest/html/administration/social_auth.html</p>","tags":["Keycloak","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX%E5%92%8Cstolon%E9%AB%98%E5%8F%AF%E7%94%A8%E8%B0%83%E4%BC%98.html","title":"AWX \u548c stolon \u9ad8\u53ef\u7528\u8c03\u4f18","text":"","tags":["Kubernetes","PostgreSQL","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX%E5%92%8Cstolon%E9%AB%98%E5%8F%AF%E7%94%A8%E8%B0%83%E4%BC%98.html#1-k8s-awx-stolon","title":"1. K8S \u6545\u969c\u540e AWX \u548c stolon \u5207\u6362\u65f6\u95f4\u8fc7\u957f\u95ee\u9898\u89e3\u51b3\u65b9\u6848","text":"<p>\u5728 k8s \u4e0a\u5b89\u88c5\u5b8c\u6210 AWX \u540e\uff0c\u5b9e\u9645\u6d4b\u8bd5\u53d1\u73b0\u5728\u8282\u70b9\u6545\u969c\u65f6\u5207\u6362\u65f6\u95f4\u8fc7\u957f\uff0c\u8fd9\u662f\u56e0\u4e3a k8s \u9ed8\u8ba4\u8bbe\u7f6e\u91cc\uff0c\u5f53\u4e00\u4e2a k8s \u8282\u70b9 unreachable \u6216\u8005 not-ready \u65f6\uff0c\u5bb9\u5668\u4f1a\u5bb9\u5fcd\u8fd9\u4e2a\u8282\u70b9 5 \u5206\u949f\u624d\u4f1a\u81ea\u52a8\u6f02\u79fb\u3002\u53ef\u4ee5\u4fee\u6539\u4e3a\u66f4\u77ed\u7684\u65f6\u95f4\uff0c\u4f8b\u5982 10 \u79d2\u3002\u9700\u8981\u4fee\u6539<code>awx.yaml</code>\u7684<code>tolerations</code>\u3002\u540c\u65f6\uff0c\u4e3a\u4e86\u9632\u6b62\u5bb9\u5668\u88ab\u8c03\u5ea6\u5230\u76f8\u540c\u7684\u8282\u70b9\u4e0a\uff0c\u9700\u8981\u4fee\u6539<code>task_topology_spread_constraints</code>\u548c<code>web_topology_spread_constraints</code>\uff1a</p> <pre><code>---\napiVersion: awx.ansible.com/v1beta1\nkind: AWX\nmetadata:\nspec:\n  task_topology_spread_constraints: |\n    - maxSkew: 1\n      topologyKey: kubernetes.io/hostname\n      whenUnsatisfiable: DoNotSchedule\n      labelSelector:\n        matchLabels:\n          app.kubernetes.io/name: \"awx-task\"\n  web_topology_spread_constraints: |\n    - maxSkew: 1\n      topologyKey: kubernetes.io/hostname\n      whenUnsatisfiable: DoNotSchedule\n      labelSelector:\n        matchLabels:\n          app.kubernetes.io/name: \"awx-web\"\n  tolerations: |\n    - key: \"node.kubernetes.io/not-ready\"\n      operator: \"Exists\"\n      effect: \"NoExecute\"\n      tolerationSeconds: 10\n    - key: \"node.kubernetes.io/unreachable\"\n      operator: \"Exists\"\n      effect: \"NoExecute\"\n      tolerationSeconds: 10\n</code></pre> <p>\u4fee\u6539\u4e4b\u540e\u91cd\u65b0 apply \u4e0b\u8fd9\u4e2a yaml \u6587\u4ef6\u751f\u6548\u3002\u540c\u65f6\uff0cstolon \u4e5f\u6709\u540c\u6837\u7684\u95ee\u9898\uff0c\u9700\u8981\u4fee\u6539<code>stolon-keeper.yaml</code>\u3001<code>stolon-proxy.yaml</code> \u548c<code>stolon-sentinel.yaml</code>\uff0c\u4ee5<code>stolon-proxy.yaml</code>\u4e3a\u4f8b\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: stolon-proxy\nspec:\n  selector:\n    matchLabels:\n      component: stolon-proxy\n      ...\n  template:\n    ...\n    spec:\n      topologySpreadConstraints:\n        - maxSkew: 1\n          topologyKey: kubernetes.io/hostname\n          whenUnsatisfiable: DoNotSchedule\n          labelSelector:\n            matchLabels:\n              component: stolon-proxy\n      tolerations:\n        - key: \"node.kubernetes.io/not-ready\"\n          operator: \"Exists\"\n          effect: \"NoExecute\"\n          tolerationSeconds: 10\n        - key: \"node.kubernetes.io/unreachable\"\n          operator: \"Exists\"\n          effect: \"NoExecute\"\n          tolerationSeconds: 10\n</code></pre>","tags":["Kubernetes","PostgreSQL","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX%E5%92%8Cstolon%E9%AB%98%E5%8F%AF%E7%94%A8%E8%B0%83%E4%BC%98.html#2","title":"2. \u53c2\u8003\u94fe\u63a5","text":"<p>https://github.com/ansible/awx-operator/blob/0d1fa239a56c55202167cb833a72f495928442fc/docs/user-guide/advanced-configuration/assigning-awx-pods-to-specific-nodes.md?plain=1#L20</p>","tags":["Kubernetes","PostgreSQL","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX%E5%A2%9E%E5%8A%A0%E5%B9%B6%E4%BD%BF%E7%94%A8token.html","title":"AWX \u589e\u52a0\u5e76\u4f7f\u7528 token","text":"","tags":["AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX%E5%A2%9E%E5%8A%A0%E5%B9%B6%E4%BD%BF%E7%94%A8token.html#1-token","title":"1. \u521b\u5efa Token","text":"","tags":["AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX%E5%A2%9E%E5%8A%A0%E5%B9%B6%E4%BD%BF%E7%94%A8token.html#11-token","title":"1.1 \u4e3a\u81ea\u5df1\u521b\u5efa Token","text":"<p>\u8bbf\u95ee AWX \u7684 API Web \u9875\u9762\uff1ahttp://awx.hxp.lan:30623/awx/api/v2/tokens/\uff0c\u62c9\u5230\u6700\u5e95\u4e0b\uff0c\u70b9\u4e0b\u201cPOST\u201d\uff0c\u628a\u8fd4\u56de\u7684 token \u8bb0\u5f55\u4e0b\u6765\u3002</p>","tags":["AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX%E5%A2%9E%E5%8A%A0%E5%B9%B6%E4%BD%BF%E7%94%A8token.html#12-token","title":"1.2 \u4e3a\u522b\u7684\u7528\u6237\u521b\u5efa Token","text":"<p>\u4f7f\u7528 POST \u8bf7\u6c42\u8c03\u7528\u6b64\u63a5\u53e3\u521b\u5efa Token \uff1a</p> <p>&lt;http://awx.hxp.lan:30623/api/v2/users/&lt;\u7528\u6237ID&gt;/personal_tokens/&gt;</p>","tags":["AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX%E5%A2%9E%E5%8A%A0%E5%B9%B6%E4%BD%BF%E7%94%A8token.html#2-token","title":"2. Token \u4f7f\u7528\u793a\u4f8b","text":"<p>\u4f7f\u7528 token \u7684 shell \u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>export TOKEN=WYWAiswJYBsQUqQBXsfGnOn4a52CaC\ncurl -s -X GET -H \"Authorization: Bearer $TOKEN\" -H \"Content-Type: application/json\" http://awx.hxp.lan:30623/awx/api/v2/inventories/\n</code></pre> <p>python \u793a\u4f8b\uff1a</p> <pre><code>#!/usr/bin/python3\n# -*- coding: utf-8 -*-\nimport json,sys,requests\ntoken=\"WYWAiswJYBsQUqQBXsfGnOn4a52CaC\"\nendpoint=\"http://awx.hxp.lan:30623/awx/api/v2/\"\nheaders={ \"Authorization\": \"Bearer %s\" %token ,\"Content-Type\": \"application/json\"}\ninventories=requests.get(endpoint+\"inventories?search=C-PSI\", headers=headers)\nfor i in inventories.json()[\"results\"]:\n    print(i)\n</code></pre>","tags":["AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX%E5%A2%9E%E5%8A%A0%E5%B9%B6%E4%BD%BF%E7%94%A8token.html#3","title":"3. \u53c2\u8003\u8d44\u6599","text":"<p>API \u53c2\u8003\u624b\u518c\uff1ahttps://docs.ansible.com/ansible-tower/latest/html/towerapi/api_ref.html</p>","tags":["AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX%E6%96%B0%E5%A2%9E%E5%AE%B9%E5%99%A8%E7%BB%84.html","title":"AWX \u65b0\u589e\u5bb9\u5668\u7ec4","text":""},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX%E6%96%B0%E5%A2%9E%E5%AE%B9%E5%99%A8%E7%BB%84.html#1","title":"1. \u9700\u8981\u4e0b\u8f7d\u7684\u6587\u4ef6","text":"<ol> <li>containergroup-sa.yml : https://docs.ansible.com/automation-controller/latest/html/administration/_downloads/7a0708e6c2113e9601bf252270fa6c50/containergroup-sa.yml</li> </ol>"},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX%E6%96%B0%E5%A2%9E%E5%AE%B9%E5%99%A8%E7%BB%84.html#2-namespace-service-account","title":"2. \u521b\u5efa namespace \u548c service account","text":"<p>containergroup-sa.yml \u4fee\u6539\u5982\u4e0b\uff1a</p> <pre><code>---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: awx-service-account\n  namespace: awx\n---\nkind: Role\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: role-awx-service-account\n  namespace: awx\nrules:\n- apiGroups: [\"\"]\n  resources: [\"pods\"]\n  verbs: [\"get\", \"list\", \"watch\", \"create\", \"update\", \"patch\", \"delete\"]\n- apiGroups: [\"\"]\n  resources: [\"pods/log\"]\n  verbs: [\"get\", \"list\", \"watch\", \"create\", \"update\", \"patch\", \"delete\"]\n- apiGroups: [\"\"]\n  resources: [\"pods/attach\"]\n  verbs: [\"get\", \"list\", \"watch\", \"create\", \"update\", \"patch\", \"delete\"]\n---\nkind: RoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: role-awx-service-account-binding\n  namespace: awx\nsubjects:\n- kind: ServiceAccount\n  name: awx-service-account\n  namespace: awx\nroleRef:\n  kind: Role\n  name: role-awx-service-account\n  apiGroup: rbac.authorization.k8s.io\n</code></pre> <p>\u5e94\u7528\u8d44\u6e90\uff1a</p> <pre><code>kubectl create ns awx\nkubectl apply -f containergroup-sa.yml\n</code></pre>"},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX%E6%96%B0%E5%A2%9E%E5%AE%B9%E5%99%A8%E7%BB%84.html#3-service-account-token","title":"3. \u4e3a service account \u521b\u5efa token","text":"<pre><code>kubectl -n awx apply -f - &lt;&lt;EOF\napiVersion: v1\nkind: Secret\nmetadata:\n  name: awx-secret\n  annotations:\n    kubernetes.io/service-account.name: awx-service-account\ntype: kubernetes.io/service-account-token\nEOF\n</code></pre>"},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX%E6%96%B0%E5%A2%9E%E5%AE%B9%E5%99%A8%E7%BB%84.html#4-token","title":"4. \u83b7\u53d6 token \u548c\u8bc1\u4e66","text":"<pre><code># \u83b7\u53d6token\nkubectl -n awx get secrets awx-secret -o jsonpath='{.data.token}'|base64 -d;echo\n# \u83b7\u53d6\u8bc1\u4e66\nkubectl -n awx get secrets awx-secret -o jsonpath='{.data.ca\\.crt}'|base64 -d;echo\n</code></pre>"},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX%E6%96%B0%E5%A2%9E%E5%AE%B9%E5%99%A8%E7%BB%84.html#5-awx","title":"5. \u5728 AWX \u4e0a\u914d\u7f6e\u51ed\u8bc1","text":"<p>\u70b9\u51fb Resources -&gt; Credentials \uff0c\u65b0\u589e\u51ed\u8bc1\uff0c\u7c7b\u578b \u201cOpenShift or Kubernetes API Bearer Token\u201d\uff0cAPI endpoint \u4e3a k8s \u7684 apiserver endpoint\uff0c\u5728 k3s \u4e2d\u4e3a https://IP \u5730\u5740:6443\uff0ctoken \u548c CA \u8bc1\u4e66\u4e3a\u521a\u521a\u83b7\u53d6\u7684\u503c\uff0cVerify SSL \u9009 false\u3002</p>"},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX%E6%96%B0%E5%A2%9E%E5%AE%B9%E5%99%A8%E7%BB%84.html#6","title":"6. \u52a0\u5165\u5b9e\u4f8b\u7ec4","text":"<p>\u70b9\u51fb Administration -&gt; Instance Groups \uff0c\u70b9\u51fb Add -&gt; Add container group\uff0cCredential \u4e3a\u4e4b\u524d\u914d\u7f6e\u7684\u51ed\u8bc1\uff0cCutson pod spec \u4e2d\uff0cserviceAccountName \u548c namespace \u6309\u9700\u4fee\u6539\u4e3a awx-service-account \u548c awx\u3002</p>"},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX%E6%96%B0%E5%A2%9E%E5%AE%B9%E5%99%A8%E7%BB%84.html#7","title":"7. \u53c2\u8003\u94fe\u63a5","text":"<p>https://docs.ansible.com/automation-controller/latest/html/administration/containers_instance_groups.html</p>"},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX%E8%AE%BE%E7%BD%AESAML%E8%AE%A4%E8%AF%81%E7%94%A8%E6%88%B7%E4%B8%BA%E7%AE%A1%E7%90%86%E5%91%98.html","title":"AWX \u8bbe\u7f6e SAML \u8ba4\u8bc1\u7528\u6237\u4e3a\u7ba1\u7406\u5458","text":"","tags":["AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX%E8%AE%BE%E7%BD%AESAML%E8%AE%A4%E8%AF%81%E7%94%A8%E6%88%B7%E4%B8%BA%E7%AE%A1%E7%90%86%E5%91%98.html#1-awx-saml","title":"1. AWX \u521b\u5efa SAML \u7528\u6237\u4e3a\u7ba1\u7406\u5458","text":"<ol> <li>Keycloak \u4e0a\uff0c\u521b\u5efa\u4e00\u4e2a role\uff1aawx_admin    </li> <li>Keycloak \u4e0a\uff0c\u5c06 awx_system_admin \u52a0\u5165\u8fd9\u4e2a role    </li> <li>AWX \u4e0a\uff0c\u4fee\u6539 AWX \u7684 \u201cSAML User Flags Attribute Mapping\u201d    </li> </ol>","tags":["AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/%E4%BD%BF%E7%94%A8stolon%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8PostgreSQL.html","title":"\u4f7f\u7528 stolon \u5b89\u88c5\u9ad8\u53ef\u7528 PostgreSQL","text":"","tags":["Kubernetes","PostgreSQL"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/%E4%BD%BF%E7%94%A8stolon%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8PostgreSQL.html#1","title":"1. \u51c6\u5907\u5de5\u4f5c","text":"<p>stolon \u662f\u4e00\u79cd\u5b89\u88c5\u5728 kubernetes \u7684 PostgreSQL \u6570\u636e\u5e93\uff0c\u56e0\u6b64\u9700\u8981\u4e00\u5957\u5b8c\u6574\u7684 k8s \u96c6\u7fa4\uff0c\u4e14\u5fc5\u987b\u6709\u81f3\u5c11 1 \u4e2a StorageClass\uff0c\u63a8\u8350\u662f local-path-provisioner\u3002</p>","tags":["Kubernetes","PostgreSQL"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/%E4%BD%BF%E7%94%A8stolon%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8PostgreSQL.html#2","title":"2. \u4e0b\u8f7d\u914d\u7f6e\u6587\u4ef6","text":"<p>\u4ee5\u4e0b stolon \u914d\u7f6e\u6587\u4ef6\u6839\u636e https://github.com/sorintlab/stolon/tree/master/examples/kubernetes \u7684\u914d\u7f6e\u6587\u4ef6\u4fee\u6539\uff0c\u628a namespace \u6539\u6210 stolon\uff0cimage \u4fee\u6539\u4e3a sorintlab/stolon:v0.17.0-pg13</p>","tags":["Kubernetes","PostgreSQL"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/%E4%BD%BF%E7%94%A8stolon%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8PostgreSQL.html#3-service-account","title":"3. \u65b0\u589e service account","text":"<p>\u521b\u5efa role.yaml\uff1a</p> <pre><code># This is an example and generic rbac role definition for stolon. It could be\n# fine tuned and split per component.\n# The required permission per component should be:\n# keeper/proxy/sentinel: update their own pod annotations\n# sentinel/stolonctl: get, create, update configmaps\n# sentinel/stolonctl: list components pods\n# sentinel/stolonctl: get components pods annotations\n\napiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\n  name: stolon\n  namespace: stolon\nrules:\n  - apiGroups:\n      - \"\"\n    resources:\n      - pods\n      - configmaps\n      - events\n    verbs:\n      - \"*\"\n</code></pre> <p>\u521b\u5efa role-binding.yaml\uff1a</p> <pre><code>apiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\n  name: stolon\n  namespace: stolon\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: Role\n  name: stolon\nsubjects:\n  - kind: ServiceAccount\n    name: default\n    namespace: stolon\n</code></pre> <p>\u65b0\u589e service account\uff1a</p> <pre><code>kubectl create namespace stolon\nkubectl apply -f role.yaml -f role-binding.yaml\n</code></pre>","tags":["Kubernetes","PostgreSQL"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/%E4%BD%BF%E7%94%A8stolon%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8PostgreSQL.html#4-stolon-configmap","title":"4. \u521b\u5efa stolon \u96c6\u7fa4\u7684 configmap","text":"<pre><code>kubectl -n stolon run -i -t stolonctl --image=sorintlab/stolon:v0.17.0-pg13 --restart=Never --rm -- /usr/local/bin/stolonctl --cluster-name=kube-stolon --store-backend=kubernetes --kube-resource-kind=configmap init\n</code></pre>","tags":["Kubernetes","PostgreSQL"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/%E4%BD%BF%E7%94%A8stolon%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8PostgreSQL.html#5-stolon","title":"5. \u521b\u5efa stolon \u5b9e\u4f8b","text":"<p>\u83b7\u53d6\u96c6\u7fa4\u7684 storage class \u4fe1\u606f\uff1a</p> <pre><code>kubectl get storageclasses.storage.k8s.io\n</code></pre> <pre><code>NAME            PROVISIONER           RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE\ncsi-cephfs-sc   cephfs.csi.ceph.com   Delete\n</code></pre> <p>\u4f7f\u7528 csi-cephfs-sc \u4f5c\u4e3a storage class\uff0c\u4fee\u6539 stolon-keeper.yaml\uff1a</p> <pre><code>volumeClaimTemplates:\n  - metadata:\n      name: data\n      annotations:\n        volume.alpha.kubernetes.io/storage-class: csi-cephfs-sc\n    spec:\n      accessModes: [\"ReadWriteOnce\"]\n      resources:\n        requests:\n          storage: 4Gi\n      storageClassName: csi-cephfs-sc\n</code></pre> <p>\u8bbe\u7f6e\u4e00\u4e2a\u5bc6\u7801\uff0c\u5c06\u5176 base64 \u7f16\u7801\uff1a</p> <pre><code>echo '********' | base64\n</code></pre> <p>\u4fee\u6539 secret.yaml \u4e2d\u7684 password \u4e3a base64 \u7684\u8f93\u51fa\uff1a</p> <pre><code>---\napiVersion: v1\nkind: Secret\nmetadata:\n  name: stolon\ntype: Opaque\ndata:\n  password: \"***********\"\n</code></pre> <p>\u521b\u5efa\u8d44\u6e90\uff1a</p> <pre><code>kubectl -n stolon create -f stolon-sentinel.yaml -f secret.yaml -f stolon-keeper.yaml -f stolon-proxy.yaml -f stolon-proxy-service.yaml\n</code></pre>","tags":["Kubernetes","PostgreSQL"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/%E4%BD%BF%E7%94%A8stolon%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8PostgreSQL.html#6-stolon","title":"6. \u5c06 stolon \u8bbe\u7f6e\u6210\u4e09\u526f\u672c","text":"<pre><code>kubectl -n stolon scale deployment stolon-proxy --replicas 3\nkubectl -n stolon scale deployment stolon-sentinel --replicas 3\nkubectl -n stolon scale statefulset stolon-keeper --replicas 3\n</code></pre>","tags":["Kubernetes","PostgreSQL"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/%E4%BD%BF%E7%94%A8stolon%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8PostgreSQL.html#7-postgresql","title":"7. \u6d4b\u8bd5 PostgreSQL \u8fde\u901a\u6027","text":"<p>\u9996\u5148\u4e34\u65f6\u521b\u5efa\u4e00\u4e2a PostgreSQL \u5bb9\u5668\uff1a</p> <pre><code>kubectl -n stolon run -i -t stolon-client --image=sorintlab/stolon:v0.17.0-pg13 --restart=Never --rm -- /bin/bash\n</code></pre> <p>\u5728\u5bb9\u5668\u91cc\u8fde\u63a5\u6570\u636e\u5e93\uff1a</p> <pre><code>psql --host stolon-proxy-service  --port 5432 postgres -U stolon -W\n</code></pre> <p>\u5bc6\u7801\u4e3a\u521a\u521a base64 \u8bbe\u7f6e\u7684\u5bc6\u7801\u3002</p>","tags":["Kubernetes","PostgreSQL"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/%E4%BD%BF%E7%94%A8stolon%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8PostgreSQL.html#8","title":"8. \u68c0\u67e5\u6570\u636e\u5e93\u72b6\u6001","text":"<p>\u9996\u5148\u521b\u5efa\u4e00\u4e2a\u4e34\u65f6\u7684\u5bb9\u5668\uff1a</p> <pre><code>kubectl -n stolon run -i -t stolon-client --image=sorintlab/stolon:v0.17.0-pg13 --restart=Never --rm -- /bin/bash\n</code></pre> <p>\u5728\u5bb9\u5668\u91cc\u4f7f\u7528 stolonctl \u68c0\u67e5\u96c6\u7fa4\u72b6\u6001\uff1a</p> <pre><code>/usr/local/bin/stolonctl --cluster-name=kube-stolon --store-backend=kubernetes --kube-resource-kind=configmap status\n</code></pre> <pre><code>=== Active sentinels ===\n\nID      LEADER\n558a0979    false\nb509f383    true\nbc1deda2    false\n\n=== Active proxies ===\n\nID\n65e8c81e\n6c322c41\nc19abd6d\n\n=== Keepers ===\n\nUID HEALTHY PG LISTENADDRESS    PG HEALTHY  PG WANTEDGENERATION PG CURRENTGENERATION\nkeeper0 true    172.18.209.38:5432  true        4           4\nkeeper1 true    172.18.122.32:5432  true    2   2\nkeeper2 true    172.18.97.20:5432   true    2   2\n\n=== Cluster Info ===\n\nMaster Keeper: keeper0\n\n===== Keepers/DB tree =====\n\nkeeper0 (master)\n\u251c\u2500keeper2\n\u2514\u2500keeper1\n</code></pre>","tags":["Kubernetes","PostgreSQL"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/%E5%9C%A8k3s%E4%B8%8A%E6%90%AD%E5%BB%BAawx%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83.html","title":"\u5728 k3s \u4e0a\u5b89\u88c5 awx \u6d4b\u8bd5\u73af\u5883","text":"","tags":["Kubernetes","K3S","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/%E5%9C%A8k3s%E4%B8%8A%E6%90%AD%E5%BB%BAawx%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83.html#1-k3s","title":"1. \u5b89\u88c5 k3s","text":"<p>\u4e00\u952e\u5b89\u88c5 k3s \uff1a</p> <pre><code>curl -sfL https://get.k3s.io | sh -\n</code></pre>","tags":["Kubernetes","K3S","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/%E5%9C%A8k3s%E4%B8%8A%E6%90%AD%E5%BB%BAawx%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83.html#2-awx-operator","title":"2. \u5b89\u88c5 AWX Operator","text":"<p>\u521b\u5efa <code>kustomization.yaml</code> \uff1a</p> <pre><code>apiVersion: kustomize.config.k8s.io/v1beta1\nkind: Kustomization\nresources:\n  # Find the latest tag here: https://github.com/ansible/awx-operator/releases\n  - github.com/ansible/awx-operator/config/default?ref=2.19.1\n\n# Set the image tags to match the git version from above\nimages:\n  - name: quay.io/ansible/awx-operator\n    newTag: 2.19.1\n\n# Specify a custom namespace in which to install AWX\nnamespace: awx\n</code></pre> <p>\u751f\u6210 yaml \u6587\u4ef6 <code>awx-operator.yaml</code> \uff1a</p> <pre><code>kubectl apply -k . -o yaml --dry-run=client &gt; awx-operator.yaml\n</code></pre> <p>\u5c06 yaml \u6587\u4ef6\u5e94\u7528\uff1a</p> <pre><code>kubectl create namespace awx\nkubectl -n awx apply -f awx-operator.yaml\n</code></pre>","tags":["Kubernetes","K3S","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/%E5%9C%A8k3s%E4%B8%8A%E6%90%AD%E5%BB%BAawx%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83.html#3-awx-operator-awx","title":"3. \u4f7f\u7528 AWX Operator \u5b89\u88c5 AWX","text":"<p>\u521b\u5efa PostgresSQL \u914d\u7f6e <code>awx-postgres-configuration.yaml</code> \uff1a</p> <pre><code>---\napiVersion: v1\nkind: Secret\nmetadata:\n  name: awx-postgres-configuration\n  namespace: awx\nstringData:\n  host: awx-postgres-15\n  port: \"5432\"\n  database: awx\n  username: awx\n  password: awx\n  sslmode: prefer\n  type: managed\ntype: Opaque\n</code></pre> <p>\u5e94\u7528\u914d\u7f6e\u6587\u4ef6\uff1a</p> <pre><code>kubectl apply -f awx-postgres-configuration.yaml\n</code></pre> <p>\u521b\u5efa AWX \u914d\u7f6e <code>awx.yaml</code> \uff1a</p> <pre><code>---\napiVersion: awx.ansible.com/v1beta1\nkind: AWX\nmetadata:\n  name: awx\n  namespace: awx\nspec:\n  service_type: nodeport\n</code></pre> <p>\u90e8\u7f72 AWX \uff1a</p> <pre><code>kubectl apply -f awx.yaml\n</code></pre> <p>\u67e5\u770b\u5b89\u88c5\u8fdb\u5ea6\uff1a</p> <pre><code>kubectl -n awx logs -f deployments/awx-operator-controller-manager -c awx-manager\n</code></pre> <p>\u83b7\u53d6\u9ed8\u8ba4 admin \u5bc6\u7801\uff1a</p> <pre><code>kubectl -n awx get secret awx-admin-password -o jsonpath=\"{.data.password}\" | base64 --decode;echo\n</code></pre> <p>\u5982\u679c\u9700\u8981\u4fee\u6539 admin \u5bc6\u7801\uff0c\u53ef\u4ee5\u8fdb\u5165\u5bb9\u5668\u4fee\u6539\uff1a</p> <pre><code>kubectl -n awx exec -it awx-web-6b97857864-5rngv -- awx-manage update_password --username=admin --password=changeme\n</code></pre>","tags":["Kubernetes","K3S","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/%E5%9C%A8k3s%E4%B8%8A%E6%90%AD%E5%BB%BAawx%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83.html#4","title":"4. \u53c2\u8003\u8d44\u6599","text":"<p>https://github.com/ansible/awx/issues/5825</p>","tags":["Kubernetes","K3S","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/%E5%AE%89%E8%A3%85AWX-23.7.html","title":"\u5b89\u88c5 AWX-23.7","text":"","tags":["Kubernetes","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/%E5%AE%89%E8%A3%85AWX-23.7.html#1","title":"1. \u51c6\u5907\u5de5\u4f5c","text":"<p>AWX \u9ad8\u7248\u672c\u5fc5\u987b\u4f9d\u6258\u4e8e k8s \u8fdb\u884c\u5b89\u88c5\uff0c\u4e14\u9700\u8981\u4f7f\u7528 PostgreSQL-13 \u6570\u636e\u5e93\u3002</p>","tags":["Kubernetes","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/%E5%AE%89%E8%A3%85AWX-23.7.html#2-awx-operator","title":"2. \u5b89\u88c5 awx-operator","text":"<p>\u7f16\u8f91<code>kustomization.yaml</code>\uff1a</p> <pre><code>apiVersion: kustomize.config.k8s.io/v1beta1\nkind: Kustomization\nresources:\n  # Find the latest tag here: https://github.com/ansible/awx-operator/releases\n  - github.com/ansible/awx-operator/config/default?ref=2.11.0\n\n# Set the image tags to match the git version from above\nimages:\n  - name: quay.io/ansible/awx-operator\n    newTag: 2.11.0\n\n# Specify a custom namespace in which to install AWX\nnamespace: awx\n</code></pre> <p>\u751f\u6210 yaml \u6587\u4ef6\uff1a</p> <pre><code>kubectl apply -k . -o yaml --dry-run=client &gt; awx-operator.yaml\n</code></pre> <p>\u5982\u679c\u9700\u8981\u79bb\u7ebf\u90e8\u7f72\uff0c\u9700\u8981\u628a<code>awx-operator.yaml</code>\u4e2d<code>imagePullPolicy: Always</code>\u4fee\u6539\u4e3a<code>imagePullPolicy: IfNotPresent</code>\uff0c \u5c06 yaml \u6587\u4ef6\u5e94\u7528\uff1a</p> <pre><code>kubectl create namespace awx\nkubectl -n awx apply -f awx-operator.yaml\n</code></pre>","tags":["Kubernetes","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/%E5%AE%89%E8%A3%85AWX-23.7.html#3-postgresql","title":"3. \u914d\u7f6e PostgreSQL \u6570\u636e\u5e93\u7528\u6237","text":"<p>AWX \u5b58\u50a8\u6570\u636e\u9700\u8981\u4e00\u5957 PostgreSQL-13 \u6570\u636e\u5e93\uff0c\u6570\u636e\u5e93\u9700\u8981\u65b0\u5efa\u7528\u6237 awx \u548c\u6570\u636e\u5e93 awx\uff1a</p> <pre><code>psql -h postgresql-13 -U postgres\n</code></pre> <pre><code>Password for user postgres:\npsql (13.11, server 13.0 (Debian 13.0-1.pgdg100+1))\nType \"help\" for help.\n\npostgres=# CREATE USER awx WITH ENCRYPTED PASSWORD '********';\nCREATE ROLE\npostgres=# CREATE DATABASE awx OWNER awx;\nCREATE DATABASE\npostgres=# exit\n</code></pre>","tags":["Kubernetes","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/%E5%AE%89%E8%A3%85AWX-23.7.html#4-awx","title":"4. \u5b89\u88c5 AWX \u5e76\u914d\u7f6e\u5176\u4f7f\u7528\u5916\u90e8\u6570\u636e\u5e93","text":"<p>\u5b9a\u4e49 AWX \u8d44\u6e90\uff0c\u65b0\u5efa<code>awx.yaml</code>\uff1a</p> <pre><code>---\napiVersion: awx.ansible.com/v1beta1\nkind: AWX\nmetadata:\n  name: awx\n  namespace: awx\nspec:\n  ingress_type: ingress\n  ingress_path: /\n  ingress_hosts:\n    - hostname: awx.y.bocsys.cn\n  ee_images:\n    - name: awx-ee\n      image: quay.io/ansible/awx-ee:23.7.0\n  control_plane_ee_image: quay.io/ansible/awx-ee:23.7.0\n  init_container_image: quay.io/ansible/awx-ee\n  init_container_image_version: 23.7.0\n  task_replicas: 3\n  web_replicas: 3\n  task_topology_spread_constraints: |\n    - maxSkew: 1\n      topologyKey: kubernetes.io/hostname\n      whenUnsatisfiable: DoNotSchedule\n      labelSelector:\n        matchLabels:\n          app.kubernetes.io/name: \"awx-task\"\n  web_topology_spread_constraints: |\n    - maxSkew: 1\n      topologyKey: kubernetes.io/hostname\n      whenUnsatisfiable: DoNotSchedule\n      labelSelector:\n        matchLabels:\n          app.kubernetes.io/name: \"awx-web\"\n  postgres_configuration_secret: awx-postgres-configuration\n</code></pre> <p>\u65b0\u5efa\u6570\u636e\u5e93\u914d\u7f6e<code>awx-postgres-configuration.yaml</code>\uff1a</p> <pre><code>---\napiVersion: v1\nkind: Secret\nmetadata:\n  name: awx-postgres-configuration\n  namespace: awx\nstringData:\n  host: postgresql-13\n  port: \"5432\"\n  database: awx\n  username: awx\n  password: \"********\"\n  sslmode: prefer\n  type: unmanaged\ntype: Opaque\n</code></pre> <p>\u5c06\u4e24\u4e2a yaml \u6587\u4ef6\u5e94\u7528\uff1a</p> <pre><code>kubectl -n awx apply -f awx-postgres-configuration.yaml\nkubectl -n awx apply -f awx.yaml\n</code></pre> <p>\u89c2\u5bdf\u90e8\u7f72\u8fdb\u5ea6\uff1a</p> <pre><code>kubectl -n awx logs -f deployments/awx-operator-controller-manager\n</code></pre> <p>\u83b7\u53d6\u9ed8\u8ba4 admin \u5bc6\u7801\uff1a</p> <pre><code>kubectl -n awx get secret awx-admin-password -o jsonpath=\"{.data.password}\" | base64 --decode; echo\n</code></pre>","tags":["Kubernetes","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/%E5%AE%89%E8%A3%85AWX-23.7.html#5","title":"5. \u53c2\u8003\u94fe\u63a5","text":"<p>https://github.com/ansible/awx-operator/blob/devel/docs/installation/basic-install.md</p> <p>https://elatov.github.io/2022/03/deploying-awx-in-k8s-with-awx-operator/</p> <p>https://github.com/ansible/awx-operator/blob/8391ed3501ff326647485b7272e537942da0dd68/docs/user-guide/database-configuration.md?plain=1#L7</p> <p>https://tecadmin.net/postgresql-allow-remote-connections/</p> <p>https://computingforgeeks.com/install-postgresql-13-on-centos-rhel/</p> <p>https://github.com/ansible/awx-operator/issues/1190</p>","tags":["Kubernetes","AWX"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Git%E4%BD%BF%E7%94%A8/GitHub%E9%BB%98%E8%AE%A4%E5%A4%B4%E5%83%8F%E8%8E%B7%E5%8F%96.html","title":"GitHub \u9ed8\u8ba4\u5934\u50cf\u83b7\u53d6","text":"","tags":["GitHub"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Git%E4%BD%BF%E7%94%A8/GitHub%E9%BB%98%E8%AE%A4%E5%A4%B4%E5%83%8F%E8%8E%B7%E5%8F%96.html#1-github","title":"1. \u83b7\u53d6 GitHub \u9ed8\u8ba4\u521d\u59cb\u5934\u50cf","text":"<p>\u83b7\u53d6 GitHub \u9ed8\u8ba4\u521d\u59cb\u5934\u50cf\uff0c\u9700\u8981\u8bbf\u95ee\u9ed8\u8ba4\u7684\u5934\u50cf\u5730\u5740\uff1ahttps://github.com/identicons/hxp-plus.png \uff08\u5c06 hxp-plus \u4fee\u6539\u4e3a GitHub \u7528\u6237\u540d\uff09</p>","tags":["GitHub"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Git%E4%BD%BF%E7%94%A8/GitHub%E9%BB%98%E8%AE%A4%E5%A4%B4%E5%83%8F%E8%8E%B7%E5%8F%96.html#2","title":"2. \u53c2\u8003\u8d44\u6599","text":"<p>https://github.blog/2013-08-14-identicons/</p>","tags":["GitHub"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Git%E4%BD%BF%E7%94%A8/GitLab%E7%AC%AC%E4%BA%8C%E9%82%AE%E7%AE%B1%E4%BF%AE%E6%94%B9%E4%B8%BA%E5%B7%B2%E8%AE%A4%E8%AF%81.html","title":"GitLab \u7b2c\u4e8c\u90ae\u7bb1\u4fee\u6539\u4e3a\u5df2\u8ba4\u8bc1","text":"","tags":["GitLab"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Git%E4%BD%BF%E7%94%A8/GitLab%E7%AC%AC%E4%BA%8C%E9%82%AE%E7%AE%B1%E4%BF%AE%E6%94%B9%E4%B8%BA%E5%B7%B2%E8%AE%A4%E8%AF%81.html#1","title":"1. \u95ee\u9898\u80cc\u666f","text":"<p>\u5728\u5185\u7f51\u73af\u5883\u4e2d\u4f7f\u7528 GitLab \uff0c\u5982\u679c\u9700\u8981\u6dfb\u52a0\u7b2c\u4e8c\u4e2a\u7535\u5b50\u90ae\u4ef6\uff0c\u7535\u5b50\u90ae\u4ef6\u9700\u8981\u88ab\u9a8c\u8bc1\uff0c\u4f46\u662f\u9a8c\u8bc1\u7684\u90ae\u4ef6\u53d1\u4e0d\u51fa\u53bb\uff0c\u5c31\u65e0\u6cd5\u9a8c\u8bc1\u5e76\u5b8c\u6210\u6dfb\u52a0\u3002\u6b64\u65f6\u9700\u8981\u4e00\u79cd\u65b9\u6cd5\u624b\u52a8\u4fee\u6539\u90ae\u7bb1\u4e3a\u5df2\u8ba4\u8bc1\u3002</p>","tags":["GitLab"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Git%E4%BD%BF%E7%94%A8/GitLab%E7%AC%AC%E4%BA%8C%E9%82%AE%E7%AE%B1%E4%BF%AE%E6%94%B9%E4%B8%BA%E5%B7%B2%E8%AE%A4%E8%AF%81.html#2-rails","title":"2. \u767b\u5f55 Rails \u63a7\u5236\u53f0\u624b\u52a8\u4fee\u6539\u7b2c\u4e8c\u90ae\u7bb1\u4e3a\u5df2\u8ba4\u8bc1","text":"<p>\u767b\u5f55\u5230 GitLab \u670d\u52a1\u5668\u4e0a\uff0c\u8fdb\u5165 Rails \u63a7\u5236\u53f0\u4fee\u6539\u90ae\u7bb1\u4e3a\u5df2\u8ba4\u8bc1\uff1a</p> <pre><code>[root@gitlab gitlab]# gitlab-rails console production\n-------------------------------------------------------------------------------------\n GitLab:       11.5.1 (c90ae59)\n GitLab Shell: 8.4.1\n postgresql:   9.6.8\n-------------------------------------------------------------------------------------\nBoth Deployment and its :status machine have defined a different default for \"status\". Use only one or the other for defining defaults to avoid unexpected behaviors.\nLoading production environment (Rails 4.2.10)\nirb(main):003:0&gt; email = Email.find_by(email: \"hxp@hxp.plus\")\n=&gt; #&lt;Email id: 2, user_id: 51, email: \"hxp@hxp.plus\", created_at: \"2024-06-05 03:59:21\", updated_at: \"2024-06-05 03:59:21\"&gt;\nirb(main):004:0&gt; email.confirmed_at = Time.zone.now\n=&gt; Wed, 05 Jun 2024 04:37:42 UTC +00:00\nirb(main):005:0&gt; email.save!\n=&gt; true\nirb(main):006:0&gt; exit\n</code></pre>","tags":["GitLab"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Git%E4%BD%BF%E7%94%A8/GitLab%E7%AC%AC%E4%BA%8C%E9%82%AE%E7%AE%B1%E4%BF%AE%E6%94%B9%E4%B8%BA%E5%B7%B2%E8%AE%A4%E8%AF%81.html#3","title":"3. \u53c2\u8003\u8d44\u6599","text":"<p>https://gist.github.com/macdja38/3d62d4f251bd7c46f0128bb6a9d35544</p>","tags":["GitLab"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Git%E4%BD%BF%E7%94%A8/Git%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3.html","title":"Git \u4e2d\u6587\u4e71\u7801\u95ee\u9898\u89e3\u51b3","text":"","tags":["Git"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Git%E4%BD%BF%E7%94%A8/Git%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3.html#1-git","title":"1. Git \u4e2d\u6587\u8def\u5f84\u4e71\u7801\u95ee\u9898","text":"<p>\u9ed8\u8ba4\u914d\u7f6e\u4e0b Git \u5982\u679c\u6709\u4e2d\u6587\u6587\u4ef6\u4f1a\u6709\u4e71\u7801\uff1a</p> <pre><code>$ git status\n\u4f4d\u4e8e\u5206\u652f master\n\u60a8\u7684\u5206\u652f\u4e0e\u4e0a\u6e38\u5206\u652f 'origin/master' \u4e00\u81f4\u3002\n\n\u5c1a\u672a\u6682\u5b58\u4ee5\u5907\u63d0\u4ea4\u7684\u53d8\u66f4\uff1a\n  \uff08\u4f7f\u7528 \"git add &lt;\u6587\u4ef6&gt;...\" \u66f4\u65b0\u8981\u63d0\u4ea4\u7684\u5185\u5bb9\uff09\n  \uff08\u4f7f\u7528 \"git checkout -- &lt;\u6587\u4ef6&gt;...\" \u4e22\u5f03\u5de5\u4f5c\u533a\u7684\u6539\u52a8\uff09\n\n    \u4fee\u6539\uff1a     .obsidian/workspace.json\n\n\u672a\u8ddf\u8e2a\u7684\u6587\u4ef6:\n  \uff08\u4f7f\u7528 \"git add &lt;\u6587\u4ef6&gt;...\" \u4ee5\u5305\u542b\u8981\u63d0\u4ea4\u7684\u5185\u5bb9\uff09\n\n    \"Git\\344\\270\\255\\346\\226\\207\\344\\271\\261\\347\\240\\201\\351\\227\\256\\351\\242\\230\\350\\247\\243\\345\\206\\263.md\"\n\n\u4fee\u6539\u5c1a\u672a\u52a0\u5165\u63d0\u4ea4\uff08\u4f7f\u7528 \"git add\" \u548c/\u6216 \"git commit -a\"\uff09\n</code></pre>","tags":["Git"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Git%E4%BD%BF%E7%94%A8/Git%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3.html#2","title":"2. \u89e3\u51b3\u65b9\u6cd5","text":"<pre><code>git config --global core.quotepath false\n</code></pre>","tags":["Git"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Git%E4%BD%BF%E7%94%A8/Git%E9%85%8D%E7%BD%AE%E8%AE%B0%E4%BD%8F%E5%AF%86%E7%A0%81.html","title":"Git \u914d\u7f6e\u8bb0\u4f4f\u5bc6\u7801","text":"","tags":["Git"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Git%E4%BD%BF%E7%94%A8/Git%E9%85%8D%E7%BD%AE%E8%AE%B0%E4%BD%8F%E5%AF%86%E7%A0%81.html#1-token","title":"1. Token \u7684\u751f\u6210","text":"<p>\u7531\u4e8e GitHub \u7b49\u5e73\u53f0\u7684\u9650\u5236\uff0c\u5728 Git \u5ba2\u6237\u7aef\u914d\u7f6e\u7684\u5bc6\u7801\u9700\u8981\u662f Personal Access Token\uff0c\u53ef\u5728\u4e2a\u4eba\u8bbe\u7f6e\u7684\u201cDeveloper Settings\u201d\u8bbe\u7f6e\u3002</p>","tags":["Git"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Git%E4%BD%BF%E7%94%A8/Git%E9%85%8D%E7%BD%AE%E8%AE%B0%E4%BD%8F%E5%AF%86%E7%A0%81.html#2-git","title":"2. \u914d\u7f6e Git \u8bb0\u4f4f\u5bc6\u7801","text":"<p>\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u914d\u7f6e\uff08\u5168\u5c40\u751f\u6548\uff0c\u5982\u679c\u60f3\u4ec5\u5bf9\u4ed3\u5e93\u751f\u6548\uff0c\u53bb\u6389 <code>--global</code> \uff09\uff1a</p> <pre><code>git config --global credential.helper store\n</code></pre>","tags":["Git"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Git%E4%BD%BF%E7%94%A8/%E4%BD%BF%E7%94%A8nginx%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E5%8F%AA%E8%AF%BBGit%E4%BB%93%E5%BA%93.html","title":"\u4f7f\u7528 nginx \u5feb\u901f\u642d\u5efa\u53ea\u8bfb Git \u4ed3\u5e93","text":"","tags":["Git","Nginx"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Git%E4%BD%BF%E7%94%A8/%E4%BD%BF%E7%94%A8nginx%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E5%8F%AA%E8%AF%BBGit%E4%BB%93%E5%BA%93.html#1","title":"1. \u9879\u76ee\u80cc\u666f","text":"<p>\u5bf9\u4e8e\u6709\u591a\u5730\u591a\u4e2a\u7f51\u7edc\u533a\u57df\u7684\u5927\u578b\u516c\u53f8\uff0c\u7f51\u7edc\u533a\u57df\u4e4b\u95f4\u7f51\u7edc\u4e0d\u901a\uff0c\u540c\u65f6\u6bcf\u4e2a\u7f51\u7edc\u533a\u57df\u90fd\u6709\u4e00\u4e2a nginx \u4f5c\u4e3a\u4ecb\u8d28\u5e93\uff0c\u5404\u4e2a\u7f51\u7edc\u533a\u57df\u5185\u6240\u6709\u4e3b\u673a\u53ef\u4ee5\u8bbf\u95ee\u672c\u7f51\u7edc\u533a\u57df\u4e4b\u95f4\u7684\u4ecb\u8d28\u5e93\uff0c\u4ecb\u8d28\u5e93\u4e4b\u95f4\u540c\u6b65\u3002\u540c\u65f6\u9700\u8981\u4f7f\u7528 Git \u6765\u8fdb\u884c\u4ee3\u7801\u7684\u7ba1\u7406\uff0c\u8981\u6c42\u5404\u4e2a\u7f51\u7edc\u533a\u57df\u7684\u4e3b\u673a\u90fd\u4ee5\u53ea\u8bfb\u7684\u65b9\u5f0f\u80fd\u8bbf\u95ee\u5230 Git \u4ed3\u5e93\u6765\u62c9\u53d6\u4ee3\u7801\u3002\u56e0\u6b64\u9700\u8981\u5efa\u7acb\u57fa\u4e8e HTTP \u7684 Git \u4ed3\u5e93\uff0c\u540c\u65f6\u5c3d\u91cf\u5c11\u5730\u66f4\u6539\u5404\u5730\u4ecb\u8d28\u5e93\u7684\u914d\u7f6e\u3002</p>","tags":["Git","Nginx"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Git%E4%BD%BF%E7%94%A8/%E4%BD%BF%E7%94%A8nginx%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E5%8F%AA%E8%AF%BBGit%E4%BB%93%E5%BA%93.html#2-git","title":"2. \u51e0\u79cd\u5efa\u7acb Git \u4ed3\u5e93\u7684\u9009\u62e9","text":"","tags":["Git","Nginx"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Git%E4%BD%BF%E7%94%A8/%E4%BD%BF%E7%94%A8nginx%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E5%8F%AA%E8%AF%BBGit%E4%BB%93%E5%BA%93.html#21-smart-http","title":"2.1 Smart HTTP \u4ed3\u5e93","text":"<p>\u8fd9\u4e2a\u662f Git \u5b98\u65b9\u63a8\u8350\u7684\u4f7f\u7528 HTTP \u5efa\u7acb Git \u4ed3\u5e93\u7684\u65b9\u5f0f\uff0c\u597d\u5904\u4e3a\u5efa\u7acb\u597d\u7684 Git \u4ed3\u5e93\u53ef\u8bfb\u53ef\u5199\uff0c\u4f46\u662f\u5b98\u65b9\u53ea\u7ed9\u4e86 Apache \u7684\u793a\u4f8b\uff0c\u5982\u679c\u4f7f\u7528 nginx\uff0c\u9700\u8981\u4f7f\u7528\u5230\u7b2c\u4e09\u65b9\u6a21\u5757 fcgiwrap \uff0c\u8fd9\u5c31\u9700\u8981\u4fee\u6539\u5df2\u6709\u7684 nginx \uff0c\u540c\u65f6\uff0c\u8fd9\u4e2a\u6a21\u5757\u4e0d\u662f RHEL \u5b98\u65b9\u9644\u5e26\u7684\uff0c\u662f\u5426\u8981\u5b89\u88c5\u5230\u751f\u4ea7\u73af\u5883\u6709\u5f85\u5546\u69b7\u3002</p>","tags":["Git","Nginx"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Git%E4%BD%BF%E7%94%A8/%E4%BD%BF%E7%94%A8nginx%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E5%8F%AA%E8%AF%BBGit%E4%BB%93%E5%BA%93.html#22-ssh","title":"2.2 SSH \u4ed3\u5e93","text":"<p>\u8fd9\u4e2a\u662f\u6700\u7b80\u5355\u7684\u5efa\u7acb Git \u4ed3\u5e93\u7684\u65b9\u5f0f\uff0c\u5373\u53ea\u8981\u6709\u4e00\u4e2a SSH \u670d\u52a1\u5668\u5373\u53ef\u3002\u7f3a\u70b9\u662f SSH \u767b\u5f55\u6309\u7167\u4f01\u4e1a\u7684\u89c4\u5b9a\uff0c\u7981\u6b62\u7a7a\u5bc6\u7801\uff0c\u8fd9\u5c31\u5fc5\u987b\u6bcf\u6b21\u62c9\u4ee3\u7801\u7684\u65f6\u5019\u4f7f\u7528\u5bc6\u7801\uff0c\u6216\u8005\u5efa\u7acb SSH \u4e92\u4fe1\u3002\u4e14\u8fd9\u79cd\u65b9\u5f0f\u8d70\u7684\u662f SSH \u7aef\u53e3\uff0c\u5bf9\u4e8e\u8fd9\u4e2a\u9700\u6c42\u800c\u8a00\u4e0d\u80fd\u6ee1\u8db3\u3002</p>","tags":["Git","Nginx"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Git%E4%BD%BF%E7%94%A8/%E4%BD%BF%E7%94%A8nginx%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E5%8F%AA%E8%AF%BBGit%E4%BB%93%E5%BA%93.html#23-dumb-http","title":"2.3 Dumb HTTP \u4ed3\u5e93","text":"<p>\u5f53 Git \u62c9\u53d6 HTTP \u4ed3\u5e93\u65f6\uff0c\u5b83\u4f1a\u9996\u5148\u8ba4\u4e3a\u4ed3\u5e93\u662f Smart HTTP \u4ed3\u5e93\uff0c\u670d\u52a1\u5668\u6ca1\u6709\u76f8\u5e94\u800c\u5931\u8d25\u540e\uff0c\u4e3b\u52a8\u56de\u843d\u5230 Dumb HTTP \u6a21\u5f0f\u3002\u8fd9\u4e2a\u6a21\u5f0f\u5b8c\u7f8e\u7b26\u5408\u6b64\u9879\u76ee\u7684\u8981\u6c42\uff0c\u56e0\u4e3a Dumb HTTP \u4ed3\u5e93\u53ea\u9700\u8981\u4e00\u4e2a\u80fd\u6b63\u5e38\u5de5\u4f5c\u7684 HTTP \u670d\u52a1\u5668\uff0c\u8fd9\u610f\u5473\u7740\u4e0d\u9700\u8981\u4fee\u6539 nginx \u914d\u7f6e\u6216\u8005\u52a0\u5165\u7b2c\u4e09\u65b9\u6a21\u5757\u3002</p>","tags":["Git","Nginx"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Git%E4%BD%BF%E7%94%A8/%E4%BD%BF%E7%94%A8nginx%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E5%8F%AA%E8%AF%BBGit%E4%BB%93%E5%BA%93.html#3-dumb-http","title":"3. \u5efa\u7acb Dumb HTTP \u4ed3\u5e93","text":"<p>\u4ee5\u4e0b Dockerfile \u662f\u4e00\u4e2a Dumb HTTP \u4ed3\u5e93\u7684\u793a\u4f8b\uff1a</p> <pre><code>FROM redhat/ubi8:8.10\nRUN yum install -y nginx git\nWORKDIR /usr/share/nginx/html\nRUN git clone --mirror https://github.com/hxp-plus/docs.hxp.plus.git docs.hxp.plus.git\nRUN cd docs.hxp.plus.git &amp;&amp; mv hooks/post-update.sample hooks/post-update &amp;&amp; chmod a+x hooks/post-update &amp;&amp; git update-server-info\nCOPY &lt;&lt;-'EOF' /etc/nginx/nginx.conf\ndaemon off;\nuser nginx;\nworker_processes 1;\nerror_log /dev/stdout info;\npid /run/nginx.pid;\ninclude /usr/share/nginx/modules/*.conf;\nevents {\n    worker_connections 1024;\n}\nhttp {\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n    access_log  /dev/stdout  main;\n    sendfile            on;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n    keepalive_timeout   65;\n    types_hash_max_size 2048;\n    include             /etc/nginx/mime.types;\n    default_type        application/octet-stream;\n    server {\n        listen                80 default_server;\n        listen                [::]:80 default_server;\n        server_name           _;\n        root                  /usr/share/nginx/html;\n        charset               utf-8;\n        client_max_body_size  0;\n        location / {\n            autoindex on;\n        }\n    }\n}\nEOF\nEXPOSE 80\nCMD [\"/sbin/nginx\"]\n</code></pre> <p>\u53ef\u4ee5\u770b\u51fa\uff0c\u5efa\u7acb\u8fc7\u7a0b\u4e3a\u5927\u81f4\u4ee5\u4e0b\u51e0\u6b65\uff1a</p> <ol> <li>\u5b89\u88c5 git \u548c nginx \u3002</li> <li>\u5728 nginx \u7684\u6839\u76ee\u5f55\uff0c\u514b\u9686 git \u4ed3\u5e93\u3002</li> <li>\u4fee\u6539\u514b\u9686\u4e0b\u7684\u4ed3\u5e93\u7684 post-update hook \uff0c\u5e76\u8fd0\u884c\u4e00\u6b21 post-update hook \u91cc\u7684\u547d\u4ee4\u3002</li> <li>\u914d\u7f6e nginx \uff0c\u4f7f\u5176\u80fd\u5411\u5916\u754c\u63d0\u4f9b http \u8d44\u6e90\u3002</li> </ol> <p>\u5982\u679c\u9700\u8981\u66f4\u65b0 nginx \u4e0a\u7684 git \u4ed3\u5e93\uff0c\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>cd /usr/share/nginx/html/docs.hxp.plus.git\ngit fetch --all\n</code></pre>","tags":["Git","Nginx"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Git%E4%BD%BF%E7%94%A8/%E4%BD%BF%E7%94%A8nginx%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E5%8F%AA%E8%AF%BBGit%E4%BB%93%E5%BA%93.html#4","title":"4. \u53c2\u8003\u8d44\u6599","text":"<p>https://wiki.archlinux.org/title/Git_server</p> <p>https://git-scm.com/book/en/v2/Git-on-the-Server-Smart-HTTP</p> <p>https://git-scm.com/book/en/v2/Git-on-the-Server-The-Protocols</p> <p>https://cloud.tencent.com/developer/article/1921219</p>","tags":["Git","Nginx"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Git%E4%BD%BF%E7%94%A8/%E6%9C%80%E7%AE%80Git%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA.html","title":"\u6700\u7b80 Git \u670d\u52a1\u5668\u642d\u5efa","text":"","tags":["Git"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Git%E4%BD%BF%E7%94%A8/%E6%9C%80%E7%AE%80Git%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA.html#1-git","title":"1. \u6700\u7b80 Git \u670d\u52a1\u5668\u642d\u5efa\u65b9\u6cd5","text":"<p>\u53ea\u8981\u6709\u670d\u52a1\u5668\u6709 SSH\uff0c\u5c31\u53ef\u4ee5\u642d\u5efa Git \u4ed3\u5e93\u3002\u5728\u4ed3\u5e93\u4e0a\uff0c\u5148\u521b\u5efa\u7528\u6237 git\uff0c\u5e76\u4f7f\u7528\u7528\u6237 git \u6765\u521b\u5efa\u4ed3\u5e93\uff1a</p> <pre><code>cd /srv/git\nmkdir project.git\ncd project.git\ngit init --bare\n</code></pre> <p>\u4e4b\u540e\u5728\u5ba2\u6237\u7aef\u4f7f\u7528 Git\uff1a</p> <pre><code>git remote add origin git@gitserver:/srv/git/project.git\n</code></pre>","tags":["Git"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Java/SpringBoot%202.5.1%20%E5%AF%B9%E6%8E%A5Keycloak%E8%AE%A4%E8%AF%81.html","title":"SpringBoot 2.5.1 \u5bf9\u63a5 Keycloak \u8ba4\u8bc1","text":"","tags":["Spring Security","SpringBoot","Java","Keycloak"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Java/SpringBoot%202.5.1%20%E5%AF%B9%E6%8E%A5Keycloak%E8%AE%A4%E8%AF%81.html#1-spring","title":"1. Spring \u9879\u76ee\u914d\u7f6e","text":"<p>\u5728 <code>pom.xml</code> \u52a0\u5165\u4f9d\u8d56\uff1a</p> <pre><code>&lt;dependency&gt;\n  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n  &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;\n&lt;/dependency&gt;\n&lt;dependency&gt;\n  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n  &lt;artifactId&gt;spring-boot-starter-oauth2-client&lt;/artifactId&gt;\n&lt;/dependency&gt;\n</code></pre> <p>\u6dfb\u52a0 application.properties \u914d\u7f6e\uff1a</p> <pre><code>spring.security.oauth2.client.registration.keycloak.client-id=test-client\nspring.security.oauth2.client.registration.keycloak.authorization-grant-type=authorization_code\nspring.security.oauth2.client.registration.keycloak.scope=openid\nspring.security.oauth2.client.provider.keycloak.issuer-uri=http://ubuntu.hxp.lan:8080/realms/test\nspring.security.oauth2.client.provider.keycloak.user-name-attribute=preferred_username\nspring.security.oauth2.resourceserver.jwt.issuer-uri=http://ubuntu.hxp.lan:8080/realms/test\n</code></pre>","tags":["Spring Security","SpringBoot","Java","Keycloak"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Java/SpringBoot%202.5.1%20%E5%AF%B9%E6%8E%A5Keycloak%E8%AE%A4%E8%AF%81.html#2-keycloak","title":"2. Keycloak \u914d\u7f6e","text":"<p>\u672c\u6b21\u4f7f\u7528\u7684 Keycloak \u5f00\u53d1\u670d\u52a1\u5668\uff0c docker-compose \u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>version: \"3\"\n\nservices:\n  mysql:\n    image: mysql:8.0\n    volumes:\n      - mysql_data:/var/lib/mysql\n    environment:\n      MYSQL_ROOT_PASSWORD: MyRootPassword\n      MYSQL_DATABASE: keycloak\n      MYSQL_USER: keycloak\n      MYSQL_PASSWORD: MyKeycloakMySQLPassword\n    restart: always\n  keycloak:\n    image: quay.io/keycloak/keycloak:24.0\n    command: start-dev\n    environment:\n      KC_HOSTNAME: ubuntu.hxp.lan\n      KC_HOSTNAME_PORT: 8080\n      KC_HOSTNAME_STRICT_BACKCHANNEL: false\n      KC_HTTP_ENABLED: true\n      KC_HOSTNAME_STRICT_HTTPS: false\n      KC_HEALTH_ENABLED: true\n      KEYCLOAK_ADMIN: admin\n      KEYCLOAK_ADMIN_PASSWORD: admin\n      KC_DB: mysql\n      KC_DB_URL: jdbc:mysql://mysql:3306/keycloak\n      KC_DB_USERNAME: keycloak\n      KC_DB_PASSWORD: MyKeycloakMySQLPassword\n    ports:\n      - 8080:8080\n    restart: always\n    depends_on:\n      - mysql\nvolumes:\n  mysql_data:\n    driver: local\n</code></pre> <p>docker \u7684 2 \u4e2a\u5bb9\u5668\u542f\u52a8\u5b8c\u6210\u4e4b\u540e\uff0c\u8fdb\u5165 <code>http://ubuntu.hxp.lan:8080/</code> \u914d\u7f6e Keycloak \uff08\u7528\u6237\u540d\u548c\u5bc6\u7801\u5747\u4e3a <code>admin</code> \uff09\uff0c\u505a\u5982\u4e0b\u914d\u7f6e\uff1a</p> <ol> <li>\u65b0\u5efa\u540d\u79f0\u4e3a test \u7684 Realm</li> <li>\u65b0\u5efa\u7c7b\u578b\u4e3a OpenID Connect \uff0cID \u4e3a test-client \u7684 client</li> <li>test-client \u7684 Client authentication \u4e3a OFF</li> <li>test-client \u7684 Valid redirect URIs \u4e3a *</li> <li>test-client \u7684 Web origins \u4e3a *</li> <li>\u5728\u540d\u79f0\u4e3a test \u7684 Realm \u91cc\u65b0\u5efa\u7528\u6237 testuser</li> </ol> <p>\u4e4b\u540e\u542f\u52a8 Spring \u540e\u7aef\uff0c\u4f1a\u81ea\u52a8\u8df3\u8f6c\u5230 Keycloak \u767b\u5f55\u9875\u9762\u3002</p>","tags":["Spring Security","SpringBoot","Java","Keycloak"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Java/SpringBoot%202.5.1%20%E5%AF%B9%E6%8E%A5Keycloak%E8%AE%A4%E8%AF%81.html#3-spring-securityconfig","title":"3. \u5728 Spring \u91cc \u914d\u7f6e SecurityConfig","text":"<p>\u65b0\u5efa\u6587\u4ef6 <code>src/main/java/com/onlyoffice/integration/config/SecurityConfig.java</code> \uff1a</p> <pre><code>package com.onlyoffice.integration.config;\n\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\nimport org.springframework.security.core.GrantedAuthority;\nimport org.springframework.security.oauth2.client.oidc.userinfo.OidcUserRequest;\nimport org.springframework.security.oauth2.client.oidc.userinfo.OidcUserService;\nimport org.springframework.security.oauth2.client.registration.ClientRegistration;\nimport org.springframework.security.oauth2.client.userinfo.OAuth2UserService;\nimport org.springframework.security.oauth2.core.OAuth2AccessToken;\nimport org.springframework.security.oauth2.core.oidc.user.DefaultOidcUser;\nimport org.springframework.security.oauth2.core.oidc.user.OidcUser;\nimport org.springframework.security.web.SecurityFilterChain;\nimport org.springframework.util.StringUtils;\n\nimport java.util.HashSet;\nimport java.util.Set;\n\n@Configuration\n@EnableWebSecurity\npublic class SecurityConfig {\n    @Bean\n    public SecurityFilterChain filterChain(final HttpSecurity http) throws Exception {\n        http.csrf().disable().authorizeRequests().antMatchers(\"/track\", \"/download\").permitAll().anyRequest().authenticated().and().oauth2Login(oauth2 -&gt; oauth2.userInfoEndpoint(userInfo -&gt; userInfo.oidcUserService(this.oidcUserService())));\n        return http.build();\n    }\n\n    private OAuth2UserService&lt;OidcUserRequest, OidcUser&gt; oidcUserService() {\n        final OidcUserService delegate = new OidcUserService();\n\n        return (userRequest) -&gt; {\n            // Delegate to the default implementation for loading a user\n            OidcUser oidcUser = delegate.loadUser(userRequest);\n\n            OAuth2AccessToken accessToken = userRequest.getAccessToken();\n            Set&lt;GrantedAuthority&gt; mappedAuthorities = new HashSet&lt;&gt;();\n\n            // TODO\n            // 1) Fetch the authority information from the protected resource using accessToken\n            // 2) Map the authority information to one or more GrantedAuthority's and add it to mappedAuthorities\n\n            // 3) Create a copy of oidcUser but use the mappedAuthorities instead\n            ClientRegistration.ProviderDetails providerDetails = userRequest.getClientRegistration().getProviderDetails();\n            String userNameAttributeName = providerDetails.getUserInfoEndpoint().getUserNameAttributeName();\n            if (StringUtils.hasText(userNameAttributeName)) {\n                oidcUser = new DefaultOidcUser(mappedAuthorities, oidcUser.getIdToken(), oidcUser.getUserInfo(), userNameAttributeName);\n            } else {\n                oidcUser = new DefaultOidcUser(mappedAuthorities, oidcUser.getIdToken(), oidcUser.getUserInfo());\n            }\n\n            return oidcUser;\n        };\n    }\n}\n</code></pre> <p>\u6ce8\u610f\u8fd9\u91cc\u6211\u7981\u7528\u4e86 CSRF \uff0c\u5e76\u4e14\u5141\u8bb8 <code>/track</code> \u548c <code>/download</code> \u975e\u6388\u6743\u8bbf\u95ee\u3002</p>","tags":["Spring Security","SpringBoot","Java","Keycloak"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Java/SpringBoot%202.5.1%20%E5%AF%B9%E6%8E%A5Keycloak%E8%AE%A4%E8%AF%81.html#4-spring-keycloak","title":"4. \u5728 Spring \u91cc\u8bfb\u53d6\u5df2\u767b\u5f55\u7684 Keycloak \u7528\u6237\u4fe1\u606f","text":"<p>\u5728\u9002\u5f53\u7684\u5730\u65b9\u5f15\u7528\u5982\u4e0b\u4f9d\u8d56\uff1a</p> <pre><code>import org.springframework.security.core.Authentication;\nimport org.springframework.security.core.context.SecurityContextHolder;\nimport org.springframework.security.oauth2.client.authentication.OAuth2AuthenticationToken;\n</code></pre> <p>\u83b7\u53d6\u7528\u6237\u4fe1\u606f\u7684\u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>String userFullName = \"\u533f\u540d\u7528\u6237\";\nAuthentication authentication = SecurityContextHolder.getContext().getAuthentication();\nSystem.out.println(authentication.getPrincipal().getClass());\nif (authentication.getPrincipal() instanceof DefaultOidcUser) {\n    DefaultOidcUser userDetails = (DefaultOidcUser) authentication.getPrincipal();\n    userFullName = userDetails.getFullName();\n}\n</code></pre>","tags":["Spring Security","SpringBoot","Java","Keycloak"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Java/SpringBoot%202.5.1%20%E5%AF%B9%E6%8E%A5Keycloak%E8%AE%A4%E8%AF%81.html#5","title":"5. \u53c2\u8003\u8d44\u6599","text":"<p>https://www.baeldung.com/spring-boot-security-autoconfiguration</p> <p>https://www.baeldung.com/spring-security-5-oauth2-login</p> <p>https://spring.io/guides/tutorials/spring-boot-oauth2</p> <p>https://spring.io/blog/2018/03/06/using-spring-security-5-to-integrate-with-oauth-2-secured-services-such-as-facebook-and-github</p> <p>https://docs.spring.io/spring-security/reference/5.7/servlet/oauth2/login/advanced.html#oauth2login-advanced-oidc-user-service</p>","tags":["Spring Security","SpringBoot","Java","Keycloak"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Java/%E4%BD%BF%E7%94%A8OnlyOffice%E5%AE%98%E6%96%B9Spring%E7%A4%BA%E4%BE%8B%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91.html","title":"\u4f7f\u7528 OnlyOffice \u5b98\u65b9 Spring \u793a\u4f8b\u9047\u5230\u7684\u5751","text":"","tags":["OnlyOffice","SpringBoot","Maven","Java"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Java/%E4%BD%BF%E7%94%A8OnlyOffice%E5%AE%98%E6%96%B9Spring%E7%A4%BA%E4%BE%8B%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91.html#1-github-resources","title":"1. GitHub \u4e0b\u8f7d\u4e0b\u6765\u7684\u4ee3\u7801\u4e2d resources \u76ee\u5f55\u7f3a\u5931","text":"<p>\u8fd9\u662f\u7531\u4e8e <code>web/documentserver-example/java-spring/src/main/resources</code> \u4e0b\u7684\u4e24\u4e2a\u76ee\u5f55\u4e0d\u5c5e\u4e8e\u8fd9\u4e2a GitHub \u4ed3\u5e93\uff0c\u662f submodule \uff1a</p> <p></p> <pre><code>git clone --recurse-submodules https://github.com/ONLYOFFICE/document-server-integration.git\n</code></pre>","tags":["OnlyOffice","SpringBoot","Maven","Java"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Java/%E4%BD%BF%E7%94%A8OnlyOffice%E5%AE%98%E6%96%B9Spring%E7%A4%BA%E4%BE%8B%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91.html#2-idea-jar","title":"2. \u5982\u4f55\u7528 IDEA \u5c06\u9879\u76ee\u7f16\u8bd1\u6210 jar \u5305","text":"<p>\u9879\u76ee\u52a0\u8f7d\u5230 IDEA \u540e\uff0c\u70b9\u5f00 maven \u7684\u6807\u7b7e\u9875\uff0c\u9f20\u6807\u53cc\u51fb\u8fd9\u4e2a <code>package</code> \uff1a</p> <p></p> <p>jar \u5305\u4f1a\u751f\u6210\u5728 <code>target/integration-1.0.jar</code> \uff0c\u5c06\u5176\u590d\u5236\u5373\u53ef\u4f7f\u7528\u3002</p>","tags":["OnlyOffice","SpringBoot","Maven","Java"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Java/%E4%BD%BF%E7%94%A8OnlyOffice%E5%AE%98%E6%96%B9Spring%E7%A4%BA%E4%BE%8B%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91.html#3-jar","title":"3. \u9879\u76ee\u6253\u5305\u6210 jar \u540e\u5355\u72ec\u8fd0\u884c\u62a5\u9519","text":"<p>\u9879\u76ee\u6253\u5305\u6210 jar \u5305\u5355\u72ec\u8fd0\u884c\u4f1a\u62a5\u9519 FileNotFoundException \uff0c\u539f\u56e0\u6709 2 \u4e2a\uff0c\u9996\u5148\u662f resources \u76ee\u5f55\u6ca1\u6709\u88ab\u6253\u5305\u8fdb\u5165 jar \u5305\uff0c\u89e3\u51b3\u65b9\u6cd5\u4e3a\u4fee\u6539 <code>pom.xml</code> \uff0c\u5728 <code>build</code> \u4e2d\u52a0\u5165\uff1a</p> <pre><code>&lt;resources&gt;\n  &lt;resource&gt;\n    &lt;directory&gt;${basedir}/src/main/resources&lt;/directory&gt;\n  &lt;/resource&gt;\n&lt;/resources&gt;\n</code></pre> <p>\u5176\u6b21\u662f <code>src/main/java/com/onlyoffice/integration/documentserver/util/service/DefaultFormatService.java</code> \u4e2d\u8fd9\u4e00\u884c\u4f7f\u7528\u7684 <code>getFile()</code> \u65b9\u6cd5\u5728 jar \u5305\u4e2d\u4e0d\u9002\u7528\uff1a</p> <pre><code>File targetFile = resourceFile.getFile();\n</code></pre> <p>\u9700\u8981\u5c06\u8fd9\u4e00\u884c\u4fee\u6539\u4e3a\u4ee5\u4e0b\u51e0\u884c\uff1a</p> <pre><code>InputStream inputStream = resourceFile.getInputStream();\nFile targetFile = File.createTempFile(\"onlyoffice-docs-formats\", \".json\");\ntry (FileOutputStream outputStream = new FileOutputStream(targetFile)) {\n    final int bufferLength = 1024;\n    byte[] buffer = new byte[bufferLength];\n    int bytesRead;\n    while ((bytesRead = inputStream.read(buffer)) != -1) {\n        outputStream.write(buffer, 0, bytesRead);\n    }\n}\n</code></pre> <p>\u540c\u65f6\u9700\u8981\u5bfc\u5165\u989d\u5916\u7684\u4ee5\u4e0b\u4e24\u4e2a\u5305\uff1a</p> <pre><code>import java.io.FileOutputStream;\nimport java.io.InputStream;\n</code></pre>","tags":["OnlyOffice","SpringBoot","Maven","Java"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Java/%E4%BD%BF%E7%94%A8OnlyOffice%E5%AE%98%E6%96%B9Spring%E7%A4%BA%E4%BE%8B%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91.html#4","title":"4. \u6587\u6863\u4e0a\u4f20\u5927\u5c0f\u9650\u5236\u4fee\u6539","text":"<p>\u9ed8\u8ba4\u7684\u6587\u6863\u4e0a\u4f20\u9650\u5236\u8fc7\u5c0f\uff0c\u6709\u4e9b\u5927\u6587\u6863\u4e0a\u4f20\u4f1a\u62a5\u9519\uff0c\u9700\u8981\u4fee\u6539 <code>src/main/resources/application.properties</code> \uff1a</p> <pre><code>filesize-max=5242880\nspring.servlet.multipart.max-file-size=50MB\nspring.servlet.multipart.max-request-size=50MB\n</code></pre> <p>\u5c06\u4ee5\u4e0a\u4e09\u4e2a\u53c2\u6570\u4fee\u6539\u4e3a\u539f\u6765\u7684 10 \u500d\u3002</p>","tags":["OnlyOffice","SpringBoot","Maven","Java"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Java/%E4%BD%BF%E7%94%A8OnlyOffice%E5%AE%98%E6%96%B9Spring%E7%A4%BA%E4%BE%8B%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91.html#5-mysql","title":"5. \u4fee\u6539\u4e3a\u4f7f\u7528 MySQL \u6570\u636e\u5e93","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u8fd9\u4e2a Spring \u793a\u4f8b\u4f7f\u7528\u5728\u5185\u5b58\u4e2d\u7684 h2 \u6570\u636e\u5e93\uff0c\u9700\u8981\u5c06\u5176\u4fee\u6539\u4e3a\u4f7f\u7528 MySQL \uff0c\u9700\u8981\u4fee\u6539 <code>src/main/resources/application.properties</code> \uff0c\u5c06\u4ee5\u4e0b\u51e0\u884c\uff1a</p> <pre><code>spring.datasource.url=jdbc:h2:mem:usersdb\nspring.datasource.driverClassName=org.h2.Driver\nspring.datasource.username=sa\nspring.datasource.password=password\nspring.jpa.database-platform=org.hibernate.dialect.H2Dialect\nhibernate.ddl-auto\n</code></pre> <p>\u4fee\u6539\u4e3a\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>spring.datasource.url=jdbc:mysql://ubuntu.hxp.lan:3306/spring\nspring.datasource.driverClassName=com.mysql.cj.jdbc.Driver\nspring.datasource.username=spring\nspring.datasource.password=spring\nspring.jpa.hibernate.ddl-auto=create-drop\n</code></pre> <p>\u540c\u65f6\uff0c\u5728 <code>pom.xml</code> \u91cc\u589e\u52a0 mysql-connector \uff1a</p> <pre><code>&lt;dependency&gt;\n  &lt;groupId&gt;mysql&lt;/groupId&gt;\n  &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;\n&lt;/dependency&gt;\n</code></pre>","tags":["OnlyOffice","SpringBoot","Maven","Java"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Java/%E4%BD%BF%E7%94%A8OnlyOffice%E5%AE%98%E6%96%B9Spring%E7%A4%BA%E4%BE%8B%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91.html#6-spring-spring-security","title":"6. Spring \u9879\u76ee\u52a0\u5165 spring security \u540e\u65e0\u6cd5\u8fd0\u884c","text":"<p>\u5728\u5f15\u5165 spring security \u540e\uff0c\u5373\u4f7f\u662f permitAll() \u5728\u6253\u5f00 OnlyOffice \u9875\u9762\u8fd8\u662f\u62a5\u9519\uff0c document-server \u62a5\u9519\u5982\u4e0b\uff1a</p> <pre><code>document-server-1  | [2024-05-28T22:08:57.809] [ERROR] [localhost] [1383708097] [1] nodeJS - postData error: url = http://ubuntu.hxp.lan:4000/track?fileName=new.docx&amp;userAddress=%2Fhome%2Fhxp%2Fonlyoffice-spring-keycloak%2Fdocuments%2F127.0.1.1%2F;data = {\"key\":\"1383708097\",\"status\":1,\"users\":[\"1\"],\"actions\":[{\"type\":1,\"userid\":\"1\"}]} Error: Error response: statusCode:403; headers:{\"set-cookie\":[\"JSESSIONID=B667F99DC2C69C008DF263C81F2A5FCA; Path=/; HttpOnly\"],\"x-content-type-options\":\"nosniff\",\"x-xss-protection\":\"1; mode=block\",\"cache-control\":\"no-cache, no-store, max-age=0, must-revalidate\",\"pragma\":\"no-cache\",\"expires\":\"0\",\"x-frame-options\":\"DENY\",\"content-type\":\"application/json\",\"transfer-encoding\":\"chunked\",\"date\":\"Tue, 28 May 2024 14:08:57 GMT\",\"connection\":\"close\"}; body:\ndocument-server-1  | {\"timestamp\":1716905337808,\"status\":403,\"error\":\"Forbidden\",\"message\":\"Forbidden\",\"path\":\"/track\"}\n</code></pre> <p>\u6b64\u65f6\u9700\u8981\u68c0\u67e5 Spring \u7684\u65e5\u5fd7\uff0c\u5728 <code>application.properties</code> \u52a0\u5165\uff1a</p> <pre><code>logging.level.org.springframework.security=DEBUG\n</code></pre> <p>\u89c2\u5bdf\u5230 Spring \u5410\u51fa\u4ee5\u4e0b\u65e5\u5fd7\uff1a</p> <pre><code>2024-05-28 14:07:54.813 DEBUG 1342180 --- [nio-4000-exec-2] s.s.w.c.SecurityContextPersistenceFilter : Set SecurityContextHolder to empty SecurityContext\n2024-05-28 14:07:54.814 DEBUG 1342180 --- [nio-4000-exec-2] o.s.security.web.csrf.CsrfFilter         : Invalid CSRF token found for http://ubuntu.hxp.lan:4000/track?fileName=new.docx&amp;userAddress=%2Fhome%2Fhxp%2Fonlyoffice-spring-keycloak%2Fdocuments%2F127.0.1.1%2F\n2024-05-28 14:07:54.814 DEBUG 1342180 --- [nio-4000-exec-2] o.s.s.w.access.AccessDeniedHandlerImpl   : Responding with 403 status code\n</code></pre> <p>\u53ef\u4ee5\u786e\u5b9a\u662f spring security \u7684 csrf \u4fdd\u62a4\u8fd4\u56de\u4e86 403 \u5bfc\u81f4\u3002\u89e3\u51b3\u65b9\u6cd5\u4e3a\u4fee\u6539 SecurityChain \uff0c\u5728 http \u540e\u9762\u52a0\u4e0a <code>.csrf.disable()</code> \uff0c\u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>public SecurityFilterChain filterChain(final HttpSecurity http) throws Exception {\n    http\n            .csrf().disable()\n            .authorizeRequests()\n            .antMatchers(\"/track\", \"/download\").permitAll()\n            .anyRequest().authenticated()\n            .and()\n            .oauth2Login();\n    return http.build();\n}\n</code></pre>","tags":["OnlyOffice","SpringBoot","Maven","Java"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Java/%E4%BD%BF%E7%94%A8OnlyOffice%E5%AE%98%E6%96%B9Spring%E7%A4%BA%E4%BE%8B%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91.html#7-spring-document-server-10","title":"7. \u5728\u5185\u7f51\u90e8\u7f72\u65f6\uff0c Spring \u540e\u7aef\u8c03\u7528 document-server \u65f6\uff0c\u5b58\u5728\u5927\u7ea6 10 \u79d2\u5de6\u53f3\u7684\u5ef6\u8fdf\uff0c\u624d\u5c55\u793a\u6587\u6863\u7f16\u8f91\u9875\u9762","text":"<p>\u8fd9\u4e2a\u662f\u56e0\u4e3a document-server \u6bcf\u6b21\u88ab\u8c03\u7528\u7684\u65f6\u5019\u90fd\u4f1a\u5c1d\u8bd5\u8bbf\u95ee\u5916\u7f51\uff0c\u8bbf\u95ee\u5916\u7f51\u4f1a\u8fdb\u884c DNS \u67e5\u8be2\u3002\u800c\u5b9e\u9645\u90e8\u7f72\u65f6\uff0c\u673a\u5668\u7684 DNS \u88ab\u8bbe\u7f6e\u6210\u4e86 3 \u4e2a\u6839\u672c\u5c31\u4e0d\u901a\u7684\u5916\u7f51 DNS \uff0c\u5bfc\u81f4\u6bcf\u6b21\u5f00\u542f document-server \uff0c\u90fd\u4f1a\u8bbf\u95ee\u5916\u7f51\uff0c\u8bbf\u95ee\u5916\u7f51\u65f6\u5148\u7528\u7b2c\u4e00\u4e2a DNS \u670d\u52a1\u5668\u89e3\u6790\uff0c\u7b2c\u4e00\u4e2a DNS \u670d\u52a1\u5668\u8fde\u63a5\u8d85\u65f6\u540e\uff0c\u518d\u5c1d\u8bd5\u7b2c 2 \u4e2a DNS \u670d\u52a1\u5668\uff0c\u4ee5\u6b64\u7c7b\u63a8\u3002\u89e3\u51b3\u65b9\u6cd5\u4e3a\u4fee\u6b63\u5185\u7f51\u90e8\u7f72\u673a\u5668\u7684 DNS \u4e3a\u6b63\u786e\u7684\u914d\u7f6e\u3002</p>","tags":["OnlyOffice","SpringBoot","Maven","Java"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Java/%E4%BD%BF%E7%94%A8OnlyOffice%E5%AE%98%E6%96%B9Spring%E7%A4%BA%E4%BE%8B%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91.html#8-applicationproperties-jar","title":"8. \u5c06 application.properties \u4e0d\u6253\u5305\u5230 jar","text":"<p><code>pom.xml</code> \u589e\u52a0 plugin \uff1a</p> <pre><code>&lt;plugin&gt;\n  &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;\n  &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;\n  &lt;version&gt;3.2.0&lt;/version&gt;\n  &lt;configuration&gt;\n    &lt;excludes&gt;\n      &lt;exclude&gt;**/application.properties&lt;/exclude&gt;\n    &lt;/excludes&gt;\n  &lt;/configuration&gt;\n&lt;/plugin&gt;\n</code></pre> <p>\u8fd9\u6837\u6253\u5305\u540e\u7684 jar \u5305\u4e0d\u542b <code>application.properties</code> \uff0c\u8fd0\u884c\u9700\u8981\u624b\u52a8\u6307\u5b9a\uff1a</p> <pre><code>java -jar integration-1.0.jar --spring.config.location=file:///${HOME}/onlyoffice-spring-keycloak/src/main/resources/application.properties\n</code></pre>","tags":["OnlyOffice","SpringBoot","Maven","Java"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Java/%E4%BD%BF%E7%94%A8OnlyOffice%E5%AE%98%E6%96%B9Spring%E7%A4%BA%E4%BE%8B%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91.html#9","title":"9. \u53c2\u8003\u6587\u732e","text":"<p>https://www.baeldung.com/spring-security-enable-logging</p> <p>https://www.baeldung.com/spring-properties-file-outside-jar</p> <p>https://www.waheedtechblog.com/2014/07/how-to-exclude-properties-file-from-jar.html</p>","tags":["OnlyOffice","SpringBoot","Maven","Java"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Keycloak/k3s%E6%90%AD%E5%BB%BA%E5%8D%95%E7%82%B9Keycloak.html","title":"k3s \u642d\u5efa\u5355\u70b9 keycloak","text":"","tags":["Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Keycloak/k3s%E6%90%AD%E5%BB%BA%E5%8D%95%E7%82%B9Keycloak.html#1-mysql","title":"1. \u90e8\u7f72 MySQL \u6570\u636e\u5e93","text":"<p>\u4f7f\u7528 statefulset \u90e8\u7f72 MySQL \u6570\u636e\u5e93\uff0c yaml \u914d\u7f6e\u6587\u4ef6\u5982\u4e0b\uff1a</p> <pre><code>---\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: mysql\n  namespace: keycloak\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      name: mysql\n  template:\n    metadata:\n      labels:\n        name: mysql\n    spec:\n      containers:\n        - env:\n            - name: MYSQL_DATABASE\n              value: keycloak\n            - name: MYSQL_PASSWORD\n              value: keycloak\n            - name: MYSQL_ROOT_PASSWORD\n              value: keycloak\n            - name: MYSQL_USER\n              value: keycloak\n          image: mysql:8.0\n          name: mysql\n          ports:\n            - containerPort: 3306\n              protocol: TCP\n          volumeMounts:\n            - mountPath: /var/lib/mysql\n              name: mysql\n      restartPolicy: Always\n      volumes:\n        - name: mysql\n          persistentVolumeClaim:\n            claimName: mysql\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: mysql\n  namespace: keycloak\nspec:\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 1Gi\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: mysql\n  namespace: keycloak\nspec:\n  ports:\n    - name: \"3306\"\n      port: 3306\n      targetPort: 3306\n  selector:\n    name: mysql\n</code></pre>","tags":["Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Keycloak/k3s%E6%90%AD%E5%BB%BA%E5%8D%95%E7%82%B9Keycloak.html#2-ssl","title":"2. \u751f\u6210 SSL \u8bc1\u4e66","text":"<p>\u5373\u4f7f\u4e0d\u4f7f\u7528\uff0c\u4e5f\u9700\u8981\u81ea\u7b7e\u8bc1\u4e66\uff0c\u5426\u5219 Keycloak \u65e0\u6cd5\u4ee5\u751f\u6210\u6a21\u5f0f\u542f\u52a8\uff1a</p> <pre><code>openssl req -subj '/CN=test.keycloak.org/O=Test Keycloak./C=US' -newkey rsa:2048 -nodes -keyout key.pem -x509 -days 3650 -out certificate.pem\n</code></pre> <p>\u5c06\u8bc1\u4e66\u7531 k8s \u7ba1\u7406\uff1a</p> <pre><code>kubectl -n keycloak create secret tls keycloak --cert=certificate.pem --key=key.pem\n</code></pre>","tags":["Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Keycloak/k3s%E6%90%AD%E5%BB%BA%E5%8D%95%E7%82%B9Keycloak.html#3-keycloak","title":"3. \u90e8\u7f72 Keycloak","text":"<p>\u5148\u521b\u5efa service\uff0c\u66b4\u9732\u670d\u52a1\u7aef\u53e3 30081 \uff08\u5982\u679c\u4fee\u6539\u6b64\u7aef\u53e3\u5219\u540e\u7eed\u90fd\u9700\u8981\u4fee\u6539\uff09\uff1a</p> <pre><code>---\napiVersion: v1\nkind: Service\nmetadata:\n  name: keycloak\n  namespace: keycloak\n  labels:\n    app: keycloak\nspec:\n  type: NodePort\n  ports:\n    - name: http\n      port: 8080\n      targetPort: 8080\n      nodePort: 30081\n  selector:\n    app: keycloak\n  type: LoadBalancer\n</code></pre> <p>\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0ckeycloak \u4e0d\u540c\u5bb9\u5668\u4e4b\u95f4\u7684\u4e92\u76f8\u53d1\u73b0\u662f\u9760 IP multicast \u5e7f\u64ad\u5b9e\u73b0\uff0c\u4f46\u662f\u7531\u4e8e\u5728 k8s \u73af\u5883\u4e0b\uff0ccalico \u548c fannel \u4e0d\u652f\u6301 multicast\uff0c\u4e0d\u540c k8s \u8282\u70b9\u7684 keycloak \u5bb9\u5668\u5e7f\u64ad\u4e0d\u53ef\u8fbe\uff0c\u5c31\u65e0\u6cd5\u901a\u8fc7 multicast \u53d1\u73b0\u5f7c\u6b64\u3002\u9ed8\u8ba4\u7684 multicast \u670d\u52a1\u53d1\u73b0\u65b9\u5f0f\u5728 calico \u548c fannel \u4e0b\u4e0d\u53ef\u4f7f\u7528\uff0c\u5c31\u9700\u8981\u81ea\u5df1\u5199\u914d\u7f6e <code>cache-ispn.xml</code> \u66ff\u6362\u5bb9\u5668\u91cc\u7684\u6765\u5b9e\u73b0 keycloak \u4f7f\u7528 JDBC ping \u6765\u53d1\u73b0\u5f7c\u6b64\uff0c\u8fd9\u91cc\u76f4\u63a5\u628a\u914d\u7f6e\u5199 configmap \u7136\u540e\u6302\u8f7d\u5230\u5bb9\u5668\uff1a</p> <pre><code>---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: cache-ispn\n  namespace: keycloak\ndata:\n  cache-ispn.xml: |\n    &lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;\n    &lt;!--\n      ~ Copyright 2019 Red Hat, Inc. and/or its affiliates\n      ~ and other contributors as indicated by the @author tags.\n      ~\n      ~ Licensed under the Apache License, Version 2.0 (the \"License\");\n      ~ you may not use this file except in compliance with the License.\n      ~ You may obtain a copy of the License at\n      ~\n      ~ http://www.apache.org/licenses/LICENSE-2.0\n      ~\n      ~ Unless required by applicable law or agreed to in writing, software\n      ~ distributed under the License is distributed on an \"AS IS\" BASIS,\n      ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n      ~ See the License for the specific language governing permissions and\n      ~ limitations under the License.\n      --&gt;\n\n    &lt;infinispan\n            xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n            xsi:schemaLocation=\"urn:infinispan:config:14.0 http://www.infinispan.org/schemas/infinispan-config-14.0.xsd\"\n            xmlns=\"urn:infinispan:config:14.0\"&gt;\n        &lt;jgroups&gt;\n            &lt;stack name=\"jdbc-ping-tcp\" extends=\"tcp\"&gt;\n                &lt;JDBC_PING connection_driver=\"com.mysql.cj.jdbc.Driver\"\n                        connection_username=\"${env.KC_DB_USERNAME}\"\n                        connection_password=\"${env.KC_DB_PASSWORD}\"\n                        connection_url=\"${env.KC_DB_URL}\"\n                        info_writer_sleep_time=\"500\"\n                        initialize_sql=\"CREATE TABLE IF NOT EXISTS JGROUPSPING (own_addr varchar(200) NOT NULL, cluster_name varchar(200) NOT NULL, ping_data VARBINARY(255), constraint PK_JGROUPSPING PRIMARY KEY (own_addr, cluster_name));\"\n                        remove_all_data_on_view_change=\"true\"\n                        stack.combine=\"REPLACE\"\n                        stack.position=\"MPING\" /&gt;\n            &lt;/stack&gt;\n        &lt;/jgroups&gt;\n        &lt;cache-container name=\"keycloak\"&gt;\n            &lt;transport lock-timeout=\"60000\" stack=\"jdbc-ping-tcp\"/&gt;\n            &lt;metrics names-as-tags=\"true\" /&gt;\n            &lt;local-cache name=\"realms\"&gt;\n                &lt;encoding&gt;\n                    &lt;key media-type=\"application/x-java-object\"/&gt;\n                    &lt;value media-type=\"application/x-java-object\"/&gt;\n                &lt;/encoding&gt;\n                &lt;memory max-count=\"10000\"/&gt;\n            &lt;/local-cache&gt;\n            &lt;local-cache name=\"users\"&gt;\n                &lt;encoding&gt;\n                    &lt;key media-type=\"application/x-java-object\"/&gt;\n                    &lt;value media-type=\"application/x-java-object\"/&gt;\n                &lt;/encoding&gt;\n                &lt;memory max-count=\"10000\"/&gt;\n            &lt;/local-cache&gt;\n            &lt;distributed-cache name=\"sessions\" owners=\"2\"&gt;\n                &lt;expiration lifespan=\"-1\"/&gt;\n            &lt;/distributed-cache&gt;\n            &lt;distributed-cache name=\"authenticationSessions\" owners=\"2\"&gt;\n                &lt;expiration lifespan=\"-1\"/&gt;\n            &lt;/distributed-cache&gt;\n            &lt;distributed-cache name=\"offlineSessions\" owners=\"2\"&gt;\n                &lt;expiration lifespan=\"-1\"/&gt;\n            &lt;/distributed-cache&gt;\n            &lt;distributed-cache name=\"clientSessions\" owners=\"2\"&gt;\n                &lt;expiration lifespan=\"-1\"/&gt;\n            &lt;/distributed-cache&gt;\n            &lt;distributed-cache name=\"offlineClientSessions\" owners=\"2\"&gt;\n                &lt;expiration lifespan=\"-1\"/&gt;\n            &lt;/distributed-cache&gt;\n            &lt;distributed-cache name=\"loginFailures\" owners=\"2\"&gt;\n                &lt;expiration lifespan=\"-1\"/&gt;\n            &lt;/distributed-cache&gt;\n            &lt;local-cache name=\"authorization\"&gt;\n                &lt;encoding&gt;\n                    &lt;key media-type=\"application/x-java-object\"/&gt;\n                    &lt;value media-type=\"application/x-java-object\"/&gt;\n                &lt;/encoding&gt;\n                &lt;memory max-count=\"10000\"/&gt;\n            &lt;/local-cache&gt;\n            &lt;replicated-cache name=\"work\"&gt;\n                &lt;expiration lifespan=\"-1\"/&gt;\n            &lt;/replicated-cache&gt;\n            &lt;local-cache name=\"keys\"&gt;\n                &lt;encoding&gt;\n                    &lt;key media-type=\"application/x-java-object\"/&gt;\n                    &lt;value media-type=\"application/x-java-object\"/&gt;\n                &lt;/encoding&gt;\n                &lt;expiration max-idle=\"3600000\"/&gt;\n                &lt;memory max-count=\"1000\"/&gt;\n            &lt;/local-cache&gt;\n            &lt;distributed-cache name=\"actionTokens\" owners=\"2\"&gt;\n                &lt;encoding&gt;\n                    &lt;key media-type=\"application/x-java-object\"/&gt;\n                    &lt;value media-type=\"application/x-java-object\"/&gt;\n                &lt;/encoding&gt;\n                &lt;expiration max-idle=\"-1\" lifespan=\"-1\" interval=\"300000\"/&gt;\n                &lt;memory max-count=\"-1\"/&gt;\n            &lt;/distributed-cache&gt;\n        &lt;/cache-container&gt;\n    &lt;/infinispan&gt;\n</code></pre> <p>\u518d\u521b\u5efa deployment\uff1a</p> <pre><code>---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: keycloak\n  namespace: keycloak\n  labels:\n    app: keycloak\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: keycloak\n  template:\n    metadata:\n      labels:\n        app: keycloak\n    spec:\n      containers:\n        - name: keycloak\n          image: quay.io/keycloak/keycloak:24.0\n          args: [\"start\", \"--hostname-strict-https=false\"]\n          env:\n            - name: KEYCLOAK_ADMIN\n              value: \"admin\"\n            - name: KEYCLOAK_ADMIN_PASSWORD\n              value: \"admin\"\n            - name: KC_PROXY\n              value: \"edge\"\n            - name: KC_HTTP_ENABLED\n              value: \"true\"\n            - name: KC_HTTPS_CERTIFICATE_FILE\n              value: \"/etc/keycloak/ssl/tls.crt\"\n            - name: KC_HTTPS_CERTIFICATE_KEY_FILE\n              value: \"/etc/keycloak/ssl/tls.key\"\n            - name: KC_HOSTNAME_STRICT\n              value: \"false\"\n            - name: KC_HOSTNAME\n              value: \"keycloak.hxp.lan\"\n            - name: KC_HOSTNAME_PORT\n              value: \"30081\"\n            - name: KC_DB\n              value: mysql\n            - name: KC_DB_USERNAME\n              value: keycloak\n            - name: KC_DB_PASSWORD\n              value: keycloak\n            - name: KC_DB_URL_HOST\n              value: mysql\n            - name: KC_DB_URL_PORT\n              value: \"3306\"\n            - name: KC_DB_URL_DATABASE\n              value: keycloak\n            - name: KC_DB_URL\n              value: \"jdbc:mysql://mysql:3306/keycloak\"\n            - name: KC_CACHE_CONFIG_FILE\n              value: cache-ispn.xml\n          ports:\n            - name: http\n              containerPort: 8080\n          ports:\n            - name: discovery\n              containerPort: 7600\n          volumeMounts:\n            - mountPath: \"/etc/keycloak/ssl/\"\n              name: keycloak-ssl\n              readOnly: true\n            - name: cache-ispn\n              mountPath: /opt/keycloak/conf/cache-ispn.xml\n              subPath: cache-ispn.xml\n          readinessProbe:\n            httpGet:\n              path: /realms/master\n              port: 8080\n      volumes:\n        - name: keycloak-ssl\n          secret:\n            secretName: keycloak\n        - name: cache-ispn\n          configMap:\n            defaultMode: 0755\n            name: cache-ispn\n            items:\n            - key: cache-ispn.xml\n              path: cache-ispn.xml\n</code></pre> <p>JDBC ping \u7684\u539f\u7406\u662f\u6bcf\u4e2a keycloak \u90fd\u5f80\u6570\u636e\u5e93\u91cc\u7684 JGROUPSPING \u8868\u5199\u4e0a\u81ea\u5df1\u7684\u4fe1\u606f\uff0c\u901a\u8fc7\u8bfb\u6570\u636e\u5e93\u6765\u53d1\u73b0\u522b\u7684\u8282\u70b9\u3002\u5728\u521b\u5efa\u5b8c\u6210\u4ee5\u540e\uff0c\u9700\u8981\u8fdb\u5165\u5230\u5bb9\u5668\u91cc\uff0c\u4fee\u6539 admin realm \u7684 sslRequired \u53c2\u6570\uff08\u6b64\u65f6\u5bb9\u5668\u4e3a NotReady \u72b6\u6001\u4e3a\u6b63\u5e38\u73b0\u8c61\uff09\uff1a</p> <pre><code>kubectl -n keycloak exec -it keycloak-59d77cf866-mjchw -- /bin/bash -c '/opt/keycloak/bin/kcadm.sh update realms/master -s sslRequired=NONE --server http://keycloak:8080 --realm master --user admin'\n</code></pre>","tags":["Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Keycloak/k3s%E6%90%AD%E5%BB%BA%E5%8D%95%E7%82%B9Keycloak.html#4","title":"4. \u53c2\u8003\u94fe\u63a5","text":"<p>https://github.com/keycloak/keycloak-quickstarts/blob/release/24.0/kubernetes/keycloak.yaml</p> <p>https://www.keycloak.org/server/db#_supported_databases</p> <p>https://www.keycloak.org/server/hostname</p> <p>https://www.keycloak.org/operator/basic-deployment</p> <p>https://faun.pub/mount-ssl-certificates-in-kubernetes-pod-with-secret-8aca220896e6</p> <p>https://www.keycloak.org/operator/advanced-configuration</p> <p>https://www.keycloak.org/server/all-config</p> <p>https://www.keycloak.org/operator/basic-deployment</p> <p>https://www.keycloak.org/operator/installation</p> <p>https://www.keycloak.org/2019/05/keycloak-cluster-setup</p> <p>https://jbjerksetmyr.medium.com/how-to-setup-a-keycloak-server-with-external-mysql-database-on-aws-ecs-fargate-in-clustered-mode-edf664a765bf</p>","tags":["Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Keycloak/k8s%E9%9B%86%E7%BE%A4Keycloak%E9%83%A8%E7%BD%B2%E5%8F%8A%E8%B4%9F%E8%BD%BD%E9%85%8D%E7%BD%AE.html","title":"k8s \u96c6\u7fa4 Keycloak \u90e8\u7f72\u53ca\u8d1f\u8f7d\u914d\u7f6e","text":"","tags":["Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Keycloak/k8s%E9%9B%86%E7%BE%A4Keycloak%E9%83%A8%E7%BD%B2%E5%8F%8A%E8%B4%9F%E8%BD%BD%E9%85%8D%E7%BD%AE.html#1-mysql","title":"1. \u90e8\u7f72 MySQL \u6570\u636e\u5e93","text":"<p>\u65b0\u5efa\u4e00\u5957 MySQL-8 \u6570\u636e\u5e93\uff0c\u65b0\u5efa\u7528\u6237 keycloak \u548c\u6570\u636e\u5e93 keycloak\uff0c\u7136\u540e\u6d4b\u8bd5\u5176\u8fde\u63a5\u6027\uff1a</p> <pre><code>mysql -h'192.168.100.243' -P'3306' -ukeycloak -p keycloak\n</code></pre>","tags":["Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Keycloak/k8s%E9%9B%86%E7%BE%A4Keycloak%E9%83%A8%E7%BD%B2%E5%8F%8A%E8%B4%9F%E8%BD%BD%E9%85%8D%E7%BD%AE.html#2-ssl","title":"2. \u751f\u6210 SSL \u8bc1\u4e66","text":"<p>\u5373\u4f7f\u4e0d\u4f7f\u7528\uff0c\u4e5f\u9700\u8981\u81ea\u7b7e\u8bc1\u4e66\uff0c\u5426\u5219 Keycloak \u65e0\u6cd5\u4ee5\u751f\u6210\u6a21\u5f0f\u542f\u52a8\uff1a</p> <pre><code>openssl req -subj '/CN=test.keycloak.org/O=Test Keycloak./C=US' -newkey rsa:2048 -nodes -keyout key.pem -x509 -days 3650 -out certificate.pem\n</code></pre>","tags":["Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Keycloak/k8s%E9%9B%86%E7%BE%A4Keycloak%E9%83%A8%E7%BD%B2%E5%8F%8A%E8%B4%9F%E8%BD%BD%E9%85%8D%E7%BD%AE.html#3-keycloak","title":"3. \u90e8\u7f72 Keycloak","text":"<p>\u5148\u521b\u5efa service\uff0c\u66b4\u9732\u670d\u52a1\u7aef\u53e3 30081\uff1a</p> <pre><code>---\napiVersion: v1\nkind: Service\nmetadata:\n  name: keycloak\n  namespace: keycloak\n  labels:\n    app: keycloak\nspec:\n  type: NodePort\n  ports:\n    - name: http\n      port: 8080\n      targetPort: 8080\n      nodePort: 30081\n  selector:\n    app: keycloak\n  type: LoadBalancer\n</code></pre> <p>\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0ckeycloak \u4e0d\u540c\u5bb9\u5668\u4e4b\u95f4\u7684\u4e92\u76f8\u53d1\u73b0\u662f\u9760 IP multicast \u5e7f\u64ad\u5b9e\u73b0\uff0c\u4f46\u662f\u7531\u4e8e\u5728 k8s \u73af\u5883\u4e0b\uff0ccalico \u548c fannel \u4e0d\u652f\u6301 multicast\uff0c\u4e0d\u540c k8s \u8282\u70b9\u7684 keycloak \u5bb9\u5668\u5e7f\u64ad\u4e0d\u53ef\u8fbe\uff0c\u5c31\u65e0\u6cd5\u901a\u8fc7 multicast \u53d1\u73b0\u5f7c\u6b64\u3002\u9ed8\u8ba4\u7684 multicast \u670d\u52a1\u53d1\u73b0\u65b9\u5f0f\u5728 calico \u548c fannel \u4e0b\u4e0d\u53ef\u4f7f\u7528\uff0c\u5c31\u9700\u8981\u81ea\u5df1\u5199\u914d\u7f6e<code>cache-ispn.xml</code>\u66ff\u6362\u5bb9\u5668\u91cc\u7684\u6765\u5b9e\u73b0 keycloak \u4f7f\u7528 JDBC ping \u6765\u53d1\u73b0\u5f7c\u6b64\uff0c\u8fd9\u91cc\u76f4\u63a5\u628a\u914d\u7f6e\u5199 configmap \u7136\u540e\u6302\u8f7d\u5230\u5bb9\u5668\uff1a</p> <pre><code>---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: cache-ispn\n  namespace: keycloak\ndata:\n  cache-ispn.xml: |\n    &lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;\n    &lt;!--\n      ~ Copyright 2019 Red Hat, Inc. and/or its affiliates\n      ~ and other contributors as indicated by the @author tags.\n      ~\n      ~ Licensed under the Apache License, Version 2.0 (the \"License\");\n      ~ you may not use this file except in compliance with the License.\n      ~ You may obtain a copy of the License at\n      ~\n      ~ http://www.apache.org/licenses/LICENSE-2.0\n      ~\n      ~ Unless required by applicable law or agreed to in writing, software\n      ~ distributed under the License is distributed on an \"AS IS\" BASIS,\n      ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n      ~ See the License for the specific language governing permissions and\n      ~ limitations under the License.\n      --&gt;\n\n    &lt;infinispan\n            xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n            xsi:schemaLocation=\"urn:infinispan:config:14.0 http://www.infinispan.org/schemas/infinispan-config-14.0.xsd\"\n            xmlns=\"urn:infinispan:config:14.0\"&gt;\n        &lt;jgroups&gt;\n            &lt;stack name=\"jdbc-ping-tcp\" extends=\"tcp\"&gt;\n                &lt;JDBC_PING connection_driver=\"com.mysql.cj.jdbc.Driver\"\n                        connection_username=\"${env.KC_DB_USERNAME}\"\n                        connection_password=\"${env.KC_DB_PASSWORD}\"\n                        connection_url=\"${env.KC_DB_URL}\"\n                        info_writer_sleep_time=\"500\"\n                        initialize_sql=\"CREATE TABLE IF NOT EXISTS JGROUPSPING (own_addr varchar(200) NOT NULL, cluster_name varchar(200) NOT NULL, ping_data VARBINARY(255), constraint PK_JGROUPSPING PRIMARY KEY (own_addr, cluster_name));\"\n                        remove_all_data_on_view_change=\"true\"\n                        stack.combine=\"REPLACE\"\n                        stack.position=\"MPING\" /&gt;\n            &lt;/stack&gt;\n        &lt;/jgroups&gt;\n        &lt;cache-container name=\"keycloak\"&gt;\n            &lt;transport lock-timeout=\"60000\" stack=\"jdbc-ping-tcp\"/&gt;\n            &lt;metrics names-as-tags=\"true\" /&gt;\n            &lt;local-cache name=\"realms\"&gt;\n                &lt;encoding&gt;\n                    &lt;key media-type=\"application/x-java-object\"/&gt;\n                    &lt;value media-type=\"application/x-java-object\"/&gt;\n                &lt;/encoding&gt;\n                &lt;memory max-count=\"10000\"/&gt;\n            &lt;/local-cache&gt;\n            &lt;local-cache name=\"users\"&gt;\n                &lt;encoding&gt;\n                    &lt;key media-type=\"application/x-java-object\"/&gt;\n                    &lt;value media-type=\"application/x-java-object\"/&gt;\n                &lt;/encoding&gt;\n                &lt;memory max-count=\"10000\"/&gt;\n            &lt;/local-cache&gt;\n            &lt;distributed-cache name=\"sessions\" owners=\"2\"&gt;\n                &lt;expiration lifespan=\"-1\"/&gt;\n            &lt;/distributed-cache&gt;\n            &lt;distributed-cache name=\"authenticationSessions\" owners=\"2\"&gt;\n                &lt;expiration lifespan=\"-1\"/&gt;\n            &lt;/distributed-cache&gt;\n            &lt;distributed-cache name=\"offlineSessions\" owners=\"2\"&gt;\n                &lt;expiration lifespan=\"-1\"/&gt;\n            &lt;/distributed-cache&gt;\n            &lt;distributed-cache name=\"clientSessions\" owners=\"2\"&gt;\n                &lt;expiration lifespan=\"-1\"/&gt;\n            &lt;/distributed-cache&gt;\n            &lt;distributed-cache name=\"offlineClientSessions\" owners=\"2\"&gt;\n                &lt;expiration lifespan=\"-1\"/&gt;\n            &lt;/distributed-cache&gt;\n            &lt;distributed-cache name=\"loginFailures\" owners=\"2\"&gt;\n                &lt;expiration lifespan=\"-1\"/&gt;\n            &lt;/distributed-cache&gt;\n            &lt;local-cache name=\"authorization\"&gt;\n                &lt;encoding&gt;\n                    &lt;key media-type=\"application/x-java-object\"/&gt;\n                    &lt;value media-type=\"application/x-java-object\"/&gt;\n                &lt;/encoding&gt;\n                &lt;memory max-count=\"10000\"/&gt;\n            &lt;/local-cache&gt;\n            &lt;replicated-cache name=\"work\"&gt;\n                &lt;expiration lifespan=\"-1\"/&gt;\n            &lt;/replicated-cache&gt;\n            &lt;local-cache name=\"keys\"&gt;\n                &lt;encoding&gt;\n                    &lt;key media-type=\"application/x-java-object\"/&gt;\n                    &lt;value media-type=\"application/x-java-object\"/&gt;\n                &lt;/encoding&gt;\n                &lt;expiration max-idle=\"3600000\"/&gt;\n                &lt;memory max-count=\"1000\"/&gt;\n            &lt;/local-cache&gt;\n            &lt;distributed-cache name=\"actionTokens\" owners=\"2\"&gt;\n                &lt;encoding&gt;\n                    &lt;key media-type=\"application/x-java-object\"/&gt;\n                    &lt;value media-type=\"application/x-java-object\"/&gt;\n                &lt;/encoding&gt;\n                &lt;expiration max-idle=\"-1\" lifespan=\"-1\" interval=\"300000\"/&gt;\n                &lt;memory max-count=\"-1\"/&gt;\n            &lt;/distributed-cache&gt;\n        &lt;/cache-container&gt;\n    &lt;/infinispan&gt;\n</code></pre> <p>\u518d\u521b\u5efa deployment\uff1a</p> <pre><code>---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: keycloak\n  namespace: keycloak\n  labels:\n    app: keycloak\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: keycloak\n  template:\n    metadata:\n      labels:\n        app: keycloak\n    spec:\n      containers:\n        - name: keycloak\n          image: 192.168.100.12:8082/keycloak/keycloak:24.0\n          args: [\"start\", \"--hostname-strict-https=false\"]\n          env:\n            - name: KEYCLOAK_ADMIN\n              value: \"admin\"\n            - name: KEYCLOAK_ADMIN_PASSWORD\n              value: \"**************\"\n            - name: KC_PROXY\n              value: \"edge\"\n            - name: KC_HTTP_ENABLED\n              value: \"true\"\n            - name: KC_HTTPS_CERTIFICATE_FILE\n              value: \"/etc/keycloak/ssl/tls.crt\"\n            - name: KC_HTTPS_CERTIFICATE_KEY_FILE\n              value: \"/etc/keycloak/ssl/tls.key\"\n            - name: KC_HOSTNAME_STRICT\n              value: \"false\"\n            - name: KC_HOSTNAME\n              value: \"108.96.27.44\"\n            - name: KC_HOSTNAME_PORT\n              value: \"9003\"\n            - name: KC_DB\n              value: mysql\n            - name: KC_DB_USERNAME\n              value: keycloak\n            - name: KC_DB_PASSWORD\n              value: '********'\n            - name: KC_DB_URL_HOST\n              value: 192.168.100.243\n            - name: KC_DB_URL_PORT\n              value: \"3306\"\n            - name: KC_DB_URL_DATABASE\n              value: keycloak\n            - name: KC_DB_URL\n              value: \"jdbc:mysql://192.168.100.243:3306/keycloak\"\n            - name: KC_CACHE_CONFIG_FILE\n              value: cache-ispn.xml\n          ports:\n            - name: http\n              containerPort: 8080\n          ports:\n            - name: discovery\n              containerPort: 7600\n          volumeMounts:\n            - mountPath: \"/etc/keycloak/ssl/\"\n              name: keycloak-ssl\n              readOnly: true\n            - name: cache-ispn\n              mountPath: /opt/keycloak/conf/cache-ispn.xml\n              subPath: cache-ispn.xml\n          readinessProbe:\n            httpGet:\n              path: /realms/master\n              port: 8080\n      imagePullSecrets:\n        - name: nexus-regcred\n      volumes:\n        - name: keycloak-ssl\n          secret:\n            secretName: keycloak-tls-secret\n        - name: cache-ispn\n          configMap:\n            defaultMode: 0755\n            name: cache-ispn\n            items:\n            - key: cache-ispn.xml\n              path: cache-ispn.xml\n</code></pre> <p>JDBC ping \u7684\u539f\u7406\u662f\u6bcf\u4e2a keycloak \u90fd\u5f80\u6570\u636e\u5e93\u91cc\u7684 JGROUPSPING \u8868\u5199\u4e0a\u81ea\u5df1\u7684\u4fe1\u606f\uff0c\u901a\u8fc7\u8bfb\u6570\u636e\u5e93\u6765\u53d1\u73b0\u522b\u7684\u8282\u70b9\u3002\u5728\u521b\u5efa\u5b8c\u6210\u4ee5\u540e\uff0c\u9700\u8981\u8fdb\u5165\u5230\u5bb9\u5668\u91cc\uff0c\u4fee\u6539 admin realm \u7684 sslRequired \u53c2\u6570\uff1a</p> <pre><code>kubectl -n keycloak exec -it keycloak-8659669957-jrtqr -- /bin/bash\n/opt/keycloak/bin/kcadm.sh update realms/master -s sslRequired=NONE --server http://keycloak:8080 --realm master --user admin\n</code></pre>","tags":["Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Keycloak/k8s%E9%9B%86%E7%BE%A4Keycloak%E9%83%A8%E7%BD%B2%E5%8F%8A%E8%B4%9F%E8%BD%BD%E9%85%8D%E7%BD%AE.html#31","title":"3.1 \u914d\u7f6e\u8d1f\u8f7d\u5747\u8861\u5668","text":"<p>\u8d1f\u8f7d\u5747\u8861\u5668\u914d\u7f6e\u5982\u4e0b\uff0c\u9700\u8981\u6253\u5f00\u201c\u9644\u52a0 HTTP \u5934\u5b57\u6bb5\uff1a[\u5ba2\u6237\u7aef\u771f\u5b9e IP / X-Forwarded-For]\u201d\u529f\u80fd\uff1a </p>","tags":["Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Keycloak/k8s%E9%9B%86%E7%BE%A4Keycloak%E9%83%A8%E7%BD%B2%E5%8F%8A%E8%B4%9F%E8%BD%BD%E9%85%8D%E7%BD%AE.html#4","title":"4. \u53c2\u8003\u94fe\u63a5","text":"<p>https://github.com/keycloak/keycloak-quickstarts/blob/release/24.0/kubernetes/keycloak.yaml</p> <p>https://www.keycloak.org/server/db#_supported_databases</p> <p>https://www.keycloak.org/server/hostname</p> <p>https://www.keycloak.org/operator/basic-deployment</p> <p>https://faun.pub/mount-ssl-certificates-in-kubernetes-pod-with-secret-8aca220896e6</p> <p>https://www.keycloak.org/operator/advanced-configuration</p> <p>https://www.keycloak.org/server/all-config</p> <p>https://www.keycloak.org/operator/basic-deployment</p> <p>https://www.keycloak.org/operator/installation</p> <p>https://www.keycloak.org/2019/05/keycloak-cluster-setup</p> <p>https://jbjerksetmyr.medium.com/how-to-setup-a-keycloak-server-with-external-mysql-database-on-aws-ecs-fargate-in-clustered-mode-edf664a765bf</p>","tags":["Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Keycloak/%E4%BD%BF%E7%94%A8docker-compose%E6%90%AD%E5%BB%BAkeycloak%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83.html","title":"\u4f7f\u7528 docker-compose \u642d\u5efa keycloak \u5f00\u53d1\u73af\u5883","text":"<p>\u5f00\u53d1\u73af\u5883\u9700\u8981 keycloak \uff0c\u4f7f\u7528 docker-compose \u642d\u5efa\u8fd0\u884c\u5728 <code>172.21.1.56:8085</code> \u7684 keycloak \uff0c\u65b0\u5efa\u6587\u4ef6 <code>compose.yaml</code> \uff1a</p> <pre><code>---\nnetworks:\n  geeker-admin:\n    driver: bridge\n    name: geeker-admin\nservices:\n  keycloak:\n    command: start-dev\n    container_name: geeker-admin-keycloak\n    depends_on:\n      - mysql\n    environment:\n      KC_DB: mysql\n      KC_DB_PASSWORD: MyKeycloakMySQLPassword\n      KC_DB_URL: jdbc:mysql://mysql:3306/keycloak\n      KC_DB_USERNAME: keycloak\n      KC_HEALTH_ENABLED: true\n      KC_HOSTNAME: 172.21.1.56\n      KC_HOSTNAME_PORT: 8085\n      KC_HOSTNAME_STRICT_BACKCHANNEL: false\n      KC_HOSTNAME_STRICT_HTTPS: false\n      KC_HTTP_ENABLED: true\n      KEYCLOAK_ADMIN: admin\n      KEYCLOAK_ADMIN_PASSWORD: admin\n    expose:\n      - 8080\n    image: quay.io/keycloak/keycloak:24.0\n    networks:\n      - geeker-admin\n    ports:\n      - 8085:8080\n    restart: always\n  mysql:\n    container_name: geeker-admin-mysql\n    environment:\n      MYSQL_DATABASE: keycloak\n      MYSQL_PASSWORD: MyKeycloakMySQLPassword\n      MYSQL_ROOT_PASSWORD: MyRootPassword\n      MYSQL_USER: keycloak\n    expose:\n      - 3306\n    image: mysql:8.0\n    networks:\n      - geeker-admin\n    restart: always\n    volumes:\n      - mysql:/var/lib/mysql\nvolumes:\n  mysql:\n    driver: local\n    name: geeker-admin-mysql\n</code></pre> <p>\u7279\u522b\u6ce8\u610f\uff0c <code>KC_HOSTNAME</code> \u4e00\u5b9a\u914d\u7f6e\u6210\u670d\u52a1\u5668\u5916\u90e8\u57df\u540d\u6216 IP\uff0c\u4e0d\u80fd\u662f <code>localhost</code> \u3002\u542f\u52a8\uff1a</p> <pre><code>docker compose up\n</code></pre> <p>\u6ce8\uff1a\u7b2c\u4e00\u6b21\u542f\u52a8\u53ef\u80fd\u4e0d\u6210\u529f\uff0c\u9700\u8981\u91cd\u542f\u4e00\u6b21\u3002</p>","tags":["Keycloak","Docker"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Keycloak/%E4%BD%BF%E7%94%A8openresty%E5%AE%B9%E5%99%A8%E4%B8%BAk8s%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9BKeycloak%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1.html","title":"\u4f7f\u7528 openresty \u5bb9\u5668\u4e3a k8s \u7684\u670d\u52a1\u63d0\u4f9b Keycloak \u8ba4\u8bc1\u670d\u52a1","text":"","tags":["openresty","Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Keycloak/%E4%BD%BF%E7%94%A8openresty%E5%AE%B9%E5%99%A8%E4%B8%BAk8s%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9BKeycloak%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1.html#1","title":"1. \u524d\u7f6e\u6761\u4ef6","text":"<ul> <li>\u4e00\u4e2a\u80fd\u8fd0\u4f5c\u7684 k8s \u96c6\u7fa4</li> <li>\u76f8\u5173\u5bb9\u5668\u955c\u50cf\u4e0a\u4f20\u5230\u955c\u50cf\u4ed3\u5e93</li> <li>k8s \u914d\u7f6e\u597d\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u51ed\u8bc1</li> </ul>","tags":["openresty","Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Keycloak/%E4%BD%BF%E7%94%A8openresty%E5%AE%B9%E5%99%A8%E4%B8%BAk8s%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9BKeycloak%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1.html#2","title":"2. \u6784\u5efa\u5bb9\u5668\u955c\u50cf","text":"<p>\u4f7f\u7528 openresty-keycloak-gateway \u9879\u76ee\u8fdb\u884c\u5bb9\u5668\u955c\u50cf\u7684\u6784\u5efa\uff0c\u5176 Dockerfile \u5982\u4e0b\uff1a</p> <pre><code>FROM openresty/openresty:alpine-fat\nRUN mkdir /var/log/nginx\nRUN apk add --no-cache openssl-dev\nRUN apk add --no-cache git\nRUN apk add --no-cache gcc\nRUN luarocks install lua-resty-openidc\nENTRYPOINT [\"/usr/local/openresty/nginx/sbin/nginx\", \"-g\", \"daemon off;\"]\n</code></pre>","tags":["openresty","Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Keycloak/%E4%BD%BF%E7%94%A8openresty%E5%AE%B9%E5%99%A8%E4%B8%BAk8s%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9BKeycloak%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1.html#3-configmap","title":"3. \u521b\u5efa configmap \u6765\u5b58\u50a8\u5bb9\u5668\u914d\u7f6e","text":"<p>\u4f7f\u7528 configmap \u8fdb\u884c openresty \u914d\u7f6e\u7684\u5b58\u50a8\uff1a</p> <pre><code>---\napiVersion: v1\ndata:\n  nginx.conf: |\n    events {\n      worker_connections 1024;\n    }\n\n    http {\n      lua_package_path '~/lua/?.lua;;';\n      lua_ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;\n      lua_ssl_verify_depth 5;\n      lua_shared_dict introspection 10m;\n      server {\n        listen       8000 default_server;\n        listen       [::]:8000 default_server;\n        # disbled caching so the browser won't cache the site.\n        expires           0;\n        add_header        Cache-Control private;\n        set $session_name nginx_session;\n        set $session_secret kjlbnbuukllkj23i;\n        access_by_lua_block {\n          local keycloak_base_url = \"http://22.182.16.129:9003/\"\n          local client_id = \"IT-Automation\"\n          local realm = \"IT-Automation\"\n          local opts = {\n            client_id = client_id,\n            discovery = keycloak_base_url .. \"/realms/\" .. realm .. \"/.well-known/openid-configuration\",\n            redirect_url_scheme = \"http\",\n            redirect_uri_path = \"/redirect\",\n            logout_path = \"/logout\",\n            session_contents = {id_token=true},\n            ssl_verify = \"no\",\n          }\n          local res, err = require(\"resty.openidc\").authenticate(opts)\n          if err then\n            ngx.status = 401\n            ngx.say(err)\n            ngx.exit(ngx.HTTP_UNAUTHORIZED)\n          end\n        }\n        location / {\n          add_header Cache-Control 'no-store';\n          add_header Cache-Control 'no-cache';\n          expires 0;\n          proxy_set_header Host $host;\n          proxy_set_header X-Real-IP $remote_addr;\n          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n          proxy_set_header X-Forwarded-Proto $scheme;\n          proxy_set_header Authorization \"\";\n          proxy_http_version 1.1;\n          proxy_set_header Upgrade $http_upgrade;\n          proxy_set_header Connection \"Upgrade\";\n          proxy_pass http://mkdocs.mkdocs.svc.cluster.local/;\n        }\n      }\n    }\n</code></pre> <p>\u5176\u4e2d <code>proxy_pass</code> \u4e3a\u9700\u8981 openresty \u8fdb\u884c\u53cd\u5411\u4ee3\u7406\u7684\u5730\u5740\uff0c\u5728\u8fd9\u91cc\u4f7f\u7528\u4e86 k8s \u5185\u90e8\u7684\u57df\u540d\u89e3\u6790\uff0c\u57df\u540d\u7684\u683c\u5f0f\u4e3a <code>[service\u540d\u79f0].[namespace\u540d\u79f0].svc.cluster.local</code> \uff0c\u89e3\u6790\u5230 mkdocs \u8fd9\u4e2a namespace \u7684 mkdocs service \u3002</p>","tags":["openresty","Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Keycloak/%E4%BD%BF%E7%94%A8openresty%E5%AE%B9%E5%99%A8%E4%B8%BAk8s%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9BKeycloak%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1.html#4-deployment-pod","title":"4. \u4f7f\u7528 deployment \u90e8\u7f72 pod","text":"<p>\u4f7f\u7528\u6b64 deployment \u90e8\u7f72 pod \uff0c\u90e8\u7f72\u6570\u91cf\u4e3a 2 \u4efd\uff1a</p> <pre><code>---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: authproxy\n  namespace: mkdocs\n  labels:\n    app: authproxy\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: authproxy\n  template:\n    metadata:\n      labels:\n        app: authproxy\n    spec:\n      containers:\n        - image: 192.168.100.12:8082/authproxy:v20240508\n          name: authproxy\n          ports:\n            - containerPort: 8000\n              name: web\n          volumeMounts:\n            - name: authproxy\n              mountPath: /nginx.conf\n              subPath: nginx.conf\n          args: [\"-c\", \"/nginx.conf\"]\n      imagePullSecrets:\n        - name: nexus-regcred\n      volumes:\n        - name: authproxy\n          configMap:\n            defaultMode: 0644\n            name: authproxy\n            items:\n              - key: nginx.conf\n                path: nginx.conf\n</code></pre>","tags":["openresty","Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Keycloak/%E4%BD%BF%E7%94%A8openresty%E5%AE%B9%E5%99%A8%E4%B8%BAk8s%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9BKeycloak%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1.html#5-service","title":"5. \u4f7f\u7528 service \u66b4\u9732\u670d\u52a1","text":"<p>\u5c06 authproxy \u4ee5 NodePort \u65b9\u5f0f\u66b4\u9732\uff1a</p> <pre><code>---\napiVersion: v1\nkind: Service\nmetadata:\n  name: authproxy\n  namespace: mkdocs\n  labels:\n    app: authproxy\nspec:\n  type: NodePort\n  ports:\n    - port: 80\n      targetPort: 8000\n      name: web\n  selector:\n    app: authproxy\n</code></pre>","tags":["openresty","Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Python/Python%E5%8D%87%E7%BA%A7%E6%89%80%E6%9C%89%E4%BE%9D%E8%B5%96.html","title":"Python \u5347\u7ea7\u6240\u6709\u4f9d\u8d56","text":"","tags":["Python"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Python/Python%E5%8D%87%E7%BA%A7%E6%89%80%E6%9C%89%E4%BE%9D%E8%B5%96.html#1-pip","title":"1. \u4f7f\u7528 pip \u5217\u51fa\u6240\u6709\u4e0d\u662f\u6700\u65b0\u7684\u4f9d\u8d56","text":"<pre><code>pip list --outdated\n</code></pre> <p>\u8f93\u51fa\u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>Package                                   Version   Latest    Type\n----------------------------------------- --------- --------- -----\nBabel                                     2.14.0    2.15.0    wheel\ncertifi                                   2024.2.2  2024.6.2  wheel\nJinja2                                    3.1.3     3.1.4     wheel\nmkdocs-git-revision-date-localized-plugin 1.2.4     1.2.6     wheel\nmkdocs-print-site-plugin                  2.4.1     2.5.0     wheel\npackaging                                 24.0      24.1      wheel\nplatformdirs                              4.2.1     4.2.2     wheel\nPygments                                  2.17.2    2.18.0    wheel\npymdown-extensions                        10.8      10.8.1    wheel\nregex                                     2024.4.16 2024.5.15 wheel\nrequests                                  2.31.0    2.32.3    wheel\nwatchdog                                  4.0.0     4.0.1     wheel\n</code></pre>","tags":["Python"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Python/Python%E5%8D%87%E7%BA%A7%E6%89%80%E6%9C%89%E4%BE%9D%E8%B5%96.html#2","title":"2. \u5347\u7ea7\u6240\u6709\u4f9d\u8d56","text":"<p>\u786e\u8ba4\u65e0\u8bef\u540e\uff0c\u4e00\u952e\u5347\u7ea7\uff1a</p> <pre><code>pip install -U `pip list --outdated | awk 'NR&gt;2 {print $1}'`\n</code></pre> <p>\u4e4b\u540e\u9a8c\u8bc1\u901a\u8fc7\u540e\uff0c\u66f4\u65b0 <code>requirements.txt</code> \uff1a</p> <pre><code>pip freeze &gt; requirements.txt\n</code></pre>","tags":["Python"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Python/Python%E5%8D%87%E7%BA%A7%E6%89%80%E6%9C%89%E4%BE%9D%E8%B5%96.html#3","title":"3. \u53c2\u8003\u8d44\u6599","text":"<p>https://stackoverflow.com/questions/2720014/how-to-upgrade-all-python-packages-with-pip</p>","tags":["Python"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Python/Python%E9%99%90%E5%88%B6%E5%86%85%E5%AD%98%E5%92%8CCPU%E4%BD%BF%E7%94%A8.html","title":"Python \u9650\u5236\u5185\u5b58\u548c CPU \u4f7f\u7528","text":"","tags":["Python"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Python/Python%E9%99%90%E5%88%B6%E5%86%85%E5%AD%98%E5%92%8CCPU%E4%BD%BF%E7%94%A8.html#1","title":"1. \u9879\u76ee\u9700\u6c42","text":"<p>\u5728\u4f7f\u7528 Python \u8fdb\u884c\u76d1\u63a7\u6216\u8005\u81ea\u52a8\u5316\u64cd\u4f5c\u65f6\uff0c\u9700\u8981\u7279\u522b\u7559\u610f\u7684\u4e00\u70b9\u5c31\u662f Python \u672c\u8eab\u7684\u5185\u5b58\u4f7f\u7528\uff0c\u8b6c\u5982\u8bf4\u4f60\u5199\u4e86\u4e2a Python \u7a0b\u5e8f\uff0c\u67e5\u770b\u65e5\u5fd7\u5e76\u5728\u65e5\u5fd7\u91cc\u63d0\u53d6\u5173\u952e\u5b57\u8fdb\u884c\u5206\u6790\uff0c\u7136\u540e\u5728\u6d4b\u8bd5\u73af\u5883\u7a0b\u5e8f\u8fd0\u884c\u6ca1\u6709\u95ee\u9898\uff0c\u4f46\u662f\u5728\u751f\u4ea7\u73af\u5883\uff0c\u5927\u591a\u6570\u673a\u5668\u4e0a\u8fd0\u884c\u7684\u4e5f\u6ca1\u6709\u95ee\u9898\uff0c\u7a81\u7136\u6709\u90a3\u4e48\u4e00\u4e2a\u673a\u5668\uff0c\u65e5\u5fd7\u6709\u51e0\u4e2a G\uff0cPython \u5199\u7684\u65f6\u5019\u6ca1\u6709\u8003\u8651\u5230\u8fd9\u79cd\u60c5\u51b5\uff0c\u628a\u51e0\u4e2a G \u7684\u65e5\u5fd7\u90fd\u8f7d\u5165\u5185\u5b58\uff0c\u5bfc\u81f4\u670d\u52a1\u5668 OOM \u6545\u969c\u3002</p> <p>\u56e0\u6b64\u9700\u8981\u6709\u4e00\u79cd\u65b9\u5f0f\uff0c\u8ba9 Python \u7a0b\u5e8f\u5728\u5185\u5b58\u4f7f\u7528\u8fbe\u5230\u4e00\u4e2a\u6570\u503c\u540e\uff0c\u7533\u8bf7\u5185\u5b58\u5931\u8d25\u800c\u81ea\u6211\u7194\u65ad\u3002\u5bf9\u4e8e CPU \u8d44\u6e90\u540c\u7406\u9700\u8981\u9650\u5236\u3002</p>","tags":["Python"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Python/Python%E9%99%90%E5%88%B6%E5%86%85%E5%AD%98%E5%92%8CCPU%E4%BD%BF%E7%94%A8.html#2-linux","title":"2. Linux \u5185\u5b58\u7684\u7ba1\u7406\u673a\u5236","text":"<p>\u5728 Linux \u4e2d\uff0c\u5982\u679c\u4f7f\u7528 <code>ps</code> \u547d\u4ee4\u67e5\u770b\u8fdb\u7a0b\u7684\u5185\u5b58\u4f7f\u7528\uff0c\u4f1a\u6709 <code>VSZ</code> \u548c <code>RSS</code> \u4e24\u4e2a\u6570\u503c\u3002\u5176\u4e2d <code>VSZ</code> \u4e3a\u865a\u62df\u5185\u5b58\u5927\u5c0f\uff0c\u5373\u8fdb\u7a0b\u7533\u8bf7\u4f7f\u7528\u4e86\u591a\u5c11\u5185\u5b58\uff0c\u800c <code>RSS</code> \u4e3a\u9a7b\u7559\u96c6\u5927\u5c0f\uff0c\u5373\u5b9e\u9645\u8fd9\u4e2a\u8fdb\u7a0b\u4f7f\u7528\u4e86\u591a\u5c11\u7269\u7406\u5185\u5b58\uff08\u5305\u542b\u4e0e\u5176\u5b83\u8fdb\u7a0b\u5171\u4eab\u7684\u5185\u5b58\uff09\u3002Linux \u7684\u5185\u5b58\u5206\u914d\u673a\u5236\u4e3a\u61d2\u5206\u914d\uff0c\u5982\u679c\u7a0b\u5e8f\u9700\u8981\u4f7f\u7528\u5185\u5b58\uff0c\u5c31\u5206\u914d\u7ed9\u7a0b\u5e8f\uff0c\u4f46\u76f4\u5230\u7a0b\u5e8f\u771f\u6b63\u5c1d\u8bd5\u8bbf\u95ee\u5185\u5b58\u65f6\uff0c\u624d\u771f\u6b63\u628a\u5185\u5b58\u7ed9\u7a0b\u5e8f\u3002\u8b6c\u5982\u8bf4\u7a0b\u5e8f\u6709\u5f88\u591a\u51fd\u6570\uff0c\u4f46\u662f\u9664\u975e\u51fd\u6570\u771f\u6b63\u88ab\u8c03\u7528\uff0c\u5426\u5219\u8fd9\u4e9b\u51fd\u6570\u4e0d\u4f1a\u88ab\u52a0\u8f7d\u8fdb\u5185\u5b58\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0b <code>VSZ</code> \u9ad8\u4f46\u662f <code>RSS</code> \u4f4e\uff0c\u8282\u7ea6\u7269\u7406\u5185\u5b58\u3002</p>","tags":["Python"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Python/Python%E9%99%90%E5%88%B6%E5%86%85%E5%AD%98%E5%92%8CCPU%E4%BD%BF%E7%94%A8.html#3-resource-ulimit","title":"3. \u4f7f\u7528 resource \u6765\u914d\u7f6e ulimit","text":"<p>\u9996\u5148\u89c2\u5bdf\u8fd9\u6837\u4e00\u4e2a Python \u7a0b\u5e8f\uff08\u7531\u4e8e RLIMIT_RSS \u4ec5\u5728 Linux 2.4.30 \u4ee5\u4e0b\u6709\u7528\uff0c\u6545\u9650\u5236 RLIMIT_AS\uff09\uff1a</p> <pre><code>#!/usr/bin/python\n# -*- coding: utf-8 -*-\nfrom __future__ import print_function\nimport sys, signal, resource, time, os\nfrom subprocess import Popen, PIPE\n\n\nclass Command:\n    def __init__(self, command, time_limit):\n        self.command = command\n        self.time_limit = time_limit\n        self.stdout = None\n        self.stderr = None\n        self.return_code = None\n\n    def run(self):\n        process = Popen(\n            [\n                \"timeout\",\n                \"-s\",\n                \"9\",\n                str(self.time_limit),\n                \"/bin/bash\",\n                \"-c\",\n                self.command,\n            ],\n            stdout=PIPE,\n            stderr=PIPE,\n        )\n        out, err = process.communicate()\n        self.stdout = out.decode()\n        self.stderr = err.decode()\n        self.return_code = process.returncode\n\n\nclass ResourceLimit:\n    def set_memory_limit(self, size_mb):\n        size_bytes = size_mb * 1024 * 1024\n        resource.setrlimit(resource.RLIMIT_AS, (size_bytes, size_bytes))\n\n    def get_memory_limit(self):\n        soft, hard = resource.getrlimit(resource.RLIMIT_AS)\n        print(\"[INFO] Current memory limit: %s (soft) %s (hard)\" % (soft, hard))\n\n    def get_memory_usage(self):\n        command = Command(\n            \"ps -o user,pid,pcpu,pmem,vsz,rss,args -p %s\" % os.getpid(), 5\n        )\n        command.run()\n        print(\"==== MEMORY USAGE ====\")\n        print(command.stdout)\n\n    def set_max_runtime(self, seconds):\n        resource.setrlimit(resource.RLIMIT_CPU, (seconds, seconds))\n\n    def get_max_runtime(self):\n        soft, hard = resource.getrlimit(resource.RLIMIT_CPU)\n        print(\"[INFO] Current runtime limit: %ss (soft) %ss (hard)\" % (soft, hard))\n\n\ndef main():\n    df = Command(\"df -PTh\", 5)\n    df.run()\n    print(\"=== STDOUT ====\\n%s\" % df.stdout)\n    print(\"=== STDERR ====\\n%s\" % df.stderr)\n    print(\"RETURN CODE: %s\" % df.return_code)\n    sleep = Command(\"sleep 10\", 5)\n    sleep.run()\n    print(\"=== STDOUT ====\\n%s\" % sleep.stdout)\n    print(\"=== STDERR ====\\n%s\" % sleep.stderr)\n    print(\"RETURN CODE: %s\" % sleep.return_code)\n    # while True:\n    #     pass\n\n\nif __name__ == \"__main__\":\n    ResourceLimit().set_memory_limit(64)\n    ResourceLimit().set_max_runtime(1)\n    ResourceLimit().get_memory_limit()\n    ResourceLimit().get_max_runtime()\n    ResourceLimit().get_memory_usage()\n    main()\n    ResourceLimit().get_memory_usage()\n</code></pre> <p>\u8fd9\u6bb5\u4ee3\u7801\u4e2d\uff0c <code>Command</code> \u7c7b\u7528\u4e8e\u6267\u884c\u7cfb\u7edf\u547d\u4ee4\uff0c <code>ResourceLimit</code> \u7c7b\u7528\u4e8e\u9650\u5236\u7cfb\u7edf\u7684 CPU \u548c\u5185\u5b58\u4f7f\u7528\u3002\u6bcf\u5f53\u6267\u884c<code>ResourceLimit().get_memory_usage()</code> \u65f6\uff0c\u90fd\u8c03\u7528\u7cfb\u7edf\u7684 <code>ps</code> \u547d\u4ee4\u5e76\u6253\u5370\u51fa\u7a0b\u5e8f\u5f53\u524d\u7684\u5185\u5b58\u5927\u5c0f\uff0c\u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>==== MEMORY USAGE ====\nUSER       PID %CPU %MEM    VSZ   RSS COMMAND\nroot       167  0.0  0.0  33280  5504 python main.py\n</code></pre> <p>\u8fd9\u8868\u793a\u7a0b\u5e8f\u7533\u8bf7\u4e86 33MB \u5185\u5b58\uff0c\u4f46\u662f\u5b9e\u9645\u4f7f\u7528\u4e86 5.5 MB \u3002\u540c\u65f6\uff0c\u5728\u8fd9\u4e2a\u7a0b\u5e8f\u4e2d\uff0c\u6211\u4eec\u9650\u5236\u4e86 CPU \u8fd0\u884c\u65f6\u95f4 1 \u79d2\uff0c\u5982\u679c\u628a\u6b7b\u5faa\u73af\u7684\u8bed\u53e5\u7684\u6ce8\u91ca\u62ff\u6389\uff0c\u7a0b\u5e8f\u8fdb\u5165\u6b7b\u5faa\u73af\u540e 1 \u79d2\u5c31\u88ab Kill \uff0c\u4f46\u662f\u5728\u6ca1\u6709\u62ff\u6389\u6ce8\u91ca\u65f6\uff0c\u7a0b\u5e8f\u5b9e\u9645\u8fd0\u884c\u65f6\u95f4\u5927\u4e8e 1 \u79d2\u3002\u8fd9\u4e2a\u662f\u6b63\u5e38\u73b0\u8c61\uff0c\u56e0\u4e3a\u6211\u4eec\u9650\u5236\u7684\u662f\u8fd9\u4e2a python \u8fdb\u7a0b\u7684\u5b9e\u9645\u5728 CPU \u4e0a\u4f7f\u7528\u7684\u65f6\u95f4\uff0c\u4e0d\u5305\u542b\u5b83 sleep \u7684\u65f6\u95f4\u548c\u5b50\u8fdb\u7a0b\u7684\u65f6\u95f4\u3002\u53ef\u4ee5\u7528 time \u547d\u4ee4\u5f97\u5230\u5b9e\u9645\u5728 CPU \u4e0a\u8dd1\u7684\u65f6\u95f4\uff1a</p> <pre><code>time python src/main.py\n</code></pre> <p>time \u547d\u4ee4\u663e\u793a\u5b9e\u9645\u7a0b\u5e8f\u7528\u7684\u73b0\u5b9e\u65f6\u95f4\u662f 5 \u79d2\uff0c\u4f46\u662f\u5176\u5728 CPU \u4e0a\u8fd0\u884c\u7684\u65f6\u95f4\u53ea\u6709 0.1 \u79d2\u4e0d\u5230\u3002</p> <pre><code>real    0m5.020s\nuser    0m0.016s\nsys     0m0.006s\n</code></pre>","tags":["Python"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Python/Python%E9%99%90%E5%88%B6%E5%86%85%E5%AD%98%E5%92%8CCPU%E4%BD%BF%E7%94%A8.html#4","title":"4. \u53c2\u8003\u8d44\u6599","text":"<p>https://linuxconfig.org/ps-output-difference-between-vsz-vs-rss-memory-usage</p> <p>https://cloud.tencent.com/developer/article/1121759</p> <p>https://unix.stackexchange.com/questions/375889/unix-command-to-tell-how-much-ram-was-used-during-program-runtime</p> <p>https://docs.python.org/2/library/resource.html</p> <p>https://www.geeksforgeeks.org/python-how-to-put-limits-on-memory-and-cpu-usage/</p>","tags":["Python"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Python/%E5%9F%BA%E4%BA%8EPython%E7%9A%84%E6%A8%A1%E5%9D%97%E5%8C%96%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7%E7%9A%84%E5%BC%80%E5%8F%91.html","title":"\u57fa\u4e8e Python \u7684\u6a21\u5757\u5316\u76d1\u63a7\u5de5\u5177\u7684\u5f00\u53d1","text":"","tags":["Python"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Python/%E5%9F%BA%E4%BA%8EPython%E7%9A%84%E6%A8%A1%E5%9D%97%E5%8C%96%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7%E7%9A%84%E5%BC%80%E5%8F%91.html#1","title":"1. \u9879\u76ee\u80cc\u666f","text":"<p>\u5927\u578b\u516c\u53f8\u6709\u975e\u5e38\u591a\u7684\u5b9a\u5236\u5316\u76d1\u63a7\u9700\u6c42\uff0c Zabbix \u3001 Prometheus \u7b49\u76d1\u63a7\u5de5\u5177\u4e0d\u80fd\u6ee1\u8db3\uff0c\u5fc5\u987b\u8fd0\u7ef4\u4eba\u5458\u5f00\u53d1\u5b9a\u5236\u7684\u811a\u672c\u5b9e\u73b0\u76d1\u63a7\u3002\u4f46\u662f\u5728\u5f00\u53d1\u7684\u8fc7\u7a0b\u4e2d\uff0c\u9047\u5230\u4e86\u4ee5\u4e0b\u51e0\u70b9\u56f0\u96be\uff1a</p> <ol> <li>\u968f\u7740\u9700\u6c42\u7684\u589e\u52a0\uff0c\u6bcf\u589e\u52a0\u4e00\u4e2a\u76d1\u63a7\u9879\uff0c\u5c31\u589e\u52a0\u4e00\u4e2a\u811a\u672c\u3002\u811a\u672c\u4f7f\u7528 crontab \u8fdb\u884c\u8fd0\u884c\uff0c crontab \u8d8a\u52a0\u8d8a\u591a\uff0c\u4e14\u9879\u76ee\u7684\u6587\u4ef6\u8d8a\u6765\u8d8a\u591a\uff0c crontab \u4e5f\u8d8a\u6765\u8d8a\u591a\u3002\u968f\u7740\u9879\u76ee\u7684\u53d1\u5c55\uff0c\u8d8a\u6765\u8d8a\u4e0d\u597d\u7ef4\u62a4\u3002</li> <li>\u4ee3\u7801\u53ef\u91cd\u590d\u5229\u7528\u7387\u4f4e\uff0c\u5f88\u591a\u7684\u811a\u672c\u90fd\u9700\u8981\u5b9e\u73b0\u4e00\u4e2a\u5171\u540c\u6216\u76f8\u4f3c\u7684\u529f\u80fd\uff0c\u4e8b\u5b9e\u4e0a\u9879\u76ee\u91cc\u662f\u76f8\u540c\u7684\u4ee3\u7801\u4e0d\u505c\u5728\u4e0d\u540c\u811a\u672c\u4e2d\u590d\u5236\u7c98\u8d34\uff0c\u4e14\u4e00\u65e6\u5171\u6027\u7684\u4ee3\u7801\u88ab\u4fee\u6539\uff0c\u6240\u6709\u811a\u672c\u90fd\u9700\u8981\u4fee\u6539\u3002</li> <li>\u4ee3\u7801 BUG \u65e0\u6cd5\u907f\u514d\uff0c\u7531\u4e8e\u811a\u672c\u4f7f\u7528 Shell \u8fdb\u884c\u5f00\u53d1\uff0c Shell \u8bed\u6cd5\u4e2d\u5e76\u6ca1\u6709\u53d8\u91cf\u7c7b\u578b\u7684\u6982\u5ff5\uff0c\u7ecf\u5e38\u662f\u811a\u672c\u6267\u884c\u4e86\u4e00\u4e2a\u547d\u4ee4\uff0c\u547d\u4ee4\u6ca1\u6709\u6309\u7167\u671f\u671b\u8fd4\u56de\uff0c\u4f46\u662f Shell \u7ee7\u7eed\u6267\u884c\uff0c\u5e76\u6ca1\u6709\u50cf\u5176\u5b83\u8bed\u8a00\u5728\u7c7b\u578b\u8f6c\u6362\u65f6\u629b\u51fa\u5f02\u5e38\u3002\u540c\u65f6\uff0c Shell \u4e2d\u6bd4\u8f83\u5927\u5c0f\u7ecf\u5e38\u7531\u4e8e\u5c0f\u6570\u548c\u6574\u6570\u6bd4\u8f83\u5927\u5c0f\u7684\u95ee\u9898\uff0c\u6216\u8005\u5c06\u5c0f\u6570\u8f6c\u5316\u4e3a\u6574\u6570\u7684\u95ee\u9898\uff0c\u5bfc\u81f4\u811a\u672c\u5f97\u5230\u7684\u6570\u636e\u548c\u9608\u503c\u6570\u636e\u6bd4\u8f83\u7ed3\u679c\u4e0d\u6b63\u786e\u3002</li> </ol>","tags":["Python"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Python/%E5%9F%BA%E4%BA%8EPython%E7%9A%84%E6%A8%A1%E5%9D%97%E5%8C%96%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7%E7%9A%84%E5%BC%80%E5%8F%91.html#2-python","title":"2. Python \u9879\u76ee\u7684\u6253\u5305\u65b9\u5f0f\u6bd4\u8f83","text":"<p>\u5bf9\u4e8e\u8fd9\u4e2a\u9879\u76ee\uff0c\u663e\u7136\u9700\u8981\u5c06 Python \u9879\u76ee\u8fdb\u884c\u6253\u5305\uff0c\u5426\u5219\u8fd8\u662f\u4f1a\u6709\u968f\u7740\u9879\u76ee\u7684\u63a8\u8fdb\u3001\u5f80\u670d\u52a1\u5668\u4e0a\u90e8\u7f72\u7684\u811a\u672c\u6587\u4ef6\u8d8a\u6765\u8d8a\u591a\u7684\u95ee\u9898\u3002\u76ee\u524d Python \u9879\u76ee\u7684\u6253\u5305\u5927\u81f4\u6709\u4f7f\u7528 PyInstaller \u548c zipapp \u4e24\u79cd\u65b9\u5f0f\u3002\u4e0d\u63a8\u8350\u4f7f\u7528 PyInstaller \u7684\u539f\u56e0\u4e3a\uff1aPyInstaller \u867d\u7136\u4e0d\u9700\u8981\u76ee\u6807\u4e3b\u673a\u5b89\u88c5 Python\uff0c\u4f46\u662f\u5b83\u5728\u8fd0\u884c\u7684\u65f6\u5019\u4f1a\u5728 /tmp \u4e0b\u521b\u5efa\u4e34\u65f6\u76ee\u5f55\u5b58\u653e Python \u4ee3\u7801\uff0c\u5982\u679c\u9047\u5230\u4e86\u95ee\u9898\u4e2d\u9014\u5d29\u6e83\uff0c\u5219\u4e34\u65f6\u76ee\u5f55\u4e0d\u4f1a\u88ab\u6e05\u7a7a\u3002\u8fd9\u4f1a\u5bfc\u81f4\u5982\u679c\u7a0b\u5e8f\u4ee3\u7801\u6709\u95ee\u9898\uff0c\u968f\u7740 crontab \u4e0d\u65ad\u8c03\u7528\u4ee3\u7801\u4f1a\u5bfc\u81f4 /tmp \u76ee\u5f55\u4e0b\u5b50\u76ee\u5f55\u8d8a\u6765\u8d8a\u591a\u3002</p> <p>\u5982\u679c\u4f7f\u7528 zipapp \u65b9\u5f0f\uff0c\u5219\u9700\u8981\u7ed9\u6240\u6709\u7684\u673a\u5668\u901a\u8fc7\u89e3\u538b\u7684\u65b9\u5f0f\u5b89\u88c5\u4e00\u4e2a Python3 \u4f9b\u9879\u76ee\u8fd0\u884c\u4f7f\u7528\u3002\u672c\u6b21\u793a\u4f8b\u5c06 Python-3.7.17 \u89e3\u538b\u548c\u9879\u76ee\u653e\u5230\u4e86 <code>/opt/Python-3.7.17</code> \u76ee\u5f55\u4e0b\u3002</p>","tags":["Python"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Python/%E5%9F%BA%E4%BA%8EPython%E7%9A%84%E6%A8%A1%E5%9D%97%E5%8C%96%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7%E7%9A%84%E5%BC%80%E5%8F%91.html#3","title":"3. \u9879\u76ee\u7ed3\u6784","text":"<p>\u9879\u76ee\u7684\u7ed3\u6784\u5982\u4e0b\uff1a</p> <pre><code>.\n\u251c\u2500\u2500 build.sh\n\u251c\u2500\u2500 dist\n\u2502   \u2514\u2500\u2500 monitor.pyz\n\u251c\u2500\u2500 run.sh\n\u2514\u2500\u2500 src\n    \u251c\u2500\u2500 monitor.py\n    \u2514\u2500\u2500 utils\n        \u2514\u2500\u2500 command.py\n</code></pre> <p>\u5176\u4e2d dist \u76ee\u5f55\u4e3a\u5b58\u653e\u6253\u5305\u597d Python \u9879\u76ee\u7684\u76ee\u5f55\u3002</p>","tags":["Python"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Python/%E5%9F%BA%E4%BA%8EPython%E7%9A%84%E6%A8%A1%E5%9D%97%E5%8C%96%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7%E7%9A%84%E5%BC%80%E5%8F%91.html#4-python","title":"4. \u9879\u76ee\u6838\u5fc3 Python \u4ee3\u7801\u67b6\u6784","text":"<p>\u76ee\u5f55 <code>src</code> \u4e0b\u4e3a\u76d1\u63a7\u5de5\u5177\u4ee3\u7801\uff0c\u5176\u4e2d <code>monitor.py</code> \u4e3a\u7a0b\u5e8f\u7684\u5165\u53e3\uff1a</p> <pre><code>from utils.command import run\n\ndef main():\n    ls_result=run(['ls', '-lh'])\n    print(ls_result)\n    cat_result=run(['cat', '/proc/meminfo'])\n    print(cat_result)\n    cat_result=run(['cat', '/tmp/100MB.bin'])\n    print(cat_result)\n\nif __name__ == '__main__':\n    main()\n</code></pre> <p>\u6240\u6709\u7684\u529f\u80fd\u4ee5\u6a21\u5757\u7684\u5f62\u5f0f\u653e\u5728 <code>utils</code> \u4e0b\uff0c\u5176\u4e2d <code>utils/command.py</code> \u4e3a Shell \u547d\u4ee4\u76f8\u5173\u7684\u6a21\u5757\uff0c\u6a21\u5757\u91cc\u6709\u4e2a\u51fd\u6570 <code>run</code> \u662f\u7528\u6765\u8fd0\u884c\u547d\u4ee4\u5e76\u8fd4\u56de\u547d\u4ee4\u8fd0\u884c\u7ed3\u679c\u7684\uff1a</p> <pre><code>import subprocess\n\ndef run(cmd):\n    return subprocess.check_output(cmd).decode('utf-8').split('\\n')\n</code></pre> <p>\u5982\u679c\u65e5\u540e\u6709\u65b0\u589e\u6a21\u5757\u7684\u9700\u6c42\uff0c\u8b6c\u5982\u8bf4\u589e\u52a0 HBA \u5361\u72b6\u6001\u76d1\u63a7\uff0c\u5219\u65b0\u5efa Python \u6587\u4ef6 <code>utils/hba.py</code> \uff0c\u5e76\u5728\u91cc\u9762\u5199\u76f8\u5e94\u7684\u51fd\u6570\u6765\u5b9e\u73b0\u76d1\u63a7\uff0c\u6700\u540e\u5728 <code>monitor.py</code> \u91cc\u8c03\u7528\u3002</p>","tags":["Python"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Python/%E5%9F%BA%E4%BA%8EPython%E7%9A%84%E6%A8%A1%E5%9D%97%E5%8C%96%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7%E7%9A%84%E5%BC%80%E5%8F%91.html#5","title":"5. \u9879\u76ee\u7684\u6784\u5efa\u4e0e\u8fd0\u884c","text":"<p><code>run.sh</code> \u4e3a\u8fd0\u884c\u9879\u76ee\u7684\u811a\u672c\uff0c\u5982\u4e0b\uff1a</p> <pre><code>#!/bin/bash\nulimit -v 128000 # Limit memory usage to 128MiB\nPYTHON_INSTALL_DIR=/opt/Python-3.7.17/\nLOG_FILE=/tmp/systemmon.out\nexport PATH=$PYTHON_INSTALL_DIR/bin:$PATH\nexport LD_LIBRATY_PATH=$PYTHON_INSTALL_DIR/lib:$LD_LIBRATY_PATH\necho \"Current Python version is: $(python3 --version)\"\npython3 dist/monitor.pyz 2&gt;&amp;1 | tee -a $LOG_FILE\n</code></pre> <p>\u5728\u8fd9\u4e2a\u811a\u672c\u91cc\u4f7f\u7528 ulimit \u9650\u5236\u4e86 Python \u7a0b\u5e8f\u5728\u6267\u884c\u65f6\uff0c\u6700\u9ad8\u6d88\u8017 128MB \u5185\u5b58\uff0c\u5982\u679c\u8d85\u8fc7\u9650\u5236\uff0cPython \u4f1a\u62a5\u9519 <code>MemoryError</code> \u5e76\u88ab\u6740\u6b7b\u3002\u53ef\u5c06\u6b64\u811a\u672c\u52a0\u5230 crontab \u91cc\u5b9a\u65f6\u6267\u884c\u6765\u5b9e\u73b0\u76d1\u63a7\uff0c\u540c\u65f6\u811a\u672c\u6240\u6709\u7684\u8f93\u51fa\uff0c\u7528 <code>tee -a</code> \u7684\u65b9\u5f0f\u91cd\u5b9a\u5411\u5230\u4e86\u53d8\u91cf <code>LOG_FILE</code> \u5b9a\u4e49\u7684\u65e5\u5fd7\u6587\u4ef6\u3002</p> <p><code>build.sh</code> \u4e3a\u6253\u5305 Python \u7684\u811a\u672c\uff1a</p> <pre><code>#!/bin/bash\nPYTHON_INSTALL_DIR=/opt/Python-3.7.17/\nAPP_NAME=monitor\nexport PATH=$PYTHON_INSTALL_DIR/bin:$PATH\nexport LD_LIBRATY_PATH=$PYTHON_INSTALL_DIR/lib:$LD_LIBRATY_PATH\necho \"Current Python version is: $(python3 --version)\"\nmkdir -p dist\npython3 -m zipapp src -o dist/$APP_NAME.pyz -m \"monitor:main\"\n</code></pre> <p>\u8fd9\u4e2a\u811a\u672c\u8d1f\u8d23\u5c06 <code>src</code> \u76ee\u5f55\u4e0b\u7684\u6240\u6709\u4ee3\u7801\u6253\u5305\u6210\u4e3a pyz \u683c\u5f0f\u7684 Python \u5305\uff0c\u5e76\u5c06\u5176\u653e\u5728 <code>dist</code> \u76ee\u5f55\u4e0b\u3002</p>","tags":["Python"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Python/%E6%9E%84%E5%BB%BA%E8%A7%A3%E5%8E%8B%E5%8D%B3%E7%94%A8%E7%9A%84Python3.html","title":"\u6784\u5efa\u89e3\u538b\u5373\u7528\u7684 Python3","text":"","tags":["Python"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Python/%E6%9E%84%E5%BB%BA%E8%A7%A3%E5%8E%8B%E5%8D%B3%E7%94%A8%E7%9A%84Python3.html#1","title":"1. \u80cc\u666f","text":"<p>\u5728\u590d\u6742\u7684\u8fd0\u7ef4\u573a\u666f\u4e0b\uff0c\u4e0d\u540c\u7684 Linux \u64cd\u4f5c\u7cfb\u7edf\u7684 Python \u7248\u672c\u4e0d\u4e00\uff0c\u6709\u7684\u64cd\u4f5c\u7cfb\u7edf\u662f Python2\uff0c\u6709\u7684\u662f Python3 \uff0c\u4e14\u5373\u4f7f\u90fd Python3\uff0c\u5404\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u7684 Python3 \u7684\u7248\u672c\u4e5f\u4e0d\u4e00\u6837\u3002\u5982\u679c\u6211\u4eec\u8981\u53d1\u5e03\u4e00\u4e2a\u7a0b\u5e8f\uff0c\u8b6c\u5982\u8bf4\u76d1\u63a7\u7a0b\u5e8f\uff0c\u9700\u8981\u8ba9\u4e0d\u540c\u7684\u64cd\u4f5c\u7cfb\u7edf\u90fd\u80fd\u8fd0\u884c\uff0c\u5219\u9700\u8981\u628a\u6240\u6709\u64cd\u4f5c\u7cfb\u7edf\u90fd\u9002\u914d\u4e00\u904d\uff0c\u4e14\u6bcf\u6b21\u66f4\u65b0\u90fd\u9700\u8981\u9002\u914d\u3002\u4e0d\u5982\u76f4\u63a5\u5355\u72ec\u5e26\u4e00\u4e2a Python \u5230\u6240\u6709\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u3002</p>","tags":["Python"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Python/%E6%9E%84%E5%BB%BA%E8%A7%A3%E5%8E%8B%E5%8D%B3%E7%94%A8%E7%9A%84Python3.html#2-python3-opt","title":"2. \u7f16\u8bd1\u4e00\u4efd Python3 \u5e76\u5c06\u5176\u5b89\u88c5\u5230 /opt \u76ee\u5f55","text":"<p>\u7531\u4e8e\u4e0d\u540c\u7248\u672c\u7684 Linux \u7684 glibc \u7248\u672c\u4e0d\u540c\uff0c\u4e14\u9ad8\u7248\u672c\u7684 glibc \u517c\u5bb9\u4f4e\u7248\u672c\uff0c\u53cd\u4e4b\u4e0d\u517c\u5bb9\uff0c\u56e0\u6b64\u9700\u8981\u5728\u4f60\u9700\u8981\u9002\u914d\u7684\u6700\u4f4e\u7248\u672c Linux \u4e0a\u7f16\u8bd1\uff0c\u6211\u8fd9\u91cc\u9009\u7528\u7684 CentOS 6 \uff0c\u540c\u65f6\uff0c\u7f16\u8bd1\u4e0d\u9700\u8981\u771f\u7684\u5b89\u88c5 CentOS 6 \uff0c\u53ef\u4ee5\u4f7f\u7528 docker \u5bb9\u5668\u5e76\u5728\u5bb9\u5668\u91cc\u7f16\u8bd1\u3002\u6211\u7684 Dockerfile \u5982\u4e0b\uff1a</p> <pre><code>FROM centos:6.10\nCOPY &lt;&lt;-'EOF' /etc/yum.repos.d/CentOS-Base.repo\n[base]\nname=CentOS-$releasever - Base\nbaseurl=https://vault.centos.org/6.10/os/$basearch/\ngpgcheck=0\nEOF\nRUN yum install -y make gcc zlib-devel\nRUN mkdir -p /build\nWORKDIR /build\nRUN curl https://www.python.org/ftp/python/3.7.17/Python-3.7.17.tgz -o Python-3.7.17.tgz\nRUN tar -zxf Python-3.7.17.tgz -C /build\nWORKDIR /build/Python-3.7.17\nRUN ./configure --prefix=/opt/Python-3.7.17\nRUN make install\nWORKDIR /opt\nVOLUME /opt\nCMD [\"/bin/bash\"]\n</code></pre> <p>\u4f7f\u7528 docker \u6784\u5efa\u4e00\u4e2a\u5bb9\u5668\u5e76\u5728\u5bb9\u5668\u91cc\u7f16\u8bd1\u51fa Python3\uff0c\u5b89\u88c5\u5230\u5bb9\u5668\u7684 /opt \u76ee\u5f55\uff1a</p> <pre><code>docker build -t centos6-python3.7 .\n</code></pre> <p>\u4e4b\u540e\u5c06\u5bb9\u5668\u5185\u7f16\u8bd1\u597d\u7684 Python3 \u590d\u5236\u51fa\u6765\uff1a</p> <pre><code>mkdir -p dist\ndocker run --rm -v ./dist:/mnt centos6-python3.7 /bin/bash -c 'cd /opt &amp;&amp; /bin/tar zcpf /mnt/Python-3.7.17.tgz Python-3.7.17'\n</code></pre>","tags":["Python"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Python/%E6%9E%84%E5%BB%BA%E8%A7%A3%E5%8E%8B%E5%8D%B3%E7%94%A8%E7%9A%84Python3.html#3-python3","title":"3. \u4f7f\u7528 Python3","text":"<p>\u5c06\u6574\u4e2a Python-3.7.17 \u76ee\u5f55\u590d\u5236\u5230\u522b\u7684\u673a\u5668\u4e0a\uff0c\u8fd0\u884c\u524d\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf\uff1a</p> <pre><code>export PATH=$PWD/Python-3.7.17/bin:$PATH\nexport LD_LIBRATY_PATH=$PWD/Python-3.7.17/lib:$LD_LIBRATY_PATH\necho \"Current Python version is: $(python3 --version)\"\n</code></pre> <p>\u4e4b\u540e\u4f7f\u7528 python3 \u547d\u4ee4\u6267\u884c\u3002</p>","tags":["Python"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Rust/Rust%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85.html","title":"Rust \u4ea4\u53c9\u7f16\u8bd1\u73af\u5883\u79bb\u7ebf\u5b89\u88c5","text":""},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Rust/Rust%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85.html#1","title":"1. \u5b89\u88c5\u51c6\u5907","text":"<p>\u4e0b\u8f7d\u4ee5\u4e0b\u6587\u4ef6\uff1a</p> <ul> <li>aarch64-linux-musl-cross.tgz</li> <li>rust-std-1.80.1-aarch64-unknown-linux-musl.tar.xz</li> </ul> <p>\u5176\u4e2d MUSL \u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\u4e0b\u8f7d\u5730\u5740\u89c1 https://musl.cc \uff0cRust \u76f8\u5173\u4e0b\u8f7d\u5730\u5740\u89c1 https://static.rust-lang.org/dist/channel-rust-stable.toml</p>"},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Rust/Rust%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85.html#2-musl","title":"2. \u5b89\u88c5 MUSL \u4ea4\u53c9\u7f16\u8bd1\u73af\u5883","text":"<pre><code>tar -zxf aarch64-linux-musl-cross.tgz -C ~/softwares/rust/\n</code></pre> <p>\u4fee\u6539 <code>~/.bashrc</code> \uff1a</p> <pre><code>export PATH=~/softwares/rust/aarch64-linux-musl-cross/bin/:$PATH\n</code></pre> <pre><code>source ~/.bashrc\n</code></pre>"},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Rust/Rust%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85.html#3-rust-std","title":"3. \u5b89\u88c5\u76ee\u6807\u7248\u672c rust-std","text":"<p>\u89e3\u538b <code>rust-std</code> \u5e76\u5b89\u88c5 \uff1a</p> <pre><code>tar -xJf rust-std-1.80.1-aarch64-unknown-linux-musl.tar.xz\n./rust-std-1.80.1-aarch64-unknown-linux-musl/install.sh --prefix=$HOME/softwares/rust/\n</code></pre>"},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Rust/Rust%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85.html#4-cargo","title":"4. \u914d\u7f6e cargo","text":"<p>\u4fee\u6539 <code>~/.cargo/config.toml</code> \uff1a</p> <pre><code>[target.aarch64-unknown-linux-musl]\nlinker = \"aarch64-linux-musl-ld\"\n</code></pre>"},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Rust/Rust%E7%A6%BB%E7%BA%BF%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85.html","title":"Rust \u79bb\u7ebf\u5f00\u53d1\u73af\u5883\u5b89\u88c5","text":""},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Rust/Rust%E7%A6%BB%E7%BA%BF%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85.html#1","title":"1. \u5b89\u88c5\u51c6\u5907","text":"<p>\u4e0b\u8f7d\u4ee5\u4e0b\u6587\u4ef6\uff1a</p> <ul> <li>rust-1.80.1-aarch64-unknown-linux-gnu.tar.xz</li> <li>rust-std-1.80.1-aarch64-unknown-linux-musl.tar.xz</li> <li>rust-src-1.80.1.tar.xz</li> <li>rustup-init</li> </ul> <p>\u5b89\u88c5\u5730\u5740\u8be6\u89c1 https://static.rust-lang.org/dist/channel-rust-stable.toml \u548c https://rust-lang.github.io/rustup/installation/other.html</p>"},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Rust/Rust%E7%A6%BB%E7%BA%BF%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85.html#2","title":"2. \u914d\u7f6e\u5b89\u88c5\u8def\u5f84","text":"<p>\u4f7f\u7528\u73af\u5883\u53d8\u91cf\u914d\u7f6e\u5b89\u88c5\u8def\u5f84\uff1a</p> <pre><code>export RUST_INSTALL_DIR=${HOME}/softwares/rust\nmkdir -p $RUST_INSTALL_DIR\n</code></pre> <p>\u5982\u679c\u4e2d\u9014\u9000\u51fa\u5b89\u88c5\uff0c\u4e0b\u6b21\u7ee7\u7eed\u5b89\u88c5\u65f6\u9700\u8981\u91cd\u65b0\u8bbe\u7f6e\u8fd9\u4e9b\u73af\u5883\u53d8\u91cf\u3002</p>"},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Rust/Rust%E7%A6%BB%E7%BA%BF%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85.html#3-rust","title":"3. \u5b89\u88c5 Rust","text":"<pre><code>tar -xJf rust-1.80.1-aarch64-unknown-linux-gnu.tar.xz\n./rust-1.80.1-aarch64-unknown-linux-gnu/install.sh --prefix=$RUST_INSTALL_DIR\n</code></pre>"},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Rust/Rust%E7%A6%BB%E7%BA%BF%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85.html#4-rustup","title":"4. \u5b89\u88c5 rustup","text":"<pre><code>chmod +x ./rustup-init\n./rustup-init --default-toolchain none -y\nsource ~/.bashrc\n</code></pre>"},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Rust/Rust%E7%A6%BB%E7%BA%BF%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85.html#5-toolchain","title":"5. \u5b89\u88c5 toolchain","text":"<pre><code>rustup toolchain link rust-1.80.1-aarch64-unknown-linux-gnu $RUST_INSTALL_DIR\nrustup default rust-1.80.1-aarch64-unknown-linux-gnu\nrustc --version\n</code></pre>"},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Rust/Rust%E7%A6%BB%E7%BA%BF%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85.html#6-target","title":"6. \u5b89\u88c5\u4ea4\u53c9\u7f16\u8bd1 target","text":"<pre><code>tar -xJf rust-std-1.80.1-aarch64-unknown-linux-musl.tar.xz\n./rust-std-1.80.1-aarch64-unknown-linux-musl/install.sh --prefix=$RUST_INSTALL_DIR\n</code></pre>"},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Rust/Rust%E7%A6%BB%E7%BA%BF%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85.html#7-rust-src","title":"7. \u5b89\u88c5 rust-src","text":"<pre><code>tar -xJf rust-src-1.80.1.tar.xz\n./rust-src-1.80.1/install.sh --prefix=$RUST_INSTALL_DIR\n</code></pre>"},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Rust/Rust%E7%A6%BB%E7%BA%BF%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85.html#8-configtoml","title":"8. \u914d\u7f6e config.toml","text":"<p>\u65b0\u5efa\u6587\u4ef6 <code>~/.cargo/config.toml</code> :</p> <pre><code>[source.crates-io]\nreplace-with = \"vendored-sources\"\n\n[source.vendored-sources]\ndirectory = \"vendor\"\n</code></pre>"},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Rust/Rust%E7%A6%BB%E7%BA%BF%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85.html#9","title":"9. \u4ea4\u53c9\u7f16\u8bd1","text":"<p>\u67e5\u770b\u53ef\u7528\u7684 target \uff1a</p> <pre><code>rustc --print target-list | grep musl | grep linux | grep aarch64\n</code></pre> <p>\u7f16\u8bd1\uff1a</p> <pre><code>cargo build --target=aarch64-unknown-linux-musl --release\n</code></pre> <p>\u5982\u679c\u9700\u8981\u4f7f\u7528 crate \u5305\uff0c\u5728\u7ebf\u673a\u5668\u4e0a\u8fd0\u884c <code>cargo vendor</code> \uff0c\u4e4b\u540e\u628a <code>vendor</code> \u76ee\u5f55\u590d\u5236\u5230\u7528\u6237\u7684\u5bb6\u76ee\u5f55\u4e0b\u3002</p>"},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Shell/Shell%E8%AE%BE%E7%BD%AE%E5%8F%98%E9%87%8F%E6%9C%AA%E8%B5%8B%E5%80%BC%E6%88%96%E9%81%87%E5%88%B0%E9%94%99%E8%AF%AF%E7%AB%8B%E5%88%BB%E9%80%80%E5%87%BA.html","title":"Shell \u8bbe\u7f6e\u53d8\u91cf\u672a\u8d4b\u503c\u6216\u9047\u5230\u9519\u8bef\u7acb\u523b\u9000\u51fa","text":"","tags":["Shell"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Shell/Shell%E8%AE%BE%E7%BD%AE%E5%8F%98%E9%87%8F%E6%9C%AA%E8%B5%8B%E5%80%BC%E6%88%96%E9%81%87%E5%88%B0%E9%94%99%E8%AF%AF%E7%AB%8B%E5%88%BB%E9%80%80%E5%87%BA.html#1","title":"1. \u95ee\u9898\u80cc\u666f","text":"<p>\u4f17\u6240\u5468\u77e5 Shell \u662f\u4e00\u4e2a\u4e0d\u5b89\u5168\u7684\u8bed\u8a00\uff0c\u53d8\u91cf\u4e0d\u88ab\u5b9a\u4e49\u4e5f\u53ef\u4ee5\u88ab\u8bbf\u95ee\uff0c\u800c\u4e14\u4e00\u884c\u547d\u4ee4\u62a5\u9519\u4ee5\u540e\uff0c\u4e0d\u662f\u50cf\u5176\u5b83\u8bed\u8a00\u4f3c\u7684\u9000\u51fa\uff0c\u800c\u662f\u63a5\u7740\u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u3002\u901a\u8fc7\u4fee\u6539 Shell \u811a\u672c\u7684\u4e00\u4e9b\u8bbe\u7f6e\uff0c\u53ef\u4ee5\u6682\u65f6\u5f25\u8865\u4e0b\u8fd9\u4e2a\u95ee\u9898\u3002</p>","tags":["Shell"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Shell/Shell%E8%AE%BE%E7%BD%AE%E5%8F%98%E9%87%8F%E6%9C%AA%E8%B5%8B%E5%80%BC%E6%88%96%E9%81%87%E5%88%B0%E9%94%99%E8%AF%AF%E7%AB%8B%E5%88%BB%E9%80%80%E5%87%BA.html#2-shell","title":"2. \u6bcf\u4e2a Shell \u811a\u672c\u90fd\u63a8\u8350\u589e\u52a0\u7684\u53c2\u6570","text":"<p>\u63a8\u8350\u5728\u6bcf\u4e2a Shell \u811a\u672c\u524d\u90fd\u52a0\u5165\u4ee5\u4e0b\u8bed\u53e5\uff1a</p> <pre><code>set -o errexit\nset -o nounset\nset -o pipefail\n</code></pre> <p>\u5176\u4e2d <code>set -o errexit</code> \u7b49\u540c\u4e8e <code>set -e</code> ,\u4f5c\u7528\u4e3a\u6709\u4e00\u884c\u547d\u4ee4\u62a5\u9519\u7acb\u523b\u9000\u51fa\u3002 <code>set -o nounset</code> \u7b49\u540c\u4e8e <code>set -u</code> \uff0c\u4f5c\u7528\u4e3a\u5728\u8bbf\u95ee\u672a\u5b9a\u4e49\u53d8\u91cf\u65f6\u62a5\u9519\u3002 <code>set -o pipefail</code> \u4f5c\u7528\u4e3a\u5bf9\u4e8e\u5355\u884c\u547d\u4ee4\uff0c\u8fd4\u56de\u503c\u4e0d\u518d\u662f\u6700\u53f3\u4fa7\u547d\u4ee4\u8fd4\u56de\u503c\uff0c\u800c\u662f\u5728\u8fd4\u56de\u503c\u4e0d\u4e3a\u96f6\u7684\u547d\u4ee4\u4e2d\uff0c\u53d6\u6700\u53f3\u4fa7\u7684\u4f5c\u4e3a\u8fd4\u56de\u503c\u3002</p>","tags":["Shell"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Shell/Shell%E8%AE%BE%E7%BD%AE%E5%8F%98%E9%87%8F%E6%9C%AA%E8%B5%8B%E5%80%BC%E6%88%96%E9%81%87%E5%88%B0%E9%94%99%E8%AF%AF%E7%AB%8B%E5%88%BB%E9%80%80%E5%87%BA.html#3","title":"3. \u53c2\u8003\u8d44\u6599","text":"<p>https://medium.com/factualopinions/consider-starting-all-your-bash-scripts-with-these-options-74fbec0cbb83</p> <p>https://www.gnu.org/software/bash/manual/bash.html#The-Set-Builtin</p>","tags":["Shell"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E7%AC%94%E8%AE%B0%E5%8F%8A%E6%96%87%E6%A1%A3%E8%BD%AF%E4%BB%B6/mkdocs%E5%9C%A8k8s%E4%B8%8A%E7%9A%84%E9%83%A8%E7%BD%B2.html","title":"mkdocs \u5728 k8s \u4e0a\u7684\u90e8\u7f72","text":"","tags":["mkdocs","Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E7%AC%94%E8%AE%B0%E5%8F%8A%E6%96%87%E6%A1%A3%E8%BD%AF%E4%BB%B6/mkdocs%E5%9C%A8k8s%E4%B8%8A%E7%9A%84%E9%83%A8%E7%BD%B2.html#1","title":"1. \u524d\u7f6e\u6761\u4ef6","text":"<ul> <li>\u4e00\u4e2a\u80fd\u8fd0\u4f5c\u7684 k8s \u96c6\u7fa4</li> <li>\u76f8\u5173\u5bb9\u5668\u955c\u50cf\u4e0a\u4f20\u5230\u955c\u50cf\u4ed3\u5e93</li> <li>k8s \u914d\u7f6e\u597d\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u51ed\u8bc1</li> </ul>","tags":["mkdocs","Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E7%AC%94%E8%AE%B0%E5%8F%8A%E6%96%87%E6%A1%A3%E8%BD%AF%E4%BB%B6/mkdocs%E5%9C%A8k8s%E4%B8%8A%E7%9A%84%E9%83%A8%E7%BD%B2.html#2-configmap","title":"2. \u521b\u5efa configmap","text":"<p>\u4f7f\u7528 configmap \u6765\u5b58\u50a8\u672c\u6b21\u90e8\u7f72\u9700\u8981\u7684\u6240\u6709\u914d\u7f6e\u6587\u4ef6\uff1a</p> <pre><code>---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mkdocs\n  namespace: mkdocs\ndata:\n  build.sh: |\n    set -e\n    cd /\n    git config --global credential.helper store\n    echo 'http://4895664:Pass1234%21@22.122.61.128' &gt;&gt; ~/.git-credentials\n    git clone http://22.122.61.128/mkdocs/system-ops.git\n    cd /system-ops &amp;&amp; git checkout mkdocs-system-ops-hxp &amp;&amp; mkdocs build\n    cp -r /system-ops/site/* /mkdocs/\n  nginx.conf: |\n    user nginx;\n    worker_processes 1;\n    error_log /var/log/nginx/error.log notice;\n    pid /var/run/nginx.pid;\n\n    events {\n      worker_connections  1024;\n    }\n\n    http {\n      include /etc/nginx/mime.types;\n      default_type application/octet-stream;\n      log_format main '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n      access_log /var/log/nginx/access.log  main;\n      sendfile on;\n      server {\n        listen 80;\n        server_name _;\n        keepalive_timeout 70;\n        location / {\n          root /mkdocs;\n          autoindex   on;\n        }\n      }\n    }\n</code></pre> <p>configmap \u4e2d\u5305\u542b nginx \u7684\u914d\u7f6e\u548c\u6784\u5efa\u6587\u6863\u4f7f\u7528\u7684 build.sh \u811a\u672c\u3002</p>","tags":["mkdocs","Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E7%AC%94%E8%AE%B0%E5%8F%8A%E6%96%87%E6%A1%A3%E8%BD%AF%E4%BB%B6/mkdocs%E5%9C%A8k8s%E4%B8%8A%E7%9A%84%E9%83%A8%E7%BD%B2.html#3-deployment-pod","title":"3. \u4f7f\u7528 deployment \u90e8\u7f72 pod","text":"<p>\u672c\u6b21\u90e8\u7f72\u662f\u90e8\u7f72\u4e00\u4e2a pod \uff0c\u5176\u5728\u542f\u52a8\u7684\u65f6\u5019\u8fd0\u884c mkdocs \u5bb9\u5668\u6765\u4ece GitLab \u62c9\u4ee3\u7801\u5e76\u7f16\u8bd1\uff0c\u7f16\u8bd1\u6210\u529f\u4ee5\u540e\uff0c\u8fd0\u884c nginx \u5bb9\u5668\u63d0\u4f9b\u670d\u52a1\u3002\u5982\u679c\u7f16\u8bd1\u5931\u8d25\uff0c\u5219 initContainer \u4e0d\u505c\u91cd\u542f\u3002\u90e8\u7f72\u4f7f\u7528\u7684 yaml \u6587\u4ef6\u5982\u4e0b\uff1a</p> <pre><code>---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: mkdocs\n  namespace: mkdocs\n  labels:\n    app: mkdocs\nspec:\n  selector:\n    matchLabels:\n      app: mkdocs\n  replicas: 2\n  template:\n    metadata:\n      labels:\n        app: mkdocs\n    spec:\n      initContainers:\n        - image: 192.168.100.12:8082/mkdocs-git-revision:latest\n          name: mkdocs\n          volumeMounts:\n            - name: build-script\n              mountPath: /build.sh\n              subPath: build.sh\n            - name: mkdocs\n              mountPath: /mkdocs\n          command: [\"/bin/sh\", \"-c\", \"/build.sh\"]\n      containers:\n        - image: 192.168.100.12:8082/nginx:1.20.0\n          name: nginx\n          ports:\n            - containerPort: 443\n              name: web\n          volumeMounts:\n            - name: nginx-conf\n              mountPath: /etc/nginx/nginx.conf\n              subPath: nginx.conf\n            - name: mkdocs\n              mountPath: /mkdocs\n      imagePullSecrets:\n        - name: nexus-regcred\n      volumes:\n        - name: nginx-conf\n          configMap:\n            defaultMode: 0644\n            name: mkdocs\n            items:\n              - key: nginx.conf\n                path: nginx.conf\n        - name: build-script\n          configMap:\n            defaultMode: 0755\n            name: mkdocs\n            items:\n              - key: build.sh\n                path: build.sh\n        - name: mkdocs\n          emptyDir:\n\n\n\n\n            sizeLimit: 500Mi\n</code></pre>","tags":["mkdocs","Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E7%AC%94%E8%AE%B0%E5%8F%8A%E6%96%87%E6%A1%A3%E8%BD%AF%E4%BB%B6/mkdocs%E5%9C%A8k8s%E4%B8%8A%E7%9A%84%E9%83%A8%E7%BD%B2.html#4-service","title":"4. \u4f7f\u7528 service \u66b4\u9732\u670d\u52a1","text":"<p>\u7531\u4e8e\u6b64\u73af\u5883 mkdocs \u4e0d\u9700\u8981\u5bf9\u5916\u66b4\u9732\uff0c\u4f7f\u7528\u4e86 ClusterIP \u7c7b\u578b\u7684 service \uff1a</p> <pre><code>---\napiVersion: v1\nkind: Service\nmetadata:\n  name: mkdocs\n  namespace: mkdocs\n  labels:\n    app: mkdocs\nspec:\n  type: ClusterIP\n  ports:\n    - port: 80\n      targetPort: 80\n      name: web\n  selector:\n    app: mkdocs\n</code></pre>","tags":["mkdocs","Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E7%AC%94%E8%AE%B0%E5%8F%8A%E6%96%87%E6%A1%A3%E8%BD%AF%E4%BB%B6/%E6%80%9D%E6%BA%90%E7%AC%94%E8%AE%B0k8s%E9%83%A8%E7%BD%B2.html","title":"\u601d\u6e90\u7b14\u8bb0 k8s \u90e8\u7f72","text":"","tags":["\u601d\u6e90\u7b14\u8bb0","Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E7%AC%94%E8%AE%B0%E5%8F%8A%E6%96%87%E6%A1%A3%E8%BD%AF%E4%BB%B6/%E6%80%9D%E6%BA%90%E7%AC%94%E8%AE%B0k8s%E9%83%A8%E7%BD%B2.html#1","title":"1. \u524d\u7f6e\u6761\u4ef6","text":"<ul> <li>\u4e00\u4e2a\u80fd\u8fd0\u4f5c\u7684 k8s \u96c6\u7fa4</li> <li>\u76f8\u5173\u5bb9\u5668\u955c\u50cf\u4e0a\u4f20\u5230\u955c\u50cf\u4ed3\u5e93</li> <li>k8s \u914d\u7f6e\u597d\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u51ed\u8bc1</li> <li>k8s \u4e0a\u81f3\u5c11\u6709\u4e00\u4e2a default storage class</li> </ul>","tags":["\u601d\u6e90\u7b14\u8bb0","Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E7%AC%94%E8%AE%B0%E5%8F%8A%E6%96%87%E6%A1%A3%E8%BD%AF%E4%BB%B6/%E6%80%9D%E6%BA%90%E7%AC%94%E8%AE%B0k8s%E9%83%A8%E7%BD%B2.html#2-pvc","title":"2. \u521b\u5efa pvc \u6765\u63d0\u4f9b\u6301\u4e45\u5316\u5b58\u50a8","text":"<p>\u9996\u5148\u521b\u5efa pvc \u6765\u4e3a\u601d\u6e90\u7b14\u8bb0\u63d0\u4f9b\u6301\u4e45\u5316\u5b58\u50a8\uff1a</p> <pre><code>---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: siyuan-pandoc-monitor\n  namespace: siyuan-pandoc\n  labels:\n    app: siyuan-pandoc-monitor\nspec:\n  accessModes:\n    - ReadWriteMany\n  resources:\n    requests:\n      storage: 1Gi\n</code></pre>","tags":["\u601d\u6e90\u7b14\u8bb0","Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E7%AC%94%E8%AE%B0%E5%8F%8A%E6%96%87%E6%A1%A3%E8%BD%AF%E4%BB%B6/%E6%80%9D%E6%BA%90%E7%AC%94%E8%AE%B0k8s%E9%83%A8%E7%BD%B2.html#3-deployment-pod","title":"3. \u521b\u5efa deployment \u6765\u90e8\u7f72 pod","text":"<p>\u7136\u540e\u4f7f\u7528\u6b64 yaml \u90e8\u7f72 deployment\uff1a</p> <pre><code>---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: siyuan-pandoc-monitor\n  name: siyuan-pandoc-monitor\n  namespace: siyuan-pandoc\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: siyuan-pandoc-monitor\n  strategy:\n    type: Recreate\n  template:\n    metadata:\n      labels:\n        app: siyuan-pandoc-monitor\n    spec:\n      containers:\n        - args:\n            - -c\n            - /opt/siyuan/kernel --workspace=/siyuan/workspace\n          command:\n            - /bin/sh\n          env:\n            - name: SIYUAN_ACCESS_AUTH_CODE_BYPASS\n              value: \"true\"\n          image: 192.168.100.12:8082/siyuan-pandoc:v3.0.9\n          imagePullPolicy: IfNotPresent\n          name: siyuan-pandoc-monitor\n          ports:\n            - containerPort: 6806\n              name: web\n              protocol: TCP\n          volumeMounts:\n            - mountPath: /siyuan/workspace\n              name: siyuan-pandoc-monitor\n      imagePullSecrets:\n        - name: nexus-regcred\n      securityContext:\n        fsGroup: 1000\n      tolerations:\n        - effect: NoExecute\n          key: node.kubernetes.io/not-ready\n          operator: Exists\n          tolerationSeconds: 10\n        - effect: NoExecute\n          key: node.kubernetes.io/unreachable\n          operator: Exists\n          tolerationSeconds: 10\n      volumes:\n        - name: siyuan-pandoc-monitor\n          persistentVolumeClaim:\n            claimName: siyuan-pandoc-monitor\n</code></pre> <p>\u7279\u522b\u9700\u8981\u6ce8\u610f\uff0c\u601d\u6e90\u7b14\u8bb0\u53ea\u80fd\u5355 pod \u8fd0\u884c\uff0c\u7b2c\u4e00\u4e2a pod \u542f\u52a8\u540e\uff0c\u4f1a\u7ed9\u7b14\u8bb0\u7684\u76ee\u5f55\u52a0\u9501\uff0c\u7b2c\u4e8c\u4e2a pod \u542f\u52a8\u7684\u65f6\u5019\u770b\u5230\u76ee\u5f55\u88ab\u52a0\u9501\u5c31\u4f1a\u542f\u52a8\u62a5\u9519\uff0c\u56e0\u6b64\u53ea\u80fd\u90e8\u7f72 1 \u4e2a pod \uff0c\u800c\u4e14\u9700\u8981\u5c06 <code>strategy.type</code> \u8bbe\u7f6e\u4e3a <code>Recreate</code> \uff0c\u5426\u5219 rollout restart deployment \u7684\u65f6\u5019\uff0c\u4f1a\u5148\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 pod \uff0c\u65b0 pod \u4f1a\u6c38\u8fdc CrashLoopbackOff \u3002\u4fee\u6539\u4e4b\u540e rollout restart \u65f6\u4f1a\u5148\u628a pod \u6740\u6389\u7136\u540e\u542f\u52a8\u65b0\u7684 pod \u3002\u540c\u65f6\uff0c k8s \u9ed8\u8ba4\u8bbe\u7f6e\u4e0b\uff0c\u5982\u679c\u8282\u70b9\u5b95\u673a\uff0c pod \u4f1a\u5fcd\u8010\u8282\u70b9 5 \u5206\u949f\u624d\u4f1a\u8fc1\u79fb\uff0c\u8fd9\u5728\u5355 pod \u90e8\u7f72\u7684\u60c5\u51b5\u4e0b\u5b95\u673a\u4f1a\u51fa\u73b0 5 \u5206\u949f\u670d\u52a1\u4e0d\u53ef\u7528\uff0c\u9700\u8981\u4fee\u6539 tolerations \u90a3\u91cc\u6765\u5c06\u8fd9\u4e2a 5 \u5206\u949f\u7f29\u77ed\u4e3a 10 \u79d2\u3002</p>","tags":["\u601d\u6e90\u7b14\u8bb0","Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E7%AC%94%E8%AE%B0%E5%8F%8A%E6%96%87%E6%A1%A3%E8%BD%AF%E4%BB%B6/%E6%80%9D%E6%BA%90%E7%AC%94%E8%AE%B0k8s%E9%83%A8%E7%BD%B2.html#4-service","title":"4. \u521b\u5efa service \u6765\u66b4\u9732\u670d\u52a1","text":"<p>\u6700\u540e\u9700\u8981\u5c06\u601d\u6e90\u7b14\u8bb0\u670d\u52a1\u66b4\u9732\uff0c\u521b\u5efa service \uff1a</p> <pre><code>---\napiVersion: v1\nkind: Service\nmetadata:\n  name: siyuan-pandoc-monitor\n  namespace: siyuan-pandoc\n  labels:\n    app: siyuan-pandoc-monitor\nspec:\n  type: NodePort\n  ports:\n    - port: 80\n      targetPort: 6806\n      name: web\n  selector:\n    app: siyuan-pandoc-monitor\n</code></pre> <p>\u5982\u679c\u601d\u6e90\u7b14\u8bb0\u5728\u96c6\u7fa4\u8bbf\u95ee\u5c31\u53ef\u4ee5\uff0c\u53ef\u4ee5\u5c06 <code>spec.type</code> \u4fee\u6539\u4e3a <code>ClusterIP</code> \u3002</p>","tags":["\u601d\u6e90\u7b14\u8bb0","Keycloak","Kubernetes"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E7%AC%94%E8%AE%B0%E5%8F%8A%E6%96%87%E6%A1%A3%E8%BD%AF%E4%BB%B6/%E7%BC%96%E8%AF%91OnlyOffice%E4%BB%A5%E8%A7%A3%E9%99%A420%E8%BF%9E%E6%8E%A5%E6%95%B0%E9%99%90%E5%88%B6.html","title":"\u7f16\u8bd1 OnlyOffice \u4ee5\u89e3\u9664 20 \u8fde\u63a5\u6570\u9650\u5236","text":"","tags":["OnlyOffice","Docker"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E7%AC%94%E8%AE%B0%E5%8F%8A%E6%96%87%E6%A1%A3%E8%BD%AF%E4%BB%B6/%E7%BC%96%E8%AF%91OnlyOffice%E4%BB%A5%E8%A7%A3%E9%99%A420%E8%BF%9E%E6%8E%A5%E6%95%B0%E9%99%90%E5%88%B6.html#1","title":"1. \u6784\u5efa\u5bb9\u5668\u7f16\u8bd1\u73af\u5883","text":"<p>\u7f16\u8bd1\u9700\u8981\u7528\u5230 Ubuntu 20.04 \uff0c\u660e\u667a\u7684\u505a\u6cd5\u662f\u6574\u4e00\u4e2a Ubuntu 20.04 \u7684\u5bb9\u5668\u3002\u5728\u4efb\u610f\u5df2\u7ecf\u5b89\u88c5 docker \u7684\u673a\u5668\u4e0a\uff0c\u65b0\u5efa\u76ee\u5f55 <code>onlyoffice</code> \u4f5c\u4e3a\u672c\u9879\u76ee\u5de5\u4f5c\u76ee\u5f55\uff0c\u521b\u5efa Dockerfile \u5982\u4e0b\uff1a</p> <pre><code>FROM ubuntu:20.04\n\nENV TZ=Etc/UTC\nRUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; echo $TZ &gt; /etc/timezone\n\nRUN apt-get -y update &amp;&amp; \\\n    apt-get -y install python2 \\\n                       python3 \\\n                       sudo \\\n                       git\nRUN ln -s /usr/bin/python2 /usr/bin/python\nWORKDIR /build\n\nCMD /bin/bash -c 'while true;do sleep 3600;done'\n</code></pre> <p>\u6784\u5efa\u5bb9\u5668\uff1a</p> <pre><code>docker build --tag onlyoffice-document-editors-builder .\n</code></pre> <p>\u542f\u52a8\u5bb9\u5668\u524d\u9700\u8981\u7981\u7528 IPv6 \uff1a</p> <pre><code>sudo sysctl -w net.ipv6.conf.all.disable_ipv6=1\n</code></pre> <p>\u542f\u52a8\u5bb9\u5668\uff08\u9700\u8981\u5728\u65b0\u521b\u5efa\u7684 <code>onlyoffice</code> \u76ee\u5f55\u8fd0\u884c\uff09\uff1a</p> <pre><code>docker rm onlyoffice_build\ndocker run -d --name onlyoffice_build -p 8701:80 -v $PWD:/build onlyoffice-document-editors-builder\n</code></pre> <p>\u5bb9\u5668\u540e\u53f0\u542f\u52a8\u5b8c\u6210\u540e\uff0c\u8fdb\u5165\u5bb9\u5668\uff1a</p> <pre><code>docker exec -it onlyoffice_build /bin/bash\n</code></pre> <p>\u4e4b\u540e\u7684\u64cd\u4f5c\u5747\u5728\u5bb9\u5668\u5185\u8fd0\u884c\u3002</p>","tags":["OnlyOffice","Docker"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E7%AC%94%E8%AE%B0%E5%8F%8A%E6%96%87%E6%A1%A3%E8%BD%AF%E4%BB%B6/%E7%BC%96%E8%AF%91OnlyOffice%E4%BB%A5%E8%A7%A3%E9%99%A420%E8%BF%9E%E6%8E%A5%E6%95%B0%E9%99%90%E5%88%B6.html#2-build_tools","title":"2. \u4e0b\u8f7d build_tools \u5e76\u5f00\u59cb\u7f16\u8bd1","text":"<p>\u8fdb\u5165\u5bb9\u5668\uff0c\u4e0b\u8f7d<code>build_tools</code> \u9879\u76ee\uff1a</p> <pre><code>cd /build\ngit clone https://github.com/ONLYOFFICE/build_tools.git\n</code></pre> <p>\u4f7f\u7528 <code>build_tools</code> \u9879\u76ee\u7f16\u8bd1\uff1a</p> <pre><code>cd /build/build_tools/tools/linux &amp;&amp; ./automate.py server\n</code></pre> <p>\u4e4b\u540e\u7b49\u5f85\u5176\u7f16\u8bd1\u5b8c\u6210\uff0c\u9700\u8981\u7b49\u5f85\u51e0\u4e2a\u5c0f\u65f6\u3002</p>","tags":["OnlyOffice","Docker"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E7%AC%94%E8%AE%B0%E5%8F%8A%E6%96%87%E6%A1%A3%E8%BD%AF%E4%BB%B6/%E7%BC%96%E8%AF%91OnlyOffice%E4%BB%A5%E8%A7%A3%E9%99%A420%E8%BF%9E%E6%8E%A5%E6%95%B0%E9%99%90%E5%88%B6.html#3-onlyoffice","title":"3. \u4fee\u6539 OnlyOffice \u6700\u5927\u8fde\u63a5\u6570","text":"<p>\u4fee\u6539 <code>/build/server/Common/sources/constants.js</code> \uff1a</p> <pre><code>exports.LICENSE_CONNECTIONS = 99999;\n</code></pre> <p>\u4fee\u6539 <code>/build/build_tools/tools/linux/automate.py</code> \u4e2d\u6b64\u5904 <code>--update</code> \u4e3a <code>0</code> \uff0c\u4f7f\u5f97\u4e0b\u6b21\u7f16\u8bd1\u4e0d\u518d\u66f4\u65b0\u6587\u4ef6\uff1a</p> <pre><code>build_tools_params = [\"--branch\", branch,\n                      \"--module\", modules,\n                      \"--update\", \"0\",\n                      \"--qt-dir\", os.getcwd() + \"/qt_build/Qt-5.9.9\"] + params\n</code></pre> <p>\u4e4b\u540e\u91cd\u65b0 \u7f16\u8bd1\u6e90\u4ee3\u7801\uff1a</p> <pre><code>cd /build/build_tools/tools/linux &amp;&amp; ./automate.py server\n</code></pre> <p>\u4e8c\u6b21\u7f16\u8bd1\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u9a8c\u8bc1\uff1a</p> <pre><code>grep CONNECTIONS /build/build_tools/out/linux_64/onlyoffice/documentserver-snap/var\n/www/onlyoffice/documentserver/server/Common/sources/constants.js\n</code></pre> <p>\u8fd9\u91cc\u7684 <code>exports.LICENSE_CONNECTIONS</code> \u7531 20 \u53d8\u4e3a 99999 \u5219\u4e3a\u4fee\u6539\u751f\u6548\uff1a</p> <pre><code>exports.LICENSE_CONNECTIONS = 99999;\n</code></pre>","tags":["OnlyOffice","Docker"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E7%AC%94%E8%AE%B0%E5%8F%8A%E6%96%87%E6%A1%A3%E8%BD%AF%E4%BB%B6/%E7%BC%96%E8%AF%91OnlyOffice%E4%BB%A5%E8%A7%A3%E9%99%A420%E8%BF%9E%E6%8E%A5%E6%95%B0%E9%99%90%E5%88%B6.html#4-documentserver","title":"4. \u8bd5\u8fd0\u884c documentserver","text":"","tags":["OnlyOffice","Docker"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E7%AC%94%E8%AE%B0%E5%8F%8A%E6%96%87%E6%A1%A3%E8%BD%AF%E4%BB%B6/%E7%BC%96%E8%AF%91OnlyOffice%E4%BB%A5%E8%A7%A3%E9%99%A420%E8%BF%9E%E6%8E%A5%E6%95%B0%E9%99%90%E5%88%B6.html#41-nginx","title":"4.1 \u914d\u7f6e\u5e76\u542f\u52a8 nginx","text":"<p>\u5b89\u88c5\u5e76\u6e05\u9664 nginx \u9ed8\u8ba4\u914d\u7f6e\uff1a</p> <pre><code>sudo apt-get install nginx\nsudo rm -f /etc/nginx/sites-enabled/default\n</code></pre> <p>\u65b0\u5efa\u6587\u4ef6 <code>/etc/nginx/sites-available/onlyoffice-documentserver</code> \u5982\u4e0b\uff1a</p> <pre><code>map $http_host $this_host {\n  \"\" $host;\n  default $http_host;\n}\nmap $http_x_forwarded_proto $the_scheme {\n  default $http_x_forwarded_proto;\n  \"\" $scheme;\n}\nmap $http_x_forwarded_host $the_host {\n  default $http_x_forwarded_host;\n  \"\" $this_host;\n}\nmap $http_upgrade $proxy_connection {\n  default upgrade;\n  \"\" close;\n}\nproxy_set_header Host $http_host;\nproxy_set_header Upgrade $http_upgrade;\nproxy_set_header Connection $proxy_connection;\nproxy_set_header X-Forwarded-Host $the_host;\nproxy_set_header X-Forwarded-Proto $the_scheme;\nserver {\n  listen 0.0.0.0:80;\n  listen [::]:80 default_server;\n  server_tokens off;\n  rewrite ^\\/OfficeWeb(\\/apps\\/.*)$ /web-apps$1 redirect;\n  location / {\n    proxy_pass http://localhost:8000;\n    proxy_http_version 1.1;\n  }\n}\n</code></pre> <p>\u4f7f\u914d\u7f6e\u6587\u4ef6\u751f\u6548\uff1a</p> <pre><code>sudo ln -s /etc/nginx/sites-available/onlyoffice-documentserver /etc/nginx/sites-enabled/onlyoffice-documentserver\n</code></pre> <p>\u91cd\u542f nginx\uff1a</p> <pre><code>service nginx restart\n</code></pre>","tags":["OnlyOffice","Docker"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E7%AC%94%E8%AE%B0%E5%8F%8A%E6%96%87%E6%A1%A3%E8%BD%AF%E4%BB%B6/%E7%BC%96%E8%AF%91OnlyOffice%E4%BB%A5%E8%A7%A3%E9%99%A420%E8%BF%9E%E6%8E%A5%E6%95%B0%E9%99%90%E5%88%B6.html#42-postgresql","title":"4.2 \u914d\u7f6e\u5e76\u542f\u52a8 postgresql","text":"<p>\u5b89\u88c5 postgresql \u5e76\u542f\u52a8\uff1a</p> <pre><code>sudo apt-get install postgresql\nservice postgresql restart\n</code></pre> <p>\u521b\u5efa\u6570\u636e\u5e93\u548c\u7528\u6237\uff1a</p> <pre><code>sudo -i -u postgres psql -c \"CREATE DATABASE onlyoffice;\"\nsudo -i -u postgres psql -c \"CREATE USER onlyoffice WITH password 'onlyoffice';\"\nsudo -i -u postgres psql -c \"GRANT ALL privileges ON DATABASE onlyoffice TO onlyoffice;\"\n</code></pre> <p>\u6570\u636e\u94fa\u5e95\uff1a</p> <pre><code>psql -hlocalhost -Uonlyoffice -d onlyoffice -f /build/build_tools/out/linux_64/onlyoffice/documentserver/server/schema/postgresql/createdb.sql # \u5bc6\u7801\u4e3a onlyoffice\n</code></pre>","tags":["OnlyOffice","Docker"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E7%AC%94%E8%AE%B0%E5%8F%8A%E6%96%87%E6%A1%A3%E8%BD%AF%E4%BB%B6/%E7%BC%96%E8%AF%91OnlyOffice%E4%BB%A5%E8%A7%A3%E9%99%A420%E8%BF%9E%E6%8E%A5%E6%95%B0%E9%99%90%E5%88%B6.html#43-rabbitmq","title":"4.3 \u5b89\u88c5\u5e76\u542f\u52a8 RabbitMQ","text":"<pre><code>sudo apt-get install rabbitmq-server\nservice rabbitmq-server restart\n</code></pre>","tags":["OnlyOffice","Docker"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E7%AC%94%E8%AE%B0%E5%8F%8A%E6%96%87%E6%A1%A3%E8%BD%AF%E4%BB%B6/%E7%BC%96%E8%AF%91OnlyOffice%E4%BB%A5%E8%A7%A3%E9%99%A420%E8%BF%9E%E6%8E%A5%E6%95%B0%E9%99%90%E5%88%B6.html#44","title":"4.4 \u751f\u6210\u5b57\u4f53\u548c\u5e7b\u706f\u7247\u4e3b\u9898","text":"<pre><code>cd /build/build_tools/out/linux_64/onlyoffice/documentserver\nmkdir fonts\nLD_LIBRARY_PATH=${PWD}/server/FileConverter/bin server/tools/allfontsgen \\\n  --input=\"${PWD}/core-fonts\" \\\n  --allfonts-web=\"${PWD}/sdkjs/common/AllFonts.js\" \\\n  --allfonts=\"${PWD}/server/FileConverter/bin/AllFonts.js\" \\\n  --images=\"${PWD}/sdkjs/common/Images\" \\\n  --selection=\"${PWD}/server/FileConverter/bin/font_selection.bin\" \\\n  --output-web='fonts' \\\n  --use-system=\"true\"\nLD_LIBRARY_PATH=${PWD}/server/FileConverter/bin server/tools/allthemesgen \\\n  --converter-dir=\"${PWD}/server/FileConverter/bin\"\\\n  --src=\"${PWD}/sdkjs/slide/themes\"\\\n  --output=\"${PWD}/sdkjs/common/Images\"\n</code></pre>","tags":["OnlyOffice","Docker"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E7%AC%94%E8%AE%B0%E5%8F%8A%E6%96%87%E6%A1%A3%E8%BD%AF%E4%BB%B6/%E7%BC%96%E8%AF%91OnlyOffice%E4%BB%A5%E8%A7%A3%E9%99%A420%E8%BF%9E%E6%8E%A5%E6%95%B0%E9%99%90%E5%88%B6.html#45-documentserver","title":"4.5 \u8fd0\u884c documentserver","text":"<p>\u542f\u52a8 FileConverter \uff1a</p> <pre><code>cd /build/build_tools/out/linux_64/onlyoffice/documentserver/server/FileConverter/\nnohup bash -c 'LD_LIBRARY_PATH=$PWD/bin NODE_ENV=development-linux NODE_CONFIG_DIR=$PWD/../Common/config ./converter' &amp;\n</code></pre> <p>\u542f\u52a8 DocService \uff1a</p> <pre><code>cd /build/build_tools/out/linux_64/onlyoffice/documentserver/server/DocService\nnohup bash -c 'NODE_ENV=development-linux NODE_CONFIG_DIR=$PWD/../Common/config ./docservice' &amp;\n</code></pre>","tags":["OnlyOffice","Docker"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E7%AC%94%E8%AE%B0%E5%8F%8A%E6%96%87%E6%A1%A3%E8%BD%AF%E4%BB%B6/%E7%BC%96%E8%AF%91OnlyOffice%E4%BB%A5%E8%A7%A3%E9%99%A420%E8%BF%9E%E6%8E%A5%E6%95%B0%E9%99%90%E5%88%B6.html#46","title":"4.6 \u6700\u7ec8\u6d4b\u8bd5","text":"<p>\u4f7f\u7528\u5b98\u65b9\u7684 Java Spring Demo \u8fdb\u884c\u6d4b\u8bd5\uff0c\u8be5\u9879\u76ee GitHub \u5730\u5740\u4e3a\uff1ahttps://github.com/ONLYOFFICE/document-server-integration/tree/master/web/documentserver-example/java-spring \uff0c\u4e5f\u53ef\u4ee5\u5728 https://api.onlyoffice.com/zh/editors/demopreview \u9875\u9762\u201c\u9009\u62e9\u7f16\u7a0b\u8bed\u8a00\u5e76\u5c06\u5728\u7ebf\u7f16\u8f91\u5668\u96c6\u6210\u793a\u4f8b\u7684\u4ee3\u7801\u4e0b\u8f7d\u5230\u60a8\u7684\u7f51\u7ad9\u201d\u5904\u4e0b\u8f7d\u3002Spring \u9879\u76ee\u9700\u8981\u4fee\u6539 <code>src/main/resources/application.properties</code> \u7684\u5982\u4e0b 2 \u884c\uff1a</p> <pre><code>server.port=4000\nfiles.docservice.url.site=http://ubuntu.hxp.lan:8701/\n</code></pre> <p>\u4e4b\u540e\u542f\u52a8 Spring \u540e\u7aef\uff0c\u8bbf\u95ee http://nuc.hxp.lan:4000/ \u6d4b\u8bd5 Spring \u540e\u7aef\u662f\u5426\u80fd\u6b63\u5e38\u8fd0\u4f5c\u3002\uff08\u5176\u4e2d ubuntu.hxp.lan \u4e3a Document Server \u7684\u57df\u540d\uff0c\u800c nuc.hxp.lan \u4e3a\u540e\u7aef Spring \u670d\u52a1\u5668\u57df\u540d\uff0c\u8fd9\u4e24\u4e2a\u57df\u540d\u53ef\u4ee5\u4f7f\u7528 IP \u5730\u5740\u4ee3\u66ff\uff09</p>","tags":["OnlyOffice","Docker"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E7%AC%94%E8%AE%B0%E5%8F%8A%E6%96%87%E6%A1%A3%E8%BD%AF%E4%BB%B6/%E7%BC%96%E8%AF%91OnlyOffice%E4%BB%A5%E8%A7%A3%E9%99%A420%E8%BF%9E%E6%8E%A5%E6%95%B0%E9%99%90%E5%88%B6.html#5","title":"5. \u6253\u5305\u5bb9\u5668\u955c\u50cf","text":"<p>\u5c06\u4ee5\u4e0a\u6240\u6709\u64cd\u4f5c\u505a\u6210\u5bb9\u5668\u955c\u50cf\uff0c\u65b0\u5efa Dockerfile \uff1a</p> <pre><code>FROM ubuntu:20.04\n\nENV TZ=Etc/UTC\nRUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; echo $TZ &gt; /etc/timezone\n\nRUN apt-get -y update &amp;&amp; \\\n    apt-get -y install python2 \\\n                       python3 \\\n                       sudo \\\n                       git \\\n                       postgresql \\\n                       rabbitmq-server \\\n                       nginx\nRUN ln -s /usr/bin/python2 /usr/bin/python\nWORKDIR /build\n\nRUN git clone https://github.com/ONLYOFFICE/build_tools.git\nRUN cd /build/build_tools/tools/linux &amp;&amp; ./automate.py server\nRUN sed -i 's/exports.LICENSE_CONNECTIONS = 20;/exports.LICENSE_CONNECTIONS = 99999;/' /build/server/Common/sources/constants.js\nRUN sed -i 's/\"--update\", \"1\"/\"--update\", \"0\"/' /build/build_tools/tools/linux/automate.py\nRUN cd /build/build_tools/tools/linux &amp;&amp; ./automate.py server\n\nFROM ubuntu:20.04\nENV TZ=Asia/Shanghai\nRUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; echo $TZ &gt; /etc/timezone\nCOPY --from=0 /build/build_tools/out/linux_64/onlyoffice/documentserver /var/www/html/documentserver\nRUN apt-get -y update &amp;&amp; apt-get -y install nginx postgresql rabbitmq-server sudo ttf-wqy-zenhei fonts-wqy-microhei\nCOPY onlyoffice-documentserver /etc/nginx/sites-available/onlyoffice-documentserver\nRUN sudo rm -f /etc/nginx/sites-enabled/default\nRUN ln -s /etc/nginx/sites-available/onlyoffice-documentserver /etc/nginx/sites-enabled/onlyoffice-documentserver\nRUN service postgresql restart &amp;&amp; \\\n    sudo -i -u postgres psql -c \"CREATE DATABASE onlyoffice;\" &amp;&amp; \\\n    sudo -i -u postgres psql -c \"CREATE USER onlyoffice WITH password 'onlyoffice';\" &amp;&amp; \\\n    sudo -i -u postgres psql -c \"GRANT ALL privileges ON DATABASE onlyoffice TO onlyoffice;\" &amp;&amp; \\\n    PGPASSWORD=onlyoffice psql -hlocalhost -Uonlyoffice -d onlyoffice -f /var/www/html/documentserver/server/schema/postgresql/createdb.sql\nRUN cd /var/www/html/documentserver &amp;&amp; \\\n    mkdir fonts &amp;&amp; \\\n    LD_LIBRARY_PATH=${PWD}/server/FileConverter/bin server/tools/allfontsgen \\\n      --input=\"${PWD}/core-fonts\" \\\n      --allfonts-web=\"${PWD}/sdkjs/common/AllFonts.js\" \\\n      --allfonts=\"${PWD}/server/FileConverter/bin/AllFonts.js\" \\\n      --images=\"${PWD}/sdkjs/common/Images\" \\\n      --selection=\"${PWD}/server/FileConverter/bin/font_selection.bin\" \\\n      --output-web='fonts' \\\n      --use-system=\"true\" &amp;&amp; \\\n    LD_LIBRARY_PATH=${PWD}/server/FileConverter/bin server/tools/allthemesgen \\\n      --converter-dir=\"${PWD}/server/FileConverter/bin\"\\\n      --src=\"${PWD}/sdkjs/slide/themes\"\\\n      --output=\"${PWD}/sdkjs/common/Images\"\nCOPY start.sh /start.sh\nCMD /bin/bash /start.sh\n</code></pre> <p>\u5176\u4e2d <code>start.sh</code> \u5982\u4e0b\uff1a</p> <pre><code>#!/bin/bash\n\nservice nginx restart\nservice postgresql restart\nservice rabbitmq-server restart\n\ntouch /logs.txt\n\ncd /var/www/html/documentserver/server/FileConverter/\nnohup bash -c 'LD_LIBRARY_PATH=$PWD/bin NODE_ENV=development-linux NODE_CONFIG_DIR=$PWD/../Common/config ./converter' 2&amp;&gt;1 &gt;&gt;/logs.txt &amp;\ncd /var/www/html/documentserver/server/DocService/\nnohup bash -c 'NODE_ENV=development-linux NODE_CONFIG_DIR=$PWD/../Common/config ./docservice' 2&amp;&gt;1 &gt;&gt;/logs.txt &amp;\n\ntail -f /logs.txt\n</code></pre> <p>nginx \u914d\u7f6e <code>onlyoffice-documentserver</code> \u5982\u4e0b\uff1a</p> <pre><code>map $http_host $this_host {\n  \"\" $host;\n  default $http_host;\n}\nmap $http_x_forwarded_proto $the_scheme {\n  default $http_x_forwarded_proto;\n  \"\" $scheme;\n}\nmap $http_x_forwarded_host $the_host {\n  default $http_x_forwarded_host;\n  \"\" $this_host;\n}\nmap $http_upgrade $proxy_connection {\n  default upgrade;\n  \"\" close;\n}\nproxy_set_header Host $http_host;\nproxy_set_header Upgrade $http_upgrade;\nproxy_set_header Connection $proxy_connection;\nproxy_set_header X-Forwarded-Host $the_host;\nproxy_set_header X-Forwarded-Proto $the_scheme;\nserver {\n  listen 0.0.0.0:80;\n  listen [::]:80 default_server;\n  server_tokens off;\n  rewrite ^\\/OfficeWeb(\\/apps\\/.*)$ /web-apps$1 redirect;\n  location / {\n    proxy_pass http://localhost:8000;\n    proxy_http_version 1.1;\n  }\n}\n</code></pre> <p>\u6784\u5efa\u5bb9\u5668\u955c\u50cf\uff1a</p> <pre><code>docker build --tag hxp.plus/onlyoffice/document-server:v20240526 .\n</code></pre> <p>\u542f\u52a8\u5bb9\u5668\uff1a</p> <pre><code>docker run -p 8701:80 --rm -it --name document-server hxp.plus/onlyoffice/document-server:v20240526\n</code></pre>","tags":["OnlyOffice","Docker"]},{"location":"%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/%E7%AC%94%E8%AE%B0%E5%8F%8A%E6%96%87%E6%A1%A3%E8%BD%AF%E4%BB%B6/%E7%BC%96%E8%AF%91OnlyOffice%E4%BB%A5%E8%A7%A3%E9%99%A420%E8%BF%9E%E6%8E%A5%E6%95%B0%E9%99%90%E5%88%B6.html#6","title":"6. \u53c2\u8003\u8d44\u6599","text":"<p>https://helpcenter.onlyoffice.com/installation/docs-community-compile.aspx</p> <p>https://blog.cyida.com/2022/2YTMY16.html</p> <p>https://github.com/ONLYOFFICE/build_tools</p> <p>https://www.btactic.com/build-onlyoffice-from-source-code-2023/?lang=en</p> <p>https://zsy314.wordpress.com/tag/linux/</p>","tags":["OnlyOffice","Docker"]}]}