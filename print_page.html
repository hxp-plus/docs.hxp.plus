
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="胡喜平">
      
      
        <link rel="canonical" href="https://docs.hxp.plus/print_page.html">
      
      
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.23">
    
    
      
        <title>Print Site - hxp的文档库</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
        <script src="https://unpkg.com/iframe-worker/shim"></script>
      
    
    
      
    
    
      <link rel="stylesheet" href="css/print-site.css">
    
      <link rel="stylesheet" href="css/print-site-material.css">
    
      <link rel="stylesheet" href="stylesheets/extra.css">
    
    <script>__md_scope=new URL("/",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  
        <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            remove_material_navigation();remove_mkdocs_theme_navigation();generate_toc();
        })
        </script>
        </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#index" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="index.html" title="hxp的文档库" class="md-header__button md-logo" aria-label="hxp的文档库" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            hxp的文档库
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Print Site
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/hxp-plus/docs.hxp.plus.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    docs.hxp.plus
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="index.html" class="md-tabs__link">
        
  
  
    
  
  首页

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Kubernetes.html" class="md-tabs__link">
          
  
  
  容器技术

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/Vue3/Geeker-Admin%E6%8E%A5%E5%85%A5Keycloak%E8%AE%A4%E8%AF%81.html" class="md-tabs__link">
          
  
  
  前端开发

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/Ceph/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Ceph.html" class="md-tabs__link">
          
  
  
  存储技术

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX%E5%92%8Cstolon%E9%AB%98%E5%8F%AF%E7%94%A8%E8%B0%83%E4%BC%98.html" class="md-tabs__link">
          
  
  
  运维开发

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="%E6%8A%98%E8%85%BELinux/%E9%80%9A%E7%94%A8Linux/Linux%E4%B8%8B%E8%BD%BDyum%E6%BA%90.html" class="md-tabs__link">
          
  
  
  折腾Linux

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/Hyper-V/Hyper-V%E4%BF%AE%E6%94%B9%E8%B0%83%E5%BA%A6%E5%99%A8.html" class="md-tabs__link">
          
  
  
  虚拟化技术

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="tags.html" class="md-tabs__link">
        
  
  
    
  
  文档分类

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="index.html" title="hxp的文档库" class="md-nav__button md-logo" aria-label="hxp的文档库" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    hxp的文档库
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/hxp-plus/docs.hxp.plus.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    docs.hxp.plus
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    首页
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Kubernetes/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Kubernetes.html" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    容器技术
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/Vue3/Geeker-Admin%E6%8E%A5%E5%85%A5Keycloak%E8%AE%A4%E8%AF%81.html" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    前端开发
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/Ceph/%E9%93%B6%E6%B2%B3%E9%BA%92%E9%BA%9FV10%E5%AE%89%E8%A3%85Ceph.html" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    存储技术
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/AWX%E5%92%8Cstolon%E9%AB%98%E5%8F%AF%E7%94%A8%E8%B0%83%E4%BC%98.html" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    运维开发
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="%E6%8A%98%E8%85%BELinux/%E9%80%9A%E7%94%A8Linux/Linux%E4%B8%8B%E8%BD%BDyum%E6%BA%90.html" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    折腾Linux
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/Hyper-V/Hyper-V%E4%BF%AE%E6%94%B9%E8%B0%83%E5%BA%A6%E5%99%A8.html" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    虚拟化技术
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="tags.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    文档分类
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#index" class="md-nav__link">
    <span class="md-ellipsis">
      1 首页
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-2" class="md-nav__link">
    <span class="md-ellipsis">
      2 容器技术
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2 容器技术">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#section-2-1" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 Kubernetes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.1 Kubernetes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes" class="md-nav__link">
    <span class="md-ellipsis">
      2.1.1 银河麒麟V10安装Kubernetes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8" class="md-nav__link">
    <span class="md-ellipsis">
      2.1.2 对接CephFS存储
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller" class="md-nav__link">
    <span class="md-ellipsis">
      2.1.3 安装traefik ingress controller
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85helm%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8" class="md-nav__link">
    <span class="md-ellipsis">
      2.1.4 安装helm包管理器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server" class="md-nav__link">
    <span class="md-ellipsis">
      2.1.5 安装metrics-server
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81" class="md-nav__link">
    <span class="md-ellipsis">
      2.1.6 配置私有镜像仓库凭证
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5" class="md-nav__link">
    <span class="md-ellipsis">
      2.1.7 禁用容器镜像垃圾回收并配置磁盘相关容器漂移策略
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85" class="md-nav__link">
    <span class="md-ellipsis">
      2.1.8 local-path-provisioner安装
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9" class="md-nav__link">
    <span class="md-ellipsis">
      2.1.9 扩容master节点
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k3s%e5%88%a0%e9%99%a4namespace%e5%8d%a1%e6%ad%bb%e5%9c%a8terminating%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95" class="md-nav__link">
    <span class="md-ellipsis">
      2.1.10 k3s删除namespace卡死在Terminating解决方法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k8s%e5%bc%80%e5%90%afswap%e6%94%af%e6%8c%81" class="md-nav__link">
    <span class="md-ellipsis">
      2.1.11 k8s 开启 swap 支持
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-2-2" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 Docker&Podman
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.2 Docker&amp;Podman">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.1 Dockerfile中不保留编译缓存
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.2 基于eBPF的容器审计技术的实现
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-3" class="md-nav__link">
    <span class="md-ellipsis">
      3 前端开发
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3 前端开发">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#section-3-1" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 Vue3
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.1 Vue3">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.1 Geeker-Admin接入Keycloak认证
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-4" class="md-nav__link">
    <span class="md-ellipsis">
      4 存储技术
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4 存储技术">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#section-4-1" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 Ceph
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.1 Ceph">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph" class="md-nav__link">
    <span class="md-ellipsis">
      4.1.1 银河麒麟V10安装Ceph
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-4-2" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 ZFS
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.2 ZFS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7" class="md-nav__link">
    <span class="md-ellipsis">
      4.2.1 TrueNAS删除所有空快照
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-4-3" class="md-nav__link">
    <span class="md-ellipsis">
      4.3 TrueNAS
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.3 TrueNAS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025" class="md-nav__link">
    <span class="md-ellipsis">
      4.3.1 TrueNAS iSCSI 安装 Windows Server 2025
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-5" class="md-nav__link">
    <span class="md-ellipsis">
      5 运维开发
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5 运维开发">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#section-5-1" class="md-nav__link">
    <span class="md-ellipsis">
      5.1 AWX
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5.1 AWX">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98" class="md-nav__link">
    <span class="md-ellipsis">
      5.1.1 AWX和stolon高可用调优
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql" class="md-nav__link">
    <span class="md-ellipsis">
      5.1.2 使用stolon安装高可用PostgreSQL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7" class="md-nav__link">
    <span class="md-ellipsis">
      5.1.3 安装AWX-23.7
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81" class="md-nav__link">
    <span class="md-ellipsis">
      5.1.4 AWX-23.9使用SAML对接Keycloak-24认证
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%a2%9e%e5%8a%a0%e5%b9%b6%e4%bd%bf%e7%94%a8token" class="md-nav__link">
    <span class="md-ellipsis">
      5.1.5 AWX增加并使用token
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e8%ae%be%e7%bd%aesaml%e8%ae%a4%e8%af%81%e7%94%a8%e6%88%b7%e4%b8%ba%e7%ae%a1%e7%90%86%e5%91%98" class="md-nav__link">
    <span class="md-ellipsis">
      5.1.6 AWX设置SAML认证用户为管理员
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84" class="md-nav__link">
    <span class="md-ellipsis">
      5.1.7 AWX新增容器组
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83" class="md-nav__link">
    <span class="md-ellipsis">
      5.1.8 在k3s上搭建awx测试环境
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-5-2" class="md-nav__link">
    <span class="md-ellipsis">
      5.2 Keycloak
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5.2 Keycloak">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1" class="md-nav__link">
    <span class="md-ellipsis">
      5.2.1 使用openresty容器为k8s的服务提供Keycloak认证服务
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae" class="md-nav__link">
    <span class="md-ellipsis">
      5.2.2 k8s集群Keycloak部署及负载配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83" class="md-nav__link">
    <span class="md-ellipsis">
      5.2.3 使用docker-compose搭建keycloak开发环境
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak" class="md-nav__link">
    <span class="md-ellipsis">
      5.2.4 k3s搭建单点Keycloak
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-5-3" class="md-nav__link">
    <span class="md-ellipsis">
      5.3 笔记及文档软件
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5.3 笔记及文档软件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2" class="md-nav__link">
    <span class="md-ellipsis">
      5.3.1 思源笔记k8s部署
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2" class="md-nav__link">
    <span class="md-ellipsis">
      5.3.2 mkdocs在k8s上的部署
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6" class="md-nav__link">
    <span class="md-ellipsis">
      5.3.3 编译OnlyOffice以解除20连接数限制
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-5-4" class="md-nav__link">
    <span class="md-ellipsis">
      5.4 Git使用
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5.4 Git使用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3" class="md-nav__link">
    <span class="md-ellipsis">
      5.4.1 Git中文乱码问题解决
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e6%9c%80%e7%ae%80git%e6%9c%8d%e5%8a%a1%e5%99%a8%e6%90%ad%e5%bb%ba" class="md-nav__link">
    <span class="md-ellipsis">
      5.4.2 最简Git服务器搭建.md
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-github%e9%bb%98%e8%ae%a4%e5%a4%b4%e5%83%8f%e8%8e%b7%e5%8f%96" class="md-nav__link">
    <span class="md-ellipsis">
      5.4.3 GitHub默认头像获取
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e9%85%8d%e7%bd%ae%e8%ae%b0%e4%bd%8f%e5%af%86%e7%a0%81" class="md-nav__link">
    <span class="md-ellipsis">
      5.4.4 Git配置记住密码
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93" class="md-nav__link">
    <span class="md-ellipsis">
      5.4.5 使用nginx快速搭建只读Git仓库
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-gitlab%e7%ac%ac%e4%ba%8c%e9%82%ae%e7%ae%b1%e4%bf%ae%e6%94%b9%e4%b8%ba%e5%b7%b2%e8%ae%a4%e8%af%81" class="md-nav__link">
    <span class="md-ellipsis">
      5.4.6 GitLab第二邮箱修改为已认证
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-5-5" class="md-nav__link">
    <span class="md-ellipsis">
      5.5 Python
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5.5 Python">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3" class="md-nav__link">
    <span class="md-ellipsis">
      5.5.1 构建解压即用的Python3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91" class="md-nav__link">
    <span class="md-ellipsis">
      5.5.2 基于Python的模块化监控工具的开发
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96" class="md-nav__link">
    <span class="md-ellipsis">
      5.5.3 Python升级所有依赖
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8" class="md-nav__link">
    <span class="md-ellipsis">
      5.5.4 Python限制内存和CPU使用
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-5-6" class="md-nav__link">
    <span class="md-ellipsis">
      5.6 Java
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5.6 Java">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81" class="md-nav__link">
    <span class="md-ellipsis">
      5.6.1 SpringBoot 2.5.1 对接Keycloak认证
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91" class="md-nav__link">
    <span class="md-ellipsis">
      5.6.2 使用OnlyOffice官方Spring示例遇到的坑
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-5-7" class="md-nav__link">
    <span class="md-ellipsis">
      5.7 Shell
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5.7 Shell">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-shell-shell%e8%ae%be%e7%bd%ae%e5%8f%98%e9%87%8f%e6%9c%aa%e8%b5%8b%e5%80%bc%e6%88%96%e9%81%87%e5%88%b0%e9%94%99%e8%af%af%e7%ab%8b%e5%88%bb%e9%80%80%e5%87%ba" class="md-nav__link">
    <span class="md-ellipsis">
      5.7.1 Shell设置变量未赋值或遇到错误立刻退出
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-5-8" class="md-nav__link">
    <span class="md-ellipsis">
      5.8 Rust
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5.8 Rust">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85" class="md-nav__link">
    <span class="md-ellipsis">
      5.8.1 Rust离线开发环境安装
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e4%ba%a4%e5%8f%89%e7%bc%96%e8%af%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85" class="md-nav__link">
    <span class="md-ellipsis">
      5.8.2 Rust交叉编译环境安装
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-6" class="md-nav__link">
    <span class="md-ellipsis">
      6 折腾Linux
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6 折腾Linux">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#section-6-1" class="md-nav__link">
    <span class="md-ellipsis">
      6.1 通用Linux
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.1 通用Linux">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90" class="md-nav__link">
    <span class="md-ellipsis">
      6.1.1 Linux下载yum源
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e6%8c%82%e8%bd%bdcifs" class="md-nav__link">
    <span class="md-ellipsis">
      6.1.2 Linux挂载CIFS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20lvm%e8%b8%a2pv" class="md-nav__link">
    <span class="md-ellipsis">
      6.1.3 Linux LVM踢PV
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e5%b0%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e7%a3%81%e7%9b%98%e5%88%86%e5%8c%ba%e6%89%a9%e5%ae%b9%e5%88%b0%e6%9c%80%e5%a4%a7" class="md-nav__link">
    <span class="md-ellipsis">
      6.1.4 Linux将最后一个磁盘分区扩容到最大
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e9%85%8d%e7%bd%aeudev%e8%a7%84%e5%88%99%e5%bf%bd%e7%95%a5%e7%a3%81%e7%9b%98" class="md-nav__link">
    <span class="md-ellipsis">
      6.1.5 Linux配置udev规则忽略磁盘
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-%e4%bd%bf%e7%94%a8tlog%e5%af%b9%e7%99%bb%e5%bd%95%e5%88%b0linux%e4%b8%8a%e7%9a%84%e7%94%a8%e6%88%b7%e8%bf%9b%e8%a1%8c%e5%bd%95%e5%b1%8f" class="md-nav__link">
    <span class="md-ellipsis">
      6.1.6 使用tlog对登录到Linux上的用户进行录屏
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85" class="md-nav__link">
    <span class="md-ellipsis">
      6.1.7 Kickstart 软raid安装.md
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20%e5%bc%80%e5%90%af%20otp%20%e4%ba%8c%e6%ac%a1%e8%ae%a4%e8%af%81" class="md-nav__link">
    <span class="md-ellipsis">
      6.1.8 Linux 开启 OTP 二次认证
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-6-2" class="md-nav__link">
    <span class="md-ellipsis">
      6.2 Gentoo
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.2 Gentoo">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo" class="md-nav__link">
    <span class="md-ellipsis">
      6.2.1 在QEMU环境安装Gentoo
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo" class="md-nav__link">
    <span class="md-ellipsis">
      6.2.2 在Hyper-V环境安装Gentoo
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95" class="md-nav__link">
    <span class="md-ellipsis">
      6.2.3 emerge装包ninja报错“manifest 'build.ninja' still dirty after 100 tries”解决方法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-gentoo-gentoo%e5%90%af%e5%8a%a8%e6%97%b6%e6%8c%82%e8%bd%bdcifs%e5%a4%b1%e8%b4%a5%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95" class="md-nav__link">
    <span class="md-ellipsis">
      6.2.4 Gentoo启动时挂载cifs失败解决方法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3" class="md-nav__link">
    <span class="md-ellipsis">
      6.2.5 Hyper-V环境下sddm无法启动图形界面问题解决
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%ae%89%e8%a3%85xfce%e5%90%8efcitx%e5%8f%b3%e4%b8%8a%e8%a7%92%e6%98%be%e7%a4%ba%e4%bd%86%e6%97%a0%e6%b3%95%e9%80%89%e6%8b%a9%e8%be%93%e5%85%a5%e6%b3%95%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3" class="md-nav__link">
    <span class="md-ellipsis">
      6.2.6 安装xfce后fcitx右上角显示但无法选择输入法问题解决
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-6-3" class="md-nav__link">
    <span class="md-ellipsis">
      6.3 OpenWrt
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.3 OpenWrt">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85wireguard" class="md-nav__link">
    <span class="md-ellipsis">
      6.3.1 OpenWrt安装WireGuard
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn" class="md-nav__link">
    <span class="md-ellipsis">
      6.3.2 OpenWrt安装OpenVPN
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%20ddns%e5%bc%80%e6%9c%ba%e5%90%af%e5%8a%a8%e5%a4%b1%e8%b4%a5%e9%97%ae%e9%a2%98" class="md-nav__link">
    <span class="md-ellipsis">
      6.3.3 OpenWrt DDNS开机启动失败问题
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh" class="md-nav__link">
    <span class="md-ellipsis">
      6.3.4 小米AX9000解锁SSH
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%88%b7%e6%9c%ba" class="md-nav__link">
    <span class="md-ellipsis">
      6.3.5 小米AX9000刷机
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%8a%a0%e5%85%a5160mhz%e6%94%af%e6%8c%81" class="md-nav__link">
    <span class="md-ellipsis">
      6.3.6 小米AX9000加入160MHz支持
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2" class="md-nav__link">
    <span class="md-ellipsis">
      6.3.7 北京联通中兴F4610U光猫开超管界面
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e4%bf%ae%e6%94%b9%e9%bb%98%e8%ae%a4shell%e4%b8%babash%e5%b9%b6%e5%bc%80%e5%90%af%e5%8e%86%e5%8f%b2%e5%91%bd%e4%bb%a4%e6%97%b6%e9%97%b4%e6%88%b3" class="md-nav__link">
    <span class="md-ellipsis">
      6.3.8 OpenWrt修改默认Shell为bash并开启历史命令时间戳
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-6-4" class="md-nav__link">
    <span class="md-ellipsis">
      6.4 Ubuntu
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.4 Ubuntu">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-ubuntu-ubuntu%e5%ae%89%e8%a3%85hyper-v%e5%b7%a5%e5%85%b7" class="md-nav__link">
    <span class="md-ellipsis">
      6.4.1 Ubuntu安装Hyper-V工具
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-6-5" class="md-nav__link">
    <span class="md-ellipsis">
      6.5 RHEL6
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.5 RHEL6">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-rhel6-%e8%ae%b0%e6%9f%90%e6%ac%a1%e8%af%af%e6%93%8d%e4%bd%9cyum%20update%e5%90%8ejboss%e5%ba%94%e7%94%a8%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%8f%8a%e9%87%8d%e5%90%af%e6%97%a0%e6%b3%95%e8%af%86%e5%88%abvg%e9%97%ae%e9%a2%98" class="md-nav__link">
    <span class="md-ellipsis">
      6.5.1 记某次误操作yum update后jboss应用无法启动及重启无法识别vg问题
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-6-6" class="md-nav__link">
    <span class="md-ellipsis">
      6.6 中标麒麟V7
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.6 中标麒麟V7">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88" class="md-nav__link">
    <span class="md-ellipsis">
      6.6.1 曙光服务器装机无RAID卡驱动导致不能识别硬盘问题分析与解决方案
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e8%81%94%e6%83%b3%e7%89%a9%e7%90%86%e6%9c%bapxe%e8%a3%85%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9c%e6%a0%b9%e5%88%86%e5%8c%ba%e6%89%be%e4%b8%8d%e5%88%b0%e2%80%9d%e5%8e%9f%e5%9b%a0%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95" class="md-nav__link">
    <span class="md-ellipsis">
      6.6.2 联想物理机PXE装机报错“根分区找不到”原因及解决方法
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-6-7" class="md-nav__link">
    <span class="md-ellipsis">
      6.7 银河麒麟V10
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.7 银河麒麟V10">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81" class="md-nav__link">
    <span class="md-ellipsis">
      6.7.1 麒麟V10SP4增加VSCode支持
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e8%ae%b0%e6%9f%90%e6%ac%a1%e6%9f%90%e5%ae%89%e5%85%a8%e5%8e%82%e5%95%86%e5%ba%94%e7%94%a8%e8%bf%90%e8%a1%8c%e4%b8%80%e6%ae%b5%e6%97%b6%e9%97%b4%e5%90%8e%ef%bc%8clinux%e5%87%ba%e7%8e%b0ping%e5%bb%b6%e8%bf%9f%e9%ab%98%e9%97%ae%e9%a2%98%e7%9a%84%e8%a7%a3%e5%86%b3%e6%80%9d%e8%b7%af" class="md-nav__link">
    <span class="md-ellipsis">
      6.7.2 记某次某安全厂商应用运行一段时间后Linux出现ping延迟高问题的解决思路
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-7" class="md-nav__link">
    <span class="md-ellipsis">
      7 虚拟化技术
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7 虚拟化技术">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#section-7-1" class="md-nav__link">
    <span class="md-ellipsis">
      7.1 Hyper-V
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.1 Hyper-V">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-hyper-v-hyper-v%e4%bf%ae%e6%94%b9%e8%b0%83%e5%ba%a6%e5%99%a8" class="md-nav__link">
    <span class="md-ellipsis">
      7.1.1 Hyper-V修改调度器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-hyper-v-hyper-v%e5%a4%9a%e7%bd%91%e5%8d%a1%e7%bb%91%e5%ae%9a" class="md-nav__link">
    <span class="md-ellipsis">
      7.1.3 Hyper-V多网卡绑定
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-7-2" class="md-nav__link">
    <span class="md-ellipsis">
      7.2 QEMU
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.2 QEMU">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-virt-manager%e5%88%9b%e5%bb%ba%e8%99%9a%e6%8b%9f%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9cdid%20not%20find%20any%20uefi%20binary%20path%20for%20arch%20%27aarch64%27%e2%80%9d%e9%97%ae%e9%a2%98" class="md-nav__link">
    <span class="md-ellipsis">
      7.2.1 virt-manager创建虚拟机报错“Did not find any UEFI binary path for arch 'aarch64'”问题
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba" class="md-nav__link">
    <span class="md-ellipsis">
      7.2.2 PVE发放ARM虚拟机
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#section-7-3" class="md-nav__link">
    <span class="md-ellipsis">
      7.3 华为云
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.3 华为云">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3" class="md-nav__link">
    <span class="md-ellipsis">
      7.3.1 华为HCS 8与银河麒麟V10SP4 cloud-init适配问题解决
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tags" class="md-nav__link">
    <span class="md-ellipsis">
      8 文档分类
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                



                  



<div id="print-site-page" class="print-site-enumerate-headings print-site-enumerate-figures">
        <section class="print-page">
            <div id="print-page-toc" data-toc-depth="3">
                <nav role='navigation' class='print-page-toc-nav'>
                <h1 class='print-page-toc-title'>Table of Contents</h1>
                </nav>
            </div>
        </section>
        <section class="print-page" id="index" heading-number="1"><h1 id="index-hxp">hxp 的文档库<a class="headerlink" href="#index-hxp" title="Permanent link">&para;</a></h1>
<p>此网站为 <a href="https://github.com/hxp-plus">胡喜平</a> 个人文档库。包含日常 Linux、存储、容器等所有技术研发的笔记。</p>
<h2 id="index-1">1. 个人简介<a class="headerlink" href="#index-1" title="Permanent link">&para;</a></h2>
<p>胡喜平，Linux 狂热爱好者，从 14 岁日常使用 Linux ，大学三年级获得 RedHat Linux 最高级认证 RHCA ，2 年 Arch Linux 、1 年 Gentoo 使用经验，具有丰富的 Linux 日常和企业使用经验，能通过自己折腾解决非常多的问题。</p>
<p>负责某国有大型银行 Ansible 及 AWX 的搭建和自动化问题、几乎所有和 Linux 沾边的事情，GPFS、Oracle、Redis、MySQL-cmha 等自动安装脚本、 Linux 故障和性能问题分析。</p>
<hindex-2 id="index-2">2. 个人工作经历<a class="headerlink" href="#index-2" title="Permanent link">&para;</a></h2>
<h3 id="index-21-linux">2.1 华中科技大学 Linux 社团创始人<a class="headerlink" href="#index-21-linux" title="Permanent link">&para;</a></h3>
<ul>
<li>创建华中科技大学 Linux 社团，负责社团 Gentoo Linux 服务器建设。</li>
</ul>
<ul>
<li>和校超算中心举办讲座 <a href="https://imo.hust.edu.cn/info/1353/4670.htm">https://imo.hust.edu.cn/info/1353/4670.htm</a></li>
</ul>
<h3 id="index-22-ansible-awx">2.2 某大型国有银行 Ansible 堡垒机和 AWX 建设<a class="headerlink" href="#index-22-ansible-awx" title="Permanent link">&para;</a></h3>
<ul>
<li>独自完成在银河麒麟 V10 信创系统上，搭建 4 个不同网络区域的 Kubernetes 集群，并将其作为 AWX 的容器组。将开源 AWX-23.9 使用 awx-operator 部署并自建 Keycloak 单点登陆系统、使用 SAML 对接。</li>
</ul>
<ul>
<li>完成 Ansible 堡垒机的容器化改造，解决不同人用相同账号上堡垒机时，每个登录之间相互隔离且有 root 权限、灰度发布等功能。</li>
</ul>
<ul>
<li>负责日常中间件安装、生产变更的 Ansible 脚本维护。</li>
</ul>
<ul>
<li>负责基于 Python 的 Ansible 模块编写。</li>
</ul>
<h2 id="index-3">3. 个人所获得的专业认证<a class="headerlink" href="#index-3" title="Permanent link">&para;</a></h2>
<h3 id="index-31-redhat-rhca">3.1 RedHat 认证架构师（RHCA）<a class="headerlink" href="#index-31-redhat-rhca" title="Permanent link">&para;</a></h3>
<p><img alt="" src="images/RHCA.png" /></p>
<h3 id="index-32-kubernetes-cka">3.2 Kubernetes CKA 认证<a class="headerlink" href="#index-32-kubernetes-cka" title="Permanent link">&para;</a></h3>
<p><img alt="" src="images/CKA.png" /></p>
<h3 id="index-33-redhat-ceph">3.3 RedHat 认证 Ceph 存储管理员<a class="headerlink" href="#index-33-redhat-ceph" title="Permanent link">&para;</a></h3>
<p><img alt="" src="images/EX125.png" /></p>
<h3 id="index-34-redhat">3.4 RedHat 认证系统管理员<a class="headerlink" href="#index-34-redhat" title="Permanent link">&para;</a></h3>
<p><img alt="" src="images/EX200.png" /></p>
<h3 id="index-35-redhat-openstack">3.5 RedHat 认证 OpenStack 系统管理员<a class="headerlink" href="#index-35-redhat-openstack" title="Permanent link">&para;</a></h3>
<p><img alt="" src="images/EX210.png" /></p>
<h3 id="index-36-redhat-openshift">3.6 RedHat 认证 OpenShift 管理专家<a class="headerlink" href="#index-36-redhat-openshift" title="Permanent link">&para;</a></h3>
<p><img alt="" src="images/EX280.png" /></p>
<h3 id="index-37-redhat">3.7 RedHat 认证工程师<a class="headerlink" href="#index-37-redhat" title="Permanent link">&para;</a></h3>
<p><img alt="" src="images/EX294.png" /></p>
<h3 id="index-38-redhat">3.8 RedHat 认证高可用集群专家<a class="headerlink" href="#index-38-redhat" title="Permanent link">&para;</a></h3>
<p><img alt="" src="images/EX436.png" /></p>
<h3 id="index-39-redhat-linux">3.9 RedHat 认证 Linux 性能调优专家<a class="headerlink" href="#index-39-redhat-linux" title="Permanent link">&para;</a></h3>
<p><img alt="" src="images/EX442.png" /></p></section>
                    <section class='print-page md-section' id='section-2' heading-number='2'>
                        <h1>容器技术<a class='headerlink' href='#section-2' title='Permanent link'></a>
                        </h1>
                    
                    <section class='print-page md-section' id='section-2-1' heading-number='2.1'>
                        <h1>Kubernetes<a class='headerlink' href='#section-2-1' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes" heading-number="2.1.1"><nav class='md-tags'><span class='md-tag'>Kubernetes</span><span class='md-tag'>银河麒麟V10</span></nav><h1 id="v10-kubernetes">银河麒麟 V10 安装 Kubernetes<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-v10-kubernetes" title="Permanent link">&para;</a></h1>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-1">1. 系统架构<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-1" title="Permanent link">&para;</a></h2>
<p>本次安装的 K8S 仅有 3 个 master 节点，其中 1 节点和 3 节点额外 HAProxy 和 Keepalived 做 apiserver 高可用，各个节点配置和用途如下：</p>
<table>
<thead>
<tr>
<th>节点名称</th>
<th>IP 地址</th>
<th>服务器角色</th>
<th>配置要求</th>
</tr>
</thead>
<tbody>
<tr>
<td>k8s01</td>
<td>192.168.100.11</td>
<td>K8S master 节点</td>
<td>2C4G，公网网卡名称 ens33</td>
</tr>
<tr>
<td>k8s02</td>
<td>192.168.100.12</td>
<td>K8S master 节点</td>
<td>2C4G，公网网卡名称 ens33</td>
</tr>
<tr>
<td>k8s03</td>
<td>192.168.100.13</td>
<td>K8S master 节点</td>
<td>2C4G，公网网卡名称 ens33</td>
</tr>
</tbody>
</table>
<p>其中，所有的节点都需要配置 NTP 时钟同步服务器，且所有节点都需要有默认网关。节点 k8s01 和 k8s03 因有安装 KeepAlived 的需求，需要额外配置一个 VIP：192.168.100.10，同时，需要使用 Ansible 对这 3 个节点进行批量配置。</p>
<p>此次安装为最小化安装，安装网络插件 calico，ingress、helm、ceph-csi 、metrics-server 等非必要功能不安装。同时，推荐提前创建 <code>/var/lib/containerd</code> 目录并给其单独挂在逻辑卷。</p>
<h%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-2">2. 准备工作<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-2" title="Permanent link">&para;</a></h2>
<h3 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-21">2.1 安装前系统参数<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-21" title="Permanent link">&para;</a></h3>
<p>所有节点均需要禁用 swap、关闭 firewalld 防火墙与 SELinux：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-0-6">6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-0-7">7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-0-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a># Disable swap
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>sed -i &#39;/^.*[[:space:]]*swap[[:space:]]*swap[[:space:]]*.*$/d&#39; /etc/fstab
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a># Disable firewalld
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a>systemctl disable firewalld.service
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a># Disable SELinux
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a>sed -i &#39;s/^SELINUX=.*$/SELINUX=disabled/g&#39; /etc/selinux/config
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a># Reboot to apply changes
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a>reboot
</span></code></pre></div></td></tr></table></div>
<p>对于 1C2G 的低配置机器，如果发现内存不足，需要修改 kdump 的默认 1024M 内存为更小的数值：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-1-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>sed -i &#39;s/crashkernel=1024M,high/crashkernel=128M,high/&#39; /etc/default/grub
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>grub2-mkconfig -o /boot/grub2/grub.cfg
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a>reboot
</span></code></pre></div></td></tr></table></div>
<h3 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-22">2.2 安装依赖的软件<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-22" title="Permanent link">&para;</a></h3>
<p>所有 k8s 节点都需要使用 yum 命令安装以下依赖：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>yum install conntrack-tools libnetfilter_cthelper ibnetfilter_cttimeout libnetfilter_queue socat
</span></code></pre></div></td></tr></table></div>
<h3 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-23-ansible">2.3 Ansible 主机清单配置<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-23-ansible" title="Permanent link">&para;</a></h3>
<p>本文使用 Ansible 来对节点进行批量操作，Ansible 主机清单配置如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-3-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-3-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-3-12">12</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-3-13">13</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-3-14">14</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-3-15">15</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-3-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>[k8s]
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>192.168.100.11
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a>192.168.100.12
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a>192.168.100.13
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a>[keepalived]
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a>192.168.100.11 keepalived_status=MASTER
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a>192.168.100.13 keepalived_status=BACKUP
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10"></a>[keepalived:vars]
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11"></a>keepalived_nic=ens33
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12"></a>keepalived_pass=unIhenGAcvAEH
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13"></a>keepalived_router_id=101
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14"></a>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15"></a>[all:vars]
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16"></a>keepalived_vip=192.168.100.10
</span></code></pre></div></td></tr></table></div>
<h3 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-24">2.4 介质下载<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-24" title="Permanent link">&para;</a></h3>
<p>如果需要离线安装，需要额外准备一台可以通外网的机器来下载介质，此机器也需要禁用 swap、关闭 firewalld 防火墙与 SELinux，且至少需要安装 docker、containerd 与 helm。其中需要下载的二进制文件及配置文件如下：</p>
<table>
<thead>
<tr>
<th>介质名称</th>
<th>下载地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>containerd-1.7.11-linux-amd64.tar.gz</td>
<td><a href="https://github.com/containerd/containerd/releases">https://github.com/containerd/containerd/releases</a></td>
</tr>
<tr>
<td>containerd.service</td>
<td><a href="https://raw.githubusercontent.com/containerd/containerd/main/containerd.service">https://raw.githubusercontent.com/containerd/containerd/main/containerd.service</a></td>
</tr>
<tr>
<td>runc.amd64</td>
<td><a href="https://github.com/opencontainers/runc/releases">https://github.com/opencontainers/runc/releases</a></td>
</tr>
<tr>
<td>cni-plugins-linux-amd64-v1.4.0.tgz</td>
<td><a href="https://github.com/containernetworking/plugins/releases">https://github.com/containernetworking/plugins/releases</a></td>
</tr>
<tr>
<td>crictl-v1.28.0-linux-amd64.tar.gz</td>
<td><a href="https://github.com/kubernetes-sigs/cri-tools/releases">https://github.com/kubernetes-sigs/cri-tools/releases</a></td>
</tr>
<tr>
<td>kubelet</td>
<td><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#k8s-install-2">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#k8s-install-2</a></td>
</tr>
<tr>
<td>kubeadm</td>
<td><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#k8s-install-2">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#k8s-install-2</a></td>
</tr>
<tr>
<td>kubectl</td>
<td><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#k8s-install-2">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#k8s-install-2</a></td>
</tr>
<tr>
<td>10-kubeadm.conf</td>
<td><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#k8s-install-2">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#k8s-install-2</a></td>
</tr>
<tr>
<td>tigera-operator.yaml</td>
<td><a href="https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart">https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart</a></td>
</tr>
<tr>
<td>custom-resources.yaml</td>
<td><a href="https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart">https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart</a></td>
</tr>
</tbody>
</table>
<p>需要下载的容器镜像如下：</p>
<table>
<thead>
<tr>
<th>镜像名称</th>
<th>下载方式</th>
</tr>
</thead>
<tbody>
<tr>
<td>registry.k8s.io/kube-apiserver:v1.29.0</td>
<td>使用 ctr 或者 docker 命令下载</td>
</tr>
<tr>
<td>registry.k8s.io/kube-controller-manager:v1.29.0</td>
<td>使用 ctr 或者 docker 命令下载</td>
</tr>
<tr>
<td>registry.k8s.io/kube-scheduler:v1.29.0</td>
<td>使用 ctr 或者 docker 命令下载</td>
</tr>
<tr>
<td>registry.k8s.io/kube-proxy:v1.29.0</td>
<td>使用 ctr 或者 docker 命令下载</td>
</tr>
<tr>
<td>registry.k8s.io/coredns/coredns:v1.11.1</td>
<td>使用 ctr 或者 docker 命令下载</td>
</tr>
<tr>
<td>registry.k8s.io/pause:3.9</td>
<td>使用 ctr 或者 docker 命令下载</td>
</tr>
<tr>
<td>registry.k8s.io/etcd:3.5.10-0</td>
<td>使用 ctr 或者 docker 命令下载</td>
</tr>
<tr>
<td>docker.io/library/haproxy:2.1.4</td>
<td>使用 ctr 或者 docker 命令下载</td>
</tr>
<tr>
<td>docker.io/osixia/keepalived:2.0.17</td>
<td>使用 ctr 或者 docker 命令下载</td>
</tr>
<tr>
<td>docker.io/calico/apiserver:v3.27.0</td>
<td>使用 ctr 或者 docker 命令下载</td>
</tr>
<tr>
<td>docker.io/calico/cni:v3.27.0</td>
<td>使用 ctr 或者 docker 命令下载</td>
</tr>
<tr>
<td>docker.io/calico/csi:v3.27.0</td>
<td>使用 ctr 或者 docker 命令下载</td>
</tr>
<tr>
<td>docker.io/calico/kube-controllers:v3.27.0</td>
<td>使用 ctr 或者 docker 命令下载</td>
</tr>
<tr>
<td>docker.io/calico/node-driver-registrar:v3.27.0</td>
<td>使用 ctr 或者 docker 命令下载</td>
</tr>
<tr>
<td>docker.io/calico/node:v3.27.0</td>
<td>使用 ctr 或者 docker 命令下载</td>
</tr>
<tr>
<td>docker.io/calico/pod2daemon-flexvol:v3.27.0</td>
<td>使用 ctr 或者 docker 命令下载</td>
</tr>
<tr>
<td>quay.io/tigera/operator:v1.32.3</td>
<td>使用 ctr 或者 docker 命令下载</td>
</tr>
<tr>
<td>docker.io/calico/typha:v3.27.0</td>
<td>使用 ctr 或者 docker 命令下载</td>
</tr>
</tbody>
</table>
<p>容器镜像使用 ctr 或者 docker 命令下载，ctr 的下载命令如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-4-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>ctr -n k8s.io image pull [镜像名称] --platform linux/amd64
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a>ctr -n k8s.io image export [镜像名称].tar [镜像名称] --platform linux/amd64
</span></code></pre></div></td></tr></table></div>
<p>docker 下载的命令如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-5-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>docker pull [镜像名称]
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a>docker image save -i [镜像名称].tar
</span></code></pre></div></td></tr></table></div>
<p>导入容器镜像，需要在 k8s 节点用 ctr 命令导入，命令如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-6-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a>ctr -n k8s.io image import [镜像名称].tar --platform linux/amd64
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-3-containerd">3. 安装 containerd 容器运行环境<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-3-containerd" title="Permanent link">&para;</a></h2>
<p>所有的 k8s 节点都需要安装 containerd，使用此 Ansible Playbook 进行批量安装：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">containerd-install.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-12">12</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-13">13</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-14">14</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-15">15</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-16">16</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-17">17</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-18">18</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-19">19</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-20">20</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-21">21</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-22">22</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-23">23</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-24">24</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-25">25</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-26">26</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-27">27</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-28">28</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-29">29</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-30">30</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-31">31</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-32">32</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-7-33">33</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="nn">---</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install containerd</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">extract containerd-1.7.11-linux-amd64.tar.gz</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">      </span><span class="nt">unarchive</span><span class="p">:</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="w">        </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">containerd-1.7.11-linux-amd64.tar.gz</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/local/</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install containerd.service</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="w">      </span><span class="nt">copy</span><span class="p">:</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="w">        </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">containerd.service</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/lib/systemd/system/containerd.service</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">generate default containerd config</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="w">      </span><span class="nt">shell</span><span class="p">:</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="w">        </span><span class="nt">cmd</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16"></a><span class="w">          </span><span class="no">mkdir -p /etc/containerd/</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="w">          </span><span class="no">containerd config default &gt; /etc/containerd/config.toml</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">configure containerd to use systemd cgroup</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="w">      </span><span class="nt">replace</span><span class="p">:</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20"></a><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/containerd/config.toml</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21"></a><span class="w">        </span><span class="nt">regexp</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;SystemdCgroup</span><span class="nv"> </span><span class="s">=</span><span class="nv"> </span><span class="s">false&quot;</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22"></a><span class="w">        </span><span class="nt">replace</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;SystemdCgroup</span><span class="nv"> </span><span class="s">=</span><span class="nv"> </span><span class="s">true&quot;</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">configure containerd to use pause:3.9</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24"></a><span class="w">      </span><span class="nt">replace</span><span class="p">:</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25"></a><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/containerd/config.toml</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26"></a><span class="w">        </span><span class="nt">regexp</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;registry.k8s.io/pause:3.8&quot;</span>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27"></a><span class="w">        </span><span class="nt">replace</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;registry.k8s.io/pause:3.9&quot;</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">enable and restart containerd service</span>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29"></a><span class="w">      </span><span class="nt">systemd</span><span class="p">:</span>
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">containerd</span>
</span><span id="__span-7-31"><a id="__codelineno-7-31" name="__codelineno-7-31"></a><span class="w">        </span><span class="nt">daemon_reload</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</span><span id="__span-7-32"><a id="__codelineno-7-32" name="__codelineno-7-32"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restarted</span>
</span><span id="__span-7-33"><a id="__codelineno-7-33" name="__codelineno-7-33"></a><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-4-kubernetes">4. 安装 Kubernetes<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-4-kubernetes" title="Permanent link">&para;</a></h2>
<h3 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-41-k8s">4.1 配置内核参数并安装 k8s 二进制文件<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-41-k8s" title="Permanent link">&para;</a></h3>
<p>使用以下 playbook 配置内核参数、安装二进制文件并导入容器镜像：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">k8s-install.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-12">12</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-13">13</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-14">14</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-15">15</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-16">16</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-17">17</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-18">18</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-19">19</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-20">20</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-21">21</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-22">22</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-23">23</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-24">24</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-25">25</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-26">26</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-27">27</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-28">28</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-29">29</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-30">30</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-31">31</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-32">32</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-33">33</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-34">34</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-35">35</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-36">36</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-37">37</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-38">38</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-39">39</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-40">40</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-41">41</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-42">42</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-43">43</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-44">44</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-45">45</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-46">46</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-47">47</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-48">48</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-49">49</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-50">50</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-51">51</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-52">52</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-53">53</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-54">54</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-55">55</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-56">56</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-57">57</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-58">58</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-59">59</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-60">60</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-61">61</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-62">62</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-63">63</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-64">64</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-65">65</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-66">66</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-67">67</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-68">68</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-69">69</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-70">70</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-71">71</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-72">72</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-73">73</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-74">74</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-75">75</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-8-76">76</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="nn">---</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install kubernetes</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">edit /etc/modules-load.d/k8s.conf</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">      </span><span class="nt">copy</span><span class="p">:</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="w">        </span><span class="nt">content</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">          </span><span class="no">overlay</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">          </span><span class="no">br_netfilter</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/modules-load.d/k8s.conf</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="w">      </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s_mod</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">edit /etc/sysctl.d/k8s.conf</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="w">      </span><span class="nt">copy</span><span class="p">:</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14"></a><span class="w">        </span><span class="nt">content</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15"></a><span class="w">          </span><span class="no">net.bridge.bridge-nf-call-iptables  = 1</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16"></a><span class="w">          </span><span class="no">net.bridge.bridge-nf-call-ip6tables = 1</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17"></a><span class="w">          </span><span class="no">net.ipv4.ip_forward                 = 1</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/sysctl.d/k8s.conf</span>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19"></a><span class="w">      </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s_sysctl</span>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">edit /etc/sysctl.conf</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21"></a><span class="w">      </span><span class="nt">copy</span><span class="p">:</span>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22"></a><span class="w">        </span><span class="nt">content</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/sysctl.conf</span>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24"></a><span class="w">      </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sysctl</span>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reboot</span>
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26"></a><span class="w">      </span><span class="nt">reboot</span><span class="p">:</span>
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27"></a><span class="w">        </span><span class="nt">reboot_timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">600</span>
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28"></a><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s_mod.changed == true or k8s_sysctl.changed == true or sysctl.changed == true</span>
</span><span id="__span-8-29"><a id="__codelineno-8-29" name="__codelineno-8-29"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install runc</span>
</span><span id="__span-8-30"><a id="__codelineno-8-30" name="__codelineno-8-30"></a><span class="w">      </span><span class="nt">copy</span><span class="p">:</span>
</span><span id="__span-8-31"><a id="__codelineno-8-31" name="__codelineno-8-31"></a><span class="w">        </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">runc.amd64</span>
</span><span id="__span-8-32"><a id="__codelineno-8-32" name="__codelineno-8-32"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/local/sbin/runc</span>
</span><span id="__span-8-33"><a id="__codelineno-8-33" name="__codelineno-8-33"></a><span class="w">        </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0755</span>
</span><span id="__span-8-34"><a id="__codelineno-8-34" name="__codelineno-8-34"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">create directory /opt/cni/bin</span>
</span><span id="__span-8-35"><a id="__codelineno-8-35" name="__codelineno-8-35"></a><span class="w">      </span><span class="nt">file</span><span class="p">:</span>
</span><span id="__span-8-36"><a id="__codelineno-8-36" name="__codelineno-8-36"></a><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/opt/cni/bin</span>
</span><span id="__span-8-37"><a id="__codelineno-8-37" name="__codelineno-8-37"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">directory</span>
</span><span id="__span-8-38"><a id="__codelineno-8-38" name="__codelineno-8-38"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install cni-plugins</span>
</span><span id="__span-8-39"><a id="__codelineno-8-39" name="__codelineno-8-39"></a><span class="w">      </span><span class="nt">unarchive</span><span class="p">:</span>
</span><span id="__span-8-40"><a id="__codelineno-8-40" name="__codelineno-8-40"></a><span class="w">        </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cni-plugins-linux-amd64-v1.4.0.tgz</span>
</span><span id="__span-8-41"><a id="__codelineno-8-41" name="__codelineno-8-41"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/opt/cni/bin</span>
</span><span id="__span-8-42"><a id="__codelineno-8-42" name="__codelineno-8-42"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install crictl</span>
</span><span id="__span-8-43"><a id="__codelineno-8-43" name="__codelineno-8-43"></a><span class="w">      </span><span class="nt">unarchive</span><span class="p">:</span>
</span><span id="__span-8-44"><a id="__codelineno-8-44" name="__codelineno-8-44"></a><span class="w">        </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">crictl-v1.28.0-linux-amd64.tar.gz</span>
</span><span id="__span-8-45"><a id="__codelineno-8-45" name="__codelineno-8-45"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/local/bin</span>
</span><span id="__span-8-46"><a id="__codelineno-8-46" name="__codelineno-8-46"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install kubelet, kubeadm and kubectl</span>
</span><span id="__span-8-47"><a id="__codelineno-8-47" name="__codelineno-8-47"></a><span class="w">      </span><span class="nt">copy</span><span class="p">:</span>
</span><span id="__span-8-48"><a id="__codelineno-8-48" name="__codelineno-8-48"></a><span class="w">        </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span id="__span-8-49"><a id="__codelineno-8-49" name="__codelineno-8-49"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/local/bin/</span>
</span><span id="__span-8-50"><a id="__codelineno-8-50" name="__codelineno-8-50"></a><span class="w">        </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0755</span>
</span><span id="__span-8-51"><a id="__codelineno-8-51" name="__codelineno-8-51"></a><span class="w">      </span><span class="nt">with_items</span><span class="p">:</span>
</span><span id="__span-8-52"><a id="__codelineno-8-52" name="__codelineno-8-52"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeadm</span>
</span><span id="__span-8-53"><a id="__codelineno-8-53" name="__codelineno-8-53"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubelet</span>
</span><span id="__span-8-54"><a id="__codelineno-8-54" name="__codelineno-8-54"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubectl</span>
</span><span id="__span-8-55"><a id="__codelineno-8-55" name="__codelineno-8-55"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">set up bash-completion</span>
</span><span id="__span-8-56"><a id="__codelineno-8-56" name="__codelineno-8-56"></a><span class="w">      </span><span class="nt">lineinfile</span><span class="p">:</span>
</span><span id="__span-8-57"><a id="__codelineno-8-57" name="__codelineno-8-57"></a><span class="w">        </span><span class="nt">line</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;source</span><span class="nv"> </span><span class="s">&lt;(kubectl</span><span class="nv"> </span><span class="s">completion</span><span class="nv"> </span><span class="s">bash)&quot;</span>
</span><span id="__span-8-58"><a id="__codelineno-8-58" name="__codelineno-8-58"></a><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/root/.bashrc</span>
</span><span id="__span-8-59"><a id="__codelineno-8-59" name="__codelineno-8-59"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install kubelet service</span>
</span><span id="__span-8-60"><a id="__codelineno-8-60" name="__codelineno-8-60"></a><span class="w">      </span><span class="nt">copy</span><span class="p">:</span>
</span><span id="__span-8-61"><a id="__codelineno-8-61" name="__codelineno-8-61"></a><span class="w">        </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubelet.service</span>
</span><span id="__span-8-62"><a id="__codelineno-8-62" name="__codelineno-8-62"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/systemd/system/kubelet.service</span>
</span><span id="__span-8-63"><a id="__codelineno-8-63" name="__codelineno-8-63"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">create directory /etc/systemd/system/kubelet.service.d</span>
</span><span id="__span-8-64"><a id="__codelineno-8-64" name="__codelineno-8-64"></a><span class="w">      </span><span class="nt">file</span><span class="p">:</span>
</span><span id="__span-8-65"><a id="__codelineno-8-65" name="__codelineno-8-65"></a><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/systemd/system/kubelet.service.d</span>
</span><span id="__span-8-66"><a id="__codelineno-8-66" name="__codelineno-8-66"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">directory</span>
</span><span id="__span-8-67"><a id="__codelineno-8-67" name="__codelineno-8-67"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install 10-kubeadm.conf</span>
</span><span id="__span-8-68"><a id="__codelineno-8-68" name="__codelineno-8-68"></a><span class="w">      </span><span class="nt">copy</span><span class="p">:</span>
</span><span id="__span-8-69"><a id="__codelineno-8-69" name="__codelineno-8-69"></a><span class="w">        </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10-kubeadm.conf</span>
</span><span id="__span-8-70"><a id="__codelineno-8-70" name="__codelineno-8-70"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span>
</span><span id="__span-8-71"><a id="__codelineno-8-71" name="__codelineno-8-71"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">enable and restart kubelet service</span>
</span><span id="__span-8-72"><a id="__codelineno-8-72" name="__codelineno-8-72"></a><span class="w">      </span><span class="nt">systemd</span><span class="p">:</span>
</span><span id="__span-8-73"><a id="__codelineno-8-73" name="__codelineno-8-73"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubelet</span>
</span><span id="__span-8-74"><a id="__codelineno-8-74" name="__codelineno-8-74"></a><span class="w">        </span><span class="nt">daemon_reload</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</span><span id="__span-8-75"><a id="__codelineno-8-75" name="__codelineno-8-75"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restarted</span>
</span><span id="__span-8-76"><a id="__codelineno-8-76" name="__codelineno-8-76"></a><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-42-etchosts">4.2 配置所有节点/etc/hosts<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-42-etchosts" title="Permanent link">&para;</a></h3>
<h4 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-421-jinja2">4.2.1 创建 jinja2 模板文件<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-421-jinja2" title="Permanent link">&para;</a></h4>
<p>创建一个 jinja2 模板文件用于配置 hosts，将其放在 templates 目录下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">hosts.j2</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-9-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-9-2">2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-9-3">3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-9-4">4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-9-5">5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-9-6">6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-9-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2"></a>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3"></a>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4"></a>{{ keepalived_vip }} cluster-endpoint
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5"></a>{% for host in groups[&#39;k8s&#39;] %}
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6"></a>{{ host }} {{ hostvars[host].ansible_nodename }}
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7"></a>{% endfor %}
</span></code></pre></div></td></tr></table></div>
<h4 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-422-ansible-playbook-etchosts">4.2.2 使用 Ansible Playbook 配置/etc/hosts<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-422-ansible-playbook-etchosts" title="Permanent link">&para;</a></h4>
<p>使用以下 Ansible Playbook 批量配置/etc/hosts：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-10-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-10-2">2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-10-3">3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-10-4">4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-10-5">5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-10-6">6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-10-7">7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-10-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="nn">---</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">config /etc/hosts for all hosts</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">create /etc/hosts</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">      </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="w">        </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">templates/hosts.j2</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/hosts</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-43-static-pod-keepalived-haproxy">4.3 使用 static pod 方式安装 Keepalived 和 HAProxy<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-43-static-pod-keepalived-haproxy" title="Permanent link">&para;</a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>在生产环境，如果负载均衡器可用，推荐使用负载均衡器来实现 apiserver 高可用。如果没有负载均衡器，推荐单独发放 2 台虚拟机做 HAProxy 和 Keepalived 进行软负载高可用。如果实在无法满足条件，在 2 个 k8s 节点以 static pod 方式安装 HAProxy 和 Keepalived。</p>
</div>
<h4 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-431-jinja2">4.3.1 创建 jinja2 模板文件<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-431-jinja2" title="Permanent link">&para;</a></h4>
<p>一共需要创建 4 个 jinja2 模板文件，将其放在 templates 目录下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">check_apiserver.sh.j2</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-11-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-11-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a>#!/bin/sh
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2"></a>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3"></a>errorExit() {
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4"></a>    echo &quot;*** $*&quot; 1&gt;&amp;2
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5"></a>    exit 1
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6"></a>}
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7"></a>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8"></a>curl --silent --max-time 2 --insecure https://localhost:8443/ -o /dev/null || errorExit &quot;Error GET https://localhost:8443/&quot;
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9"></a>if ip addr | grep -q {{ keepalived_vip }}; then
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10"></a>    curl --silent --max-time 2 --insecure https://{{ keepalived_vip }}:8443/ -o /dev/null || errorExit &quot;Error GET https://{{ keepalived_vip }}:8443/&quot;
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11"></a>fi
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">haproxy.cfg.j2</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-12">12</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-13">13</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-14">14</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-15">15</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-16">16</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-17">17</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-18">18</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-19">19</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-20">20</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-21">21</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-22">22</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-23">23</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-24">24</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-25">25</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-26">26</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-27">27</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-28">28</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-29">29</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-30">30</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-31">31</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-32">32</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-33">33</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-34">34</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-35">35</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-36">36</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-37">37</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-38">38</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-39">39</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-40">40</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-41">41</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-42">42</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-43">43</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-44">44</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-45">45</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-46">46</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-47">47</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-48">48</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-49">49</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-50">50</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-12-51">51</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a># /etc/haproxy/haproxy.cfg
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2"></a>#---------------------------------------------------------------------
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3"></a># Global settings
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4"></a>#---------------------------------------------------------------------
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5"></a>global
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6"></a>    log /dev/log local0
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7"></a>    log /dev/log local1 notice
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8"></a>    daemon
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9"></a>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10"></a>#---------------------------------------------------------------------
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11"></a># common defaults that all the &#39;listen&#39; and &#39;backend&#39; sections will
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12"></a># use if not designated in their block
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13"></a>#---------------------------------------------------------------------
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14"></a>defaults
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15"></a>    mode                    http
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16"></a>    log                     global
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17"></a>    option                  httplog
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18"></a>    option                  dontlognull
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19"></a>    option http-server-close
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20"></a>    option forwardfor       except 127.0.0.0/8
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21"></a>    option                  redispatch
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22"></a>    retries                 1
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23"></a>    timeout http-request    10s
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24"></a>    timeout queue           20s
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25"></a>    timeout connect         5s
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26"></a>    timeout client          20s
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27"></a>    timeout server          20s
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28"></a>    timeout http-keep-alive 10s
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29"></a>    timeout check           10s
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30"></a>
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31"></a>#---------------------------------------------------------------------
</span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32"></a># apiserver frontend which proxys to the control plane nodes
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33"></a>#---------------------------------------------------------------------
</span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34"></a>frontend apiserver
</span><span id="__span-12-35"><a id="__codelineno-12-35" name="__codelineno-12-35"></a>    bind *:8443
</span><span id="__span-12-36"><a id="__codelineno-12-36" name="__codelineno-12-36"></a>    mode tcp
</span><span id="__span-12-37"><a id="__codelineno-12-37" name="__codelineno-12-37"></a>    option tcplog
</span><span id="__span-12-38"><a id="__codelineno-12-38" name="__codelineno-12-38"></a>    default_backend apiserverbackend
</span><span id="__span-12-39"><a id="__codelineno-12-39" name="__codelineno-12-39"></a>
</span><span id="__span-12-40"><a id="__codelineno-12-40" name="__codelineno-12-40"></a>#---------------------------------------------------------------------
</span><span id="__span-12-41"><a id="__codelineno-12-41" name="__codelineno-12-41"></a># round robin balancing for apiserver
</span><span id="__span-12-42"><a id="__codelineno-12-42" name="__codelineno-12-42"></a>#---------------------------------------------------------------------
</span><span id="__span-12-43"><a id="__codelineno-12-43" name="__codelineno-12-43"></a>backend apiserverbackend
</span><span id="__span-12-44"><a id="__codelineno-12-44" name="__codelineno-12-44"></a>    option httpchk GET /healthz
</span><span id="__span-12-45"><a id="__codelineno-12-45" name="__codelineno-12-45"></a>    http-check expect status 200
</span><span id="__span-12-46"><a id="__codelineno-12-46" name="__codelineno-12-46"></a>    mode tcp
</span><span id="__span-12-47"><a id="__codelineno-12-47" name="__codelineno-12-47"></a>    option ssl-hello-chk
</span><span id="__span-12-48"><a id="__codelineno-12-48" name="__codelineno-12-48"></a>    balance     roundrobin
</span><span id="__span-12-49"><a id="__codelineno-12-49" name="__codelineno-12-49"></a>    {% for host in groups[&#39;k8s&#39;] %}
</span><span id="__span-12-50"><a id="__codelineno-12-50" name="__codelineno-12-50"></a>        server {{ hostvars[host].ansible_nodename }} {{ host }}:6443 check
</span><span id="__span-12-51"><a id="__codelineno-12-51" name="__codelineno-12-51"></a>    {% endfor %}
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">haproxy.yaml.j2</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-12">12</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-13">13</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-14">14</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-15">15</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-16">16</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-17">17</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-18">18</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-19">19</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-20">20</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-21">21</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-22">22</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-23">23</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-24">24</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-25">25</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-26">26</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-13-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a>apiVersion: v1
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2"></a>kind: Pod
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3"></a>metadata:
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4"></a>  name: haproxy
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5"></a>  namespace: kube-system
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6"></a>spec:
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7"></a>  containers:
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8"></a>  - image: docker.io/library/haproxy:2.1.4
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9"></a>    name: haproxy
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10"></a>    livenessProbe:
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11"></a>      failureThreshold: 8
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12"></a>      httpGet:
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13"></a>        host: localhost
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14"></a>        path: /healthz
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15"></a>        port: 8443
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16"></a>        scheme: HTTPS
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17"></a>    volumeMounts:
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18"></a>    - mountPath: /usr/local/etc/haproxy/haproxy.cfg
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19"></a>      name: haproxyconf
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20"></a>      readOnly: true
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21"></a>  hostNetwork: true
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22"></a>  volumes:
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23"></a>  - hostPath:
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24"></a>      path: /etc/haproxy/haproxy.cfg
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25"></a>      type: FileOrCreate
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26"></a>    name: haproxyconf
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27"></a>status: {}
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">keepalived.conf.j2</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-12">12</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-13">13</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-14">14</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-15">15</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-16">16</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-17">17</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-18">18</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-19">19</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-20">20</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-21">21</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-22">22</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-23">23</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-24">24</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-25">25</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-26">26</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-27">27</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-28">28</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-14-29">29</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a>! /etc/keepalived/keepalived.conf
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2"></a>! Configuration File for keepalived
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3"></a>global_defs {
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4"></a>    router_id LVS_DEVEL
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5"></a>}
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6"></a>vrrp_script check_apiserver {
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7"></a>  script &quot;/etc/keepalived/check_apiserver.sh&quot;
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8"></a>  interval 3
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9"></a>  weight -2
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10"></a>  fall 10
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11"></a>  rise 2
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12"></a>}
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13"></a>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14"></a>vrrp_instance VI_1 {
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15"></a>    state {{ keepalived_status }}
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16"></a>    interface {{ keepalived_nic }}
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17"></a>    virtual_router_id {{ keepalived_router_id }}
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18"></a>    priority 50
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19"></a>    authentication {
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20"></a>        auth_type PASS
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21"></a>        auth_pass {{ keepalived_pass }}
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22"></a>    }
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23"></a>    virtual_ipaddress {
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24"></a>        {{ keepalived_vip }}
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25"></a>    }
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26"></a>    track_script {
</span><span id="__span-14-27"><a id="__codelineno-14-27" name="__codelineno-14-27"></a>        check_apiserver
</span><span id="__span-14-28"><a id="__codelineno-14-28" name="__codelineno-14-28"></a>    }
</span><span id="__span-14-29"><a id="__codelineno-14-29" name="__codelineno-14-29"></a>}
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">keepalived.yaml.j2</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-12">12</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-13">13</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-14">14</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-15">15</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-16">16</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-17">17</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-18">18</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-19">19</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-20">20</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-21">21</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-22">22</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-23">23</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-24">24</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-25">25</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-26">26</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-27">27</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-28">28</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-29">29</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-30">30</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-15-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1"></a>apiVersion: v1
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2"></a>kind: Pod
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3"></a>metadata:
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4"></a>  creationTimestamp: null
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5"></a>  name: keepalived
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6"></a>  namespace: kube-system
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7"></a>spec:
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8"></a>  containers:
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9"></a>  - image: docker.io/osixia/keepalived:2.0.17
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10"></a>    name: keepalived
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11"></a>    resources: {}
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12"></a>    securityContext:
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13"></a>      capabilities:
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14"></a>        add:
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15"></a>        - NET_ADMIN
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16"></a>        - NET_BROADCAST
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17"></a>        - NET_RAW
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18"></a>    volumeMounts:
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19"></a>    - mountPath: /usr/local/etc/keepalived/keepalived.conf
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20"></a>      name: config
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21"></a>    - mountPath: /etc/keepalived/check_apiserver.sh
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22"></a>      name: check
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23"></a>  hostNetwork: true
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24"></a>  volumes:
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25"></a>  - hostPath:
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26"></a>      path: /etc/keepalived/keepalived.conf
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27"></a>    name: config
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28"></a>  - hostPath:
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29"></a>      path: /etc/keepalived/check_apiserver.sh
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30"></a>    name: check
</span><span id="__span-15-31"><a id="__codelineno-15-31" name="__codelineno-15-31"></a>status: {}
</span></code></pre></div></td></tr></table></div>
<h4 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-432-ansible-playbook-haproxy-keepalived-static-pod">4.3.2 使用 Ansible Playbook 安装 HAProxy 和 Keepalived 的 static pod<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-432-ansible-playbook-haproxy-keepalived-static-pod" title="Permanent link">&para;</a></h4>
<p>使用以下 Playbook 安装 HAProxy 和 Keepalived 的 static pod：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">k8s-install-haproxy-keepalived.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-12">12</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-13">13</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-14">14</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-15">15</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-16">16</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-17">17</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-18">18</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-19">19</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-20">20</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-21">21</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-22">22</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-23">23</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-24">24</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-25">25</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-26">26</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-27">27</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-28">28</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-29">29</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-30">30</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-31">31</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-32">32</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-33">33</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-34">34</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-35">35</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-36">36</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-37">37</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-38">38</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-16-39">39</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="nn">---</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install keepalived and haproxy as static pod</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">create directory /etc/haproxy, /etc/keepalived and /etc/kubernetes/manifests</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="w">      </span><span class="nt">file</span><span class="p">:</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">directory</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="w">        </span><span class="nt">recurse</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10"></a><span class="w">      </span><span class="nt">with_items</span><span class="p">:</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/haproxy</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/keepalived</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/kubernetes/manifests</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14"></a><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&#39;keepalived&#39;</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">group_names&quot;</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">create /etc/haproxy/haproxy.cfg</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16"></a><span class="w">      </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17"></a><span class="w">        </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">templates/haproxy.cfg.j2</span>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/haproxy/haproxy.cfg</span>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19"></a><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&#39;keepalived&#39;</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">group_names&quot;</span>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">create /etc/keepalived/check_apiserver.sh</span>
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21"></a><span class="w">      </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-16-22"><a id="__codelineno-16-22" name="__codelineno-16-22"></a><span class="w">        </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">templates/check_apiserver.sh.j2</span>
</span><span id="__span-16-23"><a id="__codelineno-16-23" name="__codelineno-16-23"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/keepalived/check_apiserver.sh</span>
</span><span id="__span-16-24"><a id="__codelineno-16-24" name="__codelineno-16-24"></a><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&#39;keepalived&#39;</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">group_names&quot;</span>
</span><span id="__span-16-25"><a id="__codelineno-16-25" name="__codelineno-16-25"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">create /etc/keepalived/keepalived.conf</span>
</span><span id="__span-16-26"><a id="__codelineno-16-26" name="__codelineno-16-26"></a><span class="w">      </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-16-27"><a id="__codelineno-16-27" name="__codelineno-16-27"></a><span class="w">        </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">templates/keepalived.conf.j2</span>
</span><span id="__span-16-28"><a id="__codelineno-16-28" name="__codelineno-16-28"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/keepalived/keepalived.conf</span>
</span><span id="__span-16-29"><a id="__codelineno-16-29" name="__codelineno-16-29"></a><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&#39;keepalived&#39;</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">group_names&quot;</span>
</span><span id="__span-16-30"><a id="__codelineno-16-30" name="__codelineno-16-30"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">create /etc/kubernetes/manifests/haproxy.yaml</span>
</span><span id="__span-16-31"><a id="__codelineno-16-31" name="__codelineno-16-31"></a><span class="w">      </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-16-32"><a id="__codelineno-16-32" name="__codelineno-16-32"></a><span class="w">        </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">templates/haproxy.yaml.j2</span>
</span><span id="__span-16-33"><a id="__codelineno-16-33" name="__codelineno-16-33"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/kubernetes/manifests/haproxy.yaml</span>
</span><span id="__span-16-34"><a id="__codelineno-16-34" name="__codelineno-16-34"></a><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&#39;keepalived&#39;</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">group_names&quot;</span>
</span><span id="__span-16-35"><a id="__codelineno-16-35" name="__codelineno-16-35"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">create /etc/kubernetes/manifests/keepalived.yaml</span>
</span><span id="__span-16-36"><a id="__codelineno-16-36" name="__codelineno-16-36"></a><span class="w">      </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-16-37"><a id="__codelineno-16-37" name="__codelineno-16-37"></a><span class="w">        </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">templates/keepalived.yaml.j2</span>
</span><span id="__span-16-38"><a id="__codelineno-16-38" name="__codelineno-16-38"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/kubernetes/manifests/keepalived.yaml</span>
</span><span id="__span-16-39"><a id="__codelineno-16-39" name="__codelineno-16-39"></a><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&#39;keepalived&#39;</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">group_names&quot;</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-44-kubeadm-kubernetes">4.4 使用 kubeadm 创建 Kubernetes 集群<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-44-kubeadm-kubernetes" title="Permanent link">&para;</a></h3>
<p>在 k8s01 节点创建集群：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-17-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1"></a>kubeadm init --control-plane-endpoint cluster-endpoint:8443 --pod-network-cidr=172.18.0.0/16 --upload-certs
</span></code></pre></div></td></tr></table></div>
<p>创建成功后会有以下提示：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-18-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-18-2">2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-18-3">3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-18-4">4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-18-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1"></a>You can now join any number of the control-plane node running the following command on each as root:
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2"></a>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3"></a>  kubeadm join cluster-endpoint:8443 --token dqgsa7.3g5uhcbbtbgogrfm \
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4"></a>    --discovery-token-ca-cert-hash sha256:7b66a8861d2c2986f1d5caf043b8e5358477b52d4760055dda2781ddad44cc92 \
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5"></a>    --control-plane --certificate-key 526b695cca88e6c8bbb1e19f805f46f080087bcb748a5547009d99c6ac1e4d27
</span></code></pre></div></td></tr></table></div>
<p>在 k8s02 和 k8s03 执行：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-19-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-19-2">2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-19-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1"></a>kubeadm join cluster-endpoint:8443 --token dqgsa7.3g5uhcbbtbgogrfm \
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2"></a>    --discovery-token-ca-cert-hash sha256:7b66a8861d2c2986f1d5caf043b8e5358477b52d4760055dda2781ddad44cc92 \
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3"></a>    --control-plane --certificate-key 526b695cca88e6c8bbb1e19f805f46f080087bcb748a5547009d99c6ac1e4d27
</span></code></pre></div></td></tr></table></div>
<p>将两个节点加入集群，之后所有 k8s 节点都修改 bashrc：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-20-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-20-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1"></a>echo &#39;export KUBECONFIG=/etc/kubernetes/admin.conf&#39; &gt;&gt; /root/.bashrc
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2"></a>source /root/.bashrc
</span></code></pre></div></td></tr></table></div>
<p>检查集群状态：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-21-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-21-2">2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-21-3">3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-21-4">4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-21-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1"></a># kubectl get nodes
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2"></a>NAME    STATUS     ROLES           AGE     VERSION
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3"></a>k8s01   NotReady   control-plane   4m32s   v1.29.0
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4"></a>k8s02   NotReady   control-plane   2m6s    v1.29.0
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5"></a>k8s03   NotReady   control-plane   110s    v1.29.0
</span></code></pre></div></td></tr></table></div>
<p>此时 NotReady 是因为没有安装 calico，为正常现象。</p>
<h3 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-45-master">4.5 设置允许 master 节点调度容器<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-45-master" title="Permanent link">&para;</a></h3>
<p>集群创建以后，因为我们只有 master 节点，需要允许容器在 master 节点调度：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-22-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1"></a>kubectl taint nodes --all node-role.kubernetes.io/control-plane-
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-5-calico">5. 安装 Calico 网络插件<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-5-calico" title="Permanent link">&para;</a></h2>
<h3 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-51-networkmanager">5.1 配置 NetworkManager<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-51-networkmanager" title="Permanent link">&para;</a></h3>
<p>所有节点都需要配置 NetworkManager 忽略 calico 网卡，可使用以下 playbook 批量配置：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">calico-configure-nm.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-23-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-23-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-23-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-23-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-23-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-23-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-23-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-23-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-23-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-23-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-23-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-23-12">12</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-23-13">13</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-23-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="nn">---</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">configure networkmanager for calico</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">create /etc/NetworkManager/conf.d/calico.conf</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6"></a><span class="w">      </span><span class="nt">copy</span><span class="p">:</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7"></a><span class="w">        </span><span class="nt">content</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8"></a><span class="w">          </span><span class="no">[keyfile]</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9"></a><span class="w">          </span><span class="no">unmanaged-devices=interface-name:cali*;interface-name:tunl*;interface-name:vxlan.calico;interface-name:vxlan-v6.calico;interface-name:wireguard.cali;interface-name:wg-v6.cali</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/NetworkManager/conf.d/calico.conf</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restart networkmanager</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12"></a><span class="w">      </span><span class="nt">systemd</span><span class="p">:</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkManager</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restarted</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-52-tigera-operator-calico">5.2 创建 tigera-operator 并安装 calico<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-52-tigera-operator-calico" title="Permanent link">&para;</a></h3>
<p>创建 <code>custom-resources.yaml</code>：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">custom-resources.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-24-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-24-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-24-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-24-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-24-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-24-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-24-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-24-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-24-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-24-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-24-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-24-12">12</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-24-13">13</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-24-14">14</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-24-15">15</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-24-16">16</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-24-17">17</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-24-18">18</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-24-19">19</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-24-20">20</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-24-21">21</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-24-22">22</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-24-23">23</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-24-24">24</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="c1"># This section includes base Calico installation configuration.</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="c1"># For more information, see: https://docs.tigera.io/calico/latest/reference/installation/api#operator.tigera.io/v1.Installation</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">operator.tigera.io/v1</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Installation</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8"></a><span class="w">  </span><span class="c1"># Configures Calico networking.</span>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9"></a><span class="w">  </span><span class="nt">calicoNetwork</span><span class="p">:</span>
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10"></a><span class="w">    </span><span class="c1"># Note: The ipPools section cannot be modified post-install.</span>
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11"></a><span class="w">    </span><span class="nt">ipPools</span><span class="p">:</span>
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">blockSize</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">24</span>
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13"></a><span class="w">        </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">172.18.0.0/16</span>
</span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14"></a><span class="w">        </span><span class="nt">encapsulation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VXLAN</span>
</span><span id="__span-24-15"><a id="__codelineno-24-15" name="__codelineno-24-15"></a><span class="w">        </span><span class="nt">natOutgoing</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Enabled</span>
</span><span id="__span-24-16"><a id="__codelineno-24-16" name="__codelineno-24-16"></a><span class="w">        </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all()</span>
</span><span id="__span-24-17"><a id="__codelineno-24-17" name="__codelineno-24-17"></a><span class="nn">---</span>
</span><span id="__span-24-18"><a id="__codelineno-24-18" name="__codelineno-24-18"></a><span class="c1"># This section configures the Calico API server.</span>
</span><span id="__span-24-19"><a id="__codelineno-24-19" name="__codelineno-24-19"></a><span class="c1"># For more information, see: https://docs.tigera.io/calico/latest/reference/installation/api#operator.tigera.io/v1.APIServer</span>
</span><span id="__span-24-20"><a id="__codelineno-24-20" name="__codelineno-24-20"></a><span class="c1">#apiVersion: operator.tigera.io/v1</span>
</span><span id="__span-24-21"><a id="__codelineno-24-21" name="__codelineno-24-21"></a><span class="c1">#kind: APIServer</span>
</span><span id="__span-24-22"><a id="__codelineno-24-22" name="__codelineno-24-22"></a><span class="c1">#metadata:</span>
</span><span id="__span-24-23"><a id="__codelineno-24-23" name="__codelineno-24-23"></a><span class="c1">#  name: default</span>
</span><span id="__span-24-24"><a id="__codelineno-24-24" name="__codelineno-24-24"></a><span class="c1">#spec: {}</span>
</span></code></pre></div></td></tr></table></div>
<p>在任意一个 k8s 节点上运行：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-25-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-25-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1"></a>kubectl create -f tigera-operator.yaml
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2"></a>kubectl create -f custom-resources.yaml
</span></code></pre></div></td></tr></table></div>
<p>检查 pod 状态：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-26-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-26-2">2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-26-3">3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-26-4">4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-26-5">5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-26-6">6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-26-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1"></a># kubectl -n tigera-operator get pods
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2"></a>NAME                               READY   STATUS    RESTARTS      AGE
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3"></a>tigera-operator-55585899bf-6mwrh   1/1     Running   2 (50s ago)   11m
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4"></a># kubectl -n calico-system get pods
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5"></a>NAME                           READY   STATUS    RESTARTS       AGE
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6"></a>calico-typha-f8fd87f9d-8sb7w   1/1     Running   1 (2m8s ago)   10m
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7"></a>calico-typha-f8fd87f9d-thkt6   1/1     Running   1 (92s ago)    10m
</span></code></pre></div></td></tr></table></div>
<p>在完全就绪以后，在 k8s 上查看路由表，可以看到 calico 为每个 k8s 节点都分配了一个网段，网段写入了路由表：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-27-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-27-2">2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-27-3">3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-27-4">4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-27-5">5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-27-6">6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-27-7">7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-27-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1"></a># ip route
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2"></a>default via 192.168.100.1 dev ens33 proto static metric 100
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3"></a>172.18.97.0/24 via 172.18.97.0 dev vxlan.calico onlink
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4"></a>172.18.122.0/24 via 172.18.122.0 dev vxlan.calico onlink
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5"></a>blackhole 172.18.209.0/24 proto 80
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6"></a>172.18.209.7 dev cali7ba71aa9a5b scope link
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7"></a>172.18.209.8 dev cali4f83fc794cd scope link
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8"></a>192.168.100.0/24 dev ens33 proto kernel scope link src 192.168.100.11 metric 100
</span></code></pre></div></td></tr></table></div>
<p>完全就绪以后，检查两个 coredns 是不是扎堆部署在一个节点上：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-28-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-28-2">2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-28-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1"></a># kubectl -n kube-system get pods -o wide | grep coredns
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2"></a>kube-system        coredns-76f75df574-4nskd            1/1     Running   1 (4m17s ago)   47m     172.18.97.7      k8s03    &lt;none&gt;           &lt;none&gt;
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3"></a>kube-system        coredns-76f75df574-t9stk            1/1     Running   1 (4m17s ago)   47m     172.18.97.6      k8s03    &lt;none&gt;           &lt;none&gt;
</span></code></pre></div></td></tr></table></div>
<p>如果有这种情况，需要轮询重启 coredns 来使得 coredns 不扎堆在一个节点：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-__codelineno-29-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1"></a>kubectl -n kube-system rollout restart deployment coredns
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-6">6. 参考链接<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes-6" title="Permanent link">&para;</a></h2>
<p><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/</a></p>
<p><a href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/">https://kubernetes.io/docs/setup/production-environment/container-runtimes/</a></p>
<p><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/</a></p>
<p><a href="https://github.com/kubernetes/kubeadm/blob/main/docs/ha-considerations.md#options-for-software-load-balancing">https://github.com/kubernetes/kubeadm/blob/main/docs/ha-considerations.md#options-for-software-load-balancing</a></p>
<p><a href="https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart">https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart</a></p>
<p><a href="https://www.pivert.org/ceph-csi-on-kubernetes-1-24/">https://www.pivert.org/ceph-csi-on-kubernetes-1-24/</a></p></section><section class="print-page" id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8" heading-number="2.1.2"><nav class='md-tags'><span class='md-tag'>Kubernetes</span><span class='md-tag'>Ceph</span></nav><h1 id="cephfs">对接 CephFS 存储<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-cephfs" title="Permanent link">&para;</a></h1>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-1">1. 准备工作<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-1" title="Permanent link">&para;</a></h2>
<h3 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-11">1.1 介质下载<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-11" title="Permanent link">&para;</a></h3>
<p>需要使用以下命令下载 ceph-csi-cephfs 的 helm chart：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>helm repo add ceph-csi https://ceph.github.io/csi-charts
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>helm pull ceph-csi/ceph-csi-cephfs
</span></code></pre></div></td></tr></table></div>
<p>同时需要下载此 helm chart 所需的容器镜像，镜像名称用以下命令查看：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>helm template ceph-csi-cephfs-3.10.1.tgz | grep &#39;image:&#39;
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-2-cephfs-volume">2. 新建 cephfs 和 volume<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-2-cephfs-volume" title="Permanent link">&para;</a></h2>
<p>在 ceph 服务器上，使用<code>cephadm shell</code>进入 ceph 命令行，并执行以下命令：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-2-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>ceph<span class="w"> </span>fs<span class="w"> </span>volume<span class="w"> </span>create<span class="w"> </span>cephfs
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>ceph<span class="w"> </span>fs<span class="w"> </span>subvolumegroup<span class="w"> </span>create<span class="w"> </span>cephfs<span class="w"> </span>csi
</span></code></pre></div></td></tr></table></div>
<p>执行以后检查：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>ceph fs volume ls
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-4-2">2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-4-3">3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-4-4">4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-4-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>[
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a>    {
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a>        &quot;name&quot;: &quot;cephfs&quot;
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a>    }
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a>]
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-5-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>ceph fs subvolumegroup ls cephfs
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-6-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-6-2">2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-6-3">3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-6-4">4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-6-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a>[
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a>    {
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a>        &quot;name&quot;: &quot;csi&quot;
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a>    }
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a>]
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-3-ceph-admin-keyring">3. ceph 集群配置和 admin keyring 收集<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-3-ceph-admin-keyring" title="Permanent link">&para;</a></h2>
<p>在 ceph 节点上，收集 ceph 配置和 admin 的 keyring：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-7-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a>ceph config generate-minimal-conf
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-8-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-8-2">2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-8-3">3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-8-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a># minimal ceph.conf for 77488730-b4d9-11ee-bec7-fa163e3bb924
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a>[global]
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a>    fsid = 77488730-b4d9-11ee-bec7-fa163e3bb924
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a>    mon_host = [v2:192.168.100.14:3300/0,v1:192.168.100.14:6789/0] [v2:192.168.100.15:3300/0,v1:192.168.100.15:6789/0] [v2:192.168.100.16:3300/0,v1:192.168.100.16:6789/0]
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-9-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a>ceph auth get client.admin
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-10-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-10-2">2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-10-3">3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-10-4">4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-10-5">5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-10-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a>[client.admin]
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a>    key = ********
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3"></a>    caps mds = &quot;allow *&quot;
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4"></a>    caps mgr = &quot;allow *&quot;
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5"></a>    caps mon = &quot;allow *&quot;
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6"></a>    caps osd = &quot;allow *&quot;
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-4-valuesyaml">4. 创建 values.yaml<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-4-valuesyaml" title="Permanent link">&para;</a></h2>
<p>首先生成 values.yaml：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-11-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a>helm show values ceph-csi-cephfs-3.10.1.tgz &gt; values.yaml
</span></code></pre></div></td></tr></table></div>
<p>修改以下的部分：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-12-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="nt">csiConfig</span><span class="p">:</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">clusterID</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;77488730-b4d9-11ee-bec7-fa163e3bb924&quot;</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">    </span><span class="nt">monitors</span><span class="p">:</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;192.168.100.14&quot;</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;192.168.100.15&quot;</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;192.168.100.16&quot;</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="w">    </span><span class="nt">cephFS</span><span class="p">:</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="w">      </span><span class="nt">subvolumeGroup</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;csi&quot;</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="w">      </span><span class="c1"># netNamespaceFilePath: &quot;{{ .kubeletDir }}/plugins/{{ .driverName }}/net&quot;</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="c1"># csiConfig: []</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-13-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-13-2">2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-13-3">3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-13-4">4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-13-5">5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-13-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a>secret:
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2"></a>  # Specifies whether the secret should be created
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3"></a>  create: true
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4"></a>  name: csi-cephfs-secret
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5"></a>  adminID: admin
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6"></a>  adminKey: ********
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-14-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-14-2">2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-14-3">3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-14-4">4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-14-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a>storageClass:
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2"></a>  create: true
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3"></a>  name: csi-cephfs-sc
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4"></a>  clusterID: 77488730-b4d9-11ee-bec7-fa163e3bb924
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5"></a>  fsName: cephfs
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-5-helm-chart-ceph-csi-cephfs">5. 使用 helm chart 安装 ceph-csi-cephfs<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-5-helm-chart-ceph-csi-cephfs" title="Permanent link">&para;</a></h2>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-15-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-15-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1"></a>kubectl<span class="w"> </span>create<span class="w"> </span>namespace<span class="w"> </span>ceph-csi-cephfs
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2"></a>helm<span class="w"> </span>install<span class="w"> </span>--namespace<span class="w"> </span><span class="s2">&quot;ceph-csi-cephfs&quot;</span><span class="w"> </span><span class="s2">&quot;ceph-csi-cephfs&quot;</span><span class="w"> </span>ceph-csi-cephfs-3.10.1.tgz<span class="w"> </span>--values<span class="w"> </span>./values.yaml
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-6-ceph-csi-sc-storage-class">6. 将 ceph-csi-sc 设置为默认 storage class<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-6-ceph-csi-sc-storage-class" title="Permanent link">&para;</a></h2>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-16-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1"></a>kubectl<span class="w"> </span>patch<span class="w"> </span>storageclass<span class="w"> </span>ceph-csi-sc<span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;{&quot;metadata&quot;: {&quot;annotations&quot;:{&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;true&quot;}}}&#39;</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-7-pvc">7. 创建 pvc 并测试<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-7-pvc" title="Permanent link">&para;</a></h2>
<p>新建文件<code>test-pvc.yaml</code>：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">test-pvc.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-17-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-17-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-17-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-17-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-17-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-17-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-17-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-17-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-17-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-17-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-17-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-17-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="nn">---</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-pvc</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteMany</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10"></a><span class="w">    </span><span class="nt">requests</span><span class="p">:</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11"></a><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">csi-cephfs-sc</span>
</span></code></pre></div></td></tr></table></div>
<p>创建 pvc：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-18-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1"></a>kubectl apply -f test-pvc.yaml
</span></code></pre></div></td></tr></table></div>
<p>检查 pvc 状态为 Bound 则为安装成功：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-19-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1"></a>kubectl get pvc
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-20-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-20-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1"></a>NAME       STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS    VOLUMEATTRIBUTESCLASS   AGE
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2"></a>test-pvc   Bound    pvc-9c92208e-cd5a-436a-a785-74b6dc00ae31   1Gi        RWX            csi-cephfs-sc   &lt;unset&gt;                 9m15s
</span></code></pre></div></td></tr></table></div>
<p>如果要查询这个 pvc 对应的 pv 对应的 cephfs 存储位置，可使用以下命令：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-21-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1"></a>kubectl get pv $(kubectl get pvc test-pvc -o jsonpath=&quot;{.spec.volumeName}&quot;) -o jsonpath=&#39;{.spec.csi.volumeAttributes.subvolumePath}&#39;;echo
</span></code></pre></div></td></tr></table></div>
<p>清理：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-22-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1"></a>kubectl delete -f testpvc.yaml
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-8-k8s-cephfs">8. 在非 k8s 节点挂载 cephfs 的方法<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-8-k8s-cephfs" title="Permanent link">&para;</a></h2>
<h3 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-81-ceph-fuse">8.1 安装并配置 ceph-fuse<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-81-ceph-fuse" title="Permanent link">&para;</a></h3>
<p>在 ceph 客户端上安装 ceph-fuse：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-23-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1"></a>yum install ceph-fuse
</span></code></pre></div></td></tr></table></div>
<p>配置<code>/etc/ceph/ceph.conf</code>：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-24-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-24-2">2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-24-3">3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-24-4">4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-24-5">5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-24-6">6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-24-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1"></a>mkdir -p -m 755 /etc/ceph
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2"></a>cat &gt; /etc/ceph/ceph.conf &lt;&lt;-&#39;EOF&#39;
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3"></a>[global]
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4"></a>    fsid = 77488730-b4d9-11ee-bec7-fa163e3bb924
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5"></a>    mon_host = 192.168.100.14:6789,192.168.100.15:6789,192.168.100.16:6789
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6"></a>EOF
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7"></a>chmod 644 /etc/ceph/ceph.conf
</span></code></pre></div></td></tr></table></div>
<p>配置 keyring：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-25-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-25-2">2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-25-3">3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-25-4">4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-25-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1"></a>cat &gt; /etc/ceph/ceph.client.admin.keyring &lt;&lt;-&#39;EOF&#39;
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2"></a>[client.admin]
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3"></a>    key = **********
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4"></a>EOF
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5"></a>chmod 600 /etc/ceph/ceph.client.admin.keyring
</span></code></pre></div></td></tr></table></div>
<h3 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-82-cephfs">8.2 临时挂在 cephfs<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-82-cephfs" title="Permanent link">&para;</a></h3>
<p>如果要临时挂载，使用命令：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-26-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1"></a>ceph-fuse -n client.admin /mnt/cephfs
</span></code></pre></div></td></tr></table></div>
<h3 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-83-cephfs">8.3 永久挂载 cephfs<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-83-cephfs" title="Permanent link">&para;</a></h3>
<p>如果要永久挂载，则配置<code>/etc/fstab</code>，加入以下行：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-27-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1"></a>none    /mnt/cephfs fuse.ceph   ceph.id=admin,_netdev   0   0
</span></code></pre></div></td></tr></table></div>
<p>再挂载 cephfs：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-28-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-__codelineno-28-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1"></a>mkdir -p /mnt/cephfs
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2"></a>mount /mnt/cephfs
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-9">9. 参考链接<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8-9" title="Permanent link">&para;</a></h2>
<p><a href="https://www.pivert.org/ceph-csi-on-kubernetes-1-24/">https://www.pivert.org/ceph-csi-on-kubernetes-1-24/</a></p></section><section class="print-page" id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller" heading-number="2.1.3"><nav class='md-tags'><span class='md-tag'>Kubernetes</span><span class='md-tag'>traefik</span></nav><h1 id="traefik-ingress-controller">安装 traefik ingress controller<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-traefik-ingress-controller" title="Permanent link">&para;</a></h1>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-1">1. 准备工作<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-1" title="Permanent link">&para;</a></h2>
<h3 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-11">1.1 介质下载<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-11" title="Permanent link">&para;</a></h3>
<p>需要使用以下命令下载 traefik 的 helm chart：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>helm repo add traefik https://traefik.github.io/charts
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>helm pull traefik/traefik
</span></code></pre></div></td></tr></table></div>
<p>同时需要下载此 helm chart 所需的容器镜像，镜像名称用以下命令查看：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>helm install --dry-run traefik traefik-27.0.2.tgz | grep image:
</span></code></pre></div></td></tr></table></div>
<p>如果需要测试 traefik 部署，还需要下载容器镜像<code>docker.io/traefik/whoami:v1.10</code>，并从 traefik 官网的 <a href="https://doc.traefik.io/traefik/getting-started/quick-start-with-kubernetes/">QuickStart</a> 章节下载 yaml 文件<code>03-whoami.yml</code>、<code>03-whoami-services.yml</code>和<code>04-whoami-ingress.yml</code>。</p>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-2-values">2. 创建并修改 values<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-2-values" title="Permanent link">&para;</a></h2>
<p>创建<code>values.yaml</code>：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>helm show values traefik-27.0.2.tgz &gt; values.yaml
</span></code></pre></div></td></tr></table></div>
<p>如果使用私有镜像仓库，需要修改<code>image</code>和<code>imagePullSecrets</code>。</p>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-3-helm-chart">3. 部署 helm chart<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-3-helm-chart" title="Permanent link">&para;</a></h2>
<p>创建 namespace 并部署：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-3-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>kubectl create ns traefik
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>helm install --namespace traefik traefik traefik-27.0.2.tgz --values values.yaml
</span></code></pre></div></td></tr></table></div>
<p>将容器部署修改为 3 个：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-4-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>kubectl -n traefik scale deployment traefik --replicas 3
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-4">4. 配置负载均衡器<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-4" title="Permanent link">&para;</a></h2>
<p>首选查询 traefik 的 NodePort 端口：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-5-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>kubectl get svc -n traefik
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-6-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-6-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a>NAME      TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a>traefik   LoadBalancer   10.96.103.221   &lt;pending&gt;     80:30795/TCP,443:32752/TCP   5d1h
</span></code></pre></div></td></tr></table></div>
<p>这里 http 端口 30795，https 端口 32752，配置负载均衡器的 80 端口转发到所有 k8s 节点 30795 端口，443 端口转发到所有 k8s 节点 32752 端口，负载模式为 TCP 轮询。如果使用的是在 k8s master 节点使用 static pod 方式安装 HAProxy 和 Keepalived 的方式，则需要修改 HAProxy 配置：</p>
<div class="language-cfg highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-7-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-7-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-7-12">12</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-7-13">13</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-7-14">14</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-7-15">15</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-7-16">16</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-7-17">17</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-7-18">18</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-7-19">19</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-7-20">20</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-7-21">21</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-7-22">22</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-7-23">23</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-7-24">24</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-7-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="na">frontend web</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="w">    </span><span class="na">bind *</span><span class="o">:</span><span class="s">80</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="w">    </span><span class="na">mode tcp</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">    </span><span class="na">option tcplog</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">    </span><span class="na">default_backend webbackend</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6"></a>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="na">backend webbackend</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">    </span><span class="na">mode tcp</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">    </span><span class="na">balance     roundrobin</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="w">        </span><span class="na">server k8s01 192.168.100.11</span><span class="o">:</span><span class="s">30795 check</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="w">        </span><span class="na">server k8s02 192.168.100.12</span><span class="o">:</span><span class="s">30795 check</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="w">        </span><span class="na">server k8s03 192.168.100.13</span><span class="o">:</span><span class="s">30795 check</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13"></a>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="na">frontend websecure</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="w">    </span><span class="na">bind *</span><span class="o">:</span><span class="s">443</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16"></a><span class="w">    </span><span class="na">mode tcp</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="w">    </span><span class="na">option tcplog</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="w">    </span><span class="na">default_backend websecurebackend</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19"></a>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20"></a><span class="na">backend websecurebackend</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21"></a><span class="w">    </span><span class="na">mode tcp</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22"></a><span class="w">    </span><span class="na">balance     roundrobin</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23"></a><span class="w">        </span><span class="na">server k8s01 192.168.100.11</span><span class="o">:</span><span class="s">32752 check</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24"></a><span class="w">        </span><span class="na">server k8s02 192.168.100.12</span><span class="o">:</span><span class="s">32752 check</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25"></a><span class="w">        </span><span class="na">server k8s03 192.168.100.13</span><span class="o">:</span><span class="s">32752 check</span>
</span></code></pre></div></td></tr></table></div>
<p>static pod 重启必须使用 crictl 命令，首先找到 static pod 的容器 ID：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-8-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a>crictl ps | grep haproxy
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-9-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a>a0b4e29a3ba18 6600fae04efde 3 minutes ago Running haproxy 2 5e3faac3ce66d haproxy-k8s01
</span></code></pre></div></td></tr></table></div>
<p>然后停止容器：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-10-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a>crictl stop a0b4e29a3ba18
</span></code></pre></div></td></tr></table></div>
<p>在停止容器后 kubelet 会自动将其重新拉起。</p>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-5-whoami">5. 创建 whoami 容器进行验证<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-5-whoami" title="Permanent link">&para;</a></h2>
<p>在 default 命名空间，创建 whoami 容器、service 和 ingress：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-11-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a>kubectl apply -f 03-whoami.yml -f 03-whoami-services.yml -f 04-whoami-ingress.yml
</span></code></pre></div></td></tr></table></div>
<p>使用 curl 命令检查：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-12-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a>curl http://[负载均衡器VIP]/whoami/
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-13-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-13-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-13-12">12</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-13-13">13</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-13-14">14</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-13-15">15</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-13-16">16</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-13-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a>Hostname: whoami-78994d7bf9-x7lzr
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2"></a>IP: 127.0.0.1
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3"></a>IP: ::1
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4"></a>IP: 172.18.209.24
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5"></a>IP: fe80::209c:b5ff:fefa:ca79
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6"></a>RemoteAddr: 172.18.209.20:41776
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7"></a>GET /whoami/ HTTP/1.1
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8"></a>Host: 192.168.100.10
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9"></a>User-Agent: curl/7.71.1
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10"></a>Accept: */*
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11"></a>Accept-Encoding: gzip
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12"></a>X-Forwarded-For: 192.168.100.11
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13"></a>X-Forwarded-Host: 192.168.100.10
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14"></a>X-Forwarded-Port: 80
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15"></a>X-Forwarded-Proto: http
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16"></a>X-Forwarded-Server: traefik-deployment-65547f8865-27d6x
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17"></a>X-Real-Ip: 192.168.100.11
</span></code></pre></div></td></tr></table></div>
<p>可以看到 whoami 容器收到的请求里带着文根 whoami，之后测试 middleware 去除文根功能，修改<code>04-whoami-ingress.yml</code>如下：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-12">12</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-13">13</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-14">14</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-15">15</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-16">16</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-17">17</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-18">18</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-19">19</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-20">20</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-21">21</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-22">22</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-23">23</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-24">24</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-25">25</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-26">26</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-27">27</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-14-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">whoami-ingress</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="w">    </span><span class="nt">ingress.kubernetes.io/ssl-redirect</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;false&quot;</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="w">    </span><span class="nt">traefik.ingress.kubernetes.io/router.middlewares</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default-strip-prefix@kubernetescrd</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http</span><span class="p">:</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11"></a><span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13"></a><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14"></a><span class="w">            </span><span class="nt">backend</span><span class="p">:</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15"></a><span class="w">              </span><span class="nt">service</span><span class="p">:</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16"></a><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">whoami</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17"></a><span class="w">                </span><span class="nt">port</span><span class="p">:</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18"></a><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19"></a><span class="nn">---</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">traefik.containo.us/v1alpha1</span>
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Middleware</span>
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">strip-prefix</span>
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24"></a><span class="w">  </span><span class="c1"># No namespace defined</span>
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26"></a><span class="w">  </span><span class="nt">stripPrefixRegex</span><span class="p">:</span>
</span><span id="__span-14-27"><a id="__codelineno-14-27" name="__codelineno-14-27"></a><span class="w">    </span><span class="nt">regex</span><span class="p">:</span>
</span><span id="__span-14-28"><a id="__codelineno-14-28" name="__codelineno-14-28"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">^/[^/]+</span>
</span></code></pre></div></td></tr></table></div>
<p>修改完成后应用 yaml 配置：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-15-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1"></a>kubectl apply -f 04-whoami-ingress.yml
</span></code></pre></div></td></tr></table></div>
<p>用 curl 命令测试：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-16-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1"></a>curl http://[负载均衡器VIP]/whoami/
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-17-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-17-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-17-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-17-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-17-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-17-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-17-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-17-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-17-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-17-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-17-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-17-12">12</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-17-13">13</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-17-14">14</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-17-15">15</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-17-16">16</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-17-17">17</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-17-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1"></a>Hostname: whoami-8c9864b56-dms8j
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2"></a>IP: 127.0.0.1
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3"></a>IP: ::1
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4"></a>IP: 172.18.122.2
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5"></a>IP: fe80::e840:22ff:fe60:51e7
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6"></a>RemoteAddr: 172.18.209.2:41866
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7"></a>GET / HTTP/1.1
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8"></a>Host: 192.168.100.10
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9"></a>User-Agent: curl/7.61.1
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10"></a>Accept: */*
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11"></a>Accept-Encoding: gzip
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12"></a>X-Forwarded-For: 172.18.122.0
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13"></a>X-Forwarded-Host: 192.168.100.10
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14"></a>X-Forwarded-Port: 80
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15"></a>X-Forwarded-Prefix: /whoami
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16"></a>X-Forwarded-Proto: http
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17"></a>X-Forwarded-Server: traefik-858b7cfbcd-t4ltm
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18"></a>X-Real-Ip: 172.18.122.0
</span></code></pre></div></td></tr></table></div>
<p>注意这里的<code>GET /whoami/ HTTP/1.1</code>变成了<code>GET / HTTP/1.1</code>，说明 middleware 生效。最后清理测试使用的资源：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-__codelineno-18-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1"></a>kubectl delete -f 03-whoami.yml -f 03-whoami-services.yml -f 04-whoami-ingress.yml
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-6">6. 参考链接<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller-6" title="Permanent link">&para;</a></h2>
<p><a href="https://doc.traefik.io/traefik/getting-started/install-traefik/#use-the-helm-chart">https://doc.traefik.io/traefik/getting-started/install-traefik/#use-the-helm-chart</a></p>
<p><a href="https://github.com/traefik/traefik-helm-chart/blob/master/EXAMPLES.md">https://github.com/traefik/traefik-helm-chart/blob/master/EXAMPLES.md</a></p></section><section class="print-page" id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85helm%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8" heading-number="2.1.4"><nav class='md-tags'><span class='md-tag'>Kubernetes</span><span class='md-tag'>helm</span></nav><h1 id="helm">安装 helm 包管理器<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85helm%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8-helm" title="Permanent link">&para;</a></h1>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85helm%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8-1">1. 准备工作<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85helm%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8-1" title="Permanent link">&para;</a></h2>
<h3 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85helm%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8-11">1.1 介质下载<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85helm%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8-11" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>介质名称</th>
<th>下载地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>helm-v3.14.0-linux-amd64.tar.gz</td>
<td><a href="https://github.com/helm/helm/releases">https://github.com/helm/helm/releases</a></td>
</tr>
</tbody>
</table>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85helm%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8-2-ansible-playbook-k8s-helm">2. 使用 Ansible Playbook 为所有 k8s 节点批量安装 helm<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85helm%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8-2-ansible-playbook-k8s-helm" title="Permanent link">&para;</a></h2>
<p>将 helm 二进制程序放到<code>/usr/local/bin/</code>即可完成安装，playbook 如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">helm-install.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85helm%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85helm%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85helm%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85helm%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85helm%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85helm%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85helm%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85helm%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85helm%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85helm%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85helm%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85helm%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85helm%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85helm%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8-__codelineno-0-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>---
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>- name: install helm
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a>  hosts: k8s
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a>  tasks:
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a>  - name: unarchive files to remote /tmp
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a>    unarchive:
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a>      src: helm-v3.14.0-linux-amd64.tar.gz
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a>      dest: /tmp/
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a>  - name: install helm
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a>    copy:
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a>      src: /tmp/linux-amd64/helm
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a>      dest: /usr/local/bin/helm
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a>      mode: 0755
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a>      remote_src: yes
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85helm%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8-3">3. 参考链接<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85helm%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8-3" title="Permanent link">&para;</a></h2>
<p><a href="https://helm.sh/docs/intro/install/">https://helm.sh/docs/intro/install/</a></p>
<p><a href="https://stackoverflow.com/questions/50343089/how-to-use-helm-charts-without-internet-access">https://stackoverflow.com/questions/50343089/how-to-use-helm-charts-without-internet-access</a></p>
<p><a href="https://stackoverflow.com/questions/60892265/extract-docker-images-from-helm-chart">https://stackoverflow.com/questions/60892265/extract-docker-images-from-helm-chart</a></p></section><section class="print-page" id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server" heading-number="2.1.5"><nav class='md-tags'><span class='md-tag'>Kubernetes</span><span class='md-tag'>metrics-server</span></nav><h1 id="metrics-server">安装 metrics-server<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-metrics-server" title="Permanent link">&para;</a></h1>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-1">1. 准备工作<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-1" title="Permanent link">&para;</a></h2>
<h3 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-11">1.1 介质下载<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-11" title="Permanent link">&para;</a></h3>
<p>需要使用以下命令下载 metrics-server 的 helm chart：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>helm repo add metrics-server https://kubernetes-sigs.github.io/metrics-server/
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>helm pull metrics-server/metrics-server
</span></code></pre></div></td></tr></table></div>
<p>同时需要下载此 helm chart 所需的容器镜像，镜像名称用以下命令查看：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>helm install --dry-run metrics-server metrics-server-3.12.0.tgz | grep image:
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-2-helm-metrics-server">2. 使用 helm 安装 metrics-server<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-2-helm-metrics-server" title="Permanent link">&para;</a></h2>
<p>在其中一个节点创建 metrics-server 的 namespace 并安装：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-2-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>kubectl create ns metrics-server
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>helm install --namespace metrics-server metrics-server metrics-server-3.11.0.tgz
</span></code></pre></div></td></tr></table></div>
<p>创建之后，修改 deployments 配置：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>kubectl -n metrics-server edit deployments.apps metrics-server
</span></code></pre></div></td></tr></table></div>
<p>新增<code>- --kubelet-insecure-tls</code>配置，修改之后如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-4-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>    spec:
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a>      containers:
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a>      - args:
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a>        - --secure-port=10250
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a>        - --cert-dir=/tmp
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a>        - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a>        - --kubelet-use-node-status-port
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a>        - --metric-resolution=15s
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a>        - --kubelet-insecure-tls
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a>        image: registry.k8s.io/metrics-server/metrics-server:v0.6.4
</span></code></pre></div></td></tr></table></div>
<p>修改之后轮询重启容器，并将容器修改为部署 3 个：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-5-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>kubectl -n metrics-server rollout restart deployment metrics-server
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a>kubectl -n metrics-server scale --replicas 3 deployment metrics-server
</span></code></pre></div></td></tr></table></div>
<p>部署完成后检查资源状态：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-6-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a>kubectl get all -n metrics-server
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-7-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-7-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-7-12">12</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-7-13">13</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-7-14">14</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server-__codelineno-7-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a>NAME                                  READY   STATUS    RESTARTS   AGE
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a>pod/metrics-server-55f78d9d6f-4r98q   1/1     Running   0          32s
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a>pod/metrics-server-55f78d9d6f-68t2q   1/1     Running   0          32s
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4"></a>pod/metrics-server-55f78d9d6f-cktdd   1/1     Running   0          102s
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5"></a>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6"></a>NAME                     TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7"></a>service/metrics-server   ClusterIP   10.108.4.192   &lt;none&gt;        443/TCP   8m2s
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8"></a>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9"></a>NAME                             READY   UP-TO-DATE   AVAILABLE   AGE
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10"></a>deployment.apps/metrics-server   3/3     3            3           8m2s
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11"></a>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12"></a>NAME                                        DESIRED   CURRENT   READY   AGE
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13"></a>replicaset.apps/metrics-server-55f78d9d6f   3         3         3       102s
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14"></a>replicaset.apps/metrics-server-596d577f98   0         0         0       2m24s
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15"></a>replicaset.apps/metrics-server-5b76987ff    0         0         0       8m2s
</span></code></pre></div></td></tr></table></div>
<p>之后执行<code>kubectl top pods -A</code>和<code>kubectl top nodes</code>，观察有无报错。</p></section><section class="print-page" id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81" heading-number="2.1.6"><nav class='md-tags'><span class='md-tag'>Kubernetes</span><span class='md-tag'>Nexus</span></nav><h1 id="_1">配置私有镜像仓库凭证<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-_1" title="Permanent link">&para;</a></h1>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-1-docker">1. docker 配置添加<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-1-docker" title="Permanent link">&para;</a></h2>
<p>在 Nexus 虚拟机<code>192.168.100.12</code>上，获取 docker 配置<code>~/.docker/config.json</code>如下：</p>
<div class="language-json highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-__codelineno-0-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="p">{</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">  </span><span class="nt">&quot;auths&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="nt">&quot;192.168.100.12:8082&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">      </span><span class="nt">&quot;auth&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;**********&quot;</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="nt">&quot;192.168.100.12:8083&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">      </span><span class="nt">&quot;auth&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;**********&quot;</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>将此配置复制到 kubernetes 的 master 节点的<code>/tmp/config.json</code>，并加入凭证到 <code>keycloak</code> 命名空间：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>keycloak<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>generic<span class="w"> </span>nexus-regcred<span class="w"> </span>--from-file<span class="o">=</span>.dockerconfigjson<span class="o">=</span>/tmp/config.json<span class="w"> </span>--type<span class="o">=</span>kubernetes.io/dockerconfigjson
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-2-ca">2. CA 证书添加<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-2-ca" title="Permanent link">&para;</a></h2>
<p>在 Nexus 虚拟机<code>192.168.100.12</code>上，获取 CA 证书<code>/etc/docker/certs.d/192.168.100.12:8082/ca.crt</code>，将其复制到所有 k8s 节点的<code>/etc/pki/ca-trust/source/anchors/nexus.crt</code>，并在所有节点更新证书：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>update-ca-trust
</span></code></pre></div></td></tr></table></div>
<p>之后还需要重启 containerd：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>systemctl<span class="w"> </span>restart<span class="w"> </span>containerd.service
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-3">3. 使用凭证拉取镜像<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-3" title="Permanent link">&para;</a></h2>
<p>在命名空间 <code>keycloak</code> 创建一个 pod，使用凭证 <code>nexus-regcred</code> 拉取镜像，新建文件<code>test-pod.yaml</code>：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">test-pod.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-__codelineno-4-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-__codelineno-4-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-__codelineno-4-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="nn">---</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-pod</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.100.12:8082/keycloak/keycloak:24.0</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">  </span><span class="nt">imagePullSecrets</span><span class="p">:</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nexus-regcred</span>
</span></code></pre></div></td></tr></table></div>
<p>创建 pod：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81-__codelineno-5-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>kubectl<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>test-pod.yaml
</span></code></pre></div></td></tr></table></div></section><section class="print-page" id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5" heading-number="2.1.7"><nav class='md-tags'><span class='md-tag'>Kubernetes</span></nav><h1 id="_1">禁用容器镜像垃圾回收并配置磁盘相关容器漂移策略<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-_1" title="Permanent link">&para;</a></h1>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-1-k8s">1. 在无镜像仓库的情况下使用 k8s 的问题<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-1-k8s" title="Permanent link">&para;</a></h2>
<p>k8s 默认有一个垃圾回收机制，而且容器的临时存储和容器的镜像存储都在/var 目录下，因此只要有/var 目录大于 85%的情况（无论是容器写临时文件还是/var 目录下生成了其它特别大的东西，还是导入容器镜像），k8s 就会把所有的容器赶走，同时会对容器镜像垃圾回收。但是，由于容器已经都被赶走了，垃圾回收会把这些容器镜像删掉，之后如果容器镜像是在节点手动导入而非从镜像仓库拉取，则会导致容器镜像永远丢失，节点/var 目录清理或扩容后，仍旧无法启动容器。因此需要把容器的存储位置单独挂盘，并且禁用容器镜像的垃圾回收。</p>
<p><strong>还是不推荐不搭建一个镜像仓库，因为这种方法一旦容器的目录真的满了，必须人工上去 ctr 命令删除容器</strong></p>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-2-kubelet">2. 修改 kubelet 配置<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-2-kubelet" title="Permanent link">&para;</a></h2>
<p>在<code>/var/lib/kubelet/config.yaml</code>中，配置 k8s 节点在容器临时文件存储低于 10% 时，赶走所有容器到其它节点，且容器镜像不使用 100 年后才清理：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nt">evictionHard</span><span class="p">:</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">  </span><span class="nt">imagefs.available</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10%&quot;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">nodefs.available</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;5%&quot;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="nt">imageGCHighThresholdPercent</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="nt">imageGCLowThresholdPercent</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">99</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="nt">imageMinimumGCAge</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">876000h</span>
</span></code></pre></div></td></tr></table></div>
<p>重启 kublet：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>systemctl<span class="w"> </span>restart<span class="w"> </span>kubelet.service
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-3-varlibcontainerd-lv">3. 将 /var/lib/containerd 单独挂载 lv，防止系统日志挤占容器空间<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-3-varlibcontainerd-lv" title="Permanent link">&para;</a></h2>
<h3 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-31-k8s">3.1 腾空一个 k8s 节点<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-31-k8s" title="Permanent link">&para;</a></h3>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-__codelineno-2-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>kubectl<span class="w"> </span>cordon<span class="w"> </span>z10bansk8scp02
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>kubectl<span class="w"> </span>drain<span class="w"> </span>z10bansk8scp02<span class="w"> </span>--ignore-daemonsets<span class="w"> </span>--delete-emptydir-data
</span></code></pre></div></td></tr></table></div>
<h3 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-32">3.2 清理数据<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-32" title="Permanent link">&para;</a></h3>
<p>停止 kubelet：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>systemctl<span class="w"> </span>stop<span class="w"> </span>kubelet.service
</span></code></pre></div></td></tr></table></div>
<p>删除所有容器：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-__codelineno-4-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">for</span><span class="w"> </span>i<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>ctr<span class="w"> </span>-n<span class="w"> </span>k8s.io<span class="w"> </span>task<span class="w"> </span>ls<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span><span class="p">;</span><span class="k">do</span><span class="w"> </span>ctr<span class="w"> </span>-n<span class="w"> </span>k8s.io<span class="w"> </span>task<span class="w"> </span><span class="nb">kill</span><span class="w"> </span><span class="nv">$i</span><span class="p">;</span><span class="k">done</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="k">for</span><span class="w"> </span>i<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>ctr<span class="w"> </span>-n<span class="w"> </span>k8s.io<span class="w"> </span>container<span class="w"> </span>ls<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span><span class="p">;</span><span class="k">do</span><span class="w"> </span>ctr<span class="w"> </span>-n<span class="w"> </span>k8s.io<span class="w"> </span>container<span class="w"> </span>delete<span class="w"> </span><span class="nv">$i</span><span class="p">;</span><span class="k">done</span>
</span></code></pre></div></td></tr></table></div>
<p>删除容器镜像：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-__codelineno-5-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>ctr<span class="w"> </span>-n<span class="w"> </span>k8s.io<span class="w"> </span>image<span class="w"> </span>prune<span class="w"> </span>--all
</span></code></pre></div></td></tr></table></div>
<p>停止 containerd 并清理 containerd 目录：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-__codelineno-6-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-__codelineno-6-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a>systemctl<span class="w"> </span>stop<span class="w"> </span>containerd
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a>rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/containerd/*
</span></code></pre></div></td></tr></table></div>
<p>将 containerd 镜像目录单独挂载 lv：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-__codelineno-7-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-__codelineno-7-2">2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-__codelineno-7-3">3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-__codelineno-7-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a>lvcreate<span class="w"> </span>-n<span class="w"> </span>lv_containerd<span class="w"> </span>-L<span class="w"> </span>30G<span class="w"> </span>rootvg
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a>mkfs.xfs<span class="w"> </span>/dev/rootvg/lv_containerd
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;/dev/rootvg/lv_containerd /var/lib/containerd xfs defaults 0 0&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/etc/fstab
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4"></a>mount<span class="w"> </span>-a
</span></code></pre></div></td></tr></table></div>
<p>启动 containerd 和 kubelet，并解除隔离状态：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-__codelineno-8-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-__codelineno-8-2">2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-__codelineno-8-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a>systemctl<span class="w"> </span>restart<span class="w"> </span>containerd
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a>systemctl<span class="w"> </span>restart<span class="w"> </span>kubelet.service
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a>kubectl<span class="w"> </span>uncordon<span class="w"> </span>z10bansk8scp02
</span></code></pre></div></td></tr></table></div>
<h3 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-33">3.3 重新导入容器镜像并检查：<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-33" title="Permanent link">&para;</a></h3>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-__codelineno-9-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-__codelineno-9-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="k">for</span><span class="w"> </span>i<span class="w"> </span><span class="k">in</span><span class="w"> </span>*<span class="p">;</span><span class="k">do</span><span class="w"> </span>ctr<span class="w"> </span>-n<span class="w"> </span>k8s.io<span class="w"> </span>image<span class="w"> </span>import<span class="w"> </span><span class="nv">$i</span><span class="w"> </span>--platform<span class="w"> </span>linux/amd64<span class="p">;</span><span class="k">done</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2"></a>ctr<span class="w"> </span>-n<span class="w"> </span>k8s.io<span class="w"> </span>images<span class="w"> </span>list<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span>^sha256<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $1}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>nl
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-4">4. 参考链接<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5-4" title="Permanent link">&para;</a></h2>
<p><a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/">https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/</a></p>
<p><a href="https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/">https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/</a></p>
<p><a href="https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/">https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/</a></p></section><section class="print-page" id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85" heading-number="2.1.8"><nav class='md-tags'><span class='md-tag'>Kubernetes</span><span class='md-tag'>local-path-provisioner</span></nav><h1 id="local-path-provisioner">local-path-provisioner 安装<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-local-path-provisioner" title="Permanent link">&para;</a></h1>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-1-kubernetes">1. 创建 kubernetes 相关资源<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-1-kubernetes" title="Permanent link">&para;</a></h2>
<p>下载 yaml 文件并应用：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>wget<span class="w"> </span>https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.26/deploy/local-path-storage.yaml
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>local-path-storage.yaml
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-2-local-path-provisioner">2. 创建 local-path-provisioner 目录<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-2-local-path-provisioner" title="Permanent link">&para;</a></h2>
<p>在所有节点，创建<code>/opt/local-path-provisioner</code>目录（建议对此目录单独建立逻辑卷</p>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-3-local-path-provisioner-storageclass">3. 将 local-path-provisioner 设置为默认 StorageClass<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-3-local-path-provisioner-storageclass" title="Permanent link">&para;</a></h2>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>kubectl<span class="w"> </span>patch<span class="w"> </span>storageclass<span class="w"> </span>local-path<span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;{&quot;metadata&quot;: {&quot;annotations&quot;:{&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;true&quot;}}}&#39;</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-4">4. 测试并验证<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-4" title="Permanent link">&para;</a></h2>
<p>创建 pvc 并测试，新建文件<code>test-pvc.yaml</code>：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-2-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>---
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>apiVersion: v1
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a>kind: PersistentVolumeClaim
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a>metadata:
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a>  name: test-pvc
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a>spec:
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a>  accessModes:
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a>    - ReadWriteOnce
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a>  resources:
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10"></a>    requests:
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11"></a>      storage: 1Gi
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12"></a>  storageClassName: local-path
</span></code></pre></div></td></tr></table></div>
<p>创建 pvc：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>kubectl apply -f test-pvc.yaml
</span></code></pre></div></td></tr></table></div>
<p>由于 VolumeBindingMode 设置成了 WaitForFirstConsumer，需要启动一个 pod 来使用 pvc，pv 才会被创建：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-12">12</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-13">13</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-14">14</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-15">15</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-16">16</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-17">17</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-18">18</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-19">19</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-20">20</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-21">21</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-22">22</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-23">23</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-24">24</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-25">25</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-26">26</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-27">27</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-28">28</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-29">29</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-30">30</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-31">31</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-32">32</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-4-33">33</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>kubectl<span class="w"> </span>run<span class="w"> </span>-i<span class="w"> </span>--rm<span class="w"> </span>--tty<span class="w"> </span>busybox<span class="w"> </span>--overrides<span class="o">=</span><span class="s1">&#39;</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="s1">{</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="s1">    &quot;apiVersion&quot;: &quot;v1&quot;,</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="s1">    &quot;spec&quot;: {</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="s1">        &quot;containers&quot;: [</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="s1">            {</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="s1">                &quot;name&quot;: &quot;busybox&quot;,</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="s1">                &quot;image&quot;: &quot;docker.io/rancher/busybox:1.31.1&quot;,</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="s1">                &quot;args&quot;: [</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="s1">                    &quot;sh&quot;</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="s1">                ],</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="s1">                &quot;stdin&quot;: true,</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="s1">                &quot;stdinOnce&quot;: true,</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="s1">                &quot;tty&quot;: true,</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="s1">                &quot;volumeMounts&quot;: [</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="s1">                    {</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="s1">                        &quot;mountPath&quot;: &quot;/home/store&quot;,</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="s1">                        &quot;name&quot;: &quot;store&quot;</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="s1">                    }</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="s1">                ]</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="s1">            }</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="s1">        ],</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="s1">        &quot;volumes&quot;: [</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24"></a><span class="s1">            {</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25"></a><span class="s1">                &quot;name&quot;: &quot;store&quot;,</span>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26"></a><span class="s1">                &quot;persistentVolumeClaim&quot;: {</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27"></a><span class="s1">                    &quot;claimName&quot;: &quot;test-pvc&quot;</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28"></a><span class="s1">                }</span>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29"></a><span class="s1">            }</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30"></a><span class="s1">        ]</span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31"></a><span class="s1">    }</span>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32"></a><span class="s1">}</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33"></a><span class="s1">&#39;</span><span class="w">  </span>--image<span class="o">=</span>busybox<span class="w"> </span>--restart<span class="o">=</span>Never<span class="w"> </span>--<span class="w"> </span>/bin/sh
</span></code></pre></div></td></tr></table></div>
<p>检查 pvc 为 Bound 状态：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-5-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>kubectl get pvc
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-6-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85-__codelineno-6-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a>NAME       STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS    VOLUMEATTRIBUTESCLASS   AGE
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a>test-pvc   Bound    pvc-9c92208e-cd5a-436a-a785-74b6dc00ae31   1Gi        RWX            csi-cephfs-sc   &lt;unset&gt;                 9m15s
</span></code></pre></div></td></tr></table></div></section><section class="print-page" id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9" heading-number="2.1.9"><nav class='md-tags'><span class='md-tag'>Kubernetes</span></nav><h1 id="master">扩容 master 节点<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-master" title="Permanent link">&para;</a></h1>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-1">1. 在已有的节点上生成加入节点的命令<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-1" title="Permanent link">&para;</a></h2>
<p>在已有的 master 节点生成证书和加入集群命令：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>kubeadm token create --print-join-command
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>kubeadm join cluster-endpoint:8443 --token 9igvk8.ptcn52v5d7g261ff --discovery-token-ca-cert-hash sha256:b25ba14968a69b71974b51ee5996d61c3ae1940afcea673500b3d5468d41a1ee
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>kubeadm init phase upload-certs --upload-certs
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-__codelineno-3-3">3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-__codelineno-3-4">4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-__codelineno-3-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>W0417 16:23:10.938672 3195210 version.go:104] could not fetch a Kubernetes version from the internet: unable to get URL &quot;https://dl.k8s.io/release/stable-1.txt&quot;: Get &quot;https://dl.k8s.io/release/stable-1.txt&quot;: dial tcp: lookup dl.k8s.io on 21.126.129.88:53: no such host
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>W0417 16:23:10.938728 3195210 version.go:105] falling back to the local client version: v1.29.2
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a>[upload-certs] Storing the certificates in Secret &quot;kubeadm-certs&quot; in the &quot;kube-system&quot; Namespace
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a>[upload-certs] Using certificate key:
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a>6147e16f74b590e74b53dd24e4e928dfeaf934c66229adb4036f6cbac792392a
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-2-k8s">2. 在新节点加入 K8S 集群<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-2-k8s" title="Permanent link">&para;</a></h2>
<p>在新节点上使用 kubeadm 命令加入集群，并作为 master 节点：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-__codelineno-4-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>kubeadm join cluster-endpoint:8443 --token 9igvk8.ptcn52v5d7g261ff --discovery-token-ca-cert-hash sha256:b25ba14968a69b71974b51ee5996d61c3ae1940afcea673500b3d5468d41a1ee --control-plane --certificate-key 6147e16f74b590e74b53dd24e4e928dfeaf934c66229adb4036f6cbac792392a
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-3-networkmanager-calico">3. 配置 NetworkManager 忽略 calico 网卡<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-3-networkmanager-calico" title="Permanent link">&para;</a></h2>
<p>如果 k8s 集群使用 calico 作为网络插件，还需要配置 NetworkManager 忽略 calico 网卡，可使用以下 playbook 批量配置：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-__codelineno-5-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-__codelineno-5-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-__codelineno-5-12">12</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-__codelineno-5-13">13</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-__codelineno-5-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nn">---</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">configure networkmanager for calico</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">create /etc/NetworkManager/conf.d/calico.conf</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">      </span><span class="nt">copy</span><span class="p">:</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">        </span><span class="nt">content</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">          </span><span class="no">[keyfile]</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">          </span><span class="no">unmanaged-devices=interface-name:cali*;interface-name:tunl*;interface-name:vxlan.calico;interface-name:vxlan-v6.calico;interface-name:wireguard.cali;interface-name:wg-v6.cali</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/NetworkManager/conf.d/calico.conf</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restart networkmanager</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">      </span><span class="nt">systemd</span><span class="p">:</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkManager</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restarted</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-4-bashrc">4. 修改 bashrc<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-4-bashrc" title="Permanent link">&para;</a></h2>
<p>修改 bashrc 使得默认 kubectl 命令连接此 k8s 集群：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-__codelineno-6-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9-__codelineno-6-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;export KUBECONFIG=/etc/kubernetes/admin.conf&#39;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/root/.bashrc
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="nb">source</span><span class="w"> </span>/root/.bashrc
</span></code></pre></div></td></tr></table></div></section><section class="print-page" id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k3s%e5%88%a0%e9%99%a4namespace%e5%8d%a1%e6%ad%bb%e5%9c%a8terminating%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95" heading-number="2.1.10"><nav class='md-tags'><span class='md-tag'>k3s</span></nav><h1 id="k3s-namespace-terminating">k3s 删除 namespace 卡死在 Terminating 解决方法<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k3s%e5%88%a0%e9%99%a4namespace%e5%8d%a1%e6%ad%bb%e5%9c%a8terminating%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-k3s-namespace-terminating" title="Permanent link">&para;</a></h1>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k3s%e5%88%a0%e9%99%a4namespace%e5%8d%a1%e6%ad%bb%e5%9c%a8terminating%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-1">1. 问题现象<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k3s%e5%88%a0%e9%99%a4namespace%e5%8d%a1%e6%ad%bb%e5%9c%a8terminating%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-1" title="Permanent link">&para;</a></h2>
<p>k3s 在删除 namespace 时，卡死，按 Ctrl-C 后发现 namespace 一直处于 Terminating 状态：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k3s%e5%88%a0%e9%99%a4namespace%e5%8d%a1%e6%ad%bb%e5%9c%a8terminating%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k3s%e5%88%a0%e9%99%a4namespace%e5%8d%a1%e6%ad%bb%e5%9c%a8terminating%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k3s%e5%88%a0%e9%99%a4namespace%e5%8d%a1%e6%ad%bb%e5%9c%a8terminating%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k3s%e5%88%a0%e9%99%a4namespace%e5%8d%a1%e6%ad%bb%e5%9c%a8terminating%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k3s%e5%88%a0%e9%99%a4namespace%e5%8d%a1%e6%ad%bb%e5%9c%a8terminating%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k3s%e5%88%a0%e9%99%a4namespace%e5%8d%a1%e6%ad%bb%e5%9c%a8terminating%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-0-6">6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k3s%e5%88%a0%e9%99%a4namespace%e5%8d%a1%e6%ad%bb%e5%9c%a8terminating%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-0-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>$ kubectl get ns
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>NAME              STATUS        AGE
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a>kube-system       Active        33d
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a>default           Active        33d
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a>kube-public       Active        33d
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a>kube-node-lease   Active        33d
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a>awx               Terminating   5d18h
</span></code></pre></div></td></tr></table></div>
<h%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k3s%e5%88%a0%e9%99%a4namespace%e5%8d%a1%e6%ad%bb%e5%9c%a8terminating%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k3s%e5%88%a0%e9%99%a4namespace%e5%8d%a1%e6%ad%bb%e5%9c%a8terminating%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-2">2. 解决方法<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k3s%e5%88%a0%e9%99%a4namespace%e5%8d%a1%e6%ad%bb%e5%9c%a8terminating%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-2" title="Permanent link">&para;</a></h2>
<p>用以下命令清理：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k3s%e5%88%a0%e9%99%a4namespace%e5%8d%a1%e6%ad%bb%e5%9c%a8terminating%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>NS=`kubectl get ns |grep Terminating | awk &#39;NR==1 {print $1}&#39;` &amp;&amp; kubectl get namespace &quot;$NS&quot; -o json   | tr -d &quot;\n&quot; | sed &quot;s/\&quot;finalizers\&quot;: \[[^]]\+\]/\&quot;finalizers\&quot;: []/&quot;   | kubectl replace --raw /api/v1/namespaces/$NS/finalize -f -
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k3s%e5%88%a0%e9%99%a4namespace%e5%8d%a1%e6%ad%bb%e5%9c%a8terminating%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-3">3. 参考文献<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k3s%e5%88%a0%e9%99%a4namespace%e5%8d%a1%e6%ad%bb%e5%9c%a8terminating%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-3" title="Permanent link">&para;</a></h2>
<p><a href="https://stackoverflow.com/questions/52369247/namespace-stucked-as-terminating-how-i-removed-it">https://stackoverflow.com/questions/52369247/namespace-stucked-as-terminating-how-i-removed-it</a></p></section><section class="print-page" id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k8s%e5%bc%80%e5%90%afswap%e6%94%af%e6%8c%81" heading-number="2.1.11"><h1 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k8s%e5%bc%80%e5%90%afswap%e6%94%af%e6%8c%81-k8s-swap">k8s 开启 swap 支持<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k8s%e5%bc%80%e5%90%afswap%e6%94%af%e6%8c%81-k8s-swap" title="Permanent link">&para;</a></h1>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k8s%e5%bc%80%e5%90%afswap%e6%94%af%e6%8c%81-1">1. 隔离并驱逐所有容器<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k8s%e5%bc%80%e5%90%afswap%e6%94%af%e6%8c%81-1" title="Permanent link">&para;</a></h2>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k8s%e5%bc%80%e5%90%afswap%e6%94%af%e6%8c%81-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k8s%e5%bc%80%e5%90%afswap%e6%94%af%e6%8c%81-__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>kubectl<span class="w"> </span>cordon<span class="w"> </span>awx-k8s-01
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>kubectl<span class="w"> </span>drain<span class="w"> </span>awx-k8s-01<span class="w"> </span>--ignore-daemonsets<span class="w"> </span>--delete-emptydir-data
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k8s%e5%bc%80%e5%90%afswap%e6%94%af%e6%8c%81-2-kubelet">2. 修改 kubelet 配置<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k8s%e5%bc%80%e5%90%afswap%e6%94%af%e6%8c%81-2-kubelet" title="Permanent link">&para;</a></h2>
<p>修改 <code>/var/lib/kubelet/config.yaml</code> ：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k8s%e5%bc%80%e5%90%afswap%e6%94%af%e6%8c%81-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nt">memorySwap</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
</span></code></pre></div></td></tr></table></div>
<p>修改为：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k8s%e5%bc%80%e5%90%afswap%e6%94%af%e6%8c%81-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k8s%e5%bc%80%e5%90%afswap%e6%94%af%e6%8c%81-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k8s%e5%bc%80%e5%90%afswap%e6%94%af%e6%8c%81-__codelineno-2-3">3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k8s%e5%bc%80%e5%90%afswap%e6%94%af%e6%8c%81-__codelineno-2-4">4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k8s%e5%bc%80%e5%90%afswap%e6%94%af%e6%8c%81-__codelineno-2-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nt">failSwapOn</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="nt">featureGates</span><span class="p">:</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">  </span><span class="nt">NodeSwap</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="nt">memorySwap</span><span class="p">:</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span><span class="nt">swapBehavior</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">UnlimitedSwap</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k8s%e5%bc%80%e5%90%afswap%e6%94%af%e6%8c%81-3-kubelet">3. 重启 kubelet<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k8s%e5%bc%80%e5%90%afswap%e6%94%af%e6%8c%81-3-kubelet" title="Permanent link">&para;</a></h2>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k8s%e5%bc%80%e5%90%afswap%e6%94%af%e6%8c%81-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k8s%e5%bc%80%e5%90%afswap%e6%94%af%e6%8c%81-__codelineno-3-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>systemctl<span class="w"> </span>restart<span class="w"> </span>kubelet
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>systemctl<span class="w"> </span>status<span class="w"> </span>kubelet
</span></code></pre></div></td></tr></table></div></section></section>
                    <section class='print-page md-section' id='section-2-2' heading-number='2.2'>
                        <h1>Docker&Podman<a class='headerlink' href='#section-2-2' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98" heading-number="2.2.1"><nav class='md-tags'><span class='md-tag'>Docker</span></nav><h1 id="dockerfile">Dockerfile 中不保留编译缓存<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-dockerfile" title="Permanent link">&para;</a></h1>
<p>在构建 OnlyOffice 的 Docker 镜像时，需要在 Dockerfile 里下载源代码并编译，但是源代码编译后，编译的缓存由 40GB，导致镜像最终由 44GB，但是实际有用的只是编译后的二进制文件。原先的 Dockerfile 如下：</p>
<div class="language-Dockerfile highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-0-19">19</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-0-20">20</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-0-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">FROM</span><span class="w"> </span><span class="s">ubuntu:20.04</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="k">ENV</span><span class="w"> </span><span class="nv">TZ</span><span class="o">=</span>Etc/UTC
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="k">RUN</span><span class="w"> </span>ln<span class="w"> </span>-snf<span class="w"> </span>/usr/share/zoneinfo/<span class="nv">$TZ</span><span class="w"> </span>/etc/localtime<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$TZ</span><span class="w"> </span>&gt;<span class="w"> </span>/etc/timezone
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>-y<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span>apt-get<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>python2<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">                       </span>python3<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">                       </span>sudo<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">                       </span>git<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">                       </span>postgresql<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">                       </span>rabbitmq-server<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">                       </span>nginx
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="k">RUN</span><span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/usr/bin/python2<span class="w"> </span>/usr/bin/python
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/build</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16"></a>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="k">RUN</span><span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/ONLYOFFICE/build_tools.git
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="k">RUN</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>/build/build_tools/tools/linux<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>./automate.py<span class="w"> </span>server
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="k">RUN</span><span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s/exports.LICENSE_CONNECTIONS = 20;/exports.LICENSE_CONNECTIONS = 99999;/&#39;</span><span class="w"> </span>/build/server/Common/sources/constants.js
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="k">RUN</span><span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s/&quot;--update&quot;, &quot;1&quot;/&quot;--update&quot;, &quot;0&quot;/&#39;</span><span class="w"> </span>/build/build_tools/tools/linux/automate.py
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="k">RUN</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>/build/build_tools/tools/linux<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>./automate.py<span class="w"> </span>server
</span></code></pre></div></td></tr></table></div>
<p>这个 Dockerfile 构建出的镜像中，只有 <code>/build/build_tools/out/linux_64/onlyoffice/documentserver</code> 中的文件有用，其它文件没有用。如果尝试在 Dockerfile 中将其 <code>rm -rf</code> 掉，会不起作用。因为写入 image layer 的东西是删不掉的。这时候就需要使用 Dockerfile 的多阶段构建：</p>
<div class="language-Dockerfile highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-23">23</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-24">24</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-25">25</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-26">26</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-1-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">FROM</span><span class="w"> </span><span class="s">ubuntu:20.04</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="k">ENV</span><span class="w"> </span><span class="nv">TZ</span><span class="o">=</span>Etc/UTC
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="k">RUN</span><span class="w"> </span>ln<span class="w"> </span>-snf<span class="w"> </span>/usr/share/zoneinfo/<span class="nv">$TZ</span><span class="w"> </span>/etc/localtime<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$TZ</span><span class="w"> </span>&gt;<span class="w"> </span>/etc/timezone
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>-y<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">    </span>apt-get<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>python2<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">                       </span>python3<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">                       </span>sudo<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">                       </span>git<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">                       </span>postgresql<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">                       </span>rabbitmq-server<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">                       </span>nginx
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="k">RUN</span><span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/usr/bin/python2<span class="w"> </span>/usr/bin/python
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/build</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16"></a>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="k">RUN</span><span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/ONLYOFFICE/build_tools.git
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="k">RUN</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>/build/build_tools/tools/linux<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>./automate.py<span class="w"> </span>server
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="k">RUN</span><span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s/exports.LICENSE_CONNECTIONS = 20;/exports.LICENSE_CONNECTIONS = 99999;/&#39;</span><span class="w"> </span>/build/server/Common/sources/constants.js
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="k">RUN</span><span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s/&quot;--update&quot;, &quot;1&quot;/&quot;--update&quot;, &quot;0&quot;/&#39;</span><span class="w"> </span>/build/build_tools/tools/linux/automate.py
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="k">RUN</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>/build/build_tools/tools/linux<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>./automate.py<span class="w"> </span>server
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22"></a>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="k">FROM</span><span class="w"> </span><span class="s">ubuntu:20.04</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span><span class="m">0</span><span class="w"> </span>/build/build_tools/out/linux_64/onlyoffice/documentserver<span class="w"> </span>/var/www/html/
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>-y<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>nginx
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26"></a>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="k">CMD</span><span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;while true;do sleep 3600;done&#39;</span>
</span></code></pre></div></td></tr></table></div>
<p>即先构建一个编译镜像，然后把编译镜像里生成的有用的东西复制到第二个镜像，再构建第二个镜像。</p>
<p>同时，编译完成以后，还需要清理 docker 的 overlay2 里的缓存等其它缓存：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>docker system prune -a
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-1">1. 参考链接<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98-1" title="Permanent link">&para;</a></h2>
<p><a href="https://docs.docker.com/build/building/multi-stage/">https://docs.docker.com/build/building/multi-stage/</a></p></section><section class="print-page" id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0" heading-number="2.2.2"><nav class='md-tags'><span class='md-tag'>Podman</span><span class='md-tag'>Tetragon</span><span class='md-tag'>eBPF</span></nav><h1 id="ebpf">基于 eBPF 的容器审计技术的实现<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-ebpf" title="Permanent link">&para;</a></h1>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-1">1. 项目需求<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-1" title="Permanent link">&para;</a></h2>
<p>某项目需要监视运行在 podman 宿主机内容器中所有文件的修改和系统调用，作为审计日志。日志中至少需要包含执行命令的容器、命令内容或修改的文件。</p>
<p>使用 auditd 无法实现此需求，因为容器内 auditd 无法启动，audit 依赖于内核 kaudit 进程，其工作方式为内核态 kauditd 在系统调用层记录日志，把日志放入一个 netlink 套接字中，用户态 auditd 进程监听这个套接字，将日志转储到系统日志或日志文件中。且一个机器上只要有一个容器或者宿主机开启 auditd ，其它容器或宿主机都无法再次启动 auditd 。</p>
<p>而且， auditd 不支持 namespace ，不可能知道是那个容器里执行了什么命令。因此解决这个方法需要使用 eBPF 内核探针。</p>
<p>此方案在 RHEL8 内核版本 <code>4.18.0-553.el8_10</code> ， podman 版本 <code>4.9.4-rhel</code> 上测试通过。</p>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-2-tetragon">2. 云原生方案下的容器审计工具 Tetragon<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-2-tetragon" title="Permanent link">&para;</a></h2>
<p>Tetragon 是一个应用于 k8s 、 docker 等容器环境下的审计工具，它依赖于 eBPF 技术，以容器的方式运行，通过 eBPF 的 kprobe 设立 hook 的方式完成对一个容器宿主机上所有容器的命令执行与文件修改、甚至网络连接的审计。本次方案在 podman 容器宿主机上使用此方案实现。</p>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-3-tetragon">3. 运行 Tetragon 容器<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-3-tetragon" title="Permanent link">&para;</a></h2>
<p>首先新建文件审计配置文件 <code>file_monitoring.yaml</code> ：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-19">19</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-20">20</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-21">21</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-22">22</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-23">23</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-24">24</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-25">25</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-26">26</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-27">27</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-28">28</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-29">29</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-30">30</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-31">31</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-32">32</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-33">33</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-34">34</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-35">35</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-36">36</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-37">37</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-38">38</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-39">39</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-40">40</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-41">41</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-42">42</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-43">43</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-44">44</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-45">45</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-46">46</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-47">47</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-48">48</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-49">49</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-50">50</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-51">51</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-52">52</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-53">53</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-54">54</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-55">55</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-56">56</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-57">57</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-58">58</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-59">59</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-60">60</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-61">61</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-62">62</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-63">63</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-64">64</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-65">65</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-66">66</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-67">67</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-68">68</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-69">69</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-70">70</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-71">71</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-72">72</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-73">73</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-74">74</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-75">75</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-76">76</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-77">77</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-78">78</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-79">79</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-80">80</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-81">81</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-82">82</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-83">83</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-84">84</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-85">85</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-86">86</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-87">87</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-88">88</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-89">89</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-90">90</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-91">91</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-92">92</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-93">93</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-94">94</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-95">95</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-96">96</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-97">97</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-0-98">98</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cilium.io/v1alpha1</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TracingPolicy</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;file-monitoring-filtered&quot;</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">  </span><span class="nt">kprobes</span><span class="p">:</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">call</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;security_file_permission&quot;</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">      </span><span class="nt">syscall</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">      </span><span class="nt">return</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">      </span><span class="nt">args</span><span class="p">:</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">index</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;file&quot;</span><span class="w"> </span><span class="c1"># (struct file *) used for getting the path</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">index</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="w"> </span><span class="c1"># 0x04 is MAY_READ, 0x02 is MAY_WRITE</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">      </span><span class="nt">returnArg</span><span class="p">:</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">        </span><span class="nt">index</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;int&quot;</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">      </span><span class="nt">returnArgAction</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Post&quot;</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">      </span><span class="nt">selectors</span><span class="p">:</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matchArgs</span><span class="p">:</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">index</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">              </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;NotPrefix&quot;</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">              </span><span class="nt">values</span><span class="p">:</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;/dev/&quot;</span><span class="w"> </span><span class="c1"># Reads to sensitive directories</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;/proc/&quot;</span><span class="w"> </span><span class="c1"># Reads to sensitive directories</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;/var/log/tetragon/tetragon.log&quot;</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">index</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="w">              </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Equal&quot;</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="w">              </span><span class="nt">values</span><span class="p">:</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;4&quot;</span><span class="w"> </span><span class="c1"># MAY_READ</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matchArgs</span><span class="p">:</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">index</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="w">              </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;NotPrefix&quot;</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="w">              </span><span class="nt">values</span><span class="p">:</span>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;/dev&quot;</span><span class="w"> </span><span class="c1"># Writes to sensitive directories</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;/proc/&quot;</span><span class="w"> </span><span class="c1"># Reads to sensitive directories</span>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;/var/log/tetragon/tetragon.log&quot;</span>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">index</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="w">              </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Equal&quot;</span>
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="w">              </span><span class="nt">values</span><span class="p">:</span>
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;2&quot;</span><span class="w"> </span><span class="c1"># MAY_WRITE</span>
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">call</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;security_mmap_file&quot;</span>
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="w">      </span><span class="nt">syscall</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</span><span id="__span-0-44"><a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="w">      </span><span class="nt">return</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-0-45"><a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="w">      </span><span class="nt">args</span><span class="p">:</span>
</span><span id="__span-0-46"><a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">index</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-0-47"><a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;file&quot;</span><span class="w"> </span><span class="c1"># (struct file *) used for getting the path</span>
</span><span id="__span-0-48"><a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">index</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-0-49"><a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;uint32&quot;</span><span class="w"> </span><span class="c1"># the prot flags PROT_READ(0x01), PROT_WRITE(0x02), PROT_EXEC(0x04)</span>
</span><span id="__span-0-50"><a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">index</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</span><span id="__span-0-51"><a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;uint32&quot;</span><span class="w"> </span><span class="c1"># the mmap flags (i.e. MAP_SHARED, ...)</span>
</span><span id="__span-0-52"><a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="w">      </span><span class="nt">returnArg</span><span class="p">:</span>
</span><span id="__span-0-53"><a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="w">        </span><span class="nt">index</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-0-54"><a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;int&quot;</span>
</span><span id="__span-0-55"><a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="w">      </span><span class="nt">returnArgAction</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Post&quot;</span>
</span><span id="__span-0-56"><a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="w">      </span><span class="nt">selectors</span><span class="p">:</span>
</span><span id="__span-0-57"><a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matchArgs</span><span class="p">:</span>
</span><span id="__span-0-58"><a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">index</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-0-59"><a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="w">              </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Prefix&quot;</span>
</span><span id="__span-0-60"><a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="w">              </span><span class="nt">values</span><span class="p">:</span>
</span><span id="__span-0-61"><a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="w"> </span><span class="c1"># Reads to sensitive directories</span>
</span><span id="__span-0-62"><a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">index</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-0-63"><a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="w">              </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Equal&quot;</span>
</span><span id="__span-0-64"><a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="w">              </span><span class="nt">values</span><span class="p">:</span>
</span><span id="__span-0-65"><a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="c1"># MAY_READ</span>
</span><span id="__span-0-66"><a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">index</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</span><span id="__span-0-67"><a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="w">              </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Mask&quot;</span>
</span><span id="__span-0-68"><a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="w">              </span><span class="nt">values</span><span class="p">:</span>
</span><span id="__span-0-69"><a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="c1"># MAP_SHARED</span>
</span><span id="__span-0-70"><a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matchArgs</span><span class="p">:</span>
</span><span id="__span-0-71"><a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">index</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-0-72"><a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="w">              </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Prefix&quot;</span>
</span><span id="__span-0-73"><a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="w">              </span><span class="nt">values</span><span class="p">:</span>
</span><span id="__span-0-74"><a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="w"> </span><span class="c1"># Writes to sensitive directories</span>
</span><span id="__span-0-75"><a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">index</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-0-76"><a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="w">              </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Mask&quot;</span>
</span><span id="__span-0-77"><a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="w">              </span><span class="nt">values</span><span class="p">:</span>
</span><span id="__span-0-78"><a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;2&quot;</span><span class="w"> </span><span class="c1"># PROT_WRITE</span>
</span><span id="__span-0-79"><a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">index</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</span><span id="__span-0-80"><a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="w">              </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Mask&quot;</span>
</span><span id="__span-0-81"><a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="w">              </span><span class="nt">values</span><span class="p">:</span>
</span><span id="__span-0-82"><a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="c1"># MAP_SHARED</span>
</span><span id="__span-0-83"><a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">call</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;security_path_truncate&quot;</span>
</span><span id="__span-0-84"><a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="w">      </span><span class="nt">syscall</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</span><span id="__span-0-85"><a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="w">      </span><span class="nt">return</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-0-86"><a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="w">      </span><span class="nt">args</span><span class="p">:</span>
</span><span id="__span-0-87"><a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">index</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-0-88"><a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;path&quot;</span><span class="w"> </span><span class="c1"># (struct path *) used for getting the path</span>
</span><span id="__span-0-89"><a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="w">      </span><span class="nt">returnArg</span><span class="p">:</span>
</span><span id="__span-0-90"><a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="w">        </span><span class="nt">index</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-0-91"><a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;int&quot;</span>
</span><span id="__span-0-92"><a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="w">      </span><span class="nt">returnArgAction</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Post&quot;</span>
</span><span id="__span-0-93"><a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="w">      </span><span class="nt">selectors</span><span class="p">:</span>
</span><span id="__span-0-94"><a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matchArgs</span><span class="p">:</span>
</span><span id="__span-0-95"><a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">index</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-0-96"><a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="w">              </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Prefix&quot;</span>
</span><span id="__span-0-97"><a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="w">              </span><span class="nt">values</span><span class="p">:</span>
</span><span id="__span-0-98"><a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="w"> </span><span class="c1"># Truncate to sensitive directories</span>
</span></code></pre></div></td></tr></table></div>
<p>注意，实际使用中，需要对此配置文件进行调整。此配置文件审计所有文件，日志量极大。新建日志存储路径配置 <code>export-filename</code> :</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>/var/log/tetragon/tetragon.log
</span></code></pre></div></td></tr></table></div>
<p>之后启动 Tetragon 容器：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-2-3">3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-2-4">4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-2-5">5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-2-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>podman run -d --rm --name tetragon-container --rm \
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>  --pid=host --cgroupns=host --privileged \
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a>  -v /sys/kernel/btf/vmlinux:/var/lib/tetragon/btf \
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a>  -v ${PWD}/file_monitoring.yaml:/etc/tetragon/tetragon.tp.d/file_monitoring.yaml \
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a>  -v ${PWD}/export-filename:/etc/tetragon/tetragon.conf.d/export-filename \
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a>  quay.io/cilium/tetragon-ci:latest
</span></code></pre></div></td></tr></table></div>
<p>如果想查看实时审计日志：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>podman exec tetragon-container tetra getevents -o json
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-4">4. 测试审计结果<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-4" title="Permanent link">&para;</a></h2>
<p>运行一个临时的 ubuntu 容器：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-4-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>podman run -it --rm ubuntu /bin/bash
</span></code></pre></div></td></tr></table></div>
<p>之后在容器内部，运行命令：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-5-2">2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-5-3">3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-5-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>useradd testuser
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a>cat /etc/shadow
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a>echo &quot;Hello, world!&quot; &gt; /tmp/passwd
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a>exit
</span></code></pre></div></td></tr></table></div>
<p>之后进入 Tetragon 容器：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-6-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a>podman exec -it tetragon-container /bin/bash
</span></code></pre></div></td></tr></table></div>
<p>查看审计日志：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-7-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a>grep /tmp/passwd -rni /var/log/tetragon
</span></code></pre></div></td></tr></table></div>
<p>找到审计日志如下：</p>
<div class="language-json highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-12">12</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-13">13</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-14">14</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-15">15</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-16">16</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-17">17</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-18">18</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-19">19</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-20">20</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-21">21</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-22">22</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-23">23</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-24">24</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-25">25</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-26">26</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-27">27</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-28">28</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-29">29</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-30">30</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-31">31</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-32">32</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-33">33</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-8-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="p">{</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="w">  </span><span class="nt">&quot;process_exit&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">    </span><span class="nt">&quot;process&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">      </span><span class="nt">&quot;exec_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;OGJiZjEyNWNmNGI3OjI3NzM2NDExODc3ODU0Njg6NTc2NjY0&quot;</span><span class="p">,</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">      </span><span class="nt">&quot;pid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">576664</span><span class="p">,</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">      </span><span class="nt">&quot;uid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="w">      </span><span class="nt">&quot;cwd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/&quot;</span><span class="p">,</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">      </span><span class="nt">&quot;binary&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/usr/sbin/useradd&quot;</span><span class="p">,</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">      </span><span class="nt">&quot;arguments&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;testuser&quot;</span><span class="p">,</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="w">      </span><span class="nt">&quot;flags&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;execve rootcwd clone&quot;</span><span class="p">,</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="w">      </span><span class="nt">&quot;start_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2024-06-27T06:06:07.223409055Z&quot;</span><span class="p">,</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="w">      </span><span class="nt">&quot;auid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="w">      </span><span class="nt">&quot;docker&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;89052e071b4ae7de344adf937794275&quot;</span><span class="p">,</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14"></a><span class="w">      </span><span class="nt">&quot;parent_exec_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;OGJiZjEyNWNmNGI3OjI3NzM2MzU4NzIxMjg2MTI6NTc2NjUy&quot;</span><span class="p">,</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15"></a><span class="w">      </span><span class="nt">&quot;tid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">576664</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17"></a><span class="w">    </span><span class="nt">&quot;parent&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18"></a><span class="w">      </span><span class="nt">&quot;exec_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;OGJiZjEyNWNmNGI3OjI3NzM2MzU4NzIxMjg2MTI6NTc2NjUy&quot;</span><span class="p">,</span>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19"></a><span class="w">      </span><span class="nt">&quot;pid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">576652</span><span class="p">,</span>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20"></a><span class="w">      </span><span class="nt">&quot;uid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21"></a><span class="w">      </span><span class="nt">&quot;cwd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/&quot;</span><span class="p">,</span>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22"></a><span class="w">      </span><span class="nt">&quot;binary&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/bin/bash&quot;</span><span class="p">,</span>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23"></a><span class="w">      </span><span class="nt">&quot;flags&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;execve rootcwd clone&quot;</span><span class="p">,</span>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24"></a><span class="w">      </span><span class="nt">&quot;start_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2024-06-27T06:06:01.907752059Z&quot;</span><span class="p">,</span>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25"></a><span class="w">      </span><span class="nt">&quot;auid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26"></a><span class="w">      </span><span class="nt">&quot;docker&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;89052e071b4ae7de344adf937794275&quot;</span><span class="p">,</span>
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27"></a><span class="w">      </span><span class="nt">&quot;parent_exec_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;OGJiZjEyNWNmNGI3OjI3NzM2MzU3NTQxODkyNTg6NTc2NjQy&quot;</span><span class="p">,</span>
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28"></a><span class="w">      </span><span class="nt">&quot;tid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">576652</span>
</span><span id="__span-8-29"><a id="__codelineno-8-29" name="__codelineno-8-29"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-8-30"><a id="__codelineno-8-30" name="__codelineno-8-30"></a><span class="w">    </span><span class="nt">&quot;time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2024-06-27T06:06:07.248861466Z&quot;</span>
</span><span id="__span-8-31"><a id="__codelineno-8-31" name="__codelineno-8-31"></a><span class="w">  </span><span class="p">},</span>
</span><span id="__span-8-32"><a id="__codelineno-8-32" name="__codelineno-8-32"></a><span class="w">  </span><span class="nt">&quot;node_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;8bbf125cf4b7&quot;</span><span class="p">,</span>
</span><span id="__span-8-33"><a id="__codelineno-8-33" name="__codelineno-8-33"></a><span class="w">  </span><span class="nt">&quot;time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2024-06-27T06:06:07.248861562Z&quot;</span>
</span><span id="__span-8-34"><a id="__codelineno-8-34" name="__codelineno-8-34"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-json highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-12">12</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-13">13</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-14">14</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-15">15</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-16">16</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-17">17</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-18">18</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-19">19</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-20">20</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-21">21</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-22">22</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-23">23</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-24">24</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-25">25</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-26">26</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-27">27</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-28">28</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-29">29</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-30">30</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-31">31</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-32">32</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-33">33</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-34">34</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-35">35</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-36">36</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-37">37</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-38">38</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-39">39</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-40">40</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-41">41</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-42">42</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-9-43">43</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="p">{</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w">  </span><span class="nt">&quot;process_kprobe&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">    </span><span class="nt">&quot;process&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">      </span><span class="nt">&quot;exec_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;OGJiZjEyNWNmNGI3OjI3NzM2NDEyMTM3ODA4ODc6NTc2Njcx&quot;</span><span class="p">,</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">      </span><span class="nt">&quot;pid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">576671</span><span class="p">,</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">      </span><span class="nt">&quot;uid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="w">      </span><span class="nt">&quot;cwd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/&quot;</span><span class="p">,</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="w">      </span><span class="nt">&quot;binary&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/usr/bin/cat&quot;</span><span class="p">,</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="w">      </span><span class="nt">&quot;arguments&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/etc/shadow&quot;</span><span class="p">,</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="w">      </span><span class="nt">&quot;flags&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;execve rootcwd clone&quot;</span><span class="p">,</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="w">      </span><span class="nt">&quot;start_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2024-06-27T06:06:07.249404483Z&quot;</span><span class="p">,</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="w">      </span><span class="nt">&quot;auid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="w">      </span><span class="nt">&quot;docker&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;89052e071b4ae7de344adf937794275&quot;</span><span class="p">,</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="w">      </span><span class="nt">&quot;parent_exec_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;OGJiZjEyNWNmNGI3OjI3NzM2MzU4NzIxMjg2MTI6NTc2NjUy&quot;</span><span class="p">,</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="w">      </span><span class="nt">&quot;refcnt&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="w">      </span><span class="nt">&quot;tid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">576671</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="w">    </span><span class="nt">&quot;parent&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19"></a><span class="w">      </span><span class="nt">&quot;exec_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;OGJiZjEyNWNmNGI3OjI3NzM2MzU4NzIxMjg2MTI6NTc2NjUy&quot;</span><span class="p">,</span>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="w">      </span><span class="nt">&quot;pid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">576652</span><span class="p">,</span>
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21"></a><span class="w">      </span><span class="nt">&quot;uid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22"></a><span class="w">      </span><span class="nt">&quot;cwd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/&quot;</span><span class="p">,</span>
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23"></a><span class="w">      </span><span class="nt">&quot;binary&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/bin/bash&quot;</span><span class="p">,</span>
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24"></a><span class="w">      </span><span class="nt">&quot;flags&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;execve rootcwd clone&quot;</span><span class="p">,</span>
</span><span id="__span-9-25"><a id="__codelineno-9-25" name="__codelineno-9-25"></a><span class="w">      </span><span class="nt">&quot;start_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2024-06-27T06:06:01.907752059Z&quot;</span><span class="p">,</span>
</span><span id="__span-9-26"><a id="__codelineno-9-26" name="__codelineno-9-26"></a><span class="w">      </span><span class="nt">&quot;auid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-9-27"><a id="__codelineno-9-27" name="__codelineno-9-27"></a><span class="w">      </span><span class="nt">&quot;docker&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;89052e071b4ae7de344adf937794275&quot;</span><span class="p">,</span>
</span><span id="__span-9-28"><a id="__codelineno-9-28" name="__codelineno-9-28"></a><span class="w">      </span><span class="nt">&quot;parent_exec_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;OGJiZjEyNWNmNGI3OjI3NzM2MzU3NTQxODkyNTg6NTc2NjQy&quot;</span><span class="p">,</span>
</span><span id="__span-9-29"><a id="__codelineno-9-29" name="__codelineno-9-29"></a><span class="w">      </span><span class="nt">&quot;tid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">576652</span>
</span><span id="__span-9-30"><a id="__codelineno-9-30" name="__codelineno-9-30"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-9-31"><a id="__codelineno-9-31" name="__codelineno-9-31"></a><span class="w">    </span><span class="nt">&quot;function_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;security_file_permission&quot;</span><span class="p">,</span>
</span><span id="__span-9-32"><a id="__codelineno-9-32" name="__codelineno-9-32"></a><span class="w">    </span><span class="nt">&quot;args&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-9-33"><a id="__codelineno-9-33" name="__codelineno-9-33"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;file_arg&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/etc/shadow&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;permission&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;-rw-r-----&quot;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-9-34"><a id="__codelineno-9-34" name="__codelineno-9-34"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;int_arg&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-9-35"><a id="__codelineno-9-35" name="__codelineno-9-35"></a><span class="w">    </span><span class="p">],</span>
</span><span id="__span-9-36"><a id="__codelineno-9-36" name="__codelineno-9-36"></a><span class="w">    </span><span class="nt">&quot;return&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;int_arg&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-9-37"><a id="__codelineno-9-37" name="__codelineno-9-37"></a><span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;KPROBE_ACTION_POST&quot;</span><span class="p">,</span>
</span><span id="__span-9-38"><a id="__codelineno-9-38" name="__codelineno-9-38"></a><span class="w">    </span><span class="nt">&quot;policy_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;file-monitoring-filtered&quot;</span><span class="p">,</span>
</span><span id="__span-9-39"><a id="__codelineno-9-39" name="__codelineno-9-39"></a><span class="w">    </span><span class="nt">&quot;return_action&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;KPROBE_ACTION_POST&quot;</span>
</span><span id="__span-9-40"><a id="__codelineno-9-40" name="__codelineno-9-40"></a><span class="w">  </span><span class="p">},</span>
</span><span id="__span-9-41"><a id="__codelineno-9-41" name="__codelineno-9-41"></a><span class="w">  </span><span class="nt">&quot;node_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;8bbf125cf4b7&quot;</span><span class="p">,</span>
</span><span id="__span-9-42"><a id="__codelineno-9-42" name="__codelineno-9-42"></a><span class="w">  </span><span class="nt">&quot;time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2024-06-27T06:06:07.249857560Z&quot;</span>
</span><span id="__span-9-43"><a id="__codelineno-9-43" name="__codelineno-9-43"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-json highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-10">10</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-11">11</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-12">12</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-13">13</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-14">14</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-15">15</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-16">16</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-17">17</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-18">18</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-19">19</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-20">20</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-21">21</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-22">22</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-23">23</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-24">24</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-25">25</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-26">26</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-27">27</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-28">28</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-29">29</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-30">30</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-31">31</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-32">32</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-33">33</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-34">34</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-35">35</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-36">36</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-37">37</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-38">38</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-39">39</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-40">40</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-41">41</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-42">42</a></span>
<span class="normal"><a href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-__codelineno-10-43">43</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="p">{</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">  </span><span class="nt">&quot;process_kprobe&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">    </span><span class="nt">&quot;process&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">      </span><span class="nt">&quot;exec_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;OGJiZjEyNWNmNGI3OjI3NzM2MzU4NzIxMjg2MTI6NTc2NjUy&quot;</span><span class="p">,</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="w">      </span><span class="nt">&quot;pid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">576652</span><span class="p">,</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">      </span><span class="nt">&quot;uid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="w">      </span><span class="nt">&quot;cwd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/&quot;</span><span class="p">,</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="w">      </span><span class="nt">&quot;binary&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/bin/bash&quot;</span><span class="p">,</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="w">      </span><span class="nt">&quot;flags&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;execve rootcwd clone&quot;</span><span class="p">,</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="w">      </span><span class="nt">&quot;start_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2024-06-27T06:06:01.907752059Z&quot;</span><span class="p">,</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11"></a><span class="w">      </span><span class="nt">&quot;auid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="w">      </span><span class="nt">&quot;docker&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;89052e071b4ae7de344adf937794275&quot;</span><span class="p">,</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="w">      </span><span class="nt">&quot;parent_exec_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;OGJiZjEyNWNmNGI3OjI3NzM2MzU3NTQxODkyNTg6NTc2NjQy&quot;</span><span class="p">,</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14"></a><span class="w">      </span><span class="nt">&quot;refcnt&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15"></a><span class="w">      </span><span class="nt">&quot;tid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">576652</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17"></a><span class="w">    </span><span class="nt">&quot;parent&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18"></a><span class="w">      </span><span class="nt">&quot;exec_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;OGJiZjEyNWNmNGI3OjI3NzM2MzU3NTQxODkyNTg6NTc2NjQy&quot;</span><span class="p">,</span>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19"></a><span class="w">      </span><span class="nt">&quot;pid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">576642</span><span class="p">,</span>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20"></a><span class="w">      </span><span class="nt">&quot;uid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21"></a><span class="w">      </span><span class="nt">&quot;cwd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/tmp&quot;</span><span class="p">,</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22"></a><span class="w">      </span><span class="nt">&quot;binary&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/usr/bin/conmon&quot;</span><span class="p">,</span>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23"></a><span class="w">      </span><span class="nt">&quot;arguments&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;--api-version 1 -c 89052e071b4ae7de344adf937794275ccdb977e9d4aa1d68a9fdb5cc63959048 -u 89052e071b4ae7de344adf937794275ccdb977e9d4aa1d68a9fdb5cc63959048 -r /usr/bin/runc -b /var/lib/containers/storage/overlay-containers/89052e071b4ae7de344adf937794275ccdb977e9d4aa1d68a9fdb5cc63959048/userdata -p /run/containers/storage/overlay-containers/89052e071b4ae7de344adf937794275ccdb977e9d4aa1d68a9fdb5cc63959048/userdata/pidfile -n angry_wozniak --exit-dir /run/libpod/exits --full-attach -s -l k8s-file:/var/lib/containers/storage/overlay-containers/89052e071b4ae7de344adf937794275ccdb977e9d4aa1d68a9fdb5cc63959048/userdata/ctr.log --log-level warning --syslog --runtime-arg --log-format=json --runtime-arg --log --runtime-arg=/run/containers/storage/overlay-containers/89052e071b4ae7de344adf937794275ccdb977e9d4aa1d68a9fdb5cc63959048/userdata/oci-log -t --conmon-pidfile /run/containers/storage/overlay-containers/89052e071b4ae7de344adf937794275ccdb977e9d4aa1d68a9fdb5cc63959048/userdata/conmon.pid --exit-command /usr/bin/podman --exit-command-arg --root --exit-command-arg /var/lib/containers/storage --exit-command-arg --runroot --exit-command-arg /run/containers/storage --exit-command-arg --log-level --exit-command-arg warning --exit-command-arg --cgroup-manager --exit-command-arg systemd --exit-command-arg --tmpdir --exit-command-arg /run/libpod --exit-command-arg --network-config-dir --exit-command-arg  --exit-command-arg --network-backend --exit-command-arg cni --exit-command-arg --volumepath --exit-command-arg /var/lib/containers/storage/volumes --exit-command-arg --db-backend --exit-command-arg sqlite --exit-command-arg --transient-store=false --exit-command-arg --runtime --exit-command-arg runc --exit-command-arg --storage-driver --exit-command-arg overlay --exit-command-arg --storage-opt --exit-command-arg overlay.mountopt=nodev,metacopy=on --exit-command-arg --events-backend --exit-command-arg file --exit-command-arg container --exit-command-arg cleanup --exit-command-arg --rm --exit-command-arg 89052e071b4ae7de344adf937794275ccdb977e9d4aa1d68a9fdb5cc63959048&quot;</span><span class="p">,</span>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24"></a><span class="w">      </span><span class="nt">&quot;flags&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;execve&quot;</span><span class="p">,</span>
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25"></a><span class="w">      </span><span class="nt">&quot;start_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2024-06-27T06:06:01.789813045Z&quot;</span><span class="p">,</span>
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26"></a><span class="w">      </span><span class="nt">&quot;auid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27"></a><span class="w">      </span><span class="nt">&quot;parent_exec_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;OGJiZjEyNWNmNGI3OjI3NzM2MzU3NDM1NTE5NDM6NTc2NjQx&quot;</span><span class="p">,</span>
</span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28"></a><span class="w">      </span><span class="nt">&quot;refcnt&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-10-29"><a id="__codelineno-10-29" name="__codelineno-10-29"></a><span class="w">      </span><span class="nt">&quot;tid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">576642</span>
</span><span id="__span-10-30"><a id="__codelineno-10-30" name="__codelineno-10-30"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-10-31"><a id="__codelineno-10-31" name="__codelineno-10-31"></a><span class="w">    </span><span class="nt">&quot;function_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;security_file_permission&quot;</span><span class="p">,</span>
</span><span id="__span-10-32"><a id="__codelineno-10-32" name="__codelineno-10-32"></a><span class="w">    </span><span class="nt">&quot;args&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-10-33"><a id="__codelineno-10-33" name="__codelineno-10-33"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;file_arg&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/tmp/passwd&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;permission&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;-rw-r--r--&quot;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-10-34"><a id="__codelineno-10-34" name="__codelineno-10-34"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;int_arg&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-10-35"><a id="__codelineno-10-35" name="__codelineno-10-35"></a><span class="w">    </span><span class="p">],</span>
</span><span id="__span-10-36"><a id="__codelineno-10-36" name="__codelineno-10-36"></a><span class="w">    </span><span class="nt">&quot;return&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;int_arg&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-10-37"><a id="__codelineno-10-37" name="__codelineno-10-37"></a><span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;KPROBE_ACTION_POST&quot;</span><span class="p">,</span>
</span><span id="__span-10-38"><a id="__codelineno-10-38" name="__codelineno-10-38"></a><span class="w">    </span><span class="nt">&quot;policy_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;file-monitoring-filtered&quot;</span><span class="p">,</span>
</span><span id="__span-10-39"><a id="__codelineno-10-39" name="__codelineno-10-39"></a><span class="w">    </span><span class="nt">&quot;return_action&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;KPROBE_ACTION_POST&quot;</span>
</span><span id="__span-10-40"><a id="__codelineno-10-40" name="__codelineno-10-40"></a><span class="w">  </span><span class="p">},</span>
</span><span id="__span-10-41"><a id="__codelineno-10-41" name="__codelineno-10-41"></a><span class="w">  </span><span class="nt">&quot;node_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;8bbf125cf4b7&quot;</span><span class="p">,</span>
</span><span id="__span-10-42"><a id="__codelineno-10-42" name="__codelineno-10-42"></a><span class="w">  </span><span class="nt">&quot;time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2024-06-27T06:06:07.250057584Z&quot;</span>
</span><span id="__span-10-43"><a id="__codelineno-10-43" name="__codelineno-10-43"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-5">5. 参考资料<a class="headerlink" href="#%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0-5" title="Permanent link">&para;</a></h2>
<p><a href="https://tetragon.io/docs/getting-started/file-events/">https://tetragon.io/docs/getting-started/file-events/</a></p>
<p><a href="https://tetragon.io/docs/concepts/tracing-policy/options/">https://tetragon.io/docs/concepts/tracing-policy/options/</a></p>
<p><a href="https://github.com/cilium/tetragon/blob/main/examples/quickstart/file_monitoring.yaml">https://github.com/cilium/tetragon/blob/main/examples/quickstart/file_monitoring.yaml</a></p>
<p><a href="https://medium.com/@boutnaru/the-linux-process-journey-kauditd-25718f6c502d">https://medium.com/@boutnaru/the-linux-process-journey-kauditd-25718f6c502d</a></p>
<p><a href="https://medium.com/@rhonnava/audit-logging-with-container-id-tagging-65e92c570f12">https://medium.com/@rhonnava/audit-logging-with-container-id-tagging-65e92c570f12</a></p>
<p><a href="https://access.redhat.com/articles/4494341">https://access.redhat.com/articles/4494341</a></p></section></section></section>
                    <section class='print-page md-section' id='section-3' heading-number='3'>
                        <h1>前端开发<a class='headerlink' href='#section-3' title='Permanent link'></a>
                        </h1>
                    
                    <section class='print-page md-section' id='section-3-1' heading-number='3.1'>
                        <h1>Vue3<a class='headerlink' href='#section-3-1' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81" heading-number="3.1.1"><nav class='md-tags'><span class='md-tag'>Geeker-Admin</span><span class='md-tag'>Vue3</span><span class='md-tag'>Keycloak</span><span class='md-tag'>TypeScript</span></nav><h1 id="geeker-admin-keycloak">Geeker-Admin 接入 Keycloak 认证<a class="headerlink" href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-geeker-admin-keycloak" title="Permanent link">&para;</a></h1>
<h2 id="%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-1">1. 前置条件<a class="headerlink" href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-1" title="Permanent link">&para;</a></h2>
<ol>
<li>Keycloak 服务器运行在 <a href="http://localhost:8080/">http://localhost:8080/</a> 。</li>
<li>Keycloak 服务器创建 Realm，名称为 test ，并在其中创建 Client ID 为 test-client 、 Client type 为 OpenID Connect 、 Client authentication 关闭、 Valid redirect URIs 和 Web origins 均为 * 的 Client 。</li>
</ol>
<h2 id="%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-2-keycloak">2. 安装 Keycloak 对接器<a class="headerlink" href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-2-keycloak" title="Permanent link">&para;</a></h2>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>npm i --save keycloak-js@24.0
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-3">3. 加入环境变量<a class="headerlink" href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-3" title="Permanent link">&para;</a></h2>
<p>在 <code>.env.development</code> 加入：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-1-4">4</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-1-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a># keycloak options
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>VITE_APP_KEYCLOAK_OPTIONS_URL = &#39;http://localhost:8080/&#39;
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a>VITE_APP_KEYCLOAK_OPTIONS_REALM = &#39;test&#39;
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a>VITE_APP_KEYCLOAK_OPTIONS_CLIENTID = &#39;test-client&#39;
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a>VITE_APP_KEYCLOAK_OPTIONS_ONLOAD = &#39;login-required&#39;
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-4-maints-keycloak">4. 在 main.ts 中加入 keycloak 认证<a class="headerlink" href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-4-maints-keycloak" title="Permanent link">&para;</a></h2>
<p>在 <code>src/main.ts</code> 中加入以下代码，引入 Keycloak：</p>
<div class="language-javascript highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-3">3</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-4">4</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-5">5</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-6">6</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1">// 引入Keycloak</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="c1">// 参考：https://github.com/achernetsov/vue-keycloak-template</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="k">import</span><span class="w"> </span><span class="nx">Keycloak</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">  </span><span class="nx">type</span><span class="w"> </span><span class="nx">KeycloakConfig</span><span class="p">,</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span><span class="nx">type</span><span class="w"> </span><span class="nx">KeycloakInitOptions</span><span class="p">,</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;keycloak-js&quot;</span><span class="p">;</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useKeycloakStore</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;@/store/modules/keycloakStore&quot;</span><span class="p">;</span>
</span></code></pre></div></td></tr></table></div>
<p>为 Keycloak 加入 store，创建文件 <code>src/stores/modules/keycloakStore.ts</code> ：</p>
<div class="language-javascript highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-3">3</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-4">4</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-5">5</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-6">6</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-7">7</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-8">8</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ref</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;vue&quot;</span><span class="p">;</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">defineStore</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;pinia&quot;</span><span class="p">;</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="k">import</span><span class="w"> </span><span class="nx">type</span><span class="w"> </span><span class="nx">Keycloak</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;keycloak-js&quot;</span><span class="p">;</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="c1">// https://pinia.vuejs.org/getting-started.html</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">useKeycloakStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">defineStore</span><span class="p">(</span><span class="s2">&quot;keycloakStore&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">keycloak</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ref</span><span class="p">(</span><span class="kc">null</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Keycloak</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">keycloak</span><span class="w"> </span><span class="p">};</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="p">});</span>
</span></code></pre></div></td></tr></table></div>
<p>在 <code>main.ts</code> 中加入 Keycloak 将以下代码：</p>
<div class="language-javascript highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-4-2">2</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-4-3">3</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-4-4">4</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-4-5">5</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-4-6">6</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-4-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="nx">app</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">  </span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">ElementPlus</span><span class="p">)</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">  </span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">directives</span><span class="p">)</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">  </span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">router</span><span class="p">)</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">  </span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">I18n</span><span class="p">)</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">  </span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">pinia</span><span class="p">)</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">  </span><span class="p">.</span><span class="nx">mount</span><span class="p">(</span><span class="s2">&quot;#app&quot;</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div>
<p>替换为：</p>
<div class="language-javascript highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-10">10</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-11">11</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-12">12</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-13">13</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-14">14</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-15">15</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-16">16</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-17">17</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-18">18</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-19">19</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-20">20</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-21">21</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-22">22</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-23">23</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-24">24</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-25">25</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-26">26</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-27">27</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-28">28</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-29">29</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-30">30</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-31">31</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-32">32</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-33">33</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-34">34</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-35">35</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-36">36</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-37">37</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-38">38</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-39">39</a></span>
<span class="normal"><a href="#%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-40">40</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">ElementPlus</span><span class="p">).</span><span class="nx">use</span><span class="p">(</span><span class="nx">directives</span><span class="p">).</span><span class="nx">use</span><span class="p">(</span><span class="nx">router</span><span class="p">).</span><span class="nx">use</span><span class="p">(</span><span class="nx">I18n</span><span class="p">).</span><span class="nx">use</span><span class="p">(</span><span class="nx">pinia</span><span class="p">);</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="kd">let</span><span class="w"> </span><span class="nx">keycloakConfig</span><span class="o">:</span><span class="w"> </span><span class="nx">KeycloakConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">  </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="k">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VITE_APP_KEYCLOAK_OPTIONS_URL</span><span class="p">,</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">  </span><span class="nx">realm</span><span class="o">:</span><span class="w"> </span><span class="k">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VITE_APP_KEYCLOAK_OPTIONS_REALM</span><span class="p">,</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">  </span><span class="nx">clientId</span><span class="o">:</span><span class="w"> </span><span class="k">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VITE_APP_KEYCLOAK_OPTIONS_CLIENTID</span><span class="p">,</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="p">};</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="kd">let</span><span class="w"> </span><span class="nx">keycloak</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Keycloak</span><span class="p">(</span><span class="nx">keycloakConfig</span><span class="p">);</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="kd">const</span><span class="w"> </span><span class="nx">keycloakStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useKeycloakStore</span><span class="p">();</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="nx">keycloakStore</span><span class="p">.</span><span class="nx">keycloak</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">keycloak</span><span class="p">;</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="kd">let</span><span class="w"> </span><span class="nx">initOptions</span><span class="o">:</span><span class="w"> </span><span class="nx">KeycloakInitOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">  </span><span class="nx">onLoad</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;login-required&quot;</span><span class="p">,</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="w">  </span><span class="nx">enableLogging</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="w">  </span><span class="nx">responseMode</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;query&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// 参考：https://github.com/keycloak/keycloak/issues/14742</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="p">};</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="nx">keycloak</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">initOptions</span><span class="p">).</span><span class="nx">then</span><span class="p">((</span><span class="nx">auth</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">auth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18"></a><span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;Authentication failed&quot;</span><span class="p">);</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Authenticated&quot;</span><span class="p">);</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21"></a><span class="w">    </span><span class="nx">keycloak</span><span class="p">.</span><span class="nx">loadUserInfo</span><span class="p">().</span><span class="nx">then</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="w">      </span><span class="nx">app</span><span class="p">.</span><span class="nx">mount</span><span class="p">(</span><span class="s2">&quot;#app&quot;</span><span class="p">);</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23"></a><span class="w">    </span><span class="p">});</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25"></a><span class="w">  </span><span class="c1">//Token Refresh</span>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26"></a><span class="w">  </span><span class="nx">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27"></a><span class="w">    </span><span class="nx">keycloak</span>
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28"></a><span class="w">      </span><span class="p">.</span><span class="nx">updateToken</span><span class="p">(</span><span class="mf">70</span><span class="p">)</span>
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29"></a><span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">refreshed</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">refreshed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31"></a><span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Token refreshed&quot;</span><span class="p">);</span>
</span><span id="__span-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33"></a><span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;Token not refreshed&quot;</span><span class="p">);</span>
</span><span id="__span-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-5-35"><a id="__codelineno-5-35" name="__codelineno-5-35"></a><span class="w">      </span><span class="p">})</span>
</span><span id="__span-5-36"><a id="__codelineno-5-36" name="__codelineno-5-36"></a><span class="w">      </span><span class="p">.</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-37"><a id="__codelineno-5-37" name="__codelineno-5-37"></a><span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Failed to refresh token&quot;</span><span class="p">);</span>
</span><span id="__span-5-38"><a id="__codelineno-5-38" name="__codelineno-5-38"></a><span class="w">      </span><span class="p">});</span>
</span><span id="__span-5-39"><a id="__codelineno-5-39" name="__codelineno-5-39"></a><span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="mf">6000</span><span class="p">);</span>
</span><span id="__span-5-40"><a id="__codelineno-5-40" name="__codelineno-5-40"></a><span class="p">});</span>
</span></code></pre></div></td></tr></table></div></section></section></section>
                    <section class='print-page md-section' id='section-4' heading-number='4'>
                        <h1>存储技术<a class='headerlink' href='#section-4' title='Permanent link'></a>
                        </h1>
                    
                    <section class='print-page md-section' id='section-4-1' heading-number='4.1'>
                        <h1>Ceph<a class='headerlink' href='#section-4-1' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph" heading-number="4.1.1"><nav class='md-tags'><span class='md-tag'>Ceph</span><span class='md-tag'>银河麒麟V10</span></nav><h1 id="v10-ceph">银河麒麟 V10 安装 Ceph<a class="headerlink" href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-v10-ceph" title="Permanent link">&para;</a></h1>
<h2 id="%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-1">1. 系统架构<a class="headerlink" href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-1" title="Permanent link">&para;</a></h2>
<p>本次安装的 Ceph 仅有 3 个节点，各个节点配置和用途如下：</p>
<table>
<thead>
<tr>
<th>节点名称</th>
<th>IP 地址</th>
<th>服务器角色</th>
<th>配置要求</th>
</tr>
</thead>
<tbody>
<tr>
<td>ceph01</td>
<td>192.168.100.14</td>
<td>Ceph 节点</td>
<td>4C8G</td>
</tr>
<tr>
<td>ceph02</td>
<td>192.168.100.15</td>
<td>Ceph 节点</td>
<td>4C8G</td>
</tr>
<tr>
<td>ceph03</td>
<td>192.168.100.16</td>
<td>Ceph 节点</td>
<td>4C8G</td>
</tr>
</tbody>
</table>
<p>其中，所有的节点都需要配置 NTP 时钟同步服务器，且所有节点都需要有默认网关。同时，需要使用 Ansible 对这 3 个节点进行批量配置。</p>
<h%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-2 id="%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-2">2. 准备工作<a class="headerlink" href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-2" title="Permanent link">&para;</a></h2>
<h3 id="%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-21">2.1 安装前系统参数<a class="headerlink" href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-21" title="Permanent link">&para;</a></h3>
<p>所有节点均需要禁用 swap 、关闭 firewalld 防火墙与 SELinux ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-0-6">6</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-0-7">7</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-0-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a># Disable swap
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>sed -i &#39;/^.*[[:space:]]*swap[[:space:]]*swap[[:space:]]*.*$/d&#39; /etc/fstab
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a># Disable firewalld
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a>systemctl disable firewalld.service
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a># Disable SELinux
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a>sed -i &#39;s/^SELINUX=.*$/SELINUX=disabled/g&#39; /etc/selinux/config
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a># Reboot to apply changes
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a>reboot
</span></code></pre></div></td></tr></table></div>
<h3 id="%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-22-ansible">2.2 Ansible 主机清单配置<a class="headerlink" href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-22-ansible" title="Permanent link">&para;</a></h3>
<p>本文使用 Ansible 来对节点进行批量操作，Ansible 主机清单配置如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-1-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>[ceph]
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>192.168.100.14
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a>192.168.100.15
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a>192.168.100.16
</span></code></pre></div></td></tr></table></div>
<h3 id="%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-23">2.3 介质下载<a class="headerlink" href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-23" title="Permanent link">&para;</a></h3>
<p>如果需要离线安装，需要额外准备一台可以通外网的机器来下载介质，此机器也需要禁用 swap 、关闭 firewalld 防火墙与 SELinux ，且至少需要安装 docker 。其中需要下载的二进制文件及配置文件如下：</p>
<table>
<thead>
<tr>
<th>介质名称</th>
<th>下载地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>containerd-1.7.11-linux-amd64.tar.gz</td>
<td><a href="https://github.com/containerd/containerd/releases">https://github.com/containerd/containerd/releases</a></td>
</tr>
<tr>
<td>containerd.service</td>
<td><a href="https://raw.githubusercontent.com/containerd/containerd/main/containerd.service">https://raw.githubusercontent.com/containerd/containerd/main/containerd.service</a></td>
</tr>
<tr>
<td>docker-24.0.7.tgz</td>
<td><a href="https://download.docker.com/linux/static/stable/x86_64/">https://download.docker.com/linux/static/stable/x86_64/</a></td>
</tr>
<tr>
<td>docker.service</td>
<td><a href="https://github.com/moby/moby/blob/master/contrib/init/systemd/docker.service">https://github.com/moby/moby/blob/master/contrib/init/systemd/docker.service</a></td>
</tr>
<tr>
<td>docker.socket</td>
<td><a href="https://github.com/moby/moby/blob/master/contrib/init/systemd/docker.socket">https://github.com/moby/moby/blob/master/contrib/init/systemd/docker.socket</a></td>
</tr>
</tbody>
</table>
<p>需要下载的容器镜像如下：</p>
<table>
<thead>
<tr>
<th>镜像名称</th>
<th>下载方式</th>
</tr>
</thead>
<tbody>
<tr>
<td>quay.io/ceph/ceph:v18</td>
<td>使用 docker 命令下载</td>
</tr>
<tr>
<td>quay.io/ceph/ceph-grafana:9.4.7</td>
<td>使用 docker 命令下载</td>
</tr>
<tr>
<td>quay.io/prometheus/prometheus:v2.43.0</td>
<td>使用 docker 命令下载</td>
</tr>
<tr>
<td>quay.io/prometheus/alertmanager:v0.25.0</td>
<td>使用 docker 命令下载</td>
</tr>
<tr>
<td>quay.io/prometheus/node-exporter:v1.5.0</td>
<td>使用 docker 命令下载</td>
</tr>
<tr>
<td>registry:2</td>
<td>使用 docker 命令下载</td>
</tr>
</tbody>
</table>
<p>使用 docker 下载容器镜像的命令如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-2-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>docker pull [镜像名称]
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>docker image save -i [镜像名称].tar
</span></code></pre></div></td></tr></table></div>
<p>导入 docker 容器镜像命令如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>docker image load -i [镜像名称].tar
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-3-containerd">3. 安装 containerd 容器运行环境<a class="headerlink" href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-3-containerd" title="Permanent link">&para;</a></h2>
<p>所有的 ceph 节点都需要安装 containerd ，使用此 Ansible Playbook 进行批量安装：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">containerd-install.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-10">10</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-11">11</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-12">12</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-13">13</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-14">14</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-15">15</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-16">16</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-17">17</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-18">18</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-19">19</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-20">20</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-21">21</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-22">22</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-23">23</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-24">24</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-25">25</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-26">26</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-27">27</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-28">28</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-29">29</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-30">30</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-31">31</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-32">32</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-4-33">33</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="nn">---</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install containerd</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">extract containerd-1.7.11-linux-amd64.tar.gz</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">      </span><span class="nt">unarchive</span><span class="p">:</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">        </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">containerd-1.7.11-linux-amd64.tar.gz</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/local/</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install containerd.service</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">      </span><span class="nt">copy</span><span class="p">:</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">        </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">containerd.service</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/lib/systemd/system/containerd.service</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">generate default containerd config</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">      </span><span class="nt">shell</span><span class="p">:</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">        </span><span class="nt">cmd</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">          </span><span class="no">mkdir -p /etc/containerd/</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="w">          </span><span class="no">containerd config default &gt; /etc/containerd/config.toml</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">configure containerd to use systemd cgroup</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="w">      </span><span class="nt">replace</span><span class="p">:</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/containerd/config.toml</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="w">        </span><span class="nt">regexp</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;SystemdCgroup</span><span class="nv"> </span><span class="s">=</span><span class="nv"> </span><span class="s">false&quot;</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="w">        </span><span class="nt">replace</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;SystemdCgroup</span><span class="nv"> </span><span class="s">=</span><span class="nv"> </span><span class="s">true&quot;</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">configure containerd to use pause:3.9</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24"></a><span class="w">      </span><span class="nt">replace</span><span class="p">:</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25"></a><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/containerd/config.toml</span>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26"></a><span class="w">        </span><span class="nt">regexp</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;registry.k8s.io/pause:3.8&quot;</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27"></a><span class="w">        </span><span class="nt">replace</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;registry.k8s.io/pause:3.9&quot;</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">enable and restart containerd service</span>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29"></a><span class="w">      </span><span class="nt">systemd</span><span class="p">:</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">containerd</span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31"></a><span class="w">        </span><span class="nt">daemon_reload</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restarted</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33"></a><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-4-docker">4. 安装 docker<a class="headerlink" href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-4-docker" title="Permanent link">&para;</a></h2>
<p>所有的 ceph 节点都需要安装 docker ，使用此 Ansible Playbook 进行批量安装：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">docker-install.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-5-10">10</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-5-11">11</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-5-12">12</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-5-13">13</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-5-14">14</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-5-15">15</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-5-16">16</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-5-17">17</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-5-18">18</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-5-19">19</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-5-20">20</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-5-21">21</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-5-22">22</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-5-23">23</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-5-24">24</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-5-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nn">---</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install docker</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ceph</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">copy files to remote /tmp</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">      </span><span class="nt">copy</span><span class="p">:</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">        </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">      </span><span class="nt">with_items</span><span class="p">:</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker-24.0.7.tgz</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker.service</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker.socket</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install docker</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="w">      </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="w">        </span><span class="no">cd /tmp</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="w">        </span><span class="no">tar zxvf docker-24.0.7.tgz</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="w">        </span><span class="no">cp docker/* /usr/bin/</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18"></a><span class="w">        </span><span class="no">cp docker.service docker.socket /usr/lib/systemd/system/</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="w">        </span><span class="no">groupadd --system docker --gid 357</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">enable and restart docker service</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21"></a><span class="w">      </span><span class="nt">systemd</span><span class="p">:</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23"></a><span class="w">        </span><span class="nt">daemon_reload</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restarted</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25"></a><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-5-cephadm-ceph">5. 安装 cephadm 和 ceph<a class="headerlink" href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-5-cephadm-ceph" title="Permanent link">&para;</a></h2>
<p>使用以下 playbook 安装 ceph 和 cephadm：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-10">10</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-11">11</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-12">12</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-13">13</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-14">14</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-15">15</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-16">16</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-17">17</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-18">18</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-19">19</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-20">20</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-21">21</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-22">22</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-23">23</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-24">24</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-25">25</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-26">26</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-27">27</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-28">28</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-29">29</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-30">30</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-31">31</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-32">32</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-33">33</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-34">34</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-35">35</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-36">36</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-37">37</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-38">38</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-39">39</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-40">40</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-41">41</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-42">42</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-43">43</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-44">44</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-45">45</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-46">46</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-47">47</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-6-48">48</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="nn">---</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install ceph</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ceph</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tag images</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">      </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="w">        </span><span class="no">docker image tag quay.io/prometheus/alertmanager:v0.25.0 localhost:5000/prometheus/alertmanager:v0.25.0</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="w">        </span><span class="no">docker image tag quay.io/ceph/ceph-grafana:9.4.7 localhost:5000/ceph/ceph-grafana:9.4.7</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="w">        </span><span class="no">docker image tag quay.io/ceph/ceph:v18 localhost:5000/ceph/ceph:v18</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">        </span><span class="no">docker image tag quay.io/prometheus/node-exporter:v1.5.0 localhost:5000/prometheus/node-exporter:v1.5.0</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="w">        </span><span class="no">docker image tag quay.io/prometheus/prometheus:v2.43.0 localhost:5000/prometheus/prometheus:v2.43.0</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">run docker local registry</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="w">      </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="w">        </span><span class="no">docker run -d --restart=unless-stopped --name registry \</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="w">          </span><span class="no">-e &quot;REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY=/var/lib/registry&quot; \</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="w">          </span><span class="no">-e &quot;REGISTRY_STORAGE_CACHE_BLOBDESCRIPTOR=inmemory&quot; \</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="w">          </span><span class="no">-e &quot;REGISTRY_STORAGE_DELETE_ENABLED=true&quot; \</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="w">          </span><span class="no">-e &quot;REGISTRY_VALIDATION_DISABLED=true&quot; \</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="w">          </span><span class="no">-v &quot;registry-data:/var/lib/registry&quot; \</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20"></a><span class="w">          </span><span class="no">-p &quot;127.0.0.1:5000:5000&quot; \</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="w">          </span><span class="no">registry:2</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22"></a><span class="w">        </span><span class="no">true</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">push images to local repository</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24"></a><span class="w">      </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25"></a><span class="w">        </span><span class="no">docker push localhost:5000/prometheus/alertmanager:v0.25.0</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26"></a><span class="w">        </span><span class="no">docker push localhost:5000/ceph/ceph-grafana:9.4.7</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27"></a><span class="w">        </span><span class="no">docker push localhost:5000/ceph/ceph:v18</span>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28"></a><span class="w">        </span><span class="no">docker push localhost:5000/prometheus/node-exporter:v1.5.0</span>
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29"></a><span class="w">        </span><span class="no">docker push localhost:5000/prometheus/prometheus:v2.43.0</span>
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install cephadm</span>
</span><span id="__span-6-31"><a id="__codelineno-6-31" name="__codelineno-6-31"></a><span class="w">      </span><span class="nt">copy</span><span class="p">:</span>
</span><span id="__span-6-32"><a id="__codelineno-6-32" name="__codelineno-6-32"></a><span class="w">        </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cephadm</span>
</span><span id="__span-6-33"><a id="__codelineno-6-33" name="__codelineno-6-33"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/local/bin/</span>
</span><span id="__span-6-34"><a id="__codelineno-6-34" name="__codelineno-6-34"></a><span class="w">        </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0755</span>
</span><span id="__span-6-35"><a id="__codelineno-6-35" name="__codelineno-6-35"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">add ceph group</span>
</span><span id="__span-6-36"><a id="__codelineno-6-36" name="__codelineno-6-36"></a><span class="w">      </span><span class="nt">group</span><span class="p">:</span>
</span><span id="__span-6-37"><a id="__codelineno-6-37" name="__codelineno-6-37"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ceph</span>
</span><span id="__span-6-38"><a id="__codelineno-6-38" name="__codelineno-6-38"></a><span class="w">        </span><span class="nt">gid</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">167</span>
</span><span id="__span-6-39"><a id="__codelineno-6-39" name="__codelineno-6-39"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">add ceph user</span>
</span><span id="__span-6-40"><a id="__codelineno-6-40" name="__codelineno-6-40"></a><span class="w">      </span><span class="nt">user</span><span class="p">:</span>
</span><span id="__span-6-41"><a id="__codelineno-6-41" name="__codelineno-6-41"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ceph</span>
</span><span id="__span-6-42"><a id="__codelineno-6-42" name="__codelineno-6-42"></a><span class="w">        </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">167</span>
</span><span id="__span-6-43"><a id="__codelineno-6-43" name="__codelineno-6-43"></a><span class="w">        </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/sbin/nologin</span>
</span><span id="__span-6-44"><a id="__codelineno-6-44" name="__codelineno-6-44"></a><span class="w">        </span><span class="nt">expires</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-1</span>
</span><span id="__span-6-45"><a id="__codelineno-6-45" name="__codelineno-6-45"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">add /root/.bashrc environment variable</span>
</span><span id="__span-6-46"><a id="__codelineno-6-46" name="__codelineno-6-46"></a><span class="w">      </span><span class="nt">lineinfile</span><span class="p">:</span>
</span><span id="__span-6-47"><a id="__codelineno-6-47" name="__codelineno-6-47"></a><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/root/.bashrc</span>
</span><span id="__span-6-48"><a id="__codelineno-6-48" name="__codelineno-6-48"></a><span class="w">        </span><span class="nt">line</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;export</span><span class="nv"> </span><span class="s">CEPHADM_IMAGE=localhost:5000/ceph/ceph:v18&quot;</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-6-ceph01">6. 配置 ceph01 节点<a class="headerlink" href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-6-ceph01" title="Permanent link">&para;</a></h2>
<p>安装完成后，在 ceph01 节点，创建 ceph 集群：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-7-1">1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-7-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a>source ~/.bashrc
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a>cephadm bootstrap --mon-ip 192.168.100.14
</span></code></pre></div></td></tr></table></div>
<p>之后使用<code>cephadm shell</code>命令进入 ceph 命令行（所有 ceph 命令均需要在 ceph 命令行执行），运行以下命令修改 ceph 相关容器使用本地镜像仓库：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-8-1">1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-8-2">2</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-8-3">3</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-8-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a>ceph config set mgr mgr/cephadm/container_image_prometheus localhost:5000/prometheus/prometheus:v2.43.0
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a>ceph config set mgr mgr/cephadm/container_image_node_exporter localhost:5000/prometheus/node-exporter:v1.5.0
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a>ceph config set mgr mgr/cephadm/container_image_grafana localhost:5000/ceph/ceph-grafana:9.4.7
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a>ceph config set mgr mgr/cephadm/container_image_alertmanager localhost:5000/prometheus/alertmanager:v0.25.0
</span></code></pre></div></td></tr></table></div>
<p>重新部署 ceph 容器：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-9-1">1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-9-2">2</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-9-3">3</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-9-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a>ceph orch redeploy prometheus
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2"></a>ceph orch redeploy node-exporter
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3"></a>ceph orch redeploy grafana
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4"></a>ceph orch redeploy alertmanager
</span></code></pre></div></td></tr></table></div>
<p>验证：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-10-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a>ceph orch ls
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-11-1">1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-11-2">2</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-11-3">3</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-11-4">4</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-11-5">5</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-11-6">6</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-11-7">7</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-11-8">8</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-11-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a>NAME           PORTS        RUNNING  REFRESHED  AGE  PLACEMENT
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2"></a>alertmanager   ?:9093,9094      1/1  7s ago     3m   count:1
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3"></a>ceph-exporter                   1/1  7s ago     3m   *
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4"></a>crash                           1/1  7s ago     3m   *
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5"></a>grafana        ?:3000           1/1  7s ago     3m   count:1
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6"></a>mgr                             1/2  7s ago     3m   count:2
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7"></a>mon                             1/5  7s ago     3m   count:5
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8"></a>node-exporter  ?:9100           1/1  7s ago     3m   *
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9"></a>prometheus     ?:9095           1/1  7s ago     3m   count:1
</span></code></pre></div></td></tr></table></div>
<p>将节点 ceph01 设置成管理节点：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-12-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a>ceph orch host label add ceph01 _admin
</span></code></pre></div></td></tr></table></div>
<p>检查 ceph 所有节点：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-13-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a>ceph orch host ls
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-14-1">1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-14-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a>HOST    ADDR            LABELS  STATUS
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2"></a>ceph01  192.168.100.14  _admin
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-7-ceph">7. 将其它节点加入 ceph 集群作为管理节点<a class="headerlink" href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-7-ceph" title="Permanent link">&para;</a></h2>
<p>在第一个节点上，将剩下两个节点加入 ceph 集群（以下命令不要在 ceph 命令行执行）：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-15-1">1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-15-2">2</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-15-3">3</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-15-4">4</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-15-5">5</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-15-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1"></a>ssh-copy-id -f -i /etc/ceph/ceph.pub root@192.168.100.15
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2"></a>ssh-copy-id -f -i /etc/ceph/ceph.pub root@192.168.100.16
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3"></a>cephadm shell -- ceph orch host add ceph02 192.168.100.15
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4"></a>cephadm shell -- ceph orch host label add ceph02 _admin
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5"></a>cephadm shell -- ceph orch host add ceph03 192.168.100.16
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6"></a>cephadm shell -- ceph orch host label add ceph03 _admin
</span></code></pre></div></td></tr></table></div>
<p>将 monitor 部署在三个节点：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-16-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1"></a>ceph orch apply mon --placement=&quot;ceph01,ceph02,ceph03&quot;
</span></code></pre></div></td></tr></table></div>
<p>如果三个节点在一个 B 段，但是不在一个 C 段，还需要额外运行这个命令修改 public_network 子网：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-17-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1"></a>ceph config set mon public_network 192.168.0.0/16
</span></code></pre></div></td></tr></table></div>
<p>完成以后，检查 ceph 主机列表：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-18-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1"></a>ceph orch host ls
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-19-1">1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-19-2">2</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-19-3">3</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-19-4">4</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-19-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1"></a>HOST    ADDR            LABELS  STATUS
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2"></a>ceph01  192.168.100.14  _admin
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3"></a>ceph02  192.168.100.15  _admin
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4"></a>ceph03  192.168.100.16  _admin
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5"></a>3 hosts in cluster
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-8-ceph">8. 将磁盘加入 ceph<a class="headerlink" href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-8-ceph" title="Permanent link">&para;</a></h2>
<p>将三个机器的/dev/sdb 加入 ceph 集群：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-20-1">1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-20-2">2</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-20-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1"></a>ceph orch daemon add osd ceph01:/dev/sdb
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2"></a>ceph orch daemon add osd ceph02:/dev/sdb
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3"></a>ceph orch daemon add osd ceph03:/dev/sdb
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-9-ceph">9. 检查 ceph 集群状态<a class="headerlink" href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-9-ceph" title="Permanent link">&para;</a></h2>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-21-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1"></a>ceph<span class="w"> </span>status
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-22-1"> 1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-22-2"> 2</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-22-3"> 3</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-22-4"> 4</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-22-5"> 5</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-22-6"> 6</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-22-7"> 7</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-22-8"> 8</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-22-9"> 9</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-22-10">10</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-22-11">11</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-22-12">12</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-22-13">13</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph-__codelineno-22-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1"></a>  cluster:
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2"></a>    id:     2708c980-bdb5-11ee-9d2f-000c29838e6e
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3"></a>    health: HEALTH_OK
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4"></a>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5"></a>  services:
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6"></a>    mon: 3 daemons, quorum ceph01,ceph02,ceph03 (age 3m)
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7"></a>    mgr: ceph02.rlxrnd(active, since 3m), standbys: ceph01.ftqqta
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8"></a>    osd: 3 osds: 3 up (since 22s), 3 in (since 38s)
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9"></a>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10"></a>  data:
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11"></a>    pools:   1 pools, 1 pgs
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12"></a>    objects: 2 objects, 449 KiB
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13"></a>    usage:   80 MiB used, 96 GiB / 96 GiB avail
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14"></a>    pgs:     1 active+clean
</span></code></pre></div></td></tr></table></div></section></section>
                    <section class='print-page md-section' id='section-4-2' heading-number='4.2'>
                        <h1>ZFS<a class='headerlink' href='#section-4-2' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7" heading-number="4.2.1"><nav class='md-tags'><span class='md-tag'>ZFS</span><span class='md-tag'>TrueNAS</span></nav><h1 id="truenas">TrueNAS 删除所有空快照<a class="headerlink" href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-truenas" title="Permanent link">&para;</a></h1>
<h2 id="%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-1-zfs">1. ZFS 列出所有快照<a class="headerlink" href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-1-zfs" title="Permanent link">&para;</a></h2>
<p>使用以下命令列出所有快照:</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>zfs list -t snap
</span></code></pre></div></td></tr></table></div>
<p>该命令输出大致如下:</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-1-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>NAME                                   USED  AVAIL  REFER  MOUNTPOINT
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>boot-pool/ROOT/24.04.0@pristine          8K      -   164M  -
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a>boot-pool/ROOT/24.04.0/conf@pristine     0B      -   140K  -
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a>boot-pool/ROOT/24.04.0/etc@pristine   1.06M      -  5.54M  -
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a>boot-pool/ROOT/24.04.0/opt@pristine      0B      -  74.1M  -
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a>boot-pool/ROOT/24.04.0/usr@pristine      0B      -  2.12G  -
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a>boot-pool/ROOT/24.04.0/var@pristine    716K      -  30.8M  -
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a>nas@auto-2023-10-28_20-00               80K      -   120K  -
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a>nas@auto-2023-10-28_21-00                0B      -   112K  -
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a>nas@auto-2023-10-28_22-00                0B      -   112K  -
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a>nas@auto-2023-10-28_23-00                0B      -   112K  -
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a>nas@auto-2023-10-29_00-00                0B      -   112K  -
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a>nas@auto-2023-10-29_01-00                0B      -   112K  -
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14"></a>nas@auto-2023-10-29_02-00                0B      -   112K  -
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15"></a>nas@auto-2023-10-29_03-00                0B      -   112K  -
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16"></a>nas@auto-2023-10-29_04-00                0B      -   112K  -
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17"></a>nas@auto-2023-10-29_05-00                0B      -   112K  -
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18"></a>nas@auto-2023-10-29_06-00                0B      -   112K  -
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19"></a>nas@auto-2023-10-29_07-00                0B      -   112K  -
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20"></a>nas@auto-2023-10-29_08-00                0B      -   112K  -
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-2-0b">2. 找出所有大小为 0B 的快照并删除<a class="headerlink" href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-2-0b" title="Permanent link">&para;</a></h2>
<p>使用以下脚本,用 awk 提取出大小为 0B 的快照,并输出 zfs 删除快照的命令:</p>
<div class="admonition note">
<p class="admonition-title">remove_empty_snapshots.sh</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-2-3">3</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-2-4">4</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-2-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>#!/bin/bash
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>snapshots=$(zfs list -t snap | awk &#39;$2==&quot;0B&quot;{print $1}&#39;)
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a>while read -r line;do
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a>    echo zfs destroy $line
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a>done &lt;&lt;&lt; &quot;$snapshots&quot;
</span></code></pre></div></td></tr></table></div>
</div>
<p>将此脚本输出重定向到文件 <code>remove.sh</code> :</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>/bin/bash remove_empty_snapshots.sh &gt; remove.sh
</span></code></pre></div></td></tr></table></div>
<p>在核对 <code>remove.sh</code> 内容后,运行 <code>remove.sh</code> :</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7-__codelineno-4-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>/bin/bash remove.sh
</span></code></pre></div></td></tr></table></div></section></section>
                    <section class='print-page md-section' id='section-4-3' heading-number='4.3'>
                        <h1>TrueNAS<a class='headerlink' href='#section-4-3' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025" heading-number="4.3.1"><nav class='md-tags'><span class='md-tag'>TrueNAS</span><span class='md-tag'>Windows</span><span class='md-tag'>iSCSI</span><span class='md-tag'>TFTP</span></nav><h1 id="truenas-iscsi-windows-server-2025">TrueNAS iSCSI 安装 Windows Server 2025<a class="headerlink" href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-truenas-iscsi-windows-server-2025" title="Permanent link">&para;</a></h1>
<h2 id="%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-1">1. 准备工作<a class="headerlink" href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-1" title="Permanent link">&para;</a></h2>
<p>要想在 Windows Server 安装到 TrueNAS 的 iSCSI 服务器上，需要先具备以下：</p>
<ul>
<li>HTTP 服务器：由 TrueNAS 上虚拟机提供</li>
<li>TFTP 服务器：由 TrueNAS 的容器提供</li>
<li>iSCSI 服务器：由 TrueNAS 提供</li>
<li>DNS 和 DHCP 服务器：由 OpenWrt 上 dnsmasq 提供</li>
<li>SMB 服务器：由 TrueNAS 提供</li>
</ul>
<p>同时需要具备一台已经装好 Windows 的机器用于制作 WinPE 镜像，一台 Linux 的机器用于编译 iPXE 和上传 iPXE 镜像到 TFTP 服务器</p>
<h2 id="%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-2-iscsi-lun">2. 在 iSCSI 上划分一个 LUN<a class="headerlink" href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-2-iscsi-lun" title="Permanent link">&para;</a></h2>
<p>首先进入 Datasets ，新建一个 Zvol ，名称为 <code>windows-server-2025</code> ，大小为 64 GB ：
<img alt="新建Zvol" src="%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/TrueNAS/images/Screenshot%202025-06-15%20155635.png" />
之后不要忘记对此 Zvol 设置定时快照，以防 Windows 更新无法回退：
<img alt="设置快照" src="%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/TrueNAS/images/Screenshot%202025-06-15%20155956.png" />
进入 Shares -&gt; iSCSI ，点击 Wizard 快速创建一个 LUN ：
<img alt="创建LUN-1" src="%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/TrueNAS/images/Screenshot%202025-06-15%20155635.png" />
<img alt="创建LUN-2" src="%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/TrueNAS/images/Screenshot%202025-06-15%20160518.png" />
<img alt="创建LUN-3" src="%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/TrueNAS/images/Screenshot%202025-06-15%20160531.png" />
创建完成后可挂载此 LUN 来验证。</p>
<h2 id="%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-3-tftp">3. 搭建 TFTP 服务<a class="headerlink" href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-3-tftp" title="Permanent link">&para;</a></h2>
<p>直接使用 TrueNAS Scale 的容器功能搭建 TFTP 服务，在 Apps 里安装 <code>tftpd-hpa</code> 应用即可，相关配置默认即可。搭建完成后使用 TFTP 命令验证，注意 TFTP 命令是没有 ls 的。</p>
<h2 id="%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-4-dns-dhcp">4. 配置 DNS 和 DHCP 服务<a class="headerlink" href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-4-dns-dhcp" title="Permanent link">&para;</a></h2>
<p>DNS 和 DHCP 服务由 OpenWrt 的 dnsmasq 提供，首先配置域名 <code>pxe.hxp.lan</code> 解析到 HTTP 服务器，在 <code>Network -&gt; DHCP and DNS -&gt; Hostnames</code> 里，添加域名解析。之后在 <code>Network -&gt; DHCP and DNS -&gt; PXE/TFTP</code> 里，找到 <code>Special PXE boot options for Dnsmasq</code> 添加如下配置：
<img alt="DHCP配置-1" src="%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/TrueNAS/images/Screenshot%202025-06-15%20161300.png" />
注意这里 <code>DHCP Options</code> 为默认值。上级界面里，不勾选 <code>Enable TFTP server</code> ：
<img alt="DHCP配置-2" src="%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/TrueNAS/images/Screenshot%202025-06-15%20161504.png" />
配置完成如图所示。</p>
<h2 id="%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-5-ipxe-tftp">5. 编译 iPXE 镜像并上传至 TFTP<a class="headerlink" href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-5-ipxe-tftp" title="Permanent link">&para;</a></h2>
<p>这里使用 RHEL 9 进行编译，首先需要安装如下依赖：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>sudo<span class="w"> </span>yum<span class="w"> </span>install<span class="w"> </span>git<span class="w"> </span>gcc<span class="w"> </span>binutils<span class="w"> </span>make<span class="w"> </span>perl<span class="w"> </span>xz-devel<span class="w"> </span>mtools
</span></code></pre></div></td></tr></table></div>
<p>下载 iPXE 源码并进入源码目录：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-1-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/ipxe/ipxe.git
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="nb">cd</span><span class="w"> </span>src
</span></code></pre></div></td></tr></table></div>
<p>新建 <code>boot.ipxe</code> 文件，根据序列号启动：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-2-3">3</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-2-4">4</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-2-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>#!ipxe
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>echo Configure dhcp ....
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a>dhcp
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a>chain --replace http://pxe.hxp.lan/http-boot.ipxe
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a>shell
</span></code></pre></div></td></tr></table></div>
<p>根据MAC地址启动：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-3-3">3</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-3-4">4</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-3-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>#!ipxe
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>echo Serial number: ${serial}
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a>echo Configure dhcp ....
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a>dhcp
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a>chain --replace http://pxe.hxp.lan:31485/ipxe/${netX/mac}.ipxe
</span></code></pre></div></td></tr></table></div>
<p>这个 iPXE 仅负责将网卡 DHCP 获取到 IP 地址，并加载 <code>http://pxe.hxp.lan/http-boot.ipxe</code> ，如果后续需要修改 iPXE 则修改 HTTP 服务器上 <code>http-boot.ipxe</code> 而不是重新编译这个 iPXE 镜像。编译 iPXE 镜像：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-4-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>make<span class="w"> </span>bin-x86_64-efi/ipxe.efi<span class="w"> </span><span class="nv">EMBED</span><span class="o">=</span>boot.ipxe
</span></code></pre></div></td></tr></table></div>
<p>上传编译好的 ipxe.efi 到 TFTP 服务器（如果 TFTP 命令卡死，需要临时禁用防火墙）：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-5-2">2</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-5-3">3</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-5-4">4</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-5-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nb">cd</span><span class="w"> </span>bin-x86_64-efi
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a>tftp<span class="w"> </span><span class="m">172</span>.21.0.2<span class="w"> </span>-m<span class="w"> </span>binary<span class="w"> </span>-c<span class="w"> </span>put<span class="w"> </span>ipxe.efi
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a>touch<span class="w"> </span>autoexec.ipxe
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a>tftp<span class="w"> </span><span class="m">172</span>.21.0.2<span class="w"> </span>-m<span class="w"> </span>binary<span class="w"> </span>-c<span class="w"> </span>put<span class="w"> </span>autoexec.ipxe
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="nb">cd</span><span class="w"> </span>..
</span></code></pre></div></td></tr></table></div>
<p>同时，在 HTTP 服务器的根目录创建 <code>http-boot.ipxe</code> 如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-6-1">1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-6-2">2</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-6-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a>#!ipxe
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a>echo Serial number: ${serial}
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a>chain --replace http://pxe.hxp.lan/boot-${serial}.ipxe
</span></code></pre></div></td></tr></table></div>
<p>这个 iPXE 会输出自己的序列号，并加载 HTTP 服务器根目录下 <code>boot-[序列号].ipxe</code> 脚本，实现不同机器 PXE 启动时根据序列号拉取不同的脚本。</p>
<h2 id="%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-6-winpe-http">6. 制作 WinPE 镜像并上传至 HTTP 服务器<a class="headerlink" href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-6-winpe-http" title="Permanent link">&para;</a></h2>
<p>需要 1 台 Windows 电脑，先按照<a href="https://learn.microsoft.com/en-us/windows-hardware/get-started/adk-install">微软官方教程</a>安装 <code>Windows ADK</code> 和 <code>Windows PE add-on for the Windows ADK</code> ：
<img alt="下载ADK" src="%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/TrueNAS/images/Screenshot%202025-06-15%20163104.png" />
之后找到开始菜单里的 <code>部署和映像工具环境</code> ，使用管理员权限运行，会得到一个 CMD 窗口，输入以下命令：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-7-1">1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-7-2">2</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-7-3">3</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-7-4">4</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-7-5">5</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-7-6">6</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-7-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a>cd &quot;..\Windows Preinstallation Environment\amd64&quot;
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a>md C:\WinPE_amd64\mount
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a>Dism /Mount-Image /ImageFile:&quot;en-us\winpe.wim&quot; /index:1 /MountDir:&quot;C:\WinPE_amd64\mount&quot;
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4"></a>copype amd64 C:\temp\winpe\amd64
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5"></a>Dism /Unmount-Image /MountDir:&quot;C:\WinPE_amd64\mount&quot; /Commit
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6"></a>rd C:\WinPE_amd64\mount
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7"></a>rd C:\WinPE_amd64
</span></code></pre></div></td></tr></table></div>
<p>之后将 <code>C:\temp\winpe\amd64</code> 复制到 HTTP 服务器的根目录下。</p>
<h2 id="%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-7-windows">7. 修改 Windows 安装镜像增加驱动<a class="headerlink" href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-7-windows" title="Permanent link">&para;</a></h2>
<p>对 Windows 安装镜像 sources 目录下 boot.wim 和 install.wim 做如下操作（驱动可在 <code>C:\Windows\System32\DriverStore\FileRepository</code> 目录查找）：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-8-1">1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-8-2">2</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-8-3">3</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-8-4">4</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-8-5">5</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-8-6">6</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-8-7">7</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-8-8">8</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-8-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a>md C:\WinPE_amd64\mount
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a>Dism /Mount-Image /ImageFile:&quot;C:\temp\boot.wim&quot; /Index:1 /MountDir:&quot;C:\WinPE_amd64\mount&quot;
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a>Dism /Image:&quot;C:\WinPE_amd64\mount&quot; /Add-Driver /Driver:&quot;C:\Windows\System32\DriverStore\FileRepository&quot; /ForceUnsigned /Recurse
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a>Dism /Unmount-Image /MountDir:&quot;C:\WinPE_amd64\mount&quot; /Commit
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5"></a>Dism /Mount-Image /ImageFile:&quot;C:\temp\install.wim&quot; /Index:4 /MountDir:&quot;C:\WinPE_amd64\mount&quot;
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6"></a>Dism /Image:&quot;C:\WinPE_amd64\mount&quot; /Add-Driver /Driver:&quot;C:\Windows\System32\DriverStore\FileRepository&quot; /ForceUnsigned /Recurse
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7"></a>Dism /Unmount-Image /MountDir:&quot;C:\WinPE_amd64\mount&quot; /Commit
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8"></a>rd C:\WinPE_amd64\mount
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9"></a>rd C:\WinPE_amd64
</span></code></pre></div></td></tr></table></div>
<p>其中 install.wim 命令应当填入的序号在这里查看：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-9-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a>Dism /Get-ImageInfo /ImageFile:&quot;C:\temp\install.wim&quot;
</span></code></pre></div></td></tr></table></div>
<h2 id="%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-8-windows-server">8. 安装 Windows Server<a class="headerlink" href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-8-windows-server" title="Permanent link">&para;</a></h2>
<p>在 HTTP 服务器上，根目录存放文件 <code>boot-[序列号].ipxe</code> 为如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-10-10">10</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-10-11">11</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-10-12">12</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-10-13">13</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-10-14">14</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-10-15">15</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-10-16">16</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-10-17">17</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-10-18">18</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-10-19">19</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-10-20">20</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-10-21">21</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-10-22">22</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-10-23">23</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-10-24">24</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-10-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a>#!ipxe
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3"></a># Attach SAN storage
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4"></a>echo attaching SAN storage
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5"></a>set keep-san 1
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6"></a>sanhook iscsi:172.21.0.2::::iqn.2005-10.org.freenas.ctl:windows-server-2025
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7"></a>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8"></a># Set webroot
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9"></a>set webroot http://pxe.hxp.lan
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10"></a>echo Webroot is ${webroot}
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11"></a>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12"></a>#Set architecture
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13"></a>cpuid --ext 29 &amp;&amp; set arch amd64 || set arch x86
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14"></a>echo ARCH is ${arch}
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15"></a>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16"></a>#Load wimboot
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17"></a>echo Loading Wimboot ...
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18"></a>kernel ${webroot}/wimboot
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19"></a>initrd ${webroot}/${arch}/media/Boot/BCD BCD
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20"></a>initrd ${webroot}/${arch}/media/Boot/boot.sdi boot.sdi
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21"></a>initrd ${webroot}/${arch}/media/sources/boot.wim boot.wim
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22"></a>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23"></a>#boot winpe
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24"></a>echo booting winpe
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25"></a>boot
</span></code></pre></div></td></tr></table></div>
<p>让待装机服务器从 PXE 启动：
<img alt="WinPE启动" src="%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/TrueNAS/images/Screenshot%202025-06-15%20170514.png" /></p>
<p>提前准备 SMB 服务器并将 Windows 安装 ISO 解压至 winsrv2025 目录，启动进入 WinPE 后，进入 CMD 命令行，按下 Ctrl-C ，然后挂载 SMB 目录到 <code>Z:</code> 并运行 <code>setup.exe</code> ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-11-1">1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-11-2">2</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-11-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a>net use Z: \\172.21.0.2\downloads\others\winsrv2025
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2"></a>Z:
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3"></a>setup.exe
</span></code></pre></div></td></tr></table></div>
<p><img alt="启动setup.exe" src="%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF/TrueNAS/images/Screenshot%202025-06-15%20171854.png" /></p>
<p>如果安装失败可能需要点击 <code>use previous version of windows setup</code> ，安装系统完成后，修改 <code>boot-[序列号].ipxe</code> 为如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-12-1">1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-12-2">2</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-12-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a>echo booting from SAN storage
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2"></a>set keep-san 1
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3"></a>sanboot iscsi:172.21.0.2::::iqn.2005-10.org.freenas.ctl:windows-server-2025
</span></code></pre></div></td></tr></table></div>
<p>之后进入 PXE 则会从 iSCSI 启动。</p>
<h2 id="%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-9-windows-server">9. 激活 Windows Server<a class="headerlink" href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-9-windows-server" title="Permanent link">&para;</a></h2>
<p>激活之前，先查看当前 Windows 都有哪些版本，并将其转换为非试用版本：</p>
<div class="language-powershell highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-13-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="n">DISM</span><span class="p">.</span><span class="n">exe</span> <span class="p">/</span><span class="n">Online</span> <span class="p">/</span><span class="nb">Get-TargetEditions</span>
</span></code></pre></div></td></tr></table></div>
<p>转换为非试用的 Datacenter 版本：</p>
<div class="language-powershell highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-14-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="n">DISM</span><span class="p">.</span><span class="n">exe</span> <span class="p">/</span><span class="n">online</span> <span class="p">/</span><span class="nb">Set-Edition</span><span class="p">:</span><span class="n">ServerDatacenter</span> <span class="p">/</span><span class="n">ProductKey</span><span class="p">:</span><span class="n">D764K</span><span class="p">-</span><span class="n">2NDRG</span><span class="p">-</span><span class="n">47T6Q-P8T8W-YP6DF</span> <span class="p">/</span><span class="n">AcceptEula</span>
</span></code></pre></div></td></tr></table></div>
<p>重启后，使用<a href="https://learn.microsoft.com/en-us/windows-server/get-started/kms-client-activation-keys?tabs=server2025%2Cwindows1110ltsc%2Cversion1803%2Cwindows81">官方 KMS 密钥</a>激活：</p>
<div class="language-powershell highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-15-1">1</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-15-2">2</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-15-3">3</a></span>
<span class="normal"><a href="#%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025-__codelineno-15-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="n">slmgr</span> <span class="p">/</span><span class="n">ipk</span> <span class="n">D764K</span><span class="p">-</span><span class="n">2NDRG</span><span class="p">-</span><span class="n">47T6Q-P8T8W-YP6DF</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="n">slmgr</span> <span class="p">/</span><span class="n">skms</span> <span class="n">openwrt</span><span class="p">.</span><span class="n">hxp</span><span class="p">.</span><span class="n">lan</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="n">slmgr</span> <span class="p">/</span><span class="n">ato</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="n">slmgr</span> <span class="p">/</span><span class="n">dlv</span>
</span></code></pre></div></td></tr></table></div>
<p>这里使用了 OpenWrt 作为 KMS 服务器。</p></section></section></section>
                    <section class='print-page md-section' id='section-5' heading-number='5'>
                        <h1>运维开发<a class='headerlink' href='#section-5' title='Permanent link'></a>
                        </h1>
                    
                    <section class='print-page md-section' id='section-5-1' heading-number='5.1'>
                        <h1>AWX<a class='headerlink' href='#section-5-1' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98" heading-number="5.1.1"><nav class='md-tags'><span class='md-tag'>Kubernetes</span><span class='md-tag'>PostgreSQL</span><span class='md-tag'>AWX</span></nav><h1 id="awx-stolon">AWX 和 stolon 高可用调优<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-awx-stolon" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-1-k8s-awx-stolon">1. K8S 故障后 AWX 和 stolon 切换时间过长问题解决方案<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-1-k8s-awx-stolon" title="Permanent link">&para;</a></h2>
<p>在 k8s 上安装完成 AWX 后，实际测试发现在节点故障时切换时间过长，这是因为 k8s 默认设置里，当一个 k8s 节点 unreachable 或者 not-ready 时，容器会容忍这个节点 5 分钟才会自动漂移。可以修改为更短的时间，例如 10 秒。需要修改<code>awx.yaml</code>的<code>tolerations</code>。同时，为了防止容器被调度到相同的节点上，需要修改<code>task_topology_spread_constraints</code>和<code>web_topology_spread_constraints</code>：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-19">19</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-20">20</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-21">21</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-22">22</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-23">23</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-24">24</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-25">25</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-26">26</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-27">27</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-0-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nn">---</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">awx.ansible.com/v1beta1</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWX</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">  </span><span class="nt">task_topology_spread_constraints</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="no">- maxSkew: 1</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">      </span><span class="no">topologyKey: kubernetes.io/hostname</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">      </span><span class="no">whenUnsatisfiable: DoNotSchedule</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">      </span><span class="no">labelSelector:</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">        </span><span class="no">matchLabels:</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">          </span><span class="no">app.kubernetes.io/name: &quot;awx-task&quot;</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">  </span><span class="nt">web_topology_spread_constraints</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">    </span><span class="no">- maxSkew: 1</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">      </span><span class="no">topologyKey: kubernetes.io/hostname</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">      </span><span class="no">whenUnsatisfiable: DoNotSchedule</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">      </span><span class="no">labelSelector:</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">        </span><span class="no">matchLabels:</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">          </span><span class="no">app.kubernetes.io/name: &quot;awx-web&quot;</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">  </span><span class="nt">tolerations</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">    </span><span class="no">- key: &quot;node.kubernetes.io/not-ready&quot;</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">      </span><span class="no">operator: &quot;Exists&quot;</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">      </span><span class="no">effect: &quot;NoExecute&quot;</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">      </span><span class="no">tolerationSeconds: 10</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="w">    </span><span class="no">- key: &quot;node.kubernetes.io/unreachable&quot;</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">      </span><span class="no">operator: &quot;Exists&quot;</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">      </span><span class="no">effect: &quot;NoExecute&quot;</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="w">      </span><span class="no">tolerationSeconds: 10</span>
</span></code></pre></div></td></tr></table></div>
<p>修改之后重新 apply 下这个 yaml 文件生效。同时，stolon 也有同样的问题，需要修改<code>stolon-keeper.yaml</code>、<code>stolon-proxy.yaml</code> 和<code>stolon-sentinel.yaml</code>，以<code>stolon-proxy.yaml</code>为例：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-23">23</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-24">24</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-25">25</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-26">26</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-27">27</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-__codelineno-1-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">stolon-proxy</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">      </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">stolon-proxy</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">      </span><span class="nt">topologySpreadConstraints</span><span class="p">:</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">maxSkew</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">          </span><span class="nt">topologyKey</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes.io/hostname</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">          </span><span class="nt">whenUnsatisfiable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DoNotSchedule</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">          </span><span class="nt">labelSelector</span><span class="p">:</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">            </span><span class="nt">matchLabels</span><span class="p">:</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">              </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">stolon-proxy</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">      </span><span class="nt">tolerations</span><span class="p">:</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;node.kubernetes.io/not-ready&quot;</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">          </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Exists&quot;</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">          </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;NoExecute&quot;</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">          </span><span class="nt">tolerationSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;node.kubernetes.io/unreachable&quot;</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">          </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Exists&quot;</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">          </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;NoExecute&quot;</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="w">          </span><span class="nt">tolerationSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</span></code></pre></div></td></tr></table></div>
<h%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-2">2. 参考链接<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98-2" title="Permanent link">&para;</a></h2>
<p><a href="https://github.com/ansible/awx-operator/blob/0d1fa239a56c55202167cb833a72f495928442fc/docs/user-guide/advanced-configuration/assigning-awx-pods-to-specific-nodes.md?plain=1#L20">https://github.com/ansible/awx-operator/blob/0d1fa239a56c55202167cb833a72f495928442fc/docs/user-guide/advanced-configuration/assigning-awx-pods-to-specific-nodes.md?plain=1#L20</a></p></section><section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql" heading-number="5.1.2"><nav class='md-tags'><span class='md-tag'>Kubernetes</span><span class='md-tag'>PostgreSQL</span></nav><h1 id="stolon-postgresql">使用 stolon 安装高可用 PostgreSQL<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-stolon-postgresql" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-1">1. 准备工作<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-1" title="Permanent link">&para;</a></h2>
<p>stolon 是一种安装在 kubernetes 的 PostgreSQL 数据库，因此需要一套完整的 k8s 集群，且必须有至少 1 个 StorageClass，推荐是 local-path-provisioner。</p>
<h%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-2">2. 下载配置文件<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-2" title="Permanent link">&para;</a></h2>
<p>以下 stolon 配置文件根据 <a href="https://github.com/sorintlab/stolon/tree/master/examples/kubernetes">https://github.com/sorintlab/stolon/tree/master/examples/kubernetes</a> 的配置文件修改，把 namespace 改成 stolon，image 修改为 sorintlab/stolon:v0.17.0-pg13</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-3-service-account">3. 新增 service account<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-3-service-account" title="Permanent link">&para;</a></h2>
<p>创建 role.yaml：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-0-19">19</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-0-20">20</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-0-21">21</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-0-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1"># This is an example and generic rbac role definition for stolon. It could be</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="c1"># fine tuned and split per component.</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="c1"># The required permission per component should be:</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="c1"># keeper/proxy/sentinel: update their own pod annotations</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="c1"># sentinel/stolonctl: get, create, update configmaps</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="c1"># sentinel/stolonctl: list components pods</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="c1"># sentinel/stolonctl: get components pods annotations</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Role</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">stolon</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">stolon</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="nt">rules</span><span class="p">:</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;&quot;</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">    </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pods</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">configmaps</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">events</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;*&quot;</span>
</span></code></pre></div></td></tr></table></div>
<p>创建 role-binding.yaml：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-1-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RoleBinding</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">stolon</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">stolon</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="nt">roleRef</span><span class="p">:</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Role</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">stolon</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="nt">subjects</span><span class="p">:</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">stolon</span>
</span></code></pre></div></td></tr></table></div>
<p>新增 service account：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-2-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>kubectl create namespace stolon
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>kubectl apply -f role.yaml -f role-binding.yaml
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-4-stolon-configmap">4. 创建 stolon 集群的 configmap<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-4-stolon-configmap" title="Permanent link">&para;</a></h2>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>kubectl -n stolon run -i -t stolonctl --image=sorintlab/stolon:v0.17.0-pg13 --restart=Never --rm -- /usr/local/bin/stolonctl --cluster-name=kube-stolon --store-backend=kubernetes --kube-resource-kind=configmap init
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-5-stolon">5. 创建 stolon 实例<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-5-stolon" title="Permanent link">&para;</a></h2>
<p>获取集群的 storage class 信息：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-4-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>kubectl get storageclasses.storage.k8s.io
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-5-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>NAME            PROVISIONER           RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a>csi-cephfs-sc   cephfs.csi.ceph.com   Delete
</span></code></pre></div></td></tr></table></div>
<p>使用 csi-cephfs-sc 作为 storage class，修改 stolon-keeper.yaml：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-6-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-6-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="nt">volumeClaimTemplates</span><span class="p">:</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">data</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="w">      </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">        </span><span class="nt">volume.alpha.kubernetes.io/storage-class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">csi-cephfs-sc</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="w">      </span><span class="nt">accessModes</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;ReadWriteOnce&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="w">      </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="w">        </span><span class="nt">requests</span><span class="p">:</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">          </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4Gi</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="w">      </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">csi-cephfs-sc</span>
</span></code></pre></div></td></tr></table></div>
<p>设置一个密码，将其 base64 编码：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-7-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a>echo &#39;********&#39; | base64
</span></code></pre></div></td></tr></table></div>
<p>修改 secret.yaml 中的 password 为 base64 的输出：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-8-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-8-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-8-3">3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-8-4">4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-8-5">5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-8-6">6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-8-7">7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-8-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="nn">---</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">stolon</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Opaque</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="nt">data</span><span class="p">:</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">  </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;***********&quot;</span>
</span></code></pre></div></td></tr></table></div>
<p>创建资源：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-9-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a>kubectl -n stolon create -f stolon-sentinel.yaml -f secret.yaml -f stolon-keeper.yaml -f stolon-proxy.yaml -f stolon-proxy-service.yaml
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-6-stolon">6. 将 stolon 设置成三副本<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-6-stolon" title="Permanent link">&para;</a></h2>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-10-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-10-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-10-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a>kubectl -n stolon scale deployment stolon-proxy --replicas 3
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a>kubectl -n stolon scale deployment stolon-sentinel --replicas 3
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3"></a>kubectl -n stolon scale statefulset stolon-keeper --replicas 3
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-7-postgresql">7. 测试 PostgreSQL 连通性<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-7-postgresql" title="Permanent link">&para;</a></h2>
<p>首先临时创建一个 PostgreSQL 容器：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-11-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a>kubectl -n stolon run -i -t stolon-client --image=sorintlab/stolon:v0.17.0-pg13 --restart=Never --rm -- /bin/bash
</span></code></pre></div></td></tr></table></div>
<p>在容器里连接数据库：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-12-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a>psql --host stolon-proxy-service  --port 5432 postgres -U stolon -W
</span></code></pre></div></td></tr></table></div>
<p>密码为刚刚 base64 设置的密码。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-8">8. 检查数据库状态<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-8" title="Permanent link">&para;</a></h2>
<p>首先创建一个临时的容器：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-13-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a>kubectl -n stolon run -i -t stolon-client --image=sorintlab/stolon:v0.17.0-pg13 --restart=Never --rm -- /bin/bash
</span></code></pre></div></td></tr></table></div>
<p>在容器里使用 stolonctl 检查集群状态：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-14-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a>/usr/local/bin/stolonctl --cluster-name=kube-stolon --store-backend=kubernetes --kube-resource-kind=configmap status
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-16">16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-17">17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-18">18</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-19">19</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-20">20</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-21">21</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-22">22</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-23">23</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-24">24</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-25">25</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-26">26</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-27">27</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-28">28</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-29">29</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql-__codelineno-15-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1"></a>=== Active sentinels ===
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2"></a>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3"></a>ID      LEADER
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4"></a>558a0979    false
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5"></a>b509f383    true
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6"></a>bc1deda2    false
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7"></a>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8"></a>=== Active proxies ===
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9"></a>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10"></a>ID
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11"></a>65e8c81e
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12"></a>6c322c41
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13"></a>c19abd6d
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14"></a>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15"></a>=== Keepers ===
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16"></a>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17"></a>UID HEALTHY PG LISTENADDRESS    PG HEALTHY  PG WANTEDGENERATION PG CURRENTGENERATION
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18"></a>keeper0 true    172.18.209.38:5432  true        4           4
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19"></a>keeper1 true    172.18.122.32:5432  true    2   2
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20"></a>keeper2 true    172.18.97.20:5432   true    2   2
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21"></a>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22"></a>=== Cluster Info ===
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23"></a>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24"></a>Master Keeper: keeper0
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25"></a>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26"></a>===== Keepers/DB tree =====
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27"></a>
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28"></a>keeper0 (master)
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29"></a>├─keeper2
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30"></a>└─keeper1
</span></code></pre></div></td></tr></table></div></section><section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7" heading-number="5.1.3"><nav class='md-tags'><span class='md-tag'>Kubernetes</span><span class='md-tag'>AWX</span></nav><h1 id="awx-237">安装 AWX-23.7<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-awx-237" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-1">1. 准备工作<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-1" title="Permanent link">&para;</a></h2>
<p>AWX 高版本必须依托于 k8s 进行安装，且需要使用 PostgreSQL-13 数据库。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-2-awx-operator">2. 安装 awx-operator<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-2-awx-operator" title="Permanent link">&para;</a></h2>
<p>编辑<code>kustomization.yaml</code>：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-0-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kustomize.config.k8s.io/v1beta1</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Kustomization</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="c1"># Find the latest tag here: https://github.com/ansible/awx-operator/releases</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">github.com/ansible/awx-operator/config/default?ref=2.11.0</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="c1"># Set the image tags to match the git version from above</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="nt">images</span><span class="p">:</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">quay.io/ansible/awx-operator</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="nt">newTag</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2.11.0</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="c1"># Specify a custom namespace in which to install AWX</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">awx</span>
</span></code></pre></div></td></tr></table></div>
<p>生成 yaml 文件：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>kubectl apply -k . -o yaml --dry-run=client &gt; awx-operator.yaml
</span></code></pre></div></td></tr></table></div>
<p>如果需要离线部署，需要把<code>awx-operator.yaml</code>中<code>imagePullPolicy: Always</code>修改为<code>imagePullPolicy: IfNotPresent</code>，
将 yaml 文件应用：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-2-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>kubectl create namespace awx
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>kubectl -n awx apply -f awx-operator.yaml
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-3-postgresql">3. 配置 PostgreSQL 数据库用户<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-3-postgresql" title="Permanent link">&para;</a></h2>
<p>AWX 存储数据需要一套 PostgreSQL-13 数据库，数据库需要新建用户 awx 和数据库 awx：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>psql -h postgresql-13 -U postgres
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-4-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-4-3">3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-4-4">4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-4-5">5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-4-6">6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-4-7">7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-4-8">8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-4-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>Password for user postgres:
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a>psql (13.11, server 13.0 (Debian 13.0-1.pgdg100+1))
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a>Type &quot;help&quot; for help.
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a>postgres=# CREATE USER awx WITH ENCRYPTED PASSWORD &#39;********&#39;;
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a>CREATE ROLE
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a>postgres=# CREATE DATABASE awx OWNER awx;
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a>CREATE DATABASE
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a>postgres=# exit
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-4-awx">4. 安装 AWX 并配置其使用外部数据库<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-4-awx" title="Permanent link">&para;</a></h2>
<p>定义 AWX 资源，新建<code>awx.yaml</code>：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-16">16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-17">17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-18">18</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-19">19</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-20">20</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-21">21</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-22">22</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-23">23</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-24">24</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-25">25</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-26">26</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-27">27</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-28">28</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-29">29</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-30">30</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-31">31</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-32">32</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-33">33</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-5-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nn">---</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">awx.ansible.com/v1beta1</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWX</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">awx</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">awx</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">  </span><span class="nt">ingress_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ingress</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">  </span><span class="nt">ingress_path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w">  </span><span class="nt">ingress_hosts</span><span class="p">:</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">awx.y.bocsys.cn</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">  </span><span class="nt">ee_images</span><span class="p">:</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">awx-ee</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">quay.io/ansible/awx-ee:23.7.0</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="w">  </span><span class="nt">control_plane_ee_image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">quay.io/ansible/awx-ee:23.7.0</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="w">  </span><span class="nt">init_container_image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">quay.io/ansible/awx-ee</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="w">  </span><span class="nt">init_container_image_version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">23.7.0</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18"></a><span class="w">  </span><span class="nt">task_replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="w">  </span><span class="nt">web_replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="w">  </span><span class="nt">task_topology_spread_constraints</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21"></a><span class="w">    </span><span class="no">- maxSkew: 1</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="w">      </span><span class="no">topologyKey: kubernetes.io/hostname</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23"></a><span class="w">      </span><span class="no">whenUnsatisfiable: DoNotSchedule</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24"></a><span class="w">      </span><span class="no">labelSelector:</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25"></a><span class="w">        </span><span class="no">matchLabels:</span>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26"></a><span class="w">          </span><span class="no">app.kubernetes.io/name: &quot;awx-task&quot;</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27"></a><span class="w">  </span><span class="nt">web_topology_spread_constraints</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28"></a><span class="w">    </span><span class="no">- maxSkew: 1</span>
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29"></a><span class="w">      </span><span class="no">topologyKey: kubernetes.io/hostname</span>
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30"></a><span class="w">      </span><span class="no">whenUnsatisfiable: DoNotSchedule</span>
</span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31"></a><span class="w">      </span><span class="no">labelSelector:</span>
</span><span id="__span-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32"></a><span class="w">        </span><span class="no">matchLabels:</span>
</span><span id="__span-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33"></a><span class="w">          </span><span class="no">app.kubernetes.io/name: &quot;awx-web&quot;</span>
</span><span id="__span-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34"></a><span class="w">  </span><span class="nt">postgres_configuration_secret</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">awx-postgres-configuration</span>
</span></code></pre></div></td></tr></table></div>
<p>新建数据库配置<code>awx-postgres-configuration.yaml</code>：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-6-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-6-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-6-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-6-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-6-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-6-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="nn">---</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">awx-postgres-configuration</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">awx</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="nt">stringData</span><span class="p">:</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="w">  </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgresql-13</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;5432&quot;</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">  </span><span class="nt">database</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">awx</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">awx</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="w">  </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;********&quot;</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="w">  </span><span class="nt">sslmode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prefer</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unmanaged</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Opaque</span>
</span></code></pre></div></td></tr></table></div>
<p>将两个 yaml 文件应用：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-7-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-7-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a>kubectl -n awx apply -f awx-postgres-configuration.yaml
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a>kubectl -n awx apply -f awx.yaml
</span></code></pre></div></td></tr></table></div>
<p>观察部署进度：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-8-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a>kubectl -n awx logs -f deployments/awx-operator-controller-manager
</span></code></pre></div></td></tr></table></div>
<p>获取默认 admin 密码：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-__codelineno-9-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a>kubectl -n awx get secret awx-admin-password -o jsonpath=&quot;{.data.password}&quot; | base64 --decode; echo
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-5">5. 参考链接<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7-5" title="Permanent link">&para;</a></h2>
<p><a href="https://github.com/ansible/awx-operator/blob/devel/docs/installation/basic-install.md">https://github.com/ansible/awx-operator/blob/devel/docs/installation/basic-install.md</a></p>
<p><a href="https://elatov.github.io/2022/03/deploying-awx-in-k8s-with-awx-operator/">https://elatov.github.io/2022/03/deploying-awx-in-k8s-with-awx-operator/</a></p>
<p><a href="https://github.com/ansible/awx-operator/blob/8391ed3501ff326647485b7272e537942da0dd68/docs/user-guide/database-configuration.md?plain=1#L7">https://github.com/ansible/awx-operator/blob/8391ed3501ff326647485b7272e537942da0dd68/docs/user-guide/database-configuration.md?plain=1#L7</a></p>
<p><a href="https://tecadmin.net/postgresql-allow-remote-connections/">https://tecadmin.net/postgresql-allow-remote-connections/</a></p>
<p><a href="https://computingforgeeks.com/install-postgresql-13-on-centos-rhel/">https://computingforgeeks.com/install-postgresql-13-on-centos-rhel/</a></p>
<p><a href="https://github.com/ansible/awx-operator/issues/1190">https://github.com/ansible/awx-operator/issues/1190</a></p></section><section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81" heading-number="5.1.4"><nav class='md-tags'><span class='md-tag'>Keycloak</span><span class='md-tag'>AWX</span></nav><h1 id="awx-239-saml-keycloak-24">AWX-23.9 使用 SAML 对接 Keycloak-24 认证<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-awx-239-saml-keycloak-24" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-1-ssl">1. 生成 SSL 证书<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-1-ssl" title="Permanent link">&para;</a></h2>
<p>在任意 Linux 执行以下命令生成 SSL 证书：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>openssl<span class="w"> </span>req<span class="w"> </span>-subj<span class="w"> </span><span class="s2">&quot;/C=CN/ST=Beijing/L=Haidian/O=awx.hxp.lan/CN=awx.hxp.lan&quot;</span><span class="w"> </span>-sha256<span class="w"> </span>-newkey<span class="w"> </span>rsa:2048<span class="w"> </span>-nodes<span class="w"> </span>-keyout<span class="w"> </span>key.pem<span class="w"> </span>-x509<span class="w"> </span>-days<span class="w"> </span><span class="m">3650</span><span class="w"> </span>-out<span class="w"> </span>certificate.pem
</span></code></pre></div></td></tr></table></div>
<p>此 SSL 证书直接申请了 10 年有效期。记得在 10 年后更新。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-2-awx">2. 修改 AWX 配置<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-2-awx" title="Permanent link">&para;</a></h2>
<p>点击 <code>设置</code> -&gt; <code>杂项系统</code> ，修改 <code>服务的基本 URL</code> 为 AWX 的公网 URL：</p>
<p><img alt="" src="%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/images/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250302153500.png" /></p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-3-awx-saml">3. 在 AWX 上配置 SAML 认证<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-3-awx-saml" title="Permanent link">&para;</a></h2>
<p>点击 <code>设置</code> -&gt; <code>SAML</code> ，填写 Keycloak SAML 服务器配置：</p>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-31-saml-id">3.1 SAML 服务提供商实体 ID<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-31-saml-id" title="Permanent link">&para;</a></h3>
<p>填写 <code>awx-saml</code></p>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-32-saml">3.2 SAML 服务提供商公共证书<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-32-saml" title="Permanent link">&para;</a></h3>
<p>上传生成的证书 <code>certificate.pem</code></p>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-33-saml">3.3 SAML 服务提供商私钥<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-33-saml" title="Permanent link">&para;</a></h3>
<p>上传生成的密钥 <code>key.pem</code></p>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-34-saml">3.4 SAML 服务提供商机构信息<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-34-saml" title="Permanent link">&para;</a></h3>
<p>填写以下内容：</p>
<div class="language-json highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-1-4">4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-1-5">5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-1-6">6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-1-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="p">{</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">  </span><span class="nt">&quot;en-US&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">    </span><span class="nt">&quot;displayname&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Keycloak&quot;</span><span class="p">,</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Keycloak&quot;</span><span class="p">,</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">    </span><span class="nt">&quot;url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://keycloak.hxp.lan:30081/&quot;</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-35-saml">3.5 SAML 服务提供商技术联系人<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-35-saml" title="Permanent link">&para;</a></h3>
<p>填写以下内容：</p>
<div class="language-json highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-2-3">3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-2-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="p">{</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">  </span><span class="nt">&quot;emailAddress&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;awx@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">  </span><span class="nt">&quot;givenName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;awx&quot;</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-36-saml">3.6 SAML 服务提供商支持联系人<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-36-saml" title="Permanent link">&para;</a></h3>
<p>填写以下内容：</p>
<div class="language-json highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-3-3">3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-3-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="p">{</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">  </span><span class="nt">&quot;emailAddress&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;awx@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">  </span><span class="nt">&quot;givenName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;awx&quot;</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-37-saml">3.7 SAML 启用的身份提供商<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-37-saml" title="Permanent link">&para;</a></h3>
<p>填写以下内容：</p>
<div class="language-json highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-4-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-4-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-4-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="p">{</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">  </span><span class="nt">&quot;Keycloak&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">    </span><span class="nt">&quot;attr_email&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;email&quot;</span><span class="p">,</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="nt">&quot;attr_first_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;first_name&quot;</span><span class="p">,</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="nt">&quot;attr_last_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;last_name&quot;</span><span class="p">,</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">    </span><span class="nt">&quot;attr_user_permanent_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;name_id&quot;</span><span class="p">,</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">    </span><span class="nt">&quot;attr_username&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;username&quot;</span><span class="p">,</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span><span class="nt">&quot;entity_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://keycloak.hxp.lan:30081/realms/awx&quot;</span><span class="p">,</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">    </span><span class="nt">&quot;url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://keycloak.hxp.lan:30081/realms/awx/protocol/saml&quot;</span><span class="p">,</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">    </span><span class="nt">&quot;x509cert&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;-----BEGIN CERTIFICATE-----MIIDaz*****X7Z-----END CERTIFICATE-----&quot;</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>x509cert 内容这样生成：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-5-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>sed<span class="w"> </span><span class="s1">&#39;:a;N;$!ba;s/\n//g&#39;</span><span class="w"> </span>certificate.pem<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s/^-----BEGIN CERTIFICATE-----//;s/-----END CERTIFICATE-----$//&#39;</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-38-saml">3.8 SAML 机构映射<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-38-saml" title="Permanent link">&para;</a></h3>
<div class="language-json highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-6-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-__codelineno-6-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="p">{</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="w">  </span><span class="nt">&quot;Default&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="w">    </span><span class="nt">&quot;users&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="w">  </span><span class="p">},</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">  </span><span class="nt">&quot;Keycloak&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">    </span><span class="nt">&quot;admins&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="w">    </span><span class="nt">&quot;remove_admins&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="w">    </span><span class="nt">&quot;remove_users&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="w">    </span><span class="nt">&quot;users&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-39-saml">3.9 SAML 机构属性映射<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-39-saml" title="Permanent link">&para;</a></h3>
<p>默认值</p>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-310-saml">3.10 SAML 团队映射<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-310-saml" title="Permanent link">&para;</a></h3>
<p>默认值</p>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-311-saml">3.11 SAML 团队属性映射<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-311-saml" title="Permanent link">&para;</a></h3>
<p>默认值</p>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-312-saml-user-flags-attribute-mapping">3.12 SAML User Flags Attribute Mapping<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-312-saml-user-flags-attribute-mapping" title="Permanent link">&para;</a></h3>
<p>默认值</p>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-313-saml">3.13 SAML 安全配置<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-313-saml" title="Permanent link">&para;</a></h3>
<p>默认值</p>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-314-saml">3.14 SAML 服务提供商额外配置数据<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-314-saml" title="Permanent link">&para;</a></h3>
<p>默认值</p>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-315-saml-idp-extra_data">3.15 SAML IDP 到 extra_data 属性映射<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-315-saml-idp-extra_data" title="Permanent link">&para;</a></h3>
<p>默认值</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-4-saml-keycloak">4. 获取 SAML 配置并导入 Keycloak<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-4-saml-keycloak" title="Permanent link">&para;</a></h2>
<p>在 AWX 上完成 SAML 配置后，配置页面上 <code>SAML 服务提供商元数据 URL</code> 可下载 SAML 配置，下载此配置后，在 Keycloak 上新建 Realm 名称 awx ，点击 <code>Clients</code> -&gt; <code>Import client</code> 将此配置导入：</p>
<p><img alt="" src="%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/images/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250302182104.png" /></p>
<p>导入配置时需要将 <code>Client signature required</code> 关闭。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-5-keycloak">5. Keycloak 导入证书<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-5-keycloak" title="Permanent link">&para;</a></h2>
<p>自签的 SSL 证书需要导入到 Keycloak ，点击 <code>Realm Settings</code> -&gt; <code>Keys</code> -&gt; <code>Add provider</code> 添加类型为 <code>rsa</code> 的密钥：</p>
<p><img alt="" src="%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/images/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250302160258.png" /></p>
<p>选择证书和密钥并保存：</p>
<p><img alt="" src="%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/images/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250302181623.png" /></p>
<p>注意这里的优先级必须足够大。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-6-keycloak">6. Keycloak 配置用户信息映射<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-6-keycloak" title="Permanent link">&para;</a></h2>
<p>进入 <code>Client scopes</code> -&gt; <code>role_list</code> -&gt; <code>Mappers</code> -&gt; <code>Add mapper</code> -&gt; <code>By configuration</code> ，创建如下 <code>User Attribute</code> 映射：</p>
<p><img alt="" src="%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/images/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250302162606.png" /></p>
<p>创建如下 <code>User Property</code> 映射：</p>
<p><img alt="" src="%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/images/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250302172320.png" /></p>
<p><img alt="" src="%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/images/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250302172345.png" /></p>
<p><img alt="" src="%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/images/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250302172407.png" /></p>
<p><img alt="" src="%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/images/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250302172428.png" /></p>
<p>进入 <code>Client scopes</code> -&gt; <code>role_list</code> -&gt; <code>Mappers</code> -&gt; <code>role list</code> ，开启 <code>Single Role Attribute</code> 选项：</p>
<p><img alt="" src="%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/images/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250302182610.png" /></p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-7">7. 登录验证<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-7" title="Permanent link">&para;</a></h2>
<p>完成以后，去 AWX 点击这里登录：</p>
<p><img alt="" src="%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/images/%E6%88%AA%E5%9B%BE%E5%BD%95%E5%B1%8F_org.deepin.browser_20240306175906.png" /></p>
<p>测试用户名、电子邮箱、姓名能否正常获取：</p>
<p><img alt="" src="%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/images/%E6%88%AA%E5%9B%BE%E5%BD%95%E5%B1%8F_Navigator_20240306180102.png" /></p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-8">8. 其它设置<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-8" title="Permanent link">&para;</a></h2>
<p>可以在 <code>设置</code> -&gt; <code>其它身份验证</code> 里设置 <code>登录重定向覆写 URL</code> 为 <code>/sso/login/saml/?idp=Keycloak</code> 来让 Keycloak SAML 为默认登陆选项。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-9">9. 参考文献<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81-9" title="Permanent link">&para;</a></h2>
<p><a href="https://dev.to/rpelisse/automate-your-sso-with-ansible-and-keycloak-o1k">https://dev.to/rpelisse/automate-your-sso-with-ansible-and-keycloak-o1k</a></p>
<p><a href="https://docs.ansible.com/ansible-tower/latest/html/administration/ent_auth.html#saml-authentication-settings">https://docs.ansible.com/ansible-tower/latest/html/administration/ent_auth.html#saml-authentication-settings</a></p>
<p><a href="https://github.com/ansible/awx/issues/5570">https://github.com/ansible/awx/issues/5570</a></p>
<p><a href="https://github.com/ansible/awx/issues/1016">https://github.com/ansible/awx/issues/1016</a></p>
<p><a href="https://github.com/ansible/awx/issues/4814">https://github.com/ansible/awx/issues/4814</a></p>
<p><a href="https://github.com/ansible/awx/issues/13226">https://github.com/ansible/awx/issues/13226</a></p>
<p><a href="https://www.ansible.com/blog/red-hat-single-sign-on-integration-with-ansible-tower">https://www.ansible.com/blog/red-hat-single-sign-on-integration-with-ansible-tower</a></p>
<p><a href="https://dev.to/iderr/connect-your-awxansible-tower-with-keycloak-using-oidc--4ekb">https://dev.to/iderr/connect-your-awxansible-tower-with-keycloak-using-oidc--4ekb</a></p>
<p><a href="https://josh-tracy.github.io/Ansible_Tower_RedHatSSO/">https://josh-tracy.github.io/Ansible_Tower_RedHatSSO/</a></p>
<p><a href="https://github.com/getsentry/self-hosted/issues/1571">https://github.com/getsentry/self-hosted/issues/1571</a></p>
<p><a href="https://rdeplatform.netlify.app/docs/single%20sign-on%20with%20keycloak/">https://rdeplatform.netlify.app/docs/single%20sign-on%20with%20keycloak/</a>
integration%20with%20awx/</p>
<p><a href="https://number1.co.za/using-keycloak-as-the-identity-provider-for-awx/">https://number1.co.za/using-keycloak-as-the-identity-provider-for-awx/</a></p>
<p><a href="https://docs.ansible.com/ansible-tower/latest/html/administration/social_auth.html">https://docs.ansible.com/ansible-tower/latest/html/administration/social_auth.html</a></p></section><section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%a2%9e%e5%8a%a0%e5%b9%b6%e4%bd%bf%e7%94%a8token" heading-number="5.1.5"><nav class='md-tags'><span class='md-tag'>AWX</span></nav><h1 id="awx-token">AWX 增加并使用 token<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%a2%9e%e5%8a%a0%e5%b9%b6%e4%bd%bf%e7%94%a8token-awx-token" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%a2%9e%e5%8a%a0%e5%b9%b6%e4%bd%bf%e7%94%a8token-1-token">1. 创建 Token<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%a2%9e%e5%8a%a0%e5%b9%b6%e4%bd%bf%e7%94%a8token-1-token" title="Permanent link">&para;</a></h2>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%a2%9e%e5%8a%a0%e5%b9%b6%e4%bd%bf%e7%94%a8token-11-token">1.1 为自己创建 Token<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%a2%9e%e5%8a%a0%e5%b9%b6%e4%bd%bf%e7%94%a8token-11-token" title="Permanent link">&para;</a></h3>
<p>访问 AWX 的 API Web 页面：<a href="http://awx.hxp.lan:30623/awx/api/v2/tokens/">http://awx.hxp.lan:30623/awx/api/v2/tokens/</a>，拉到最底下，点下“POST”，把返回的 token 记录下来。</p>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%a2%9e%e5%8a%a0%e5%b9%b6%e4%bd%bf%e7%94%a8token-12-token">1.2 为别的用户创建 Token<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%a2%9e%e5%8a%a0%e5%b9%b6%e4%bd%bf%e7%94%a8token-12-token" title="Permanent link">&para;</a></h3>
<p>使用 POST 请求调用此接口创建 Token ：</p>
<p>&lt;<a href="http://awx.hxp.lan:30623/api/v2/users/">http://awx.hxp.lan:30623/api/v2/users/</a>&lt;用户ID&gt;/personal_tokens/&gt;</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%a2%9e%e5%8a%a0%e5%b9%b6%e4%bd%bf%e7%94%a8token-2-token">2. Token 使用示例<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%a2%9e%e5%8a%a0%e5%b9%b6%e4%bd%bf%e7%94%a8token-2-token" title="Permanent link">&para;</a></h2>
<p>使用 token 的 shell 示例如下：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%a2%9e%e5%8a%a0%e5%b9%b6%e4%bd%bf%e7%94%a8token-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%a2%9e%e5%8a%a0%e5%b9%b6%e4%bd%bf%e7%94%a8token-__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">TOKEN</span><span class="o">=</span>WYWAiswJYBsQUqQBXsfGnOn4a52CaC
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>curl<span class="w"> </span>-s<span class="w"> </span>-X<span class="w"> </span>GET<span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Authorization: Bearer </span><span class="nv">$TOKEN</span><span class="s2">&quot;</span><span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span>http://awx.hxp.lan:30623/awx/api/v2/inventories/
</span></code></pre></div></td></tr></table></div>
<p>python 示例：</p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%a2%9e%e5%8a%a0%e5%b9%b6%e4%bd%bf%e7%94%a8token-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%a2%9e%e5%8a%a0%e5%b9%b6%e4%bd%bf%e7%94%a8token-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%a2%9e%e5%8a%a0%e5%b9%b6%e4%bd%bf%e7%94%a8token-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%a2%9e%e5%8a%a0%e5%b9%b6%e4%bd%bf%e7%94%a8token-__codelineno-1-4">4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%a2%9e%e5%8a%a0%e5%b9%b6%e4%bd%bf%e7%94%a8token-__codelineno-1-5">5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%a2%9e%e5%8a%a0%e5%b9%b6%e4%bd%bf%e7%94%a8token-__codelineno-1-6">6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%a2%9e%e5%8a%a0%e5%b9%b6%e4%bd%bf%e7%94%a8token-__codelineno-1-7">7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%a2%9e%e5%8a%a0%e5%b9%b6%e4%bd%bf%e7%94%a8token-__codelineno-1-8">8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%a2%9e%e5%8a%a0%e5%b9%b6%e4%bd%bf%e7%94%a8token-__codelineno-1-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="ch">#!/usr/bin/python3</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="c1"># -*- coding: utf-8 -*-</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span><span class="o">,</span><span class="nn">sys</span><span class="o">,</span><span class="nn">requests</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="n">token</span><span class="o">=</span><span class="s2">&quot;WYWAiswJYBsQUqQBXsfGnOn4a52CaC&quot;</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;http://awx.hxp.lan:30623/awx/api/v2/&quot;</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="n">headers</span><span class="o">=</span><span class="p">{</span> <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">token</span> <span class="p">,</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">}</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="n">inventories</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">endpoint</span><span class="o">+</span><span class="s2">&quot;inventories?search=C-PSI&quot;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">inventories</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;results&quot;</span><span class="p">]:</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%a2%9e%e5%8a%a0%e5%b9%b6%e4%bd%bf%e7%94%a8token-3">3. 参考资料<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%a2%9e%e5%8a%a0%e5%b9%b6%e4%bd%bf%e7%94%a8token-3" title="Permanent link">&para;</a></h2>
<p>API 参考手册：<a href="https://docs.ansible.com/ansible-tower/latest/html/towerapi/api_ref.html">https://docs.ansible.com/ansible-tower/latest/html/towerapi/api_ref.html</a></p></section><section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e8%ae%be%e7%bd%aesaml%e8%ae%a4%e8%af%81%e7%94%a8%e6%88%b7%e4%b8%ba%e7%ae%a1%e7%90%86%e5%91%98" heading-number="5.1.6"><nav class='md-tags'><span class='md-tag'>AWX</span></nav><h1 id="awx-saml">AWX 设置 SAML 认证用户为管理员<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e8%ae%be%e7%bd%aesaml%e8%ae%a4%e8%af%81%e7%94%a8%e6%88%b7%e4%b8%ba%e7%ae%a1%e7%90%86%e5%91%98-awx-saml" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e8%ae%be%e7%bd%aesaml%e8%ae%a4%e8%af%81%e7%94%a8%e6%88%b7%e4%b8%ba%e7%ae%a1%e7%90%86%e5%91%98-1-awx-saml">1. AWX 创建 SAML 用户为管理员<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e8%ae%be%e7%bd%aesaml%e8%ae%a4%e8%af%81%e7%94%a8%e6%88%b7%e4%b8%ba%e7%ae%a1%e7%90%86%e5%91%98-1-awx-saml" title="Permanent link">&para;</a></h2>
<ol>
<li>Keycloak 上，创建一个 role：awx_admin
   <img alt="" src="%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/images/AWX%E8%AE%BE%E7%BD%AESAML%E8%AE%A4%E8%AF%81%E7%94%A8%E6%88%B7%E4%B8%BA%E7%AE%A1%E7%90%86%E5%91%98_1.png" /></li>
<li>Keycloak 上，将 awx_system_admin 加入这个 role
   <img alt="" src="%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/images/AWX%E8%AE%BE%E7%BD%AESAML%E8%AE%A4%E8%AF%81%E7%94%A8%E6%88%B7%E4%B8%BA%E7%AE%A1%E7%90%86%E5%91%98_2.png" /></li>
<li>AWX 上，修改 AWX 的 “SAML User Flags Attribute Mapping”
   <img alt="" src="%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/AWX/images/AWX%E8%AE%BE%E7%BD%AESAML%E8%AE%A4%E8%AF%81%E7%94%A8%E6%88%B7%E4%B8%BA%E7%AE%A1%E7%90%86%E5%91%98_3.png" /></li>
</ol></section><section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84" heading-number="5.1.7"><h1 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-awx">AWX 新增容器组<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-awx" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-1">1. 需要下载的文件<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-1" title="Permanent link">&para;</a></h2>
<ol>
<li>containergroup-sa.yml : <a href="https://docs.ansible.com/automation-controller/latest/html/administration/_downloads/7a0708e6c2113e9601bf252270fa6c50/containergroup-sa.yml">https://docs.ansible.com/automation-controller/latest/html/administration/_downloads/7a0708e6c2113e9601bf252270fa6c50/containergroup-sa.yml</a></li>
</ol>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-2-namespace-service-account">2. 创建 namespace 和 service account<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-2-namespace-service-account" title="Permanent link">&para;</a></h2>
<p>containergroup-sa.yml 修改如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-19">19</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-20">20</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-21">21</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-22">22</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-23">23</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-24">24</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-25">25</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-26">26</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-27">27</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-28">28</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-29">29</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-30">30</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-31">31</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-32">32</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-33">33</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-34">34</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-35">35</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-0-36">36</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>---
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>apiVersion: v1
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a>kind: ServiceAccount
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a>metadata:
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a>  name: awx-service-account
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a>  namespace: awx
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a>---
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a>kind: Role
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a>apiVersion: rbac.authorization.k8s.io/v1
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a>metadata:
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a>  name: role-awx-service-account
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a>  namespace: awx
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a>rules:
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a>- apiGroups: [&quot;&quot;]
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15"></a>  resources: [&quot;pods&quot;]
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16"></a>  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;, &quot;delete&quot;]
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17"></a>- apiGroups: [&quot;&quot;]
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18"></a>  resources: [&quot;pods/log&quot;]
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19"></a>  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;, &quot;delete&quot;]
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20"></a>- apiGroups: [&quot;&quot;]
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21"></a>  resources: [&quot;pods/attach&quot;]
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22"></a>  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;, &quot;delete&quot;]
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23"></a>---
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24"></a>kind: RoleBinding
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25"></a>apiVersion: rbac.authorization.k8s.io/v1
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26"></a>metadata:
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27"></a>  name: role-awx-service-account-binding
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28"></a>  namespace: awx
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29"></a>subjects:
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30"></a>- kind: ServiceAccount
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31"></a>  name: awx-service-account
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32"></a>  namespace: awx
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33"></a>roleRef:
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34"></a>  kind: Role
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35"></a>  name: role-awx-service-account
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36"></a>  apiGroup: rbac.authorization.k8s.io
</span></code></pre></div></td></tr></table></div>
<p>应用资源：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-1-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>kubectl<span class="w"> </span>create<span class="w"> </span>ns<span class="w"> </span>awx
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>containergroup-sa.yml
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-3-service-account-token">3. 为 service account 创建 token<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-3-service-account-token" title="Permanent link">&para;</a></h2>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-2-3">3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-2-4">4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-2-5">5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-2-6">6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-2-7">7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-2-8">8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-2-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>awx<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>-<span class="w"> </span><span class="s">&lt;&lt;EOF</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="s">apiVersion: v1</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="s">kind: Secret</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="s">metadata:</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="s">  name: awx-secret</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="s">  annotations:</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="s">    kubernetes.io/service-account.name: awx-service-account</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="s">type: kubernetes.io/service-account-token</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="s">EOF</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-4-token">4. 获取 token 和证书<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-4-token" title="Permanent link">&para;</a></h2>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-3-3">3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-__codelineno-3-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="c1"># 获取token</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>awx<span class="w"> </span>get<span class="w"> </span>secrets<span class="w"> </span>awx-secret<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.data.token}&#39;</span><span class="p">|</span>base64<span class="w"> </span>-d<span class="p">;</span><span class="nb">echo</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="c1"># 获取证书</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>awx<span class="w"> </span>get<span class="w"> </span>secrets<span class="w"> </span>awx-secret<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.data.ca\.crt}&#39;</span><span class="p">|</span>base64<span class="w"> </span>-d<span class="p">;</span><span class="nb">echo</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-5-awx">5. 在 AWX 上配置凭证<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-5-awx" title="Permanent link">&para;</a></h2>
<p>点击 Resources -&gt; Credentials ，新增凭证，类型 “OpenShift or Kubernetes API Bearer Token”，API endpoint 为 k8s 的 apiserver endpoint，在 k3s 中为 <a href="https://IP">https://IP</a> 地址:6443，token 和 CA 证书为刚刚获取的值，Verify SSL 选 false。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-6">6. 加入实例组<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-6" title="Permanent link">&para;</a></h2>
<p>点击 Administration -&gt; Instance Groups ，点击 Add -&gt; Add container group，Credential 为之前配置的凭证，Cutson pod spec 中，serviceAccountName 和 namespace 按需修改为 awx-service-account 和 awx。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-7">7. 参考链接<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84-7" title="Permanent link">&para;</a></h2>
<p><a href="https://docs.ansible.com/automation-controller/latest/html/administration/containers_instance_groups.html">https://docs.ansible.com/automation-controller/latest/html/administration/containers_instance_groups.html</a></p></section><section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83" heading-number="5.1.8"><nav class='md-tags'><span class='md-tag'>Kubernetes</span><span class='md-tag'>K3S</span><span class='md-tag'>AWX</span></nav><h1 id="k3s-awx">在 k3s 上安装 awx 测试环境<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-k3s-awx" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-1-k3s">1. 安装 k3s<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-1-k3s" title="Permanent link">&para;</a></h2>
<p>一键安装 k3s ：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>curl<span class="w"> </span>-sfL<span class="w"> </span>https://get.k3s.io<span class="w"> </span><span class="p">|</span><span class="w"> </span>sh<span class="w"> </span>-
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-2-awx-operator">2. 安装 AWX Operator<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-2-awx-operator" title="Permanent link">&para;</a></h2>
<p>创建 <code>kustomization.yaml</code> ：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-1-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kustomize.config.k8s.io/v1beta1</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Kustomization</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="c1"># Find the latest tag here: https://github.com/ansible/awx-operator/releases</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">github.com/ansible/awx-operator/config/default?ref=2.19.1</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="c1"># Set the image tags to match the git version from above</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="nt">images</span><span class="p">:</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">quay.io/ansible/awx-operator</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="nt">newTag</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2.19.1</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="c1"># Specify a custom namespace in which to install AWX</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">awx</span>
</span></code></pre></div></td></tr></table></div>
<p>生成 yaml 文件 <code>awx-operator.yaml</code> ：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-k<span class="w"> </span>.<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span>--dry-run<span class="o">=</span>client<span class="w"> </span>&gt;<span class="w"> </span>awx-operator.yaml
</span></code></pre></div></td></tr></table></div>
<p>将 yaml 文件应用：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-3-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>kubectl<span class="w"> </span>create<span class="w"> </span>namespace<span class="w"> </span>awx
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>awx<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>awx-operator.yaml
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-3-awx-operator-awx">3. 使用 AWX Operator 安装 AWX<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-3-awx-operator-awx" title="Permanent link">&para;</a></h2>
<p>创建 PostgresSQL 配置 <code>awx-postgres-configuration.yaml</code> ：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-4-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-4-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-4-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-4-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-4-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-4-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="nn">---</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">awx-postgres-configuration</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">awx</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="nt">stringData</span><span class="p">:</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">  </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">awx-postgres-15</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;5432&quot;</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">  </span><span class="nt">database</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">awx</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">awx</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="w">  </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">awx</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="w">  </span><span class="nt">sslmode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prefer</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">managed</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Opaque</span>
</span></code></pre></div></td></tr></table></div>
<p>应用配置文件：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-5-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>awx-postgres-configuration.yaml
</span></code></pre></div></td></tr></table></div>
<p>创建 AWX 配置 <code>awx.yaml</code> ：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-6-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-6-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-6-3">3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-6-4">4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-6-5">5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-6-6">6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-6-7">7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-6-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="nn">---</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">awx.ansible.com/v1beta1</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWX</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">awx</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">awx</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="w">  </span><span class="nt">service_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nodeport</span>
</span></code></pre></div></td></tr></table></div>
<p>部署 AWX ：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-7-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>awx.yaml
</span></code></pre></div></td></tr></table></div>
<p>查看安装进度：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-8-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>awx<span class="w"> </span>logs<span class="w"> </span>-f<span class="w"> </span>deployments/awx-operator-controller-manager<span class="w"> </span>-c<span class="w"> </span>awx-manager
</span></code></pre></div></td></tr></table></div>
<p>获取默认 admin 密码：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-9-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>awx<span class="w"> </span>get<span class="w"> </span>secret<span class="w"> </span>awx-admin-password<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&quot;{.data.password}&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>--decode<span class="p">;</span><span class="nb">echo</span>
</span></code></pre></div></td></tr></table></div>
<p>如果需要修改 admin 密码，可以进入容器修改：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-__codelineno-10-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>awx<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>awx-web-6b97857864-5rngv<span class="w"> </span>--<span class="w"> </span>awx-manage<span class="w"> </span>update_password<span class="w"> </span>--username<span class="o">=</span>admin<span class="w"> </span>--password<span class="o">=</span>changeme
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-4">4. 参考资料<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83-4" title="Permanent link">&para;</a></h2>
<p><a href="https://github.com/ansible/awx/issues/5825">https://github.com/ansible/awx/issues/5825</a></p></section></section>
                    <section class='print-page md-section' id='section-5-2' heading-number='5.2'>
                        <h1>Keycloak<a class='headerlink' href='#section-5-2' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1" heading-number="5.2.1"><nav class='md-tags'><span class='md-tag'>openresty</span><span class='md-tag'>Keycloak</span><span class='md-tag'>Kubernetes</span></nav><h1 id="openresty-k8s-keycloak">使用 openresty 容器为 k8s 的服务提供 Keycloak 认证服务<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-openresty-k8s-keycloak" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-1">1. 前置条件<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-1" title="Permanent link">&para;</a></h2>
<ul>
<li>一个能运作的 k8s 集群</li>
<li>相关容器镜像上传到镜像仓库</li>
<li>k8s 配置好私有镜像仓库凭证</li>
</ul>
<h%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-2">2. 构建容器镜像<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-2" title="Permanent link">&para;</a></h2>
<p>使用 <a href="https://github.com/smyrgeorge/openresty-keycloak-gateway">openresty-keycloak-gateway</a> 项目进行容器镜像的构建，其 Dockerfile 如下：</p>
<div class="language-Dockerfile highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-0-6">6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-0-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">FROM</span><span class="w"> </span><span class="s">openresty/openresty:alpine-fat</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">RUN</span><span class="w"> </span>mkdir<span class="w"> </span>/var/log/nginx
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="k">RUN</span><span class="w"> </span>apk<span class="w"> </span>add<span class="w"> </span>--no-cache<span class="w"> </span>openssl-dev
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="k">RUN</span><span class="w"> </span>apk<span class="w"> </span>add<span class="w"> </span>--no-cache<span class="w"> </span>git
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="k">RUN</span><span class="w"> </span>apk<span class="w"> </span>add<span class="w"> </span>--no-cache<span class="w"> </span>gcc
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="k">RUN</span><span class="w"> </span>luarocks<span class="w"> </span>install<span class="w"> </span>lua-resty-openidc
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;/usr/local/openresty/nginx/sbin/nginx&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;-g&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;daemon off;&quot;</span><span class="p">]</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-3-configmap">3. 创建 configmap 来存储容器配置<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-3-configmap" title="Permanent link">&para;</a></h2>
<p>使用 configmap 进行 openresty 配置的存储：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-23">23</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-24">24</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-25">25</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-26">26</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-27">27</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-28">28</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-29">29</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-30">30</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-31">31</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-32">32</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-33">33</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-34">34</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-35">35</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-36">36</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-37">37</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-38">38</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-39">39</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-40">40</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-41">41</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-42">42</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-43">43</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-44">44</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-45">45</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-46">46</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-47">47</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-48">48</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-49">49</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-50">50</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-51">51</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-52">52</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-53">53</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-54">54</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-55">55</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-56">56</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-1-57">57</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nn">---</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="nt">data</span><span class="p">:</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="nt">nginx.conf</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">    </span><span class="no">events {</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">      </span><span class="no">worker_connections 1024;</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">    </span><span class="no">}</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">    </span><span class="no">http {</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">      </span><span class="no">lua_package_path &#39;~/lua/?.lua;;&#39;;</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">      </span><span class="no">lua_ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">      </span><span class="no">lua_ssl_verify_depth 5;</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">      </span><span class="no">lua_shared_dict introspection 10m;</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">      </span><span class="no">server {</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">        </span><span class="no">listen       8000 default_server;</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">        </span><span class="no">listen       [::]:8000 default_server;</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">        </span><span class="no"># disbled caching so the browser won&#39;t cache the site.</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">        </span><span class="no">expires           0;</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">        </span><span class="no">add_header        Cache-Control private;</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">        </span><span class="no">set $session_name nginx_session;</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">        </span><span class="no">set $session_secret kjlbnbuukllkj23i;</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">        </span><span class="no">access_by_lua_block {</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">          </span><span class="no">local keycloak_base_url = &quot;http://22.182.16.129:9003/&quot;</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">          </span><span class="no">local client_id = &quot;IT-Automation&quot;</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">          </span><span class="no">local realm = &quot;IT-Automation&quot;</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">          </span><span class="no">local opts = {</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">            </span><span class="no">client_id = client_id,</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="w">            </span><span class="no">discovery = keycloak_base_url .. &quot;/realms/&quot; .. realm .. &quot;/.well-known/openid-configuration&quot;,</span>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="w">            </span><span class="no">redirect_url_scheme = &quot;http&quot;,</span>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="w">            </span><span class="no">redirect_uri_path = &quot;/redirect&quot;,</span>
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="w">            </span><span class="no">logout_path = &quot;/logout&quot;,</span>
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="w">            </span><span class="no">session_contents = {id_token=true},</span>
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="w">            </span><span class="no">ssl_verify = &quot;no&quot;,</span>
</span><span id="__span-1-34"><a id="__codelineno-1-34" name="__codelineno-1-34"></a><span class="w">          </span><span class="no">}</span>
</span><span id="__span-1-35"><a id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="w">          </span><span class="no">local res, err = require(&quot;resty.openidc&quot;).authenticate(opts)</span>
</span><span id="__span-1-36"><a id="__codelineno-1-36" name="__codelineno-1-36"></a><span class="w">          </span><span class="no">if err then</span>
</span><span id="__span-1-37"><a id="__codelineno-1-37" name="__codelineno-1-37"></a><span class="w">            </span><span class="no">ngx.status = 401</span>
</span><span id="__span-1-38"><a id="__codelineno-1-38" name="__codelineno-1-38"></a><span class="w">            </span><span class="no">ngx.say(err)</span>
</span><span id="__span-1-39"><a id="__codelineno-1-39" name="__codelineno-1-39"></a><span class="w">            </span><span class="no">ngx.exit(ngx.HTTP_UNAUTHORIZED)</span>
</span><span id="__span-1-40"><a id="__codelineno-1-40" name="__codelineno-1-40"></a><span class="w">          </span><span class="no">end</span>
</span><span id="__span-1-41"><a id="__codelineno-1-41" name="__codelineno-1-41"></a><span class="w">        </span><span class="no">}</span>
</span><span id="__span-1-42"><a id="__codelineno-1-42" name="__codelineno-1-42"></a><span class="w">        </span><span class="no">location / {</span>
</span><span id="__span-1-43"><a id="__codelineno-1-43" name="__codelineno-1-43"></a><span class="w">          </span><span class="no">add_header Cache-Control &#39;no-store&#39;;</span>
</span><span id="__span-1-44"><a id="__codelineno-1-44" name="__codelineno-1-44"></a><span class="w">          </span><span class="no">add_header Cache-Control &#39;no-cache&#39;;</span>
</span><span id="__span-1-45"><a id="__codelineno-1-45" name="__codelineno-1-45"></a><span class="w">          </span><span class="no">expires 0;</span>
</span><span id="__span-1-46"><a id="__codelineno-1-46" name="__codelineno-1-46"></a><span class="w">          </span><span class="no">proxy_set_header Host $host;</span>
</span><span id="__span-1-47"><a id="__codelineno-1-47" name="__codelineno-1-47"></a><span class="w">          </span><span class="no">proxy_set_header X-Real-IP $remote_addr;</span>
</span><span id="__span-1-48"><a id="__codelineno-1-48" name="__codelineno-1-48"></a><span class="w">          </span><span class="no">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span>
</span><span id="__span-1-49"><a id="__codelineno-1-49" name="__codelineno-1-49"></a><span class="w">          </span><span class="no">proxy_set_header X-Forwarded-Proto $scheme;</span>
</span><span id="__span-1-50"><a id="__codelineno-1-50" name="__codelineno-1-50"></a><span class="w">          </span><span class="no">proxy_set_header Authorization &quot;&quot;;</span>
</span><span id="__span-1-51"><a id="__codelineno-1-51" name="__codelineno-1-51"></a><span class="w">          </span><span class="no">proxy_http_version 1.1;</span>
</span><span id="__span-1-52"><a id="__codelineno-1-52" name="__codelineno-1-52"></a><span class="w">          </span><span class="no">proxy_set_header Upgrade $http_upgrade;</span>
</span><span id="__span-1-53"><a id="__codelineno-1-53" name="__codelineno-1-53"></a><span class="w">          </span><span class="no">proxy_set_header Connection &quot;Upgrade&quot;;</span>
</span><span id="__span-1-54"><a id="__codelineno-1-54" name="__codelineno-1-54"></a><span class="w">          </span><span class="no">proxy_pass http://mkdocs.mkdocs.svc.cluster.local/;</span>
</span><span id="__span-1-55"><a id="__codelineno-1-55" name="__codelineno-1-55"></a><span class="w">        </span><span class="no">}</span>
</span><span id="__span-1-56"><a id="__codelineno-1-56" name="__codelineno-1-56"></a><span class="w">      </span><span class="no">}</span>
</span><span id="__span-1-57"><a id="__codelineno-1-57" name="__codelineno-1-57"></a><span class="w">    </span><span class="no">}</span>
</span></code></pre></div></td></tr></table></div>
<p>其中 <code>proxy_pass</code> 为需要 openresty 进行反向代理的地址，在这里使用了 k8s 内部的域名解析，域名的格式为 <code>[service名称].[namespace名称].svc.cluster.local</code> ，解析到 mkdocs 这个 namespace 的 mkdocs service 。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-4-deployment-pod">4. 使用 deployment 部署 pod<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-4-deployment-pod" title="Permanent link">&para;</a></h2>
<p>使用此 deployment 部署 pod ，部署数量为 2 份：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-21">21</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-22">22</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-23">23</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-24">24</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-25">25</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-26">26</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-27">27</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-28">28</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-29">29</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-30">30</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-31">31</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-32">32</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-33">33</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-34">34</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-35">35</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-36">36</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-37">37</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-38">38</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-2-39">39</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nn">---</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">authproxy</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mkdocs</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">authproxy</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">authproxy</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">authproxy</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.100.12:8082/authproxy:v20240508</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">authproxy</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="w">          </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">authproxy</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27"></a><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/nginx.conf</span>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28"></a><span class="w">              </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx.conf</span>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29"></a><span class="w">          </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;-c&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;/nginx.conf&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30"></a><span class="w">      </span><span class="nt">imagePullSecrets</span><span class="p">:</span>
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nexus-regcred</span>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32"></a><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">authproxy</span>
</span><span id="__span-2-34"><a id="__codelineno-2-34" name="__codelineno-2-34"></a><span class="w">          </span><span class="nt">configMap</span><span class="p">:</span>
</span><span id="__span-2-35"><a id="__codelineno-2-35" name="__codelineno-2-35"></a><span class="w">            </span><span class="nt">defaultMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0644</span>
</span><span id="__span-2-36"><a id="__codelineno-2-36" name="__codelineno-2-36"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">authproxy</span>
</span><span id="__span-2-37"><a id="__codelineno-2-37" name="__codelineno-2-37"></a><span class="w">            </span><span class="nt">items</span><span class="p">:</span>
</span><span id="__span-2-38"><a id="__codelineno-2-38" name="__codelineno-2-38"></a><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx.conf</span>
</span><span id="__span-2-39"><a id="__codelineno-2-39" name="__codelineno-2-39"></a><span class="w">                </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx.conf</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-5-service">5. 使用 service 暴露服务<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-5-service" title="Permanent link">&para;</a></h2>
<p>将 authproxy 以 NodePort 方式暴露：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-3-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-3-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-3-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-3-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-3-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-3-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1-__codelineno-3-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nn">---</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">authproxy</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mkdocs</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">authproxy</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NodePort</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">authproxy</span>
</span></code></pre></div></td></tr></table></div></section><section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae" heading-number="5.2.2"><nav class='md-tags'><span class='md-tag'>Keycloak</span><span class='md-tag'>Kubernetes</span></nav><h1 id="k8s-keycloak">k8s 集群 Keycloak 部署及负载配置<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-k8s-keycloak" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-1-mysql">1. 部署 MySQL 数据库<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-1-mysql" title="Permanent link">&para;</a></h2>
<p>新建一套 MySQL-8 数据库，新建用户 keycloak 和数据库 keycloak，然后测试其连接性：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>mysql<span class="w"> </span>-h<span class="s1">&#39;192.168.100.243&#39;</span><span class="w"> </span>-P<span class="s1">&#39;3306&#39;</span><span class="w"> </span>-ukeycloak<span class="w"> </span>-p<span class="w"> </span>keycloak
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-2-ssl">2. 生成 SSL 证书<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-2-ssl" title="Permanent link">&para;</a></h2>
<p>即使不使用，也需要自签证书，否则 Keycloak 无法以生成模式启动：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>openssl<span class="w"> </span>req<span class="w"> </span>-subj<span class="w"> </span><span class="s1">&#39;/CN=test.keycloak.org/O=Test Keycloak./C=US&#39;</span><span class="w"> </span>-newkey<span class="w"> </span>rsa:2048<span class="w"> </span>-nodes<span class="w"> </span>-keyout<span class="w"> </span>key.pem<span class="w"> </span>-x509<span class="w"> </span>-days<span class="w"> </span><span class="m">3650</span><span class="w"> </span>-out<span class="w"> </span>certificate.pem
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-3-keycloak">3. 部署 Keycloak<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-3-keycloak" title="Permanent link">&para;</a></h2>
<p>先创建 service，暴露服务端口 30081：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-2-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nn">---</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NodePort</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">      </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30081</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LoadBalancer</span>
</span></code></pre></div></td></tr></table></div>
<p>在默认情况下，keycloak 不同容器之间的互相发现是靠 IP multicast 广播实现，但是由于在 k8s 环境下，calico 和 fannel 不支持 multicast，不同 k8s 节点的 keycloak 容器广播不可达，就无法通过 multicast 发现彼此。默认的 multicast 服务发现方式在 calico 和 fannel 下不可使用，就需要自己写配置<code>cache-ispn.xml</code>替换容器里的来实现 keycloak 使用 JDBC ping 来发现彼此，这里直接把配置写 configmap 然后挂载到容器：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-1">  1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-2">  2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-3">  3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-4">  4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-5">  5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-6">  6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-7">  7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-8">  8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-9">  9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-10"> 10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-11"> 11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-12"> 12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-13"> 13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-14"> 14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-15"> 15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-16"> 16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-17"> 17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-18"> 18</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-19"> 19</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-20"> 20</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-21"> 21</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-22"> 22</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-23"> 23</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-24"> 24</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-25"> 25</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-26"> 26</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-27"> 27</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-28"> 28</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-29"> 29</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-30"> 30</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-31"> 31</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-32"> 32</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-33"> 33</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-34"> 34</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-35"> 35</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-36"> 36</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-37"> 37</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-38"> 38</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-39"> 39</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-40"> 40</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-41"> 41</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-42"> 42</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-43"> 43</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-44"> 44</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-45"> 45</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-46"> 46</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-47"> 47</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-48"> 48</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-49"> 49</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-50"> 50</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-51"> 51</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-52"> 52</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-53"> 53</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-54"> 54</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-55"> 55</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-56"> 56</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-57"> 57</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-58"> 58</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-59"> 59</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-60"> 60</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-61"> 61</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-62"> 62</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-63"> 63</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-64"> 64</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-65"> 65</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-66"> 66</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-67"> 67</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-68"> 68</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-69"> 69</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-70"> 70</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-71"> 71</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-72"> 72</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-73"> 73</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-74"> 74</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-75"> 75</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-76"> 76</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-77"> 77</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-78"> 78</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-79"> 79</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-80"> 80</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-81"> 81</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-82"> 82</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-83"> 83</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-84"> 84</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-85"> 85</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-86"> 86</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-87"> 87</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-88"> 88</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-89"> 89</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-90"> 90</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-91"> 91</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-92"> 92</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-93"> 93</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-94"> 94</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-95"> 95</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-96"> 96</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-97"> 97</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-98"> 98</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-99"> 99</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-100">100</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-101">101</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-102">102</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-103">103</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-104">104</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-105">105</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-3-106">106</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nn">---</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cache-ispn</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="nt">data</span><span class="p">:</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">  </span><span class="nt">cache-ispn.xml</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">    </span><span class="no">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">    </span><span class="no">&lt;!--</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">      </span><span class="no">~ Copyright 2019 Red Hat, Inc. and/or its affiliates</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">      </span><span class="no">~ and other contributors as indicated by the @author tags.</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">      </span><span class="no">~</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">      </span><span class="no">~ Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">      </span><span class="no">~ you may not use this file except in compliance with the License.</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="w">      </span><span class="no">~ You may obtain a copy of the License at</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="w">      </span><span class="no">~</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="w">      </span><span class="no">~ http://www.apache.org/licenses/LICENSE-2.0</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="w">      </span><span class="no">~</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="w">      </span><span class="no">~ Unless required by applicable law or agreed to in writing, software</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="w">      </span><span class="no">~ distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="w">      </span><span class="no">~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="w">      </span><span class="no">~ See the License for the specific language governing permissions and</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24"></a><span class="w">      </span><span class="no">~ limitations under the License.</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25"></a><span class="w">      </span><span class="no">--&gt;</span>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26"></a>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27"></a><span class="w">    </span><span class="no">&lt;infinispan</span>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28"></a><span class="w">            </span><span class="no">xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29"></a><span class="w">            </span><span class="no">xsi:schemaLocation=&quot;urn:infinispan:config:14.0 http://www.infinispan.org/schemas/infinispan-config-14.0.xsd&quot;</span>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30"></a><span class="w">            </span><span class="no">xmlns=&quot;urn:infinispan:config:14.0&quot;&gt;</span>
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31"></a><span class="w">        </span><span class="no">&lt;jgroups&gt;</span>
</span><span id="__span-3-32"><a id="__codelineno-3-32" name="__codelineno-3-32"></a><span class="w">            </span><span class="no">&lt;stack name=&quot;jdbc-ping-tcp&quot; extends=&quot;tcp&quot;&gt;</span>
</span><span id="__span-3-33"><a id="__codelineno-3-33" name="__codelineno-3-33"></a><span class="w">                </span><span class="no">&lt;JDBC_PING connection_driver=&quot;com.mysql.cj.jdbc.Driver&quot;</span>
</span><span id="__span-3-34"><a id="__codelineno-3-34" name="__codelineno-3-34"></a><span class="w">                        </span><span class="no">connection_username=&quot;${env.KC_DB_USERNAME}&quot;</span>
</span><span id="__span-3-35"><a id="__codelineno-3-35" name="__codelineno-3-35"></a><span class="w">                        </span><span class="no">connection_password=&quot;${env.KC_DB_PASSWORD}&quot;</span>
</span><span id="__span-3-36"><a id="__codelineno-3-36" name="__codelineno-3-36"></a><span class="w">                        </span><span class="no">connection_url=&quot;${env.KC_DB_URL}&quot;</span>
</span><span id="__span-3-37"><a id="__codelineno-3-37" name="__codelineno-3-37"></a><span class="w">                        </span><span class="no">info_writer_sleep_time=&quot;500&quot;</span>
</span><span id="__span-3-38"><a id="__codelineno-3-38" name="__codelineno-3-38"></a><span class="w">                        </span><span class="no">initialize_sql=&quot;CREATE TABLE IF NOT EXISTS JGROUPSPING (own_addr varchar(200) NOT NULL, cluster_name varchar(200) NOT NULL, ping_data VARBINARY(255), constraint PK_JGROUPSPING PRIMARY KEY (own_addr, cluster_name));&quot;</span>
</span><span id="__span-3-39"><a id="__codelineno-3-39" name="__codelineno-3-39"></a><span class="w">                        </span><span class="no">remove_all_data_on_view_change=&quot;true&quot;</span>
</span><span id="__span-3-40"><a id="__codelineno-3-40" name="__codelineno-3-40"></a><span class="w">                        </span><span class="no">stack.combine=&quot;REPLACE&quot;</span>
</span><span id="__span-3-41"><a id="__codelineno-3-41" name="__codelineno-3-41"></a><span class="w">                        </span><span class="no">stack.position=&quot;MPING&quot; /&gt;</span>
</span><span id="__span-3-42"><a id="__codelineno-3-42" name="__codelineno-3-42"></a><span class="w">            </span><span class="no">&lt;/stack&gt;</span>
</span><span id="__span-3-43"><a id="__codelineno-3-43" name="__codelineno-3-43"></a><span class="w">        </span><span class="no">&lt;/jgroups&gt;</span>
</span><span id="__span-3-44"><a id="__codelineno-3-44" name="__codelineno-3-44"></a><span class="w">        </span><span class="no">&lt;cache-container name=&quot;keycloak&quot;&gt;</span>
</span><span id="__span-3-45"><a id="__codelineno-3-45" name="__codelineno-3-45"></a><span class="w">            </span><span class="no">&lt;transport lock-timeout=&quot;60000&quot; stack=&quot;jdbc-ping-tcp&quot;/&gt;</span>
</span><span id="__span-3-46"><a id="__codelineno-3-46" name="__codelineno-3-46"></a><span class="w">            </span><span class="no">&lt;metrics names-as-tags=&quot;true&quot; /&gt;</span>
</span><span id="__span-3-47"><a id="__codelineno-3-47" name="__codelineno-3-47"></a><span class="w">            </span><span class="no">&lt;local-cache name=&quot;realms&quot;&gt;</span>
</span><span id="__span-3-48"><a id="__codelineno-3-48" name="__codelineno-3-48"></a><span class="w">                </span><span class="no">&lt;encoding&gt;</span>
</span><span id="__span-3-49"><a id="__codelineno-3-49" name="__codelineno-3-49"></a><span class="w">                    </span><span class="no">&lt;key media-type=&quot;application/x-java-object&quot;/&gt;</span>
</span><span id="__span-3-50"><a id="__codelineno-3-50" name="__codelineno-3-50"></a><span class="w">                    </span><span class="no">&lt;value media-type=&quot;application/x-java-object&quot;/&gt;</span>
</span><span id="__span-3-51"><a id="__codelineno-3-51" name="__codelineno-3-51"></a><span class="w">                </span><span class="no">&lt;/encoding&gt;</span>
</span><span id="__span-3-52"><a id="__codelineno-3-52" name="__codelineno-3-52"></a><span class="w">                </span><span class="no">&lt;memory max-count=&quot;10000&quot;/&gt;</span>
</span><span id="__span-3-53"><a id="__codelineno-3-53" name="__codelineno-3-53"></a><span class="w">            </span><span class="no">&lt;/local-cache&gt;</span>
</span><span id="__span-3-54"><a id="__codelineno-3-54" name="__codelineno-3-54"></a><span class="w">            </span><span class="no">&lt;local-cache name=&quot;users&quot;&gt;</span>
</span><span id="__span-3-55"><a id="__codelineno-3-55" name="__codelineno-3-55"></a><span class="w">                </span><span class="no">&lt;encoding&gt;</span>
</span><span id="__span-3-56"><a id="__codelineno-3-56" name="__codelineno-3-56"></a><span class="w">                    </span><span class="no">&lt;key media-type=&quot;application/x-java-object&quot;/&gt;</span>
</span><span id="__span-3-57"><a id="__codelineno-3-57" name="__codelineno-3-57"></a><span class="w">                    </span><span class="no">&lt;value media-type=&quot;application/x-java-object&quot;/&gt;</span>
</span><span id="__span-3-58"><a id="__codelineno-3-58" name="__codelineno-3-58"></a><span class="w">                </span><span class="no">&lt;/encoding&gt;</span>
</span><span id="__span-3-59"><a id="__codelineno-3-59" name="__codelineno-3-59"></a><span class="w">                </span><span class="no">&lt;memory max-count=&quot;10000&quot;/&gt;</span>
</span><span id="__span-3-60"><a id="__codelineno-3-60" name="__codelineno-3-60"></a><span class="w">            </span><span class="no">&lt;/local-cache&gt;</span>
</span><span id="__span-3-61"><a id="__codelineno-3-61" name="__codelineno-3-61"></a><span class="w">            </span><span class="no">&lt;distributed-cache name=&quot;sessions&quot; owners=&quot;2&quot;&gt;</span>
</span><span id="__span-3-62"><a id="__codelineno-3-62" name="__codelineno-3-62"></a><span class="w">                </span><span class="no">&lt;expiration lifespan=&quot;-1&quot;/&gt;</span>
</span><span id="__span-3-63"><a id="__codelineno-3-63" name="__codelineno-3-63"></a><span class="w">            </span><span class="no">&lt;/distributed-cache&gt;</span>
</span><span id="__span-3-64"><a id="__codelineno-3-64" name="__codelineno-3-64"></a><span class="w">            </span><span class="no">&lt;distributed-cache name=&quot;authenticationSessions&quot; owners=&quot;2&quot;&gt;</span>
</span><span id="__span-3-65"><a id="__codelineno-3-65" name="__codelineno-3-65"></a><span class="w">                </span><span class="no">&lt;expiration lifespan=&quot;-1&quot;/&gt;</span>
</span><span id="__span-3-66"><a id="__codelineno-3-66" name="__codelineno-3-66"></a><span class="w">            </span><span class="no">&lt;/distributed-cache&gt;</span>
</span><span id="__span-3-67"><a id="__codelineno-3-67" name="__codelineno-3-67"></a><span class="w">            </span><span class="no">&lt;distributed-cache name=&quot;offlineSessions&quot; owners=&quot;2&quot;&gt;</span>
</span><span id="__span-3-68"><a id="__codelineno-3-68" name="__codelineno-3-68"></a><span class="w">                </span><span class="no">&lt;expiration lifespan=&quot;-1&quot;/&gt;</span>
</span><span id="__span-3-69"><a id="__codelineno-3-69" name="__codelineno-3-69"></a><span class="w">            </span><span class="no">&lt;/distributed-cache&gt;</span>
</span><span id="__span-3-70"><a id="__codelineno-3-70" name="__codelineno-3-70"></a><span class="w">            </span><span class="no">&lt;distributed-cache name=&quot;clientSessions&quot; owners=&quot;2&quot;&gt;</span>
</span><span id="__span-3-71"><a id="__codelineno-3-71" name="__codelineno-3-71"></a><span class="w">                </span><span class="no">&lt;expiration lifespan=&quot;-1&quot;/&gt;</span>
</span><span id="__span-3-72"><a id="__codelineno-3-72" name="__codelineno-3-72"></a><span class="w">            </span><span class="no">&lt;/distributed-cache&gt;</span>
</span><span id="__span-3-73"><a id="__codelineno-3-73" name="__codelineno-3-73"></a><span class="w">            </span><span class="no">&lt;distributed-cache name=&quot;offlineClientSessions&quot; owners=&quot;2&quot;&gt;</span>
</span><span id="__span-3-74"><a id="__codelineno-3-74" name="__codelineno-3-74"></a><span class="w">                </span><span class="no">&lt;expiration lifespan=&quot;-1&quot;/&gt;</span>
</span><span id="__span-3-75"><a id="__codelineno-3-75" name="__codelineno-3-75"></a><span class="w">            </span><span class="no">&lt;/distributed-cache&gt;</span>
</span><span id="__span-3-76"><a id="__codelineno-3-76" name="__codelineno-3-76"></a><span class="w">            </span><span class="no">&lt;distributed-cache name=&quot;loginFailures&quot; owners=&quot;2&quot;&gt;</span>
</span><span id="__span-3-77"><a id="__codelineno-3-77" name="__codelineno-3-77"></a><span class="w">                </span><span class="no">&lt;expiration lifespan=&quot;-1&quot;/&gt;</span>
</span><span id="__span-3-78"><a id="__codelineno-3-78" name="__codelineno-3-78"></a><span class="w">            </span><span class="no">&lt;/distributed-cache&gt;</span>
</span><span id="__span-3-79"><a id="__codelineno-3-79" name="__codelineno-3-79"></a><span class="w">            </span><span class="no">&lt;local-cache name=&quot;authorization&quot;&gt;</span>
</span><span id="__span-3-80"><a id="__codelineno-3-80" name="__codelineno-3-80"></a><span class="w">                </span><span class="no">&lt;encoding&gt;</span>
</span><span id="__span-3-81"><a id="__codelineno-3-81" name="__codelineno-3-81"></a><span class="w">                    </span><span class="no">&lt;key media-type=&quot;application/x-java-object&quot;/&gt;</span>
</span><span id="__span-3-82"><a id="__codelineno-3-82" name="__codelineno-3-82"></a><span class="w">                    </span><span class="no">&lt;value media-type=&quot;application/x-java-object&quot;/&gt;</span>
</span><span id="__span-3-83"><a id="__codelineno-3-83" name="__codelineno-3-83"></a><span class="w">                </span><span class="no">&lt;/encoding&gt;</span>
</span><span id="__span-3-84"><a id="__codelineno-3-84" name="__codelineno-3-84"></a><span class="w">                </span><span class="no">&lt;memory max-count=&quot;10000&quot;/&gt;</span>
</span><span id="__span-3-85"><a id="__codelineno-3-85" name="__codelineno-3-85"></a><span class="w">            </span><span class="no">&lt;/local-cache&gt;</span>
</span><span id="__span-3-86"><a id="__codelineno-3-86" name="__codelineno-3-86"></a><span class="w">            </span><span class="no">&lt;replicated-cache name=&quot;work&quot;&gt;</span>
</span><span id="__span-3-87"><a id="__codelineno-3-87" name="__codelineno-3-87"></a><span class="w">                </span><span class="no">&lt;expiration lifespan=&quot;-1&quot;/&gt;</span>
</span><span id="__span-3-88"><a id="__codelineno-3-88" name="__codelineno-3-88"></a><span class="w">            </span><span class="no">&lt;/replicated-cache&gt;</span>
</span><span id="__span-3-89"><a id="__codelineno-3-89" name="__codelineno-3-89"></a><span class="w">            </span><span class="no">&lt;local-cache name=&quot;keys&quot;&gt;</span>
</span><span id="__span-3-90"><a id="__codelineno-3-90" name="__codelineno-3-90"></a><span class="w">                </span><span class="no">&lt;encoding&gt;</span>
</span><span id="__span-3-91"><a id="__codelineno-3-91" name="__codelineno-3-91"></a><span class="w">                    </span><span class="no">&lt;key media-type=&quot;application/x-java-object&quot;/&gt;</span>
</span><span id="__span-3-92"><a id="__codelineno-3-92" name="__codelineno-3-92"></a><span class="w">                    </span><span class="no">&lt;value media-type=&quot;application/x-java-object&quot;/&gt;</span>
</span><span id="__span-3-93"><a id="__codelineno-3-93" name="__codelineno-3-93"></a><span class="w">                </span><span class="no">&lt;/encoding&gt;</span>
</span><span id="__span-3-94"><a id="__codelineno-3-94" name="__codelineno-3-94"></a><span class="w">                </span><span class="no">&lt;expiration max-idle=&quot;3600000&quot;/&gt;</span>
</span><span id="__span-3-95"><a id="__codelineno-3-95" name="__codelineno-3-95"></a><span class="w">                </span><span class="no">&lt;memory max-count=&quot;1000&quot;/&gt;</span>
</span><span id="__span-3-96"><a id="__codelineno-3-96" name="__codelineno-3-96"></a><span class="w">            </span><span class="no">&lt;/local-cache&gt;</span>
</span><span id="__span-3-97"><a id="__codelineno-3-97" name="__codelineno-3-97"></a><span class="w">            </span><span class="no">&lt;distributed-cache name=&quot;actionTokens&quot; owners=&quot;2&quot;&gt;</span>
</span><span id="__span-3-98"><a id="__codelineno-3-98" name="__codelineno-3-98"></a><span class="w">                </span><span class="no">&lt;encoding&gt;</span>
</span><span id="__span-3-99"><a id="__codelineno-3-99" name="__codelineno-3-99"></a><span class="w">                    </span><span class="no">&lt;key media-type=&quot;application/x-java-object&quot;/&gt;</span>
</span><span id="__span-3-100"><a id="__codelineno-3-100" name="__codelineno-3-100"></a><span class="w">                    </span><span class="no">&lt;value media-type=&quot;application/x-java-object&quot;/&gt;</span>
</span><span id="__span-3-101"><a id="__codelineno-3-101" name="__codelineno-3-101"></a><span class="w">                </span><span class="no">&lt;/encoding&gt;</span>
</span><span id="__span-3-102"><a id="__codelineno-3-102" name="__codelineno-3-102"></a><span class="w">                </span><span class="no">&lt;expiration max-idle=&quot;-1&quot; lifespan=&quot;-1&quot; interval=&quot;300000&quot;/&gt;</span>
</span><span id="__span-3-103"><a id="__codelineno-3-103" name="__codelineno-3-103"></a><span class="w">                </span><span class="no">&lt;memory max-count=&quot;-1&quot;/&gt;</span>
</span><span id="__span-3-104"><a id="__codelineno-3-104" name="__codelineno-3-104"></a><span class="w">            </span><span class="no">&lt;/distributed-cache&gt;</span>
</span><span id="__span-3-105"><a id="__codelineno-3-105" name="__codelineno-3-105"></a><span class="w">        </span><span class="no">&lt;/cache-container&gt;</span>
</span><span id="__span-3-106"><a id="__codelineno-3-106" name="__codelineno-3-106"></a><span class="w">    </span><span class="no">&lt;/infinispan&gt;</span>
</span></code></pre></div></td></tr></table></div>
<p>再创建 deployment：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-16">16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-17">17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-18">18</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-19">19</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-20">20</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-21">21</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-22">22</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-23">23</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-24">24</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-25">25</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-26">26</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-27">27</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-28">28</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-29">29</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-30">30</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-31">31</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-32">32</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-33">33</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-34">34</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-35">35</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-36">36</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-37">37</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-38">38</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-39">39</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-40">40</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-41">41</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-42">42</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-43">43</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-44">44</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-45">45</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-46">46</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-47">47</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-48">48</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-49">49</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-50">50</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-51">51</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-52">52</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-53">53</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-54">54</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-55">55</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-56">56</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-57">57</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-58">58</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-59">59</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-60">60</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-61">61</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-62">62</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-63">63</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-64">64</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-65">65</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-66">66</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-67">67</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-68">68</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-69">69</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-70">70</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-71">71</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-72">72</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-73">73</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-74">74</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-75">75</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-76">76</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-77">77</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-78">78</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-79">79</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-80">80</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-81">81</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-82">82</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-83">83</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-84">84</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-85">85</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-86">86</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-4-87">87</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="nn">---</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.100.12:8082/keycloak/keycloak:24.0</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="w">          </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;start&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--hostname-strict-https=false&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="w">          </span><span class="nt">env</span><span class="p">:</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KEYCLOAK_ADMIN</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;admin&quot;</span>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KEYCLOAK_ADMIN_PASSWORD</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;**************&quot;</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_PROXY</span>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;edge&quot;</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_HTTP_ENABLED</span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_HTTPS_CERTIFICATE_FILE</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/etc/keycloak/ssl/tls.crt&quot;</span>
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_HTTPS_CERTIFICATE_KEY_FILE</span>
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/etc/keycloak/ssl/tls.key&quot;</span>
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_HOSTNAME_STRICT</span>
</span><span id="__span-4-37"><a id="__codelineno-4-37" name="__codelineno-4-37"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;false&quot;</span>
</span><span id="__span-4-38"><a id="__codelineno-4-38" name="__codelineno-4-38"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_HOSTNAME</span>
</span><span id="__span-4-39"><a id="__codelineno-4-39" name="__codelineno-4-39"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;108.96.27.44&quot;</span>
</span><span id="__span-4-40"><a id="__codelineno-4-40" name="__codelineno-4-40"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_HOSTNAME_PORT</span>
</span><span id="__span-4-41"><a id="__codelineno-4-41" name="__codelineno-4-41"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;9003&quot;</span>
</span><span id="__span-4-42"><a id="__codelineno-4-42" name="__codelineno-4-42"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_DB</span>
</span><span id="__span-4-43"><a id="__codelineno-4-43" name="__codelineno-4-43"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
</span><span id="__span-4-44"><a id="__codelineno-4-44" name="__codelineno-4-44"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_DB_USERNAME</span>
</span><span id="__span-4-45"><a id="__codelineno-4-45" name="__codelineno-4-45"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-4-46"><a id="__codelineno-4-46" name="__codelineno-4-46"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_DB_PASSWORD</span>
</span><span id="__span-4-47"><a id="__codelineno-4-47" name="__codelineno-4-47"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;********&#39;</span>
</span><span id="__span-4-48"><a id="__codelineno-4-48" name="__codelineno-4-48"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_DB_URL_HOST</span>
</span><span id="__span-4-49"><a id="__codelineno-4-49" name="__codelineno-4-49"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.100.243</span>
</span><span id="__span-4-50"><a id="__codelineno-4-50" name="__codelineno-4-50"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_DB_URL_PORT</span>
</span><span id="__span-4-51"><a id="__codelineno-4-51" name="__codelineno-4-51"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;3306&quot;</span>
</span><span id="__span-4-52"><a id="__codelineno-4-52" name="__codelineno-4-52"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_DB_URL_DATABASE</span>
</span><span id="__span-4-53"><a id="__codelineno-4-53" name="__codelineno-4-53"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-4-54"><a id="__codelineno-4-54" name="__codelineno-4-54"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_DB_URL</span>
</span><span id="__span-4-55"><a id="__codelineno-4-55" name="__codelineno-4-55"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;jdbc:mysql://192.168.100.243:3306/keycloak&quot;</span>
</span><span id="__span-4-56"><a id="__codelineno-4-56" name="__codelineno-4-56"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_CACHE_CONFIG_FILE</span>
</span><span id="__span-4-57"><a id="__codelineno-4-57" name="__codelineno-4-57"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cache-ispn.xml</span>
</span><span id="__span-4-58"><a id="__codelineno-4-58" name="__codelineno-4-58"></a><span class="w">          </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-4-59"><a id="__codelineno-4-59" name="__codelineno-4-59"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
</span><span id="__span-4-60"><a id="__codelineno-4-60" name="__codelineno-4-60"></a><span class="w">              </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</span><span id="__span-4-61"><a id="__codelineno-4-61" name="__codelineno-4-61"></a><span class="w">          </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-4-62"><a id="__codelineno-4-62" name="__codelineno-4-62"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">discovery</span>
</span><span id="__span-4-63"><a id="__codelineno-4-63" name="__codelineno-4-63"></a><span class="w">              </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">7600</span>
</span><span id="__span-4-64"><a id="__codelineno-4-64" name="__codelineno-4-64"></a><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span>
</span><span id="__span-4-65"><a id="__codelineno-4-65" name="__codelineno-4-65"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/etc/keycloak/ssl/&quot;</span>
</span><span id="__span-4-66"><a id="__codelineno-4-66" name="__codelineno-4-66"></a><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak-ssl</span>
</span><span id="__span-4-67"><a id="__codelineno-4-67" name="__codelineno-4-67"></a><span class="w">              </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-4-68"><a id="__codelineno-4-68" name="__codelineno-4-68"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cache-ispn</span>
</span><span id="__span-4-69"><a id="__codelineno-4-69" name="__codelineno-4-69"></a><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/opt/keycloak/conf/cache-ispn.xml</span>
</span><span id="__span-4-70"><a id="__codelineno-4-70" name="__codelineno-4-70"></a><span class="w">              </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cache-ispn.xml</span>
</span><span id="__span-4-71"><a id="__codelineno-4-71" name="__codelineno-4-71"></a><span class="w">          </span><span class="nt">readinessProbe</span><span class="p">:</span>
</span><span id="__span-4-72"><a id="__codelineno-4-72" name="__codelineno-4-72"></a><span class="w">            </span><span class="nt">httpGet</span><span class="p">:</span>
</span><span id="__span-4-73"><a id="__codelineno-4-73" name="__codelineno-4-73"></a><span class="w">              </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/realms/master</span>
</span><span id="__span-4-74"><a id="__codelineno-4-74" name="__codelineno-4-74"></a><span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</span><span id="__span-4-75"><a id="__codelineno-4-75" name="__codelineno-4-75"></a><span class="w">      </span><span class="nt">imagePullSecrets</span><span class="p">:</span>
</span><span id="__span-4-76"><a id="__codelineno-4-76" name="__codelineno-4-76"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nexus-regcred</span>
</span><span id="__span-4-77"><a id="__codelineno-4-77" name="__codelineno-4-77"></a><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-4-78"><a id="__codelineno-4-78" name="__codelineno-4-78"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak-ssl</span>
</span><span id="__span-4-79"><a id="__codelineno-4-79" name="__codelineno-4-79"></a><span class="w">          </span><span class="nt">secret</span><span class="p">:</span>
</span><span id="__span-4-80"><a id="__codelineno-4-80" name="__codelineno-4-80"></a><span class="w">            </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak-tls-secret</span>
</span><span id="__span-4-81"><a id="__codelineno-4-81" name="__codelineno-4-81"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cache-ispn</span>
</span><span id="__span-4-82"><a id="__codelineno-4-82" name="__codelineno-4-82"></a><span class="w">          </span><span class="nt">configMap</span><span class="p">:</span>
</span><span id="__span-4-83"><a id="__codelineno-4-83" name="__codelineno-4-83"></a><span class="w">            </span><span class="nt">defaultMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0755</span>
</span><span id="__span-4-84"><a id="__codelineno-4-84" name="__codelineno-4-84"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cache-ispn</span>
</span><span id="__span-4-85"><a id="__codelineno-4-85" name="__codelineno-4-85"></a><span class="w">            </span><span class="nt">items</span><span class="p">:</span>
</span><span id="__span-4-86"><a id="__codelineno-4-86" name="__codelineno-4-86"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cache-ispn.xml</span>
</span><span id="__span-4-87"><a id="__codelineno-4-87" name="__codelineno-4-87"></a><span class="w">              </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cache-ispn.xml</span>
</span></code></pre></div></td></tr></table></div>
<p>JDBC ping 的原理是每个 keycloak 都往数据库里的 JGROUPSPING 表写上自己的信息，通过读数据库来发现别的节点。在创建完成以后，需要进入到容器里，修改 admin realm 的 sslRequired 参数：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-__codelineno-5-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>keycloak<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>keycloak-8659669957-jrtqr<span class="w"> </span>--<span class="w"> </span>/bin/bash
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a>/opt/keycloak/bin/kcadm.sh<span class="w"> </span>update<span class="w"> </span>realms/master<span class="w"> </span>-s<span class="w"> </span><span class="nv">sslRequired</span><span class="o">=</span>NONE<span class="w"> </span>--server<span class="w"> </span>http://keycloak:8080<span class="w"> </span>--realm<span class="w"> </span>master<span class="w"> </span>--user<span class="w"> </span>admin
</span></code></pre></div></td></tr></table></div>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-31">3.1 配置负载均衡器<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-31" title="Permanent link">&para;</a></h3>
<p>负载均衡器配置如下，需要打开“附加 HTTP 头字段：[客户端真实 IP / X-Forwarded-For]”功能：
<img alt="" src="%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Keycloak/images/k8s%E5%AE%89%E8%A3%85keycloak_%E8%B4%9F%E8%BD%BD%E9%85%8D%E7%BD%AE.png" /></p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-4">4. 参考链接<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae-4" title="Permanent link">&para;</a></h2>
<p><a href="https://github.com/keycloak/keycloak-quickstarts/blob/release/24.0/kubernetes/keycloak.yaml">https://github.com/keycloak/keycloak-quickstarts/blob/release/24.0/kubernetes/keycloak.yaml</a></p>
<p><a href="https://www.keycloak.org/server/db#_supported_databases">https://www.keycloak.org/server/db#_supported_databases</a></p>
<p><a href="https://www.keycloak.org/server/hostname">https://www.keycloak.org/server/hostname</a></p>
<p><a href="https://www.keycloak.org/operator/basic-deployment">https://www.keycloak.org/operator/basic-deployment</a></p>
<p><a href="https://faun.pub/mount-ssl-certificates-in-kubernetes-pod-with-secret-8aca220896e6">https://faun.pub/mount-ssl-certificates-in-kubernetes-pod-with-secret-8aca220896e6</a></p>
<p><a href="https://www.keycloak.org/operator/advanced-configuration">https://www.keycloak.org/operator/advanced-configuration</a></p>
<p><a href="https://www.keycloak.org/server/all-config">https://www.keycloak.org/server/all-config</a></p>
<p><a href="https://www.keycloak.org/operator/basic-deployment">https://www.keycloak.org/operator/basic-deployment</a></p>
<p><a href="https://www.keycloak.org/operator/installation">https://www.keycloak.org/operator/installation</a></p>
<p><a href="https://www.keycloak.org/2019/05/keycloak-cluster-setup">https://www.keycloak.org/2019/05/keycloak-cluster-setup</a></p>
<p><a href="https://jbjerksetmyr.medium.com/how-to-setup-a-keycloak-server-with-external-mysql-database-on-aws-ecs-fargate-in-clustered-mode-edf664a765bf">https://jbjerksetmyr.medium.com/how-to-setup-a-keycloak-server-with-external-mysql-database-on-aws-ecs-fargate-in-clustered-mode-edf664a765bf</a></p></section><section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83" heading-number="5.2.3"><nav class='md-tags'><span class='md-tag'>Keycloak</span><span class='md-tag'>Docker</span></nav><h1 id="docker-compose-keycloak">使用 docker-compose 搭建 keycloak 开发环境<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-docker-compose-keycloak" title="Permanent link">&para;</a></h1>
<p>开发环境需要 keycloak ，使用 docker-compose 搭建运行在 <code>172.21.1.56:8085</code> 的 keycloak ，新建文件 <code>compose.yaml</code> ：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-19">19</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-20">20</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-21">21</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-22">22</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-23">23</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-24">24</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-25">25</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-26">26</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-27">27</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-28">28</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-29">29</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-30">30</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-31">31</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-32">32</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-33">33</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-34">34</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-35">35</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-36">36</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-37">37</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-38">38</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-39">39</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-40">40</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-41">41</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-42">42</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-43">43</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-44">44</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-45">45</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-46">46</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-47">47</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-48">48</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-49">49</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-50">50</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-0-51">51</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nn">---</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nt">networks</span><span class="p">:</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">geeker-admin</span><span class="p">:</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bridge</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">geeker-admin</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="nt">services</span><span class="p">:</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">  </span><span class="nt">keycloak</span><span class="p">:</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">start-dev</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">geeker-admin-keycloak</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">      </span><span class="nt">KC_DB</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">      </span><span class="nt">KC_DB_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MyKeycloakMySQLPassword</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">      </span><span class="nt">KC_DB_URL</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jdbc:mysql://mysql:3306/keycloak</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">      </span><span class="nt">KC_DB_USERNAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">      </span><span class="nt">KC_HEALTH_ENABLED</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">      </span><span class="nt">KC_HOSTNAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">172.21.1.56</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">      </span><span class="nt">KC_HOSTNAME_PORT</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8085</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">      </span><span class="nt">KC_HOSTNAME_STRICT_BACKCHANNEL</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">      </span><span class="nt">KC_HOSTNAME_STRICT_HTTPS</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">      </span><span class="nt">KC_HTTP_ENABLED</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">      </span><span class="nt">KEYCLOAK_ADMIN</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">      </span><span class="nt">KEYCLOAK_ADMIN_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="w">    </span><span class="nt">expose</span><span class="p">:</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">quay.io/keycloak/keycloak:24.0</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">geeker-admin</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8085:8080</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="w">  </span><span class="nt">mysql</span><span class="p">:</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">geeker-admin-mysql</span>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="w">      </span><span class="nt">MYSQL_DATABASE</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="w">      </span><span class="nt">MYSQL_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MyKeycloakMySQLPassword</span>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="w">      </span><span class="nt">MYSQL_ROOT_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MyRootPassword</span>
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="w">      </span><span class="nt">MYSQL_USER</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="w">    </span><span class="nt">expose</span><span class="p">:</span>
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3306</span>
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql:8.0</span>
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
</span><span id="__span-0-44"><a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">geeker-admin</span>
</span><span id="__span-0-45"><a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
</span><span id="__span-0-46"><a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-0-47"><a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql:/var/lib/mysql</span>
</span><span id="__span-0-48"><a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-0-49"><a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="w">  </span><span class="nt">mysql</span><span class="p">:</span>
</span><span id="__span-0-50"><a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
</span><span id="__span-0-51"><a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">geeker-admin-mysql</span>
</span></code></pre></div></td></tr></table></div>
<p>特别注意， <code>KC_HOSTNAME</code> 一定配置成服务器外部域名或 IP，不能是 <code>localhost</code> 。启动：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>docker compose up
</span></code></pre></div></td></tr></table></div>
<p>注：第一次启动可能不成功，需要重启一次。</p></section><section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak" heading-number="5.2.4"><nav class='md-tags'><span class='md-tag'>Keycloak</span><span class='md-tag'>Kubernetes</span></nav><h1 id="k3s-keycloak">k3s 搭建单点 keycloak<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-k3s-keycloak" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-1-mysql">1. 部署 MySQL 数据库<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-1-mysql" title="Permanent link">&para;</a></h2>
<p>使用 statefulset 部署 MySQL 数据库， yaml 配置文件如下：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-19">19</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-20">20</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-21">21</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-22">22</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-23">23</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-24">24</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-25">25</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-26">26</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-27">27</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-28">28</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-29">29</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-30">30</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-31">31</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-32">32</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-33">33</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-34">34</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-35">35</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-36">36</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-37">37</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-38">38</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-39">39</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-40">40</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-41">41</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-42">42</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-43">43</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-44">44</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-45">45</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-46">46</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-47">47</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-48">48</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-49">49</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-50">50</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-51">51</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-52">52</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-53">53</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-54">54</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-55">55</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-56">56</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-57">57</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-58">58</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-59">59</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-60">60</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-61">61</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-62">62</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-63">63</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-0-64">64</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nn">---</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">StatefulSet</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">env</span><span class="p">:</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MYSQL_DATABASE</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MYSQL_PASSWORD</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MYSQL_ROOT_PASSWORD</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MYSQL_USER</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql:8.0</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="w">          </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3306</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="w">              </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/mysql</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="w">          </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span>
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="w">            </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="nn">---</span>
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-0-44"><a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
</span><span id="__span-0-45"><a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-0-46"><a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-0-47"><a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-0-48"><a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span id="__span-0-49"><a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-0-50"><a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="w">    </span><span class="nt">requests</span><span class="p">:</span>
</span><span id="__span-0-51"><a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</span><span id="__span-0-52"><a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="nn">---</span>
</span><span id="__span-0-53"><a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-0-54"><a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
</span><span id="__span-0-55"><a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-0-56"><a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
</span><span id="__span-0-57"><a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-0-58"><a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-0-59"><a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-0-60"><a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;3306&quot;</span>
</span><span id="__span-0-61"><a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3306</span>
</span><span id="__span-0-62"><a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3306</span>
</span><span id="__span-0-63"><a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-0-64"><a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-2-ssl">2. 生成 SSL 证书<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-2-ssl" title="Permanent link">&para;</a></h2>
<p>即使不使用，也需要自签证书，否则 Keycloak 无法以生成模式启动：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>openssl<span class="w"> </span>req<span class="w"> </span>-subj<span class="w"> </span><span class="s1">&#39;/CN=test.keycloak.org/O=Test Keycloak./C=US&#39;</span><span class="w"> </span>-newkey<span class="w"> </span>rsa:2048<span class="w"> </span>-nodes<span class="w"> </span>-keyout<span class="w"> </span>key.pem<span class="w"> </span>-x509<span class="w"> </span>-days<span class="w"> </span><span class="m">3650</span><span class="w"> </span>-out<span class="w"> </span>certificate.pem
</span></code></pre></div></td></tr></table></div>
<p>将证书由 k8s 管理：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>keycloak<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>tls<span class="w"> </span>keycloak<span class="w"> </span>--cert<span class="o">=</span>certificate.pem<span class="w"> </span>--key<span class="o">=</span>key.pem
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-3-keycloak">3. 部署 Keycloak<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-3-keycloak" title="Permanent link">&para;</a></h2>
<p>先创建 service，暴露服务端口 30081 （如果修改此端口则后续都需要修改）：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-3-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-3-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-3-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-3-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-3-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-3-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-3-16">16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-3-17">17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-3-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nn">---</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NodePort</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">      </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30081</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LoadBalancer</span>
</span></code></pre></div></td></tr></table></div>
<p>在默认情况下，keycloak 不同容器之间的互相发现是靠 IP multicast 广播实现，但是由于在 k8s 环境下，calico 和 fannel 不支持 multicast，不同 k8s 节点的 keycloak 容器广播不可达，就无法通过 multicast 发现彼此。默认的 multicast 服务发现方式在 calico 和 fannel 下不可使用，就需要自己写配置 <code>cache-ispn.xml</code> 替换容器里的来实现 keycloak 使用 JDBC ping 来发现彼此，这里直接把配置写 configmap 然后挂载到容器：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-1">  1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-2">  2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-3">  3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-4">  4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-5">  5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-6">  6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-7">  7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-8">  8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-9">  9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-10"> 10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-11"> 11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-12"> 12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-13"> 13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-14"> 14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-15"> 15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-16"> 16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-17"> 17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-18"> 18</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-19"> 19</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-20"> 20</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-21"> 21</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-22"> 22</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-23"> 23</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-24"> 24</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-25"> 25</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-26"> 26</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-27"> 27</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-28"> 28</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-29"> 29</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-30"> 30</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-31"> 31</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-32"> 32</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-33"> 33</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-34"> 34</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-35"> 35</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-36"> 36</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-37"> 37</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-38"> 38</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-39"> 39</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-40"> 40</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-41"> 41</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-42"> 42</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-43"> 43</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-44"> 44</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-45"> 45</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-46"> 46</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-47"> 47</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-48"> 48</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-49"> 49</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-50"> 50</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-51"> 51</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-52"> 52</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-53"> 53</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-54"> 54</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-55"> 55</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-56"> 56</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-57"> 57</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-58"> 58</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-59"> 59</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-60"> 60</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-61"> 61</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-62"> 62</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-63"> 63</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-64"> 64</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-65"> 65</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-66"> 66</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-67"> 67</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-68"> 68</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-69"> 69</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-70"> 70</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-71"> 71</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-72"> 72</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-73"> 73</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-74"> 74</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-75"> 75</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-76"> 76</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-77"> 77</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-78"> 78</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-79"> 79</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-80"> 80</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-81"> 81</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-82"> 82</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-83"> 83</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-84"> 84</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-85"> 85</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-86"> 86</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-87"> 87</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-88"> 88</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-89"> 89</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-90"> 90</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-91"> 91</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-92"> 92</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-93"> 93</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-94"> 94</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-95"> 95</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-96"> 96</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-97"> 97</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-98"> 98</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-99"> 99</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-100">100</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-101">101</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-102">102</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-103">103</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-104">104</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-105">105</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-4-106">106</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="nn">---</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cache-ispn</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="nt">data</span><span class="p">:</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">  </span><span class="nt">cache-ispn.xml</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">    </span><span class="no">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">    </span><span class="no">&lt;!--</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">      </span><span class="no">~ Copyright 2019 Red Hat, Inc. and/or its affiliates</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="w">      </span><span class="no">~ and other contributors as indicated by the @author tags.</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="w">      </span><span class="no">~</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">      </span><span class="no">~ Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">      </span><span class="no">~ you may not use this file except in compliance with the License.</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">      </span><span class="no">~ You may obtain a copy of the License at</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="w">      </span><span class="no">~</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="w">      </span><span class="no">~ http://www.apache.org/licenses/LICENSE-2.0</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="w">      </span><span class="no">~</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="w">      </span><span class="no">~ Unless required by applicable law or agreed to in writing, software</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="w">      </span><span class="no">~ distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="w">      </span><span class="no">~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="w">      </span><span class="no">~ See the License for the specific language governing permissions and</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24"></a><span class="w">      </span><span class="no">~ limitations under the License.</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25"></a><span class="w">      </span><span class="no">--&gt;</span>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26"></a>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27"></a><span class="w">    </span><span class="no">&lt;infinispan</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28"></a><span class="w">            </span><span class="no">xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29"></a><span class="w">            </span><span class="no">xsi:schemaLocation=&quot;urn:infinispan:config:14.0 http://www.infinispan.org/schemas/infinispan-config-14.0.xsd&quot;</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30"></a><span class="w">            </span><span class="no">xmlns=&quot;urn:infinispan:config:14.0&quot;&gt;</span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31"></a><span class="w">        </span><span class="no">&lt;jgroups&gt;</span>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32"></a><span class="w">            </span><span class="no">&lt;stack name=&quot;jdbc-ping-tcp&quot; extends=&quot;tcp&quot;&gt;</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33"></a><span class="w">                </span><span class="no">&lt;JDBC_PING connection_driver=&quot;com.mysql.cj.jdbc.Driver&quot;</span>
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34"></a><span class="w">                        </span><span class="no">connection_username=&quot;${env.KC_DB_USERNAME}&quot;</span>
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35"></a><span class="w">                        </span><span class="no">connection_password=&quot;${env.KC_DB_PASSWORD}&quot;</span>
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36"></a><span class="w">                        </span><span class="no">connection_url=&quot;${env.KC_DB_URL}&quot;</span>
</span><span id="__span-4-37"><a id="__codelineno-4-37" name="__codelineno-4-37"></a><span class="w">                        </span><span class="no">info_writer_sleep_time=&quot;500&quot;</span>
</span><span id="__span-4-38"><a id="__codelineno-4-38" name="__codelineno-4-38"></a><span class="w">                        </span><span class="no">initialize_sql=&quot;CREATE TABLE IF NOT EXISTS JGROUPSPING (own_addr varchar(200) NOT NULL, cluster_name varchar(200) NOT NULL, ping_data VARBINARY(255), constraint PK_JGROUPSPING PRIMARY KEY (own_addr, cluster_name));&quot;</span>
</span><span id="__span-4-39"><a id="__codelineno-4-39" name="__codelineno-4-39"></a><span class="w">                        </span><span class="no">remove_all_data_on_view_change=&quot;true&quot;</span>
</span><span id="__span-4-40"><a id="__codelineno-4-40" name="__codelineno-4-40"></a><span class="w">                        </span><span class="no">stack.combine=&quot;REPLACE&quot;</span>
</span><span id="__span-4-41"><a id="__codelineno-4-41" name="__codelineno-4-41"></a><span class="w">                        </span><span class="no">stack.position=&quot;MPING&quot; /&gt;</span>
</span><span id="__span-4-42"><a id="__codelineno-4-42" name="__codelineno-4-42"></a><span class="w">            </span><span class="no">&lt;/stack&gt;</span>
</span><span id="__span-4-43"><a id="__codelineno-4-43" name="__codelineno-4-43"></a><span class="w">        </span><span class="no">&lt;/jgroups&gt;</span>
</span><span id="__span-4-44"><a id="__codelineno-4-44" name="__codelineno-4-44"></a><span class="w">        </span><span class="no">&lt;cache-container name=&quot;keycloak&quot;&gt;</span>
</span><span id="__span-4-45"><a id="__codelineno-4-45" name="__codelineno-4-45"></a><span class="w">            </span><span class="no">&lt;transport lock-timeout=&quot;60000&quot; stack=&quot;jdbc-ping-tcp&quot;/&gt;</span>
</span><span id="__span-4-46"><a id="__codelineno-4-46" name="__codelineno-4-46"></a><span class="w">            </span><span class="no">&lt;metrics names-as-tags=&quot;true&quot; /&gt;</span>
</span><span id="__span-4-47"><a id="__codelineno-4-47" name="__codelineno-4-47"></a><span class="w">            </span><span class="no">&lt;local-cache name=&quot;realms&quot;&gt;</span>
</span><span id="__span-4-48"><a id="__codelineno-4-48" name="__codelineno-4-48"></a><span class="w">                </span><span class="no">&lt;encoding&gt;</span>
</span><span id="__span-4-49"><a id="__codelineno-4-49" name="__codelineno-4-49"></a><span class="w">                    </span><span class="no">&lt;key media-type=&quot;application/x-java-object&quot;/&gt;</span>
</span><span id="__span-4-50"><a id="__codelineno-4-50" name="__codelineno-4-50"></a><span class="w">                    </span><span class="no">&lt;value media-type=&quot;application/x-java-object&quot;/&gt;</span>
</span><span id="__span-4-51"><a id="__codelineno-4-51" name="__codelineno-4-51"></a><span class="w">                </span><span class="no">&lt;/encoding&gt;</span>
</span><span id="__span-4-52"><a id="__codelineno-4-52" name="__codelineno-4-52"></a><span class="w">                </span><span class="no">&lt;memory max-count=&quot;10000&quot;/&gt;</span>
</span><span id="__span-4-53"><a id="__codelineno-4-53" name="__codelineno-4-53"></a><span class="w">            </span><span class="no">&lt;/local-cache&gt;</span>
</span><span id="__span-4-54"><a id="__codelineno-4-54" name="__codelineno-4-54"></a><span class="w">            </span><span class="no">&lt;local-cache name=&quot;users&quot;&gt;</span>
</span><span id="__span-4-55"><a id="__codelineno-4-55" name="__codelineno-4-55"></a><span class="w">                </span><span class="no">&lt;encoding&gt;</span>
</span><span id="__span-4-56"><a id="__codelineno-4-56" name="__codelineno-4-56"></a><span class="w">                    </span><span class="no">&lt;key media-type=&quot;application/x-java-object&quot;/&gt;</span>
</span><span id="__span-4-57"><a id="__codelineno-4-57" name="__codelineno-4-57"></a><span class="w">                    </span><span class="no">&lt;value media-type=&quot;application/x-java-object&quot;/&gt;</span>
</span><span id="__span-4-58"><a id="__codelineno-4-58" name="__codelineno-4-58"></a><span class="w">                </span><span class="no">&lt;/encoding&gt;</span>
</span><span id="__span-4-59"><a id="__codelineno-4-59" name="__codelineno-4-59"></a><span class="w">                </span><span class="no">&lt;memory max-count=&quot;10000&quot;/&gt;</span>
</span><span id="__span-4-60"><a id="__codelineno-4-60" name="__codelineno-4-60"></a><span class="w">            </span><span class="no">&lt;/local-cache&gt;</span>
</span><span id="__span-4-61"><a id="__codelineno-4-61" name="__codelineno-4-61"></a><span class="w">            </span><span class="no">&lt;distributed-cache name=&quot;sessions&quot; owners=&quot;2&quot;&gt;</span>
</span><span id="__span-4-62"><a id="__codelineno-4-62" name="__codelineno-4-62"></a><span class="w">                </span><span class="no">&lt;expiration lifespan=&quot;-1&quot;/&gt;</span>
</span><span id="__span-4-63"><a id="__codelineno-4-63" name="__codelineno-4-63"></a><span class="w">            </span><span class="no">&lt;/distributed-cache&gt;</span>
</span><span id="__span-4-64"><a id="__codelineno-4-64" name="__codelineno-4-64"></a><span class="w">            </span><span class="no">&lt;distributed-cache name=&quot;authenticationSessions&quot; owners=&quot;2&quot;&gt;</span>
</span><span id="__span-4-65"><a id="__codelineno-4-65" name="__codelineno-4-65"></a><span class="w">                </span><span class="no">&lt;expiration lifespan=&quot;-1&quot;/&gt;</span>
</span><span id="__span-4-66"><a id="__codelineno-4-66" name="__codelineno-4-66"></a><span class="w">            </span><span class="no">&lt;/distributed-cache&gt;</span>
</span><span id="__span-4-67"><a id="__codelineno-4-67" name="__codelineno-4-67"></a><span class="w">            </span><span class="no">&lt;distributed-cache name=&quot;offlineSessions&quot; owners=&quot;2&quot;&gt;</span>
</span><span id="__span-4-68"><a id="__codelineno-4-68" name="__codelineno-4-68"></a><span class="w">                </span><span class="no">&lt;expiration lifespan=&quot;-1&quot;/&gt;</span>
</span><span id="__span-4-69"><a id="__codelineno-4-69" name="__codelineno-4-69"></a><span class="w">            </span><span class="no">&lt;/distributed-cache&gt;</span>
</span><span id="__span-4-70"><a id="__codelineno-4-70" name="__codelineno-4-70"></a><span class="w">            </span><span class="no">&lt;distributed-cache name=&quot;clientSessions&quot; owners=&quot;2&quot;&gt;</span>
</span><span id="__span-4-71"><a id="__codelineno-4-71" name="__codelineno-4-71"></a><span class="w">                </span><span class="no">&lt;expiration lifespan=&quot;-1&quot;/&gt;</span>
</span><span id="__span-4-72"><a id="__codelineno-4-72" name="__codelineno-4-72"></a><span class="w">            </span><span class="no">&lt;/distributed-cache&gt;</span>
</span><span id="__span-4-73"><a id="__codelineno-4-73" name="__codelineno-4-73"></a><span class="w">            </span><span class="no">&lt;distributed-cache name=&quot;offlineClientSessions&quot; owners=&quot;2&quot;&gt;</span>
</span><span id="__span-4-74"><a id="__codelineno-4-74" name="__codelineno-4-74"></a><span class="w">                </span><span class="no">&lt;expiration lifespan=&quot;-1&quot;/&gt;</span>
</span><span id="__span-4-75"><a id="__codelineno-4-75" name="__codelineno-4-75"></a><span class="w">            </span><span class="no">&lt;/distributed-cache&gt;</span>
</span><span id="__span-4-76"><a id="__codelineno-4-76" name="__codelineno-4-76"></a><span class="w">            </span><span class="no">&lt;distributed-cache name=&quot;loginFailures&quot; owners=&quot;2&quot;&gt;</span>
</span><span id="__span-4-77"><a id="__codelineno-4-77" name="__codelineno-4-77"></a><span class="w">                </span><span class="no">&lt;expiration lifespan=&quot;-1&quot;/&gt;</span>
</span><span id="__span-4-78"><a id="__codelineno-4-78" name="__codelineno-4-78"></a><span class="w">            </span><span class="no">&lt;/distributed-cache&gt;</span>
</span><span id="__span-4-79"><a id="__codelineno-4-79" name="__codelineno-4-79"></a><span class="w">            </span><span class="no">&lt;local-cache name=&quot;authorization&quot;&gt;</span>
</span><span id="__span-4-80"><a id="__codelineno-4-80" name="__codelineno-4-80"></a><span class="w">                </span><span class="no">&lt;encoding&gt;</span>
</span><span id="__span-4-81"><a id="__codelineno-4-81" name="__codelineno-4-81"></a><span class="w">                    </span><span class="no">&lt;key media-type=&quot;application/x-java-object&quot;/&gt;</span>
</span><span id="__span-4-82"><a id="__codelineno-4-82" name="__codelineno-4-82"></a><span class="w">                    </span><span class="no">&lt;value media-type=&quot;application/x-java-object&quot;/&gt;</span>
</span><span id="__span-4-83"><a id="__codelineno-4-83" name="__codelineno-4-83"></a><span class="w">                </span><span class="no">&lt;/encoding&gt;</span>
</span><span id="__span-4-84"><a id="__codelineno-4-84" name="__codelineno-4-84"></a><span class="w">                </span><span class="no">&lt;memory max-count=&quot;10000&quot;/&gt;</span>
</span><span id="__span-4-85"><a id="__codelineno-4-85" name="__codelineno-4-85"></a><span class="w">            </span><span class="no">&lt;/local-cache&gt;</span>
</span><span id="__span-4-86"><a id="__codelineno-4-86" name="__codelineno-4-86"></a><span class="w">            </span><span class="no">&lt;replicated-cache name=&quot;work&quot;&gt;</span>
</span><span id="__span-4-87"><a id="__codelineno-4-87" name="__codelineno-4-87"></a><span class="w">                </span><span class="no">&lt;expiration lifespan=&quot;-1&quot;/&gt;</span>
</span><span id="__span-4-88"><a id="__codelineno-4-88" name="__codelineno-4-88"></a><span class="w">            </span><span class="no">&lt;/replicated-cache&gt;</span>
</span><span id="__span-4-89"><a id="__codelineno-4-89" name="__codelineno-4-89"></a><span class="w">            </span><span class="no">&lt;local-cache name=&quot;keys&quot;&gt;</span>
</span><span id="__span-4-90"><a id="__codelineno-4-90" name="__codelineno-4-90"></a><span class="w">                </span><span class="no">&lt;encoding&gt;</span>
</span><span id="__span-4-91"><a id="__codelineno-4-91" name="__codelineno-4-91"></a><span class="w">                    </span><span class="no">&lt;key media-type=&quot;application/x-java-object&quot;/&gt;</span>
</span><span id="__span-4-92"><a id="__codelineno-4-92" name="__codelineno-4-92"></a><span class="w">                    </span><span class="no">&lt;value media-type=&quot;application/x-java-object&quot;/&gt;</span>
</span><span id="__span-4-93"><a id="__codelineno-4-93" name="__codelineno-4-93"></a><span class="w">                </span><span class="no">&lt;/encoding&gt;</span>
</span><span id="__span-4-94"><a id="__codelineno-4-94" name="__codelineno-4-94"></a><span class="w">                </span><span class="no">&lt;expiration max-idle=&quot;3600000&quot;/&gt;</span>
</span><span id="__span-4-95"><a id="__codelineno-4-95" name="__codelineno-4-95"></a><span class="w">                </span><span class="no">&lt;memory max-count=&quot;1000&quot;/&gt;</span>
</span><span id="__span-4-96"><a id="__codelineno-4-96" name="__codelineno-4-96"></a><span class="w">            </span><span class="no">&lt;/local-cache&gt;</span>
</span><span id="__span-4-97"><a id="__codelineno-4-97" name="__codelineno-4-97"></a><span class="w">            </span><span class="no">&lt;distributed-cache name=&quot;actionTokens&quot; owners=&quot;2&quot;&gt;</span>
</span><span id="__span-4-98"><a id="__codelineno-4-98" name="__codelineno-4-98"></a><span class="w">                </span><span class="no">&lt;encoding&gt;</span>
</span><span id="__span-4-99"><a id="__codelineno-4-99" name="__codelineno-4-99"></a><span class="w">                    </span><span class="no">&lt;key media-type=&quot;application/x-java-object&quot;/&gt;</span>
</span><span id="__span-4-100"><a id="__codelineno-4-100" name="__codelineno-4-100"></a><span class="w">                    </span><span class="no">&lt;value media-type=&quot;application/x-java-object&quot;/&gt;</span>
</span><span id="__span-4-101"><a id="__codelineno-4-101" name="__codelineno-4-101"></a><span class="w">                </span><span class="no">&lt;/encoding&gt;</span>
</span><span id="__span-4-102"><a id="__codelineno-4-102" name="__codelineno-4-102"></a><span class="w">                </span><span class="no">&lt;expiration max-idle=&quot;-1&quot; lifespan=&quot;-1&quot; interval=&quot;300000&quot;/&gt;</span>
</span><span id="__span-4-103"><a id="__codelineno-4-103" name="__codelineno-4-103"></a><span class="w">                </span><span class="no">&lt;memory max-count=&quot;-1&quot;/&gt;</span>
</span><span id="__span-4-104"><a id="__codelineno-4-104" name="__codelineno-4-104"></a><span class="w">            </span><span class="no">&lt;/distributed-cache&gt;</span>
</span><span id="__span-4-105"><a id="__codelineno-4-105" name="__codelineno-4-105"></a><span class="w">        </span><span class="no">&lt;/cache-container&gt;</span>
</span><span id="__span-4-106"><a id="__codelineno-4-106" name="__codelineno-4-106"></a><span class="w">    </span><span class="no">&lt;/infinispan&gt;</span>
</span></code></pre></div></td></tr></table></div>
<p>再创建 deployment：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-16">16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-17">17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-18">18</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-19">19</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-20">20</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-21">21</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-22">22</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-23">23</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-24">24</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-25">25</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-26">26</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-27">27</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-28">28</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-29">29</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-30">30</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-31">31</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-32">32</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-33">33</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-34">34</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-35">35</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-36">36</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-37">37</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-38">38</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-39">39</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-40">40</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-41">41</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-42">42</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-43">43</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-44">44</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-45">45</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-46">46</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-47">47</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-48">48</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-49">49</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-50">50</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-51">51</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-52">52</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-53">53</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-54">54</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-55">55</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-56">56</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-57">57</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-58">58</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-59">59</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-60">60</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-61">61</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-62">62</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-63">63</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-64">64</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-65">65</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-66">66</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-67">67</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-68">68</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-69">69</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-70">70</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-71">71</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-72">72</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-73">73</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-74">74</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-75">75</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-76">76</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-77">77</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-78">78</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-79">79</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-80">80</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-81">81</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-82">82</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-83">83</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-84">84</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-5-85">85</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nn">---</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21"></a><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">quay.io/keycloak/keycloak:24.0</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="w">          </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;start&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--hostname-strict-https=false&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23"></a><span class="w">          </span><span class="nt">env</span><span class="p">:</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KEYCLOAK_ADMIN</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;admin&quot;</span>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KEYCLOAK_ADMIN_PASSWORD</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;admin&quot;</span>
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_PROXY</span>
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;edge&quot;</span>
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_HTTP_ENABLED</span>
</span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
</span><span id="__span-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_HTTPS_CERTIFICATE_FILE</span>
</span><span id="__span-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/etc/keycloak/ssl/tls.crt&quot;</span>
</span><span id="__span-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_HTTPS_CERTIFICATE_KEY_FILE</span>
</span><span id="__span-5-35"><a id="__codelineno-5-35" name="__codelineno-5-35"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/etc/keycloak/ssl/tls.key&quot;</span>
</span><span id="__span-5-36"><a id="__codelineno-5-36" name="__codelineno-5-36"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_HOSTNAME_STRICT</span>
</span><span id="__span-5-37"><a id="__codelineno-5-37" name="__codelineno-5-37"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;false&quot;</span>
</span><span id="__span-5-38"><a id="__codelineno-5-38" name="__codelineno-5-38"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_HOSTNAME</span>
</span><span id="__span-5-39"><a id="__codelineno-5-39" name="__codelineno-5-39"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;keycloak.hxp.lan&quot;</span>
</span><span id="__span-5-40"><a id="__codelineno-5-40" name="__codelineno-5-40"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_HOSTNAME_PORT</span>
</span><span id="__span-5-41"><a id="__codelineno-5-41" name="__codelineno-5-41"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;30081&quot;</span>
</span><span id="__span-5-42"><a id="__codelineno-5-42" name="__codelineno-5-42"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_DB</span>
</span><span id="__span-5-43"><a id="__codelineno-5-43" name="__codelineno-5-43"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
</span><span id="__span-5-44"><a id="__codelineno-5-44" name="__codelineno-5-44"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_DB_USERNAME</span>
</span><span id="__span-5-45"><a id="__codelineno-5-45" name="__codelineno-5-45"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-5-46"><a id="__codelineno-5-46" name="__codelineno-5-46"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_DB_PASSWORD</span>
</span><span id="__span-5-47"><a id="__codelineno-5-47" name="__codelineno-5-47"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-5-48"><a id="__codelineno-5-48" name="__codelineno-5-48"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_DB_URL_HOST</span>
</span><span id="__span-5-49"><a id="__codelineno-5-49" name="__codelineno-5-49"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
</span><span id="__span-5-50"><a id="__codelineno-5-50" name="__codelineno-5-50"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_DB_URL_PORT</span>
</span><span id="__span-5-51"><a id="__codelineno-5-51" name="__codelineno-5-51"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;3306&quot;</span>
</span><span id="__span-5-52"><a id="__codelineno-5-52" name="__codelineno-5-52"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_DB_URL_DATABASE</span>
</span><span id="__span-5-53"><a id="__codelineno-5-53" name="__codelineno-5-53"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-5-54"><a id="__codelineno-5-54" name="__codelineno-5-54"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_DB_URL</span>
</span><span id="__span-5-55"><a id="__codelineno-5-55" name="__codelineno-5-55"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;jdbc:mysql://mysql:3306/keycloak&quot;</span>
</span><span id="__span-5-56"><a id="__codelineno-5-56" name="__codelineno-5-56"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KC_CACHE_CONFIG_FILE</span>
</span><span id="__span-5-57"><a id="__codelineno-5-57" name="__codelineno-5-57"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cache-ispn.xml</span>
</span><span id="__span-5-58"><a id="__codelineno-5-58" name="__codelineno-5-58"></a><span class="w">          </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-5-59"><a id="__codelineno-5-59" name="__codelineno-5-59"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
</span><span id="__span-5-60"><a id="__codelineno-5-60" name="__codelineno-5-60"></a><span class="w">              </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</span><span id="__span-5-61"><a id="__codelineno-5-61" name="__codelineno-5-61"></a><span class="w">          </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-5-62"><a id="__codelineno-5-62" name="__codelineno-5-62"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">discovery</span>
</span><span id="__span-5-63"><a id="__codelineno-5-63" name="__codelineno-5-63"></a><span class="w">              </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">7600</span>
</span><span id="__span-5-64"><a id="__codelineno-5-64" name="__codelineno-5-64"></a><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span>
</span><span id="__span-5-65"><a id="__codelineno-5-65" name="__codelineno-5-65"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/etc/keycloak/ssl/&quot;</span>
</span><span id="__span-5-66"><a id="__codelineno-5-66" name="__codelineno-5-66"></a><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak-ssl</span>
</span><span id="__span-5-67"><a id="__codelineno-5-67" name="__codelineno-5-67"></a><span class="w">              </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-5-68"><a id="__codelineno-5-68" name="__codelineno-5-68"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cache-ispn</span>
</span><span id="__span-5-69"><a id="__codelineno-5-69" name="__codelineno-5-69"></a><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/opt/keycloak/conf/cache-ispn.xml</span>
</span><span id="__span-5-70"><a id="__codelineno-5-70" name="__codelineno-5-70"></a><span class="w">              </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cache-ispn.xml</span>
</span><span id="__span-5-71"><a id="__codelineno-5-71" name="__codelineno-5-71"></a><span class="w">          </span><span class="nt">readinessProbe</span><span class="p">:</span>
</span><span id="__span-5-72"><a id="__codelineno-5-72" name="__codelineno-5-72"></a><span class="w">            </span><span class="nt">httpGet</span><span class="p">:</span>
</span><span id="__span-5-73"><a id="__codelineno-5-73" name="__codelineno-5-73"></a><span class="w">              </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/realms/master</span>
</span><span id="__span-5-74"><a id="__codelineno-5-74" name="__codelineno-5-74"></a><span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</span><span id="__span-5-75"><a id="__codelineno-5-75" name="__codelineno-5-75"></a><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-5-76"><a id="__codelineno-5-76" name="__codelineno-5-76"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak-ssl</span>
</span><span id="__span-5-77"><a id="__codelineno-5-77" name="__codelineno-5-77"></a><span class="w">          </span><span class="nt">secret</span><span class="p">:</span>
</span><span id="__span-5-78"><a id="__codelineno-5-78" name="__codelineno-5-78"></a><span class="w">            </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-5-79"><a id="__codelineno-5-79" name="__codelineno-5-79"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cache-ispn</span>
</span><span id="__span-5-80"><a id="__codelineno-5-80" name="__codelineno-5-80"></a><span class="w">          </span><span class="nt">configMap</span><span class="p">:</span>
</span><span id="__span-5-81"><a id="__codelineno-5-81" name="__codelineno-5-81"></a><span class="w">            </span><span class="nt">defaultMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0755</span>
</span><span id="__span-5-82"><a id="__codelineno-5-82" name="__codelineno-5-82"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cache-ispn</span>
</span><span id="__span-5-83"><a id="__codelineno-5-83" name="__codelineno-5-83"></a><span class="w">            </span><span class="nt">items</span><span class="p">:</span>
</span><span id="__span-5-84"><a id="__codelineno-5-84" name="__codelineno-5-84"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cache-ispn.xml</span>
</span><span id="__span-5-85"><a id="__codelineno-5-85" name="__codelineno-5-85"></a><span class="w">              </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cache-ispn.xml</span>
</span></code></pre></div></td></tr></table></div>
<p>JDBC ping 的原理是每个 keycloak 都往数据库里的 JGROUPSPING 表写上自己的信息，通过读数据库来发现别的节点。在创建完成以后，需要进入到容器里，修改 admin realm 的 sslRequired 参数（此时容器为 NotReady 状态为正常现象）：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-__codelineno-6-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>keycloak<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>keycloak-59d77cf866-mjchw<span class="w"> </span>--<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;/opt/keycloak/bin/kcadm.sh update realms/master -s sslRequired=NONE --server http://keycloak:8080 --realm master --user admin&#39;</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-4">4. 参考链接<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak-4" title="Permanent link">&para;</a></h2>
<p><a href="https://github.com/keycloak/keycloak-quickstarts/blob/release/24.0/kubernetes/keycloak.yaml">https://github.com/keycloak/keycloak-quickstarts/blob/release/24.0/kubernetes/keycloak.yaml</a></p>
<p><a href="https://www.keycloak.org/server/db#_supported_databases">https://www.keycloak.org/server/db#_supported_databases</a></p>
<p><a href="https://www.keycloak.org/server/hostname">https://www.keycloak.org/server/hostname</a></p>
<p><a href="https://www.keycloak.org/operator/basic-deployment">https://www.keycloak.org/operator/basic-deployment</a></p>
<p><a href="https://faun.pub/mount-ssl-certificates-in-kubernetes-pod-with-secret-8aca220896e6">https://faun.pub/mount-ssl-certificates-in-kubernetes-pod-with-secret-8aca220896e6</a></p>
<p><a href="https://www.keycloak.org/operator/advanced-configuration">https://www.keycloak.org/operator/advanced-configuration</a></p>
<p><a href="https://www.keycloak.org/server/all-config">https://www.keycloak.org/server/all-config</a></p>
<p><a href="https://www.keycloak.org/operator/basic-deployment">https://www.keycloak.org/operator/basic-deployment</a></p>
<p><a href="https://www.keycloak.org/operator/installation">https://www.keycloak.org/operator/installation</a></p>
<p><a href="https://www.keycloak.org/2019/05/keycloak-cluster-setup">https://www.keycloak.org/2019/05/keycloak-cluster-setup</a></p>
<p><a href="https://jbjerksetmyr.medium.com/how-to-setup-a-keycloak-server-with-external-mysql-database-on-aws-ecs-fargate-in-clustered-mode-edf664a765bf">https://jbjerksetmyr.medium.com/how-to-setup-a-keycloak-server-with-external-mysql-database-on-aws-ecs-fargate-in-clustered-mode-edf664a765bf</a></p></section></section>
                    <section class='print-page md-section' id='section-5-3' heading-number='5.3'>
                        <h1>笔记及文档软件<a class='headerlink' href='#section-5-3' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2" heading-number="5.3.1"><nav class='md-tags'><span class='md-tag'>思源笔记</span><span class='md-tag'>Keycloak</span><span class='md-tag'>Kubernetes</span></nav><h1 id="k8s">思源笔记 k8s 部署<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-k8s" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-1">1. 前置条件<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-1" title="Permanent link">&para;</a></h2>
<ul>
<li>一个能运作的 k8s 集群</li>
<li>相关容器镜像上传到镜像仓库</li>
<li>k8s 配置好私有镜像仓库凭证</li>
<li>k8s 上至少有一个 default storage class</li>
</ul>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-2-pvc">2. 创建 pvc 来提供持久化存储<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-2-pvc" title="Permanent link">&para;</a></h2>
<p>首先创建 pvc 来为思源笔记提供持久化存储：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-0-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nn">---</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">siyuan-pandoc-monitor</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">siyuan-pandoc</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">siyuan-pandoc-monitor</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteMany</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">    </span><span class="nt">requests</span><span class="p">:</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-3-deployment-pod">3. 创建 deployment 来部署 pod<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-3-deployment-pod" title="Permanent link">&para;</a></h2>
<p>然后使用此 yaml 部署 deployment：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-23">23</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-24">24</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-25">25</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-26">26</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-27">27</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-28">28</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-29">29</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-30">30</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-31">31</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-32">32</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-33">33</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-34">34</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-35">35</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-36">36</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-37">37</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-38">38</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-39">39</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-40">40</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-41">41</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-42">42</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-43">43</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-44">44</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-45">45</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-46">46</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-47">47</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-48">48</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-49">49</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-50">50</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-51">51</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-52">52</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-53">53</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-54">54</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-55">55</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-1-56">56</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nn">---</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">siyuan-pandoc-monitor</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">siyuan-pandoc-monitor</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">siyuan-pandoc</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">siyuan-pandoc-monitor</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Recreate</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">siyuan-pandoc-monitor</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">args</span><span class="p">:</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-c</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/opt/siyuan/kernel --workspace=/siyuan/workspace</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">          </span><span class="nt">command</span><span class="p">:</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/bin/sh</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">          </span><span class="nt">env</span><span class="p">:</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SIYUAN_ACCESS_AUTH_CODE_BYPASS</span>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.100.12:8082/siyuan-pandoc:v3.0.9</span>
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span>
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">siyuan-pandoc-monitor</span>
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="w">          </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-1-34"><a id="__codelineno-1-34" name="__codelineno-1-34"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">6806</span>
</span><span id="__span-1-35"><a id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
</span><span id="__span-1-36"><a id="__codelineno-1-36" name="__codelineno-1-36"></a><span class="w">              </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
</span><span id="__span-1-37"><a id="__codelineno-1-37" name="__codelineno-1-37"></a><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span>
</span><span id="__span-1-38"><a id="__codelineno-1-38" name="__codelineno-1-38"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/siyuan/workspace</span>
</span><span id="__span-1-39"><a id="__codelineno-1-39" name="__codelineno-1-39"></a><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">siyuan-pandoc-monitor</span>
</span><span id="__span-1-40"><a id="__codelineno-1-40" name="__codelineno-1-40"></a><span class="w">      </span><span class="nt">imagePullSecrets</span><span class="p">:</span>
</span><span id="__span-1-41"><a id="__codelineno-1-41" name="__codelineno-1-41"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nexus-regcred</span>
</span><span id="__span-1-42"><a id="__codelineno-1-42" name="__codelineno-1-42"></a><span class="w">      </span><span class="nt">securityContext</span><span class="p">:</span>
</span><span id="__span-1-43"><a id="__codelineno-1-43" name="__codelineno-1-43"></a><span class="w">        </span><span class="nt">fsGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
</span><span id="__span-1-44"><a id="__codelineno-1-44" name="__codelineno-1-44"></a><span class="w">      </span><span class="nt">tolerations</span><span class="p">:</span>
</span><span id="__span-1-45"><a id="__codelineno-1-45" name="__codelineno-1-45"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NoExecute</span>
</span><span id="__span-1-46"><a id="__codelineno-1-46" name="__codelineno-1-46"></a><span class="w">          </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node.kubernetes.io/not-ready</span>
</span><span id="__span-1-47"><a id="__codelineno-1-47" name="__codelineno-1-47"></a><span class="w">          </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exists</span>
</span><span id="__span-1-48"><a id="__codelineno-1-48" name="__codelineno-1-48"></a><span class="w">          </span><span class="nt">tolerationSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</span><span id="__span-1-49"><a id="__codelineno-1-49" name="__codelineno-1-49"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NoExecute</span>
</span><span id="__span-1-50"><a id="__codelineno-1-50" name="__codelineno-1-50"></a><span class="w">          </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node.kubernetes.io/unreachable</span>
</span><span id="__span-1-51"><a id="__codelineno-1-51" name="__codelineno-1-51"></a><span class="w">          </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exists</span>
</span><span id="__span-1-52"><a id="__codelineno-1-52" name="__codelineno-1-52"></a><span class="w">          </span><span class="nt">tolerationSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</span><span id="__span-1-53"><a id="__codelineno-1-53" name="__codelineno-1-53"></a><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-1-54"><a id="__codelineno-1-54" name="__codelineno-1-54"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">siyuan-pandoc-monitor</span>
</span><span id="__span-1-55"><a id="__codelineno-1-55" name="__codelineno-1-55"></a><span class="w">          </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span>
</span><span id="__span-1-56"><a id="__codelineno-1-56" name="__codelineno-1-56"></a><span class="w">            </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">siyuan-pandoc-monitor</span>
</span></code></pre></div></td></tr></table></div>
<p>特别需要注意，思源笔记只能单 pod 运行，第一个 pod 启动后，会给笔记的目录加锁，第二个 pod 启动的时候看到目录被加锁就会启动报错，因此只能部署 1 个 pod ，而且需要将 <code>strategy.type</code> 设置为 <code>Recreate</code> ，否则 rollout restart deployment 的时候，会先创建一个新的 pod ，新 pod 会永远 CrashLoopbackOff 。修改之后 rollout restart 时会先把 pod 杀掉然后启动新的 pod 。同时， k8s 默认设置下，如果节点宕机， pod 会忍耐节点 5 分钟才会迁移，这在单 pod 部署的情况下宕机会出现 5 分钟服务不可用，需要修改 tolerations 那里来将这个 5 分钟缩短为 10 秒。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-4-service">4. 创建 service 来暴露服务<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-4-service" title="Permanent link">&para;</a></h2>
<p>最后需要将思源笔记服务暴露，创建 service ：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2-__codelineno-2-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nn">---</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">siyuan-pandoc-monitor</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">siyuan-pandoc</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">siyuan-pandoc-monitor</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NodePort</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">6806</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">siyuan-pandoc-monitor</span>
</span></code></pre></div></td></tr></table></div>
<p>如果思源笔记在集群访问就可以，可以将 <code>spec.type</code> 修改为 <code>ClusterIP</code> 。</p></section><section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2" heading-number="5.3.2"><nav class='md-tags'><span class='md-tag'>mkdocs</span><span class='md-tag'>Keycloak</span><span class='md-tag'>Kubernetes</span></nav><h1 id="mkdocs-k8s">mkdocs 在 k8s 上的部署<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-mkdocs-k8s" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-1">1. 前置条件<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-1" title="Permanent link">&para;</a></h2>
<ul>
<li>一个能运作的 k8s 集群</li>
<li>相关容器镜像上传到镜像仓库</li>
<li>k8s 配置好私有镜像仓库凭证</li>
</ul>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-2-configmap">2. 创建 configmap<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-2-configmap" title="Permanent link">&para;</a></h2>
<p>使用 configmap 来存储本次部署需要的所有配置文件：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-19">19</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-20">20</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-21">21</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-22">22</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-23">23</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-24">24</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-25">25</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-26">26</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-27">27</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-28">28</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-29">29</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-30">30</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-31">31</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-32">32</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-33">33</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-34">34</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-35">35</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-36">36</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-37">37</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-38">38</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-39">39</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-40">40</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-41">41</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-42">42</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-0-43">43</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nn">---</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mkdocs</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mkdocs</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="nt">data</span><span class="p">:</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">  </span><span class="nt">build.sh</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="no">set -e</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="no">cd /</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="no">git config --global credential.helper store</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">    </span><span class="no">echo &#39;http://4895664:Pass1234%21@22.122.61.128&#39; &gt;&gt; ~/.git-credentials</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">    </span><span class="no">git clone http://22.122.61.128/mkdocs/system-ops.git</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">    </span><span class="no">cd /system-ops &amp;&amp; git checkout mkdocs-system-ops-hxp &amp;&amp; mkdocs build</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="no">cp -r /system-ops/site/* /mkdocs/</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">  </span><span class="nt">nginx.conf</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">    </span><span class="no">user nginx;</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">    </span><span class="no">worker_processes 1;</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">    </span><span class="no">error_log /var/log/nginx/error.log notice;</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">    </span><span class="no">pid /var/run/nginx.pid;</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21"></a>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">    </span><span class="no">events {</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">      </span><span class="no">worker_connections  1024;</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">    </span><span class="no">}</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25"></a>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">    </span><span class="no">http {</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">      </span><span class="no">include /etc/nginx/mime.types;</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="w">      </span><span class="no">default_type application/octet-stream;</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="w">      </span><span class="no">log_format main &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="w">                      </span><span class="no">&#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="w">                      </span><span class="no">&#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="w">      </span><span class="no">access_log /var/log/nginx/access.log  main;</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="w">      </span><span class="no">sendfile on;</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="w">      </span><span class="no">server {</span>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="w">        </span><span class="no">listen 80;</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="w">        </span><span class="no">server_name _;</span>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="w">        </span><span class="no">keepalive_timeout 70;</span>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="w">        </span><span class="no">location / {</span>
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="w">          </span><span class="no">root /mkdocs;</span>
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="w">          </span><span class="no">autoindex   on;</span>
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="w">        </span><span class="no">}</span>
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="w">      </span><span class="no">}</span>
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="w">    </span><span class="no">}</span>
</span></code></pre></div></td></tr></table></div>
<p>configmap 中包含 nginx 的配置和构建文档使用的 build.sh 脚本。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-3-deployment-pod">3. 使用 deployment 部署 pod<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-3-deployment-pod" title="Permanent link">&para;</a></h2>
<p>本次部署是部署一个 pod ，其在启动的时候运行 mkdocs 容器来从 GitLab 拉代码并编译，编译成功以后，运行 nginx 容器提供服务。如果编译失败，则 initContainer 不停重启。部署使用的 yaml 文件如下：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-23">23</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-24">24</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-25">25</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-26">26</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-27">27</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-28">28</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-29">29</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-30">30</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-31">31</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-32">32</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-33">33</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-34">34</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-35">35</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-36">36</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-37">37</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-38">38</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-39">39</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-40">40</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-41">41</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-42">42</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-43">43</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-44">44</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-45">45</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-46">46</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-47">47</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-48">48</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-49">49</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-50">50</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-51">51</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-52">52</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-53">53</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-54">54</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-55">55</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-56">56</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-57">57</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-58">58</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-59">59</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-60">60</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-61">61</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-62">62</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-63">63</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-1-64">64</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nn">---</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mkdocs</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mkdocs</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mkdocs</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mkdocs</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mkdocs</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">      </span><span class="nt">initContainers</span><span class="p">:</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.100.12:8082/mkdocs-git-revision:latest</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mkdocs</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build-script</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/build.sh</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">              </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build.sh</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mkdocs</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/mkdocs</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;/bin/sh&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;-c&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;/build.sh&quot;</span><span class="p p-Indicator">]</span>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.100.12:8082/nginx:1.20.0</span>
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="w">          </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
</span><span id="__span-1-34"><a id="__codelineno-1-34" name="__codelineno-1-34"></a><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
</span><span id="__span-1-35"><a id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span>
</span><span id="__span-1-36"><a id="__codelineno-1-36" name="__codelineno-1-36"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-conf</span>
</span><span id="__span-1-37"><a id="__codelineno-1-37" name="__codelineno-1-37"></a><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/nginx/nginx.conf</span>
</span><span id="__span-1-38"><a id="__codelineno-1-38" name="__codelineno-1-38"></a><span class="w">              </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx.conf</span>
</span><span id="__span-1-39"><a id="__codelineno-1-39" name="__codelineno-1-39"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mkdocs</span>
</span><span id="__span-1-40"><a id="__codelineno-1-40" name="__codelineno-1-40"></a><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/mkdocs</span>
</span><span id="__span-1-41"><a id="__codelineno-1-41" name="__codelineno-1-41"></a><span class="w">      </span><span class="nt">imagePullSecrets</span><span class="p">:</span>
</span><span id="__span-1-42"><a id="__codelineno-1-42" name="__codelineno-1-42"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nexus-regcred</span>
</span><span id="__span-1-43"><a id="__codelineno-1-43" name="__codelineno-1-43"></a><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-1-44"><a id="__codelineno-1-44" name="__codelineno-1-44"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-conf</span>
</span><span id="__span-1-45"><a id="__codelineno-1-45" name="__codelineno-1-45"></a><span class="w">          </span><span class="nt">configMap</span><span class="p">:</span>
</span><span id="__span-1-46"><a id="__codelineno-1-46" name="__codelineno-1-46"></a><span class="w">            </span><span class="nt">defaultMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0644</span>
</span><span id="__span-1-47"><a id="__codelineno-1-47" name="__codelineno-1-47"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mkdocs</span>
</span><span id="__span-1-48"><a id="__codelineno-1-48" name="__codelineno-1-48"></a><span class="w">            </span><span class="nt">items</span><span class="p">:</span>
</span><span id="__span-1-49"><a id="__codelineno-1-49" name="__codelineno-1-49"></a><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx.conf</span>
</span><span id="__span-1-50"><a id="__codelineno-1-50" name="__codelineno-1-50"></a><span class="w">                </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx.conf</span>
</span><span id="__span-1-51"><a id="__codelineno-1-51" name="__codelineno-1-51"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build-script</span>
</span><span id="__span-1-52"><a id="__codelineno-1-52" name="__codelineno-1-52"></a><span class="w">          </span><span class="nt">configMap</span><span class="p">:</span>
</span><span id="__span-1-53"><a id="__codelineno-1-53" name="__codelineno-1-53"></a><span class="w">            </span><span class="nt">defaultMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0755</span>
</span><span id="__span-1-54"><a id="__codelineno-1-54" name="__codelineno-1-54"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mkdocs</span>
</span><span id="__span-1-55"><a id="__codelineno-1-55" name="__codelineno-1-55"></a><span class="w">            </span><span class="nt">items</span><span class="p">:</span>
</span><span id="__span-1-56"><a id="__codelineno-1-56" name="__codelineno-1-56"></a><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build.sh</span>
</span><span id="__span-1-57"><a id="__codelineno-1-57" name="__codelineno-1-57"></a><span class="w">                </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build.sh</span>
</span><span id="__span-1-58"><a id="__codelineno-1-58" name="__codelineno-1-58"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mkdocs</span>
</span><span id="__span-1-59"><a id="__codelineno-1-59" name="__codelineno-1-59"></a><span class="w">          </span><span class="nt">emptyDir</span><span class="p">:</span>
</span><span id="__span-1-60"><a id="__codelineno-1-60" name="__codelineno-1-60"></a>
</span><span id="__span-1-61"><a id="__codelineno-1-61" name="__codelineno-1-61"></a>
</span><span id="__span-1-62"><a id="__codelineno-1-62" name="__codelineno-1-62"></a>
</span><span id="__span-1-63"><a id="__codelineno-1-63" name="__codelineno-1-63"></a>
</span><span id="__span-1-64"><a id="__codelineno-1-64" name="__codelineno-1-64"></a><span class="w">            </span><span class="nt">sizeLimit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">500Mi</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-4-service">4. 使用 service 暴露服务<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-4-service" title="Permanent link">&para;</a></h2>
<p>由于此环境 mkdocs 不需要对外暴露，使用了 ClusterIP 类型的 service ：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2-__codelineno-2-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nn">---</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mkdocs</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mkdocs</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mkdocs</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIP</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mkdocs</span>
</span></code></pre></div></td></tr></table></div></section><section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6" heading-number="5.3.3"><nav class='md-tags'><span class='md-tag'>OnlyOffice</span><span class='md-tag'>Docker</span></nav><h1 id="onlyoffice-20">编译 OnlyOffice 以解除 20 连接数限制<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-onlyoffice-20" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-1">1. 构建容器编译环境<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-1" title="Permanent link">&para;</a></h2>
<p>编译需要用到 Ubuntu 20.04 ，明智的做法是整一个 Ubuntu 20.04 的容器。在任意已经安装 docker 的机器上，新建目录 <code>onlyoffice</code> 作为本项目工作目录，创建 Dockerfile 如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-0-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>FROM ubuntu:20.04
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a>ENV TZ=Etc/UTC
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a>RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; echo $TZ &gt; /etc/timezone
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a>RUN apt-get -y update &amp;&amp; \
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a>    apt-get -y install python2 \
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a>                       python3 \
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a>                       sudo \
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a>                       git
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a>RUN ln -s /usr/bin/python2 /usr/bin/python
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a>WORKDIR /build
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a>CMD /bin/bash -c &#39;while true;do sleep 3600;done&#39;
</span></code></pre></div></td></tr></table></div>
<p>构建容器：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>docker build --tag onlyoffice-document-editors-builder .
</span></code></pre></div></td></tr></table></div>
<p>启动容器前需要禁用 IPv6 ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>sudo sysctl -w net.ipv6.conf.all.disable_ipv6=1
</span></code></pre></div></td></tr></table></div>
<p>启动容器（需要在新创建的 <code>onlyoffice</code> 目录运行）：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-3-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>docker rm onlyoffice_build
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>docker run -d --name onlyoffice_build -p 8701:80 -v $PWD:/build onlyoffice-document-editors-builder
</span></code></pre></div></td></tr></table></div>
<p>容器后台启动完成后，进入容器：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-4-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>docker exec -it onlyoffice_build /bin/bash
</span></code></pre></div></td></tr></table></div>
<p><strong>之后的操作均在容器内运行。</strong></p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-2-build_tools">2. 下载 build_tools 并开始编译<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-2-build_tools" title="Permanent link">&para;</a></h2>
<p>进入容器，下载<code>build_tools</code> 项目：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-5-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>cd /build
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a>git clone https://github.com/ONLYOFFICE/build_tools.git
</span></code></pre></div></td></tr></table></div>
<p>使用 <code>build_tools</code> 项目编译：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-6-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a>cd /build/build_tools/tools/linux &amp;&amp; ./automate.py server
</span></code></pre></div></td></tr></table></div>
<p>之后等待其编译完成，需要等待几个小时。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-3-onlyoffice">3. 修改 OnlyOffice 最大连接数<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-3-onlyoffice" title="Permanent link">&para;</a></h2>
<p>修改 <code>/build/server/Common/sources/constants.js</code> ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-7-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a>exports.LICENSE_CONNECTIONS = 99999;
</span></code></pre></div></td></tr></table></div>
<p>修改 <code>/build/build_tools/tools/linux/automate.py</code> 中此处 <code>--update</code> 为 <code>0</code> ，使得下次编译不再更新文件：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-8-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-8-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-8-3">3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-8-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a>build_tools_params = [&quot;--branch&quot;, branch,
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a>                      &quot;--module&quot;, modules,
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a>                      &quot;--update&quot;, &quot;0&quot;,
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a>                      &quot;--qt-dir&quot;, os.getcwd() + &quot;/qt_build/Qt-5.9.9&quot;] + params
</span></code></pre></div></td></tr></table></div>
<p>之后重新 编译源代码：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-9-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a>cd /build/build_tools/tools/linux &amp;&amp; ./automate.py server
</span></code></pre></div></td></tr></table></div>
<p>二次编译完成后，可以使用以下命令验证：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-10-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-10-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a>grep CONNECTIONS /build/build_tools/out/linux_64/onlyoffice/documentserver-snap/var
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a>/www/onlyoffice/documentserver/server/Common/sources/constants.js
</span></code></pre></div></td></tr></table></div>
<p>这里的 <code>exports.LICENSE_CONNECTIONS</code> 由 20 变为 99999 则为修改生效：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-11-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a>exports.LICENSE_CONNECTIONS = 99999;
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-4-documentserver">4. 试运行 documentserver<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-4-documentserver" title="Permanent link">&para;</a></h2>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-41-nginx">4.1 配置并启动 nginx<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-41-nginx" title="Permanent link">&para;</a></h3>
<p>安装并清除 nginx 默认配置：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-12-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-12-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a>sudo apt-get install nginx
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2"></a>sudo rm -f /etc/nginx/sites-enabled/default
</span></code></pre></div></td></tr></table></div>
<p>新建文件 <code>/etc/nginx/sites-available/onlyoffice-documentserver</code> 如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-16">16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-17">17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-18">18</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-19">19</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-20">20</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-21">21</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-22">22</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-23">23</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-24">24</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-25">25</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-26">26</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-27">27</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-28">28</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-29">29</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-30">30</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-13-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a>map $http_host $this_host {
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2"></a>  &quot;&quot; $host;
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3"></a>  default $http_host;
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4"></a>}
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5"></a>map $http_x_forwarded_proto $the_scheme {
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6"></a>  default $http_x_forwarded_proto;
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7"></a>  &quot;&quot; $scheme;
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8"></a>}
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9"></a>map $http_x_forwarded_host $the_host {
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10"></a>  default $http_x_forwarded_host;
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11"></a>  &quot;&quot; $this_host;
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12"></a>}
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13"></a>map $http_upgrade $proxy_connection {
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14"></a>  default upgrade;
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15"></a>  &quot;&quot; close;
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16"></a>}
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17"></a>proxy_set_header Host $http_host;
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18"></a>proxy_set_header Upgrade $http_upgrade;
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19"></a>proxy_set_header Connection $proxy_connection;
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20"></a>proxy_set_header X-Forwarded-Host $the_host;
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21"></a>proxy_set_header X-Forwarded-Proto $the_scheme;
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22"></a>server {
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23"></a>  listen 0.0.0.0:80;
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24"></a>  listen [::]:80 default_server;
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25"></a>  server_tokens off;
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26"></a>  rewrite ^\/OfficeWeb(\/apps\/.*)$ /web-apps$1 redirect;
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27"></a>  location / {
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28"></a>    proxy_pass http://localhost:8000;
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29"></a>    proxy_http_version 1.1;
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30"></a>  }
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31"></a>}
</span></code></pre></div></td></tr></table></div>
<p>使配置文件生效：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-14-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a>sudo ln -s /etc/nginx/sites-available/onlyoffice-documentserver /etc/nginx/sites-enabled/onlyoffice-documentserver
</span></code></pre></div></td></tr></table></div>
<p>重启 nginx：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-15-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1"></a>service nginx restart
</span></code></pre></div></td></tr></table></div>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-42-postgresql">4.2 配置并启动 postgresql<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-42-postgresql" title="Permanent link">&para;</a></h3>
<p>安装 postgresql 并启动：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-16-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-16-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1"></a>sudo apt-get install postgresql
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2"></a>service postgresql restart
</span></code></pre></div></td></tr></table></div>
<p>创建数据库和用户：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-17-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-17-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-17-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1"></a>sudo -i -u postgres psql -c &quot;CREATE DATABASE onlyoffice;&quot;
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2"></a>sudo -i -u postgres psql -c &quot;CREATE USER onlyoffice WITH password &#39;onlyoffice&#39;;&quot;
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3"></a>sudo -i -u postgres psql -c &quot;GRANT ALL privileges ON DATABASE onlyoffice TO onlyoffice;&quot;
</span></code></pre></div></td></tr></table></div>
<p>数据铺底：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-18-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1"></a>psql -hlocalhost -Uonlyoffice -d onlyoffice -f /build/build_tools/out/linux_64/onlyoffice/documentserver/server/schema/postgresql/createdb.sql # 密码为 onlyoffice
</span></code></pre></div></td></tr></table></div>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-43-rabbitmq">4.3 安装并启动 RabbitMQ<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-43-rabbitmq" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-19-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-19-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1"></a>sudo apt-get install rabbitmq-server
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2"></a>service rabbitmq-server restart
</span></code></pre></div></td></tr></table></div>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-44">4.4 生成字体和幻灯片主题<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-44" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-20-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-20-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-20-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-20-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-20-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-20-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-20-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-20-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-20-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-20-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-20-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-20-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-20-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-20-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1"></a>cd /build/build_tools/out/linux_64/onlyoffice/documentserver
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2"></a>mkdir fonts
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3"></a>LD_LIBRARY_PATH=${PWD}/server/FileConverter/bin server/tools/allfontsgen \
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4"></a>  --input=&quot;${PWD}/core-fonts&quot; \
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5"></a>  --allfonts-web=&quot;${PWD}/sdkjs/common/AllFonts.js&quot; \
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6"></a>  --allfonts=&quot;${PWD}/server/FileConverter/bin/AllFonts.js&quot; \
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7"></a>  --images=&quot;${PWD}/sdkjs/common/Images&quot; \
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8"></a>  --selection=&quot;${PWD}/server/FileConverter/bin/font_selection.bin&quot; \
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9"></a>  --output-web=&#39;fonts&#39; \
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10"></a>  --use-system=&quot;true&quot;
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11"></a>LD_LIBRARY_PATH=${PWD}/server/FileConverter/bin server/tools/allthemesgen \
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12"></a>  --converter-dir=&quot;${PWD}/server/FileConverter/bin&quot;\
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13"></a>  --src=&quot;${PWD}/sdkjs/slide/themes&quot;\
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14"></a>  --output=&quot;${PWD}/sdkjs/common/Images&quot;
</span></code></pre></div></td></tr></table></div>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-45-documentserver">4.5 运行 documentserver<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-45-documentserver" title="Permanent link">&para;</a></h3>
<p>启动 FileConverter ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-21-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-21-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1"></a>cd /build/build_tools/out/linux_64/onlyoffice/documentserver/server/FileConverter/
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2"></a>nohup bash -c &#39;LD_LIBRARY_PATH=$PWD/bin NODE_ENV=development-linux NODE_CONFIG_DIR=$PWD/../Common/config ./converter&#39; &amp;
</span></code></pre></div></td></tr></table></div>
<p>启动 DocService ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-22-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-22-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1"></a>cd /build/build_tools/out/linux_64/onlyoffice/documentserver/server/DocService
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2"></a>nohup bash -c &#39;NODE_ENV=development-linux NODE_CONFIG_DIR=$PWD/../Common/config ./docservice&#39; &amp;
</span></code></pre></div></td></tr></table></div>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-46">4.6 最终测试<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-46" title="Permanent link">&para;</a></h3>
<p>使用官方的 <a href="https://api.onlyoffice.com/zh/editors/example/javaspring">Java Spring Demo</a> 进行测试，该项目 GitHub 地址为：<a href="https://github.com/ONLYOFFICE/document-server-integration/tree/master/web/documentserver-example/java-spring">https://github.com/ONLYOFFICE/document-server-integration/tree/master/web/documentserver-example/java-spring</a> ，也可以在 <a href="https://api.onlyoffice.com/zh/editors/demopreview">https://api.onlyoffice.com/zh/editors/demopreview</a> 页面“选择编程语言并将在线编辑器集成示例的代码下载到您的网站”处下载。Spring 项目需要修改 <code>src/main/resources/application.properties</code> 的如下 2 行：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-23-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-23-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1"></a>server.port=4000
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2"></a>files.docservice.url.site=http://ubuntu.hxp.lan:8701/
</span></code></pre></div></td></tr></table></div>
<p>之后启动 Spring 后端，访问 <a href="http://nuc.hxp.lan:4000/">http://nuc.hxp.lan:4000/</a> 测试 Spring 后端是否能正常运作。（其中 ubuntu.hxp.lan 为 Document Server 的域名，而 nuc.hxp.lan 为后端 Spring 服务器域名，这两个域名可以使用 IP 地址代替）</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-5">5. 打包容器镜像<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-5" title="Permanent link">&para;</a></h2>
<p>将以上所有操作做成容器镜像，新建 Dockerfile ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-16">16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-17">17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-18">18</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-19">19</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-20">20</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-21">21</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-22">22</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-23">23</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-24">24</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-25">25</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-26">26</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-27">27</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-28">28</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-29">29</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-30">30</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-31">31</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-32">32</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-33">33</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-34">34</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-35">35</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-36">36</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-37">37</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-38">38</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-39">39</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-40">40</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-41">41</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-42">42</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-43">43</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-44">44</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-45">45</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-46">46</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-47">47</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-48">48</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-49">49</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-50">50</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-24-51">51</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1"></a>FROM ubuntu:20.04
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2"></a>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3"></a>ENV TZ=Etc/UTC
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4"></a>RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; echo $TZ &gt; /etc/timezone
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5"></a>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6"></a>RUN apt-get -y update &amp;&amp; \
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7"></a>    apt-get -y install python2 \
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8"></a>                       python3 \
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9"></a>                       sudo \
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10"></a>                       git \
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11"></a>                       postgresql \
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12"></a>                       rabbitmq-server \
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13"></a>                       nginx
</span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14"></a>RUN ln -s /usr/bin/python2 /usr/bin/python
</span><span id="__span-24-15"><a id="__codelineno-24-15" name="__codelineno-24-15"></a>WORKDIR /build
</span><span id="__span-24-16"><a id="__codelineno-24-16" name="__codelineno-24-16"></a>
</span><span id="__span-24-17"><a id="__codelineno-24-17" name="__codelineno-24-17"></a>RUN git clone https://github.com/ONLYOFFICE/build_tools.git
</span><span id="__span-24-18"><a id="__codelineno-24-18" name="__codelineno-24-18"></a>RUN cd /build/build_tools/tools/linux &amp;&amp; ./automate.py server
</span><span id="__span-24-19"><a id="__codelineno-24-19" name="__codelineno-24-19"></a>RUN sed -i &#39;s/exports.LICENSE_CONNECTIONS = 20;/exports.LICENSE_CONNECTIONS = 99999;/&#39; /build/server/Common/sources/constants.js
</span><span id="__span-24-20"><a id="__codelineno-24-20" name="__codelineno-24-20"></a>RUN sed -i &#39;s/&quot;--update&quot;, &quot;1&quot;/&quot;--update&quot;, &quot;0&quot;/&#39; /build/build_tools/tools/linux/automate.py
</span><span id="__span-24-21"><a id="__codelineno-24-21" name="__codelineno-24-21"></a>RUN cd /build/build_tools/tools/linux &amp;&amp; ./automate.py server
</span><span id="__span-24-22"><a id="__codelineno-24-22" name="__codelineno-24-22"></a>
</span><span id="__span-24-23"><a id="__codelineno-24-23" name="__codelineno-24-23"></a>FROM ubuntu:20.04
</span><span id="__span-24-24"><a id="__codelineno-24-24" name="__codelineno-24-24"></a>ENV TZ=Asia/Shanghai
</span><span id="__span-24-25"><a id="__codelineno-24-25" name="__codelineno-24-25"></a>RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; echo $TZ &gt; /etc/timezone
</span><span id="__span-24-26"><a id="__codelineno-24-26" name="__codelineno-24-26"></a>COPY --from=0 /build/build_tools/out/linux_64/onlyoffice/documentserver /var/www/html/documentserver
</span><span id="__span-24-27"><a id="__codelineno-24-27" name="__codelineno-24-27"></a>RUN apt-get -y update &amp;&amp; apt-get -y install nginx postgresql rabbitmq-server sudo ttf-wqy-zenhei fonts-wqy-microhei
</span><span id="__span-24-28"><a id="__codelineno-24-28" name="__codelineno-24-28"></a>COPY onlyoffice-documentserver /etc/nginx/sites-available/onlyoffice-documentserver
</span><span id="__span-24-29"><a id="__codelineno-24-29" name="__codelineno-24-29"></a>RUN sudo rm -f /etc/nginx/sites-enabled/default
</span><span id="__span-24-30"><a id="__codelineno-24-30" name="__codelineno-24-30"></a>RUN ln -s /etc/nginx/sites-available/onlyoffice-documentserver /etc/nginx/sites-enabled/onlyoffice-documentserver
</span><span id="__span-24-31"><a id="__codelineno-24-31" name="__codelineno-24-31"></a>RUN service postgresql restart &amp;&amp; \
</span><span id="__span-24-32"><a id="__codelineno-24-32" name="__codelineno-24-32"></a>    sudo -i -u postgres psql -c &quot;CREATE DATABASE onlyoffice;&quot; &amp;&amp; \
</span><span id="__span-24-33"><a id="__codelineno-24-33" name="__codelineno-24-33"></a>    sudo -i -u postgres psql -c &quot;CREATE USER onlyoffice WITH password &#39;onlyoffice&#39;;&quot; &amp;&amp; \
</span><span id="__span-24-34"><a id="__codelineno-24-34" name="__codelineno-24-34"></a>    sudo -i -u postgres psql -c &quot;GRANT ALL privileges ON DATABASE onlyoffice TO onlyoffice;&quot; &amp;&amp; \
</span><span id="__span-24-35"><a id="__codelineno-24-35" name="__codelineno-24-35"></a>    PGPASSWORD=onlyoffice psql -hlocalhost -Uonlyoffice -d onlyoffice -f /var/www/html/documentserver/server/schema/postgresql/createdb.sql
</span><span id="__span-24-36"><a id="__codelineno-24-36" name="__codelineno-24-36"></a>RUN cd /var/www/html/documentserver &amp;&amp; \
</span><span id="__span-24-37"><a id="__codelineno-24-37" name="__codelineno-24-37"></a>    mkdir fonts &amp;&amp; \
</span><span id="__span-24-38"><a id="__codelineno-24-38" name="__codelineno-24-38"></a>    LD_LIBRARY_PATH=${PWD}/server/FileConverter/bin server/tools/allfontsgen \
</span><span id="__span-24-39"><a id="__codelineno-24-39" name="__codelineno-24-39"></a>      --input=&quot;${PWD}/core-fonts&quot; \
</span><span id="__span-24-40"><a id="__codelineno-24-40" name="__codelineno-24-40"></a>      --allfonts-web=&quot;${PWD}/sdkjs/common/AllFonts.js&quot; \
</span><span id="__span-24-41"><a id="__codelineno-24-41" name="__codelineno-24-41"></a>      --allfonts=&quot;${PWD}/server/FileConverter/bin/AllFonts.js&quot; \
</span><span id="__span-24-42"><a id="__codelineno-24-42" name="__codelineno-24-42"></a>      --images=&quot;${PWD}/sdkjs/common/Images&quot; \
</span><span id="__span-24-43"><a id="__codelineno-24-43" name="__codelineno-24-43"></a>      --selection=&quot;${PWD}/server/FileConverter/bin/font_selection.bin&quot; \
</span><span id="__span-24-44"><a id="__codelineno-24-44" name="__codelineno-24-44"></a>      --output-web=&#39;fonts&#39; \
</span><span id="__span-24-45"><a id="__codelineno-24-45" name="__codelineno-24-45"></a>      --use-system=&quot;true&quot; &amp;&amp; \
</span><span id="__span-24-46"><a id="__codelineno-24-46" name="__codelineno-24-46"></a>    LD_LIBRARY_PATH=${PWD}/server/FileConverter/bin server/tools/allthemesgen \
</span><span id="__span-24-47"><a id="__codelineno-24-47" name="__codelineno-24-47"></a>      --converter-dir=&quot;${PWD}/server/FileConverter/bin&quot;\
</span><span id="__span-24-48"><a id="__codelineno-24-48" name="__codelineno-24-48"></a>      --src=&quot;${PWD}/sdkjs/slide/themes&quot;\
</span><span id="__span-24-49"><a id="__codelineno-24-49" name="__codelineno-24-49"></a>      --output=&quot;${PWD}/sdkjs/common/Images&quot;
</span><span id="__span-24-50"><a id="__codelineno-24-50" name="__codelineno-24-50"></a>COPY start.sh /start.sh
</span><span id="__span-24-51"><a id="__codelineno-24-51" name="__codelineno-24-51"></a>CMD /bin/bash /start.sh
</span></code></pre></div></td></tr></table></div>
<p>其中 <code>start.sh</code> 如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-25-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-25-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-25-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-25-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-25-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-25-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-25-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-25-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-25-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-25-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-25-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-25-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-25-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-25-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1"></a>#!/bin/bash
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2"></a>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3"></a>service nginx restart
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4"></a>service postgresql restart
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5"></a>service rabbitmq-server restart
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6"></a>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7"></a>touch /logs.txt
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8"></a>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9"></a>cd /var/www/html/documentserver/server/FileConverter/
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10"></a>nohup bash -c &#39;LD_LIBRARY_PATH=$PWD/bin NODE_ENV=development-linux NODE_CONFIG_DIR=$PWD/../Common/config ./converter&#39; 2&amp;&gt;1 &gt;&gt;/logs.txt &amp;
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11"></a>cd /var/www/html/documentserver/server/DocService/
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12"></a>nohup bash -c &#39;NODE_ENV=development-linux NODE_CONFIG_DIR=$PWD/../Common/config ./docservice&#39; 2&amp;&gt;1 &gt;&gt;/logs.txt &amp;
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13"></a>
</span><span id="__span-25-14"><a id="__codelineno-25-14" name="__codelineno-25-14"></a>tail -f /logs.txt
</span></code></pre></div></td></tr></table></div>
<p>nginx 配置 <code>onlyoffice-documentserver</code> 如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-16">16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-17">17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-18">18</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-19">19</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-20">20</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-21">21</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-22">22</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-23">23</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-24">24</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-25">25</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-26">26</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-27">27</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-28">28</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-29">29</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-30">30</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-26-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1"></a>map $http_host $this_host {
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2"></a>  &quot;&quot; $host;
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3"></a>  default $http_host;
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4"></a>}
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5"></a>map $http_x_forwarded_proto $the_scheme {
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6"></a>  default $http_x_forwarded_proto;
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7"></a>  &quot;&quot; $scheme;
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8"></a>}
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9"></a>map $http_x_forwarded_host $the_host {
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10"></a>  default $http_x_forwarded_host;
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11"></a>  &quot;&quot; $this_host;
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12"></a>}
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13"></a>map $http_upgrade $proxy_connection {
</span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14"></a>  default upgrade;
</span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15"></a>  &quot;&quot; close;
</span><span id="__span-26-16"><a id="__codelineno-26-16" name="__codelineno-26-16"></a>}
</span><span id="__span-26-17"><a id="__codelineno-26-17" name="__codelineno-26-17"></a>proxy_set_header Host $http_host;
</span><span id="__span-26-18"><a id="__codelineno-26-18" name="__codelineno-26-18"></a>proxy_set_header Upgrade $http_upgrade;
</span><span id="__span-26-19"><a id="__codelineno-26-19" name="__codelineno-26-19"></a>proxy_set_header Connection $proxy_connection;
</span><span id="__span-26-20"><a id="__codelineno-26-20" name="__codelineno-26-20"></a>proxy_set_header X-Forwarded-Host $the_host;
</span><span id="__span-26-21"><a id="__codelineno-26-21" name="__codelineno-26-21"></a>proxy_set_header X-Forwarded-Proto $the_scheme;
</span><span id="__span-26-22"><a id="__codelineno-26-22" name="__codelineno-26-22"></a>server {
</span><span id="__span-26-23"><a id="__codelineno-26-23" name="__codelineno-26-23"></a>  listen 0.0.0.0:80;
</span><span id="__span-26-24"><a id="__codelineno-26-24" name="__codelineno-26-24"></a>  listen [::]:80 default_server;
</span><span id="__span-26-25"><a id="__codelineno-26-25" name="__codelineno-26-25"></a>  server_tokens off;
</span><span id="__span-26-26"><a id="__codelineno-26-26" name="__codelineno-26-26"></a>  rewrite ^\/OfficeWeb(\/apps\/.*)$ /web-apps$1 redirect;
</span><span id="__span-26-27"><a id="__codelineno-26-27" name="__codelineno-26-27"></a>  location / {
</span><span id="__span-26-28"><a id="__codelineno-26-28" name="__codelineno-26-28"></a>    proxy_pass http://localhost:8000;
</span><span id="__span-26-29"><a id="__codelineno-26-29" name="__codelineno-26-29"></a>    proxy_http_version 1.1;
</span><span id="__span-26-30"><a id="__codelineno-26-30" name="__codelineno-26-30"></a>  }
</span><span id="__span-26-31"><a id="__codelineno-26-31" name="__codelineno-26-31"></a>}
</span></code></pre></div></td></tr></table></div>
<p>构建容器镜像：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-27-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1"></a>docker build --tag hxp.plus/onlyoffice/document-server:v20240526 .
</span></code></pre></div></td></tr></table></div>
<p>启动容器：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-__codelineno-28-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1"></a>docker run -p 8701:80 --rm -it --name document-server hxp.plus/onlyoffice/document-server:v20240526
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-6">6. 参考资料<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6-6" title="Permanent link">&para;</a></h2>
<p><a href="https://helpcenter.onlyoffice.com/installation/docs-community-compile.aspx">https://helpcenter.onlyoffice.com/installation/docs-community-compile.aspx</a></p>
<p><a href="https://blog.cyida.com/2022/2YTMY16.html">https://blog.cyida.com/2022/2YTMY16.html</a></p>
<p><a href="https://github.com/ONLYOFFICE/build_tools">https://github.com/ONLYOFFICE/build_tools</a></p>
<p><a href="https://www.btactic.com/build-onlyoffice-from-source-code-2023/?lang=en">https://www.btactic.com/build-onlyoffice-from-source-code-2023/?lang=en</a></p>
<p><a href="https://zsy314.wordpress.com/tag/linux/">https://zsy314.wordpress.com/tag/linux/</a></p></section></section>
                    <section class='print-page md-section' id='section-5-4' heading-number='5.4'>
                        <h1>Git使用<a class='headerlink' href='#section-5-4' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3" heading-number="5.4.1"><nav class='md-tags'><span class='md-tag'>Git</span></nav><h1 id="git">Git 中文乱码问题解决<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-git" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-1-git">1. Git 中文路径乱码问题<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-1-git" title="Permanent link">&para;</a></h2>
<p>默认配置下 Git 如果有中文文件会有乱码：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-0-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>$ git status
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>位于分支 master
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a>您的分支与上游分支 &#39;origin/master&#39; 一致。
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a>尚未暂存以备提交的变更：
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a>  （使用 &quot;git add &lt;文件&gt;...&quot; 更新要提交的内容）
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a>  （使用 &quot;git checkout -- &lt;文件&gt;...&quot; 丢弃工作区的改动）
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a>    修改：     .obsidian/workspace.json
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a>未跟踪的文件:
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a>  （使用 &quot;git add &lt;文件&gt;...&quot; 以包含要提交的内容）
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a>    &quot;Git\344\270\255\346\226\207\344\271\261\347\240\201\351\227\256\351\242\230\350\247\243\345\206\263.md&quot;
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15"></a>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16"></a>修改尚未加入提交（使用 &quot;git add&quot; 和/或 &quot;git commit -a&quot;）
</span></code></pre></div></td></tr></table></div>
<h%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-2">2. 解决方法<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-2" title="Permanent link">&para;</a></h2>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>git<span class="w"> </span>config<span class="w"> </span>--global<span class="w"> </span>core.quotepath<span class="w"> </span><span class="nb">false</span>
</span></code></pre></div></td></tr></table></div></section><section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e6%9c%80%e7%ae%80git%e6%9c%8d%e5%8a%a1%e5%99%a8%e6%90%ad%e5%bb%ba" heading-number="5.4.2"><nav class='md-tags'><span class='md-tag'>Git</span></nav><h1 id="git">最简 Git 服务器搭建<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e6%9c%80%e7%ae%80git%e6%9c%8d%e5%8a%a1%e5%99%a8%e6%90%ad%e5%bb%ba-git" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e6%9c%80%e7%ae%80git%e6%9c%8d%e5%8a%a1%e5%99%a8%e6%90%ad%e5%bb%ba-1-git">1. 最简 Git 服务器搭建方法<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e6%9c%80%e7%ae%80git%e6%9c%8d%e5%8a%a1%e5%99%a8%e6%90%ad%e5%bb%ba-1-git" title="Permanent link">&para;</a></h2>
<p>只要有服务器有 SSH，就可以搭建 Git 仓库。在仓库上，先创建用户 git，并使用用户 git 来创建仓库：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e6%9c%80%e7%ae%80git%e6%9c%8d%e5%8a%a1%e5%99%a8%e6%90%ad%e5%bb%ba-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e6%9c%80%e7%ae%80git%e6%9c%8d%e5%8a%a1%e5%99%a8%e6%90%ad%e5%bb%ba-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e6%9c%80%e7%ae%80git%e6%9c%8d%e5%8a%a1%e5%99%a8%e6%90%ad%e5%bb%ba-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e6%9c%80%e7%ae%80git%e6%9c%8d%e5%8a%a1%e5%99%a8%e6%90%ad%e5%bb%ba-__codelineno-0-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>cd /srv/git
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>mkdir project.git
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a>cd project.git
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a>git init --bare
</span></code></pre></div></td></tr></table></div>
<p>之后在客户端使用 Git：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e6%9c%80%e7%ae%80git%e6%9c%8d%e5%8a%a1%e5%99%a8%e6%90%ad%e5%bb%ba-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>git remote add origin git@gitserver:/srv/git/project.git
</span></code></pre></div></td></tr></table></div></section><section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-github%e9%bb%98%e8%ae%a4%e5%a4%b4%e5%83%8f%e8%8e%b7%e5%8f%96" heading-number="5.4.3"><nav class='md-tags'><span class='md-tag'>GitHub</span></nav><h1 id="github">GitHub 默认头像获取<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-github%e9%bb%98%e8%ae%a4%e5%a4%b4%e5%83%8f%e8%8e%b7%e5%8f%96-github" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-github%e9%bb%98%e8%ae%a4%e5%a4%b4%e5%83%8f%e8%8e%b7%e5%8f%96-1-github">1. 获取 GitHub 默认初始头像<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-github%e9%bb%98%e8%ae%a4%e5%a4%b4%e5%83%8f%e8%8e%b7%e5%8f%96-1-github" title="Permanent link">&para;</a></h2>
<p>获取 GitHub 默认初始头像，需要访问默认的头像地址：<a href="https://github.com/identicons/hxp-plus.png">https://github.com/identicons/hxp-plus.png</a> （将 hxp-plus 修改为 GitHub 用户名）</p>
<h%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-github%e9%bb%98%e8%ae%a4%e5%a4%b4%e5%83%8f%e8%8e%b7%e5%8f%96-2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-github%e9%bb%98%e8%ae%a4%e5%a4%b4%e5%83%8f%e8%8e%b7%e5%8f%96-2">2. 参考资料<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-github%e9%bb%98%e8%ae%a4%e5%a4%b4%e5%83%8f%e8%8e%b7%e5%8f%96-2" title="Permanent link">&para;</a></h2>
<p><a href="https://github.blog/2013-08-14-identicons/">https://github.blog/2013-08-14-identicons/</a></p></section><section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e9%85%8d%e7%bd%ae%e8%ae%b0%e4%bd%8f%e5%af%86%e7%a0%81" heading-number="5.4.4"><nav class='md-tags'><span class='md-tag'>Git</span></nav><h1 id="git">Git 配置记住密码<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e9%85%8d%e7%bd%ae%e8%ae%b0%e4%bd%8f%e5%af%86%e7%a0%81-git" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e9%85%8d%e7%bd%ae%e8%ae%b0%e4%bd%8f%e5%af%86%e7%a0%81-1-token">1. Token 的生成<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e9%85%8d%e7%bd%ae%e8%ae%b0%e4%bd%8f%e5%af%86%e7%a0%81-1-token" title="Permanent link">&para;</a></h2>
<p>由于 GitHub 等平台的限制，在 Git 客户端配置的密码需要是 Personal Access Token，可在个人设置的“Developer Settings”设置。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e9%85%8d%e7%bd%ae%e8%ae%b0%e4%bd%8f%e5%af%86%e7%a0%81-2-git">2. 配置 Git 记住密码<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e9%85%8d%e7%bd%ae%e8%ae%b0%e4%bd%8f%e5%af%86%e7%a0%81-2-git" title="Permanent link">&para;</a></h2>
<p>使用以下命令配置（全局生效，如果想仅对仓库生效，去掉 <code>--global</code> ）：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e9%85%8d%e7%bd%ae%e8%ae%b0%e4%bd%8f%e5%af%86%e7%a0%81-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>git config --global credential.helper store
</span></code></pre></div></td></tr></table></div></section><section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93" heading-number="5.4.5"><nav class='md-tags'><span class='md-tag'>Git</span><span class='md-tag'>Nginx</span></nav><h1 id="nginx-git">使用 nginx 快速搭建只读 Git 仓库<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-nginx-git" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-1">1. 项目背景<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-1" title="Permanent link">&para;</a></h2>
<p>对于有多地多个网络区域的大型公司，网络区域之间网络不通，同时每个网络区域都有一个 nginx 作为介质库，各个网络区域内所有主机可以访问本网络区域之间的介质库，介质库之间同步。同时需要使用 Git 来进行代码的管理，要求各个网络区域的主机都以只读的方式能访问到 Git 仓库来拉取代码。因此需要建立基于 HTTP 的 Git 仓库，同时尽量少地更改各地介质库的配置。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-2-git">2. 几种建立 Git 仓库的选择<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-2-git" title="Permanent link">&para;</a></h2>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-21-smart-http">2.1 Smart HTTP 仓库<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-21-smart-http" title="Permanent link">&para;</a></h3>
<p>这个是 Git 官方推荐的使用 HTTP 建立 Git 仓库的方式，好处为建立好的 Git 仓库可读可写，但是官方只给了 Apache 的示例，如果使用 nginx，需要使用到第三方模块 fcgiwrap ，这就需要修改已有的 nginx ，同时，这个模块不是 RHEL 官方附带的，是否要安装到生产环境有待商榷。</p>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-22-ssh">2.2 SSH 仓库<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-22-ssh" title="Permanent link">&para;</a></h3>
<p>这个是最简单的建立 Git 仓库的方式，即只要有一个 SSH 服务器即可。缺点是 SSH 登录按照企业的规定，禁止空密码，这就必须每次拉代码的时候使用密码，或者建立 SSH 互信。且这种方式走的是 SSH 端口，对于这个需求而言不能满足。</p>
<h3 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-23-dumb-http">2.3 Dumb HTTP 仓库<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-23-dumb-http" title="Permanent link">&para;</a></h3>
<p>当 Git 拉取 HTTP 仓库时，它会首先认为仓库是 Smart HTTP 仓库，服务器没有相应而失败后，主动回落到 Dumb HTTP 模式。这个模式完美符合此项目的要求，因为 Dumb HTTP 仓库只需要一个能正常工作的 HTTP 服务器，这意味着不需要修改 nginx 配置或者加入第三方模块。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-3-dumb-http">3. 建立 Dumb HTTP 仓库<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-3-dumb-http" title="Permanent link">&para;</a></h2>
<p>以下 Dockerfile 是一个 Dumb HTTP 仓库的示例：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-19">19</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-20">20</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-21">21</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-22">22</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-23">23</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-24">24</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-25">25</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-26">26</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-27">27</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-28">28</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-29">29</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-30">30</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-31">31</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-32">32</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-33">33</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-34">34</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-35">35</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-36">36</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-37">37</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-38">38</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-39">39</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-40">40</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-41">41</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-0-42">42</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>FROM redhat/ubi8:8.10
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>RUN yum install -y nginx git
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a>WORKDIR /usr/share/nginx/html
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a>RUN git clone --mirror https://github.com/hxp-plus/docs.hxp.plus.git docs.hxp.plus.git
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a>RUN cd docs.hxp.plus.git &amp;&amp; mv hooks/post-update.sample hooks/post-update &amp;&amp; chmod a+x hooks/post-update &amp;&amp; git update-server-info
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a>COPY &lt;&lt;-&#39;EOF&#39; /etc/nginx/nginx.conf
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a>daemon off;
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a>user nginx;
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a>worker_processes 1;
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a>error_log /dev/stdout info;
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a>pid /run/nginx.pid;
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a>include /usr/share/nginx/modules/*.conf;
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a>events {
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a>    worker_connections 1024;
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15"></a>}
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16"></a>http {
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17"></a>    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18"></a>                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19"></a>                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20"></a>    access_log  /dev/stdout  main;
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21"></a>    sendfile            on;
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22"></a>    tcp_nopush          on;
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23"></a>    tcp_nodelay         on;
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24"></a>    keepalive_timeout   65;
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25"></a>    types_hash_max_size 2048;
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26"></a>    include             /etc/nginx/mime.types;
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27"></a>    default_type        application/octet-stream;
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28"></a>    server {
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29"></a>        listen                80 default_server;
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30"></a>        listen                [::]:80 default_server;
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31"></a>        server_name           _;
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32"></a>        root                  /usr/share/nginx/html;
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33"></a>        charset               utf-8;
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34"></a>        client_max_body_size  0;
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35"></a>        location / {
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36"></a>            autoindex on;
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37"></a>        }
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38"></a>    }
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39"></a>}
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40"></a>EOF
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41"></a>EXPOSE 80
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42"></a>CMD [&quot;/sbin/nginx&quot;]
</span></code></pre></div></td></tr></table></div>
<p>可以看出，建立过程为大致以下几步：</p>
<ol>
<li>安装 git 和 nginx 。</li>
<li>在 nginx 的根目录，克隆 git 仓库。</li>
<li>修改克隆下的仓库的 post-update hook ，并运行一次 post-update hook 里的命令。</li>
<li>配置 nginx ，使其能向外界提供 http 资源。</li>
</ol>
<p>如果需要更新 nginx 上的 git 仓库，使用如下命令：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-__codelineno-1-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>cd /usr/share/nginx/html/docs.hxp.plus.git
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>git fetch --all
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-4">4. 参考资料<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93-4" title="Permanent link">&para;</a></h2>
<p><a href="https://wiki.archlinux.org/title/Git_server">https://wiki.archlinux.org/title/Git_server</a></p>
<p><a href="https://git-scm.com/book/en/v2/Git-on-the-Server-Smart-HTTP">https://git-scm.com/book/en/v2/Git-on-the-Server-Smart-HTTP</a></p>
<p><a href="https://git-scm.com/book/en/v2/Git-on-the-Server-The-Protocols">https://git-scm.com/book/en/v2/Git-on-the-Server-The-Protocols</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1921219">https://cloud.tencent.com/developer/article/1921219</a></p></section><section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-gitlab%e7%ac%ac%e4%ba%8c%e9%82%ae%e7%ae%b1%e4%bf%ae%e6%94%b9%e4%b8%ba%e5%b7%b2%e8%ae%a4%e8%af%81" heading-number="5.4.6"><nav class='md-tags'><span class='md-tag'>GitLab</span></nav><h1 id="gitlab">GitLab 第二邮箱修改为已认证<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-gitlab%e7%ac%ac%e4%ba%8c%e9%82%ae%e7%ae%b1%e4%bf%ae%e6%94%b9%e4%b8%ba%e5%b7%b2%e8%ae%a4%e8%af%81-gitlab" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-gitlab%e7%ac%ac%e4%ba%8c%e9%82%ae%e7%ae%b1%e4%bf%ae%e6%94%b9%e4%b8%ba%e5%b7%b2%e8%ae%a4%e8%af%81-1">1. 问题背景<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-gitlab%e7%ac%ac%e4%ba%8c%e9%82%ae%e7%ae%b1%e4%bf%ae%e6%94%b9%e4%b8%ba%e5%b7%b2%e8%ae%a4%e8%af%81-1" title="Permanent link">&para;</a></h2>
<p>在内网环境中使用 GitLab ，如果需要添加第二个电子邮件，电子邮件需要被验证，但是验证的邮件发不出去，就无法验证并完成添加。此时需要一种方法手动修改邮箱为已认证。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-gitlab%e7%ac%ac%e4%ba%8c%e9%82%ae%e7%ae%b1%e4%bf%ae%e6%94%b9%e4%b8%ba%e5%b7%b2%e8%ae%a4%e8%af%81-2-rails">2. 登录 Rails 控制台手动修改第二邮箱为已认证<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-gitlab%e7%ac%ac%e4%ba%8c%e9%82%ae%e7%ae%b1%e4%bf%ae%e6%94%b9%e4%b8%ba%e5%b7%b2%e8%ae%a4%e8%af%81-2-rails" title="Permanent link">&para;</a></h2>
<p>登录到 GitLab 服务器上，进入 Rails 控制台修改邮箱为已认证：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-gitlab%e7%ac%ac%e4%ba%8c%e9%82%ae%e7%ae%b1%e4%bf%ae%e6%94%b9%e4%b8%ba%e5%b7%b2%e8%ae%a4%e8%af%81-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-gitlab%e7%ac%ac%e4%ba%8c%e9%82%ae%e7%ae%b1%e4%bf%ae%e6%94%b9%e4%b8%ba%e5%b7%b2%e8%ae%a4%e8%af%81-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-gitlab%e7%ac%ac%e4%ba%8c%e9%82%ae%e7%ae%b1%e4%bf%ae%e6%94%b9%e4%b8%ba%e5%b7%b2%e8%ae%a4%e8%af%81-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-gitlab%e7%ac%ac%e4%ba%8c%e9%82%ae%e7%ae%b1%e4%bf%ae%e6%94%b9%e4%b8%ba%e5%b7%b2%e8%ae%a4%e8%af%81-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-gitlab%e7%ac%ac%e4%ba%8c%e9%82%ae%e7%ae%b1%e4%bf%ae%e6%94%b9%e4%b8%ba%e5%b7%b2%e8%ae%a4%e8%af%81-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-gitlab%e7%ac%ac%e4%ba%8c%e9%82%ae%e7%ae%b1%e4%bf%ae%e6%94%b9%e4%b8%ba%e5%b7%b2%e8%ae%a4%e8%af%81-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-gitlab%e7%ac%ac%e4%ba%8c%e9%82%ae%e7%ae%b1%e4%bf%ae%e6%94%b9%e4%b8%ba%e5%b7%b2%e8%ae%a4%e8%af%81-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-gitlab%e7%ac%ac%e4%ba%8c%e9%82%ae%e7%ae%b1%e4%bf%ae%e6%94%b9%e4%b8%ba%e5%b7%b2%e8%ae%a4%e8%af%81-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-gitlab%e7%ac%ac%e4%ba%8c%e9%82%ae%e7%ae%b1%e4%bf%ae%e6%94%b9%e4%b8%ba%e5%b7%b2%e8%ae%a4%e8%af%81-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-gitlab%e7%ac%ac%e4%ba%8c%e9%82%ae%e7%ae%b1%e4%bf%ae%e6%94%b9%e4%b8%ba%e5%b7%b2%e8%ae%a4%e8%af%81-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-gitlab%e7%ac%ac%e4%ba%8c%e9%82%ae%e7%ae%b1%e4%bf%ae%e6%94%b9%e4%b8%ba%e5%b7%b2%e8%ae%a4%e8%af%81-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-gitlab%e7%ac%ac%e4%ba%8c%e9%82%ae%e7%ae%b1%e4%bf%ae%e6%94%b9%e4%b8%ba%e5%b7%b2%e8%ae%a4%e8%af%81-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-gitlab%e7%ac%ac%e4%ba%8c%e9%82%ae%e7%ae%b1%e4%bf%ae%e6%94%b9%e4%b8%ba%e5%b7%b2%e8%ae%a4%e8%af%81-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-gitlab%e7%ac%ac%e4%ba%8c%e9%82%ae%e7%ae%b1%e4%bf%ae%e6%94%b9%e4%b8%ba%e5%b7%b2%e8%ae%a4%e8%af%81-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-gitlab%e7%ac%ac%e4%ba%8c%e9%82%ae%e7%ae%b1%e4%bf%ae%e6%94%b9%e4%b8%ba%e5%b7%b2%e8%ae%a4%e8%af%81-__codelineno-0-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>[root@gitlab gitlab]# gitlab-rails console production
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>-------------------------------------------------------------------------------------
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a> GitLab:       11.5.1 (c90ae59)
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a> GitLab Shell: 8.4.1
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a> postgresql:   9.6.8
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a>-------------------------------------------------------------------------------------
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a>Both Deployment and its :status machine have defined a different default for &quot;status&quot;. Use only one or the other for defining defaults to avoid unexpected behaviors.
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a>Loading production environment (Rails 4.2.10)
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a>irb(main):003:0&gt; email = Email.find_by(email: &quot;hxp@hxp.plus&quot;)
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a>=&gt; #&lt;Email id: 2, user_id: 51, email: &quot;hxp@hxp.plus&quot;, created_at: &quot;2024-06-05 03:59:21&quot;, updated_at: &quot;2024-06-05 03:59:21&quot;&gt;
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a>irb(main):004:0&gt; email.confirmed_at = Time.zone.now
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a>=&gt; Wed, 05 Jun 2024 04:37:42 UTC +00:00
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a>irb(main):005:0&gt; email.save!
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a>=&gt; true
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15"></a>irb(main):006:0&gt; exit
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-gitlab%e7%ac%ac%e4%ba%8c%e9%82%ae%e7%ae%b1%e4%bf%ae%e6%94%b9%e4%b8%ba%e5%b7%b2%e8%ae%a4%e8%af%81-3">3. 参考资料<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-gitlab%e7%ac%ac%e4%ba%8c%e9%82%ae%e7%ae%b1%e4%bf%ae%e6%94%b9%e4%b8%ba%e5%b7%b2%e8%ae%a4%e8%af%81-3" title="Permanent link">&para;</a></h2>
<p><a href="https://gist.github.com/macdja38/3d62d4f251bd7c46f0128bb6a9d35544">https://gist.github.com/macdja38/3d62d4f251bd7c46f0128bb6a9d35544</a></p></section></section>
                    <section class='print-page md-section' id='section-5-5' heading-number='5.5'>
                        <h1>Python<a class='headerlink' href='#section-5-5' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3" heading-number="5.5.1"><nav class='md-tags'><span class='md-tag'>Python</span></nav><h1 id="python3">构建解压即用的 Python3<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-python3" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-1">1. 背景<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-1" title="Permanent link">&para;</a></h2>
<p>在复杂的运维场景下，不同的 Linux 操作系统的 Python 版本不一，有的操作系统是 Python2，有的是 Python3 ，且即使都 Python3，各个操作系统的 Python3 的版本也不一样。如果我们要发布一个程序，譬如说监控程序，需要让不同的操作系统都能运行，则需要把所有操作系统都适配一遍，且每次更新都需要适配。不如直接单独带一个 Python 到所有的操作系统中。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-2-python3-opt">2. 编译一份 Python3 并将其安装到 /opt 目录<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-2-python3-opt" title="Permanent link">&para;</a></h2>
<p>由于不同版本的 Linux 的 glibc 版本不同，且高版本的 glibc 兼容低版本，反之不兼容，因此需要在你需要适配的最低版本 Linux 上编译，我这里选用的 CentOS 6 ，同时，编译不需要真的安装 CentOS 6 ，可以使用 docker 容器并在容器里编译。我的 Dockerfile 如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-__codelineno-0-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>FROM centos:6.10
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>COPY &lt;&lt;-&#39;EOF&#39; /etc/yum.repos.d/CentOS-Base.repo
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a>[base]
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a>name=CentOS-$releasever - Base
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a>baseurl=https://vault.centos.org/6.10/os/$basearch/
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a>gpgcheck=0
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a>EOF
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a>RUN yum install -y make gcc zlib-devel
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a>RUN mkdir -p /build
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a>WORKDIR /build
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a>RUN curl https://www.python.org/ftp/python/3.7.17/Python-3.7.17.tgz -o Python-3.7.17.tgz
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a>RUN tar -zxf Python-3.7.17.tgz -C /build
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a>WORKDIR /build/Python-3.7.17
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a>RUN ./configure --prefix=/opt/Python-3.7.17
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15"></a>RUN make install
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16"></a>WORKDIR /opt
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17"></a>VOLUME /opt
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18"></a>CMD [&quot;/bin/bash&quot;]
</span></code></pre></div></td></tr></table></div>
<p>使用 docker 构建一个容器并在容器里编译出 Python3，安装到容器的 /opt 目录：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>docker build -t centos6-python3.7 .
</span></code></pre></div></td></tr></table></div>
<p>之后将容器内编译好的 Python3 复制出来：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-__codelineno-2-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>mkdir -p dist
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>docker run --rm -v ./dist:/mnt centos6-python3.7 /bin/bash -c &#39;cd /opt &amp;&amp; /bin/tar zcpf /mnt/Python-3.7.17.tgz Python-3.7.17&#39;
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-3-python3">3. 使用 Python3<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-3-python3" title="Permanent link">&para;</a></h2>
<p>将整个 Python-3.7.17 目录复制到别的机器上，运行前设置环境变量：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3-__codelineno-3-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>export PATH=$PWD/Python-3.7.17/bin:$PATH
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>export LD_LIBRATY_PATH=$PWD/Python-3.7.17/lib:$LD_LIBRATY_PATH
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a>echo &quot;Current Python version is: $(python3 --version)&quot;
</span></code></pre></div></td></tr></table></div>
<p>之后使用 python3 命令执行。</p></section><section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91" heading-number="5.5.2"><nav class='md-tags'><span class='md-tag'>Python</span></nav><h1 id="python">基于 Python 的模块化监控工具的开发<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-python" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-1">1. 项目背景<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-1" title="Permanent link">&para;</a></h2>
<p>大型公司有非常多的定制化监控需求， Zabbix 、 Prometheus 等监控工具不能满足，必须运维人员开发定制的脚本实现监控。但是在开发的过程中，遇到了以下几点困难：</p>
<ol>
<li>随着需求的增加，每增加一个监控项，就增加一个脚本。脚本使用 crontab 进行运行， crontab 越加越多，且项目的文件越来越多， crontab 也越来越多。随着项目的发展，越来越不好维护。</li>
<li>代码可重复利用率低，很多的脚本都需要实现一个共同或相似的功能，事实上项目里是相同的代码不停在不同脚本中复制粘贴，且一旦共性的代码被修改，所有脚本都需要修改。</li>
<li>代码 BUG 无法避免，由于脚本使用 Shell 进行开发， Shell 语法中并没有变量类型的概念，经常是脚本执行了一个命令，命令没有按照期望返回，但是 Shell 继续执行，并没有像其它语言在类型转换时抛出异常。同时， Shell 中比较大小经常由于小数和整数比较大小的问题，或者将小数转化为整数的问题，导致脚本得到的数据和阈值数据比较结果不正确。</li>
</ol>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-2-python">2. Python 项目的打包方式比较<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-2-python" title="Permanent link">&para;</a></h2>
<p>对于这个项目，显然需要将 Python 项目进行打包，否则还是会有随着项目的推进、往服务器上部署的脚本文件越来越多的问题。目前 Python 项目的打包大致有使用 PyInstaller 和 zipapp 两种方式。不推荐使用 PyInstaller 的原因为：PyInstaller 虽然不需要目标主机安装 Python，但是它在运行的时候会在 /tmp 下创建临时目录存放 Python 代码，如果遇到了问题中途崩溃，则临时目录不会被清空。这会导致如果程序代码有问题，随着 crontab 不断调用代码会导致 /tmp 目录下子目录越来越多。</p>
<p>如果使用 zipapp 方式，则需要给所有的机器通过解压的方式安装一个 Python3 供项目运行使用。本次示例将 Python-3.7.17 解压和项目放到了 <code>/opt/Python-3.7.17</code> 目录下。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-3">3. 项目结构<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-3" title="Permanent link">&para;</a></h2>
<p>项目的结构如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-0-6">6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-0-7">7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-0-8">8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-0-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>.
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>├── build.sh
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a>├── dist
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a>│   └── monitor.pyz
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a>├── run.sh
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a>└── src
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a>    ├── monitor.py
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a>    └── utils
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a>        └── command.py
</span></code></pre></div></td></tr></table></div>
<p>其中 dist 目录为存放打包好 Python 项目的目录。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-4-python">4. 项目核心 Python 代码架构<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-4-python" title="Permanent link">&para;</a></h2>
<p>目录 <code>src</code> 下为监控工具代码，其中 <code>monitor.py</code> 为程序的入口：</p>
<div class="language-Python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-1-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">utils.command</span><span class="w"> </span><span class="kn">import</span> <span class="n">run</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a>    <span class="n">ls_result</span><span class="o">=</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;ls&#39;</span><span class="p">,</span> <span class="s1">&#39;-lh&#39;</span><span class="p">])</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">ls_result</span><span class="p">)</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a>    <span class="n">cat_result</span><span class="o">=</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="s1">&#39;/proc/meminfo&#39;</span><span class="p">])</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">cat_result</span><span class="p">)</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a>    <span class="n">cat_result</span><span class="o">=</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="s1">&#39;/tmp/100MB.bin&#39;</span><span class="p">])</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">cat_result</span><span class="p">)</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a>    <span class="n">main</span><span class="p">()</span>
</span></code></pre></div></td></tr></table></div>
<p>所有的功能以模块的形式放在 <code>utils</code> 下，其中 <code>utils/command.py</code> 为 Shell 命令相关的模块，模块里有个函数 <code>run</code> 是用来运行命令并返回命令运行结果的：</p>
<div class="language-Python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-2-3">3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-2-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a>    <span class="k">return</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>如果日后有新增模块的需求，譬如说增加 HBA 卡状态监控，则新建 Python 文件 <code>utils/hba.py</code> ，并在里面写相应的函数来实现监控，最后在 <code>monitor.py</code> 里调用。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-5">5. 项目的构建与运行<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-5" title="Permanent link">&para;</a></h2>
<p><code>run.sh</code> 为运行项目的脚本，如下：</p>
<div class="language-Shell highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-3-3">3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-3-4">4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-3-5">5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-3-6">6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-3-7">7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-3-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="nb">ulimit</span><span class="w"> </span>-v<span class="w"> </span><span class="m">128000</span><span class="w"> </span><span class="c1"># Limit memory usage to 128MiB</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="nv">PYTHON_INSTALL_DIR</span><span class="o">=</span>/opt/Python-3.7.17/
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="nv">LOG_FILE</span><span class="o">=</span>/tmp/systemmon.out
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PYTHON_INSTALL_DIR</span>/bin:<span class="nv">$PATH</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="nb">export</span><span class="w"> </span><span class="nv">LD_LIBRATY_PATH</span><span class="o">=</span><span class="nv">$PYTHON_INSTALL_DIR</span>/lib:<span class="nv">$LD_LIBRATY_PATH</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Current Python version is: </span><span class="k">$(</span>python3<span class="w"> </span>--version<span class="k">)</span><span class="s2">&quot;</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a>python3<span class="w"> </span>dist/monitor.pyz<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="nv">$LOG_FILE</span>
</span></code></pre></div></td></tr></table></div>
<p>在这个脚本里使用 ulimit 限制了 Python 程序在执行时，最高消耗 128MB 内存，如果超过限制，Python 会报错 <code>MemoryError</code> 并被杀死。可将此脚本加到 crontab 里定时执行来实现监控，同时脚本所有的输出，用 <code>tee -a</code> 的方式重定向到了变量 <code>LOG_FILE</code> 定义的日志文件。</p>
<p><code>build.sh</code> 为打包 Python 的脚本：</p>
<div class="language-Shell highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-4-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-4-3">3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-4-4">4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-4-5">5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-4-6">6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-4-7">7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91-__codelineno-4-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="nv">PYTHON_INSTALL_DIR</span><span class="o">=</span>/opt/Python-3.7.17/
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="nv">APP_NAME</span><span class="o">=</span>monitor
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PYTHON_INSTALL_DIR</span>/bin:<span class="nv">$PATH</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="nb">export</span><span class="w"> </span><span class="nv">LD_LIBRATY_PATH</span><span class="o">=</span><span class="nv">$PYTHON_INSTALL_DIR</span>/lib:<span class="nv">$LD_LIBRATY_PATH</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Current Python version is: </span><span class="k">$(</span>python3<span class="w"> </span>--version<span class="k">)</span><span class="s2">&quot;</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>dist
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a>python3<span class="w"> </span>-m<span class="w"> </span>zipapp<span class="w"> </span>src<span class="w"> </span>-o<span class="w"> </span>dist/<span class="nv">$APP_NAME</span>.pyz<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;monitor:main&quot;</span>
</span></code></pre></div></td></tr></table></div>
<p>这个脚本负责将 <code>src</code> 目录下的所有代码打包成为 pyz 格式的 Python 包，并将其放在 <code>dist</code> 目录下。</p></section><section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96" heading-number="5.5.3"><nav class='md-tags'><span class='md-tag'>Python</span></nav><h1 id="python">Python 升级所有依赖<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96-python" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96-1-pip">1. 使用 pip 列出所有不是最新的依赖<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96-1-pip" title="Permanent link">&para;</a></h2>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>pip list --outdated
</span></code></pre></div></td></tr></table></div>
<p>输出示例如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96-__codelineno-1-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>Package                                   Version   Latest    Type
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>----------------------------------------- --------- --------- -----
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a>Babel                                     2.14.0    2.15.0    wheel
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a>certifi                                   2024.2.2  2024.6.2  wheel
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a>Jinja2                                    3.1.3     3.1.4     wheel
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a>mkdocs-git-revision-date-localized-plugin 1.2.4     1.2.6     wheel
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a>mkdocs-print-site-plugin                  2.4.1     2.5.0     wheel
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a>packaging                                 24.0      24.1      wheel
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a>platformdirs                              4.2.1     4.2.2     wheel
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a>Pygments                                  2.17.2    2.18.0    wheel
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a>pymdown-extensions                        10.8      10.8.1    wheel
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a>regex                                     2024.4.16 2024.5.15 wheel
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a>requests                                  2.31.0    2.32.3    wheel
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14"></a>watchdog                                  4.0.0     4.0.1     wheel
</span></code></pre></div></td></tr></table></div>
<h%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96-2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96-2">2. 升级所有依赖<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96-2" title="Permanent link">&para;</a></h2>
<p>确认无误后，一键升级：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>pip install -U `pip list --outdated | awk &#39;NR&gt;2 {print $1}&#39;`
</span></code></pre></div></td></tr></table></div>
<p>之后验证通过后，更新 <code>requirements.txt</code> ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>pip freeze &gt; requirements.txt
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96-3">3. 参考资料<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96-3" title="Permanent link">&para;</a></h2>
<p><a href="https://stackoverflow.com/questions/2720014/how-to-upgrade-all-python-packages-with-pip">https://stackoverflow.com/questions/2720014/how-to-upgrade-all-python-packages-with-pip</a></p></section><section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8" heading-number="5.5.4"><nav class='md-tags'><span class='md-tag'>Python</span></nav><h1 id="python-cpu">Python 限制内存和 CPU 使用<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-python-cpu" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-1">1. 项目需求<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-1" title="Permanent link">&para;</a></h2>
<p>在使用 Python 进行监控或者自动化操作时，需要特别留意的一点就是 Python 本身的内存使用，譬如说你写了个 Python 程序，查看日志并在日志里提取关键字进行分析，然后在测试环境程序运行没有问题，但是在生产环境，大多数机器上运行的也没有问题，突然有那么一个机器，日志有几个 G，Python 写的时候没有考虑到这种情况，把几个 G 的日志都载入内存，导致服务器 OOM 故障。</p>
<p>因此需要有一种方式，让 Python 程序在内存使用达到一个数值后，申请内存失败而自我熔断。对于 CPU 资源同理需要限制。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-2-linux">2. Linux 内存的管理机制<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-2-linux" title="Permanent link">&para;</a></h2>
<p>在 Linux 中，如果使用 <code>ps</code> 命令查看进程的内存使用，会有 <code>VSZ</code> 和 <code>RSS</code> 两个数值。其中 <code>VSZ</code> 为虚拟内存大小，即进程申请使用了多少内存，而 <code>RSS</code> 为驻留集大小，即实际这个进程使用了多少物理内存（包含与其它进程共享的内存）。Linux 的内存分配机制为懒分配，如果程序需要使用内存，就分配给程序，但直到程序真正尝试访问内存时，才真正把内存给程序。譬如说程序有很多函数，但是除非函数真正被调用，否则这些函数不会被加载进内存，这种情况下 <code>VSZ</code> 高但是 <code>RSS</code> 低，节约物理内存。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-3-resource-ulimit">3. 使用 resource 来配置 ulimit<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-3-resource-ulimit" title="Permanent link">&para;</a></h2>
<p>首先观察这样一个 Python 程序（由于 RLIMIT_RSS 仅在 Linux 2.4.30 以下有用，故限制 RLIMIT_AS）：</p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-19">19</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-20">20</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-21">21</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-22">22</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-23">23</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-24">24</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-25">25</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-26">26</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-27">27</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-28">28</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-29">29</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-30">30</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-31">31</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-32">32</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-33">33</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-34">34</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-35">35</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-36">36</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-37">37</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-38">38</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-39">39</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-40">40</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-41">41</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-42">42</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-43">43</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-44">44</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-45">45</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-46">46</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-47">47</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-48">48</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-49">49</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-50">50</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-51">51</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-52">52</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-53">53</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-54">54</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-55">55</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-56">56</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-57">57</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-58">58</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-59">59</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-60">60</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-61">61</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-62">62</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-63">63</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-64">64</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-65">65</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-66">66</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-67">67</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-68">68</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-69">69</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-70">70</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-71">71</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-72">72</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-73">73</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-74">74</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-75">75</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-76">76</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-77">77</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-78">78</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-79">79</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-80">80</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-81">81</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-82">82</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-0-83">83</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="ch">#!/usr/bin/python</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="c1"># -*- coding: utf-8 -*-</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_function</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span><span class="o">,</span><span class="w"> </span><span class="nn">signal</span><span class="o">,</span><span class="w"> </span><span class="nn">resource</span><span class="o">,</span><span class="w"> </span><span class="nn">time</span><span class="o">,</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">subprocess</span><span class="w"> </span><span class="kn">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">PIPE</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">Command</span><span class="p">:</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">time_limit</span><span class="p">):</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_limit</span> <span class="o">=</span> <span class="n">time_limit</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">return_code</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15"></a>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17"></a>        <span class="n">process</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18"></a>            <span class="p">[</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19"></a>                <span class="s2">&quot;timeout&quot;</span><span class="p">,</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20"></a>                <span class="s2">&quot;-s&quot;</span><span class="p">,</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21"></a>                <span class="s2">&quot;9&quot;</span><span class="p">,</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22"></a>                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_limit</span><span class="p">),</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23"></a>                <span class="s2">&quot;/bin/bash&quot;</span><span class="p">,</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24"></a>                <span class="s2">&quot;-c&quot;</span><span class="p">,</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">,</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26"></a>            <span class="p">],</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27"></a>            <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28"></a>            <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29"></a>        <span class="p">)</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30"></a>        <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">return_code</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34"></a>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35"></a>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="k">class</span><span class="w"> </span><span class="nc">ResourceLimit</span><span class="p">:</span>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_memory_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size_mb</span><span class="p">):</span>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38"></a>        <span class="n">size_bytes</span> <span class="o">=</span> <span class="n">size_mb</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="n">resource</span><span class="o">.</span><span class="n">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_AS</span><span class="p">,</span> <span class="p">(</span><span class="n">size_bytes</span><span class="p">,</span> <span class="n">size_bytes</span><span class="p">))</span>
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40"></a>
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_memory_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="n">soft</span><span class="p">,</span> <span class="n">hard</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">getrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_AS</span><span class="p">)</span>
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] Current memory limit: </span><span class="si">%s</span><span class="s2"> (soft) </span><span class="si">%s</span><span class="s2"> (hard)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">soft</span><span class="p">,</span> <span class="n">hard</span><span class="p">))</span>
</span><span id="__span-0-44"><a id="__codelineno-0-44" name="__codelineno-0-44"></a>
</span><span id="__span-0-45"><a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_memory_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-0-46"><a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="n">command</span> <span class="o">=</span> <span class="n">Command</span><span class="p">(</span>
</span><span id="__span-0-47"><a id="__codelineno-0-47" name="__codelineno-0-47"></a>            <span class="s2">&quot;ps -o user,pid,pcpu,pmem,vsz,rss,args -p </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="mi">5</span>
</span><span id="__span-0-48"><a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="p">)</span>
</span><span id="__span-0-49"><a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="n">command</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span><span id="__span-0-50"><a id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;==== MEMORY USAGE ====&quot;</span><span class="p">)</span>
</span><span id="__span-0-51"><a id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
</span><span id="__span-0-52"><a id="__codelineno-0-52" name="__codelineno-0-52"></a>
</span><span id="__span-0-53"><a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_max_runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seconds</span><span class="p">):</span>
</span><span id="__span-0-54"><a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="n">resource</span><span class="o">.</span><span class="n">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_CPU</span><span class="p">,</span> <span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="n">seconds</span><span class="p">))</span>
</span><span id="__span-0-55"><a id="__codelineno-0-55" name="__codelineno-0-55"></a>
</span><span id="__span-0-56"><a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_max_runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-0-57"><a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="n">soft</span><span class="p">,</span> <span class="n">hard</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">getrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_CPU</span><span class="p">)</span>
</span><span id="__span-0-58"><a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] Current runtime limit: </span><span class="si">%s</span><span class="s2">s (soft) </span><span class="si">%s</span><span class="s2">s (hard)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">soft</span><span class="p">,</span> <span class="n">hard</span><span class="p">))</span>
</span><span id="__span-0-59"><a id="__codelineno-0-59" name="__codelineno-0-59"></a>
</span><span id="__span-0-60"><a id="__codelineno-0-60" name="__codelineno-0-60"></a>
</span><span id="__span-0-61"><a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
</span><span id="__span-0-62"><a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">Command</span><span class="p">(</span><span class="s2">&quot;df -PTh&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="__span-0-63"><a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="n">df</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span><span id="__span-0-64"><a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== STDOUT ====</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">df</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
</span><span id="__span-0-65"><a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== STDERR ====</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">df</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span><span id="__span-0-66"><a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RETURN CODE: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">df</span><span class="o">.</span><span class="n">return_code</span><span class="p">)</span>
</span><span id="__span-0-67"><a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="n">sleep</span> <span class="o">=</span> <span class="n">Command</span><span class="p">(</span><span class="s2">&quot;sleep 10&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="__span-0-68"><a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="n">sleep</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span><span id="__span-0-69"><a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== STDOUT ====</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sleep</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
</span><span id="__span-0-70"><a id="__codelineno-0-70" name="__codelineno-0-70"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== STDERR ====</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sleep</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span><span id="__span-0-71"><a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RETURN CODE: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sleep</span><span class="o">.</span><span class="n">return_code</span><span class="p">)</span>
</span><span id="__span-0-72"><a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="c1"># while True:</span>
</span><span id="__span-0-73"><a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="c1">#     pass</span>
</span><span id="__span-0-74"><a id="__codelineno-0-74" name="__codelineno-0-74"></a>
</span><span id="__span-0-75"><a id="__codelineno-0-75" name="__codelineno-0-75"></a>
</span><span id="__span-0-76"><a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="__span-0-77"><a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="n">ResourceLimit</span><span class="p">()</span><span class="o">.</span><span class="n">set_memory_limit</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
</span><span id="__span-0-78"><a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="n">ResourceLimit</span><span class="p">()</span><span class="o">.</span><span class="n">set_max_runtime</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-0-79"><a id="__codelineno-0-79" name="__codelineno-0-79"></a>    <span class="n">ResourceLimit</span><span class="p">()</span><span class="o">.</span><span class="n">get_memory_limit</span><span class="p">()</span>
</span><span id="__span-0-80"><a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="n">ResourceLimit</span><span class="p">()</span><span class="o">.</span><span class="n">get_max_runtime</span><span class="p">()</span>
</span><span id="__span-0-81"><a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="n">ResourceLimit</span><span class="p">()</span><span class="o">.</span><span class="n">get_memory_usage</span><span class="p">()</span>
</span><span id="__span-0-82"><a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="n">main</span><span class="p">()</span>
</span><span id="__span-0-83"><a id="__codelineno-0-83" name="__codelineno-0-83"></a>    <span class="n">ResourceLimit</span><span class="p">()</span><span class="o">.</span><span class="n">get_memory_usage</span><span class="p">()</span>
</span></code></pre></div></td></tr></table></div>
<p>这段代码中， <code>Command</code> 类用于执行系统命令， <code>ResourceLimit</code> 类用于限制系统的 CPU 和内存使用。每当执行<code>ResourceLimit().get_memory_usage()</code> 时，都调用系统的 <code>ps</code> 命令并打印出程序当前的内存大小，示例如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-1-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>==== MEMORY USAGE ====
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>USER       PID %CPU %MEM    VSZ   RSS COMMAND
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a>root       167  0.0  0.0  33280  5504 python main.py
</span></code></pre></div></td></tr></table></div>
<p>这表示程序申请了 33MB 内存，但是实际使用了 5.5 MB 。同时，在这个程序中，我们限制了 CPU 运行时间 1 秒，如果把死循环的语句的注释拿掉，程序进入死循环后 1 秒就被 Kill ，但是在没有拿掉注释时，程序实际运行时间大于 1 秒。这个是正常现象，因为我们限制的是这个 python 进程的实际在 CPU 上使用的时间，不包含它 sleep 的时间和子进程的时间。可以用 time 命令得到实际在 CPU 上跑的时间：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>time python src/main.py
</span></code></pre></div></td></tr></table></div>
<p>time 命令显示实际程序用的现实时间是 5 秒，但是其在 CPU 上运行的时间只有 0.1 秒不到。</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-__codelineno-3-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>real    0m5.020s
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>user    0m0.016s
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a>sys     0m0.006s
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-4">4. 参考资料<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8-4" title="Permanent link">&para;</a></h2>
<p><a href="https://linuxconfig.org/ps-output-difference-between-vsz-vs-rss-memory-usage">https://linuxconfig.org/ps-output-difference-between-vsz-vs-rss-memory-usage</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1121759">https://cloud.tencent.com/developer/article/1121759</a></p>
<p><a href="https://unix.stackexchange.com/questions/375889/unix-command-to-tell-how-much-ram-was-used-during-program-runtime">https://unix.stackexchange.com/questions/375889/unix-command-to-tell-how-much-ram-was-used-during-program-runtime</a></p>
<p><a href="https://docs.python.org/2/library/resource.html">https://docs.python.org/2/library/resource.html</a></p>
<p><a href="https://www.geeksforgeeks.org/python-how-to-put-limits-on-memory-and-cpu-usage/">https://www.geeksforgeeks.org/python-how-to-put-limits-on-memory-and-cpu-usage/</a></p></section></section>
                    <section class='print-page md-section' id='section-5-6' heading-number='5.6'>
                        <h1>Java<a class='headerlink' href='#section-5-6' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81" heading-number="5.6.1"><nav class='md-tags'><span class='md-tag'>Spring Security</span><span class='md-tag'>SpringBoot</span><span class='md-tag'>Java</span><span class='md-tag'>Keycloak</span></nav><h1 id="springboot-251-keycloak">SpringBoot 2.5.1 对接 Keycloak 认证<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-springboot-251-keycloak" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-1-spring">1. Spring 项目配置<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-1-spring" title="Permanent link">&para;</a></h2>
<p>在 <code>pom.xml</code> 加入依赖：</p>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-0-6">6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-0-7">7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-0-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nt">&lt;dependency&gt;</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">  </span><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-security<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="nt">&lt;/dependency&gt;</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="nt">&lt;dependency&gt;</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">  </span><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">  </span><span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-oauth2-client<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></div></td></tr></table></div>
<p>添加 application.properties 配置：</p>
<div class="language-ini highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-1-4">4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-1-5">5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-1-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="na">spring.security.oauth2.client.registration.keycloak.client-id</span><span class="o">=</span><span class="s">test-client</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="na">spring.security.oauth2.client.registration.keycloak.authorization-grant-type</span><span class="o">=</span><span class="s">authorization_code</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="na">spring.security.oauth2.client.registration.keycloak.scope</span><span class="o">=</span><span class="s">openid</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="na">spring.security.oauth2.client.provider.keycloak.issuer-uri</span><span class="o">=</span><span class="s">http://ubuntu.hxp.lan:8080/realms/test</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="na">spring.security.oauth2.client.provider.keycloak.user-name-attribute</span><span class="o">=</span><span class="s">preferred_username</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="na">spring.security.oauth2.resourceserver.jwt.issuer-uri</span><span class="o">=</span><span class="s">http://ubuntu.hxp.lan:8080/realms/test</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-2-keycloak">2. Keycloak 配置<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-2-keycloak" title="Permanent link">&para;</a></h2>
<p>本次使用的 Keycloak 开发服务器， docker-compose 配置如下：</p>
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-21">21</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-22">22</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-23">23</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-24">24</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-25">25</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-26">26</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-27">27</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-28">28</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-29">29</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-30">30</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-31">31</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-32">32</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-33">33</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-34">34</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-35">35</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-36">36</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-2-37">37</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;3&quot;</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="nt">services</span><span class="p">:</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">  </span><span class="nt">mysql</span><span class="p">:</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql:8.0</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql_data:/var/lib/mysql</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">      </span><span class="nt">MYSQL_ROOT_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MyRootPassword</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">      </span><span class="nt">MYSQL_DATABASE</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">      </span><span class="nt">MYSQL_USER</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">      </span><span class="nt">MYSQL_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MyKeycloakMySQLPassword</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">  </span><span class="nt">keycloak</span><span class="p">:</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">quay.io/keycloak/keycloak:24.0</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">start-dev</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">      </span><span class="nt">KC_HOSTNAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu.hxp.lan</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">      </span><span class="nt">KC_HOSTNAME_PORT</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="w">      </span><span class="nt">KC_HOSTNAME_STRICT_BACKCHANNEL</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="w">      </span><span class="nt">KC_HTTP_ENABLED</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="w">      </span><span class="nt">KC_HOSTNAME_STRICT_HTTPS</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="w">      </span><span class="nt">KC_HEALTH_ENABLED</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="w">      </span><span class="nt">KEYCLOAK_ADMIN</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="w">      </span><span class="nt">KEYCLOAK_ADMIN_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="w">      </span><span class="nt">KC_DB</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27"></a><span class="w">      </span><span class="nt">KC_DB_URL</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jdbc:mysql://mysql:3306/keycloak</span>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28"></a><span class="w">      </span><span class="nt">KC_DB_USERNAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29"></a><span class="w">      </span><span class="nt">KC_DB_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MyKeycloakMySQLPassword</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30"></a><span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080:8080</span>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32"></a><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33"></a><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
</span><span id="__span-2-34"><a id="__codelineno-2-34" name="__codelineno-2-34"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
</span><span id="__span-2-35"><a id="__codelineno-2-35" name="__codelineno-2-35"></a><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-2-36"><a id="__codelineno-2-36" name="__codelineno-2-36"></a><span class="w">  </span><span class="nt">mysql_data</span><span class="p">:</span>
</span><span id="__span-2-37"><a id="__codelineno-2-37" name="__codelineno-2-37"></a><span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
</span></code></pre></div></td></tr></table></div>
<p>docker 的 2 个容器启动完成之后，进入 <code>http://ubuntu.hxp.lan:8080/</code> 配置 Keycloak （用户名和密码均为 <code>admin</code> ），做如下配置：</p>
<ol>
<li>新建名称为 test 的 Realm</li>
<li>新建类型为 OpenID Connect ，ID 为 test-client 的 client</li>
<li>test-client 的 Client authentication 为 OFF</li>
<li>test-client 的 Valid redirect URIs 为 *</li>
<li>test-client 的 Web origins 为 *</li>
<li>在名称为 test 的 Realm 里新建用户 testuser</li>
</ol>
<p>之后启动 Spring 后端，会自动跳转到 Keycloak 登录页面。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-3-spring-securityconfig">3. 在 Spring 里 配置 SecurityConfig<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-3-spring-securityconfig" title="Permanent link">&para;</a></h2>
<p>新建文件 <code>src/main/java/com/onlyoffice/integration/config/SecurityConfig.java</code> ：</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-10">10</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-11">11</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-12">12</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-13">13</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-14">14</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-15">15</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-16">16</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-17">17</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-18">18</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-19">19</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-20">20</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-21">21</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-22">22</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-23">23</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-24">24</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-25">25</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-26">26</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-27">27</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-28">28</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-29">29</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-30">30</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-31">31</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-32">32</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-33">33</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-34">34</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-35">35</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-36">36</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-37">37</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-38">38</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-39">39</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-40">40</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-41">41</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-42">42</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-43">43</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-44">44</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-45">45</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-46">46</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-47">47</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-48">48</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-49">49</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-50">50</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-51">51</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-52">52</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-53">53</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-54">54</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-55">55</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-3-56">56</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">com.onlyoffice.integration.config</span><span class="p">;</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.context.annotation.Bean</span><span class="p">;</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.context.annotation.Configuration</span><span class="p">;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.config.annotation.web.builders.HttpSecurity</span><span class="p">;</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.config.annotation.web.configuration.EnableWebSecurity</span><span class="p">;</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.core.GrantedAuthority</span><span class="p">;</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.oauth2.client.oidc.userinfo.OidcUserRequest</span><span class="p">;</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.oauth2.client.oidc.userinfo.OidcUserService</span><span class="p">;</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.oauth2.client.registration.ClientRegistration</span><span class="p">;</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.oauth2.client.userinfo.OAuth2UserService</span><span class="p">;</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.oauth2.core.OAuth2AccessToken</span><span class="p">;</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.oauth2.core.oidc.user.DefaultOidcUser</span><span class="p">;</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.oauth2.core.oidc.user.OidcUser</span><span class="p">;</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.web.SecurityFilterChain</span><span class="p">;</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.util.StringUtils</span><span class="p">;</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17"></a>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashSet</span><span class="p">;</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Set</span><span class="p">;</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20"></a>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="nd">@Configuration</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="nd">@EnableWebSecurity</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SecurityConfig</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24"></a><span class="w">    </span><span class="nd">@Bean</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">SecurityFilterChain</span><span class="w"> </span><span class="nf">filterChain</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26"></a><span class="w">        </span><span class="n">http</span><span class="p">.</span><span class="na">csrf</span><span class="p">().</span><span class="na">disable</span><span class="p">().</span><span class="na">authorizeRequests</span><span class="p">().</span><span class="na">antMatchers</span><span class="p">(</span><span class="s">&quot;/track&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/download&quot;</span><span class="p">).</span><span class="na">permitAll</span><span class="p">().</span><span class="na">anyRequest</span><span class="p">().</span><span class="na">authenticated</span><span class="p">().</span><span class="na">and</span><span class="p">().</span><span class="na">oauth2Login</span><span class="p">(</span><span class="n">oauth2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">oauth2</span><span class="p">.</span><span class="na">userInfoEndpoint</span><span class="p">(</span><span class="n">userInfo</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">userInfo</span><span class="p">.</span><span class="na">oidcUserService</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">oidcUserService</span><span class="p">())));</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">http</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29"></a>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">OAuth2UserService</span><span class="o">&lt;</span><span class="n">OidcUserRequest</span><span class="p">,</span><span class="w"> </span><span class="n">OidcUser</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">oidcUserService</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">OidcUserService</span><span class="w"> </span><span class="n">delegate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">OidcUserService</span><span class="p">();</span>
</span><span id="__span-3-32"><a id="__codelineno-3-32" name="__codelineno-3-32"></a>
</span><span id="__span-3-33"><a id="__codelineno-3-33" name="__codelineno-3-33"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">userRequest</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-34"><a id="__codelineno-3-34" name="__codelineno-3-34"></a><span class="w">            </span><span class="c1">// Delegate to the default implementation for loading a user</span>
</span><span id="__span-3-35"><a id="__codelineno-3-35" name="__codelineno-3-35"></a><span class="w">            </span><span class="n">OidcUser</span><span class="w"> </span><span class="n">oidcUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">delegate</span><span class="p">.</span><span class="na">loadUser</span><span class="p">(</span><span class="n">userRequest</span><span class="p">);</span>
</span><span id="__span-3-36"><a id="__codelineno-3-36" name="__codelineno-3-36"></a>
</span><span id="__span-3-37"><a id="__codelineno-3-37" name="__codelineno-3-37"></a><span class="w">            </span><span class="n">OAuth2AccessToken</span><span class="w"> </span><span class="n">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userRequest</span><span class="p">.</span><span class="na">getAccessToken</span><span class="p">();</span>
</span><span id="__span-3-38"><a id="__codelineno-3-38" name="__codelineno-3-38"></a><span class="w">            </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">GrantedAuthority</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mappedAuthorities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-3-39"><a id="__codelineno-3-39" name="__codelineno-3-39"></a>
</span><span id="__span-3-40"><a id="__codelineno-3-40" name="__codelineno-3-40"></a><span class="w">            </span><span class="c1">// TODO</span>
</span><span id="__span-3-41"><a id="__codelineno-3-41" name="__codelineno-3-41"></a><span class="w">            </span><span class="c1">// 1) Fetch the authority information from the protected resource using accessToken</span>
</span><span id="__span-3-42"><a id="__codelineno-3-42" name="__codelineno-3-42"></a><span class="w">            </span><span class="c1">// 2) Map the authority information to one or more GrantedAuthority&#39;s and add it to mappedAuthorities</span>
</span><span id="__span-3-43"><a id="__codelineno-3-43" name="__codelineno-3-43"></a>
</span><span id="__span-3-44"><a id="__codelineno-3-44" name="__codelineno-3-44"></a><span class="w">            </span><span class="c1">// 3) Create a copy of oidcUser but use the mappedAuthorities instead</span>
</span><span id="__span-3-45"><a id="__codelineno-3-45" name="__codelineno-3-45"></a><span class="w">            </span><span class="n">ClientRegistration</span><span class="p">.</span><span class="na">ProviderDetails</span><span class="w"> </span><span class="n">providerDetails</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userRequest</span><span class="p">.</span><span class="na">getClientRegistration</span><span class="p">().</span><span class="na">getProviderDetails</span><span class="p">();</span>
</span><span id="__span-3-46"><a id="__codelineno-3-46" name="__codelineno-3-46"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">userNameAttributeName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">providerDetails</span><span class="p">.</span><span class="na">getUserInfoEndpoint</span><span class="p">().</span><span class="na">getUserNameAttributeName</span><span class="p">();</span>
</span><span id="__span-3-47"><a id="__codelineno-3-47" name="__codelineno-3-47"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">userNameAttributeName</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-48"><a id="__codelineno-3-48" name="__codelineno-3-48"></a><span class="w">                </span><span class="n">oidcUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DefaultOidcUser</span><span class="p">(</span><span class="n">mappedAuthorities</span><span class="p">,</span><span class="w"> </span><span class="n">oidcUser</span><span class="p">.</span><span class="na">getIdToken</span><span class="p">(),</span><span class="w"> </span><span class="n">oidcUser</span><span class="p">.</span><span class="na">getUserInfo</span><span class="p">(),</span><span class="w"> </span><span class="n">userNameAttributeName</span><span class="p">);</span>
</span><span id="__span-3-49"><a id="__codelineno-3-49" name="__codelineno-3-49"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-50"><a id="__codelineno-3-50" name="__codelineno-3-50"></a><span class="w">                </span><span class="n">oidcUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DefaultOidcUser</span><span class="p">(</span><span class="n">mappedAuthorities</span><span class="p">,</span><span class="w"> </span><span class="n">oidcUser</span><span class="p">.</span><span class="na">getIdToken</span><span class="p">(),</span><span class="w"> </span><span class="n">oidcUser</span><span class="p">.</span><span class="na">getUserInfo</span><span class="p">());</span>
</span><span id="__span-3-51"><a id="__codelineno-3-51" name="__codelineno-3-51"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-3-52"><a id="__codelineno-3-52" name="__codelineno-3-52"></a>
</span><span id="__span-3-53"><a id="__codelineno-3-53" name="__codelineno-3-53"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">oidcUser</span><span class="p">;</span>
</span><span id="__span-3-54"><a id="__codelineno-3-54" name="__codelineno-3-54"></a><span class="w">        </span><span class="p">};</span>
</span><span id="__span-3-55"><a id="__codelineno-3-55" name="__codelineno-3-55"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-56"><a id="__codelineno-3-56" name="__codelineno-3-56"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>注意这里我禁用了 CSRF ，并且允许 <code>/track</code> 和 <code>/download</code> 非授权访问。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-4-spring-keycloak">4. 在 Spring 里读取已登录的 Keycloak 用户信息<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-4-spring-keycloak" title="Permanent link">&para;</a></h2>
<p>在适当的地方引用如下依赖：</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-4-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-4-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.core.Authentication</span><span class="p">;</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.core.context.SecurityContextHolder</span><span class="p">;</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.oauth2.client.authentication.OAuth2AuthenticationToken</span><span class="p">;</span>
</span></code></pre></div></td></tr></table></div>
<p>获取用户信息的示例如下：</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-3">3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-4">4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-5">5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-6">6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-__codelineno-5-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="n">String</span><span class="w"> </span><span class="n">userFullName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;匿名用户&quot;</span><span class="p">;</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="n">Authentication</span><span class="w"> </span><span class="n">authentication</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SecurityContextHolder</span><span class="p">.</span><span class="na">getContext</span><span class="p">().</span><span class="na">getAuthentication</span><span class="p">();</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">authentication</span><span class="p">.</span><span class="na">getPrincipal</span><span class="p">().</span><span class="na">getClass</span><span class="p">());</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">authentication</span><span class="p">.</span><span class="na">getPrincipal</span><span class="p">()</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">DefaultOidcUser</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">    </span><span class="n">DefaultOidcUser</span><span class="w"> </span><span class="n">userDetails</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">DefaultOidcUser</span><span class="p">)</span><span class="w"> </span><span class="n">authentication</span><span class="p">.</span><span class="na">getPrincipal</span><span class="p">();</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">    </span><span class="n">userFullName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userDetails</span><span class="p">.</span><span class="na">getFullName</span><span class="p">();</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-5">5. 参考资料<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81-5" title="Permanent link">&para;</a></h2>
<p><a href="https://www.baeldung.com/spring-boot-security-autoconfiguration">https://www.baeldung.com/spring-boot-security-autoconfiguration</a></p>
<p><a href="https://www.baeldung.com/spring-security-5-oauth2-login">https://www.baeldung.com/spring-security-5-oauth2-login</a></p>
<p><a href="https://spring.io/guides/tutorials/spring-boot-oauth2">https://spring.io/guides/tutorials/spring-boot-oauth2</a></p>
<p><a href="https://spring.io/blog/2018/03/06/using-spring-security-5-to-integrate-with-oauth-2-secured-services-such-as-facebook-and-github">https://spring.io/blog/2018/03/06/using-spring-security-5-to-integrate-with-oauth-2-secured-services-such-as-facebook-and-github</a></p>
<p><a href="https://docs.spring.io/spring-security/reference/5.7/servlet/oauth2/login/advanced.html#oauth2login-advanced-oidc-user-service">https://docs.spring.io/spring-security/reference/5.7/servlet/oauth2/login/advanced.html#oauth2login-advanced-oidc-user-service</a></p></section><section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91" heading-number="5.6.2"><nav class='md-tags'><span class='md-tag'>OnlyOffice</span><span class='md-tag'>SpringBoot</span><span class='md-tag'>Maven</span><span class='md-tag'>Java</span></nav><h1 id="onlyoffice-spring">使用 OnlyOffice 官方 Spring 示例遇到的坑<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-onlyoffice-spring" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-1-github-resources">1. GitHub 下载下来的代码中 resources 目录缺失<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-1-github-resources" title="Permanent link">&para;</a></h2>
<p>这是由于 <code>web/documentserver-example/java-spring/src/main/resources</code> 下的两个目录不属于这个 GitHub 仓库，是 submodule ：</p>
<p><img alt="" src="%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Java/images/onlyoffice_1.png" /></p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>git clone --recurse-submodules https://github.com/ONLYOFFICE/document-server-integration.git
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-2-idea-jar">2. 如何用 IDEA 将项目编译成 jar 包<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-2-idea-jar" title="Permanent link">&para;</a></h2>
<p>项目加载到 IDEA 后，点开 maven 的标签页，鼠标双击这个 <code>package</code> ：</p>
<p><img alt="" src="%E8%BF%90%E7%BB%B4%E5%BC%80%E5%8F%91/Java/images/onlyoffice_2.png" /></p>
<p>jar 包会生成在 <code>target/integration-1.0.jar</code> ，将其复制即可使用。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-3-jar">3. 项目打包成 jar 后单独运行报错<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-3-jar" title="Permanent link">&para;</a></h2>
<p>项目打包成 jar 包单独运行会报错 FileNotFoundException ，原因有 2 个，首先是 resources 目录没有被打包进入 jar 包，解决方法为修改 <code>pom.xml</code> ，在 <code>build</code> 中加入：</p>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-1-4">4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-1-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nt">&lt;resources&gt;</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">  </span><span class="nt">&lt;resource&gt;</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">    </span><span class="nt">&lt;directory&gt;</span>${basedir}/src/main/resources<span class="nt">&lt;/directory&gt;</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="nt">&lt;/resource&gt;</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="nt">&lt;/resources&gt;</span>
</span></code></pre></div></td></tr></table></div>
<p>其次是 <code>src/main/java/com/onlyoffice/integration/documentserver/util/service/DefaultFormatService.java</code> 中这一行使用的 <code>getFile()</code> 方法在 jar 包中不适用：</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="n">File</span><span class="w"> </span><span class="n">targetFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resourceFile</span><span class="p">.</span><span class="na">getFile</span><span class="p">();</span>
</span></code></pre></div></td></tr></table></div>
<p>需要将这一行修改为以下几行：</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-3-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="n">InputStream</span><span class="w"> </span><span class="n">inputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resourceFile</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">();</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="n">File</span><span class="w"> </span><span class="n">targetFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span><span class="p">.</span><span class="na">createTempFile</span><span class="p">(</span><span class="s">&quot;onlyoffice-docs-formats&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;.json&quot;</span><span class="p">);</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">outputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="n">targetFile</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bufferLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">    </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">bufferLength</span><span class="o">]</span><span class="p">;</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">bytesRead</span><span class="p">;</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">bytesRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inputStream</span><span class="p">.</span><span class="na">read</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">        </span><span class="n">outputStream</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">bytesRead</span><span class="p">);</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>同时需要导入额外的以下两个包：</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-4-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileOutputStream</span><span class="p">;</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.InputStream</span><span class="p">;</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-4">4. 文档上传大小限制修改<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-4" title="Permanent link">&para;</a></h2>
<p>默认的文档上传限制过小，有些大文档上传会报错，需要修改 <code>src/main/resources/application.properties</code> ：</p>
<div class="language-ini highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-5-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-5-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="na">filesize-max</span><span class="o">=</span><span class="s">5242880</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="na">spring.servlet.multipart.max-file-size</span><span class="o">=</span><span class="s">50MB</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="na">spring.servlet.multipart.max-request-size</span><span class="o">=</span><span class="s">50MB</span>
</span></code></pre></div></td></tr></table></div>
<p>将以上三个参数修改为原来的 10 倍。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-5-mysql">5. 修改为使用 MySQL 数据库<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-5-mysql" title="Permanent link">&para;</a></h2>
<p>默认情况下这个 Spring 示例使用在内存中的 h2 数据库，需要将其修改为使用 MySQL ，需要修改 <code>src/main/resources/application.properties</code> ，将以下几行：</p>
<div class="language-ini highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-6-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-6-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-6-3">3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-6-4">4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-6-5">5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-6-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="na">spring.datasource.url</span><span class="o">=</span><span class="s">jdbc:h2:mem:usersdb</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="na">spring.datasource.driverClassName</span><span class="o">=</span><span class="s">org.h2.Driver</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="na">spring.datasource.username</span><span class="o">=</span><span class="s">sa</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="na">spring.datasource.password</span><span class="o">=</span><span class="s">password</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="na">spring.jpa.database-platform</span><span class="o">=</span><span class="s">org.hibernate.dialect.H2Dialect</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="na">hibernate.ddl-auto</span>
</span></code></pre></div></td></tr></table></div>
<p>修改为如下所示：</p>
<div class="language-ini highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-7-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-7-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-7-3">3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-7-4">4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-7-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="na">spring.datasource.url</span><span class="o">=</span><span class="s">jdbc:mysql://ubuntu.hxp.lan:3306/spring</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="na">spring.datasource.driverClassName</span><span class="o">=</span><span class="s">com.mysql.cj.jdbc.Driver</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="na">spring.datasource.username</span><span class="o">=</span><span class="s">spring</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="na">spring.datasource.password</span><span class="o">=</span><span class="s">spring</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="na">spring.jpa.hibernate.ddl-auto</span><span class="o">=</span><span class="s">create-drop</span>
</span></code></pre></div></td></tr></table></div>
<p>同时，在 <code>pom.xml</code> 里增加 mysql-connector ：</p>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-8-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-8-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-8-3">3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-8-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="nt">&lt;dependency&gt;</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="w">  </span><span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">  </span><span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-6-spring-spring-security">6. Spring 项目加入 spring security 后无法运行<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-6-spring-spring-security" title="Permanent link">&para;</a></h2>
<p>在引入 spring security 后，即使是 permitAll() 在打开 OnlyOffice 页面还是报错， document-server 报错如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-9-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-9-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a>document-server-1  | [2024-05-28T22:08:57.809] [ERROR] [localhost] [1383708097] [1] nodeJS - postData error: url = http://ubuntu.hxp.lan:4000/track?fileName=new.docx&amp;userAddress=%2Fhome%2Fhxp%2Fonlyoffice-spring-keycloak%2Fdocuments%2F127.0.1.1%2F;data = {&quot;key&quot;:&quot;1383708097&quot;,&quot;status&quot;:1,&quot;users&quot;:[&quot;1&quot;],&quot;actions&quot;:[{&quot;type&quot;:1,&quot;userid&quot;:&quot;1&quot;}]} Error: Error response: statusCode:403; headers:{&quot;set-cookie&quot;:[&quot;JSESSIONID=B667F99DC2C69C008DF263C81F2A5FCA; Path=/; HttpOnly&quot;],&quot;x-content-type-options&quot;:&quot;nosniff&quot;,&quot;x-xss-protection&quot;:&quot;1; mode=block&quot;,&quot;cache-control&quot;:&quot;no-cache, no-store, max-age=0, must-revalidate&quot;,&quot;pragma&quot;:&quot;no-cache&quot;,&quot;expires&quot;:&quot;0&quot;,&quot;x-frame-options&quot;:&quot;DENY&quot;,&quot;content-type&quot;:&quot;application/json&quot;,&quot;transfer-encoding&quot;:&quot;chunked&quot;,&quot;date&quot;:&quot;Tue, 28 May 2024 14:08:57 GMT&quot;,&quot;connection&quot;:&quot;close&quot;}; body:
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2"></a>document-server-1  | {&quot;timestamp&quot;:1716905337808,&quot;status&quot;:403,&quot;error&quot;:&quot;Forbidden&quot;,&quot;message&quot;:&quot;Forbidden&quot;,&quot;path&quot;:&quot;/track&quot;}
</span></code></pre></div></td></tr></table></div>
<p>此时需要检查 Spring 的日志，在 <code>application.properties</code> 加入：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-10-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a>logging.level.org.springframework.security=DEBUG
</span></code></pre></div></td></tr></table></div>
<p>观察到 Spring 吐出以下日志：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-11-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-11-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-11-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a>2024-05-28 14:07:54.813 DEBUG 1342180 --- [nio-4000-exec-2] s.s.w.c.SecurityContextPersistenceFilter : Set SecurityContextHolder to empty SecurityContext
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2"></a>2024-05-28 14:07:54.814 DEBUG 1342180 --- [nio-4000-exec-2] o.s.security.web.csrf.CsrfFilter         : Invalid CSRF token found for http://ubuntu.hxp.lan:4000/track?fileName=new.docx&amp;userAddress=%2Fhome%2Fhxp%2Fonlyoffice-spring-keycloak%2Fdocuments%2F127.0.1.1%2F
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3"></a>2024-05-28 14:07:54.814 DEBUG 1342180 --- [nio-4000-exec-2] o.s.s.w.access.AccessDeniedHandlerImpl   : Responding with 403 status code
</span></code></pre></div></td></tr></table></div>
<p>可以确定是 spring security 的 csrf 保护返回了 403 导致。解决方法为修改 SecurityChain ，在 http 后面加上 <code>.csrf.disable()</code> ，示例如下：</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-12-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="kd">public</span><span class="w"> </span><span class="n">SecurityFilterChain</span><span class="w"> </span><span class="nf">filterChain</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="w">    </span><span class="n">http</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">            </span><span class="p">.</span><span class="na">csrf</span><span class="p">().</span><span class="na">disable</span><span class="p">()</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">            </span><span class="p">.</span><span class="na">authorizeRequests</span><span class="p">()</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">            </span><span class="p">.</span><span class="na">antMatchers</span><span class="p">(</span><span class="s">&quot;/track&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/download&quot;</span><span class="p">).</span><span class="na">permitAll</span><span class="p">()</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="w">            </span><span class="p">.</span><span class="na">anyRequest</span><span class="p">().</span><span class="na">authenticated</span><span class="p">()</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="w">            </span><span class="p">.</span><span class="na">and</span><span class="p">()</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="w">            </span><span class="p">.</span><span class="na">oauth2Login</span><span class="p">();</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">http</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-7-spring-document-server-10">7. 在内网部署时， Spring 后端调用 document-server 时，存在大约 10 秒左右的延迟，才展示文档编辑页面<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-7-spring-document-server-10" title="Permanent link">&para;</a></h2>
<p>这个是因为 document-server 每次被调用的时候都会尝试访问外网，访问外网会进行 DNS 查询。而实际部署时，机器的 DNS 被设置成了 3 个根本就不通的外网 DNS ，导致每次开启 document-server ，都会访问外网，访问外网时先用第一个 DNS 服务器解析，第一个 DNS 服务器连接超时后，再尝试第 2 个 DNS 服务器，以此类推。解决方法为修正内网部署机器的 DNS 为正确的配置。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-8-applicationproperties-jar">8. 将 application.properties 不打包到 jar<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-8-applicationproperties-jar" title="Permanent link">&para;</a></h2>
<p><code>pom.xml</code> 增加 plugin ：</p>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-13-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="nt">&lt;plugin&gt;</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="w">  </span><span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">  </span><span class="nt">&lt;artifactId&gt;</span>maven-jar-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">  </span><span class="nt">&lt;version&gt;</span>3.2.0<span class="nt">&lt;/version&gt;</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">  </span><span class="nt">&lt;configuration&gt;</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">    </span><span class="nt">&lt;excludes&gt;</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="w">      </span><span class="nt">&lt;exclude&gt;</span>**/application.properties<span class="nt">&lt;/exclude&gt;</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="w">    </span><span class="nt">&lt;/excludes&gt;</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="w">  </span><span class="nt">&lt;/configuration&gt;</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="nt">&lt;/plugin&gt;</span>
</span></code></pre></div></td></tr></table></div>
<p>这样打包后的 jar 包不含 <code>application.properties</code> ，运行需要手动指定：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-__codelineno-14-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a>java -jar integration-1.0.jar --spring.config.location=file:///${HOME}/onlyoffice-spring-keycloak/src/main/resources/application.properties
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-9">9. 参考文献<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91-9" title="Permanent link">&para;</a></h2>
<p><a href="https://www.baeldung.com/spring-security-enable-logging">https://www.baeldung.com/spring-security-enable-logging</a></p>
<p><a href="https://www.baeldung.com/spring-properties-file-outside-jar">https://www.baeldung.com/spring-properties-file-outside-jar</a></p>
<p><a href="https://www.waheedtechblog.com/2014/07/how-to-exclude-properties-file-from-jar.html">https://www.waheedtechblog.com/2014/07/how-to-exclude-properties-file-from-jar.html</a></p></section></section>
                    <section class='print-page md-section' id='section-5-7' heading-number='5.7'>
                        <h1>Shell<a class='headerlink' href='#section-5-7' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-shell-shell%e8%ae%be%e7%bd%ae%e5%8f%98%e9%87%8f%e6%9c%aa%e8%b5%8b%e5%80%bc%e6%88%96%e9%81%87%e5%88%b0%e9%94%99%e8%af%af%e7%ab%8b%e5%88%bb%e9%80%80%e5%87%ba" heading-number="5.7.1"><nav class='md-tags'><span class='md-tag'>Shell</span></nav><h1 id="shell">Shell 设置变量未赋值或遇到错误立刻退出<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-shell-shell%e8%ae%be%e7%bd%ae%e5%8f%98%e9%87%8f%e6%9c%aa%e8%b5%8b%e5%80%bc%e6%88%96%e9%81%87%e5%88%b0%e9%94%99%e8%af%af%e7%ab%8b%e5%88%bb%e9%80%80%e5%87%ba-shell" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-shell-shell%e8%ae%be%e7%bd%ae%e5%8f%98%e9%87%8f%e6%9c%aa%e8%b5%8b%e5%80%bc%e6%88%96%e9%81%87%e5%88%b0%e9%94%99%e8%af%af%e7%ab%8b%e5%88%bb%e9%80%80%e5%87%ba-1">1. 问题背景<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-shell-shell%e8%ae%be%e7%bd%ae%e5%8f%98%e9%87%8f%e6%9c%aa%e8%b5%8b%e5%80%bc%e6%88%96%e9%81%87%e5%88%b0%e9%94%99%e8%af%af%e7%ab%8b%e5%88%bb%e9%80%80%e5%87%ba-1" title="Permanent link">&para;</a></h2>
<p>众所周知 Shell 是一个不安全的语言，变量不被定义也可以被访问，而且一行命令报错以后，不是像其它语言似的退出，而是接着运行下面的命令。通过修改 Shell 脚本的一些设置，可以暂时弥补下这个问题。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-shell-shell%e8%ae%be%e7%bd%ae%e5%8f%98%e9%87%8f%e6%9c%aa%e8%b5%8b%e5%80%bc%e6%88%96%e9%81%87%e5%88%b0%e9%94%99%e8%af%af%e7%ab%8b%e5%88%bb%e9%80%80%e5%87%ba-2-shell">2. 每个 Shell 脚本都推荐增加的参数<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-shell-shell%e8%ae%be%e7%bd%ae%e5%8f%98%e9%87%8f%e6%9c%aa%e8%b5%8b%e5%80%bc%e6%88%96%e9%81%87%e5%88%b0%e9%94%99%e8%af%af%e7%ab%8b%e5%88%bb%e9%80%80%e5%87%ba-2-shell" title="Permanent link">&para;</a></h2>
<p>推荐在每个 Shell 脚本前都加入以下语句：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-shell-shell%e8%ae%be%e7%bd%ae%e5%8f%98%e9%87%8f%e6%9c%aa%e8%b5%8b%e5%80%bc%e6%88%96%e9%81%87%e5%88%b0%e9%94%99%e8%af%af%e7%ab%8b%e5%88%bb%e9%80%80%e5%87%ba-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-shell-shell%e8%ae%be%e7%bd%ae%e5%8f%98%e9%87%8f%e6%9c%aa%e8%b5%8b%e5%80%bc%e6%88%96%e9%81%87%e5%88%b0%e9%94%99%e8%af%af%e7%ab%8b%e5%88%bb%e9%80%80%e5%87%ba-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-shell-shell%e8%ae%be%e7%bd%ae%e5%8f%98%e9%87%8f%e6%9c%aa%e8%b5%8b%e5%80%bc%e6%88%96%e9%81%87%e5%88%b0%e9%94%99%e8%af%af%e7%ab%8b%e5%88%bb%e9%80%80%e5%87%ba-__codelineno-0-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nb">set</span><span class="w"> </span>-o<span class="w"> </span>errexit
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nb">set</span><span class="w"> </span>-o<span class="w"> </span>nounset
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="nb">set</span><span class="w"> </span>-o<span class="w"> </span>pipefail
</span></code></pre></div></td></tr></table></div>
<p>其中 <code>set -o errexit</code> 等同于 <code>set -e</code> ,作用为有一行命令报错立刻退出。 <code>set -o nounset</code> 等同于 <code>set -u</code> ，作用为在访问未定义变量时报错。 <code>set -o pipefail</code> 作用为对于单行命令，返回值不再是最右侧命令返回值，而是在返回值不为零的命令中，取最右侧的作为返回值。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-shell-shell%e8%ae%be%e7%bd%ae%e5%8f%98%e9%87%8f%e6%9c%aa%e8%b5%8b%e5%80%bc%e6%88%96%e9%81%87%e5%88%b0%e9%94%99%e8%af%af%e7%ab%8b%e5%88%bb%e9%80%80%e5%87%ba-3">3. 参考资料<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-shell-shell%e8%ae%be%e7%bd%ae%e5%8f%98%e9%87%8f%e6%9c%aa%e8%b5%8b%e5%80%bc%e6%88%96%e9%81%87%e5%88%b0%e9%94%99%e8%af%af%e7%ab%8b%e5%88%bb%e9%80%80%e5%87%ba-3" title="Permanent link">&para;</a></h2>
<p><a href="https://medium.com/factualopinions/consider-starting-all-your-bash-scripts-with-these-options-74fbec0cbb83">https://medium.com/factualopinions/consider-starting-all-your-bash-scripts-with-these-options-74fbec0cbb83</a></p>
<p><a href="https://www.gnu.org/software/bash/manual/bash.html#The-Set-Builtin">https://www.gnu.org/software/bash/manual/bash.html#The-Set-Builtin</a></p></section></section>
                    <section class='print-page md-section' id='section-5-8' heading-number='5.8'>
                        <h1>Rust<a class='headerlink' href='#section-5-8' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85" heading-number="5.8.1"><h1 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-rust">Rust 离线开发环境安装<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-rust" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-1">1. 安装准备<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-1" title="Permanent link">&para;</a></h2>
<p>下载以下文件：</p>
<ul>
<li>rust-1.80.1-aarch64-unknown-linux-gnu.tar.xz</li>
<li>rust-std-1.80.1-aarch64-unknown-linux-musl.tar.xz</li>
<li>rust-src-1.80.1.tar.xz</li>
<li>rustup-init</li>
</ul>
<p>安装地址详见 <a href="https://static.rust-lang.org/dist/channel-rust-stable.toml">https://static.rust-lang.org/dist/channel-rust-stable.toml</a> 和 <a href="https://rust-lang.github.io/rustup/installation/other.html">https://rust-lang.github.io/rustup/installation/other.html</a></p>
<h%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-2">2. 配置安装路径<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-2" title="Permanent link">&para;</a></h2>
<p>使用环境变量配置安装路径：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">RUST_INSTALL_DIR</span><span class="o">=</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/softwares/rust
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="nv">$RUST_INSTALL_DIR</span>
</span></code></pre></div></td></tr></table></div>
<p>如果中途退出安装，下次继续安装时需要重新设置这些环境变量。</p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-3-rust">3. 安装 Rust<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-3-rust" title="Permanent link">&para;</a></h2>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-1-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>tar<span class="w"> </span>-xJf<span class="w"> </span>rust-1.80.1-aarch64-unknown-linux-gnu.tar.xz
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>./rust-1.80.1-aarch64-unknown-linux-gnu/install.sh<span class="w"> </span>--prefix<span class="o">=</span><span class="nv">$RUST_INSTALL_DIR</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-4-rustup">4. 安装 rustup<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-4-rustup" title="Permanent link">&para;</a></h2>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-2-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>chmod<span class="w"> </span>+x<span class="w"> </span>./rustup-init
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>./rustup-init<span class="w"> </span>--default-toolchain<span class="w"> </span>none<span class="w"> </span>-y
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="nb">source</span><span class="w"> </span>~/.bashrc
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-5-toolchain">5. 安装 toolchain<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-5-toolchain" title="Permanent link">&para;</a></h2>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-3-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>rustup<span class="w"> </span>toolchain<span class="w"> </span>link<span class="w"> </span>rust-1.80.1-aarch64-unknown-linux-gnu<span class="w"> </span><span class="nv">$RUST_INSTALL_DIR</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>rustup<span class="w"> </span>default<span class="w"> </span>rust-1.80.1-aarch64-unknown-linux-gnu
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a>rustc<span class="w"> </span>--version
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-6-target">6. 安装交叉编译 target<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-6-target" title="Permanent link">&para;</a></h2>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-4-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>tar<span class="w"> </span>-xJf<span class="w"> </span>rust-std-1.80.1-aarch64-unknown-linux-musl.tar.xz
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a>./rust-std-1.80.1-aarch64-unknown-linux-musl/install.sh<span class="w"> </span>--prefix<span class="o">=</span><span class="nv">$RUST_INSTALL_DIR</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-7-rust-src">7. 安装 rust-src<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-7-rust-src" title="Permanent link">&para;</a></h2>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-5-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>tar<span class="w"> </span>-xJf<span class="w"> </span>rust-src-1.80.1.tar.xz
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a>./rust-src-1.80.1/install.sh<span class="w"> </span>--prefix<span class="o">=</span><span class="nv">$RUST_INSTALL_DIR</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-8-configtoml">8. 配置 config.toml<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-8-configtoml" title="Permanent link">&para;</a></h2>
<p>新建文件 <code>~/.cargo/config.toml</code> :</p>
<div class="language-toml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-6-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-6-2">2</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-6-3">3</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-6-4">4</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-6-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">[source.crates-io]</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="n">replace-with</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;vendored-sources&quot;</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="k">[source.vendored-sources]</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="n">directory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;vendor&quot;</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-9">9. 交叉编译<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-9" title="Permanent link">&para;</a></h2>
<p>查看可用的 target ：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-7-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a>rustc<span class="w"> </span>--print<span class="w"> </span>target-list<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>musl<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>linux<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>aarch64
</span></code></pre></div></td></tr></table></div>
<p>编译：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-8-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a>cargo<span class="w"> </span>build<span class="w"> </span>--target<span class="o">=</span>aarch64-unknown-linux-musl<span class="w"> </span>--release
</span></code></pre></div></td></tr></table></div>
<p>如果需要使用 crate 包，在线机器上运行 <code>cargo vendor</code> ，之后把 <code>vendor</code> 目录复制到用户的家目录下。</p></section><section class="print-page" id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e4%ba%a4%e5%8f%89%e7%bc%96%e8%af%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85" heading-number="5.8.2"><h1 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e4%ba%a4%e5%8f%89%e7%bc%96%e8%af%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-rust">Rust 交叉编译环境离线安装<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e4%ba%a4%e5%8f%89%e7%bc%96%e8%af%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-rust" title="Permanent link">&para;</a></h1>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e4%ba%a4%e5%8f%89%e7%bc%96%e8%af%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-1">1. 安装准备<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e4%ba%a4%e5%8f%89%e7%bc%96%e8%af%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-1" title="Permanent link">&para;</a></h2>
<p>下载以下文件：</p>
<ul>
<li>aarch64-linux-musl-cross.tgz</li>
<li>rust-std-1.80.1-aarch64-unknown-linux-musl.tar.xz</li>
</ul>
<p>其中 MUSL 交叉编译工具链下载地址见 <a href="https://musl.cc">https://musl.cc</a> ，Rust 相关下载地址见 <a href="https://static.rust-lang.org/dist/channel-rust-stable.toml">https://static.rust-lang.org/dist/channel-rust-stable.toml</a></p>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e4%ba%a4%e5%8f%89%e7%bc%96%e8%af%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-2-musl">2. 安装 MUSL 交叉编译环境<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e4%ba%a4%e5%8f%89%e7%bc%96%e8%af%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-2-musl" title="Permanent link">&para;</a></h2>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e4%ba%a4%e5%8f%89%e7%bc%96%e8%af%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>tar<span class="w"> </span>-zxf<span class="w"> </span>aarch64-linux-musl-cross.tgz<span class="w"> </span>-C<span class="w"> </span>~/softwares/rust/
</span></code></pre></div></td></tr></table></div>
<p>修改 <code>~/.bashrc</code> ：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e4%ba%a4%e5%8f%89%e7%bc%96%e8%af%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span>~/softwares/rust/aarch64-linux-musl-cross/bin/:<span class="nv">$PATH</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e4%ba%a4%e5%8f%89%e7%bc%96%e8%af%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nb">source</span><span class="w"> </span>~/.bashrc
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e4%ba%a4%e5%8f%89%e7%bc%96%e8%af%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-3-rust-std">3. 安装目标版本 rust-std<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e4%ba%a4%e5%8f%89%e7%bc%96%e8%af%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-3-rust-std" title="Permanent link">&para;</a></h2>
<p>解压 <code>rust-std</code> 并安装 ：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e4%ba%a4%e5%8f%89%e7%bc%96%e8%af%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e4%ba%a4%e5%8f%89%e7%bc%96%e8%af%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-3-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>tar<span class="w"> </span>-xJf<span class="w"> </span>rust-std-1.80.1-aarch64-unknown-linux-musl.tar.xz
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>./rust-std-1.80.1-aarch64-unknown-linux-musl/install.sh<span class="w"> </span>--prefix<span class="o">=</span><span class="nv">$HOME</span>/softwares/rust/
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e4%ba%a4%e5%8f%89%e7%bc%96%e8%af%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-4-cargo">4. 配置 cargo<a class="headerlink" href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e4%ba%a4%e5%8f%89%e7%bc%96%e8%af%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-4-cargo" title="Permanent link">&para;</a></h2>
<p>修改 <code>~/.cargo/config.toml</code> ：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e4%ba%a4%e5%8f%89%e7%bc%96%e8%af%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e4%ba%a4%e5%8f%89%e7%bc%96%e8%af%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85-__codelineno-4-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="o">[</span>target.aarch64-unknown-linux-musl<span class="o">]</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="nv">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;aarch64-linux-musl-ld&quot;</span>
</span></code></pre></div></td></tr></table></div></section></section></section>
                    <section class='print-page md-section' id='section-6' heading-number='6'>
                        <h1>折腾Linux<a class='headerlink' href='#section-6' title='Permanent link'></a>
                        </h1>
                    
                    <section class='print-page md-section' id='section-6-1' heading-number='6.1'>
                        <h1>通用Linux<a class='headerlink' href='#section-6-1' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90" heading-number="6.1.1"><nav class='md-tags'><span class='md-tag'>Linux</span></nav><h1 id="linux-yum">Linux 下载 yum 源<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-linux-yum" title="Permanent link">&para;</a></h1>
<h2 id="%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-1-reposync">1. 使用 reposync 下载<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-1-reposync" title="Permanent link">&para;</a></h2>
<p>先创建 yum 源配置文件：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-__codelineno-0-19">19</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-__codelineno-0-20">20</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-__codelineno-0-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>cat<span class="w"> </span>&gt;<span class="w"> </span>kylin10-x86.repo<span class="w"> </span><span class="s">&lt;&lt;-&#39;EOF&#39;</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="s">###Kylin Linux Advanced Server 10 - os repo###</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="s">[ks10-adv-os]</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="s">name = Kylin Linux Advanced Server 10 - Os</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="s">baseurl = http://update.cs2c.com.cn:8080/NS/V10/V10SP1.1/os/adv/lic/base/$basearch/</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="s">gpgcheck = 0</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="s">enabled = 1</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="s">[ks10-adv-updates]</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="s">name = Kylin Linux Advanced Server 10 - Updates</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="s">baseurl = http://update.cs2c.com.cn:8080/NS/V10/V10SP1.1/os/adv/lic/updates/$basearch/</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="s">gpgcheck = 0</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="s">enabled = 1</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15"></a>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="s">[ks10-adv-addons]</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="s">name = Kylin Linux Advanced Server 10 - Addons</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="s">baseurl = http://update.cs2c.com.cn:8080/NS/V10/V10SP1.1/os/adv/lic/addons/$basearch/</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="s">gpgcheck = 0</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="s">enabled = 0</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="s">EOF</span>
</span></code></pre></div></td></tr></table></div>
<p>下载到 <code>/mnt/kylin10-x86</code> ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>dnf reposync -c kylin10-x86.repo -p /mnt/kylin10-x86 --repo ks10-adv-os,ks10-adv-updates --arch=x86_64,noarch
</span></code></pre></div></td></tr></table></div>
<p>在下 x86 的 yum 源时推荐加 <code>--arch=x86_64,noarch</code> 防止下载到 32 位的包，如果是 arm 则需要加 <code>--arch=aarch64,noarch</code> 。</p>
<h2 id="%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-2-wget">2. 使用 wget 下载<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-2-wget" title="Permanent link">&para;</a></h2>
<p>也可以使用 wget 递归下载一个 YUM 源：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>wget<span class="w"> </span>-np<span class="w"> </span>-P<span class="w"> </span>.<span class="w"> </span>-r<span class="w"> </span>-R<span class="w"> </span><span class="s2">&quot;index.html*&quot;</span><span class="w"> </span>--cut-dirs<span class="o">=</span><span class="m">6</span><span class="w"> </span>https://update.cs2c.com.cn/NS/V10/V10SP1.1/os/adv/lic/updates/
</span></code></pre></div></td></tr></table></div>
<p>其中<code>--cut-dirs</code>需要根据实际的远程目录层数进行调整，下载完成后需要检查 wget 有无报错。</p>
<h2 id="%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-3">3. 参考链接<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90-3" title="Permanent link">&para;</a></h2>
<p><a href="https://rakeshjain-devops.medium.com/download-files-and-directories-from-web-using-curl-and-wget-9217bc2e34c9">https://rakeshjain-devops.medium.com/download-files-and-directories-from-web-using-curl-and-wget-9217bc2e34c9</a></p></section><section class="print-page" id="%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e6%8c%82%e8%bd%bdcifs" heading-number="6.1.2"><nav class='md-tags'><span class='md-tag'>Linux</span><span class='md-tag'>CIFS</span></nav><h1 id="linux-cifs">Linux 挂载 CIFS<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e6%8c%82%e8%bd%bdcifs-linux-cifs" title="Permanent link">&para;</a></h1>
<p>首先安装 cifs-utils，然后编辑文件<code>/etc/cifs-credentials</code>：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e6%8c%82%e8%bd%bdcifs-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e6%8c%82%e8%bd%bdcifs-__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>username=[username]
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>password=[password]
</span></code></pre></div></td></tr></table></div>
<p>修改文件权限：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e6%8c%82%e8%bd%bdcifs-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e6%8c%82%e8%bd%bdcifs-__codelineno-1-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>chmod<span class="w"> </span><span class="m">600</span><span class="w"> </span>/etc/cifs-credentials
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>chown<span class="w"> </span>root:root<span class="w"> </span>/etc/cifs-credentials
</span></code></pre></div></td></tr></table></div>
<p>在/etc/fstab 追加挂载项：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e6%8c%82%e8%bd%bdcifs-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>//[IP_address]/[share_name] /mnt/winshare cifs credentials=/etc/cifs-credentials,uid=1000,gid=1000,_netdev 0 0
</span></code></pre></div></td></tr></table></div>
<p>挂载：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e6%8c%82%e8%bd%bdcifs-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e6%8c%82%e8%bd%bdcifs-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e6%8c%82%e8%bd%bdcifs-__codelineno-3-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>/mnt/winshare
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>systemctl<span class="w"> </span>daemon-reload
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a>mount<span class="w"> </span>-a
</span></code></pre></div></td></tr></table></div></section><section class="print-page" id="%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20lvm%e8%b8%a2pv" heading-number="6.1.3"><nav class='md-tags'><span class='md-tag'>Linux</span></nav><h1 id="linux-lvm-pv">Linux LVM 踢 PV<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20lvm%e8%b8%a2pv-linux-lvm-pv" title="Permanent link">&para;</a></h1>
<p>lv_ubuntu 由 <code>/dev/sdb</code> 和 <code>/dev/sda3</code> 两个 pv 组成，其中部分数据写在了 <code>/dev/sdb</code> ，如果想把 <code>/dev/sdb</code> 踢盘，需要先进行如下操作：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20lvm%e8%b8%a2pv-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>pvmove /dev/sdb /dev/sda3
</span></code></pre></div></td></tr></table></div>
<p>将 <code>/dev/sdb</code> 这个 PV 里的 PE 迁移到 <code>/dev/sda3</code> 上，之后踢盘：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20lvm%e8%b8%a2pv-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>vgreduce ubuntu-vg /dev/sdb
</span></code></pre></div></td></tr></table></div></section><section class="print-page" id="%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e5%b0%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e7%a3%81%e7%9b%98%e5%88%86%e5%8c%ba%e6%89%a9%e5%ae%b9%e5%88%b0%e6%9c%80%e5%a4%a7" heading-number="6.1.4"><h1 id="%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e5%b0%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e7%a3%81%e7%9b%98%e5%88%86%e5%8c%ba%e6%89%a9%e5%ae%b9%e5%88%b0%e6%9c%80%e5%a4%a7-linux">Linux 将最后一个磁盘分区扩容到最大<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e5%b0%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e7%a3%81%e7%9b%98%e5%88%86%e5%8c%ba%e6%89%a9%e5%ae%b9%e5%88%b0%e6%9c%80%e5%a4%a7-linux" title="Permanent link">&para;</a></h1>
<p>在扩容 Linux 的系统盘后， <code>/dev/sda</code> 后部有大量空闲空间没有使用，需要将其纳入最后一个磁盘分区中。</p>
<h2 id="%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e5%b0%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e7%a3%81%e7%9b%98%e5%88%86%e5%8c%ba%e6%89%a9%e5%ae%b9%e5%88%b0%e6%9c%80%e5%a4%a7-1">1. 检查路由表<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e5%b0%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e7%a3%81%e7%9b%98%e5%88%86%e5%8c%ba%e6%89%a9%e5%ae%b9%e5%88%b0%e6%9c%80%e5%a4%a7-1" title="Permanent link">&para;</a></h2>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e5%b0%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e7%a3%81%e7%9b%98%e5%88%86%e5%8c%ba%e6%89%a9%e5%ae%b9%e5%88%b0%e6%9c%80%e5%a4%a7-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>parted -s -a opt /dev/sda &quot;print free&quot;
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e5%b0%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e7%a3%81%e7%9b%98%e5%88%86%e5%8c%ba%e6%89%a9%e5%ae%b9%e5%88%b0%e6%9c%80%e5%a4%a7-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e5%b0%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e7%a3%81%e7%9b%98%e5%88%86%e5%8c%ba%e6%89%a9%e5%ae%b9%e5%88%b0%e6%9c%80%e5%a4%a7-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e5%b0%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e7%a3%81%e7%9b%98%e5%88%86%e5%8c%ba%e6%89%a9%e5%ae%b9%e5%88%b0%e6%9c%80%e5%a4%a7-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e5%b0%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e7%a3%81%e7%9b%98%e5%88%86%e5%8c%ba%e6%89%a9%e5%ae%b9%e5%88%b0%e6%9c%80%e5%a4%a7-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e5%b0%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e7%a3%81%e7%9b%98%e5%88%86%e5%8c%ba%e6%89%a9%e5%ae%b9%e5%88%b0%e6%9c%80%e5%a4%a7-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e5%b0%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e7%a3%81%e7%9b%98%e5%88%86%e5%8c%ba%e6%89%a9%e5%ae%b9%e5%88%b0%e6%9c%80%e5%a4%a7-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e5%b0%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e7%a3%81%e7%9b%98%e5%88%86%e5%8c%ba%e6%89%a9%e5%ae%b9%e5%88%b0%e6%9c%80%e5%a4%a7-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e5%b0%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e7%a3%81%e7%9b%98%e5%88%86%e5%8c%ba%e6%89%a9%e5%ae%b9%e5%88%b0%e6%9c%80%e5%a4%a7-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e5%b0%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e7%a3%81%e7%9b%98%e5%88%86%e5%8c%ba%e6%89%a9%e5%ae%b9%e5%88%b0%e6%9c%80%e5%a4%a7-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e5%b0%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e7%a3%81%e7%9b%98%e5%88%86%e5%8c%ba%e6%89%a9%e5%ae%b9%e5%88%b0%e6%9c%80%e5%a4%a7-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e5%b0%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e7%a3%81%e7%9b%98%e5%88%86%e5%8c%ba%e6%89%a9%e5%ae%b9%e5%88%b0%e6%9c%80%e5%a4%a7-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e5%b0%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e7%a3%81%e7%9b%98%e5%88%86%e5%8c%ba%e6%89%a9%e5%ae%b9%e5%88%b0%e6%9c%80%e5%a4%a7-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e5%b0%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e7%a3%81%e7%9b%98%e5%88%86%e5%8c%ba%e6%89%a9%e5%ae%b9%e5%88%b0%e6%9c%80%e5%a4%a7-__codelineno-1-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>Warning: Not all of the space available to /dev/sda appears to be used, you can fix the GPT to use all of the space (an extra 201326592 blocks) or continue with the current setting?
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>Model: Msft Virtual Disk (scsi)
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a>Disk /dev/sda: 137GB
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a>Sector size (logical/physical): 512B/4096B
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a>Partition Table: gpt
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a>Disk Flags:
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a>Number  Start   End     Size    File system  Name  Flags
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a>        17.4kB  1049kB  1031kB  Free Space
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a> 1      1049kB  1128MB  1127MB  fat32              boot, esp
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a> 2      1128MB  3276MB  2147MB  ext4
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a> 3      3276MB  34.4GB  31.1GB
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a>        34.4GB  137GB   103GB   Free Space
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e5%b0%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e7%a3%81%e7%9b%98%e5%88%86%e5%8c%ba%e6%89%a9%e5%ae%b9%e5%88%b0%e6%9c%80%e5%a4%a7-2-3">2. 扩容第 3 个分区到磁盘末尾<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e5%b0%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e7%a3%81%e7%9b%98%e5%88%86%e5%8c%ba%e6%89%a9%e5%ae%b9%e5%88%b0%e6%9c%80%e5%a4%a7-2-3" title="Permanent link">&para;</a></h2>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e5%b0%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e7%a3%81%e7%9b%98%e5%88%86%e5%8c%ba%e6%89%a9%e5%ae%b9%e5%88%b0%e6%9c%80%e5%a4%a7-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>root@ubuntu:~# growpart /dev/sda 3
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e5%b0%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e7%a3%81%e7%9b%98%e5%88%86%e5%8c%ba%e6%89%a9%e5%ae%b9%e5%88%b0%e6%9c%80%e5%a4%a7-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>CHANGED: partition=3 start=6397952 old: size=60708864 end=67106815 new: size=262037471 end=268435422
</span></code></pre></div></td></tr></table></div></section><section class="print-page" id="%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e9%85%8d%e7%bd%aeudev%e8%a7%84%e5%88%99%e5%bf%bd%e7%95%a5%e7%a3%81%e7%9b%98" heading-number="6.1.5"><nav class='md-tags'><span class='md-tag'>Linux</span><span class='md-tag'>udev</span></nav><h1 id="linux-udev">Linux 配置 udev 规则忽略磁盘<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e9%85%8d%e7%bd%aeudev%e8%a7%84%e5%88%99%e5%bf%bd%e7%95%a5%e7%a3%81%e7%9b%98-linux-udev" title="Permanent link">&para;</a></h1>
<h2 id="%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e9%85%8d%e7%bd%aeudev%e8%a7%84%e5%88%99%e5%bf%bd%e7%95%a5%e7%a3%81%e7%9b%98-1-udev">1. 配置 udev 规则忽略磁盘<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e9%85%8d%e7%bd%aeudev%e8%a7%84%e5%88%99%e5%bf%bd%e7%95%a5%e7%a3%81%e7%9b%98-1-udev" title="Permanent link">&para;</a></h2>
<p>在安装 Proxmox VE 并使用 Clover 进行引导后，我不想在 PVE 里看到引导用的 U 盘/dev/sdd，需要配置 udev rule 来忽略引导 U 盘。首先抓取 udev 特征：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e9%85%8d%e7%bd%aeudev%e8%a7%84%e5%88%99%e5%bf%bd%e7%95%a5%e7%a3%81%e7%9b%98-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>udevadm<span class="w"> </span>info<span class="w"> </span>-a<span class="w"> </span>-n<span class="w"> </span>/dev/sdd
</span></code></pre></div></td></tr></table></div>
<p>重点关注 model 或者 vendor：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e9%85%8d%e7%bd%aeudev%e8%a7%84%e5%88%99%e5%bf%bd%e7%95%a5%e7%a3%81%e7%9b%98-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e9%85%8d%e7%bd%aeudev%e8%a7%84%e5%88%99%e5%bf%bd%e7%95%a5%e7%a3%81%e7%9b%98-__codelineno-1-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>ATTRS{model}==&quot;CHIPFANCIER     &quot;
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>ATTRS{vendor}==&quot;32G SLC &quot;
</span></code></pre></div></td></tr></table></div>
<p>然后新建文件 <code>/etc/udev/rules.d/99-hide-usb.rules</code> 如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e9%85%8d%e7%bd%aeudev%e8%a7%84%e5%88%99%e5%bf%bd%e7%95%a5%e7%a3%81%e7%9b%98-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>KERNEL==&quot;sd?&quot;, ATTRS{model}==&quot;CHIPFANCIER     &quot;, ATTRS{vendor}==&quot;32G SLC &quot;, ENV{UDISKS_IGNORE}=&quot;1&quot;, RUN+=&quot;/bin/sh -c &#39;/usr/bin/echo deleted device %k &gt;&gt; /tmp/udev.log &amp;&amp; echo 1 &gt; /sys/block/%k/device/delete&#39;&quot;
</span></code></pre></div></td></tr></table></div>
<p>使其生效：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e9%85%8d%e7%bd%aeudev%e8%a7%84%e5%88%99%e5%bf%bd%e7%95%a5%e7%a3%81%e7%9b%98-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>udevadm<span class="w"> </span>control<span class="w"> </span>--reload<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>udevadm<span class="w"> </span>trigger
</span></code></pre></div></td></tr></table></div>
<p>这个 udev rule 原理是有这个盘就删除这个盘。</p>
<h%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e9%85%8d%e7%bd%aeudev%e8%a7%84%e5%88%99%e5%bf%bd%e7%95%a5%e7%a3%81%e7%9b%98-2 id="%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e9%85%8d%e7%bd%aeudev%e8%a7%84%e5%88%99%e5%bf%bd%e7%95%a5%e7%a3%81%e7%9b%98-2">2. 参考链接<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e9%85%8d%e7%bd%aeudev%e8%a7%84%e5%88%99%e5%bf%bd%e7%95%a5%e7%a3%81%e7%9b%98-2" title="Permanent link">&para;</a></h2>
<p><a href="https://www.baeldung.com/linux/shell-run-script-usb-plugged">https://www.baeldung.com/linux/shell-run-script-usb-plugged</a></p>
<p><a href="https://askubuntu.com/questions/352836/how-can-i-tell-linux-kernel-to-completely-ignore-a-disk-as-if-it-was-not-even-co">https://askubuntu.com/questions/352836/how-can-i-tell-linux-kernel-to-completely-ignore-a-disk-as-if-it-was-not-even-co</a></p>
<p><a href="https://unix.stackexchange.com/questions/25552/making-udev-ignore-certain-devices-during-boot">https://unix.stackexchange.com/questions/25552/making-udev-ignore-certain-devices-during-boot</a></p></section><section class="print-page" id="%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-%e4%bd%bf%e7%94%a8tlog%e5%af%b9%e7%99%bb%e5%bd%95%e5%88%b0linux%e4%b8%8a%e7%9a%84%e7%94%a8%e6%88%b7%e8%bf%9b%e8%a1%8c%e5%bd%95%e5%b1%8f" heading-number="6.1.6"><nav class='md-tags'><span class='md-tag'>Linux</span><span class='md-tag'>tlog</span></nav><h1 id="tlog-linux">使用 tlog 对登录到 Linux 上的用户进行录屏<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-%e4%bd%bf%e7%94%a8tlog%e5%af%b9%e7%99%bb%e5%bd%95%e5%88%b0linux%e4%b8%8a%e7%9a%84%e7%94%a8%e6%88%b7%e8%bf%9b%e8%a1%8c%e5%bd%95%e5%b1%8f-tlog-linux" title="Permanent link">&para;</a></h1>
<h2 id="%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-%e4%bd%bf%e7%94%a8tlog%e5%af%b9%e7%99%bb%e5%bd%95%e5%88%b0linux%e4%b8%8a%e7%9a%84%e7%94%a8%e6%88%b7%e8%bf%9b%e8%a1%8c%e5%bd%95%e5%b1%8f-1">1. 项目背景<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-%e4%bd%bf%e7%94%a8tlog%e5%af%b9%e7%99%bb%e5%bd%95%e5%88%b0linux%e4%b8%8a%e7%9a%84%e7%94%a8%e6%88%b7%e8%bf%9b%e8%a1%8c%e5%bd%95%e5%b1%8f-1" title="Permanent link">&para;</a></h2>
<p>需要对 SSH 登录到 Linux 服务器上的用户进行录屏，主要有两种需求：</p>
<ol>
<li>记录自己在 Linux 上的操作。</li>
<li>如果别人做了什么蠢事，把他揪出来。</li>
</ol>
<h2 id="%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-%e4%bd%bf%e7%94%a8tlog%e5%af%b9%e7%99%bb%e5%bd%95%e5%88%b0linux%e4%b8%8a%e7%9a%84%e7%94%a8%e6%88%b7%e8%bf%9b%e8%a1%8c%e5%bd%95%e5%b1%8f-2-tlog">2. 安装 tlog<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-%e4%bd%bf%e7%94%a8tlog%e5%af%b9%e7%99%bb%e5%bd%95%e5%88%b0linux%e4%b8%8a%e7%9a%84%e7%94%a8%e6%88%b7%e8%bf%9b%e8%a1%8c%e5%bd%95%e5%b1%8f-2-tlog" title="Permanent link">&para;</a></h2>
<p>从 <a href="https://github.com/Scribery/tlog">GitHub 仓库</a> 的 Releases 页面下载 tlog 源码，之后安装依赖 （以 RHEL 8 为例）：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-%e4%bd%bf%e7%94%a8tlog%e5%af%b9%e7%99%bb%e5%bd%95%e5%88%b0linux%e4%b8%8a%e7%9a%84%e7%94%a8%e6%88%b7%e8%bf%9b%e8%a1%8c%e5%bd%95%e5%b1%8f-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>yum<span class="w"> </span>install<span class="w"> </span>gcc<span class="w"> </span>make<span class="w"> </span>m4<span class="w"> </span>json-c-devel<span class="w"> </span>systemd-devel<span class="w"> </span>libcurl-devel
</span></code></pre></div></td></tr></table></div>
<p>之后对源码进行编译安装：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-%e4%bd%bf%e7%94%a8tlog%e5%af%b9%e7%99%bb%e5%bd%95%e5%88%b0linux%e4%b8%8a%e7%9a%84%e7%94%a8%e6%88%b7%e8%bf%9b%e8%a1%8c%e5%bd%95%e5%b1%8f-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-%e4%bd%bf%e7%94%a8tlog%e5%af%b9%e7%99%bb%e5%bd%95%e5%88%b0linux%e4%b8%8a%e7%9a%84%e7%94%a8%e6%88%b7%e8%bf%9b%e8%a1%8c%e5%bd%95%e5%b1%8f-__codelineno-1-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>./configure<span class="w"> </span>--prefix<span class="o">=</span>/opt/tlog<span class="w"> </span>--sysconfdir<span class="o">=</span>/etc<span class="w"> </span>--localstatedir<span class="o">=</span>/var<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>make<span class="w"> </span>install
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-%e4%bd%bf%e7%94%a8tlog%e5%af%b9%e7%99%bb%e5%bd%95%e5%88%b0linux%e4%b8%8a%e7%9a%84%e7%94%a8%e6%88%b7%e8%bf%9b%e8%a1%8c%e5%bd%95%e5%b1%8f-3-tlog">3. 为用户启用 tlog<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-%e4%bd%bf%e7%94%a8tlog%e5%af%b9%e7%99%bb%e5%bd%95%e5%88%b0linux%e4%b8%8a%e7%9a%84%e7%94%a8%e6%88%b7%e8%bf%9b%e8%a1%8c%e5%bd%95%e5%b1%8f-3-tlog" title="Permanent link">&para;</a></h2>
<p>启用 tlog 需要修改用户登录 shell ：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-%e4%bd%bf%e7%94%a8tlog%e5%af%b9%e7%99%bb%e5%bd%95%e5%88%b0linux%e4%b8%8a%e7%9a%84%e7%94%a8%e6%88%b7%e8%bf%9b%e8%a1%8c%e5%bd%95%e5%b1%8f-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>usermod<span class="w"> </span>-s<span class="w"> </span>/opt/tlog/bin/tlog-rec-session<span class="w"> </span>hxp
</span></code></pre></div></td></tr></table></div>
<p>修改 pam 配置 <code>/etc/pam.d/sshd</code> 和 <code>/etc/pam.d/system-auth</code> ，加入：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-%e4%bd%bf%e7%94%a8tlog%e5%af%b9%e7%99%bb%e5%bd%95%e5%88%b0linux%e4%b8%8a%e7%9a%84%e7%94%a8%e6%88%b7%e8%bf%9b%e8%a1%8c%e5%bd%95%e5%b1%8f-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>session     required      pam_env.so readenv=1 envfile=/etc/locale.conf
</span></code></pre></div></td></tr></table></div>
<p>修改系统临时文件目录配置 <code>/usr/lib/tmpfiles.d/tlog.conf</code> ，加入：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-%e4%bd%bf%e7%94%a8tlog%e5%af%b9%e7%99%bb%e5%bd%95%e5%88%b0linux%e4%b8%8a%e7%9a%84%e7%94%a8%e6%88%b7%e8%bf%9b%e8%a1%8c%e5%bd%95%e5%b1%8f-__codelineno-4-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>d /var/run/tlog 1777 root root 10d
</span></code></pre></div></td></tr></table></div>
<p>创建 <code>/var/run/tlog/</code> 目录：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-%e4%bd%bf%e7%94%a8tlog%e5%af%b9%e7%99%bb%e5%bd%95%e5%88%b0linux%e4%b8%8a%e7%9a%84%e7%94%a8%e6%88%b7%e8%bf%9b%e8%a1%8c%e5%bd%95%e5%b1%8f-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-%e4%bd%bf%e7%94%a8tlog%e5%af%b9%e7%99%bb%e5%bd%95%e5%88%b0linux%e4%b8%8a%e7%9a%84%e7%94%a8%e6%88%b7%e8%bf%9b%e8%a1%8c%e5%bd%95%e5%b1%8f-__codelineno-5-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>/var/run/tlog/
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a>chmod<span class="w"> </span><span class="m">1777</span><span class="w"> </span>/var/run/tlog/
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-%e4%bd%bf%e7%94%a8tlog%e5%af%b9%e7%99%bb%e5%bd%95%e5%88%b0linux%e4%b8%8a%e7%9a%84%e7%94%a8%e6%88%b7%e8%bf%9b%e8%a1%8c%e5%bd%95%e5%b1%8f-4">4. 查看录屏<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-%e4%bd%bf%e7%94%a8tlog%e5%af%b9%e7%99%bb%e5%bd%95%e5%88%b0linux%e4%b8%8a%e7%9a%84%e7%94%a8%e6%88%b7%e8%bf%9b%e8%a1%8c%e5%bd%95%e5%b1%8f-4" title="Permanent link">&para;</a></h2>
<p>录屏会录入到 journal ，查看 journal 中用户登录记录获取 ID 后：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-%e4%bd%bf%e7%94%a8tlog%e5%af%b9%e7%99%bb%e5%bd%95%e5%88%b0linux%e4%b8%8a%e7%9a%84%e7%94%a8%e6%88%b7%e8%bf%9b%e8%a1%8c%e5%bd%95%e5%b1%8f-__codelineno-6-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a>tlog-play<span class="w"> </span>-r<span class="w"> </span>journal<span class="w"> </span>-M<span class="w"> </span><span class="nv">TLOG_REC</span><span class="o">=</span>12ca5b356065453fb50adfe57007658a-306a-26f2910<span class="w"> </span>-s<span class="w"> </span><span class="m">5</span>
</span></code></pre></div></td></tr></table></div></section><section class="print-page" id="%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85" heading-number="6.1.7"><h1 id="%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-kickstart-raid">Kickstart 软 RAID 安装<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-kickstart-raid" title="Permanent link">&para;</a></h1>
<p>使用以下 <code>kickstart</code> 分区配置安装 软 RAID 1 到最小的两块硬盘的分盘脚本如下：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-19">19</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-20">20</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-21">21</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-22">22</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-23">23</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-24">24</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-25">25</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-26">26</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-27">27</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-28">28</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-29">29</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-30">30</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-31">31</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-32">32</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-33">33</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-34">34</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-35">35</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-36">36</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-0-37">37</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1"># Partition disks</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>%pre<span class="w"> </span>--interpreter<span class="o">=</span>/bin/bash
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="nb">set</span><span class="w"> </span>-x
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="c1"># Get the sizes of all /dev/sd[a-z] devices in bytes and sort them by size</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="nv">devices</span><span class="o">=</span><span class="k">$(</span>lsblk<span class="w"> </span>-dbn<span class="w"> </span>-o<span class="w"> </span>NAME,SIZE<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">&#39;^sd[a-z]&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-k2<span class="w"> </span>-n<span class="k">)</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="c1"># Extract the two smallest devices</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="nv">smallest_devices</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$devices</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">2</span><span class="k">)</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="c1"># Assign the smallest devices to variables</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="nv">smallest_1</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$smallest_devices</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span>-n<span class="w"> </span><span class="s1">&#39;1p&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="nv">smallest_2</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$smallest_devices</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span>-n<span class="w"> </span><span class="s1">&#39;2p&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="c1"># Print the results</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;The two block devices with the smallest size are:&quot;</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;/dev/</span><span class="nv">$smallest_1</span><span class="s2">&quot;</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;/dev/</span><span class="nv">$smallest_2</span><span class="s2">&quot;</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="c1"># 装软RAID到最小的2块盘上</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16"></a>cat<span class="w"> </span>&gt;/tmp/part-include<span class="w"> </span><span class="s">&lt;&lt;-EOF</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="s">    zerombr</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="s">    ignoredisk --only-use=$smallest_1,$smallest_2</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="s">    clearpart --all --initlabel --drives=$smallest_1,$smallest_2</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="s">    part raid.1583 --fstype=&quot;mdmember&quot; --ondisk=$smallest_1 --size=2050</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="s">    part raid.1590 --fstype=&quot;mdmember&quot; --ondisk=$smallest_2 --size=2050</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="s">    part raid.1254 --fstype=&quot;mdmember&quot; --ondisk=$smallest_1 --size=2050</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="s">    part raid.1261 --fstype=&quot;mdmember&quot; --ondisk=$smallest_2 --size=2050</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="s">    part raid.2055 --fstype=&quot;mdmember&quot; --ondisk=$smallest_1 --size=1 --grow</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="s">    part raid.2048 --fstype=&quot;mdmember&quot; --ondisk=$smallest_2 --size=1 --grow</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="s">    raid /boot/efi --device=boot_efi --fstype=&quot;efi&quot; --level=RAID1 --fsoptions=&quot;umask=0077,shortname=winnt&quot; raid.1583 raid.1590</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="s">    raid /boot --device=boot --fstype=&quot;xfs&quot; --level=RAID1 raid.1254 raid.1261</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="s">    raid pv.789 --device=pv00 --fstype=&quot;lvmpv&quot; --level=RAID1 raid.2055 raid.2048</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="s">    volgroup rootvg --pesize=4096 pv.789</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="s">    logvol swap --fstype=&quot;swap&quot; --size=32768 --name=lv_swap --vgname=rootvg</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="s">    logvol /home --fstype=&quot;xfs&quot; --size=20480 --name=lv_home --vgname=rootvg</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="s">    logvol /tmp --fstype=&quot;xfs&quot; --size=51200 --name=lv_tmp --vgname=rootvg</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="s">    logvol /var --fstype=&quot;xfs&quot; --size=51200 --name=lv_var --vgname=rootvg</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="s">    logvol / --fstype=&quot;xfs&quot; --size=51200 --name=lv_root --vgname=rootvg</span>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="s">EOF</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36"></a>%end
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37"></a>%include<span class="w"> </span>/tmp/part-include
</span></code></pre></div></td></tr></table></div>
<p>封装 ISO 镜像可参考以下代码：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85-__codelineno-1-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">case</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">os_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">in</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>*_ARM<span class="o">)</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">    </span>sudo<span class="w"> </span>genisoimage<span class="w"> </span>-V<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$label</span><span class="s2">&quot;</span><span class="w"> </span>-o<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BASEDIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">DISTDIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">os_type</span><span class="si">}</span><span class="s2">.</span><span class="si">${</span><span class="nv">DATE</span><span class="si">}</span><span class="s2">.iso&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">        </span>-J<span class="w"> </span>-rational-rock<span class="w"> </span>-joliet-long<span class="w"> </span>-cache-inodes<span class="w"> </span>-graft-points<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">        </span>-untranslated-filenames<span class="w"> </span>-translation-table<span class="w"> </span>-m<span class="w"> </span>repoview<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">        </span>-efi-boot-part<span class="w"> </span>-efi-boot-image<span class="w"> </span>-e<span class="w"> </span>images/efiboot.img<span class="w"> </span>-no-emul-boot<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">        </span>.
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">    </span><span class="p">;;</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a>*_X86<span class="o">)</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span>sudo<span class="w"> </span>genisoimage<span class="w"> </span>-V<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$label</span><span class="s2">&quot;</span><span class="w"> </span>-o<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BASEDIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">DISTDIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">os_type</span><span class="si">}</span><span class="s2">.</span><span class="si">${</span><span class="nv">DATE</span><span class="si">}</span><span class="s2">.iso&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">        </span>-J<span class="w"> </span>-rational-rock<span class="w"> </span>-joliet-long<span class="w"> </span>-cache-inodes<span class="w"> </span>-graft-points<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">        </span>-untranslated-filenames<span class="w"> </span>-translation-table<span class="w"> </span>-m<span class="w"> </span>repoview<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">        </span>-eltorito-boot<span class="w"> </span>isolinux/isolinux.bin<span class="w"> </span>-eltorito-catalog<span class="w"> </span>isolinux/boot.cat<span class="w"> </span>-boot-load-size<span class="w"> </span><span class="m">4</span><span class="w"> </span>-boot-info-table<span class="w"> </span>-no-emul-boot<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">        </span>-eltorito-alt-boot<span class="w"> </span>-eltorito-boot<span class="w"> </span>images/efiboot.img<span class="w"> </span>-no-emul-boot<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">        </span>.
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">    </span><span class="p">;;</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="k">esac</span>
</span></code></pre></div></td></tr></table></div></section><section class="print-page" id="%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20%e5%bc%80%e5%90%af%20otp%20%e4%ba%8c%e6%ac%a1%e8%ae%a4%e8%af%81" heading-number="6.1.8"><nav class='md-tags'><span class='md-tag'>Linux</span><span class='md-tag'>OTP</span><span class='md-tag'>google-authenticator</span></nav><h1 id="linux-otp">Linux 开启 OTP 认证<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20%e5%bc%80%e5%90%af%20otp%20%e4%ba%8c%e6%ac%a1%e8%ae%a4%e8%af%81-linux-otp" title="Permanent link">&para;</a></h1>
<h2 id="%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20%e5%bc%80%e5%90%af%20otp%20%e4%ba%8c%e6%ac%a1%e8%ae%a4%e8%af%81-1-google-authenticator">1. 安装 google-authenticator<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20%e5%bc%80%e5%90%af%20otp%20%e4%ba%8c%e6%ac%a1%e8%ae%a4%e8%af%81-1-google-authenticator" title="Permanent link">&para;</a></h2>
<p>CentOS 运行：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20%e5%bc%80%e5%90%af%20otp%20%e4%ba%8c%e6%ac%a1%e8%ae%a4%e8%af%81-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20%e5%bc%80%e5%90%af%20otp%20%e4%ba%8c%e6%ac%a1%e8%ae%a4%e8%af%81-__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>sudo<span class="w"> </span>yum<span class="w"> </span>install<span class="w"> </span>epel-release
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>google-authenticator<span class="w"> </span>qrencode<span class="w"> </span>qrencode-libs
</span></code></pre></div></td></tr></table></div>
<h%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20%e5%bc%80%e5%90%af%20otp%20%e4%ba%8c%e6%ac%a1%e8%ae%a4%e8%af%81-2 id="%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20%e5%bc%80%e5%90%af%20otp%20%e4%ba%8c%e6%ac%a1%e8%ae%a4%e8%af%81-2">2. 配置令牌<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20%e5%bc%80%e5%90%af%20otp%20%e4%ba%8c%e6%ac%a1%e8%ae%a4%e8%af%81-2" title="Permanent link">&para;</a></h2>
<p>直接使用 google-authenticator 配置（此处配置的是当前用户令牌）：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20%e5%bc%80%e5%90%af%20otp%20%e4%ba%8c%e6%ac%a1%e8%ae%a4%e8%af%81-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>google-authenticator
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20%e5%bc%80%e5%90%af%20otp%20%e4%ba%8c%e6%ac%a1%e8%ae%a4%e8%af%81-3-pam">3. 配置 PAM<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20%e5%bc%80%e5%90%af%20otp%20%e4%ba%8c%e6%ac%a1%e8%ae%a4%e8%af%81-3-pam" title="Permanent link">&para;</a></h2>
<p>编辑 <code>/etc/pam.d/sshd</code> ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20%e5%bc%80%e5%90%af%20otp%20%e4%ba%8c%e6%ac%a1%e8%ae%a4%e8%af%81-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>auth required pam_google_authenticator.so
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20%e5%bc%80%e5%90%af%20otp%20%e4%ba%8c%e6%ac%a1%e8%ae%a4%e8%af%81-4-sshd">4. 配置 sshd 使用二次验证<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20%e5%bc%80%e5%90%af%20otp%20%e4%ba%8c%e6%ac%a1%e8%ae%a4%e8%af%81-4-sshd" title="Permanent link">&para;</a></h2>
<p>修改 <code>/etc/ssh/sshd_config</code> 配置，加入：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20%e5%bc%80%e5%90%af%20otp%20%e4%ba%8c%e6%ac%a1%e8%ae%a4%e8%af%81-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>AuthenticationMethods publickey,keyboard-interactive
</span></code></pre></div></td></tr></table></div>
<p>找到 <code>/etc/ssh/sshd_config.d/50-redhat.conf</code> 并注释以下行：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20%e5%bc%80%e5%90%af%20otp%20%e4%ba%8c%e6%ac%a1%e8%ae%a4%e8%af%81-__codelineno-4-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>ChallengeResponseAuthentication no
</span></code></pre></div></td></tr></table></div>
<p>检查配置无误后重启 sshd 服务：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20%e5%bc%80%e5%90%af%20otp%20%e4%ba%8c%e6%ac%a1%e8%ae%a4%e8%af%81-__codelineno-5-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>sudo<span class="w"> </span>sshd<span class="w"> </span>-t<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>sshd
</span></code></pre></div></td></tr></table></div>
<p>此时 SSH 登录会变成需要公钥、密码和二次认证码，如果要求只要公钥和二次认证码，找到 <code>/etc/pam.d/sshd</code> 并注释：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20%e5%bc%80%e5%90%af%20otp%20%e4%ba%8c%e6%ac%a1%e8%ae%a4%e8%af%81-__codelineno-6-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a>auth       substack     password-auth
</span></code></pre></div></td></tr></table></div></section></section>
                    <section class='print-page md-section' id='section-6-2' heading-number='6.2'>
                        <h1>Gentoo<a class='headerlink' href='#section-6-2' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo" heading-number="6.2.1"><nav class='md-tags'><span class='md-tag'>Gentoo</span><span class='md-tag'>Linux</span></nav><h1 id="qemu-gentoo">在 QEMU 环境安装 Gentoo<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-qemu-gentoo" title="Permanent link">&para;</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>本次 Gentoo 安装将会安装在 BIOS 模式启动的 QEMU 虚拟机上，其中 init 方式选择传统的 openrc 而非 systemd 。</p>
</div>
<h2 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-1">1. 准备工作<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-1" title="Permanent link">&para;</a></h2>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-11">1.1 下载安装介质<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-11" title="Permanent link">&para;</a></h3>
<p>去 <a href="https://www.gentoo.org/downloads/">Gentoo 下载官网</a> ，下载 Boot Media 和 Stage Archive：</p>
<p><img alt="" src="%E6%8A%98%E8%85%BELinux/Gentoo/images/Gentoo%E5%AE%89%E8%A3%85_%E4%B8%8B%E8%BD%BD%E4%BB%8B%E8%B4%A8.png" /></p>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-12">1.2 发放虚拟机<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-12" title="Permanent link">&para;</a></h3>
<p>发放满足如下要求的虚拟机：</p>
<ul>
<li>启动方式：BIOS</li>
<li>磁盘大小：64GB</li>
<li>CD-ROM：刚刚下载的 Boot Media ISO 文件</li>
<li>Secure Boot：关闭</li>
<li>QEMU Guest Agent：开启</li>
</ul>
<p>发放完成后，从 CD-ROM 启动并引导进入系统。</p>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-13-ssh">1.3 连接网络并启动 SSH 服务<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-13-ssh" title="Permanent link">&para;</a></h3>
<p>使用静态 IP 地址的方式配置网络，使用 <code>ip a</code> 命令查询到当前环境网卡名称为 <code>enp0s18</code> ，之后使用命令 <code>net-setup enp0s18</code> 命令配置网络，本次 IP 地址暂时配置为 <code>192.168.100.200</code> （跟着 TUI 界面指引一步步配置即可）。</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>如果配置完成后网络不通，需要用 <code>ip r</code> 命令检查路由表是否正确，如果不正确需要添加如下路由：
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>ip route add 192.168.100.0/24 dev enp0s18
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>ip route add default via 192.168.100.1
</span></code></pre></div></td></tr></table></div>
用以下命令重启网卡：
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-1-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>ifconfig enp0s18 down
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>ifconfig enp0s18 up
</span></code></pre></div></td></tr></table></div></p>
</div>
<p>之后使用 <code>passwd</code> 命令设置临时 root 密码，使用 <code>rc-service sshd start</code> 命令启动 SSH 服务，后续通过 SSH 远程连接来继续安装。</p>
<h%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-2 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-2">2. 磁盘分区格式化<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-2" title="Permanent link">&para;</a></h2>
<p>参考 <a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Disks">官方手册</a> 的 "Partitioning the disk with MBR for BIOS / legacy boot" 进行分区（不创建 swap 分区）：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-21">21</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-22">22</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-23">23</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-24">24</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-25">25</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-26">26</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-27">27</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-28">28</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-29">29</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-30">30</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-31">31</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-32">32</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-33">33</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-34">34</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-35">35</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-36">36</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-37">37</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-38">38</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-39">39</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-40">40</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-41">41</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-42">42</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-43">43</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-44">44</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-45">45</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-46">46</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-47">47</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-48">48</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-49">49</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-50">50</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-51">51</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-52">52</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-53">53</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-54">54</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-55">55</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-56">56</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>livecd ~ # fdisk /dev/vda
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a>Welcome to fdisk (util-linux 2.39.3).
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a>Changes will remain in memory only, until you decide to write them.
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a>Be careful before using the write command.
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a>Device does not contain a recognized partition table.
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a>Created a new DOS (MBR) disklabel with disk identifier 0x043cf7fb.
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10"></a>Command (m for help): o
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11"></a>Created a new DOS (MBR) disklabel with disk identifier 0x76a86e99.
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12"></a>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13"></a>Command (m for help): n
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14"></a>Partition type
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15"></a>   p   primary (0 primary, 0 extended, 4 free)
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16"></a>   e   extended (container for logical partitions)
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17"></a>Select (default p): p
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18"></a>Partition number (1-4, default 1):
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19"></a>First sector (2048-134217727, default 2048):
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20"></a>Last sector, +/-sectors or +/-size{K,M,G,T,P} (2048-134217727, default 134217727): +1G
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21"></a>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22"></a>Created a new partition 1 of type &#39;Linux&#39; and of size 1 GiB.
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23"></a>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24"></a>Command (m for help): a
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25"></a>Selected partition 1
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26"></a>The bootable flag on partition 1 is enabled now.
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27"></a>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28"></a>Command (m for help): n
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29"></a>Partition type
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30"></a>   p   primary (1 primary, 0 extended, 3 free)
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31"></a>   e   extended (container for logical partitions)
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32"></a>Select (default p):
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33"></a>
</span><span id="__span-2-34"><a id="__codelineno-2-34" name="__codelineno-2-34"></a>Using default response p.
</span><span id="__span-2-35"><a id="__codelineno-2-35" name="__codelineno-2-35"></a>Partition number (2-4, default 2):
</span><span id="__span-2-36"><a id="__codelineno-2-36" name="__codelineno-2-36"></a>First sector (2099200-134217727, default 2099200):
</span><span id="__span-2-37"><a id="__codelineno-2-37" name="__codelineno-2-37"></a>Last sector, +/-sectors or +/-size{K,M,G,T,P} (2099200-134217727, default 134217727):
</span><span id="__span-2-38"><a id="__codelineno-2-38" name="__codelineno-2-38"></a>
</span><span id="__span-2-39"><a id="__codelineno-2-39" name="__codelineno-2-39"></a>Created a new partition 2 of type &#39;Linux&#39; and of size 63 GiB.
</span><span id="__span-2-40"><a id="__codelineno-2-40" name="__codelineno-2-40"></a>
</span><span id="__span-2-41"><a id="__codelineno-2-41" name="__codelineno-2-41"></a>Command (m for help): p
</span><span id="__span-2-42"><a id="__codelineno-2-42" name="__codelineno-2-42"></a>Disk /dev/vda: 64 GiB, 68719476736 bytes, 134217728 sectors
</span><span id="__span-2-43"><a id="__codelineno-2-43" name="__codelineno-2-43"></a>Units: sectors of 1 * 512 = 512 bytes
</span><span id="__span-2-44"><a id="__codelineno-2-44" name="__codelineno-2-44"></a>Sector size (logical/physical): 512 bytes / 512 bytes
</span><span id="__span-2-45"><a id="__codelineno-2-45" name="__codelineno-2-45"></a>I/O size (minimum/optimal): 512 bytes / 512 bytes
</span><span id="__span-2-46"><a id="__codelineno-2-46" name="__codelineno-2-46"></a>Disklabel type: dos
</span><span id="__span-2-47"><a id="__codelineno-2-47" name="__codelineno-2-47"></a>Disk identifier: 0x76a86e99
</span><span id="__span-2-48"><a id="__codelineno-2-48" name="__codelineno-2-48"></a>
</span><span id="__span-2-49"><a id="__codelineno-2-49" name="__codelineno-2-49"></a>Device     Boot   Start       End   Sectors Size Id Type
</span><span id="__span-2-50"><a id="__codelineno-2-50" name="__codelineno-2-50"></a>/dev/vda1  *       2048   2099199   2097152   1G 83 Linux
</span><span id="__span-2-51"><a id="__codelineno-2-51" name="__codelineno-2-51"></a>/dev/vda2       2099200 134217727 132118528  63G 83 Linux
</span><span id="__span-2-52"><a id="__codelineno-2-52" name="__codelineno-2-52"></a>
</span><span id="__span-2-53"><a id="__codelineno-2-53" name="__codelineno-2-53"></a>Command (m for help): w
</span><span id="__span-2-54"><a id="__codelineno-2-54" name="__codelineno-2-54"></a>The partition table has been altered.
</span><span id="__span-2-55"><a id="__codelineno-2-55" name="__codelineno-2-55"></a>Calling ioctl() to re-read partition table.
</span><span id="__span-2-56"><a id="__codelineno-2-56" name="__codelineno-2-56"></a>Syncing disks.
</span></code></pre></div></td></tr></table></div>
<p>格式化并挂载文件系统：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-3-3">3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-3-4">4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-3-5">5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-3-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>mkfs.xfs /dev/vda1
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>mkfs.xfs /dev/vda2
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a>mkdir --parents /mnt/gentoo
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a>mount /dev/vda2 /mnt/gentoo
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a>mkdir --parents /mnt/gentoo/boot
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a>mount /dev/vda1 /mnt/gentoo/boot
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-3-stage">3. 解压 stage 文件<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-3-stage" title="Permanent link">&para;</a></h2>
<p>先将 stage 文件放在家目录下，然后解压：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-4-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>cd /mnt/gentoo/
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a>tar xpvf ~/stage3-*.tar.xz --xattrs-include=&#39;*.*&#39; --numeric-owner
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-4">4. 同步时间<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-4" title="Permanent link">&para;</a></h2>
<p>最好在安装前用 <code>chronyd</code> 命令同步下时间，避免日后下载东西报错：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-5-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>chronyd -q
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-5">5. 默认配置修改<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-5" title="Permanent link">&para;</a></h2>
<p>修改 <code>/mnt/gentoo/etc/portage/make.conf</code> 中以下一行：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-6-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a>COMMON_FLAGS=&quot;-march=native -O2 -pipe&quot;
</span></code></pre></div></td></tr></table></div>
<p>修改之后编译安装所有软件会根据机器自己的指令集编译。</p>
<h2 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-6-base-system">6. 安装 base system<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-6-base-system" title="Permanent link">&para;</a></h2>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-61-dns">6.1 复制 DNS 服务器信息到新系统<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-61-dns" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-7-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a>cp --dereference /etc/resolv.conf /mnt/gentoo/etc/
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-62">6.2 挂载文件系统<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-62" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-8-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-8-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-8-3">3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-8-4">4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-8-5">5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-8-6">6</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-8-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a>mount --types proc /proc /mnt/gentoo/proc
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a>mount --rbind /sys /mnt/gentoo/sys
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a>mount --make-rslave /mnt/gentoo/sys
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a>mount --rbind /dev /mnt/gentoo/dev
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5"></a>mount --make-rslave /mnt/gentoo/dev
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6"></a>mount --bind /run /mnt/gentoo/run
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7"></a>mount --make-slave /mnt/gentoo/run
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-63-chroot">6.3 chroot 进入新系统<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-63-chroot" title="Permanent link">&para;</a></h3>
<p>挂载文件系统后， chroot 进入新系统：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-9-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a>chroot /mnt/gentoo /bin/bash
</span></code></pre></div></td></tr></table></div>
<p>chroot 之后需要 source 下 profile：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-10-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-10-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a>source /etc/profile
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a>export PS1=&quot;(chroot) ${PS1}&quot;
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-64-portage">6.4 配置 portage<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-64-portage" title="Permanent link">&para;</a></h3>
<p>创建配置文件：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-11-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-11-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a>mkdir --parents /etc/portage/repos.conf
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2"></a>cp /usr/share/portage/config/repos.conf /etc/portage/repos.conf/gentoo.conf
</span></code></pre></div></td></tr></table></div>
<p>为了加快下载速度，需要配置镜像，修改 <code>/etc/portage/repos.conf/gentoo.conf</code> ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-12-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a>sync-uri = rsync://mirrors.tuna.tsinghua.edu.cn/gentoo-portage
</span></code></pre></div></td></tr></table></div>
<p>在 <code>/etc/portage/make.conf</code> 中加入：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-13-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a>GENTOO_MIRRORS=&quot;https://mirrors.tuna.tsinghua.edu.cn/gentoo&quot;
</span></code></pre></div></td></tr></table></div>
<p>更新仓库：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-14-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-14-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a>emerge-webrsync
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2"></a>emerge --sync
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-65">6.5 更新所有软件包<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-65" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-15-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1"></a>emerge --ask --verbose --update --deep --newuse @world
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-7">7. 本地化配置<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-7" title="Permanent link">&para;</a></h2>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-71">7.1 设置时区<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-71" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-16-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-16-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1"></a>echo &quot;Asia/Shanghai&quot; &gt; /etc/timezone
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2"></a>emerge --config sys-libs/timezone-data
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-72-locale">7.2 设置 locale<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-72-locale" title="Permanent link">&para;</a></h3>
<p>在 <code>/etc/locale.gen</code> 中对需要的 locale 取消注释，然后重新生成 locale ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-17-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1"></a>locale-gen
</span></code></pre></div></td></tr></table></div>
<p>设置默认 locale ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-18-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1"></a>eselect locale list
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-19-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-19-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-19-3">3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-19-4">4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-19-5">5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-19-6">6</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-19-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1"></a>Available targets for the LANG variable:
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2"></a>  [1]   C
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3"></a>  [2]   C.utf8
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4"></a>  [3]   POSIX
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5"></a>  [4]   en_US.utf8
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6"></a>  [5]   C.UTF8 *
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7"></a>  [ ]   (free form)
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-20-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1"></a>eselect locale set 4
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-21-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-21-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1"></a>Setting LANG to en_US.utf8 ...
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2"></a>Run &quot;. /etc/profile&quot; to update the variable in your shell.
</span></code></pre></div></td></tr></table></div>
<p>重新加载 profile ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-22-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1"></a>env-update &amp;&amp; source /etc/profile &amp;&amp; export PS1=&quot;(chroot) ${PS1}&quot;
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-8">8. 编译并安装内核<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-8" title="Permanent link">&para;</a></h2>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-81">8.1 下载内核源码<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-81" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-23-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1"></a>emerge --ask sys-kernel/installkernel sys-kernel/gentoo-sources
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-82">8.2 选择内核源码<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-82" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-24-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1"></a>eselect kernel list
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-25-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-25-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1"></a>Available kernel symlink targets:
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2"></a>  [1]   linux-6.6.21-gentoo
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-26-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1"></a>eselect kernel set 1
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-83-genkernel">8.3 安装 genkernel<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-83-genkernel" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-27-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-27-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-27-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1"></a>mkdir -p /etc/portage/package.license
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2"></a>echo &#39;sys-kernel/linux-firmware @BINARY-REDISTRIBUTABLE&#39; &gt; /etc/portage/package.license/linux-firmware
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3"></a>emerge --ask sys-kernel/genkernel
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-84">8.4 编译内核<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-84" title="Permanent link">&para;</a></h3>
<p>用 genkernel 生成并自动安装内核：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-28-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1"></a>genkernel --mountboot --install all --menuconfig
</span></code></pre></div></td></tr></table></div>
<p>注意，在弹出的界面中，需要额外配置这几项来将相关驱动编译进内核：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-29-1"> 1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-29-2"> 2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-29-3"> 3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-29-4"> 4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-29-5"> 5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-29-6"> 6</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-29-7"> 7</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-29-8"> 8</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-29-9"> 9</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-29-10">10</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-29-11">11</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-29-12">12</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-29-13">13</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-29-14">14</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-29-15">15</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-29-16">16</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-29-17">17</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-29-18">18</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-29-19">19</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-29-20">20</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-29-21">21</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-29-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1"></a>Processor type and features  ---&gt;
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2"></a>    [*] Linux guest support ---&gt;
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3"></a>        [*] Enable Paravirtualization code
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4"></a>        [*] KVM Guest support (including kvmclock)
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5"></a>Device Drivers  ---&gt;
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6"></a>    [*] Virtio drivers  ---&gt;
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7"></a>        &lt;*&gt; PCI driver for virtio devices
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8"></a>    [*] Block devices  ---&gt;
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9"></a>        &lt;*&gt; Virtio block driver
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10"></a>    SCSI device support  ---&gt;
</span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11"></a>        [*] SCSI low-level drivers  ---&gt;
</span><span id="__span-29-12"><a id="__codelineno-29-12" name="__codelineno-29-12"></a>            [*] virtio-scsi support
</span><span id="__span-29-13"><a id="__codelineno-29-13" name="__codelineno-29-13"></a>    [*] Network device support  ---&gt;
</span><span id="__span-29-14"><a id="__codelineno-29-14" name="__codelineno-29-14"></a>        [*] Network core driver support
</span><span id="__span-29-15"><a id="__codelineno-29-15" name="__codelineno-29-15"></a>            &lt;*&gt; Virtio network driver
</span><span id="__span-29-16"><a id="__codelineno-29-16" name="__codelineno-29-16"></a>    Graphics support  ---&gt;
</span><span id="__span-29-17"><a id="__codelineno-29-17" name="__codelineno-29-17"></a>        &lt;*&gt; Direct Rendering Manager (XFree86 4.1.0 and higher DRI support)  ---&gt;
</span><span id="__span-29-18"><a id="__codelineno-29-18" name="__codelineno-29-18"></a>        &lt;*&gt; Virtio GPU driver
</span><span id="__span-29-19"><a id="__codelineno-29-19" name="__codelineno-29-19"></a>    Character devices ---&gt;
</span><span id="__span-29-20"><a id="__codelineno-29-20" name="__codelineno-29-20"></a>       &lt;*&gt; Hardware Random Number Generator Core support ---&gt;
</span><span id="__span-29-21"><a id="__codelineno-29-21" name="__codelineno-29-21"></a>           &lt;*&gt; VirtIO Random Number Generator support
</span><span id="__span-29-22"><a id="__codelineno-29-22" name="__codelineno-29-22"></a>       &lt;*&gt; Virtio console
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-85-qemu">8.5 安装 QEMU 虚拟机相关软件<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-85-qemu" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-30-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-30-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-30-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1"></a>emerge --ask sys-power/acpid app-emulation/qemu-guest-agent
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2"></a>rc-update add acpid default
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3"></a>rc-update add qemu-guest-agent default
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-9">9. 安装后配置<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-9" title="Permanent link">&para;</a></h2>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-91-fstab">9.1 配置 fstab<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-91-fstab" title="Permanent link">&para;</a></h3>
<p>编辑 <code>/etc/fstab</code>：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-31-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-31-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1"></a>/dev/vda1 /boot xfs defaults  0 2
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2"></a>/dev/vda2 / xfs defaults  0 0
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-92">9.2 配置主机名<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-92" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-32-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1"></a>echo gentoo &gt; /etc/hostname
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-93">9.3 安装必要的软件<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-93" title="Permanent link">&para;</a></h3>
<p>安装 dhcpcd 来为 DHCP 提供支持:</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-33-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-33-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-33-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1"></a>emerge --ask net-misc/dhcpcd
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2"></a>rc-update add dhcpcd default
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3"></a>rc-service dhcpcd start
</span></code></pre></div></td></tr></table></div>
<p>安装 netifrc 来管理网络：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-34-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1"></a>emerge --ask --noreplace net-misc/netifrc
</span></code></pre></div></td></tr></table></div>
<p>安装 system logger 、 chrony 等基础软件：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-35-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-35-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-35-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1"></a>emerge --ask app-admin/sysklogd sys-process/cronie sys-apps/mlocate net-misc/chrony app-shells/bash-completion sys-fs/xfsprogs sys-block/io-scheduler-udev-rules
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2"></a>rc-update add sysklogd default
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3"></a>rc-update add chronyd default
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-94-bootloader">9.4 安装 bootloader<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-94-bootloader" title="Permanent link">&para;</a></h3>
<p>安装 grub 软件包：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-36-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-36-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1"></a>echo &#39;GRUB_PLATFORMS=&quot;pc&quot;&#39; &gt;&gt; /etc/portage/make.conf
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2"></a>emerge --ask --verbose sys-boot/grub
</span></code></pre></div></td></tr></table></div>
<p>配置 grub ，修改 <code>/etc/default/grub</code> ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-37-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-37-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1"></a>GRUB_CMDLINE_LINUX=&quot;console=tty0 console=ttyS0&quot;
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2"></a>GRUB_TERMINAL=console
</span></code></pre></div></td></tr></table></div>
<p>配置 <code>/etc/inittab</code> ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-38-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-38-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1"></a># SERIAL CONSOLES
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2"></a>s0:12345:respawn:/sbin/agetty -L 115200 ttyS0 vt100
</span></code></pre></div></td></tr></table></div>
<p>安装 grub 到硬盘头：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-39-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1"></a>grub-install /dev/vda
</span></code></pre></div></td></tr></table></div>
<p>生成 grub 启动项配置：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-40-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1"></a>grub-mkconfig -o /boot/grub/grub.cfg
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-95-root">9.5 设置 root 密码<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-95-root" title="Permanent link">&para;</a></h3>
<p>安装过程中不要忘记用 <code>passwd</code> 命令设置密码。</p>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-96">9.6 配置网络<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-96" title="Permanent link">&para;</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>部分安装场景下网卡 <code>enp0s18</code> 在进入新系统后会变成 <code>ens18</code> ，需要进行相应调整。</p>
</div>
<p>使用静态地址的方式配置网络，在 <code>/etc/conf.d/net</code> 中增加网卡配置：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-41-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-41-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1"></a>config_enp0s18=&quot;192.168.100.5 netmask 255.255.255.0 brd 192.168.100.255&quot;
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2"></a>routes_enp0s18=&quot;default via 192.168.100.1&quot;
</span></code></pre></div></td></tr></table></div>
<p>配置开机启动（如果是静态地址，需要禁用 dhcpcd 防止其自动获取 169.254 网关）：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-42-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-42-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-42-3">3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-42-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1"></a>cd /etc/init.d
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2"></a>ln -s net.lo net.enp0s18
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3"></a>rc-update del dhcpcd
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4"></a>rc-update add net.enp0s18 default
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-97-ssh">9.7 配置 SSH 开机启动<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-97-ssh" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-43-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1"></a>rc-update add sshd default
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-10">10. 安装完成并重启<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-10" title="Permanent link">&para;</a></h2>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-44-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-44-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-44-3">3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-44-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1"></a>exit
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2"></a>umount -l /mnt/gentoo/dev{/shm,/pts,}
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3"></a>umount -R /mnt/gentoo
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4"></a>reboot
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-11_1">11. 参考文献<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-11_1" title="Permanent link">&para;</a></h2>
<p><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64">https://wiki.gentoo.org/wiki/Handbook:AMD64</a></p>
<p><a href="https://wiki.gentoo.org/wiki/QEMU/Linux_guest#Kernel">https://wiki.gentoo.org/wiki/QEMU/Linux_guest#Kernel</a></p>
<p><a href="https://wiki.gentoo.org/wiki/Kernel/Configuration">https://wiki.gentoo.org/wiki/Kernel/Configuration</a></p></section><section class="print-page" id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo" heading-number="6.2.2"><nav class='md-tags'><span class='md-tag'>Gentoo</span><span class='md-tag'>Linux</span></nav><h1 id="hyper-v-gentoo">在 Hyper-V 环境安装 Gentoo<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-hyper-v-gentoo" title="Permanent link">&para;</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>本次 Gentoo 安装将会安装在 UEFI 模式启动的 Hyper-V 虚拟机上，其中 init 方式选择传统的 openrc 而非 systemd 。</p>
</div>
<h2 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-1">1. 准备工作<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-1" title="Permanent link">&para;</a></h2>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-11">1.1 下载安装介质<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-11" title="Permanent link">&para;</a></h3>
<p>去 <a href="https://www.gentoo.org/downloads/">Gentoo 下载官网</a> ，下载 Boot Media 和 Stage Archive：</p>
<p><img alt="" src="%E6%8A%98%E8%85%BELinux/Gentoo/images/Gentoo%E5%AE%89%E8%A3%85_%E4%B8%8B%E8%BD%BD%E4%BB%8B%E8%B4%A8.png" /></p>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-12">1.2 发放虚拟机<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-12" title="Permanent link">&para;</a></h3>
<p>发放满足如下要求的虚拟机：</p>
<ul>
<li>虚拟机代数：第 2 代 （UEFI 启动）</li>
<li>磁盘大小：64GB</li>
<li>CD-ROM：刚刚下载的 Boot Media ISO 文件</li>
<li>Secure Boot：关闭</li>
</ul>
<p>发放完成后，从 CD-ROM 启动并引导进入系统。</p>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-13-ssh">1.3 连接网络并启动 SSH 服务<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-13-ssh" title="Permanent link">&para;</a></h3>
<p>使用静态 IP 地址的方式配置网络，使用 <code>ip a</code> 命令查询到当前环境网卡名称为 <code>eth0</code> ，之后使用命令 <code>net-setup eth0</code> 命令配置网络，一路回车即使用 DHCP 模式。之后使用 <code>ifconfig</code> 命令查看 DHCP 获得的 IP 地址。</p>
<p>之后使用 <code>passwd</code> 命令设置临时 root 密码，使用 <code>rc-service sshd start</code> 命令启动 SSH 服务，后续通过 SSH 远程连接来继续安装。</p>
<h%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-2 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-2">2. 磁盘分区格式化<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-2" title="Permanent link">&para;</a></h2>
<p>使用 <code>fdisk</code> 对硬盘进行分区，分区表格式为 GPT ，此次使用的分区表如下：</p>
<table>
<thead>
<tr>
<th>分区名称</th>
<th>分区大小</th>
<th>文件系统</th>
<th>挂载点</th>
</tr>
</thead>
<tbody>
<tr>
<td>/dev/sda1</td>
<td>1G</td>
<td>ext4</td>
<td>/boot</td>
</tr>
<tr>
<td>/dev/sda2</td>
<td>256M</td>
<td>vfat</td>
<td>/boot/efi</td>
</tr>
<tr>
<td>/dev/sda3</td>
<td>磁盘剩余所有空间</td>
<td>ext4</td>
<td>/</td>
</tr>
</tbody>
</table>
<p>格式化磁盘分区：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-0-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>mkfs.ext4 /dev/sda1
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>mkfs.vfat /dev/sda2
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a>mkfs.ext4 /dev/sda3
</span></code></pre></div></td></tr></table></div>
<p>挂载文件系统：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-1-4">4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-1-5">5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-1-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>mkdir --parents /mnt/gentoo
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>mount /dev/sda3 /mnt/gentoo
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a>mkdir --parents /mnt/gentoo/boot
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a>mount /dev/sda1 /mnt/gentoo/boot
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a>mkdir --parents /mnt/gentoo/boot/efi
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a>mount /dev/sda2 /mnt/gentoo/boot/efi
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-3-stage">3. 解压 stage 文件<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-3-stage" title="Permanent link">&para;</a></h2>
<p>先将 stage 文件放在家目录下，然后解压：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-2-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>cd /mnt/gentoo/
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>tar xpvf ~/stage3-*.tar.xz --xattrs-include=&#39;*.*&#39; --numeric-owner
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-4">4. 同步时间<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-4" title="Permanent link">&para;</a></h2>
<p>最好在安装前用 <code>chronyd</code> 命令同步下时间，避免日后下载东西报错：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>chronyd -q
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-5">5. 默认配置修改<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-5" title="Permanent link">&para;</a></h2>
<p>修改 <code>/mnt/gentoo/etc/portage/make.conf</code> 中以下一行：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-4-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>COMMON_FLAGS=&quot;-march=native -O2 -pipe&quot;
</span></code></pre></div></td></tr></table></div>
<p>修改之后编译安装所有软件会根据机器自己的指令集编译。</p>
<h2 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-6-base-system">6. 安装 base system<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-6-base-system" title="Permanent link">&para;</a></h2>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-61-dns">6.1 复制 DNS 服务器信息到新系统<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-61-dns" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-5-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>cp --dereference /etc/resolv.conf /mnt/gentoo/etc/
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-62">6.2 挂载文件系统<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-62" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-6-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-6-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-6-3">3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-6-4">4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-6-5">5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-6-6">6</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-6-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a>mount --types proc /proc /mnt/gentoo/proc
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a>mount --rbind /sys /mnt/gentoo/sys
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a>mount --make-rslave /mnt/gentoo/sys
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a>mount --rbind /dev /mnt/gentoo/dev
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a>mount --make-rslave /mnt/gentoo/dev
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6"></a>mount --bind /run /mnt/gentoo/run
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7"></a>mount --make-slave /mnt/gentoo/run
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-63-chroot">6.3 chroot 进入新系统<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-63-chroot" title="Permanent link">&para;</a></h3>
<p>挂载文件系统后， chroot 进入新系统：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-7-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a>chroot /mnt/gentoo /bin/bash
</span></code></pre></div></td></tr></table></div>
<p>chroot 之后需要 source 下 profile：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-8-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-8-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a>source /etc/profile
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a>export PS1=&quot;(chroot) ${PS1}&quot;
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-64-portage">6.4 配置 portage<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-64-portage" title="Permanent link">&para;</a></h3>
<p>创建配置文件：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-9-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-9-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a>mkdir --parents /etc/portage/repos.conf
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2"></a>cp /usr/share/portage/config/repos.conf /etc/portage/repos.conf/gentoo.conf
</span></code></pre></div></td></tr></table></div>
<p>为了加快下载速度，需要配置镜像，修改 <code>/etc/portage/repos.conf/gentoo.conf</code> ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-10-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a>sync-uri = rsync://mirrors.tuna.tsinghua.edu.cn/gentoo-portage
</span></code></pre></div></td></tr></table></div>
<p>在 <code>/etc/portage/make.conf</code> 中加入：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-11-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a>GENTOO_MIRRORS=&quot;https://mirrors.tuna.tsinghua.edu.cn/gentoo&quot;
</span></code></pre></div></td></tr></table></div>
<p>更新仓库：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-12-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-12-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a>emerge-webrsync
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2"></a>emerge --sync
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-65">6.5 更新所有软件包<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-65" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-13-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a>emerge --ask --verbose --update --deep --newuse @world
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-7">7. 本地化配置<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-7" title="Permanent link">&para;</a></h2>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-71">7.1 设置时区<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-71" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-14-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-14-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a>echo &quot;Asia/Shanghai&quot; &gt; /etc/timezone
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2"></a>emerge --config sys-libs/timezone-data
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-72-locale">7.2 设置 locale<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-72-locale" title="Permanent link">&para;</a></h3>
<p>在 <code>/etc/locale.gen</code> 中对需要的 locale 取消注释，然后重新生成 locale ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-15-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1"></a>locale-gen
</span></code></pre></div></td></tr></table></div>
<p>设置默认 locale ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-16-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1"></a>eselect locale list
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-17-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-17-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-17-3">3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-17-4">4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-17-5">5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-17-6">6</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-17-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1"></a>Available targets for the LANG variable:
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2"></a>  [1]   C
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3"></a>  [2]   C.utf8
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4"></a>  [3]   POSIX
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5"></a>  [4]   en_US.utf8
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6"></a>  [5]   C.UTF8 *
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7"></a>  [ ]   (free form)
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-18-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1"></a>eselect locale set 4
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-19-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-19-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1"></a>Setting LANG to en_US.utf8 ...
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2"></a>Run &quot;. /etc/profile&quot; to update the variable in your shell.
</span></code></pre></div></td></tr></table></div>
<p>重新加载 profile ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-20-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1"></a>env-update &amp;&amp; source /etc/profile &amp;&amp; export PS1=&quot;(chroot) ${PS1}&quot;
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-8">8. 编译并安装内核<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-8" title="Permanent link">&para;</a></h2>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-81">8.1 下载内核源码<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-81" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-21-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1"></a>emerge --ask sys-kernel/installkernel sys-kernel/gentoo-sources
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-82">8.2 选择内核源码<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-82" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-22-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1"></a>eselect kernel list
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-23-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-23-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1"></a>Available kernel symlink targets:
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2"></a>  [1]   linux-6.6.21-gentoo
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-24-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1"></a>eselect kernel set 1
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-83-genkernel">8.3 安装 genkernel<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-83-genkernel" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-25-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-25-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-25-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1"></a>mkdir -p /etc/portage/package.license
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2"></a>echo &#39;sys-kernel/linux-firmware @BINARY-REDISTRIBUTABLE&#39; &gt; /etc/portage/package.license/linux-firmware
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3"></a>emerge --ask sys-kernel/genkernel
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-84">8.4 编译内核<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-84" title="Permanent link">&para;</a></h3>
<p>用 genkernel 生成并自动安装内核：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-26-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1"></a>genkernel --mountboot --install all --hyperv
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-9">9. 安装后配置<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-9" title="Permanent link">&para;</a></h2>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-91-fstab">9.1 配置 fstab<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-91-fstab" title="Permanent link">&para;</a></h3>
<p>编辑 <code>/etc/fstab</code>：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-27-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-27-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-27-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1"></a>/dev/sda1 /boot ext4 defaults  0 2
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2"></a>/dev/sda2 /boot/efi vfat defaults 0 0
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3"></a>/dev/vda3 / ext4 defaults  0 0
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-92">9.2 配置主机名<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-92" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-28-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1"></a>echo gentoo &gt; /etc/hostname
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-93">9.3 安装必要的软件<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-93" title="Permanent link">&para;</a></h3>
<p>安装 dhcpcd 来为 DHCP 提供支持:</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-29-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-29-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-29-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1"></a>emerge --ask net-misc/dhcpcd
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2"></a>rc-update add dhcpcd default
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3"></a>rc-service dhcpcd start
</span></code></pre></div></td></tr></table></div>
<p>安装 netifrc 来管理网络：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-30-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1"></a>emerge --ask --noreplace net-misc/netifrc
</span></code></pre></div></td></tr></table></div>
<p>安装 system logger 、 chrony 等基础软件：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-31-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-31-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-31-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1"></a>emerge --ask app-admin/sysklogd sys-process/cronie sys-apps/mlocate net-misc/chrony app-shells/bash-completion sys-fs/xfsprogs sys-block/io-scheduler-udev-rules
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2"></a>rc-update add sysklogd default
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3"></a>rc-update add chronyd default
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-94-bootloader">9.4 安装 bootloader<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-94-bootloader" title="Permanent link">&para;</a></h3>
<p>安装 grub 软件包：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-32-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-32-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1"></a>echo &#39;GRUB_PLATFORMS=&quot;efi-64&quot;&#39; &gt;&gt; /etc/portage/make.conf
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2"></a>emerge --ask --verbose sys-boot/grub
</span></code></pre></div></td></tr></table></div>
<p>安装 grub 到硬盘头：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-33-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1"></a>grub-install --efi-directory=/boot/efi
</span></code></pre></div></td></tr></table></div>
<p>生成 grub 启动项配置：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-34-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1"></a>grub-mkconfig -o /boot/grub/grub.cfg
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-95-root">9.5 设置 root 密码<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-95-root" title="Permanent link">&para;</a></h3>
<p>安装过程中不要忘记用 <code>passwd</code> 命令设置密码。</p>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-96">9.6 配置网络<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-96" title="Permanent link">&para;</a></h3>
<p>使用 DHCP 的方式配置网络，在 <code>/etc/conf.d/net</code> 中增加网卡配置：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-35-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1"></a>config_eth0=&quot;dhcp&quot;
</span></code></pre></div></td></tr></table></div>
<p>配置开机启动（如果是静态地址，需要禁用 dhcpcd 防止其自动获取 169.254 网关）：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-36-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-36-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-36-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1"></a>cd /etc/init.d
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2"></a>ln -s net.lo net.eth0
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3"></a>rc-update add net.eth0 default
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-97-ssh">9.7 配置 SSH 开机启动<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-97-ssh" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-37-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1"></a>rc-update add sshd default
</span></code></pre></div></td></tr></table></div>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-98-ssh-root">9.8 配置 SSH 允许 root 使用密码登录<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-98-ssh-root" title="Permanent link">&para;</a></h3>
<p>修改 <code>/etc/ssh/sshd_config</code> ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-38-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1"></a>PermitRootLogin yes
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-10">10. 安装完成并重启<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-10" title="Permanent link">&para;</a></h2>
<p>退出 chroot 环境：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-39-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1"></a>exit
</span></code></pre></div></td></tr></table></div>
<p>卸载文件系统并重启：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-40-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-40-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-__codelineno-40-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1"></a>umount -l /mnt/gentoo/dev{/shm,/pts,}
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2"></a>umount -R /mnt/gentoo
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3"></a>reboot
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-11_1">11. 参考文献<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo-11_1" title="Permanent link">&para;</a></h2>
<p><a href="https://wiki.gentoo.org/wiki/Handbook:AMD64">https://wiki.gentoo.org/wiki/Handbook:AMD64</a></p>
<p><a href="https://wiki.gentoo.org/wiki/QEMU/Linux_guest#Kernel">https://wiki.gentoo.org/wiki/QEMU/Linux_guest#Kernel</a></p>
<p><a href="https://wiki.gentoo.org/wiki/Kernel/Configuration">https://wiki.gentoo.org/wiki/Kernel/Configuration</a></p></section><section class="print-page" id="%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95" heading-number="6.2.3"><nav class='md-tags'><span class='md-tag'>Gentoo</span><span class='md-tag'>Linux</span></nav><h1 id="emerge-ninja-manifest-buildninja-still-dirty-after-100-tries">emerge 装包 ninja 报错“manifest 'build.ninja' still dirty after 100 tries”解决方法<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-emerge-ninja-manifest-buildninja-still-dirty-after-100-tries" title="Permanent link">&para;</a></h1>
<p>在新系统修改编译 flag 后，重新编译系统里所有包时，运行了如下命令：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>emerge -Deuav world
</span></code></pre></div></td></tr></table></div>
<p>报错如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-23">23</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-24">24</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-25">25</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-26">26</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-27">27</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>* Messages for package net-libs/nghttp2-1.61.0:
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a> * ERROR: net-libs/nghttp2-1.61.0::gentoo failed (compile phase):
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a> *   ninja -v -j16 -l16 failed
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a> *
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a> * Call stack:
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a> *     ebuild.sh, line  136:  Called src_compile
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a> *   environment, line 2565:  Called cmake-multilib_src_compile
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a> *   environment, line  776:  Called multilib-minimal_src_compile
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a> *   environment, line 1904:  Called multilib_foreach_abi &#39;multilib-minimal_abi_src_compile&#39;
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a> *   environment, line 2171:  Called multibuild_foreach_variant &#39;_multilib_multibuild_wrapper&#39; &#39;multilib-minimal_abi_src_compile&#39;
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a> *   environment, line 1864:  Called _multibuild_run &#39;_multilib_multibuild_wrapper&#39; &#39;multilib-minimal_abi_src_compile&#39;
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a> *   environment, line 1862:  Called _multilib_multibuild_wrapper &#39;multilib-minimal_abi_src_compile&#39;
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14"></a> *   environment, line  531:  Called multilib-minimal_abi_src_compile
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15"></a> *   environment, line 1898:  Called multilib_src_compile
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16"></a> *   environment, line 2391:  Called cmake_src_compile
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17"></a> *   environment, line  894:  Called cmake_build
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18"></a> *   environment, line  861:  Called eninja
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19"></a> *   environment, line 1332:  Called die
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20"></a> * The specific snippet of code:
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21"></a> *       &quot;$@&quot; || die -n &quot;${*} failed&quot;
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22"></a> *
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23"></a> * If you need support, post the output of `emerge --info &#39;=net-libs/nghttp2-1.61.0::gentoo&#39;`,
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24"></a> * the complete build log and the output of `emerge -pqv &#39;=net-libs/nghttp2-1.61.0::gentoo&#39;`.
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25"></a> * The complete build log is located at &#39;/var/tmp/portage/net-libs/nghttp2-1.61.0/temp/build.log&#39;.
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26"></a> * The ebuild environment file is located at &#39;/var/tmp/portage/net-libs/nghttp2-1.61.0/temp/environment&#39;.
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27"></a> * Working directory: &#39;/var/tmp/portage/net-libs/nghttp2-1.61.0/work/nghttp2-1.61.0_build-abi_x86_64.amd64&#39;
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28"></a> * S: &#39;/var/tmp/portage/net-libs/nghttp2-1.61.0/work/nghttp2-1.61.0&#39;
</span></code></pre></div></td></tr></table></div>
<p>其中日志文件 <code>/var/tmp/portage/net-libs/nghttp2-1.61.0/temp/build.log</code> 报错如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-21">21</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-22">22</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-23">23</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-24">24</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-25">25</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-26">26</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>ninja: error: manifest &#39;build.ninja&#39; still dirty after 100 tries, perhaps system time is not set
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a> * ERROR: net-libs/nghttp2-1.61.0::gentoo failed (compile phase):
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a> *   ninja -v -j16 -l16 failed
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a> *
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a> * Call stack:
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a> *     ebuild.sh, line  136:  Called src_compile
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a> *   environment, line 2565:  Called cmake-multilib_src_compile
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a> *   environment, line  776:  Called multilib-minimal_src_compile
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a> *   environment, line 1904:  Called multilib_foreach_abi &#39;multilib-minimal_abi_src_compile&#39;
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10"></a> *   environment, line 2171:  Called multibuild_foreach_variant &#39;_multilib_multibuild_wrapper&#39; &#39;multilib-minimal_abi_src_compile&#39;
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11"></a> *   environment, line 1864:  Called _multibuild_run &#39;_multilib_multibuild_wrapper&#39; &#39;multilib-minimal_abi_src_compile&#39;
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12"></a> *   environment, line 1862:  Called _multilib_multibuild_wrapper &#39;multilib-minimal_abi_src_compile&#39;
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13"></a> *   environment, line  531:  Called multilib-minimal_abi_src_compile
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14"></a> *   environment, line 1898:  Called multilib_src_compile
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15"></a> *   environment, line 2391:  Called cmake_src_compile
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16"></a> *   environment, line  894:  Called cmake_build
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17"></a> *   environment, line  861:  Called eninja
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18"></a> *   environment, line 1332:  Called die
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19"></a> * The specific snippet of code:
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20"></a> *       &quot;$@&quot; || die -n &quot;${*} failed&quot;
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21"></a> *
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22"></a> * If you need support, post the output of `emerge --info &#39;=net-libs/nghttp2-1.61.0::gentoo&#39;`,
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23"></a> * the complete build log and the output of `emerge -pqv &#39;=net-libs/nghttp2-1.61.0::gentoo&#39;`.
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24"></a> * The complete build log is located at &#39;/var/tmp/portage/net-libs/nghttp2-1.61.0/temp/build.log&#39;.
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25"></a> * The ebuild environment file is located at &#39;/var/tmp/portage/net-libs/nghttp2-1.61.0/temp/environment&#39;.
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26"></a> * Working directory: &#39;/var/tmp/portage/net-libs/nghttp2-1.61.0/work/nghttp2-1.61.0_build-abi_x86_64.amd64&#39;
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27"></a> * S: &#39;/var/tmp/portage/net-libs/nghttp2-1.61.0/work/nghttp2-1.61.0&#39;
</span></code></pre></div></td></tr></table></div>
<p>报错的原因是系统刚装好进行了时间同步， ninja 编译发现有一些文件是在未来创建的。解决方法为找到所有在未来创建的文件，并将其时间戳修改为现在：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-3-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>touch currtime
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>find / -cnewer currtime -exec touch {} \;
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a>rm currtime
</span></code></pre></div></td></tr></table></div>
<p>最后单独重新编译这一个包：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-4-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>emerge -av =net-libs/nghttp2-1.61.0
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-1">1. 参考资料<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-1" title="Permanent link">&para;</a></h2>
<p><a href="https://forums.gentoo.org/viewtopic-p-8768044.html?sid=ed3fa313c3404a3db1ef5260515270ef">https://forums.gentoo.org/viewtopic-p-8768044.html?sid=ed3fa313c3404a3db1ef5260515270ef</a></p></section><section class="print-page" id="%e6%8a%98%e8%85%belinux-gentoo-gentoo%e5%90%af%e5%8a%a8%e6%97%b6%e6%8c%82%e8%bd%bdcifs%e5%a4%b1%e8%b4%a5%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95" heading-number="6.2.4"><nav class='md-tags'><span class='md-tag'>Gentoo</span><span class='md-tag'>Linux</span></nav><h1 id="gentoo-cifs">Gentoo 启动时挂载 cifs 失败解决方法<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-gentoo%e5%90%af%e5%8a%a8%e6%97%b6%e6%8c%82%e8%bd%bdcifs%e5%a4%b1%e8%b4%a5%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-gentoo-cifs" title="Permanent link">&para;</a></h1>
<h2 id="%e6%8a%98%e8%85%belinux-gentoo-gentoo%e5%90%af%e5%8a%a8%e6%97%b6%e6%8c%82%e8%bd%bdcifs%e5%a4%b1%e8%b4%a5%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-1">1. 问题描述<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-gentoo%e5%90%af%e5%8a%a8%e6%97%b6%e6%8c%82%e8%bd%bdcifs%e5%a4%b1%e8%b4%a5%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-1" title="Permanent link">&para;</a></h2>
<p>今日观察到 Gentoo 重启后 cifs 挂载项丢失，其中 <code>/etc/fstab</code> 是这样写的：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-gentoo%e5%90%af%e5%8a%a8%e6%97%b6%e6%8c%82%e8%bd%bdcifs%e5%a4%b1%e8%b4%a5%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>//192.168.11.254/downloads/others /mnt/winshare cifs credentials=/etc/cifs-credentials,uid=3000,gid=3000,_netdev 0 0
</span></code></pre></div></td></tr></table></div>
<p>启动报错里 <code>dmesg</code> 大致为网络不可达类型的报错。</p>
<h%e6%8a%98%e8%85%belinux-gentoo-gentoo%e5%90%af%e5%8a%a8%e6%97%b6%e6%8c%82%e8%bd%bdcifs%e5%a4%b1%e8%b4%a5%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-2 id="%e6%8a%98%e8%85%belinux-gentoo-gentoo%e5%90%af%e5%8a%a8%e6%97%b6%e6%8c%82%e8%bd%bdcifs%e5%a4%b1%e8%b4%a5%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-2">2. 排查方向<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-gentoo%e5%90%af%e5%8a%a8%e6%97%b6%e6%8c%82%e8%bd%bdcifs%e5%a4%b1%e8%b4%a5%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-2" title="Permanent link">&para;</a></h2>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-gentoo%e5%90%af%e5%8a%a8%e6%97%b6%e6%8c%82%e8%bd%bdcifs%e5%a4%b1%e8%b4%a5%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-21">2.1 检查网卡名字是否匹配<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-gentoo%e5%90%af%e5%8a%a8%e6%97%b6%e6%8c%82%e8%bd%bdcifs%e5%a4%b1%e8%b4%a5%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-21" title="Permanent link">&para;</a></h3>
<ul>
<li>检查 <code>/etc/init.d/net.*</code> 网卡配置文件的网卡名称是否是当前网卡名称。</li>
<li>检查 <code>/etc/conf.d/net</code> 中配置的网卡名称。</li>
</ul>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-gentoo%e5%90%af%e5%8a%a8%e6%97%b6%e6%8c%82%e8%bd%bdcifs%e5%a4%b1%e8%b4%a5%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-22-dhcpcd">2.2 检查 dhcpcd 和网卡服务启动状态<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-gentoo%e5%90%af%e5%8a%a8%e6%97%b6%e6%8c%82%e8%bd%bdcifs%e5%a4%b1%e8%b4%a5%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-22-dhcpcd" title="Permanent link">&para;</a></h3>
<p>在服务 <code>net.eth0</code> 开启的情况下，服务 <code>dhcpcd</code> 应该不设置开机启动，而由 <code>net.eth0</code> 拉起。</p>
<h3 id="%e6%8a%98%e8%85%belinux-gentoo-gentoo%e5%90%af%e5%8a%a8%e6%97%b6%e6%8c%82%e8%bd%bdcifs%e5%a4%b1%e8%b4%a5%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-23">2.3 配置挂载前网络依赖<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-gentoo%e5%90%af%e5%8a%a8%e6%97%b6%e6%8c%82%e8%bd%bdcifs%e5%a4%b1%e8%b4%a5%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-23" title="Permanent link">&para;</a></h3>
<p>配置文件 <code>/etc/conf.d/netmount</code> ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-gentoo%e5%90%af%e5%8a%a8%e6%97%b6%e6%8c%82%e8%bd%bdcifs%e5%a4%b1%e8%b4%a5%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-gentoo%e5%90%af%e5%8a%a8%e6%97%b6%e6%8c%82%e8%bd%bdcifs%e5%a4%b1%e8%b4%a5%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>rc_need=&quot;net.eth0&quot;
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>rc_need=&quot;dhcpcd&quot;
</span></code></pre></div></td></tr></table></div>
<p>配置文件 <code>/etc/conf.d/net-online</code> ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-gentoo%e5%90%af%e5%8a%a8%e6%97%b6%e6%8c%82%e8%bd%bdcifs%e5%a4%b1%e8%b4%a5%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-gentoo%e5%90%af%e5%8a%a8%e6%97%b6%e6%8c%82%e8%bd%bdcifs%e5%a4%b1%e8%b4%a5%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-gentoo%e5%90%af%e5%8a%a8%e6%97%b6%e6%8c%82%e8%bd%bdcifs%e5%a4%b1%e8%b4%a5%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-3">3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-gentoo%e5%90%af%e5%8a%a8%e6%97%b6%e6%8c%82%e8%bd%bdcifs%e5%a4%b1%e8%b4%a5%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>interfaces=&quot;eth0&quot;
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>include_ping_test=yes
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a>ping_test_host=192.168.11.1
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a>timeout=120
</span></code></pre></div></td></tr></table></div>
<p>同时将这两个服务开机自启动。</p></section><section class="print-page" id="%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3" heading-number="6.2.5"><nav class='md-tags'><span class='md-tag'>Gentoo</span><span class='md-tag'>Linux</span><span class='md-tag'>xfce</span><span class='md-tag'>sddm</span><span class='md-tag'>Hyper-V</span></nav><h1 id="hyper-v-sddm">Hyper-V 环境下 sddm 无法启动图形界面问题解决<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-hyper-v-sddm" title="Permanent link">&para;</a></h1>
<h2 id="%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-1">1. 问题描述<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-1" title="Permanent link">&para;</a></h2>
<p>在 Hyper-V 环境下，安装 KDE 后，sddm 无法启动图形界面，即以下命令无效：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>rc-service display-manager start
</span></code></pre></div></td></tr></table></div>
<p>其中 <code>/etc/conf.d/display-manager</code> 中正确配置了 <code>DISPLAYMANAGER="sddm"</code> ，且使用配置 <code>~/.xinitrc</code> 后用 <code>startx</code> 命令启动 KDE ，或者使用 VNC 都正常。</p>
<h%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-2 id="%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-2">2. 排查过程<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-2" title="Permanent link">&para;</a></h2>
<p>将虚拟机迁移到 VMware ，一切正常。说明 sddm 安装和配置没有问题。 VMware 和 Hyper-V 的区别为 VMware 虚拟机里 <code>lspci</code> 有输出， Hyper-V 虚拟机里没有，因为 Hyper-V 走的是 VMBus 而不是 PCI-E 。</p>
<p>同时，在 Hyper-V 里启动 manjaro 安装镜像，图形界面可以启动。因此不是 Hyper-V 虚拟机配置问题。于是开始排查内核模块问题，在 manjaro 上 <code>lsmod | grep hyper</code> 和 gentoo 进行对比，最终将 gentoo 内核重新编译：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>genkernel all --install --bootloader=grub2 --hyperv --mountboot --menuconfig
</span></code></pre></div></td></tr></table></div>
<p>其中 menuconfig 里，禁用这里的 <code>hyperv_fb</code> ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>hyperv_fb
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>│ Symbol: FB_HYPERV [=m] │
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a>│ Type : tristate │
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a>│ Defined at drivers/video/fbdev/Kconfig:1781 │
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a>│ Prompt: Microsoft Hyper-V Synthetic Video support │
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a>│ Depends on: HAS_IOMEM [=y] &amp;&amp; FB [=y] &amp;&amp; HYPERV [=m] │
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a>│ Location: │
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a>│ -&gt; Device Drivers │
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a>│ -&gt; Graphics support │
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10"></a>│ -&gt; Frame buffer Devices │
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11"></a>│ (2) -&gt; Microsoft Hyper-V Synthetic Video support (FB_HYPERV [=m])
</span></code></pre></div></td></tr></table></div>
<p>开启这里的 <code>hyperv_drm</code> ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-10">10</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>hyperv_drm
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>│ Symbol: DRM_HYPERV [=n] │
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a>│ Type : tristate │
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a>│ Defined at drivers/gpu/drm/Kconfig:390 │
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a>│ Prompt: DRM Support for Hyper-V synthetic video device │
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a>│ Depends on: HAS_IOMEM [=y] &amp;&amp; DRM [=m] &amp;&amp; PCI [=y] &amp;&amp; MMU [=y] &amp;&amp; HYPERV [=m] │
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a>│ Location: │
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a>│ -&gt; Device Drivers │
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a>│ -&gt; Graphics support │
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10"></a>│ (1) -&gt; DRM Support for Hyper-V synthetic video device (DRM_HYPERV [=n]) │
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11"></a>│ Selects: DRM_KMS_HELPER [=m] &amp;&amp; DRM_GEM_SHMEM_HELPER [=m]
</span></code></pre></div></td></tr></table></div>
<p>问题没有得到解决。后来得知这个是 sddm 已知问题，更换 DM 为 lightdm 后，修改 lightdm 配置文件 <code>/etc/lightdm/lightdm.conf</code> 的这一行：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-4-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>[LightDM]
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a>logind-check-graphical=false
</span></code></pre></div></td></tr></table></div>
<p>同时，需要移除文件 <code>/usr/share/xsessions/Xsession.desktop</code> 来防止右上角显示不能用的 Xsession 这个 DE ，修改 <code>/etc/conf.d/display-manager</code> 里 <code>DISPLAYMANAGER="lightdm"</code> ，之后问题得到解决。</p></section><section class="print-page" id="%e6%8a%98%e8%85%belinux-gentoo-%e5%ae%89%e8%a3%85xfce%e5%90%8efcitx%e5%8f%b3%e4%b8%8a%e8%a7%92%e6%98%be%e7%a4%ba%e4%bd%86%e6%97%a0%e6%b3%95%e9%80%89%e6%8b%a9%e8%be%93%e5%85%a5%e6%b3%95%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3" heading-number="6.2.6"><nav class='md-tags'><span class='md-tag'>Gentoo</span><span class='md-tag'>Linux</span><span class='md-tag'>xfce</span><span class='md-tag'>fcitx</span></nav><h1 id="xfce-fcitx">安装 xfce 后 fcitx 右上角显示但无法选择输入法问题解决<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%ae%89%e8%a3%85xfce%e5%90%8efcitx%e5%8f%b3%e4%b8%8a%e8%a7%92%e6%98%be%e7%a4%ba%e4%bd%86%e6%97%a0%e6%b3%95%e9%80%89%e6%8b%a9%e8%be%93%e5%85%a5%e6%b3%95%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-xfce-fcitx" title="Permanent link">&para;</a></h1>
<h2 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%ae%89%e8%a3%85xfce%e5%90%8efcitx%e5%8f%b3%e4%b8%8a%e8%a7%92%e6%98%be%e7%a4%ba%e4%bd%86%e6%97%a0%e6%b3%95%e9%80%89%e6%8b%a9%e8%be%93%e5%85%a5%e6%b3%95%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-1">1. 问题描述<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%ae%89%e8%a3%85xfce%e5%90%8efcitx%e5%8f%b3%e4%b8%8a%e8%a7%92%e6%98%be%e7%a4%ba%e4%bd%86%e6%97%a0%e6%b3%95%e9%80%89%e6%8b%a9%e8%be%93%e5%85%a5%e6%b3%95%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-1" title="Permanent link">&para;</a></h2>
<p>在安装 xfce 后，安装 fcitx-rime ，之后发现输入法的键盘图标在右上角能显示，但是右键无法选择输入法。已经尝试过的方法为：</p>
<ul>
<li>将那三个环境变量同时配置于 <code>~/.xprofile</code> 、 <code>~/.xinitrc</code> 和 <code>/etc/profile.d/fcitx.sh</code> ，重启，问题依旧存在。</li>
<li>使用 <code>fcitx-diagnose</code> 诊断，发现无异常。</li>
<li>尝试使用 vnc 连接，问题依旧存在。</li>
</ul>
<h%e6%8a%98%e8%85%belinux-gentoo-%e5%ae%89%e8%a3%85xfce%e5%90%8efcitx%e5%8f%b3%e4%b8%8a%e8%a7%92%e6%98%be%e7%a4%ba%e4%bd%86%e6%97%a0%e6%b3%95%e9%80%89%e6%8b%a9%e8%be%93%e5%85%a5%e6%b3%95%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-2 id="%e6%8a%98%e8%85%belinux-gentoo-%e5%ae%89%e8%a3%85xfce%e5%90%8efcitx%e5%8f%b3%e4%b8%8a%e8%a7%92%e6%98%be%e7%a4%ba%e4%bd%86%e6%97%a0%e6%b3%95%e9%80%89%e6%8b%a9%e8%be%93%e5%85%a5%e6%b3%95%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-2">2. 解决方法<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%ae%89%e8%a3%85xfce%e5%90%8efcitx%e5%8f%b3%e4%b8%8a%e8%a7%92%e6%98%be%e7%a4%ba%e4%bd%86%e6%97%a0%e6%b3%95%e9%80%89%e6%8b%a9%e8%be%93%e5%85%a5%e6%b3%95%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-2" title="Permanent link">&para;</a></h2>
<p>安装 ibus 输入法后，问题自动解决，我也不知道为什么：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%ae%89%e8%a3%85xfce%e5%90%8efcitx%e5%8f%b3%e4%b8%8a%e8%a7%92%e6%98%be%e7%a4%ba%e4%bd%86%e6%97%a0%e6%b3%95%e9%80%89%e6%8b%a9%e8%be%93%e5%85%a5%e6%b3%95%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>emerge --ask app-i18n/ibus ibus-libpinyin
</span></code></pre></div></td></tr></table></div>
<p>表现为安装 ibus 后，我将三个环境变量清除：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%ae%89%e8%a3%85xfce%e5%90%8efcitx%e5%8f%b3%e4%b8%8a%e8%a7%92%e6%98%be%e7%a4%ba%e4%bd%86%e6%97%a0%e6%b3%95%e9%80%89%e6%8b%a9%e8%be%93%e5%85%a5%e6%b3%95%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%ae%89%e8%a3%85xfce%e5%90%8efcitx%e5%8f%b3%e4%b8%8a%e8%a7%92%e6%98%be%e7%a4%ba%e4%bd%86%e6%97%a0%e6%b3%95%e9%80%89%e6%8b%a9%e8%be%93%e5%85%a5%e6%b3%95%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%ae%89%e8%a3%85xfce%e5%90%8efcitx%e5%8f%b3%e4%b8%8a%e8%a7%92%e6%98%be%e7%a4%ba%e4%bd%86%e6%97%a0%e6%b3%95%e9%80%89%e6%8b%a9%e8%be%93%e5%85%a5%e6%b3%95%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-1-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>export GTK_IM_MODULE=fcitx
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>export QT_IM_MODULE=fcitx
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a>export XMODIFIERS=@im=fcitx
</span></code></pre></div></td></tr></table></div>
<p>然后改成了 ibus 的：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%ae%89%e8%a3%85xfce%e5%90%8efcitx%e5%8f%b3%e4%b8%8a%e8%a7%92%e6%98%be%e7%a4%ba%e4%bd%86%e6%97%a0%e6%b3%95%e9%80%89%e6%8b%a9%e8%be%93%e5%85%a5%e6%b3%95%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%ae%89%e8%a3%85xfce%e5%90%8efcitx%e5%8f%b3%e4%b8%8a%e8%a7%92%e6%98%be%e7%a4%ba%e4%bd%86%e6%97%a0%e6%b3%95%e9%80%89%e6%8b%a9%e8%be%93%e5%85%a5%e6%b3%95%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-gentoo-%e5%ae%89%e8%a3%85xfce%e5%90%8efcitx%e5%8f%b3%e4%b8%8a%e8%a7%92%e6%98%be%e7%a4%ba%e4%bd%86%e6%97%a0%e6%b3%95%e9%80%89%e6%8b%a9%e8%be%93%e5%85%a5%e6%b3%95%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>GTK_IM_MODULE=ibus
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>QT_IM_MODULE=ibus
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a>XMODIFIERS=@im=ibus
</span></code></pre></div></td></tr></table></div>
<p>之后没有卸载 fcitx ，重启后发现 xfce 右上角键盘图标变成加粗的图标， fcitx 莫名其妙地好了。删除 ibus 环境变量，不添加 fcitx 环境变量，重启，依旧是好的。</p></section></section>
                    <section class='print-page md-section' id='section-6-3' heading-number='6.3'>
                        <h1>OpenWrt<a class='headerlink' href='#section-6-3' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85wireguard" heading-number="6.3.1"><nav class='md-tags'><span class='md-tag'>OpenWrt</span><span class='md-tag'>WireGuard</span></nav><h1 id="openwrt-wireguard">OpenWrt 安装 WireGuard<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85wireguard-openwrt-wireguard" title="Permanent link">&para;</a></h1>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85wireguard-1">1. 前言<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85wireguard-1" title="Permanent link">&para;</a></h2>
<p>当出门在外需要访问家里的服务时，总是需要一种异地组网方案。现行的异地组网方案大致有 ZeroTier 、 OpenVPN 和 WireGuard 三种，其中各有优劣。 OpenVPN 的优势是使用 TCP 连接，不容易像剩下两种方案似的有 UDP 连接不稳定的情况，缺点是速度慢。而 WireGuard 正好和 OpenVPN 相反，速度最快，但只能使用 UDP 直连。 ZeroTier 介于两种之间（它在连接非常不稳定时会使用 TCP 并走中转服务器）。</p>
<p>因此本文在 OpenWrt 上搭建一个 WireGuard 服务器，其中需要准备的条件如下：</p>
<ul>
<li>OpenWrt 系统已安装。</li>
<li>有公网 IPv6 。</li>
<li>公网 IPv6 高位 UDP 端口可以稳定连接。</li>
<li>私网网段 10.8.0.0/24 没有被使用，将会被作为 WireGuard 私网网段。</li>
</ul>
<h%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85wireguard-2 id="%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85wireguard-2">2. 安装必要的软件包<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85wireguard-2" title="Permanent link">&para;</a></h2>
<p>安装以下软件：</p>
<ul>
<li>wireguard-tools</li>
<li>luci-app-wireguard</li>
<li>luci-proto-wireguard</li>
<li>qrencode</li>
</ul>
<p>可以去 <code>System -&gt; Software</code> 界面安装，或者使用命令行安装。安装以后记得重启。</p>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85wireguard-3-wireguard">3. 配置 WireGuard 网卡<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85wireguard-3-wireguard" title="Permanent link">&para;</a></h2>
<p>在 <code>Network -&gt; Interfaces</code> 界面，点击 <code>Add new Interface</code> ，添加类型为 WireGuard 的网卡：</p>
<p><img alt="" src="%E6%8A%98%E8%85%BELinux/OpenWrt/images/WireGuard_1.png" /></p>
<p>需要点击 <code>Generate new key pair</code> 生成密钥，其中 <code>IP Address</code> 里应该填写 OpenWrt 准备使用的私网 IP 地址（10.8.0.1/32），以及整个 WireGuard 网络的地址（10.8.0.0/24）：</p>
<p><img alt="" src="%E6%8A%98%E8%85%BELinux/OpenWrt/images/WireGuard_2.png" /></p>
<p>在 <code>Firewall Settings</code> 里，新建防火墙区域 <code>vpn</code> 并将其加入该区域：</p>
<p><img alt="" src="%E6%8A%98%E8%85%BELinux/OpenWrt/images/WireGuard_8.png" /></p>
<p>在 <code>Peers</code> 里，设置需要连接到此 WireGuard 服务器的客户端，点击 <code>Add peer</code> 添加客户端：</p>
<p><img alt="" src="%E6%8A%98%E8%85%BELinux/OpenWrt/images/WireGuard_3.png" /></p>
<p>同样需要点击 <code>Generate new key pair</code> 和 <code>Generate preshared key</code> 来生成 2 个密钥，勾选 <code>Route Allowed IPs</code> 并在 <code>Allowed IPs</code> 中填入客户端在 WireGuard 私网的 IP 地址（10.8.0.2/32）， <code>Persistens Keep Alive</code> 填写建议值 <code>25</code> ，之后点击 <code>Generate configuration</code> 获取客户端连接配置：</p>
<p><img alt="" src="%E6%8A%98%E8%85%BELinux/OpenWrt/images/WireGuard_4.png" /></p>
<p>之后保存所有设置，并重启 WireGuard 网卡（每次修改后都需要重启网卡生效）。</p>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85wireguard-4-wireguard">4. 查看 WireGuard 配置<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85wireguard-4-wireguard" title="Permanent link">&para;</a></h2>
<p>在 <code>Status -&gt; WireGuard</code> 中可以查看 WireGuard 所有客户端的信息：</p>
<p><img alt="" src="%E6%8A%98%E8%85%BELinux/OpenWrt/images/WireGuard_5.png" /></p>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85wireguard-5">5. 配置防火墙<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85wireguard-5" title="Permanent link">&para;</a></h2>
<p>在 <code>Network -&gt; Firewall -&gt; Traffic Rules</code> 中，添加防火墙规则，放行 WireGuard 的端口：</p>
<p><img alt="" src="%E6%8A%98%E8%85%BELinux/OpenWrt/images/WireGuard_7.png" /></p>
<p>同时，在 <code>Network -&gt; Firewall -&gt; Zones</code> 中，设置 <code>vpn</code> 区域对所有区域可转发，开启 <code>Masquerading</code> ，Input 、 Output 、 Forward 全部 Accept ：</p>
<p><img alt="" src="%E6%8A%98%E8%85%BELinux/OpenWrt/images/WireGuard_6.png" /></p>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85wireguard-6">6. 使用客户端测试<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85wireguard-6" title="Permanent link">&para;</a></h2>
<p>移动端使用二维码，桌面端直接复制配置文件导入，进行测试。</p>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85wireguard-7">7. 参考资料<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85wireguard-7" title="Permanent link">&para;</a></h2>
<p><a href="https://upsangel.com/security/vpn/%E4%B8%80%E9%8D%B5%E9%80%A3%E5%9B%9E%E5%AE%B6%E9%87%8C%E5%85%A7%E7%B6%B2%EF%BC%9Aopenwrt%E4%B8%8A%E9%83%A8%E7%BD%B2wireguard-vpn%E6%9C%8D%E5%8B%99%E5%99%A8%E7%9A%84%E4%B8%89%E5%80%8B%E8%A6%81%E9%BB%9E/">https://upsangel.com/security/vpn/%E4%B8%80%E9%8D%B5%E9%80%A3%E5%9B%9E%E5%AE%B6%E9%87%8C%E5%85%A7%E7%B6%B2%EF%BC%9Aopenwrt%E4%B8%8A%E9%83%A8%E7%BD%B2wireguard-vpn%E6%9C%8D%E5%8B%99%E5%99%A8%E7%9A%84%E4%B8%89%E5%80%8B%E8%A6%81%E9%BB%9E/</a></p>
<p><a href="https://whatgui.github.io/2020/02/08/%E3%80%8C%E6%8D%AF%E9%A5%AC%E8%AE%B0%E5%BD%95%E3%80%8D%E5%9C%A8OpenWrt%E4%B8%8A%E9%85%8D%E7%BD%AE%E4%B8%80%E4%B8%8Bwireguard%E6%9C%8D%E5%8A%A1%E7%AB%AF/">https://whatgui.github.io/2020/02/08/%E3%80%8C%E6%8D%AF%E9%A5%AC%E8%AE%B0%E5%BD%95%E3%80%8D%E5%9C%A8OpenWrt%E4%B8%8A%E9%85%8D%E7%BD%AE%E4%B8%80%E4%B8%8Bwireguard%E6%9C%8D%E5%8A%A1%E7%AB%AF/</a></p></section><section class="print-page" id="%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn" heading-number="6.3.2"><nav class='md-tags'><span class='md-tag'>OpenWrt</span><span class='md-tag'>OpenVPN</span></nav><h1 id="openwrt-openvpn">OpenWrt 安装 OpenVPN<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-openwrt-openvpn" title="Permanent link">&para;</a></h1>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-1">1. 前言<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-1" title="Permanent link">&para;</a></h2>
<p>尽管 OpenVPN 这种异地组网方式有些许远古，但是还是有使用 OpenVPN 的必要，譬如说它支持 TCP 协议。因此本文会建立一个 OpenVPN 服务器，前置条件如下：</p>
<ul>
<li>OpenWrt 有公网 IPv6 ，且高位 TCP 端口可稳定连接。</li>
<li>私网网段 10.8.1.0/24 没有被使用，将会被作为 OpenVPN 私网网段。</li>
</ul>
<h%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-2 id="%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-2">2. 安装软件包<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-2" title="Permanent link">&para;</a></h2>
<p>使用 opkg 安装软件：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-0-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a># Install packages
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>opkg update
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a>opkg install openvpn-openssl openvpn-easy-rsa
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-3">3. 设置环境变量<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-3" title="Permanent link">&para;</a></h2>
<p>以下为安装需要的环境变量：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-1-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1"># Configuration parameters</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="nv">VPN_DIR</span><span class="o">=</span><span class="s2">&quot;/etc/openvpn&quot;</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="nv">VPN_PKI</span><span class="o">=</span><span class="s2">&quot;/etc/easy-rsa/pki&quot;</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="nv">VPN_PORT</span><span class="o">=</span><span class="s2">&quot;11940&quot;</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="nv">VPN_PROTO</span><span class="o">=</span><span class="s2">&quot;tcp6&quot;</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="nv">VPN_POOL</span><span class="o">=</span><span class="s2">&quot;10.8.1.0 255.255.255.0&quot;</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="nv">VPN_DNS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">VPN_POOL</span><span class="p">%.* *</span><span class="si">}</span><span class="s2">.1&quot;</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="nv">VPN_DN</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>uci<span class="w"> </span>-q<span class="w"> </span>get<span class="w"> </span>dhcp.@dnsmasq<span class="o">[</span><span class="m">0</span><span class="o">]</span>.domain<span class="k">)</span><span class="s2">&quot;</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="c1"># Fetch server address</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="nv">NET_FQDN</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>uci<span class="w"> </span>-q<span class="w"> </span>get<span class="w"> </span>ddns.@service<span class="o">[</span><span class="m">0</span><span class="o">]</span>.lookup_host<span class="k">)</span><span class="s2">&quot;</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a>.<span class="w"> </span>/lib/functions/network.sh
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a>network_flush_cache
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14"></a>network_find_wan<span class="w"> </span>NET_IF
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15"></a>network_get_ipaddr<span class="w"> </span>NET_ADDR<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">NET_IF</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">NET_FQDN</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">  </span><span class="nv">VPN_SERV</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">NET_FQDN</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="k">else</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">  </span><span class="nv">VPN_SERV</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">NET_ADDR</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="k">fi</span>
</span></code></pre></div></td></tr></table></div>
<p>如果中途退出，需要重新设置。</p>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-4-easyrsa">4. 使用 EasyRSA 生成密钥<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-4-easyrsa" title="Permanent link">&para;</a></h2>
<p>一键下载并生成密钥：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-21">21</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-22">22</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-23">23</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-24">24</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-25">25</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-26">26</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-27">27</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-28">28</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-29">29</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-30">30</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-31">31</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-2-32">32</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nb">cd</span><span class="w"> </span>~
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="c1"># Work around EasyRSA issues</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a>wget<span class="w"> </span>-U<span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span>-O<span class="w"> </span>/tmp/easyrsa.tar.gz<span class="w"> </span>https://github.com/OpenVPN/easy-rsa/releases/download/v3.2.0/EasyRSA-3.2.0.tgz
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a>tar<span class="w"> </span>-z<span class="w"> </span>-x<span class="w"> </span>-f<span class="w"> </span>/tmp/easyrsa.tar.gz
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="c1"># Configuration parameters</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a>cat<span class="w"> </span><span class="s">&lt;&lt; EOF &gt; /etc/profile.d/easy-rsa.sh</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="s">export EASYRSA_PKI=&quot;${VPN_PKI}&quot;</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="s">export EASYRSA_TEMP_DIR=&quot;/tmp&quot;</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="s">export EASYRSA_CERT_EXPIRE=&quot;3650&quot;</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="s">export EASYRSA_BATCH=&quot;1&quot;</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="s">alias easyrsa=&quot;/root/EasyRSA-3.2.0/easyrsa&quot;</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="s">EOF</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14"></a>.<span class="w"> </span>/etc/profile.d/easy-rsa.sh
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15"></a>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="c1"># Remove and re-initialize PKI directory</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17"></a>easyrsa<span class="w"> </span>init-pki
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18"></a>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="c1"># Generate DH parameters</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20"></a>easyrsa<span class="w"> </span>gen-dh
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21"></a>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="c1"># Create a new CA</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23"></a>easyrsa<span class="w"> </span>build-ca<span class="w"> </span>nopass
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24"></a>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="c1"># Generate server keys and certificate</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26"></a>easyrsa<span class="w"> </span>build-server-full<span class="w"> </span>server<span class="w"> </span>nopass
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27"></a>openvpn<span class="w"> </span>--genkey<span class="w"> </span>tls-crypt-v2-server<span class="w"> </span><span class="si">${</span><span class="nv">EASYRSA_PKI</span><span class="si">}</span>/private/server.pem
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28"></a>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29"></a><span class="c1"># Generate client keys and certificate</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30"></a>easyrsa<span class="w"> </span>build-client-full<span class="w"> </span>client<span class="w"> </span>nopass
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31"></a>openvpn<span class="w"> </span>--tls-crypt-v2<span class="w"> </span><span class="si">${</span><span class="nv">EASYRSA_PKI</span><span class="si">}</span>/private/server.pem<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32"></a>--genkey<span class="w"> </span>tls-crypt-v2-client<span class="w"> </span><span class="si">${</span><span class="nv">EASYRSA_PKI</span><span class="si">}</span>/private/client.pem
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-5-openvpn">5. 生成 OpenVPN 配置并启动服务<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-5-openvpn" title="Permanent link">&para;</a></h2>
<p>生成客户端与服务器配置文件：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-10">10</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-11">11</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-12">12</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-13">13</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-14">14</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-15">15</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-16">16</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-17">17</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-18">18</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-19">19</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-20">20</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-21">21</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-22">22</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-23">23</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-24">24</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-25">25</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-26">26</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-27">27</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-28">28</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-29">29</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-30">30</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-31">31</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-32">32</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-33">33</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-34">34</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-35">35</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-36">36</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-37">37</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-38">38</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-39">39</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-40">40</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-41">41</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-42">42</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-43">43</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-44">44</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-45">45</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-46">46</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-47">47</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-48">48</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-49">49</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-50">50</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-51">51</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-52">52</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-53">53</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-54">54</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-55">55</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-56">56</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-57">57</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-58">58</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-59">59</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-60">60</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-61">61</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-62">62</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-63">63</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-64">64</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-65">65</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-66">66</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-67">67</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-__codelineno-3-68">68</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="c1"># Configure VPN service and generate client profiles</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="nb">umask</span><span class="w"> </span><span class="nv">go</span><span class="o">=</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="nv">VPN_DH</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>cat<span class="w"> </span><span class="si">${</span><span class="nv">VPN_PKI</span><span class="si">}</span>/dh.pem<span class="k">)</span><span class="s2">&quot;</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="nv">VPN_CA</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span><span class="si">${</span><span class="nv">VPN_PKI</span><span class="si">}</span>/ca.crt<span class="k">)</span><span class="s2">&quot;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a>ls<span class="w"> </span><span class="si">${</span><span class="nv">VPN_PKI</span><span class="si">}</span>/issued<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;s/\.\w*</span>$<span class="s2">//&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="p">|</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>VPN_ID
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="k">do</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="nv">VPN_TC</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>cat<span class="w"> </span><span class="si">${</span><span class="nv">VPN_PKI</span><span class="si">}</span>/private/<span class="si">${</span><span class="nv">VPN_ID</span><span class="si">}</span>.pem<span class="k">)</span><span class="s2">&quot;</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="nv">VPN_KEY</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>cat<span class="w"> </span><span class="si">${</span><span class="nv">VPN_PKI</span><span class="si">}</span>/private/<span class="si">${</span><span class="nv">VPN_ID</span><span class="si">}</span>.key<span class="k">)</span><span class="s2">&quot;</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="nv">VPN_CERT</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span><span class="si">${</span><span class="nv">VPN_PKI</span><span class="si">}</span>/issued/<span class="si">${</span><span class="nv">VPN_ID</span><span class="si">}</span>.crt<span class="k">)</span><span class="s2">&quot;</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="nv">VPN_EKU</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">VPN_CERT</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>openssl<span class="w"> </span>x509<span class="w"> </span>-noout<span class="w"> </span>-purpose<span class="k">)</span><span class="s2">&quot;</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="k">case</span><span class="w"> </span><span class="si">${</span><span class="nv">VPN_EKU</span><span class="si">}</span><span class="w"> </span><span class="k">in</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="o">(</span>*<span class="s2">&quot;SSL server : Yes&quot;</span>*<span class="o">)</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="nv">VPN_CONF</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">VPN_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">VPN_ID</span><span class="si">}</span><span class="s2">.conf&quot;</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16"></a>cat<span class="w"> </span><span class="s">&lt;&lt; EOF &gt; ${VPN_CONF} ;;</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="s">user nobody</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="s">group nogroup</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="s">dev tun</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="s">port ${VPN_PORT}</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="s">proto ${VPN_PROTO}</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="s">server ${VPN_POOL}</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="s">topology subnet</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24"></a><span class="s">client-to-client</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25"></a><span class="s">keepalive 10 60</span>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26"></a><span class="s">persist-tun</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27"></a><span class="s">persist-key</span>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28"></a><span class="s">push &quot;dhcp-option DNS ${VPN_DNS}&quot;</span>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29"></a><span class="s">push &quot;dhcp-option DOMAIN ${VPN_DN}&quot;</span>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30"></a><span class="s">push &quot;redirect-gateway def1&quot;</span>
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31"></a><span class="s">push &quot;persist-tun&quot;</span>
</span><span id="__span-3-32"><a id="__codelineno-3-32" name="__codelineno-3-32"></a><span class="s">push &quot;persist-key&quot;</span>
</span><span id="__span-3-33"><a id="__codelineno-3-33" name="__codelineno-3-33"></a><span class="s">&lt;dh&gt;</span>
</span><span id="__span-3-34"><a id="__codelineno-3-34" name="__codelineno-3-34"></a><span class="s">${VPN_DH}</span>
</span><span id="__span-3-35"><a id="__codelineno-3-35" name="__codelineno-3-35"></a><span class="s">&lt;/dh&gt;</span>
</span><span id="__span-3-36"><a id="__codelineno-3-36" name="__codelineno-3-36"></a><span class="s">EOF</span>
</span><span id="__span-3-37"><a id="__codelineno-3-37" name="__codelineno-3-37"></a><span class="o">(</span>*<span class="s2">&quot;SSL client : Yes&quot;</span>*<span class="o">)</span>
</span><span id="__span-3-38"><a id="__codelineno-3-38" name="__codelineno-3-38"></a><span class="nv">VPN_CONF</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">VPN_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">VPN_ID</span><span class="si">}</span><span class="s2">.ovpn&quot;</span>
</span><span id="__span-3-39"><a id="__codelineno-3-39" name="__codelineno-3-39"></a>cat<span class="w"> </span><span class="s">&lt;&lt; EOF &gt; ${VPN_CONF} ;;</span>
</span><span id="__span-3-40"><a id="__codelineno-3-40" name="__codelineno-3-40"></a><span class="s">user nobody</span>
</span><span id="__span-3-41"><a id="__codelineno-3-41" name="__codelineno-3-41"></a><span class="s">group nogroup</span>
</span><span id="__span-3-42"><a id="__codelineno-3-42" name="__codelineno-3-42"></a><span class="s">dev tun</span>
</span><span id="__span-3-43"><a id="__codelineno-3-43" name="__codelineno-3-43"></a><span class="s">nobind</span>
</span><span id="__span-3-44"><a id="__codelineno-3-44" name="__codelineno-3-44"></a><span class="s">client</span>
</span><span id="__span-3-45"><a id="__codelineno-3-45" name="__codelineno-3-45"></a><span class="s">remote ${VPN_SERV} ${VPN_PORT} ${VPN_PROTO}</span>
</span><span id="__span-3-46"><a id="__codelineno-3-46" name="__codelineno-3-46"></a><span class="s">auth-nocache</span>
</span><span id="__span-3-47"><a id="__codelineno-3-47" name="__codelineno-3-47"></a><span class="s">comp-lzo yes</span>
</span><span id="__span-3-48"><a id="__codelineno-3-48" name="__codelineno-3-48"></a><span class="s">allow-compression yes</span>
</span><span id="__span-3-49"><a id="__codelineno-3-49" name="__codelineno-3-49"></a><span class="s">remote-cert-tls server</span>
</span><span id="__span-3-50"><a id="__codelineno-3-50" name="__codelineno-3-50"></a><span class="s">EOF</span>
</span><span id="__span-3-51"><a id="__codelineno-3-51" name="__codelineno-3-51"></a><span class="k">esac</span>
</span><span id="__span-3-52"><a id="__codelineno-3-52" name="__codelineno-3-52"></a>cat<span class="w"> </span><span class="s">&lt;&lt; EOF &gt;&gt; ${VPN_CONF}</span>
</span><span id="__span-3-53"><a id="__codelineno-3-53" name="__codelineno-3-53"></a><span class="s">&lt;tls-crypt-v2&gt;</span>
</span><span id="__span-3-54"><a id="__codelineno-3-54" name="__codelineno-3-54"></a><span class="s">${VPN_TC}</span>
</span><span id="__span-3-55"><a id="__codelineno-3-55" name="__codelineno-3-55"></a><span class="s">&lt;/tls-crypt-v2&gt;</span>
</span><span id="__span-3-56"><a id="__codelineno-3-56" name="__codelineno-3-56"></a><span class="s">&lt;key&gt;</span>
</span><span id="__span-3-57"><a id="__codelineno-3-57" name="__codelineno-3-57"></a><span class="s">${VPN_KEY}</span>
</span><span id="__span-3-58"><a id="__codelineno-3-58" name="__codelineno-3-58"></a><span class="s">&lt;/key&gt;</span>
</span><span id="__span-3-59"><a id="__codelineno-3-59" name="__codelineno-3-59"></a><span class="s">&lt;cert&gt;</span>
</span><span id="__span-3-60"><a id="__codelineno-3-60" name="__codelineno-3-60"></a><span class="s">${VPN_CERT}</span>
</span><span id="__span-3-61"><a id="__codelineno-3-61" name="__codelineno-3-61"></a><span class="s">&lt;/cert&gt;</span>
</span><span id="__span-3-62"><a id="__codelineno-3-62" name="__codelineno-3-62"></a><span class="s">&lt;ca&gt;</span>
</span><span id="__span-3-63"><a id="__codelineno-3-63" name="__codelineno-3-63"></a><span class="s">${VPN_CA}</span>
</span><span id="__span-3-64"><a id="__codelineno-3-64" name="__codelineno-3-64"></a><span class="s">&lt;/ca&gt;</span>
</span><span id="__span-3-65"><a id="__codelineno-3-65" name="__codelineno-3-65"></a><span class="s">EOF</span>
</span><span id="__span-3-66"><a id="__codelineno-3-66" name="__codelineno-3-66"></a><span class="k">done</span>
</span><span id="__span-3-67"><a id="__codelineno-3-67" name="__codelineno-3-67"></a>service<span class="w"> </span>openvpn<span class="w"> </span>restart
</span><span id="__span-3-68"><a id="__codelineno-3-68" name="__codelineno-3-68"></a>ls<span class="w"> </span><span class="si">${</span><span class="nv">VPN_DIR</span><span class="si">}</span>/*.ovpn
</span></code></pre></div></td></tr></table></div>
<p>生成的客户端配置在 <code>/etc/openvpn/client.ovpn</code> ，服务器配置在 <code>/etc/openvpn/server.conf</code></p>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-6">6. 配置防火墙<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-6" title="Permanent link">&para;</a></h2>
<p>在 <code>Network -&gt; Firewall -&gt; Traffic Rules</code> 配置防火墙，放行 OpenVPN 端口：</p>
<p><img alt="" src="%E6%8A%98%E8%85%BELinux/OpenWrt/images/OpenVPN_1.png" /></p>
<p>在 <code>Network -&gt; Interfaces</code> 中添加 <code>tun0</code> 网络接口：</p>
<p><img alt="" src="%E6%8A%98%E8%85%BELinux/OpenWrt/images/OpenVPN_2.png" /></p>
<p>将该网络接口放入 <code>vpn</code> 防火墙区域：</p>
<p><img alt="" src="%E6%8A%98%E8%85%BELinux/OpenWrt/images/OpenVPN_3.png" /></p>
<p>同时，在 <code>Network -&gt; Firewall -&gt; Zones</code> 中，设置 <code>vpn</code> 区域对所有区域可转发，开启 <code>Masquerading</code> ，Input 、 Output 、 Forward 全部 Accept ：</p>
<p><img alt="" src="%E6%8A%98%E8%85%BELinux/OpenWrt/images/OpenVPN_4.png" /></p>
<p>至此一个最基本的 OpenVPN 配置完成。</p>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-7-luci-app-openvpn">7. luci-app-openvpn 的配置<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-7-luci-app-openvpn" title="Permanent link">&para;</a></h2>
<p>如果要使用图形化管理 OpenVPN ，首先需要安装 luci-app-openvpn ，之后根据 <code>/etc/openvpn/server.conf</code> 进行配置文件迁移。首先先在 <code>/etc/openvpn/server.conf</code> 中提取证书，并存放到相应位置：</p>
<table>
<thead>
<tr>
<th><code>server.conf</code> 中证书</th>
<th>存放地点</th>
</tr>
</thead>
<tbody>
<tr>
<td>ca</td>
<td>/etc/openvpn/pki/ca.crt</td>
</tr>
<tr>
<td>dh</td>
<td>/etc/openvpn/pki/dh.pem</td>
</tr>
<tr>
<td>cert</td>
<td>/etc/openvpn/pki/server.crt</td>
</tr>
<tr>
<td>key</td>
<td>/etc/openvpn/pki/server.key</td>
</tr>
<tr>
<td>tls-crypt-v2</td>
<td>/etc/openvpn/pki/server.pem</td>
</tr>
</tbody>
</table>
<p>之后将 <code>/etc/openvpn/server.conf</code> 重命名为 <code>server.conf.bak</code> ，开始在 <code>VPN -&gt; OpenVPN</code> 界面点击 <code>Edit</code> 对默认的 <code>myvpn</code> 进行配置：</p>
<p><img alt="" src="%E6%8A%98%E8%85%BELinux/OpenWrt/images/OpenVPN_5.png" /></p>
<p>实测最终的配置如下：</p>
<p><img alt="" src="%E6%8A%98%E8%85%BELinux/OpenWrt/images/OpenVPN_6.png" /></p>
<p><img alt="" src="%E6%8A%98%E8%85%BELinux/OpenWrt/images/OpenVPN_7.png" /></p>
<p><img alt="" src="%E6%8A%98%E8%85%BELinux/OpenWrt/images/OpenVPN_8.png" /></p>
<p><img alt="" src="%E6%8A%98%E8%85%BELinux/OpenWrt/images/OpenVPN_9.png" /></p>
<p><img alt="" src="%E6%8A%98%E8%85%BELinux/OpenWrt/images/OpenVPN_10.png" /></p>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-8">8. 参考资料<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn-8" title="Permanent link">&para;</a></h2>
<p><a href="https://openwrt.org/docs/guide-user/services/vpn/openvpn/server">https://openwrt.org/docs/guide-user/services/vpn/openvpn/server</a></p></section><section class="print-page" id="%e6%8a%98%e8%85%belinux-openwrt-openwrt%20ddns%e5%bc%80%e6%9c%ba%e5%90%af%e5%8a%a8%e5%a4%b1%e8%b4%a5%e9%97%ae%e9%a2%98" heading-number="6.3.3"><nav class='md-tags'><span class='md-tag'>OpenWrt</span><span class='md-tag'>DDNS</span></nav><h1 id="openwrt-ddns">OpenWrt DDNS 开机启动失败问题<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%20ddns%e5%bc%80%e6%9c%ba%e5%90%af%e5%8a%a8%e5%a4%b1%e8%b4%a5%e9%97%ae%e9%a2%98-openwrt-ddns" title="Permanent link">&para;</a></h1>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-openwrt%20ddns%e5%bc%80%e6%9c%ba%e5%90%af%e5%8a%a8%e5%a4%b1%e8%b4%a5%e9%97%ae%e9%a2%98-1">1. 问题描述<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%20ddns%e5%bc%80%e6%9c%ba%e5%90%af%e5%8a%a8%e5%a4%b1%e8%b4%a5%e9%97%ae%e9%a2%98-1" title="Permanent link">&para;</a></h2>
<p>OpenWrt 在安装 <code>luci-app-ddns</code> 和 <code>ddns-scripts-dnspod</code> 后，每次开机后均不能正常启动。在 <code>System -&gt; Startup -&gt; Initscripts</code> 里显示 <code>ddns</code> 是 <code>Enabled</code> 状态，且点击 <code>Restart</code> 能正常启动。</p>
<h%e6%8a%98%e8%85%belinux-openwrt-openwrt%20ddns%e5%bc%80%e6%9c%ba%e5%90%af%e5%8a%a8%e5%a4%b1%e8%b4%a5%e9%97%ae%e9%a2%98-2 id="%e6%8a%98%e8%85%belinux-openwrt-openwrt%20ddns%e5%bc%80%e6%9c%ba%e5%90%af%e5%8a%a8%e5%a4%b1%e8%b4%a5%e9%97%ae%e9%a2%98-2">2. 解决方法<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%20ddns%e5%bc%80%e6%9c%ba%e5%90%af%e5%8a%a8%e5%a4%b1%e8%b4%a5%e9%97%ae%e9%a2%98-2" title="Permanent link">&para;</a></h2>
<p>已知 bug ，可以添加额外启动脚本解决，在 <code>System -&gt; Startup -&gt; Local Startup</code> 添加：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%20ddns%e5%bc%80%e6%9c%ba%e5%90%af%e5%8a%a8%e5%a4%b1%e8%b4%a5%e9%97%ae%e9%a2%98-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>/bin/sleep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>/sbin/service<span class="w"> </span>ddns<span class="w"> </span>restart<span class="w"> </span><span class="p">&amp;</span>
</span></code></pre></div></td></tr></table></div>
<p>添加后如图：</p>
<p><img alt="" src="%E6%8A%98%E8%85%BELinux/OpenWrt/images/DDNS_1.png" /></p>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-openwrt%20ddns%e5%bc%80%e6%9c%ba%e5%90%af%e5%8a%a8%e5%a4%b1%e8%b4%a5%e9%97%ae%e9%a2%98-3">3. 参考资料<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%20ddns%e5%bc%80%e6%9c%ba%e5%90%af%e5%8a%a8%e5%a4%b1%e8%b4%a5%e9%97%ae%e9%a2%98-3" title="Permanent link">&para;</a></h2>
<p><a href="https://forum.openwrt.org/t/ddns-do-not-start-when-reboot/98374/17">https://forum.openwrt.org/t/ddns-do-not-start-when-reboot/98374/17</a></p>
<p><a href="https://forum.openwrt.org/t/ddns-do-not-start-when-reboot/98374/2">https://forum.openwrt.org/t/ddns-do-not-start-when-reboot/98374/2</a></p>
<p><a href="https://forum.openwrt.org/t/ddns-do-not-start-when-reboot/98374/2">https://forum.openwrt.org/t/ddns-do-not-start-when-reboot/98374/2</a></p>
<p><a href="https://forum.openwrt.org/t/ddns-auto-start-not-working/30866">https://forum.openwrt.org/t/ddns-auto-start-not-working/30866</a></p></section><section class="print-page" id="%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh" heading-number="6.3.4"><nav class='md-tags'><span class='md-tag'>OpenWrt</span><span class='md-tag'>AX9000</span></nav><h1 id="ax9000-ssh">小米 AX9000 解锁 SSH<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-ax9000-ssh" title="Permanent link">&para;</a></h1>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-1">1. 刷入小米开发版固件<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-1" title="Permanent link">&para;</a></h2>
<p>下载<a href="%E6%8A%98%E8%85%BELinux/OpenWrt/attachments/%E3%80%90%E5%AF%86%E7%A0%81%EF%BC%9AMiWiFi%E3%80%91MIWIFIRepairTool.x86.7z">小米路由器修复工具</a>和<a href="%E6%8A%98%E8%85%BELinux/OpenWrt/attachments/miwifi_ra70_all_develop_1.0.140.bin">小米路由器开发版固件 1.0.140</a>，进行刷机。下载地址也可在<a href="https://www.miwifi.com/miwifi_download.html">小米路由器官网</a>下载。</p>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-2-docker">2. 安装 docker<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-2-docker" title="Permanent link">&para;</a></h2>
<p>准备一个格式化成 ext4 格式且大于 64GB 的 U 盘，插入 AX9000，登录<a href="http://192.168.31.1">小米路由器后台</a>安装 docker 后安装管理插件。</p>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-3-busybox">3. 启动 busybox 容器<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-3-busybox" title="Permanent link">&para;</a></h2>
<p>使用安装好的 docker 启动 busybox 容器：</p>
<ul>
<li>Image: docker.io/busybox</li>
<li>Console: Interactive &amp; TTY</li>
<li>Advanced container settings:<ul>
<li>Volumes:<ul>
<li>container: /mnt, Bind</li>
<li>host: /, Writable</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>之后返回容器列表，点击 busybox 容器后回形针图标，进入容器。</p>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-4-chroot-ax9000-ssh">4. chroot 到 AX9000 并获取 SSH<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-4-chroot-ax9000-ssh" title="Permanent link">&para;</a></h2>
<p>在容器内执行：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>chroot<span class="w"> </span>/mnt
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>vi<span class="w"> </span>/etc/init.d/dropbear
</span></code></pre></div></td></tr></table></div>
<p>编辑 <code>/etc/init.d/dropbear</code> 注释以下几行：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-1-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>start_service<span class="o">()</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="o">{</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">        </span><span class="c1"># 稳定版不能打开ssh服务</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">        </span><span class="c1">#flg_ssh=`nvram get ssh_en`</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">        </span><span class="c1">#channel=`/sbin/uci get /usr/share/xiaoqiang/xiaoqiang_version.version.CHANNEL`</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">        </span><span class="c1">#if [ &quot;$flg_ssh&quot; != &quot;1&quot; -o &quot;$channel&quot; = &quot;release&quot; ]; then</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">        </span><span class="c1">#       return 0</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">        </span><span class="c1">#fi</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">        </span><span class="o">[</span><span class="w"> </span>-s<span class="w"> </span>/etc/dropbear/dropbear_rsa_host_key<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span>keygen
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">        </span>.<span class="w"> </span>/lib/functions.sh
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">        </span>.<span class="w"> </span>/lib/functions/network.sh
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14"></a>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">        </span>config_load<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">NAME</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">        </span>config_foreach<span class="w"> </span>dropbear_instance<span class="w"> </span>dropbear
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="o">}</span>
</span></code></pre></div></td></tr></table></div>
<p>启动 SSH 服务：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>/etc/init.d/dropbear<span class="w"> </span>start
</span></code></pre></div></td></tr></table></div>
<p>修改 root 密码：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>passwd<span class="w"> </span>root
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-5-ssh">5. 固化 SSH<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-5-ssh" title="Permanent link">&para;</a></h2>
<p>如果想让升级后依旧保留 SSH 权限，需要固化，固化直接使用这个工具即可：<a href="https://github.com/paldier/ax3600_tool">https://github.com/paldier/ax3600_tool</a></p>
<p>注意 AX9000 的 bdata 分区是 mtd18</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-10">10</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-11">11</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-12">12</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-13">13</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-14">14</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-15">15</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-16">16</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-17">17</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-18">18</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-19">19</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-20">20</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-21">21</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-22">22</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-23">23</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-24">24</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-25">25</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-26">26</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-27">27</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-28">28</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-29">29</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-30">30</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-31">31</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-4-32">32</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>root@XiaoQiang:~# cat /proc/mtd
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a>dev: size erasesize name
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a>mtd0: 00100000 00020000 &quot;0:SBL1&quot;
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a>mtd1: 00100000 00020000 &quot;0:MIBIB&quot;
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a>mtd2: 00080000 00020000 &quot;0:BOOTCONFIG&quot;
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a>mtd3: 00080000 00020000 &quot;0:BOOTCONFIG1&quot;
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a>mtd4: 00300000 00020000 &quot;0:QSEE&quot;
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a>mtd5: 00300000 00020000 &quot;0:QSEE_1&quot;
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a>mtd6: 00080000 00020000 &quot;0:DEVCFG&quot;
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a>mtd7: 00080000 00020000 &quot;0:DEVCFG_1&quot;
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11"></a>mtd8: 00080000 00020000 &quot;0:APDP&quot;
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12"></a>mtd9: 00080000 00020000 &quot;0:APDP_1&quot;
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13"></a>mtd10: 00080000 00020000 &quot;0:RPM&quot;
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14"></a>mtd11: 00080000 00020000 &quot;0:RPM_1&quot;
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15"></a>mtd12: 00080000 00020000 &quot;0:CDT&quot;
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16"></a>mtd13: 00080000 00020000 &quot;0:CDT_1&quot;
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17"></a>mtd14: 00080000 00020000 &quot;0:APPSBLENV&quot;
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18"></a>mtd15: 00100000 00020000 &quot;0:APPSBL_1&quot;
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19"></a>mtd16: 00100000 00020000 &quot;0:APPSBL&quot;
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20"></a>mtd17: 00080000 00020000 &quot;0:ART&quot;
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21"></a>mtd18: 00080000 00020000 &quot;bdata&quot;
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22"></a>mtd19: 00080000 00020000 &quot;crash&quot;
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23"></a>mtd20: 00080000 00020000 &quot;crash_syslog&quot;
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24"></a>mtd21: 03800000 00020000 &quot;rootfs&quot;
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25"></a>mtd22: 03800000 00020000 &quot;rootfs_1&quot;
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26"></a>mtd23: 00100000 00020000 &quot;cfg_bak&quot;
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27"></a>mtd24: 03d80000 00020000 &quot;overlay&quot;
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28"></a>mtd25: 04000000 00020000 &quot;mifw_bak&quot;
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29"></a>mtd26: 005ef000 0001f000 &quot;kernel&quot;
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30"></a>mtd27: 02283000 0001f000 &quot;ubi_rootfs&quot;
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31"></a>mtd28: 0087a000 0001f000 &quot;rootfs_data&quot;
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32"></a>mtd29: 03013000 0001f000 &quot;data&quot;
</span></code></pre></div></td></tr></table></div>
<p>所以备份命令是：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-__codelineno-5-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>nanddump<span class="w"> </span>-f<span class="w"> </span>/tmp/bdata_mtd18.img<span class="w"> </span>/dev/mtd18
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-6">6. 参考资料<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh-6" title="Permanent link">&para;</a></h2>
<p><a href="https://blog.nanpuyue.com/2022/056.html">https://blog.nanpuyue.com/2022/056.html</a></p></section><section class="print-page" id="%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%88%b7%e6%9c%ba" heading-number="6.3.5"><nav class='md-tags'><span class='md-tag'>OpenWrt</span><span class='md-tag'>AX9000</span></nav><h1 id="ax9000">小米 AX9000 刷机<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%88%b7%e6%9c%ba-ax9000" title="Permanent link">&para;</a></h1>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%88%b7%e6%9c%ba-1-rootfs">1. 确保小米固件在分区 rootfs 里<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%88%b7%e6%9c%ba-1-rootfs" title="Permanent link">&para;</a></h2>
<p>SSH 登录小米路由器，设置 env 保证小米固件在分区 rootfs 里，为下一部把 qsdk 刷到 rootfs_1 做准备：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%88%b7%e6%9c%ba-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%88%b7%e6%9c%ba-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%88%b7%e6%9c%ba-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%88%b7%e6%9c%ba-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%88%b7%e6%9c%ba-__codelineno-0-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>nvram<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">flag_last_success</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>nvram<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">flag_boot_rootfs</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a>nvram<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">flag_try_sys1_failed</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a>nvram<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">flag_try_sys2_failed</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a>nvram<span class="w"> </span>commit
</span></code></pre></div></td></tr></table></div>
<p>重启路由器：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%88%b7%e6%9c%ba-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>reboot
</span></code></pre></div></td></tr></table></div>
<h%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%88%b7%e6%9c%ba-2 id="%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%88%b7%e6%9c%ba-2">2. 刷写固件<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%88%b7%e6%9c%ba-2" title="Permanent link">&para;</a></h2>
<p>刷机固件为<a href="%E6%8A%98%E8%85%BELinux/OpenWrt/attachments/AX9000%E5%9B%BA%E4%BB%B6_20240929.7z">kiddin9 固件</a>， scp 把固件 kwrt-09.29.2024-ipq807x-generic-xiaomi_ax9000-squashfs-factory.ubi 传到路由器 tmp 目录，ssh 命令打以下命令：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%88%b7%e6%9c%ba-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%88%b7%e6%9c%ba-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%88%b7%e6%9c%ba-__codelineno-2-3">3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%88%b7%e6%9c%ba-__codelineno-2-4">4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%88%b7%e6%9c%ba-__codelineno-2-5">5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%88%b7%e6%9c%ba-__codelineno-2-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>.<span class="w"> </span>/lib/upgrade/platform.sh
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>switch_layout<span class="w"> </span>linux
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a>ubiformat<span class="w"> </span>/dev/mtd22<span class="w"> </span>-y<span class="w"> </span>-f<span class="w"> </span>/tmp/kwrt-09.29.2024-ipq807x-generic-xiaomi_ax9000-squashfs-factory.ubi
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a>nvram<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">flag_last_success</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a>nvram<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">flag_boot_rootfs</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a>nvram<span class="w"> </span>commit
</span></code></pre></div></td></tr></table></div>
<p>重启路由器：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%88%b7%e6%9c%ba-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>reboot
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%88%b7%e6%9c%ba-3">3. 参考资料<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%88%b7%e6%9c%ba-3" title="Permanent link">&para;</a></h2>
<p><a href="https://www.right.com.cn/forum/thread-5657691-1-1.html">https://www.right.com.cn/forum/thread-5657691-1-1.html</a></p>
<p><a href="https://www.right.com.cn/forum/thread-4875974-1-1.html">https://www.right.com.cn/forum/thread-4875974-1-1.html</a></p>
<p><a href="https://www.right.com.cn/forum/thread-8234200-1-1.html">https://www.right.com.cn/forum/thread-8234200-1-1.html</a></p>
<p><a href="https://mudew.com/2022/11/23/%E5%B0%8F%E7%B1%B3AX9000%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/">https://mudew.com/2022/11/23/%E5%B0%8F%E7%B1%B3AX9000%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/</a></p></section><section class="print-page" id="%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%8a%a0%e5%85%a5160mhz%e6%94%af%e6%8c%81" heading-number="6.3.6"><nav class='md-tags'><span class='md-tag'>OpenWrt</span><span class='md-tag'>AX9000</span></nav><h1 id="ax9000-160mhz">小米 AX9000 加入 160MHz 支持<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%8a%a0%e5%85%a5160mhz%e6%94%af%e6%8c%81-ax9000-160mhz" title="Permanent link">&para;</a></h1>
<p>备份准备替换的驱动</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%8a%a0%e5%85%a5160mhz%e6%94%af%e6%8c%81-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nb">cd</span><span class="w"> </span>/lib/firmware/ath11k/QCN9074/hw1.0<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>mv<span class="w"> </span>./board-2.bin<span class="w"> </span>./board-2.bin.bak
</span></code></pre></div></td></tr></table></div>
<p>将 <a href="%E6%8A%98%E8%85%BELinux/OpenWrt/attachments/generic-ax9000.tar.gz">generic-ax9000.tar.gz</a> 拷贝到 root 根目录</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%8a%a0%e5%85%a5160mhz%e6%94%af%e6%8c%81-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>mv<span class="w"> </span>generic-ax9000.tar.gz<span class="w"> </span>/
</span></code></pre></div></td></tr></table></div>
<p>进入根目录执行解压命令</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%8a%a0%e5%85%a5160mhz%e6%94%af%e6%8c%81-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nb">cd</span><span class="w"> </span>/<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>tar<span class="w"> </span>-xzvf<span class="w"> </span>generic-ax9000.tar.gz
</span></code></pre></div></td></tr></table></div>
<p>重启路由器，设置 160MHZ WIFI 信道，36,40,44,48,52,56,60 其中选一个</p>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%8a%a0%e5%85%a5160mhz%e6%94%af%e6%8c%81-1">1. 参考资料<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%8a%a0%e5%85%a5160mhz%e6%94%af%e6%8c%81-1" title="Permanent link">&para;</a></h2>
<p><a href="https://github.com/robimarko/openwrt/issues/84">https://github.com/robimarko/openwrt/issues/84</a></p>
<p><a href="https://forum.openwrt.org/t/openwrt-support-for-xiaomi-ax9000/98908/976">https://forum.openwrt.org/t/openwrt-support-for-xiaomi-ax9000/98908/976</a></p>
<p><a href="https://openwrt.org/toh/xiaomi/ax9000#potential_issueslimitations">https://openwrt.org/toh/xiaomi/ax9000#potential_issueslimitations</a></p>
<p><a href="https://www.right.com.cn/forum/thread-8354210-1-1.html">https://www.right.com.cn/forum/thread-8354210-1-1.html</a></p>
<p><a href="https://www.right.com.cn/forum/thread-8342494-1-1.html">https://www.right.com.cn/forum/thread-8342494-1-1.html</a></p></section><section class="print-page" id="%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2" heading-number="6.3.7"><nav class='md-tags'><span class='md-tag'>F4610U</span><span class='md-tag'>光猫破解</span><span class='md-tag'>宽带</span></nav><h1 id="f4610u">北京联通中兴 F4610U 光猫开超管界面<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-f4610u" title="Permanent link">&para;</a></h1>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-1">1. 降级固件<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-1" title="Permanent link">&para;</a></h2>
<p>从恩山论坛<a href="https://www.right.com.cn/forum/thread-8361606-1-1.html">北京联通光猫固件中兴 4610U_V1.2.0P1N20/N16 固件升降级及参数修改教程</a>下载固件，使用普通账号和密码登录 <a href="http://192.168.1.1">http://192.168.1.1</a> ，再浏览器复制粘贴这个地址：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>http://192.168.1.1/getpage.gch?pid=1001&amp;hidden=upgrade
</span></code></pre></div></td></tr></table></div>
<p>进入 <code>设备管理</code>-&gt;<code>设备管理</code>-&gt;<code>版本升级</code>。</p>
<p>先上传 <code>F4610U_V1.2.0P1N20_upgrade.bin</code> 文件进行升级，升级后光猫会重启，等待光猫重启完毕，再上传 <code>F4610U_V1.2.0P1N16_upgrade.bin</code> 文件进行降级。降级完成后，进入 <code>状态</code> -&gt; <code>设备信息</code> ，检查 <code>软件版本号</code> 为 <code>V1.2.0P1T1</code> 则降级成功。</p>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-2-telnet">2. 开启 telnet<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-2-telnet" title="Permanent link">&para;</a></h2>
<p>开启 Telnet 前，需要先拔掉光猫的光纤，之后用牙签捅 Reset 按钮，之后使用 <a href="https://github.com/douniwan5788/zte_modem_tools">zte_modem_tools</a> 开源项目：</p>
<div class="language-powershell highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="n">python</span> <span class="p">.\</span><span class="n">zte_factroymode</span><span class="p">.</span><span class="n">py</span> <span class="n">telnet</span>
</span></code></pre></div></td></tr></table></div>
<p>如果报错可重试，重试失败可尝试再次拔掉光纤用牙签捅 Reset 按钮，成功实例输出如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-2-21">21</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-2-22">22</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-2-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>PS C:\Users\hxp\Downloads\zte_modem_tools-main&gt; python .\zte_factroymode.py telnet
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>trying  user:&quot;factorymode&quot; pass:&quot;nE%jA@5b&quot;
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a>reset facTelnetSteps:
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a>reset OK!
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a>facStep 1:
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a>OK!
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a>facStep 2:
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10"></a>OK!
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11"></a>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12"></a>facStep 3:
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13"></a>OK!
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14"></a>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15"></a>facStep 4:
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16"></a>OK!
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17"></a>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18"></a>b&#39;FactoryMode.gch\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xd6`\xd0[1F\xb9\x87\x8f\xb5p/P\xd0\xab\x17&#39;
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19"></a>facStep 5:
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20"></a>OK!
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21"></a>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22"></a>b&#39;FactoryModeAuth.gch?user=H5nb40xW&amp;pass=T******3\x00&#39;
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23"></a>done
</span></code></pre></div></td></tr></table></div>
<p>这一步会生成随机用户名和密码（此用户名为 <code>H5nb40xW</code> 密码为 <code>T******3</code>），用 Telnet 进行连接：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-3-3">3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-3-4">4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-3-5">5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-3-6">6</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-3-7">7</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-3-8">8</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-3-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>F4610U
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a>Login: H5nb40xW
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a>Password:
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a>BusyBox v1.17.2 (2022-10-20 22:55:06 CST) built-in shell (ash)
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a>Enter &#39;help&#39; for a list of built-in commands.
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a>/ #
</span></code></pre></div></td></tr></table></div>
<p>如果需要开永久 telnet（密码 Zte521），运行：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-4-10">10</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-4-11">11</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-4-12">12</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-4-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>sendcmd 1 DB p TelnetCfg
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a>sendcmd 1 DB set TelnetCfg 0 Lan_Enable 1
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a>sendcmd 1 DB set TelnetCfg 0 TS_UName root
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a>sendcmd 1 DB set TelnetCfg 0 TSLan_UName root
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a>sendcmd 1 DB set TelnetCfg 0 TS_UPwd Zte521
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a>sendcmd 1 DB set TelnetCfg 0 TSLan_UPwd Zte521
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a>sendcmd 1 DB set TelnetCfg 0 Max_Con_Num 99
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a>sendcmd 1 DB set TelnetCfg 0 ExitTime 999999
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a>sendcmd 1 DB set TelnetCfg 0 InitSecLvl 3
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a>sendcmd 1 DB set TelnetCfg 0 CloseServerTime 9999999
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11"></a>sendcmd 1 DB set TelnetCfg 0 Lan_EnableAfterOlt 1
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12"></a>sendcmd 1 DB save
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13"></a>killall telnetd
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-3">3. 修改区域<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-3" title="Permanent link">&para;</a></h2>
<p>先查看区域代码：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-5-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>cat<span class="w"> </span>/etc/init.d/regioncode
</span></code></pre></div></td></tr></table></div>
<p>设定区域为河北省：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-6-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a>upgradetest<span class="w"> </span>sdefconf<span class="w"> </span><span class="m">322</span>
</span></code></pre></div></td></tr></table></div>
<p>成功后光猫输出 success 并自动重启：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-7-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-7-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-__codelineno-7-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a>&lt;a00002a025&gt;11930:43:45 [U_upgradetest][Crit] [upgrade_test.c(126)main] LOG_SEC: Upgradetest sdefconf!
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a>&lt;a00002a025&gt;11930:43:45 [U_upgradetest][Crit] [pon_upgrade_cma(480)CmDelCfgFile] LOG_SEC: Delete cfg file!
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a>success!
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-4">4. 使用超级管理员登录<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-4" title="Permanent link">&para;</a></h2>
<p>等光猫重启后，访问 <a href="http://192.168.1.1/cu.html">http://192.168.1.1/cu.html</a> ，使用 <code>cuadmin</code> 账号登录超级管理员。</p>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-5">5. 修改为桥接模式<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-5" title="Permanent link">&para;</a></h2>
<p>登录超级管理员界面后，进入 <code>基本配置</code> -&gt; <code>WAN连接</code> ，使用如下配置新建网络连接：</p>
<ul>
<li>连接名称：新建 WAN 连接</li>
<li>连接模式：桥接</li>
<li>VLAN 模式：改写(tag)</li>
<li>VLAN ID：3961</li>
<li>802.1p：0</li>
<li>使能 DSCP：否</li>
<li>DHCP 服务使能：否</li>
</ul>
<p>之后通过 OpenWrt 使用宽带账号密码拨号。</p>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-6">6. 参考资料<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2-6" title="Permanent link">&para;</a></h2>
<p><a href="https://www.bilibili.com/video/BV1W94y1t7cW/?vd_source=d266dd531d25724f221c1d5d3c3d2438">https://www.bilibili.com/video/BV1W94y1t7cW/?vd_source=d266dd531d25724f221c1d5d3c3d2438</a></p>
<p><a href="https://www.right.com.cn/forum/thread-8389711-1-1.html">https://www.right.com.cn/forum/thread-8389711-1-1.html</a></p>
<p><a href="https://www.right.com.cn/forum/thread-8389176-1-1.html">https://www.right.com.cn/forum/thread-8389176-1-1.html</a></p>
<p><a href="https://www.right.com.cn/forum/thread-8361606-1-1.html">https://www.right.com.cn/forum/thread-8361606-1-1.html</a></p></section><section class="print-page" id="%e6%8a%98%e8%85%belinux-openwrt-openwrt%e4%bf%ae%e6%94%b9%e9%bb%98%e8%ae%a4shell%e4%b8%babash%e5%b9%b6%e5%bc%80%e5%90%af%e5%8e%86%e5%8f%b2%e5%91%bd%e4%bb%a4%e6%97%b6%e9%97%b4%e6%88%b3" heading-number="6.3.8"><nav class='md-tags'><span class='md-tag'>OpenWrt</span><span class='md-tag'>DDNS</span></nav><h1 id="openwrt-shell-bash">OpenWrt 修改默认 Shell 为 bash 并开启历史命令时间戳<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e4%bf%ae%e6%94%b9%e9%bb%98%e8%ae%a4shell%e4%b8%babash%e5%b9%b6%e5%bc%80%e5%90%af%e5%8e%86%e5%8f%b2%e5%91%bd%e4%bb%a4%e6%97%b6%e9%97%b4%e6%88%b3-openwrt-shell-bash" title="Permanent link">&para;</a></h1>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-openwrt%e4%bf%ae%e6%94%b9%e9%bb%98%e8%ae%a4shell%e4%b8%babash%e5%b9%b6%e5%bc%80%e5%90%af%e5%8e%86%e5%8f%b2%e5%91%bd%e4%bb%a4%e6%97%b6%e9%97%b4%e6%88%b3-1-bash">1. 安装并配置 bash<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e4%bf%ae%e6%94%b9%e9%bb%98%e8%ae%a4shell%e4%b8%babash%e5%b9%b6%e5%bc%80%e5%90%af%e5%8e%86%e5%8f%b2%e5%91%bd%e4%bb%a4%e6%97%b6%e9%97%b4%e6%88%b3-1-bash" title="Permanent link">&para;</a></h2>
<p>安装 bash</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e4%bf%ae%e6%94%b9%e9%bb%98%e8%ae%a4shell%e4%b8%babash%e5%b9%b6%e5%bc%80%e5%90%af%e5%8e%86%e5%8f%b2%e5%91%bd%e4%bb%a4%e6%97%b6%e9%97%b4%e6%88%b3-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>opkg<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>opkg<span class="w"> </span>install<span class="w"> </span>bash
</span></code></pre></div></td></tr></table></div>
<p>检查 <code>/etc/shells</code> 中有 <code>/bin/bash</code> 后，修改 root 用户的 shell 解释器，编辑 <code>/etc/passwd</code> 文件，修改第一行（第一行就是 root 用户）中的 <code>/bin/ash</code> ，改成 <code>/bin/bash</code> ，重启路由器。</p>
<h%e6%8a%98%e8%85%belinux-openwrt-openwrt%e4%bf%ae%e6%94%b9%e9%bb%98%e8%ae%a4shell%e4%b8%babash%e5%b9%b6%e5%bc%80%e5%90%af%e5%8e%86%e5%8f%b2%e5%91%bd%e4%bb%a4%e6%97%b6%e9%97%b4%e6%88%b3-2 id="%e6%8a%98%e8%85%belinux-openwrt-openwrt%e4%bf%ae%e6%94%b9%e9%bb%98%e8%ae%a4shell%e4%b8%babash%e5%b9%b6%e5%bc%80%e5%90%af%e5%8e%86%e5%8f%b2%e5%91%bd%e4%bb%a4%e6%97%b6%e9%97%b4%e6%88%b3-2">2. 配置命令时间戳记录<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e4%bf%ae%e6%94%b9%e9%bb%98%e8%ae%a4shell%e4%b8%babash%e5%b9%b6%e5%bc%80%e5%90%af%e5%8e%86%e5%8f%b2%e5%91%bd%e4%bb%a4%e6%97%b6%e9%97%b4%e6%88%b3-2" title="Permanent link">&para;</a></h2>
<p>新建配置 <code>/etc/profile.d/history.sh</code> ：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e4%bf%ae%e6%94%b9%e9%bb%98%e8%ae%a4shell%e4%b8%babash%e5%b9%b6%e5%bc%80%e5%90%af%e5%8e%86%e5%8f%b2%e5%91%bd%e4%bb%a4%e6%97%b6%e9%97%b4%e6%88%b3-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e4%bf%ae%e6%94%b9%e9%bb%98%e8%ae%a4shell%e4%b8%babash%e5%b9%b6%e5%bc%80%e5%90%af%e5%8e%86%e5%8f%b2%e5%91%bd%e4%bb%a4%e6%97%b6%e9%97%b4%e6%88%b3-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e4%bf%ae%e6%94%b9%e9%bb%98%e8%ae%a4shell%e4%b8%babash%e5%b9%b6%e5%bc%80%e5%90%af%e5%8e%86%e5%8f%b2%e5%91%bd%e4%bb%a4%e6%97%b6%e9%97%b4%e6%88%b3-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e4%bf%ae%e6%94%b9%e9%bb%98%e8%ae%a4shell%e4%b8%babash%e5%b9%b6%e5%bc%80%e5%90%af%e5%8e%86%e5%8f%b2%e5%91%bd%e4%bb%a4%e6%97%b6%e9%97%b4%e6%88%b3-__codelineno-1-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">PROMPT_COMMAND</span><span class="o">=</span><span class="s1">&#39;history -a&#39;</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">HISTTIMEFORMAT</span><span class="o">=</span><span class="s2">&quot;[ %F %T ] (</span><span class="nv">$USER</span><span class="s2">) || &quot;</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="nb">export</span><span class="w"> </span><span class="nv">HISTFILESIZE</span><span class="o">=</span><span class="m">100000</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="nb">export</span><span class="w"> </span><span class="nv">HISTSIZE</span><span class="o">=</span><span class="m">100000</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-openwrt-openwrt%e4%bf%ae%e6%94%b9%e9%bb%98%e8%ae%a4shell%e4%b8%babash%e5%b9%b6%e5%bc%80%e5%90%af%e5%8e%86%e5%8f%b2%e5%91%bd%e4%bb%a4%e6%97%b6%e9%97%b4%e6%88%b3-3">3. 参考资料<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-openwrt-openwrt%e4%bf%ae%e6%94%b9%e9%bb%98%e8%ae%a4shell%e4%b8%babash%e5%b9%b6%e5%bc%80%e5%90%af%e5%8e%86%e5%8f%b2%e5%91%bd%e4%bb%a4%e6%97%b6%e9%97%b4%e6%88%b3-3" title="Permanent link">&para;</a></h2>
<p><a href="https://hellodk.cn/post/472">https://hellodk.cn/post/472</a></p></section></section>
                    <section class='print-page md-section' id='section-6-4' heading-number='6.4'>
                        <h1>Ubuntu<a class='headerlink' href='#section-6-4' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="%e6%8a%98%e8%85%belinux-ubuntu-ubuntu%e5%ae%89%e8%a3%85hyper-v%e5%b7%a5%e5%85%b7" heading-number="6.4.1"><nav class='md-tags'><span class='md-tag'>Ubuntu</span><span class='md-tag'>Linux</span><span class='md-tag'>Hyper-V</span></nav><h1 id="ubuntu-hyper-v">Ubuntu 安装 Hyper-V 工具<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-ubuntu-ubuntu%e5%ae%89%e8%a3%85hyper-v%e5%b7%a5%e5%85%b7-ubuntu-hyper-v" title="Permanent link">&para;</a></h1>
<p>在 Hyper-V 上默认安装好的 Ubuntu Server 后，如果虚拟机使用的 IP 地址不是 Hyper-V 分配，这里不显示：</p>
<p><img alt="" src="%E6%8A%98%E8%85%BELinux/Ubuntu/images/ubuntu_hyper-v.png" /></p>
<p>解决方法：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-ubuntu-ubuntu%e5%ae%89%e8%a3%85hyper-v%e5%b7%a5%e5%85%b7-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>sudo apt-get install &quot;linux-cloud-tools-$(uname -r)&quot;
</span></code></pre></div></td></tr></table></div>
<p>这样就能安装 Hyper-V 的相关服务（需重启生效）。</p></section></section>
                    <section class='print-page md-section' id='section-6-5' heading-number='6.5'>
                        <h1>RHEL6<a class='headerlink' href='#section-6-5' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="%e6%8a%98%e8%85%belinux-rhel6-%e8%ae%b0%e6%9f%90%e6%ac%a1%e8%af%af%e6%93%8d%e4%bd%9cyum%20update%e5%90%8ejboss%e5%ba%94%e7%94%a8%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%8f%8a%e9%87%8d%e5%90%af%e6%97%a0%e6%b3%95%e8%af%86%e5%88%abvg%e9%97%ae%e9%a2%98" heading-number="6.5.1"><nav class='md-tags'><span class='md-tag'>RHEL6</span><span class='md-tag'>Linux</span></nav><h1 id="yum-update-jboss-vg">记某次误操作 yum update 后 jboss 应用无法启动及重启无法识别 vg 问题<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-rhel6-%e8%ae%b0%e6%9f%90%e6%ac%a1%e8%af%af%e6%93%8d%e4%bd%9cyum%20update%e5%90%8ejboss%e5%ba%94%e7%94%a8%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%8f%8a%e9%87%8d%e5%90%af%e6%97%a0%e6%b3%95%e8%af%86%e5%88%abvg%e9%97%ae%e9%a2%98-yum-update-jboss-vg" title="Permanent link">&para;</a></h1>
<h2 id="%e6%8a%98%e8%85%belinux-rhel6-%e8%ae%b0%e6%9f%90%e6%ac%a1%e8%af%af%e6%93%8d%e4%bd%9cyum%20update%e5%90%8ejboss%e5%ba%94%e7%94%a8%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%8f%8a%e9%87%8d%e5%90%af%e6%97%a0%e6%b3%95%e8%af%86%e5%88%abvg%e9%97%ae%e9%a2%98-1">1. 问题描述<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-rhel6-%e8%ae%b0%e6%9f%90%e6%ac%a1%e8%af%af%e6%93%8d%e4%bd%9cyum%20update%e5%90%8ejboss%e5%ba%94%e7%94%a8%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%8f%8a%e9%87%8d%e5%90%af%e6%97%a0%e6%b3%95%e8%af%86%e5%88%abvg%e9%97%ae%e9%a2%98-1" title="Permanent link">&para;</a></h2>
<p>在一次开启 kdump 的操作中，因为误操作导致执行了 <code>yum update -y</code> ，即使在中途被发现后按 Ctrl-C 退出，但是还是有部分软件包被升级。误操作当时，内核和 java 等组件被升级，且当晚进行了修改 grub 的操作使得重启后依旧进入旧内核。</p>
<p>但是后续发现 jboss 在重启后，jboss 能启动但是 jboss 的应用无法启动，报错为国密证书无法加载。且在重启后报错找不到逻辑卷。</p>
<h%e6%8a%98%e8%85%belinux-rhel6-%e8%ae%b0%e6%9f%90%e6%ac%a1%e8%af%af%e6%93%8d%e4%bd%9cyum%20update%e5%90%8ejboss%e5%ba%94%e7%94%a8%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%8f%8a%e9%87%8d%e5%90%af%e6%97%a0%e6%b3%95%e8%af%86%e5%88%abvg%e9%97%ae%e9%a2%98-2 id="%e6%8a%98%e8%85%belinux-rhel6-%e8%ae%b0%e6%9f%90%e6%ac%a1%e8%af%af%e6%93%8d%e4%bd%9cyum%20update%e5%90%8ejboss%e5%ba%94%e7%94%a8%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%8f%8a%e9%87%8d%e5%90%af%e6%97%a0%e6%b3%95%e8%af%86%e5%88%abvg%e9%97%ae%e9%a2%98-2">2. 问题解决过程<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-rhel6-%e8%ae%b0%e6%9f%90%e6%ac%a1%e8%af%af%e6%93%8d%e4%bd%9cyum%20update%e5%90%8ejboss%e5%ba%94%e7%94%a8%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%8f%8a%e9%87%8d%e5%90%af%e6%97%a0%e6%b3%95%e8%af%86%e5%88%abvg%e9%97%ae%e9%a2%98-2" title="Permanent link">&para;</a></h2>
<h3 id="%e6%8a%98%e8%85%belinux-rhel6-%e8%ae%b0%e6%9f%90%e6%ac%a1%e8%af%af%e6%93%8d%e4%bd%9cyum%20update%e5%90%8ejboss%e5%ba%94%e7%94%a8%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%8f%8a%e9%87%8d%e5%90%af%e6%97%a0%e6%b3%95%e8%af%86%e5%88%abvg%e9%97%ae%e9%a2%98-21-jboss">2.1 jboss 应用无法启动<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-rhel6-%e8%ae%b0%e6%9f%90%e6%ac%a1%e8%af%af%e6%93%8d%e4%bd%9cyum%20update%e5%90%8ejboss%e5%ba%94%e7%94%a8%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%8f%8a%e9%87%8d%e5%90%af%e6%97%a0%e6%b3%95%e8%af%86%e5%88%abvg%e9%97%ae%e9%a2%98-21-jboss" title="Permanent link">&para;</a></h3>
<p>经过和正常节点的对比，jboss 无法启动可能是由于 java 被升级导致，进行了 java 的降级（降级需要将系统的 YUM 源修改到 RHEL6.4 的 YUM 源）：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-rhel6-%e8%ae%b0%e6%9f%90%e6%ac%a1%e8%af%af%e6%93%8d%e4%bd%9cyum%20update%e5%90%8ejboss%e5%ba%94%e7%94%a8%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%8f%8a%e9%87%8d%e5%90%af%e6%97%a0%e6%b3%95%e8%af%86%e5%88%abvg%e9%97%ae%e9%a2%98-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-rhel6-%e8%ae%b0%e6%9f%90%e6%ac%a1%e8%af%af%e6%93%8d%e4%bd%9cyum%20update%e5%90%8ejboss%e5%ba%94%e7%94%a8%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%8f%8a%e9%87%8d%e5%90%af%e6%97%a0%e6%b3%95%e8%af%86%e5%88%abvg%e9%97%ae%e9%a2%98-__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>yum install java-1.7.0-openjdk-1.7.0.9-2.3.4.1.el6_3
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>yum reinstall java-1.7.0-openjdk-1.7.0.9-2.3.4.1.el6_3
</span></code></pre></div></td></tr></table></div>
<p>经过 java 的降级后，jboss 应用无法启动问题被解决。</p>
<h3 id="%e6%8a%98%e8%85%belinux-rhel6-%e8%ae%b0%e6%9f%90%e6%ac%a1%e8%af%af%e6%93%8d%e4%bd%9cyum%20update%e5%90%8ejboss%e5%ba%94%e7%94%a8%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%8f%8a%e9%87%8d%e5%90%af%e6%97%a0%e6%b3%95%e8%af%86%e5%88%abvg%e9%97%ae%e9%a2%98-22-var-tmp">2.2 系统重启后报错 /var 目录和 /tmp 目录疑似损坏<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-rhel6-%e8%ae%b0%e6%9f%90%e6%ac%a1%e8%af%af%e6%93%8d%e4%bd%9cyum%20update%e5%90%8ejboss%e5%ba%94%e7%94%a8%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%8f%8a%e9%87%8d%e5%90%af%e6%97%a0%e6%b3%95%e8%af%86%e5%88%abvg%e9%97%ae%e9%a2%98-22-var-tmp" title="Permanent link">&para;</a></h3>
<p>后续又发现在重启后，由于 RHEL6 的 /etc/fstab 默认配置启动时 fsck ，fsck 报错 /var 和 /tmp 损坏。在系统进入 enmergency shell 后，输入 root 密码，首先尝试使用 <code>lvm lvs</code> 命令检查逻辑卷是否还在，发现报错：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-rhel6-%e8%ae%b0%e6%9f%90%e6%ac%a1%e8%af%af%e6%93%8d%e4%bd%9cyum%20update%e5%90%8ejboss%e5%ba%94%e7%94%a8%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%8f%8a%e9%87%8d%e5%90%af%e6%97%a0%e6%b3%95%e8%af%86%e5%88%abvg%e9%97%ae%e9%a2%98-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>File-based locking initialisation failed
</span></code></pre></div></td></tr></table></div>
<p>查询文档得知，此报错是由于 <code>/var/lock/lvm</code> 目录无法写入导致。根本原因为在 emergency shell 中，根目录是以只读的方式挂载的，需要重新挂载为读写：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-rhel6-%e8%ae%b0%e6%9f%90%e6%ac%a1%e8%af%af%e6%93%8d%e4%bd%9cyum%20update%e5%90%8ejboss%e5%ba%94%e7%94%a8%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%8f%8a%e9%87%8d%e5%90%af%e6%97%a0%e6%b3%95%e8%af%86%e5%88%abvg%e9%97%ae%e9%a2%98-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>mount -o remount,rw /
</span></code></pre></div></td></tr></table></div>
<p>之后发现 <code>lvs</code> 命令正常，但是所有逻辑卷都没有 activate ，且运行此命令可以 activate 所有逻辑卷：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-rhel6-%e8%ae%b0%e6%9f%90%e6%ac%a1%e8%af%af%e6%93%8d%e4%bd%9cyum%20update%e5%90%8ejboss%e5%ba%94%e7%94%a8%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%8f%8a%e9%87%8d%e5%90%af%e6%97%a0%e6%b3%95%e8%af%86%e5%88%abvg%e9%97%ae%e9%a2%98-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>vgchange -ay rootvg
</span></code></pre></div></td></tr></table></div>
<p>之后排查文件系统损坏问题，尝试使用 <code>e2fsck</code> 命令修复文件系统：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-rhel6-%e8%ae%b0%e6%9f%90%e6%ac%a1%e8%af%af%e6%93%8d%e4%bd%9cyum%20update%e5%90%8ejboss%e5%ba%94%e7%94%a8%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%8f%8a%e9%87%8d%e5%90%af%e6%97%a0%e6%b3%95%e8%af%86%e5%88%abvg%e9%97%ae%e9%a2%98-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-rhel6-%e8%ae%b0%e6%9f%90%e6%ac%a1%e8%af%af%e6%93%8d%e4%bd%9cyum%20update%e5%90%8ejboss%e5%ba%94%e7%94%a8%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%8f%8a%e9%87%8d%e5%90%af%e6%97%a0%e6%b3%95%e8%af%86%e5%88%abvg%e9%97%ae%e9%a2%98-__codelineno-4-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>e2fsck /dev/rootvg/lv_var
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a>e2fsck /dev/rootvg/lv_tmp
</span></code></pre></div></td></tr></table></div>
<p>但是发现文件系统没有损坏。重启以后，故障没有恢复，依旧是找不到除了根目录和 swap 以外所有逻辑卷。经过仔细分析系统启动时挂载逻辑卷的原理为执行 <code>/etc/rc.sysinit</code> 脚本中有一句 vgchange 命令激活逻辑卷。猜测是此命令没有正确执行导致，因为进入 emergency shell 的现象就是 vg 没有激活，且根目录和 swap 被激活。仔细和正常的机器进行对比，得出解决方案如下：</p>
<p>修改 <code>/etc/rc.sysinit</code> ，将：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-rhel6-%e8%ae%b0%e6%9f%90%e6%ac%a1%e8%af%af%e6%93%8d%e4%bd%9cyum%20update%e5%90%8ejboss%e5%ba%94%e7%94%a8%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%8f%8a%e9%87%8d%e5%90%af%e6%97%a0%e6%b3%95%e8%af%86%e5%88%abvg%e9%97%ae%e9%a2%98-__codelineno-5-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>action $&quot;Setting up Logical Volume Management:&quot; /sbin/lvm vgchange -a ay --sysinit --ignoreskippedcluster
</span></code></pre></div></td></tr></table></div>
<p>修改为：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-rhel6-%e8%ae%b0%e6%9f%90%e6%ac%a1%e8%af%af%e6%93%8d%e4%bd%9cyum%20update%e5%90%8ejboss%e5%ba%94%e7%94%a8%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%8f%8a%e9%87%8d%e5%90%af%e6%97%a0%e6%b3%95%e8%af%86%e5%88%abvg%e9%97%ae%e9%a2%98-__codelineno-6-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a>action $&quot;Setting up Logical Volume Management:&quot; /sbin/lvm vgchange -a ay --sysinit
</span></code></pre></div></td></tr></table></div>
<p>问题的根本原因，猜测为 <code>yum update -y</code> 升级了 <code>/etc/rc.sysinit</code> 但是没有升级 lvm ，或者升级 lvm 的过程中被终止，导致 <code>/etc/rc.sysinit</code> 被更新加入了 <code>--ignoreskippedcluster</code> 参数，但是 vgchange 命令和 lvm 没有被更新。实际在机器上实行 <code>/sbin/lvm vgchange -a ay --sysinit --ignoreskippedcluster</code> 报错信息为“参数 --ignoreskippedcluster 未知”也印证了这一点。</p>
<h2 id="%e6%8a%98%e8%85%belinux-rhel6-%e8%ae%b0%e6%9f%90%e6%ac%a1%e8%af%af%e6%93%8d%e4%bd%9cyum%20update%e5%90%8ejboss%e5%ba%94%e7%94%a8%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%8f%8a%e9%87%8d%e5%90%af%e6%97%a0%e6%b3%95%e8%af%86%e5%88%abvg%e9%97%ae%e9%a2%98-3">3. 参考文献<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-rhel6-%e8%ae%b0%e6%9f%90%e6%ac%a1%e8%af%af%e6%93%8d%e4%bd%9cyum%20update%e5%90%8ejboss%e5%ba%94%e7%94%a8%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%8f%8a%e9%87%8d%e5%90%af%e6%97%a0%e6%b3%95%e8%af%86%e5%88%abvg%e9%97%ae%e9%a2%98-3" title="Permanent link">&para;</a></h2>
<p><a href="https://access.redhat.com/solutions/47028">https://access.redhat.com/solutions/47028</a></p>
<p><a href="https://access.redhat.com/solutions/22545">https://access.redhat.com/solutions/22545</a></p></section></section>
                    <section class='print-page md-section' id='section-6-6' heading-number='6.6'>
                        <h1>中标麒麟V7<a class='headerlink' href='#section-6-6' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88" heading-number="6.6.1"><nav class='md-tags'><span class='md-tag'>中标麒麟V7</span><span class='md-tag'>Linux</span></nav><h1 id="raid">曙光服务器装机无 RAID 卡驱动导致不能识别硬盘问题分析与解决方案<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-raid" title="Permanent link">&para;</a></h1>
<h2 id="%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-1">1. 问题的初步定位<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-1" title="Permanent link">&para;</a></h2>
<p>2022 年曙光服务器装机时找不到硬盘，但是老的曙光服务器可以找到硬盘，之前的解决方法是挂载一个 DUD（Driver Update Disk）光盘的 ISO 镜像，DUD 盘里有 RAID 卡驱动（rpm 包形式的驱动），安装时检测到 DUD 盘现场安装驱动，并在装新系统时也安装 DUD 盘内的驱动。</p>
<p>这是命令 modinfo megaraid_sas 在装机不挂 DUD 镜像时的输出，可以看出 magaraid_sas 驱动的版本比较低，驱动厂商为 Avago：</p>
<p><img alt="2a0527997c7166e7e9abe9b312dfe612.png" src="%E6%8A%98%E8%85%BELinux/%E4%B8%AD%E6%A0%87%E9%BA%92%E9%BA%9FV7/images/a6fbfdb2491a46628c5594452f35b85e.png" /></p>
<p>这个是装好的服务器的 megaraid_sas 驱动的信息，驱动版本高，而且厂商为 Boardcom（Avago 收购 Boardcom 后改了公司的名字为 Boardcom，因此 Boradcom 和 Avago 是一个公司）：</p>
<p><img alt="d44861c01d811f0242334555572fe97d.png" src="%E6%8A%98%E8%85%BELinux/%E4%B8%AD%E6%A0%87%E9%BA%92%E9%BA%9FV7/images/5207e9a232d9444d9d57f77fae9d791a.png" /></p>
<p>因此，新版曙光服务器找不到驱动的原因为：新版曙光服务器升级了 RAID 卡到新的版本，但是麒麟 7.6 的安装镜像里的驱动是老版本驱动。解决方案是升级安装镜像里的 megaraid_sas 驱动程序。</p>
<p>同时，观察没有挂载 DUD 盘时，安装光盘里的 Linux 可以正常启动，可以加载内核和 initramfs ，initramfs 可以挂载 squashfs，从而把镜像内的操作系统启动起来。但是镜像内操作系统启动完成后，megaraid_sas 驱动程序版本低，无法驱动高版本的 RAID 卡。因此需要升级的是 squashfs 内的 RAID 卡驱动。</p>
<h2 id="%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-2-squashfs">2. 修改装机镜像中 squashfs 并加入新版驱动<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-2-squashfs" title="Permanent link">&para;</a></h2>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>以下过程需要用 root 用户操作</p>
</div>
<p>squashfs 位于安装光盘的 LiveOS 目录下，先把它移动出来：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-0-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>mkdir /root/squashfs-edit
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>mv LiveOS/squashfs.img /root/squashfs-edit/
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a>cd /root/squashfs-edit/
</span></code></pre></div></td></tr></table></div>
<p>解压 squashfs：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>unsquashfs squashfs.img
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-2-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>Parallel unsquashfs: Using 8 processors
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>1 inodes (16384 blocks) to write
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a>[============================================================-] 16384/16384 100%
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a>created 1 files
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a>created 2 directories
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a>created 0 symlinks
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a>created 0 devices
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10"></a>created 0 fifos
</span></code></pre></div></td></tr></table></div>
<p>解压完成后的目录结构为：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>tree .
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-4-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-4-3">3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-4-4">4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-4-5">5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-4-6">6</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-4-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>.
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a>├── squashfs.img
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a>└── squashfs-root
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a>    └── LiveOS
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a>        └── rootfs.img
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a>2 directories, 2 files
</span></code></pre></div></td></tr></table></div>
<p>发现 rootfs.img 是一个 ext4 文件系统：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-5-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>file squashfs-root/LiveOS/rootfs.img
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-6-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a>squashfs-root/LiveOS/rootfs.img: Linux rev 1.0 ext4 filesystem data, UUID=921b7a3a-746d-405e-af58-cb96cb700222, volume name &quot;Anaconda&quot; (extents) (64bit) (huge files)
</span></code></pre></div></td></tr></table></div>
<p>将这个 rootfs.img 上传到安装了海光版本的麒麟 7.6 系统的机器上（可以是办公电脑开的 KVM 虚拟机），并挂载：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-7-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-7-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-7-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a>mkdir /root/rootfs
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a>mount rootfs.img /root/rootfs/
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a>ls /root/rootfs/
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-8-10">10</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-8-11">11</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-8-12">12</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-8-13">13</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-8-14">14</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-8-15">15</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-8-16">16</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-8-17">17</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-8-18">18</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-8-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a>total 27K
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a>lrwxrwxrwx.  1 root root    7 Oct 13  2019 bin -&gt; usr/bin
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a>dr-xr-xr-x.  2 root root 1.0K Oct 13  2019 boot
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a>drwxr-xr-x   2 root root 1.0K Oct 13  2019 dev
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5"></a>drwxr-xr-x. 92 root root 5.0K Oct 13  2019 etc
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6"></a>lrwxrwxrwx.  1 root root   12 Oct 13  2019 firmware -&gt; lib/firmware
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7"></a>lrwxrwxrwx.  1 root root    7 Oct 13  2019 lib -&gt; usr/lib
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8"></a>lrwxrwxrwx.  1 root root    9 Oct 13  2019 lib64 -&gt; usr/lib64
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9"></a>drwx------.  2 root root  12K Oct 13  2019 lost+found
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10"></a>drwxr-xr-x.  2 root root 1.0K Oct 13  2019 mnt
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11"></a>lrwxrwxrwx.  1 root root   11 Oct 13  2019 modules -&gt; lib/modules
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12"></a>dr-xr-xr-x   2 root root 1.0K Apr 11  2018 proc
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13"></a>dr-xr-x---.  2 root root 1.0K Oct 13  2019 root
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14"></a>drwxr-xr-x. 16 root root 1.0K Oct 13  2019 run
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15"></a>lrwxrwxrwx.  1 root root    8 Oct 13  2019 sbin -&gt; usr/sbin
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16"></a>dr-xr-xr-x   2 root root 1.0K Apr 11  2018 sys
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17"></a>drwxrwxrwt.  7 root root 1.0K Oct 13  2019 tmp
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18"></a>drwxr-xr-x. 10 root root 1.0K Oct 13  2019 usr
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19"></a>drwxr-xr-x. 10 root root 1.0K Oct 13  2019 var
</span></code></pre></div></td></tr></table></div>
<p>之后用新版 megaraid_sas 驱动替换掉老版本驱动（如果驱动是 ko 结尾的，用 xz 命令压缩下）：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-9-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-9-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a>xz megaraid_sas.ko
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2"></a>cp megaraid_sas.ko.xz /root/rootfs/usr/lib/modules/3.10.0-957.el7.hg.3.x86_64/kernel/drivers/scsi/megaraid/megaraid_sas.ko.xz
</span></code></pre></div></td></tr></table></div>
<p>替换完成后，chroot 进去:</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-10-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a>chroot /root/rootfs
</span></code></pre></div></td></tr></table></div>
<p>运行 depmod 来重建内核模块的依赖关系：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-11-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a>depmod -v
</span></code></pre></div></td></tr></table></div>
<p>新建配置文件 <code>/etc/modules-load.d/megaraid_sas.conf</code> ,使得开机加载 megaraid_sas 驱动:</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-12-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a>echo megaraid_sas &gt; /etc/modules-load.d/megaraid_sas.conf
</span></code></pre></div></td></tr></table></div>
<p>完成修改后退出 chroot ,卸载 rootfs：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-13-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-13-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a>exit
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2"></a>umount /root/rootfs
</span></code></pre></div></td></tr></table></div>
<p>把 rootfs.img 替换为新的 rootfs.img 后，用以下命令重新封装 squashfs：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-14-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a>mksquashfs squashfs-root/ squashfs.img.new -noappend -always-use-fragments
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-1"> 1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-2"> 2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-3"> 3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-4"> 4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-5"> 5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-6"> 6</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-7"> 7</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-8"> 8</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-9"> 9</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-10">10</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-11">11</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-12">12</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-13">13</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-14">14</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-15">15</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-16">16</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-17">17</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-18">18</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-19">19</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-20">20</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-21">21</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-22">22</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-23">23</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-24">24</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-25">25</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-26">26</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-15-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1"></a>Parallel mksquashfs: Using 8 processors
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2"></a>Creating 4.0 filesystem on squashfs.img.new, block size 131072.
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3"></a>[============================================================|] 16384/16384 100%
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4"></a>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5"></a>Exportable Squashfs 4.0 filesystem, gzip compressed, data block size 131072
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6"></a>    compressed data, compressed metadata, compressed fragments, compressed xattrs
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7"></a>    duplicates are removed
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8"></a>Filesystem size 521989.16 Kbytes (509.76 Mbytes)
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9"></a>    24.89% of uncompressed filesystem size (2097216.30 Kbytes)
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10"></a>Inode table size 30526 bytes (29.81 Kbytes)
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11"></a>    46.50% of uncompressed inode table size (65650 bytes)
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12"></a>Directory table size 48 bytes (0.05 Kbytes)
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13"></a>    82.76% of uncompressed directory table size (58 bytes)
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14"></a>Number of duplicate files found 0
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15"></a>Number of inodes 3
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16"></a>Number of files 1
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17"></a>Number of fragments 0
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18"></a>Number of symbolic links  0
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19"></a>Number of device nodes 0
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20"></a>Number of fifo nodes 0
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21"></a>Number of socket nodes 0
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22"></a>Number of directories 2
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23"></a>Number of ids (unique uids + gids) 1
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24"></a>Number of uids 1
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25"></a>    root (0)
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26"></a>Number of gids 1
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27"></a>    root (0)
</span></code></pre></div></td></tr></table></div>
<p>用新生成的 squashfs.img.new 替换掉老的 squashfs，然后重新制作成装机镜像即可。同时，为了确保驱动程序能被加载，可以在 kickstart 文件中，分盘之前，插入：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-16-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-16-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-16-3">3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-16-4">4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-16-5">5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-16-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1"></a># Load Boardcom RAID card driver
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2"></a>%pre
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3"></a>set -x
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4"></a>modprobe megaraid_sas
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5"></a>sleep 10
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6"></a>%end
</span></code></pre></div></td></tr></table></div>
<p>来强制加载 megaraid_sas 驱动。也需要在 kickstart 中设置机器装完系统后，额外安装 megaraid_sas 驱动到新系统，把 DUD 光盘放到 extend/megaraid9560_v7.iso，然后在%post --nochroot 中加入：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-17-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-17-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-17-3">3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-17-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1"></a># Copy Boardcom RAID driver installation disk
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2"></a>echo &quot;Copying megaraid9560_v7.iso to /root ...&quot;
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3"></a>curl --connect-timeout 5 -o /mnt/sysimage/root/megaraid9560_v7.iso http://osinstall.pxe/kylin/v7-hygon/os/x86_64/extend/megaraid9560_v7.iso
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4"></a>cp /run/install/repo/extend/megaraid9560_v7.iso /mnt/sysimage/root/
</span></code></pre></div></td></tr></table></div>
<p>还需要在装机后运行脚本 %post 中加入：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-18-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-18-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-__codelineno-18-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1"></a>echo &quot;Installing Boardcom RAID card driver ...&quot;
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2"></a>mount /root/megaraid9560_v7.iso /mnt
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3"></a>cd /mnt/rpms/x86_64 &amp;&amp; rpm -ivh kmod-megaraid_sas-07.720.04.00-1.x86_64.rpm
</span></code></pre></div></td></tr></table></div>
<p>来确保装机后 kickstart 会安装新版本驱动到装好后的系统。</p></section><section class="print-page" id="%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e8%81%94%e6%83%b3%e7%89%a9%e7%90%86%e6%9c%bapxe%e8%a3%85%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9c%e6%a0%b9%e5%88%86%e5%8c%ba%e6%89%be%e4%b8%8d%e5%88%b0%e2%80%9d%e5%8e%9f%e5%9b%a0%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95" heading-number="6.6.2"><nav class='md-tags'><span class='md-tag'>中标麒麟V7</span><span class='md-tag'>Linux</span></nav><h1 id="pxe">联想物理机 PXE 装机报错“根分区找不到”原因及解决方法<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e8%81%94%e6%83%b3%e7%89%a9%e7%90%86%e6%9c%bapxe%e8%a3%85%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9c%e6%a0%b9%e5%88%86%e5%8c%ba%e6%89%be%e4%b8%8d%e5%88%b0%e2%80%9d%e5%8e%9f%e5%9b%a0%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-pxe" title="Permanent link">&para;</a></h1>
<h2 id="%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e8%81%94%e6%83%b3%e7%89%a9%e7%90%86%e6%9c%bapxe%e8%a3%85%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9c%e6%a0%b9%e5%88%86%e5%8c%ba%e6%89%be%e4%b8%8d%e5%88%b0%e2%80%9d%e5%8e%9f%e5%9b%a0%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-1-pxe">1. PXE 装机启动过程<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e8%81%94%e6%83%b3%e7%89%a9%e7%90%86%e6%9c%bapxe%e8%a3%85%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9c%e6%a0%b9%e5%88%86%e5%8c%ba%e6%89%be%e4%b8%8d%e5%88%b0%e2%80%9d%e5%8e%9f%e5%9b%a0%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-1-pxe" title="Permanent link">&para;</a></h2>
<p>实际观察到的联想服务器装机启动过程大致如下：</p>
<ol>
<li>加载位于  <a href="http://osinstall/kylin/v7-hygon/os/x86_64/images/pxeboot/vmlinuz">http://osinstall/kylin/v7-hygon/os/x86_64/images/pxeboot/vmlinuz</a> 的内核和位于 <a href="http://osinstall/kylin/v7-hygon/os/x86_64/images/pxeboot/vmlinuz%E7%9A%84%E5%86%85%E6%A0%B8%E5%92%8C%E4%BD%8D%E4%BA%8Ehttp://osinstall/kylin/v7-hygon/os/x86_64/images/pxeboot/initrd.img" title="http://osinstall/kylin/v7-hygon/os/x86_64/images/pxeboot/vmlinuz%E7%9A%84%E5%86%85%E6%A0%B8%E5%92%8C%E4%BD%8D%E4%BA%8Ehttp://osinstall/kylin/v7-hygon/os/x86_64/images/pxeboot/initrd.img">http://osinstall/kylin/v7-hygon/os/x86_64/images/pxeboot/initrd.img</a>  的 initramfs</li>
<li>initramfs 加载完毕后，加载  <a href="http://osinstall.pxe/kylin/v7-hygon/os/x86_64/LiveOS/squashfs.img" title="http://osinstall.pxe/kylin/v7-hygon/os/x86_64/LiveOS/squashfs.img">http://osinstall.pxe/kylin/v7-hygon/os/x86_64/LiveOS/squashfs.img</a> ，并将其挂载，之后 chroot 进 squashfs 进行后续安装</li>
</ol>
<p>装机失败报错 /dev/root 找不到，是卡在挂载 squashfs.img 这一步：</p>
<p><img alt="" src="%E6%8A%98%E8%85%BELinux/%E4%B8%AD%E6%A0%87%E9%BA%92%E9%BA%9FV7/images/46c8067efbe74c2e8937979aacc4a378.png" /></p>
<p>用 ip a 命令检查发现没有网卡：</p>
<p><img alt="" src="%E6%8A%98%E8%85%BELinux/%E4%B8%AD%E6%A0%87%E9%BA%92%E9%BA%9FV7/images/0ac0c4f4e733433890c3cf40ecd3ba89.png" /></p>
<p>经过检查，装机失败的机器网卡为网讯 RP2000，驱动的内核模块应该是 txgbe ：</p>
<p><img alt="" src="%E6%8A%98%E8%85%BELinux/%E4%B8%AD%E6%A0%87%E9%BA%92%E9%BA%9FV7/images/571fe0a2d08b4101afa1187d56754bd6.png" /></p>
<p>装机成功的机器网卡英特尔 X710，英特尔网卡兼容性好，initramfs 有驱动：</p>
<p><img alt="" src="%E6%8A%98%E8%85%BELinux/%E4%B8%AD%E6%A0%87%E9%BA%92%E9%BA%9FV7/images/add7835ab034488db98aa6549e32d9a0.png" /></p>
<p>找不到 /dev/root 的原因为 initramfs 无 txgbe 网卡驱动，导致无法连接网络获取 squashfs.img ，最终导致 squashfs.img 无法挂载，安装镜像无法继续启动。</p>
<h%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e8%81%94%e6%83%b3%e7%89%a9%e7%90%86%e6%9c%bapxe%e8%a3%85%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9c%e6%a0%b9%e5%88%86%e5%8c%ba%e6%89%be%e4%b8%8d%e5%88%b0%e2%80%9d%e5%8e%9f%e5%9b%a0%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-2 id="%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e8%81%94%e6%83%b3%e7%89%a9%e7%90%86%e6%9c%bapxe%e8%a3%85%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9c%e6%a0%b9%e5%88%86%e5%8c%ba%e6%89%be%e4%b8%8d%e5%88%b0%e2%80%9d%e5%8e%9f%e5%9b%a0%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-2">2. 解决方法<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e8%81%94%e6%83%b3%e7%89%a9%e7%90%86%e6%9c%bapxe%e8%a3%85%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9c%e6%a0%b9%e5%88%86%e5%8c%ba%e6%89%be%e4%b8%8d%e5%88%b0%e2%80%9d%e5%8e%9f%e5%9b%a0%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-2" title="Permanent link">&para;</a></h2>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>以下过程需要用 root 用户操作</p>
</div>
<p>联想服务器 PXE 装机失败报错/dev/root 找不到，原因为 initrd.img 无法下载 squashfs.img，从而无法挂载 squashfs，经检查发现 initrd.img 里没有网讯网卡驱动，解决方法是在 initramfs 里加入网讯网卡驱动。首先将装机镜像的 images/pxeboot/initrd.img 复制到一台已经装好海光版本麒麟 7.6 的机器上（可以是没有网讯网卡的虚拟机），并解压 initrd.img：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e8%81%94%e6%83%b3%e7%89%a9%e7%90%86%e6%9c%bapxe%e8%a3%85%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9c%e6%a0%b9%e5%88%86%e5%8c%ba%e6%89%be%e4%b8%8d%e5%88%b0%e2%80%9d%e5%8e%9f%e5%9b%a0%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e8%81%94%e6%83%b3%e7%89%a9%e7%90%86%e6%9c%bapxe%e8%a3%85%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9c%e6%a0%b9%e5%88%86%e5%8c%ba%e6%89%be%e4%b8%8d%e5%88%b0%e2%80%9d%e5%8e%9f%e5%9b%a0%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e8%81%94%e6%83%b3%e7%89%a9%e7%90%86%e6%9c%bapxe%e8%a3%85%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9c%e6%a0%b9%e5%88%86%e5%8c%ba%e6%89%be%e4%b8%8d%e5%88%b0%e2%80%9d%e5%8e%9f%e5%9b%a0%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-0-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>mkdir /root/initramfs-hygon
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>cd /root/initramfs-hygon
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a>xz -d -c -k /tmp/initrd.img | cpio -i
</span></code></pre></div></td></tr></table></div>
<p>之后把驱动程序 txgbe.ko 使用 xz 压缩，并复制到相应目录：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e8%81%94%e6%83%b3%e7%89%a9%e7%90%86%e6%9c%bapxe%e8%a3%85%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9c%e6%a0%b9%e5%88%86%e5%8c%ba%e6%89%be%e4%b8%8d%e5%88%b0%e2%80%9d%e5%8e%9f%e5%9b%a0%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e8%81%94%e6%83%b3%e7%89%a9%e7%90%86%e6%9c%bapxe%e8%a3%85%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9c%e6%a0%b9%e5%88%86%e5%8c%ba%e6%89%be%e4%b8%8d%e5%88%b0%e2%80%9d%e5%8e%9f%e5%9b%a0%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e8%81%94%e6%83%b3%e7%89%a9%e7%90%86%e6%9c%bapxe%e8%a3%85%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9c%e6%a0%b9%e5%88%86%e5%8c%ba%e6%89%be%e4%b8%8d%e5%88%b0%e2%80%9d%e5%8e%9f%e5%9b%a0%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e8%81%94%e6%83%b3%e7%89%a9%e7%90%86%e6%9c%bapxe%e8%a3%85%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9c%e6%a0%b9%e5%88%86%e5%8c%ba%e6%89%be%e4%b8%8d%e5%88%b0%e2%80%9d%e5%8e%9f%e5%9b%a0%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-1-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>cd usr/lib/modules/3.10.0-957.el7.hg.3.x86_64/kernel/drivers/net/ethernet/
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>mkdir txgbe
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a>cd txgbe/
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a>mv /tmp/txgbe.ko.xz .
</span></code></pre></div></td></tr></table></div>
<p>然后需要 chroot 进去进行 depmod：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e8%81%94%e6%83%b3%e7%89%a9%e7%90%86%e6%9c%bapxe%e8%a3%85%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9c%e6%a0%b9%e5%88%86%e5%8c%ba%e6%89%be%e4%b8%8d%e5%88%b0%e2%80%9d%e5%8e%9f%e5%9b%a0%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e8%81%94%e6%83%b3%e7%89%a9%e7%90%86%e6%9c%bapxe%e8%a3%85%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9c%e6%a0%b9%e5%88%86%e5%8c%ba%e6%89%be%e4%b8%8d%e5%88%b0%e2%80%9d%e5%8e%9f%e5%9b%a0%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-2-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>chroot /root/initramfs-hygon/
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>depmod -v | grep txgbe
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e8%81%94%e6%83%b3%e7%89%a9%e7%90%86%e6%9c%bapxe%e8%a3%85%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9c%e6%a0%b9%e5%88%86%e5%8c%ba%e6%89%be%e4%b8%8d%e5%88%b0%e2%80%9d%e5%8e%9f%e5%9b%a0%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>/lib/modules/3.10.0-957.el7.hg.3.x86_64/kernel/drivers/net/ethernet/txgbe/txgbe.ko.xz needs &quot;ptp_clock_index&quot;: /lib/modules/3.10.0-957.el7.hg.3.x86_64/kernel/drivers/ptp/ptp.ko.xz
</span></code></pre></div></td></tr></table></div>
<p>退出 chroot ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e8%81%94%e6%83%b3%e7%89%a9%e7%90%86%e6%9c%bapxe%e8%a3%85%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9c%e6%a0%b9%e5%88%86%e5%8c%ba%e6%89%be%e4%b8%8d%e5%88%b0%e2%80%9d%e5%8e%9f%e5%9b%a0%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-4-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>exit
</span></code></pre></div></td></tr></table></div>
<p>之后重新封装 initrd.img：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e8%81%94%e6%83%b3%e7%89%a9%e7%90%86%e6%9c%bapxe%e8%a3%85%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9c%e6%a0%b9%e5%88%86%e5%8c%ba%e6%89%be%e4%b8%8d%e5%88%b0%e2%80%9d%e5%8e%9f%e5%9b%a0%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e8%81%94%e6%83%b3%e7%89%a9%e7%90%86%e6%9c%bapxe%e8%a3%85%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9c%e6%a0%b9%e5%88%86%e5%8c%ba%e6%89%be%e4%b8%8d%e5%88%b0%e2%80%9d%e5%8e%9f%e5%9b%a0%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-5-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>cd /root/initramfs-hygon/
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a>find . | cpio -H newc -o | xz --check=crc32 --x86 --lzma2 &gt; /root/initrd-230322.img
</span></code></pre></div></td></tr></table></div>
<p>验证：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e8%81%94%e6%83%b3%e7%89%a9%e7%90%86%e6%9c%bapxe%e8%a3%85%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9c%e6%a0%b9%e5%88%86%e5%8c%ba%e6%89%be%e4%b8%8d%e5%88%b0%e2%80%9d%e5%8e%9f%e5%9b%a0%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-6-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a>lsinitramfs initrd-230322.img | grep txgbe
</span></code></pre></div></td></tr></table></div>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e8%81%94%e6%83%b3%e7%89%a9%e7%90%86%e6%9c%bapxe%e8%a3%85%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9c%e6%a0%b9%e5%88%86%e5%8c%ba%e6%89%be%e4%b8%8d%e5%88%b0%e2%80%9d%e5%8e%9f%e5%9b%a0%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-7-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e8%81%94%e6%83%b3%e7%89%a9%e7%90%86%e6%9c%bapxe%e8%a3%85%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9c%e6%a0%b9%e5%88%86%e5%8c%ba%e6%89%be%e4%b8%8d%e5%88%b0%e2%80%9d%e5%8e%9f%e5%9b%a0%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95-__codelineno-7-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a>usr/lib/modules/3.10.0-957.el7.hg.3.x86_64/kernel/drivers/net/ethernet/txgbe
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a>usr/lib/modules/3.10.0-957.el7.hg.3.x86_64/kernel/drivers/net/ethernet/txgbe/txgbe.ko.xz
</span></code></pre></div></td></tr></table></div>
<p>最后把 initrd.img 替换，重新封装 ISO 镜像。</p></section></section>
                    <section class='print-page md-section' id='section-6-7' heading-number='6.7'>
                        <h1>银河麒麟V10<a class='headerlink' href='#section-6-7' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81" heading-number="6.7.1"><nav class='md-tags'><span class='md-tag'>Linux</span><span class='md-tag'>银河麒麟V10</span><span class='md-tag'>VSCode</span></nav><h1 id="v10sp4-vscode">麒麟 V10SP4 增加 VSCode 支持<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-v10sp4-vscode" title="Permanent link">&para;</a></h1>
<p>VSCode 自 1.99 版本开始抛弃了对旧版本 Linux 的支持，对于旧版本需要额外进行一些配置才能使用。</p>
<h2 id="%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-1">1. 安装编译依赖<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-1" title="Permanent link">&para;</a></h2>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>yum<span class="w"> </span>group<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span><span class="s1">&#39;Development Tools&#39;</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>yum<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>texinfo<span class="w"> </span>help2man<span class="w"> </span>ncurses-libs<span class="w"> </span>ncurses-devel<span class="w"> </span>libstdc++-static
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-2-crosstool-ng">2. 安装 crosstool-ng<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-2-crosstool-ng" title="Permanent link">&para;</a></h2>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-__codelineno-1-4">4</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-__codelineno-1-5">5</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-__codelineno-1-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>wget<span class="w"> </span>http://crosstool-ng.org/download/crosstool-ng/crosstool-ng-1.26.0.tar.bz2
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>tar<span class="w"> </span>-xjf<span class="w"> </span>crosstool-ng-1.26.0.tar.bz2
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="nb">cd</span><span class="w"> </span>crosstool-ng-1.26.0
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a>./configure<span class="w"> </span>--prefix<span class="o">=</span>/opt/crosstool-ng-1.26.0
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a>make
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a>make<span class="w"> </span>install
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-3-sysroot">3. 编译新 sysroot<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-3-sysroot" title="Permanent link">&para;</a></h2>
<p>新建 <code>.config</code> 文件：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-__codelineno-2-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>mkdir<span class="w"> </span>/opt/crosstool-ng-1.26.0/toolchain
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="nb">cd</span><span class="w"> </span>/opt/crosstool-ng-1.26.0/toolchain
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a>wget<span class="w"> </span>-O<span class="w"> </span>.config<span class="w"> </span><span class="s1">&#39;https://raw.githubusercontent.com/microsoft/vscode-linux-build-agent/refs/heads/main/x86_64-gcc-8.5.0-glibc-2.28.config&#39;</span>
</span></code></pre></div></td></tr></table></div>
<p>编辑 <code>.config</code> 文件，将以下行插入到最开始位置以允许使用 root 构建：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-__codelineno-3-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>CT_EXPERIMENTAL=y
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>CT_ALLOW_BUILD_AS_ROOT=y
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a>CT_ALLOW_BUILD_AS_ROOT_SURE=y
</span></code></pre></div></td></tr></table></div>
<p>用 <code>make menuconfig</code> 修改 gcc 版本：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-__codelineno-4-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>/opt/crosstool-ng-1.26.0/bin/ct-ng<span class="w"> </span>menuconfig
</span></code></pre></div></td></tr></table></div>
<p>进入 <code>C compiler</code> -&gt; <code>Version of gcc</code> ，将其修改为 <code>6.5.0</code> ，进入 <code>Operating System</code> -&gt; <code>Version of linux</code> ，将其修改为 <code>4.18.20</code> ，保存退出后开始编译：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-__codelineno-5-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>/opt/crosstool-ng-1.26.0/bin/ct-ng<span class="w"> </span>build
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-4-patchelf">4. 安装 patchelf<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-4-patchelf" title="Permanent link">&para;</a></h2>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-__codelineno-6-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-__codelineno-6-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-__codelineno-6-3">3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-__codelineno-6-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="nb">cd</span><span class="w"> </span>/tmp
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a>wget<span class="w"> </span>https://github.com/NixOS/patchelf/releases/download/0.18.0/patchelf-0.18.0-x86_64.tar.gz
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a>mkdir<span class="w"> </span>/opt/patchelf-0.18.0
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a>tar<span class="w"> </span>-zxvf<span class="w"> </span>patchelf-0.18.0-x86_64.tar.gz<span class="w"> </span>-C<span class="w"> </span>/opt/patchelf-0.18.0
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-5">5. 设置环境变量<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-5" title="Permanent link">&para;</a></h2>
<p>新建文件 <code>/etc/profile.d/vscode.sh</code> ：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-__codelineno-7-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-__codelineno-7-2">2</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-__codelineno-7-3">3</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-__codelineno-7-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">VSCODE_SERVER_CUSTOM_GLIBC_LINKER</span><span class="o">=</span>/opt/crosstool-ng-1.26.0/toolchain/x86_64-linux-gnu/x86_64-linux-gnu/sysroot/lib/ld-2.28.so
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="nb">export</span><span class="w"> </span><span class="nv">VSCODE_SERVER_CUSTOM_GLIBC_PATH</span><span class="o">=</span>/opt/crosstool-ng-1.26.0/toolchain/x86_64-linux-gnu/x86_64-linux-gnu/sysroot/lib64
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="nb">export</span><span class="w"> </span><span class="nv">VSCODE_SERVER_PATCHELF_PATH</span><span class="o">=</span>/opt/patchelf-0.18.0/bin/patchelf
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-6-sshd-allowtcpforwarding">6. 启用 sshd 的 AllowTcpForwarding<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-6-sshd-allowtcpforwarding" title="Permanent link">&para;</a></h2>
<p>编辑 <code>/etc/ssh/sshd_config</code>，将 <code>AllowTcpForwarding</code> 设置为 <code>yes</code>后，重启 sshd 服务：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-__codelineno-8-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a>sshd<span class="w"> </span>-t<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>sshd
</span></code></pre></div></td></tr></table></div>
<h2 id="%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-7">7. 参考链接<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81-7" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://code.visualstudio.com/docs/remote/faq#_can-i-run-vs-code-server-on-older-linux-distributions">https://code.visualstudio.com/docs/remote/faq#_can-i-run-vs-code-server-on-older-linux-distributions</a></li>
</ul></section><section class="print-page" id="%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e8%ae%b0%e6%9f%90%e6%ac%a1%e6%9f%90%e5%ae%89%e5%85%a8%e5%8e%82%e5%95%86%e5%ba%94%e7%94%a8%e8%bf%90%e8%a1%8c%e4%b8%80%e6%ae%b5%e6%97%b6%e9%97%b4%e5%90%8e%ef%bc%8clinux%e5%87%ba%e7%8e%b0ping%e5%bb%b6%e8%bf%9f%e9%ab%98%e9%97%ae%e9%a2%98%e7%9a%84%e8%a7%a3%e5%86%b3%e6%80%9d%e8%b7%af" heading-number="6.7.2"><nav class='md-tags'><span class='md-tag'>Linux</span><span class='md-tag'>银河麒麟V10</span><span class='md-tag'>iptables</span></nav><h1 id="linux-ping">记某次某安全厂商应用运行一段时间后，Linux 出现 ping 延迟高问题的解决思路<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e8%ae%b0%e6%9f%90%e6%ac%a1%e6%9f%90%e5%ae%89%e5%85%a8%e5%8e%82%e5%95%86%e5%ba%94%e7%94%a8%e8%bf%90%e8%a1%8c%e4%b8%80%e6%ae%b5%e6%97%b6%e9%97%b4%e5%90%8e%ef%bc%8clinux%e5%87%ba%e7%8e%b0ping%e5%bb%b6%e8%bf%9f%e9%ab%98%e9%97%ae%e9%a2%98%e7%9a%84%e8%a7%a3%e5%86%b3%e6%80%9d%e8%b7%af-linux-ping" title="Permanent link">&para;</a></h1>
<h2 id="%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e8%ae%b0%e6%9f%90%e6%ac%a1%e6%9f%90%e5%ae%89%e5%85%a8%e5%8e%82%e5%95%86%e5%ba%94%e7%94%a8%e8%bf%90%e8%a1%8c%e4%b8%80%e6%ae%b5%e6%97%b6%e9%97%b4%e5%90%8e%ef%bc%8clinux%e5%87%ba%e7%8e%b0ping%e5%bb%b6%e8%bf%9f%e9%ab%98%e9%97%ae%e9%a2%98%e7%9a%84%e8%a7%a3%e5%86%b3%e6%80%9d%e8%b7%af-1">1. 问题描述<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e8%ae%b0%e6%9f%90%e6%ac%a1%e6%9f%90%e5%ae%89%e5%85%a8%e5%8e%82%e5%95%86%e5%ba%94%e7%94%a8%e8%bf%90%e8%a1%8c%e4%b8%80%e6%ae%b5%e6%97%b6%e9%97%b4%e5%90%8e%ef%bc%8clinux%e5%87%ba%e7%8e%b0ping%e5%bb%b6%e8%bf%9f%e9%ab%98%e9%97%ae%e9%a2%98%e7%9a%84%e8%a7%a3%e5%86%b3%e6%80%9d%e8%b7%af-1" title="Permanent link">&para;</a></h2>
<p>在某台联想信创服务器（海光 CPU 版本）上安装银河麒麟 V10SP1 后，安装了某个安全厂商的软件。该安全厂商软件需要部分 root 的权限运行，观察到的现象为：软件运行一段时间后，这个节点到别的节点 ping 延迟变得特别高而且不稳定（同一个交换机下的两台机器之间互相 ping，有 100ms 延迟）。且观察到 CPU 软中断非常高且分布不均匀。</p>
<h%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e8%ae%b0%e6%9f%90%e6%ac%a1%e6%9f%90%e5%ae%89%e5%85%a8%e5%8e%82%e5%95%86%e5%ba%94%e7%94%a8%e8%bf%90%e8%a1%8c%e4%b8%80%e6%ae%b5%e6%97%b6%e9%97%b4%e5%90%8e%ef%bc%8clinux%e5%87%ba%e7%8e%b0ping%e5%bb%b6%e8%bf%9f%e9%ab%98%e9%97%ae%e9%a2%98%e7%9a%84%e8%a7%a3%e5%86%b3%e6%80%9d%e8%b7%af-2 id="%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e8%ae%b0%e6%9f%90%e6%ac%a1%e6%9f%90%e5%ae%89%e5%85%a8%e5%8e%82%e5%95%86%e5%ba%94%e7%94%a8%e8%bf%90%e8%a1%8c%e4%b8%80%e6%ae%b5%e6%97%b6%e9%97%b4%e5%90%8e%ef%bc%8clinux%e5%87%ba%e7%8e%b0ping%e5%bb%b6%e8%bf%9f%e9%ab%98%e9%97%ae%e9%a2%98%e7%9a%84%e8%a7%a3%e5%86%b3%e6%80%9d%e8%b7%af-2">2. 解决思路及最终结论<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e8%ae%b0%e6%9f%90%e6%ac%a1%e6%9f%90%e5%ae%89%e5%85%a8%e5%8e%82%e5%95%86%e5%ba%94%e7%94%a8%e8%bf%90%e8%a1%8c%e4%b8%80%e6%ae%b5%e6%97%b6%e9%97%b4%e5%90%8e%ef%bc%8clinux%e5%87%ba%e7%8e%b0ping%e5%bb%b6%e8%bf%9f%e9%ab%98%e9%97%ae%e9%a2%98%e7%9a%84%e8%a7%a3%e5%86%b3%e6%80%9d%e8%b7%af-2" title="Permanent link">&para;</a></h2>
<p>该问题的排查思路如下：</p>
<ul>
<li>在确认了无应用和业务影响、将应用服务器隔离后，停止应用，继续测试，发现 ping 延迟依旧高，至此排除不是应用运行导致的问题。</li>
<li>关闭这台物理机上安装的安全防护软件 G01，并卸载 G01 软件的内核模块，问题依旧存在，说明不是 G01 导致的问题。</li>
<li>重启 <code>dbus</code> 服务和 <code>systemd</code> 服务：</li>
</ul>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e8%ae%b0%e6%9f%90%e6%ac%a1%e6%9f%90%e5%ae%89%e5%85%a8%e5%8e%82%e5%95%86%e5%ba%94%e7%94%a8%e8%bf%90%e8%a1%8c%e4%b8%80%e6%ae%b5%e6%97%b6%e9%97%b4%e5%90%8e%ef%bc%8clinux%e5%87%ba%e7%8e%b0ping%e5%bb%b6%e8%bf%9f%e9%ab%98%e9%97%ae%e9%a2%98%e7%9a%84%e8%a7%a3%e5%86%b3%e6%80%9d%e8%b7%af-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e8%ae%b0%e6%9f%90%e6%ac%a1%e6%9f%90%e5%ae%89%e5%85%a8%e5%8e%82%e5%95%86%e5%ba%94%e7%94%a8%e8%bf%90%e8%a1%8c%e4%b8%80%e6%ae%b5%e6%97%b6%e9%97%b4%e5%90%8e%ef%bc%8clinux%e5%87%ba%e7%8e%b0ping%e5%bb%b6%e8%bf%9f%e9%ab%98%e9%97%ae%e9%a2%98%e7%9a%84%e8%a7%a3%e5%86%b3%e6%80%9d%e8%b7%af-__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>systemctl restart dbus.service
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>systemctl systemctl daemon-reexec
</span></code></pre></div></td></tr></table></div>
<p>问题依旧存在，排除 <code>dbus</code>和 `systemd 的问题。</p>
<ul>
<li>该物理机使用双网卡绑定，依次重启两个网卡及其 bond，重启 <code>NetworkManager</code> ，问题没有解决。且尝试 ping 127.0.0.1 ，发现 127.0.0.1 的延迟也有 10ms 且不稳定，排除是网络问题导致。</li>
</ul>
<ul>
<li>最终发现是 <code>iptables</code> 里有 9 万行重复项导致：</li>
</ul>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e8%ae%b0%e6%9f%90%e6%ac%a1%e6%9f%90%e5%ae%89%e5%85%a8%e5%8e%82%e5%95%86%e5%ba%94%e7%94%a8%e8%bf%90%e8%a1%8c%e4%b8%80%e6%ae%b5%e6%97%b6%e9%97%b4%e5%90%8e%ef%bc%8clinux%e5%87%ba%e7%8e%b0ping%e5%bb%b6%e8%bf%9f%e9%ab%98%e9%97%ae%e9%a2%98%e7%9a%84%e8%a7%a3%e5%86%b3%e6%80%9d%e8%b7%af-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e8%ae%b0%e6%9f%90%e6%ac%a1%e6%9f%90%e5%ae%89%e5%85%a8%e5%8e%82%e5%95%86%e5%ba%94%e7%94%a8%e8%bf%90%e8%a1%8c%e4%b8%80%e6%ae%b5%e6%97%b6%e9%97%b4%e5%90%8e%ef%bc%8clinux%e5%87%ba%e7%8e%b0ping%e5%bb%b6%e8%bf%9f%e9%ab%98%e9%97%ae%e9%a2%98%e7%9a%84%e8%a7%a3%e5%86%b3%e6%80%9d%e8%b7%af-__codelineno-1-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a># iptables -n -L -v | wc -l
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>91257
</span></code></pre></div></td></tr></table></div>
<p>直接问题是因为每次包进入到服务器，都要匹配这 9 万行 iptables 规则，然后才会把包放进来。</p>
<h2 id="%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e8%ae%b0%e6%9f%90%e6%ac%a1%e6%9f%90%e5%ae%89%e5%85%a8%e5%8e%82%e5%95%86%e5%ba%94%e7%94%a8%e8%bf%90%e8%a1%8c%e4%b8%80%e6%ae%b5%e6%97%b6%e9%97%b4%e5%90%8e%ef%bc%8clinux%e5%87%ba%e7%8e%b0ping%e5%bb%b6%e8%bf%9f%e9%ab%98%e9%97%ae%e9%a2%98%e7%9a%84%e8%a7%a3%e5%86%b3%e6%80%9d%e8%b7%af-3">3. 解决方法<a class="headerlink" href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e8%ae%b0%e6%9f%90%e6%ac%a1%e6%9f%90%e5%ae%89%e5%85%a8%e5%8e%82%e5%95%86%e5%ba%94%e7%94%a8%e8%bf%90%e8%a1%8c%e4%b8%80%e6%ae%b5%e6%97%b6%e9%97%b4%e5%90%8e%ef%bc%8clinux%e5%87%ba%e7%8e%b0ping%e5%bb%b6%e8%bf%9f%e9%ab%98%e9%97%ae%e9%a2%98%e7%9a%84%e8%a7%a3%e5%86%b3%e6%80%9d%e8%b7%af-3" title="Permanent link">&para;</a></h2>
<p>临时的解决方法为清空 iptables ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e8%ae%b0%e6%9f%90%e6%ac%a1%e6%9f%90%e5%ae%89%e5%85%a8%e5%8e%82%e5%95%86%e5%ba%94%e7%94%a8%e8%bf%90%e8%a1%8c%e4%b8%80%e6%ae%b5%e6%97%b6%e9%97%b4%e5%90%8e%ef%bc%8clinux%e5%87%ba%e7%8e%b0ping%e5%bb%b6%e8%bf%9f%e9%ab%98%e9%97%ae%e9%a2%98%e7%9a%84%e8%a7%a3%e5%86%b3%e6%80%9d%e8%b7%af-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>iptables -F
</span></code></pre></div></td></tr></table></div>
<p>清空后， ping 127.0.0.1 验证问题已解决。</p>
<p>根本的解决方法需要安全软件厂商分析为什么软件会往 iptables 里添加 9 万行重复的 iptables 规则。</p></section></section></section>
                    <section class='print-page md-section' id='section-7' heading-number='7'>
                        <h1>虚拟化技术<a class='headerlink' href='#section-7' title='Permanent link'></a>
                        </h1>
                    
                    <section class='print-page md-section' id='section-7-1' heading-number='7.1'>
                        <h1>Hyper-V<a class='headerlink' href='#section-7-1' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-hyper-v-hyper-v%e4%bf%ae%e6%94%b9%e8%b0%83%e5%ba%a6%e5%99%a8" heading-number="7.1.1"><nav class='md-tags'><span class='md-tag'>Hyper-V</span></nav><h1 id="hyper-v">Hyper-V 修改调度器<a class="headerlink" href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-hyper-v-hyper-v%e4%bf%ae%e6%94%b9%e8%b0%83%e5%ba%a6%e5%99%a8-hyper-v" title="Permanent link">&para;</a></h1>
<p>在尝试给 Hyper-V 虚拟机设置 CPU 使用限制时，发现这样的告警：</p>
<p><img alt="" src="%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/Hyper-V/images/hyper-v_1.png" /></p>
<p>需要修改调度器。查看当前调度器的 PowerShell 命令为：</p>
<div class="language-powershell highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-hyper-v-hyper-v%e4%bf%ae%e6%94%b9%e8%b0%83%e5%ba%a6%e5%99%a8-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nb">Get-WinEvent</span> <span class="n">-FilterHashTable</span> <span class="p">@{</span><span class="n">ProviderName</span><span class="p">=</span><span class="s2">&quot;Microsoft-Windows-Hyper-V-Hypervisor&quot;</span><span class="p">;</span> <span class="n">ID</span><span class="p">=</span><span class="n">2</span><span class="p">}</span> <span class="n">-MaxEvents</span> <span class="n">1</span>
</span></code></pre></div></td></tr></table></div>
<p>命令返回如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-hyper-v-hyper-v%e4%bf%ae%e6%94%b9%e8%b0%83%e5%ba%a6%e5%99%a8-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-hyper-v-hyper-v%e4%bf%ae%e6%94%b9%e8%b0%83%e5%ba%a6%e5%99%a8-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-hyper-v-hyper-v%e4%bf%ae%e6%94%b9%e8%b0%83%e5%ba%a6%e5%99%a8-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-hyper-v-hyper-v%e4%bf%ae%e6%94%b9%e8%b0%83%e5%ba%a6%e5%99%a8-__codelineno-1-4">4</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-hyper-v-hyper-v%e4%bf%ae%e6%94%b9%e8%b0%83%e5%ba%a6%e5%99%a8-__codelineno-1-5">5</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-hyper-v-hyper-v%e4%bf%ae%e6%94%b9%e8%b0%83%e5%ba%a6%e5%99%a8-__codelineno-1-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>   ProviderName: Microsoft-Windows-Hyper-V-Hypervisor
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a>TimeCreated                      Id LevelDisplayName Message
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a>-----------                      -- ---------------- -------
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a>6/1/2024 9:31:43 PM               2 Information      Hypervisor scheduler type is 0x4.
</span></code></pre></div></td></tr></table></div>
<p>其中 <code>0x4</code> 表示调度器为 <code>Root scheduler</code> ，其它数字含义如下：</p>
<ul>
<li>1 = Classic scheduler, SMT disabled</li>
<li>2 = Classic scheduler</li>
<li>3 = Core scheduler</li>
<li>4 = Root scheduler</li>
</ul>
<p>调度器具体区别可参考 <a href="https://learn.microsoft.com/en-us/windows-server/virtualization/hyper-v/manage/manage-hyper-v-scheduler-types">Manage Hyper-V hypervisor scheduler types</a> ，</p>
<p>修改调度器方法为 Core scheduler 的方法为：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-hyper-v-hyper-v%e4%bf%ae%e6%94%b9%e8%b0%83%e5%ba%a6%e5%99%a8-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>bcdedit /set hypervisorschedulertype core
</span></code></pre></div></td></tr></table></div>
<p>修改以后需要重启。</p></section><section class="print-page" id="%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-hyper-v-hyper-v%e5%a4%9a%e7%bd%91%e5%8d%a1%e7%bb%91%e5%ae%9a" heading-number="7.1.3"><nav class='md-tags'><span class='md-tag'>Hyper-V</span></nav><h1 id="hyper-v">Hyper-V 多网卡绑定<a class="headerlink" href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-hyper-v-hyper-v%e5%a4%9a%e7%bd%91%e5%8d%a1%e7%bb%91%e5%ae%9a-hyper-v" title="Permanent link">&para;</a></h1>
<p>自 Windows Server 2022 启，LBFO （即操作系统里内置的 NIC Teaming）不再被支持添加到 Hyper-V 的虚拟交换机内，需要使用 Switch Embedded Teaming (SET) ，添加方法如下：</p>
<p>获取网卡名：</p>
<div class="language-powershell highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-hyper-v-hyper-v%e5%a4%9a%e7%bd%91%e5%8d%a1%e7%bb%91%e5%ae%9a-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nb">Get-NetAdapter</span>
</span></code></pre></div></td></tr></table></div>
<p>创建虚拟交换机：</p>
<div class="language-powershell highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-hyper-v-hyper-v%e5%a4%9a%e7%bd%91%e5%8d%a1%e7%bb%91%e5%ae%9a-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nb">New-VMSwitch</span> <span class="n">-Name</span> <span class="s2">&quot;External&quot;</span> <span class="n">-NetAdapterName</span> <span class="s2">&quot;以太网 2&quot;</span><span class="p">,</span> <span class="s2">&quot;以太网 3&quot;</span> <span class="n">-AllowManagementOS</span> <span class="nv">$false</span>
</span></code></pre></div></td></tr></table></div>
<p>查看虚拟交换机参数：</p>
<div class="language-powershell highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-hyper-v-hyper-v%e5%a4%9a%e7%bd%91%e5%8d%a1%e7%bb%91%e5%ae%9a-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nb">Get-VMSwitchTeam</span> <span class="n">-Name</span> <span class="n">External</span> <span class="p">|</span> <span class="nb">Format-List</span>
</span></code></pre></div></td></tr></table></div>
<p>修改虚拟交换机负载均衡算法为动态：</p>
<div class="language-powershell highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-hyper-v-hyper-v%e5%a4%9a%e7%bd%91%e5%8d%a1%e7%bb%91%e5%ae%9a-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nb">Set-VMSwitchTeam</span> <span class="n">-Name</span> <span class="s2">&quot;External&quot;</span> <span class="n">-LoadBalancingAlgorithm</span> <span class="n">Dynamic</span>
</span></code></pre></div></td></tr></table></div>
<p>注意：SET 是不支持 LACP 的，只支持和交换机无关的绑定模式，需要把对端绑定模式修改为轮询。</p></section></section>
                    <section class='print-page md-section' id='section-7-2' heading-number='7.2'>
                        <h1>QEMU<a class='headerlink' href='#section-7-2' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-virt-manager%e5%88%9b%e5%bb%ba%e8%99%9a%e6%8b%9f%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9cdid%20not%20find%20any%20uefi%20binary%20path%20for%20arch%20%27aarch64%27%e2%80%9d%e9%97%ae%e9%a2%98" heading-number="7.2.1"><nav class='md-tags'><span class='md-tag'>QEMU</span><span class='md-tag'>KVM</span><span class='md-tag'>银河麒麟V10</span></nav><h1 id="virt-manager-did-not-find-any-uefi-binary-path-for-arch-aarch64">virt-manager 创建虚拟机报错 “Did not find any UEFI binary path for arch 'aarch64'” 问题<a class="headerlink" href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-virt-manager%e5%88%9b%e5%bb%ba%e8%99%9a%e6%8b%9f%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9cdid%20not%20find%20any%20uefi%20binary%20path%20for%20arch%20%27aarch64%27%e2%80%9d%e9%97%ae%e9%a2%98-virt-manager-did-not-find-any-uefi-binary-path-for-arch-aarch64" title="Permanent link">&para;</a></h1>
<h2 id="%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-virt-manager%e5%88%9b%e5%bb%ba%e8%99%9a%e6%8b%9f%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9cdid%20not%20find%20any%20uefi%20binary%20path%20for%20arch%20%27aarch64%27%e2%80%9d%e9%97%ae%e9%a2%98-_1">问题描述<a class="headerlink" href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-virt-manager%e5%88%9b%e5%bb%ba%e8%99%9a%e6%8b%9f%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9cdid%20not%20find%20any%20uefi%20binary%20path%20for%20arch%20%27aarch64%27%e2%80%9d%e9%97%ae%e9%a2%98-_1" title="Permanent link">&para;</a></h2>
<p>在 ARM64 架构的华为鲲鹏架构物理机上，安装 virt-manager 后，无法创建 KVM 虚拟机，报错 “Did not find any UEFI binary path for arch 'aarch64'” ：</p>
<p><img alt="" src="%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/QEMU/images/virt-manager%E6%8A%A5%E9%94%99.png" /></p>
<p>操作系统为银河麒麟 V10，经过检查， <code>edk2-ovmf-201908-9.ky10.noarch.rpm</code> 软件包已安装。</p>
<h2 id="%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-virt-manager%e5%88%9b%e5%bb%ba%e8%99%9a%e6%8b%9f%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9cdid%20not%20find%20any%20uefi%20binary%20path%20for%20arch%20%27aarch64%27%e2%80%9d%e9%97%ae%e9%a2%98-_2">解决方法<a class="headerlink" href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-virt-manager%e5%88%9b%e5%bb%ba%e8%99%9a%e6%8b%9f%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9cdid%20not%20find%20any%20uefi%20binary%20path%20for%20arch%20%27aarch64%27%e2%80%9d%e9%97%ae%e9%a2%98-_2" title="Permanent link">&para;</a></h2>
<p>需要安装 <code>edk2-aarch64</code> 并重启 libvirtd ：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-virt-manager%e5%88%9b%e5%bb%ba%e8%99%9a%e6%8b%9f%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9cdid%20not%20find%20any%20uefi%20binary%20path%20for%20arch%20%27aarch64%27%e2%80%9d%e9%97%ae%e9%a2%98-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-virt-manager%e5%88%9b%e5%bb%ba%e8%99%9a%e6%8b%9f%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9cdid%20not%20find%20any%20uefi%20binary%20path%20for%20arch%20%27aarch64%27%e2%80%9d%e9%97%ae%e9%a2%98-__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>yum install edk2-aarch64
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>systemctl restart libvirtd
</span></code></pre></div></td></tr></table></div></section><section class="print-page" id="%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba" heading-number="7.2.2"><h1 id="%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-pvearm">PVE发放ARM虚拟机<a class="headerlink" href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-pvearm" title="Permanent link">&para;</a></h1>
<h2 id="%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-pve">PVE 宿主机安装依赖<a class="headerlink" href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-pve" title="Permanent link">&para;</a></h2>
<p>PVE宿主机需要安装ARM结构的firmware：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>apt<span class="w"> </span>install<span class="w"> </span>pve-edk2-firmware-aarch64
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-_1">新建虚拟机<a class="headerlink" href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-_1" title="Permanent link">&para;</a></h2>
<p>新建虚拟机，并做如下配置：</p>
<ul>
<li>不选择 CDROM</li>
<li>Machine 选择 i440fx</li>
<li>BIOS 选择 UEFI ，不添加 EFI 磁盘</li>
<li>SCSI 控制器选择 VirtIO SCSI ，磁盘选 VirtIO Block 类型</li>
</ul>
<h2 id="%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-_2">修改虚拟机配置<a class="headerlink" href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-_2" title="Permanent link">&para;</a></h2>
<p>创建出的虚拟机ID为108，进入 <code>/etc/pve/qemu-server/108.conf</code> ，修改这个文件，添加如下配置：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>arch: aarch64
</span></code></pre></div></td></tr></table></div>
<p>删除如下配置：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-__codelineno-2-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>cpu: x86-64-v2-AES
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>vmgenid: 8e8ffebe-a35d-4882-9039-a8f1d66b6b8d
</span></code></pre></div></td></tr></table></div>
<p>之后再页面上删除 CD 驱动器，再新建为 SCSI 的 CD 驱动器。修改完成此配置示例如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-__codelineno-3-10">10</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-__codelineno-3-11">11</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-__codelineno-3-12">12</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-__codelineno-3-13">13</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-__codelineno-3-14">14</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-__codelineno-3-15">15</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba-__codelineno-3-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>arch: aarch64
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>bios: ovmf
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a>boot: order=net0;scsi0
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a>cores: 8
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a>memory: 16384
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a>meta: creation-qemu=9.0.2,ctime=1740024564
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a>name: centos-9-arm-1
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a>net0: virtio=BC:24:11:E4:64:02,bridge=vmbr0,firewall=1
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a>numa: 0
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10"></a>ostype: l26
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11"></a>scsi0: local:iso/CentOS-Stream-9-latest-aarch64-dvd1.iso,media=cdrom,size=10398208K
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12"></a>scsihw: virtio-scsi-pci
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13"></a>smbios1: uuid=3b8d0e01-c5e7-49d3-9f3e-d0fb02e0e048
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14"></a>sockets: 1
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15"></a>template: 1
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16"></a>virtio0: local-zfs:base-106-disk-0,iothread=1,size=32G
</span></code></pre></div></td></tr></table></div>
<p>挂载操作系统 ISO 安装镜像，在 Options 里修改 CD 为第一启动项，安装操作系统。</p></section></section>
                    <section class='print-page md-section' id='section-7-3' heading-number='7.3'>
                        <h1>华为云<a class='headerlink' href='#section-7-3' title='Permanent link'></a>
                        </h1>
                    <section class="print-page" id="%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3" heading-number="7.3.1"><h1 id="%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-hcs-8-v10sp4-cloud-init">华为 HCS 8 与银河麒麟 V10SP4 cloud-init 适配问题解决<a class="headerlink" href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-hcs-8-v10sp4-cloud-init" title="Permanent link">&para;</a></h1>
<h2 id="%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-1">1. 问题现象<a class="headerlink" href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-1" title="Permanent link">&para;</a></h2>
<p>在制作银河麒麟 V10SP4 虚拟机镜像时，安装后检查发现没有安装 cloud-init ，进一步调查 packer 日志如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>qemu: install-cloud-init.sh executing ......
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>qemu: /usr/bin/python3
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a>qemu: python version check success
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a>qemu: /usr/bin/systemctl
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a>qemu: setuptools install failed, try to install setuptools through specified directory
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a>qemu: uninstall old setuptools, try to install setuptools again
</span></code></pre></div></td></tr></table></div>
<p>日志指向为 setuptools 安装失败。尝试挂载 image-tools 的 ISO 进行手动安装：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-1-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a>mount<span class="w"> </span>/dev/sr0<span class="w"> </span>/mnt
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>mkdir<span class="w"> </span>/opt/image-tools
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a>cp<span class="w"> </span>-r<span class="w"> </span>/mnt/linux/<span class="w"> </span>/opt/image-tools/
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a>umount<span class="w"> </span>/mnt
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="nb">cd</span><span class="w"> </span>/tmp
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a>tar<span class="w"> </span>zxvf<span class="w"> </span>/root/install/drivers/cloud-init-depends.tar.gz
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a>find<span class="w"> </span>/tmp/cloud-init-depends<span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span>-exec<span class="w"> </span>cp<span class="w"> </span><span class="o">{}</span><span class="w"> </span>/opt/image-tools/linux/cloud-init/cloudinit_depend/<span class="w"> </span><span class="se">\;</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="nb">cd</span><span class="w"> </span>/opt/image-tools/linux
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a>chmod<span class="w"> </span>+x<span class="w"> </span>*.sh
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a>./install-cloud-init.sh
</span></code></pre></div></td></tr></table></div>
<p>可以复现相同的报错。</p>
<h%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-2 id="%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-2">2. 排查过程<a class="headerlink" href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-2" title="Permanent link">&para;</a></h2>
<p>安装 setuptools 的 Shell 代码位于 <code>/opt/image-tools/linux/cloud-init/install_script/utils/common_func.sh</code> ：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-2-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1"># install python setuptools</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>fnSetuptoolsInstall<span class="o">()</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="o">{</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">    </span><span class="nv">setuptools_name</span><span class="o">=</span><span class="si">${</span><span class="nv">setuptools_pkg</span><span class="si">}</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">    </span><span class="nb">cd</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PKG_PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">    </span>tar<span class="w"> </span>-xzvf<span class="w"> </span><span class="si">${</span><span class="nv">setuptools_name</span><span class="si">}</span>.tar.gz<span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">    </span><span class="nb">cd</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PKG_PATH</span><span class="si">}</span><span class="s2">&quot;</span>/<span class="si">${</span><span class="nv">setuptools_name</span><span class="si">}</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">    </span><span class="si">${</span><span class="nv">PYTHON_EXEC</span><span class="si">}</span><span class="w"> </span>bootstrap.py<span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">    </span><span class="si">${</span><span class="nv">PYTHON_EXEC</span><span class="si">}</span><span class="w"> </span>setup.py<span class="w"> </span>install<span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10"></a>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;setuptools install failed, try to install setuptools through specified directory&quot;</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">        </span><span class="si">${</span><span class="nv">PYTHON_EXEC</span><span class="si">}</span><span class="w"> </span>setup.py<span class="w"> </span>install<span class="w"> </span>--prefix<span class="o">=</span>/<span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span>-a<span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span><span class="si">${</span><span class="nv">PYTHON_EXEC</span><span class="si">}</span><span class="w"> </span>-m<span class="w"> </span>pydoc<span class="w"> </span>setuptools<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>VERSION<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;uninstall old setuptools, try to install setuptools again&quot;</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">        </span>fnSetuptoolsUnInstall
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">        </span><span class="si">${</span><span class="nv">PYTHON_EXEC</span><span class="si">}</span><span class="w"> </span>setup.py<span class="w"> </span>install<span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="w">    </span>fnResultCheck<span class="w"> </span><span class="si">${</span><span class="nv">setuptools_name</span><span class="si">}</span><span class="w"> </span><span class="nv">$?</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="o">}</span>
</span></code></pre></div></td></tr></table></div>
<p>进一步使用 <code>bash -xv install-cloud-init.sh</code> 打印 Shell 脚本详细调试信息如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-10">10</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-11">11</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-12">12</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-13">13</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-14">14</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-15">15</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-16">16</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-17">17</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-18">18</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-19">19</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-20">20</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-3-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>++ fnSetuptoolsInstall
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>++ &#39;[&#39; -e /etc/.productinfo &#39;]&#39;
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a>+++ grep -c Kylin /etc/.productinfo
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a>++ &#39;[&#39; 1 -ne 0 &#39;]&#39;
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a>+++ grep -c &#39;V10 (SP3)&#39; /etc/.productinfo
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a>++ &#39;[&#39; 0 -ne 0 &#39;]&#39;
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a>++ setuptools_name=setuptools-65.6.3
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a>++ cd /opt/image-tools/linux/cloud-init/cloudinit_depend
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a>++ tar -xzvf setuptools-65.6.3.tar.gz
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10"></a>++ cd /opt/image-tools/linux/cloud-init/cloudinit_depend/setuptools-65.6.3
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11"></a>++ python3 bootstrap.py
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12"></a>++ python3 setup.py install
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13"></a>++ &#39;[&#39; 1 -ne 0 &#39;]&#39;
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14"></a>++ echo &#39;setuptools install failed, try to install setuptools through specified directory&#39;
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15"></a>setuptools install failed, try to install setuptools through specified directory
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16"></a>++ python3 setup.py install --prefix=/
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17"></a>+++ grep VERSION
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18"></a>+++ python3 -m pydoc setuptools
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19"></a>++ &#39;[&#39; 1 -ne 0 -a -n VERSION &#39;]&#39;
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20"></a>++ echo &#39;uninstall old setuptools, try to install setuptools again&#39;
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21"></a>uninstall old setuptools, try to install setuptools again
</span></code></pre></div></td></tr></table></div>
<p>该脚本实际运行的安装命令如下：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-4-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>python3<span class="w"> </span>setup.py<span class="w"> </span>install<span class="w"> </span>--prefix<span class="o">=</span>/
</span></code></pre></div></td></tr></table></div>
<p>手动执行，发现开源版本 setuptools 不能安装：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-5-10">10</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-5-11">11</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-5-12">12</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-5-13">13</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-5-14">14</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-5-15">15</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-5-16">16</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-5-17">17</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-5-18">18</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-5-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>[root@localhost setuptools-65.6.3]# python3 setup.py install
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a>Traceback (most recent call last):
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a>  File &quot;setup.py&quot;, line 87, in &lt;module&gt;
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a>    dist = setuptools.setup(**setup_params)
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5"></a>  File &quot;/opt/image-tools/linux/cloud-init/cloudinit_depend/setuptools-65.6.3/setuptools/__init__.py&quot;, line 87, in setup
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6"></a>    return distutils.core.setup(**attrs)
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7"></a>  File &quot;/opt/image-tools/linux/cloud-init/cloudinit_depend/setuptools-65.6.3/setuptools/_distutils/core.py&quot;, line 147, in setup
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8"></a>    _setup_distribution = dist = klass(attrs)
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9"></a>  File &quot;/opt/image-tools/linux/cloud-init/cloudinit_depend/setuptools-65.6.3/setuptools/dist.py&quot;, line 479, in __init__
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10"></a>    for k, v in attrs.items()
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11"></a>  File &quot;/opt/image-tools/linux/cloud-init/cloudinit_depend/setuptools-65.6.3/setuptools/_distutils/dist.py&quot;, line 283, in __init__
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12"></a>    self.finalize_options()
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13"></a>  File &quot;/opt/image-tools/linux/cloud-init/cloudinit_depend/setuptools-65.6.3/setuptools/dist.py&quot;, line 898, in finalize_options
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14"></a>    for ep in sorted(loaded, key=by_order):
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15"></a>  File &quot;/opt/image-tools/linux/cloud-init/cloudinit_depend/setuptools-65.6.3/setuptools/dist.py&quot;, line 897, in &lt;lambda&gt;
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16"></a>    loaded = map(lambda e: e.load(), filtered)
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17"></a>  File &quot;/opt/image-tools/linux/cloud-init/cloudinit_depend/setuptools-65.6.3/setuptools/_vendor/importlib_metadata/__init__.py&quot;, line 196, in load
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18"></a>    return functools.reduce(getattr, attrs, module)
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19"></a>AttributeError: type object &#39;Distribution&#39; has no attribute &#39;_finalize_feature_opts&#39;
</span></code></pre></div></td></tr></table></div>
<p>其中报错的 python 代码位于 <code>/opt/image-tools/linux/cloud-init/cloudinit_depend/setuptools-65.6.3/setuptools/__init__.py</code> ：</p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-6-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">setuptools.dist</span><span class="w"> </span><span class="kn">import</span> <span class="n">Distribution</span>
</span></code></pre></div></td></tr></table></div>
<p>看起来像是 python 在安装时检查 Linux 发行版版本，不识别银河麒麟系列操作系统。因此断定需要安装麒麟修改后的 setuptools 而非开源版本。这一点华为云工程师已经考虑到了，代码 <code>/opt/image-tools/linux/cloud-init/cloudinit_scripts/offdeploy-cloud-init.sh</code> 里有对麒麟操作系统的判断：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-10">10</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-11">11</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-12">12</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-13">13</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-14">14</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-15">15</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-16">16</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-17">17</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-18">18</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-19">19</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-20">20</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-21">21</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-22">22</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-23">23</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-24">24</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-25">25</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-26">26</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-27">27</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-28">28</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-29">29</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-30">30</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-31">31</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-32">32</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-33">33</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-34">34</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-35">35</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-36">36</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-37">37</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-38">38</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-7-39">39</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="c1"># install python setuptools</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a>fnSetuptoolsInstall<span class="o">()</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="o">{</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">    </span><span class="c1"># 当前仅针对Kylin V10 SP3进行特殊处理，使用系统自带的setuptools，其他操作系统仍沿用老的逻辑</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-e<span class="w"> </span>/etc/.productinfo<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="sb">`</span>grep<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;Kylin&quot;</span><span class="w"> </span>/etc/.productinfo<span class="sb">`</span><span class="w"> </span>-ne<span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="sb">`</span>grep<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;V10 (SP3)&quot;</span><span class="w"> </span>/etc/.productinfo<span class="sb">`</span><span class="w"> </span>-ne<span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">        </span><span class="nv">hasInstallSetuptools</span><span class="o">=</span><span class="k">$(</span>python<span class="w"> </span>-m<span class="w"> </span>pydoc<span class="w"> </span>setuptools<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>__version__<span class="k">)</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$hasInstallSetuptools</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">                </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;setuptools has already installed on this machine, skip install setuptools&quot;</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">                </span><span class="k">return</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="w">        </span><span class="k">fi</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="w">    </span><span class="nv">setuptools_name</span><span class="o">=</span><span class="si">${</span><span class="nv">setuptools_pkg</span><span class="si">}</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="w">    </span><span class="nb">cd</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PKG_PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="w">    </span>tar<span class="w"> </span>-xzvf<span class="w"> </span><span class="si">${</span><span class="nv">setuptools_name</span><span class="si">}</span>.tar.gz<span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="w">    </span><span class="nb">cd</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PKG_PATH</span><span class="si">}</span><span class="s2">&quot;</span>/<span class="si">${</span><span class="nv">setuptools_name</span><span class="si">}</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16"></a><span class="w">    </span><span class="si">${</span><span class="nv">PYTHON_EXEC</span><span class="si">}</span><span class="w"> </span>bootstrap.py<span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="w">    </span><span class="si">${</span><span class="nv">PYTHON_EXEC</span><span class="si">}</span><span class="w"> </span>setup.py<span class="w"> </span>install<span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18"></a>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20"></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;setuptools install failed, try to install setuptools through specified directory&quot;</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21"></a><span class="w">        </span><span class="si">${</span><span class="nv">PYTHON_EXEC</span><span class="si">}</span><span class="w"> </span>setup.py<span class="w"> </span>install<span class="w"> </span>--prefix<span class="o">=</span>/<span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span>-a<span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span><span class="si">${</span><span class="nv">PYTHON_EXEC</span><span class="si">}</span><span class="w"> </span>-m<span class="w"> </span>pydoc<span class="w"> </span>setuptools<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>VERSION<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24"></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;uninstall old setuptools, try to install setuptools again&quot;</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25"></a><span class="w">        </span>fnSetuptoolsUnInstall
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26"></a><span class="w">        </span><span class="si">${</span><span class="nv">PYTHON_EXEC</span><span class="si">}</span><span class="w"> </span>setup.py<span class="w"> </span>install<span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29"></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;setuptools install failed, try to install setuptools 41.1.0&quot;</span>
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30"></a><span class="w">        </span><span class="nv">setuptools_pkg</span><span class="o">=</span><span class="s2">&quot;setuptools-41.1.0&quot;</span>
</span><span id="__span-7-31"><a id="__codelineno-7-31" name="__codelineno-7-31"></a><span class="w">        </span><span class="nv">setuptools_name</span><span class="o">=</span><span class="si">${</span><span class="nv">setuptools_pkg</span><span class="si">}</span>
</span><span id="__span-7-32"><a id="__codelineno-7-32" name="__codelineno-7-32"></a><span class="w">        </span><span class="nb">cd</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PKG_PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span>
</span><span id="__span-7-33"><a id="__codelineno-7-33" name="__codelineno-7-33"></a><span class="w">        </span>tar<span class="w"> </span>-xzvf<span class="w"> </span><span class="si">${</span><span class="nv">setuptools_name</span><span class="si">}</span>.tar.gz<span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
</span><span id="__span-7-34"><a id="__codelineno-7-34" name="__codelineno-7-34"></a><span class="w">        </span><span class="nb">cd</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PKG_PATH</span><span class="si">}</span><span class="s2">&quot;</span>/<span class="si">${</span><span class="nv">setuptools_name</span><span class="si">}</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span>
</span><span id="__span-7-35"><a id="__codelineno-7-35" name="__codelineno-7-35"></a><span class="w">        </span><span class="si">${</span><span class="nv">PYTHON_EXEC</span><span class="si">}</span><span class="w"> </span>bootstrap.py<span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
</span><span id="__span-7-36"><a id="__codelineno-7-36" name="__codelineno-7-36"></a><span class="w">        </span><span class="si">${</span><span class="nv">PYTHON_EXEC</span><span class="si">}</span><span class="w"> </span>setup.py<span class="w"> </span>install<span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
</span><span id="__span-7-37"><a id="__codelineno-7-37" name="__codelineno-7-37"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-7-38"><a id="__codelineno-7-38" name="__codelineno-7-38"></a><span class="w">    </span>fnResultCheck<span class="w"> </span><span class="si">${</span><span class="nv">setuptools_name</span><span class="si">}</span><span class="w"> </span><span class="nv">$?</span>
</span><span id="__span-7-39"><a id="__codelineno-7-39" name="__codelineno-7-39"></a><span class="o">}</span>
</span></code></pre></div></td></tr></table></div>
<p>但是此代码仅能判断银河麒麟 V10 SP3 ，实测判断命令在 银河麒麟 V10 SP4 上输出如下：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-8-10">10</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-8-11">11</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-8-12">12</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-8-13">13</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-8-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a>[root@localhost linux]# grep -c &quot;V10 (SP3)&quot; /etc/.productinfo
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a>0
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a>[root@localhost linux]# cat /etc/.productinfo
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a>Kylin Linux Advanced Server
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5"></a>release V10 SP3 2403/(Halberd)-aarch64-Build20/20240426
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6"></a>[root@localhost linux]# python -m pydoc setuptools | grep __version__
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7"></a>-bash: python: command not found
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8"></a>[root@localhost linux]# python3 -m pydoc setuptools | grep __version__
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9"></a>[root@localhost linux]# python2 -m pydoc setuptools | grep __version__
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10"></a>-bash: python2: command not found
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11"></a>[root@localhost linux]# ls -lh /usr/bin/python
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12"></a>ls: cannot access &#39;/usr/bin/python&#39;: No such file or directory
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13"></a>[root@localhost linux]# ls -lh /usr/bin/python3
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14"></a>lrwxrwxrwx 1 root root 9 Mar 18  2024 /usr/bin/python3 -&gt; python3.7
</span></code></pre></div></td></tr></table></div>
<h2 id="%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-3">3. 解决方法<a class="headerlink" href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-3" title="Permanent link">&para;</a></h2>
<p>修改上述代码，加入 SP4 版本判断逻辑，将以下代码：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-9-1">1</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-9-2">2</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-9-3">3</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-9-4">4</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-9-5">5</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-9-6">6</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-9-7">7</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-9-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="w">    </span><span class="c1"># 当前仅针对Kylin V10 SP3进行特殊处理，使用系统自带的setuptools，其他操作系统仍沿用老的逻辑</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-e<span class="w"> </span>/etc/.productinfo<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="sb">`</span>grep<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;Kylin&quot;</span><span class="w"> </span>/etc/.productinfo<span class="sb">`</span><span class="w"> </span>-ne<span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="sb">`</span>grep<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;V10 (SP3)&quot;</span><span class="w"> </span>/etc/.productinfo<span class="sb">`</span><span class="w"> </span>-ne<span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">        </span><span class="nv">hasInstallSetuptools</span><span class="o">=</span><span class="k">$(</span>python<span class="w"> </span>-m<span class="w"> </span>pydoc<span class="w"> </span>setuptools<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>__version__<span class="k">)</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$hasInstallSetuptools</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">                </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;setuptools has already installed on this machine, skip install setuptools&quot;</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">                </span><span class="k">return</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="w">        </span><span class="k">fi</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="w">    </span><span class="k">fi</span>
</span></code></pre></div></td></tr></table></div>
<p>修改为：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-10-1">1</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-10-2">2</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-10-3">3</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-10-4">4</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-10-5">5</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-10-6">6</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-10-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-e<span class="w"> </span>/etc/.productinfo<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="sb">`</span>grep<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;Kylin&quot;</span><span class="w"> </span>/etc/.productinfo<span class="sb">`</span><span class="w"> </span>-ne<span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="sb">`</span>grep<span class="w"> </span>-cE<span class="w"> </span><span class="s2">&quot;V10 (SP3)|V10 SP3 2403&quot;</span><span class="w"> </span>/etc/.productinfo<span class="sb">`</span><span class="w"> </span>-ne<span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">        </span><span class="nv">hasInstallSetuptools</span><span class="o">=</span><span class="k">$(</span><span class="si">${</span><span class="nv">PYTHON_EXEC</span><span class="si">}</span><span class="w"> </span>-m<span class="w"> </span>pydoc<span class="w"> </span>setuptools<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>version<span class="k">)</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$hasInstallSetuptools</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">                </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;setuptools has already installed on this machine, skip install setuptools&quot;</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="w">                </span><span class="k">return</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">        </span><span class="k">fi</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="w">    </span><span class="k">fi</span>
</span></code></pre></div></td></tr></table></div>
<p>如果需要使用 Shell 脚本自动化修改，代码如下：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-11-1">1</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-11-2">2</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-11-3">3</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-11-4">4</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-11-5">5</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-11-6">6</a></span>
<span class="normal"><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3-__codelineno-11-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-e<span class="w"> </span>/etc/.productinfo<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="sb">`</span>grep<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;Kylin&quot;</span><span class="w"> </span>/etc/.productinfo<span class="sb">`</span><span class="w"> </span>-ne<span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="sb">`</span>grep<span class="w"> </span>-cE<span class="w"> </span><span class="s2">&quot;V10 (SP3)|V10 SP3 2403&quot;</span><span class="w"> </span>/etc/.productinfo<span class="sb">`</span><span class="w"> </span>-ne<span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="w">    </span>cp<span class="w"> </span>-f<span class="w"> </span>/opt/image-tools/linux/cloud-init/cloudinit_scripts/offdeploy-cloud-init.sh<span class="w"> </span>/opt/image-tools/linux/cloud-init/cloudinit_scripts/offdeploy-cloud-init.sh.bak
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="w">    </span>chmod<span class="w"> </span>+w<span class="w"> </span>/opt/image-tools/linux/cloud-init/cloudinit_scripts/offdeploy-cloud-init.sh
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">    </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s/grep -c &quot;V10 (SP3)&quot; \/etc\/.productinfo/grep -cE &quot;V10 (SP3)|V10 SP3 2403&quot; \/etc\/.productinfo/&#39;</span><span class="w"> </span>/opt/image-tools/linux/cloud-init/cloudinit_scripts/offdeploy-cloud-init.sh
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">    </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s/python -m pydoc setuptools | grep __version__/${PYTHON_EXEC} -m pydoc setuptools | grep version/&#39;</span><span class="w"> </span>/opt/image-tools/linux/cloud-init/cloudinit_scripts/offdeploy-cloud-init.sh
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w">    </span>diff<span class="w"> </span>/opt/image-tools/linux/cloud-init/cloudinit_scripts/offdeploy-cloud-init.sh<span class="w"> </span>/opt/image-tools/linux/cloud-init/cloudinit_scripts/offdeploy-cloud-init.sh.bak
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="k">fi</span>
</span></code></pre></div></td></tr></table></div>
<p>之后重新安装 cloud-init 。</p></section></section></section><section class="print-page" id="tags" heading-number="8"><h1 id="tags-_1">文档分类<a class="headerlink" href="#tags-_1" title="Permanent link">&para;</a></h1>
<p>以下为所有文档的过滤标签:</p>
<h6 id="tags-tags.md:23-45/slug">tags.md:23-45/name<a class="headerlink" href="#tags-tags.md:23-45/slug" title="Permanent link">&para;</a></h6></section></div><style>.print-site-enumerate-headings #index > h1:before { content: '1 ' }

                .print-site-enumerate-headings #index h2:before { content: '1.' counter(counter-index-2) ' ' }
                .print-site-enumerate-headings #index h2 {  counter-reset: counter-index-3 ;  counter-increment: counter-index-2 }
            
                .print-site-enumerate-headings #index h3:before { content: '1.' counter(counter-index-2) '.' counter(counter-index-3) ' ' }
                .print-site-enumerate-headings #index h3 {  counter-increment: counter-index-3 }
            
.print-site-enumerate-headings #section-2 > h1:before { content: '2 ' }
.print-site-enumerate-headings #section-2-1 > h1:before { content: '2.1 ' }
.print-site-enumerate-headings #%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85kubernetes > h1:before { content: '2.1.1 ' }

.print-site-enumerate-headings #%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%af%b9%e6%8e%a5cephfs%e5%ad%98%e5%82%a8 > h1:before { content: '2.1.2 ' }

.print-site-enumerate-headings #%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85traefik%20ingress%20controller > h1:before { content: '2.1.3 ' }

.print-site-enumerate-headings #%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85helm%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8 > h1:before { content: '2.1.4 ' }

.print-site-enumerate-headings #%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e5%ae%89%e8%a3%85metrics-server > h1:before { content: '2.1.5 ' }

.print-site-enumerate-headings #%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e9%85%8d%e7%bd%ae%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93%e5%87%ad%e8%af%81 > h1:before { content: '2.1.6 ' }

.print-site-enumerate-headings #%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e7%a6%81%e7%94%a8%e5%ae%b9%e5%99%a8%e9%95%9c%e5%83%8f%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%b9%b6%e9%85%8d%e7%bd%ae%e7%a3%81%e7%9b%98%e7%9b%b8%e5%85%b3%e5%ae%b9%e5%99%a8%e6%bc%82%e7%a7%bb%e7%ad%96%e7%95%a5 > h1:before { content: '2.1.7 ' }

.print-site-enumerate-headings #%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-local-path-provisioner%e5%ae%89%e8%a3%85 > h1:before { content: '2.1.8 ' }

.print-site-enumerate-headings #%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-%e6%89%a9%e5%ae%b9master%e8%8a%82%e7%82%b9 > h1:before { content: '2.1.9 ' }

.print-site-enumerate-headings #%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k3s%e5%88%a0%e9%99%a4namespace%e5%8d%a1%e6%ad%bb%e5%9c%a8terminating%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95 > h1:before { content: '2.1.10 ' }

.print-site-enumerate-headings #%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-kubernetes-k8s%e5%bc%80%e5%90%afswap%e6%94%af%e6%8c%81 > h1:before { content: '2.1.11 ' }

.print-site-enumerate-headings #section-2-2 > h1:before { content: '2.2 ' }
.print-site-enumerate-headings #%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-dockerfile%e4%b8%ad%e4%b8%8d%e4%bf%9d%e7%95%99%e7%bc%96%e8%af%91%e7%bc%93%e5%ad%98 > h1:before { content: '2.2.1 ' }

.print-site-enumerate-headings #%e5%ae%b9%e5%99%a8%e6%8a%80%e6%9c%af-docker%26podman-%e5%9f%ba%e4%ba%8eebpf%e7%9a%84%e5%ae%b9%e5%99%a8%e5%ae%a1%e8%ae%a1%e6%8a%80%e6%9c%af%e7%9a%84%e5%ae%9e%e7%8e%b0 > h1:before { content: '2.2.2 ' }

.print-site-enumerate-headings #section-3 > h1:before { content: '3 ' }
.print-site-enumerate-headings #section-3-1 > h1:before { content: '3.1 ' }
.print-site-enumerate-headings #%e5%89%8d%e7%ab%af%e5%bc%80%e5%8f%91-vue3-geeker-admin%e6%8e%a5%e5%85%a5keycloak%e8%ae%a4%e8%af%81 > h1:before { content: '3.1.1 ' }

.print-site-enumerate-headings #section-4 > h1:before { content: '4 ' }
.print-site-enumerate-headings #section-4-1 > h1:before { content: '4.1 ' }
.print-site-enumerate-headings #%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-ceph-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10%e5%ae%89%e8%a3%85ceph > h1:before { content: '4.1.1 ' }

.print-site-enumerate-headings #section-4-2 > h1:before { content: '4.2 ' }
.print-site-enumerate-headings #%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-zfs-truenas%e5%88%a0%e9%99%a4%e6%89%80%e6%9c%89%e7%a9%ba%e5%bf%ab%e7%85%a7 > h1:before { content: '4.2.1 ' }

.print-site-enumerate-headings #section-4-3 > h1:before { content: '4.3 ' }
.print-site-enumerate-headings #%e5%ad%98%e5%82%a8%e6%8a%80%e6%9c%af-truenas-truenas%20iscsi%20%e5%ae%89%e8%a3%85%20windows%20server%202025 > h1:before { content: '4.3.1 ' }

.print-site-enumerate-headings #section-5 > h1:before { content: '5 ' }
.print-site-enumerate-headings #section-5-1 > h1:before { content: '5.1 ' }
.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%92%8cstolon%e9%ab%98%e5%8f%af%e7%94%a8%e8%b0%83%e4%bc%98 > h1:before { content: '5.1.1 ' }

.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e4%bd%bf%e7%94%a8stolon%e5%ae%89%e8%a3%85%e9%ab%98%e5%8f%af%e7%94%a8postgresql > h1:before { content: '5.1.2 ' }

.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%ae%89%e8%a3%85awx-23.7 > h1:before { content: '5.1.3 ' }

.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx-23.9%e4%bd%bf%e7%94%a8saml%e5%af%b9%e6%8e%a5keycloak-24%e8%ae%a4%e8%af%81 > h1:before { content: '5.1.4 ' }

.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e5%a2%9e%e5%8a%a0%e5%b9%b6%e4%bd%bf%e7%94%a8token > h1:before { content: '5.1.5 ' }

.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e8%ae%be%e7%bd%aesaml%e8%ae%a4%e8%af%81%e7%94%a8%e6%88%b7%e4%b8%ba%e7%ae%a1%e7%90%86%e5%91%98 > h1:before { content: '5.1.6 ' }

.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-awx%e6%96%b0%e5%a2%9e%e5%ae%b9%e5%99%a8%e7%bb%84 > h1:before { content: '5.1.7 ' }

.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-awx-%e5%9c%a8k3s%e4%b8%8a%e6%90%ad%e5%bb%baawx%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83 > h1:before { content: '5.1.8 ' }

.print-site-enumerate-headings #section-5-2 > h1:before { content: '5.2 ' }
.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8openresty%e5%ae%b9%e5%99%a8%e4%b8%bak8s%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9bkeycloak%e8%ae%a4%e8%af%81%e6%9c%8d%e5%8a%a1 > h1:before { content: '5.2.1 ' }

.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k8s%e9%9b%86%e7%be%a4keycloak%e9%83%a8%e7%bd%b2%e5%8f%8a%e8%b4%9f%e8%bd%bd%e9%85%8d%e7%bd%ae > h1:before { content: '5.2.2 ' }

.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-%e4%bd%bf%e7%94%a8docker-compose%e6%90%ad%e5%bb%bakeycloak%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83 > h1:before { content: '5.2.3 ' }

.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-keycloak-k3s%e6%90%ad%e5%bb%ba%e5%8d%95%e7%82%b9keycloak > h1:before { content: '5.2.4 ' }

.print-site-enumerate-headings #section-5-3 > h1:before { content: '5.3 ' }
.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e6%80%9d%e6%ba%90%e7%ac%94%e8%ae%b0k8s%e9%83%a8%e7%bd%b2 > h1:before { content: '5.3.1 ' }

.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-mkdocs%e5%9c%a8k8s%e4%b8%8a%e7%9a%84%e9%83%a8%e7%bd%b2 > h1:before { content: '5.3.2 ' }

.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-%e7%ac%94%e8%ae%b0%e5%8f%8a%e6%96%87%e6%a1%a3%e8%bd%af%e4%bb%b6-%e7%bc%96%e8%af%91onlyoffice%e4%bb%a5%e8%a7%a3%e9%99%a420%e8%bf%9e%e6%8e%a5%e6%95%b0%e9%99%90%e5%88%b6 > h1:before { content: '5.3.3 ' }

.print-site-enumerate-headings #section-5-4 > h1:before { content: '5.4 ' }
.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3 > h1:before { content: '5.4.1 ' }

.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e6%9c%80%e7%ae%80git%e6%9c%8d%e5%8a%a1%e5%99%a8%e6%90%ad%e5%bb%ba > h1:before { content: '5.4.2 ' }

.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-github%e9%bb%98%e8%ae%a4%e5%a4%b4%e5%83%8f%e8%8e%b7%e5%8f%96 > h1:before { content: '5.4.3 ' }

.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-git%e9%85%8d%e7%bd%ae%e8%ae%b0%e4%bd%8f%e5%af%86%e7%a0%81 > h1:before { content: '5.4.4 ' }

.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-%e4%bd%bf%e7%94%a8nginx%e5%bf%ab%e9%80%9f%e6%90%ad%e5%bb%ba%e5%8f%aa%e8%af%bbgit%e4%bb%93%e5%ba%93 > h1:before { content: '5.4.5 ' }

.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-git%e4%bd%bf%e7%94%a8-gitlab%e7%ac%ac%e4%ba%8c%e9%82%ae%e7%ae%b1%e4%bf%ae%e6%94%b9%e4%b8%ba%e5%b7%b2%e8%ae%a4%e8%af%81 > h1:before { content: '5.4.6 ' }

.print-site-enumerate-headings #section-5-5 > h1:before { content: '5.5 ' }
.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e6%9e%84%e5%bb%ba%e8%a7%a3%e5%8e%8b%e5%8d%b3%e7%94%a8%e7%9a%84python3 > h1:before { content: '5.5.1 ' }

.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-%e5%9f%ba%e4%ba%8epython%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e7%9b%91%e6%8e%a7%e5%b7%a5%e5%85%b7%e7%9a%84%e5%bc%80%e5%8f%91 > h1:before { content: '5.5.2 ' }

.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e5%8d%87%e7%ba%a7%e6%89%80%e6%9c%89%e4%be%9d%e8%b5%96 > h1:before { content: '5.5.3 ' }

.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-python-python%e9%99%90%e5%88%b6%e5%86%85%e5%ad%98%e5%92%8ccpu%e4%bd%bf%e7%94%a8 > h1:before { content: '5.5.4 ' }

.print-site-enumerate-headings #section-5-6 > h1:before { content: '5.6 ' }
.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-springboot%202.5.1%20%e5%af%b9%e6%8e%a5keycloak%e8%ae%a4%e8%af%81 > h1:before { content: '5.6.1 ' }

.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-java-%e4%bd%bf%e7%94%a8onlyoffice%e5%ae%98%e6%96%b9spring%e7%a4%ba%e4%be%8b%e9%81%87%e5%88%b0%e7%9a%84%e5%9d%91 > h1:before { content: '5.6.2 ' }

.print-site-enumerate-headings #section-5-7 > h1:before { content: '5.7 ' }
.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-shell-shell%e8%ae%be%e7%bd%ae%e5%8f%98%e9%87%8f%e6%9c%aa%e8%b5%8b%e5%80%bc%e6%88%96%e9%81%87%e5%88%b0%e9%94%99%e8%af%af%e7%ab%8b%e5%88%bb%e9%80%80%e5%87%ba > h1:before { content: '5.7.1 ' }

.print-site-enumerate-headings #section-5-8 > h1:before { content: '5.8 ' }
.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e7%a6%bb%e7%ba%bf%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85 > h1:before { content: '5.8.1 ' }

.print-site-enumerate-headings #%e8%bf%90%e7%bb%b4%e5%bc%80%e5%8f%91-rust-rust%e4%ba%a4%e5%8f%89%e7%bc%96%e8%af%91%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85 > h1:before { content: '5.8.2 ' }

.print-site-enumerate-headings #section-6 > h1:before { content: '6 ' }
.print-site-enumerate-headings #section-6-1 > h1:before { content: '6.1 ' }
.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e4%b8%8b%e8%bd%bdyum%e6%ba%90 > h1:before { content: '6.1.1 ' }

.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e6%8c%82%e8%bd%bdcifs > h1:before { content: '6.1.2 ' }

.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20lvm%e8%b8%a2pv > h1:before { content: '6.1.3 ' }

.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e5%b0%86%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e7%a3%81%e7%9b%98%e5%88%86%e5%8c%ba%e6%89%a9%e5%ae%b9%e5%88%b0%e6%9c%80%e5%a4%a7 > h1:before { content: '6.1.4 ' }

.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%e9%85%8d%e7%bd%aeudev%e8%a7%84%e5%88%99%e5%bf%bd%e7%95%a5%e7%a3%81%e7%9b%98 > h1:before { content: '6.1.5 ' }

.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-%e4%bd%bf%e7%94%a8tlog%e5%af%b9%e7%99%bb%e5%bd%95%e5%88%b0linux%e4%b8%8a%e7%9a%84%e7%94%a8%e6%88%b7%e8%bf%9b%e8%a1%8c%e5%bd%95%e5%b1%8f > h1:before { content: '6.1.6 ' }

.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-kickstart%20%e8%bd%afraid%e5%ae%89%e8%a3%85 > h1:before { content: '6.1.7 ' }

.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-%e9%80%9a%e7%94%a8linux-linux%20%e5%bc%80%e5%90%af%20otp%20%e4%ba%8c%e6%ac%a1%e8%ae%a4%e8%af%81 > h1:before { content: '6.1.8 ' }

.print-site-enumerate-headings #section-6-2 > h1:before { content: '6.2 ' }
.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8qemu%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo > h1:before { content: '6.2.1 ' }

.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-gentoo-%e5%9c%a8hyper-v%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85gentoo > h1:before { content: '6.2.2 ' }

.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-gentoo-emerge%e8%a3%85%e5%8c%85ninja%e6%8a%a5%e9%94%99%e2%80%9cmanifest%20%27build.ninja%27%20still%20dirty%20after%20100%20tries%e2%80%9d%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95 > h1:before { content: '6.2.3 ' }

.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-gentoo-gentoo%e5%90%af%e5%8a%a8%e6%97%b6%e6%8c%82%e8%bd%bdcifs%e5%a4%b1%e8%b4%a5%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95 > h1:before { content: '6.2.4 ' }

.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-gentoo-hyper-v%e7%8e%af%e5%a2%83%e4%b8%8bsddm%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%9b%be%e5%bd%a2%e7%95%8c%e9%9d%a2%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3 > h1:before { content: '6.2.5 ' }

.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-gentoo-%e5%ae%89%e8%a3%85xfce%e5%90%8efcitx%e5%8f%b3%e4%b8%8a%e8%a7%92%e6%98%be%e7%a4%ba%e4%bd%86%e6%97%a0%e6%b3%95%e9%80%89%e6%8b%a9%e8%be%93%e5%85%a5%e6%b3%95%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3 > h1:before { content: '6.2.6 ' }

.print-site-enumerate-headings #section-6-3 > h1:before { content: '6.3 ' }
.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85wireguard > h1:before { content: '6.3.1 ' }

.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-openwrt-openwrt%e5%ae%89%e8%a3%85openvpn > h1:before { content: '6.3.2 ' }

.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-openwrt-openwrt%20ddns%e5%bc%80%e6%9c%ba%e5%90%af%e5%8a%a8%e5%a4%b1%e8%b4%a5%e9%97%ae%e9%a2%98 > h1:before { content: '6.3.3 ' }

.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e8%a7%a3%e9%94%81ssh > h1:before { content: '6.3.4 ' }

.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%88%b7%e6%9c%ba > h1:before { content: '6.3.5 ' }

.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-openwrt-%e5%b0%8f%e7%b1%b3ax9000%e5%8a%a0%e5%85%a5160mhz%e6%94%af%e6%8c%81 > h1:before { content: '6.3.6 ' }

.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-openwrt-%e5%8c%97%e4%ba%ac%e8%81%94%e9%80%9a%e4%b8%ad%e5%85%b4f4610u%e5%85%89%e7%8c%ab%e5%bc%80%e8%b6%85%e7%ae%a1%e7%95%8c%e9%9d%a2 > h1:before { content: '6.3.7 ' }

.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-openwrt-openwrt%e4%bf%ae%e6%94%b9%e9%bb%98%e8%ae%a4shell%e4%b8%babash%e5%b9%b6%e5%bc%80%e5%90%af%e5%8e%86%e5%8f%b2%e5%91%bd%e4%bb%a4%e6%97%b6%e9%97%b4%e6%88%b3 > h1:before { content: '6.3.8 ' }

.print-site-enumerate-headings #section-6-4 > h1:before { content: '6.4 ' }
.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-ubuntu-ubuntu%e5%ae%89%e8%a3%85hyper-v%e5%b7%a5%e5%85%b7 > h1:before { content: '6.4.1 ' }

.print-site-enumerate-headings #section-6-5 > h1:before { content: '6.5 ' }
.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-rhel6-%e8%ae%b0%e6%9f%90%e6%ac%a1%e8%af%af%e6%93%8d%e4%bd%9cyum%20update%e5%90%8ejboss%e5%ba%94%e7%94%a8%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8%e5%8f%8a%e9%87%8d%e5%90%af%e6%97%a0%e6%b3%95%e8%af%86%e5%88%abvg%e9%97%ae%e9%a2%98 > h1:before { content: '6.5.1 ' }

.print-site-enumerate-headings #section-6-6 > h1:before { content: '6.6 ' }
.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e6%9b%99%e5%85%89%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a3%85%e6%9c%ba%e6%97%a0raid%e5%8d%a1%e9%a9%b1%e5%8a%a8%e5%af%bc%e8%87%b4%e4%b8%8d%e8%83%bd%e8%af%86%e5%88%ab%e7%a1%ac%e7%9b%98%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88 > h1:before { content: '6.6.1 ' }

.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-%e4%b8%ad%e6%a0%87%e9%ba%92%e9%ba%9fv7-%e8%81%94%e6%83%b3%e7%89%a9%e7%90%86%e6%9c%bapxe%e8%a3%85%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9c%e6%a0%b9%e5%88%86%e5%8c%ba%e6%89%be%e4%b8%8d%e5%88%b0%e2%80%9d%e5%8e%9f%e5%9b%a0%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95 > h1:before { content: '6.6.2 ' }

.print-site-enumerate-headings #section-6-7 > h1:before { content: '6.7 ' }
.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e9%ba%92%e9%ba%9fv10sp4%e5%a2%9e%e5%8a%a0vscode%e6%94%af%e6%8c%81 > h1:before { content: '6.7.1 ' }

.print-site-enumerate-headings #%e6%8a%98%e8%85%belinux-%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10-%e8%ae%b0%e6%9f%90%e6%ac%a1%e6%9f%90%e5%ae%89%e5%85%a8%e5%8e%82%e5%95%86%e5%ba%94%e7%94%a8%e8%bf%90%e8%a1%8c%e4%b8%80%e6%ae%b5%e6%97%b6%e9%97%b4%e5%90%8e%ef%bc%8clinux%e5%87%ba%e7%8e%b0ping%e5%bb%b6%e8%bf%9f%e9%ab%98%e9%97%ae%e9%a2%98%e7%9a%84%e8%a7%a3%e5%86%b3%e6%80%9d%e8%b7%af > h1:before { content: '6.7.2 ' }

.print-site-enumerate-headings #section-7 > h1:before { content: '7 ' }
.print-site-enumerate-headings #section-7-1 > h1:before { content: '7.1 ' }
.print-site-enumerate-headings #%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-hyper-v-hyper-v%e4%bf%ae%e6%94%b9%e8%b0%83%e5%ba%a6%e5%99%a8 > h1:before { content: '7.1.1 ' }

.print-site-enumerate-headings #%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-hyper-v-hyper-v%e5%a4%9a%e7%bd%91%e5%8d%a1%e7%bb%91%e5%ae%9a > h1:before { content: '7.1.3 ' }

.print-site-enumerate-headings #section-7-2 > h1:before { content: '7.2 ' }
.print-site-enumerate-headings #%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-virt-manager%e5%88%9b%e5%bb%ba%e8%99%9a%e6%8b%9f%e6%9c%ba%e6%8a%a5%e9%94%99%e2%80%9cdid%20not%20find%20any%20uefi%20binary%20path%20for%20arch%20%27aarch64%27%e2%80%9d%e9%97%ae%e9%a2%98 > h1:before { content: '7.2.1 ' }

.print-site-enumerate-headings #%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-qemu-pve%e5%8f%91%e6%94%bearm%e8%99%9a%e6%8b%9f%e6%9c%ba > h1:before { content: '7.2.2 ' }

.print-site-enumerate-headings #section-7-3 > h1:before { content: '7.3 ' }
.print-site-enumerate-headings #%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af-%e5%8d%8e%e4%b8%ba%e4%ba%91-%e5%8d%8e%e4%b8%bahcs%208%e4%b8%8e%e9%93%b6%e6%b2%b3%e9%ba%92%e9%ba%9fv10sp4%20cloud-init%e9%80%82%e9%85%8d%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3 > h1:before { content: '7.3.1 ' }

.print-site-enumerate-headings #tags > h1:before { content: '8 ' }

                .print-site-enumerate-headings #tags h2:before { content: '8.' counter(counter-tags-2) ' ' }
                .print-site-enumerate-headings #tags h2 {  counter-reset: counter-tags-3 ;  counter-increment: counter-tags-2 }
            
                .print-site-enumerate-headings #tags h3:before { content: '8.' counter(counter-tags-2) '.' counter(counter-tags-3) ' ' }
                .print-site-enumerate-headings #tags h3 {  counter-increment: counter-tags-3 }
            </style>












                

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "/", "features": ["navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.expand", "navigation.top", "navigation.footer", "navigation.prune", "search.suggest", "search.highlight", "search.share", "header.autohide", "toc.follow", "content.code.copy"], "search": "assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="js/print-site.js"></script>
      
        <script src="js/open_in_new_tab.js"></script>
      
    
  </body>
</html>